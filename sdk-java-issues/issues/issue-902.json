{
  "assignees": [],
  "author": {
    "id": "MDQ6VXNlcjUzMjEwOA==",
    "is_bot": false,
    "login": "Spikhalskiy",
    "name": "Dmitry Spikhalsky"
  },
  "body": "## Expected Behavior\r\n\r\nTemporal JavaSDK explicitly supports the idea of fixing a bug leading to an exception in the workflow implementation. Workflow can throw a non `ApplicationFailure` exception and such an exception can be fixed in code, the worker can be redeployed and the workflow should be able to successfully continue the existing execution without resetting the history.\r\n\r\nThe following code simulates a situation when a second asynchronously triggered procedure throws an exception on the first execution and the problem is getting \"fixed\" on the second attempt. You would expect that this code will be able to successfully finish on a second attempt. \r\n\r\n```\r\n    public String execute(String input) {\r\n      List<Promise<Void>> processingPromises = new ArrayList<>();\r\n      processingPromises.add(\r\n          Async.procedure(this::procedure, \"input1\", false, Workflow.isReplaying()));\r\n      processingPromises.add(\r\n          Async.procedure(this::procedure, \"input2\", true, Workflow.isReplaying()));\r\n      processingPromises.forEach(Promise::get);\r\n      return \"done\";\r\n    }\r\n\r\n    private void procedure(String obj, boolean failingOnTheFirstRun, boolean retrying) {\r\n      ActivityAlphabet activity = Workflow.newActivityStub(ActivityAlphabet.class);\r\n      \r\n      // only the second Async procedure fails and only during the initial run \r\n      if (failingOnTheFirstRun && !retrying) {\r\n        // emulating fail with some implementation bug\r\n        throw new NullPointerException();\r\n      }\r\n      activity.doA(obj);\r\n      activity.doB(obj);\r\n    }\r\n```\r\n\r\n## Actual Behavior\r\n\r\nNon-deterministic exception:\r\n\r\n```\r\nCaused by: io.temporal.worker.NonDeterministicException: Failure handling event 11 of type 'EVENT_TYPE_ACTIVITY_TASK_SCHEDULED' during replay. Command COMMAND_TYPE_SCHEDULE_ACTIVITY_TASK doesn't match event EVENT_TYPE_ACTIVITY_TASK_SCHEDULED with EventId=11 on check activityType with an expected value name: \"DoA\"\r\n and an actual value name: \"DoB\"\r\n. {PreviousStartedEventId=9, workflowTaskStartedEventId=18, Currently Processing StartedEventId=9}\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.assertMatch(WorkflowStateMachines.java:887)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.validateCommand(WorkflowStateMachines.java:817)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleCommandEvent(WorkflowStateMachines.java:338)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleSingleEvent(WorkflowStateMachines.java:229)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEventsBatch(WorkflowStateMachines.java:200)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:176)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:176)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:145)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithQuery(ReplayWorkflowTaskHandler.java:127)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:102)\r\n```\r\n\r\nTest reproducing the problem: https://github.com/Spikhalskiy/java-sdk/commit/43ce60f9518fc1acb871a73aafab6df2a57749df#diff-96be05397e0cfb9f8d1bdc02587f70a34e65e1b42b8e908964162f39d27f249aR46\r\n\r\n## Root cause analysis\r\n\r\n1. Async procedure can't propagate the exception on the main worklow thead when it happens, the exception \"stays in the Promise\" until it's checked.\r\n2. Workflow code is awaiting for the first promise from the non-failing procedure before starting the await on the second failing promise.\r\n3. Failure of the second procedure is getting ignored for some time and the first procedure gets a chance to advance and be fully complete, produce a couple of completed activity executions before we realize that the second procedure is failed already. \r\n4. These \"unlawfully\" advanced first procedure and it's scheduled activities recorded in the history create a history that is incompatible with \"fixed\" code and can't be replayed by a \"fixed\" version.\r\n\r\nThe reason this happens is eager evaluation. As soon as the promises are created they begin evaluating. Now imagine the following sequence of events:\r\n\r\n**First execution**\r\n1. Promises 1&2 start running\r\n1. Promise 1 schedules A\r\n1. Promise 2 throws, but exception is not propagated up yet\r\n1. Promise 1 schedules B\r\n1. We send 1A and 1B to server\r\nNext go-round we blow up w/ the exception\r\n\r\n**Expected fixed execution**\r\n1. Promises 1&2 start running\r\n1. Promise 1 schedules A\r\n1. Promise 2 schedules A because it is fixed now _//<-- Failing here now_\r\n1. Promise 1 schedules B\r\n1. Promise 2 schedules B\r\n\r\nOops now 2A is out-of-order according to existing history. 2B would be OK since there was nothing before it besides the task failure in history.\r\nSo, we are failing after step 3 with non-deterministic error because the command 2A doesn't match the expected event 1B from the history.\r\n\r\n## Workaround\r\n\r\n1. Using `Promise.allOf` to wait on all the promises doesn't allow the exception to be \"ignored\" because we wait only on the one promise at a time. Has to be implemented correctly in this way before the problem actually happened and the incorrect history is already produced.\r\n1. Promoting all exceptions happening in Async functions/procedures to Errors solves this by immediately failing the workflow task. This has to be done before the workflow execution and before the incompatible history is already produced.\r\n\r\nThe only solution if the problem already manifested itself is history reset + one of the workarounds to prevent it from happening again.\r\n\r\n## Notes about the original user report\r\n\r\nInvestigation triggered by:\r\nhttps://community.temporal.io/t/verifying-error-handling-and-fixing-buggy-code-within-async-procedure-promises/3391/10\r\n\r\nWhich leaded to creation of simplified flaky reproduction \r\nhttps://github.com/Spikhalskiy/java-sdk/commit/eb6b44142fa5f2fb31809dace8aedb435307430b\r\nthat flakes about 5% of the time and requires `WorkflowImplZRetriesTestCopy1` to be executed after `WorkflowImplRetriesTest` to increase the chance of the problem happening.\r\n\r\nThe original flaky reproduction may be very hard to follow and link to the described issue, because the problem occurs there only under a specific ordering of the activity executions and completions that leads to an effective \"reordering\" of asynchronous procedures execution.\r\n\r\n",
  "closedAt": null,
  "comments": [],
  "createdAt": "2021-11-28T20:00:56Z",
  "labels": [
    {
      "id": "MDU6TGFiZWwxNjIyNzE5ODQx",
      "name": "bug",
      "description": "Something isn't working",
      "color": "d73a4a"
    }
  ],
  "milestone": null,
  "number": 902,
  "reactionGroups": [],
  "state": "OPEN",
  "title": "Exception in one of several \"parallel\" workflow async functions leads to non-deterministic execution",
  "updatedAt": "2024-12-17T21:21:49Z",
  "url": "https://github.com/temporalio/sdk-java/issues/902"
}
