{
  "assignees": [],
  "author": {
    "id": "MDQ6VXNlcjY0MTIxNjk=",
    "is_bot": false,
    "login": "mjameswh",
    "name": "James Watkins-Harvey"
  },
  "body": "### Describe the bug\r\n\r\nA user has a workflow that attempts to cancel an activity in the very same WFT where that activity completes (eg. it cancels the activity from a signal handler, so the activity promise has not yet been marked as completed).\r\n\r\nUsing the official server, the workflows continues execution without problem.\r\n\r\nHowever, using the time skipping test server, the workflow get stuck, and the following error message is being displayed:\r\n\r\n```\r\nNetwork error while completing workflow activation error=status: FailedPrecondition, message: \"ACTIVITY_UNKNOWN for scheduledEventId=41\"\r\n```\r\n\r\n### Minimal Reproduction\r\n\r\nA user provided [this repro](https://github.com/Irvenae/ts-temporal/blob/main/src/__tests__/networkError.test.ts).\r\n\r\nAnother user provided the following code:\r\n\r\n```\r\ntry {\r\n  await someActivity(); // someActivity works here\r\n  await someActivityThatTriggersCancelation();\r\n} catch (e: unknown) {\r\n  if (isCancellation(e)) {\r\n    await CancellationScope.nonCancellable(async () => {\r\n      await someActivity(); // someActivity fails with \"ACTIVITY_UNKNOWN\" here\r\n    });\r\n  }\r\n}\r\n```\r\n\r\nHe also mentioned that he would encounter the same thing if he calls `handle.cancel()` outside of any activity, in the outer test context.",
  "closedAt": null,
  "comments": [
    {
      "id": "IC_kwDODN12PM6cKgWe",
      "author": {
        "login": "mjameswh"
      },
      "authorAssociation": "MEMBER",
      "body": "**Internal notes**\r\n\r\nThe error returned by [the Test server](https://github.com/temporalio/sdk-java/blob/ba838febd86bb7033346b075504158d65b81a3d0/temporal-test-server/src/main/java/io/temporal/internal/testservice/TestWorkflowMutableStateImpl.java#L790) is “incorrect” with regards to the official server…\r\n\r\nThat explains the \"Network error\" message, but not why the workflow is able to continue forward with the official server, but not with the time skipping test server. In both case, the server should deny the WFT Completion anyway, and [core will evict the workflow in both cases](https://github.com/temporalio/sdk-core/blob/master/core/src/worker/workflow/mod.rs#L524-L535).\r\n\r\nAn hypothesis is that the test server might fail to send a subsequent WFT for some reason.",
      "createdAt": "2023-02-17T15:35:05Z",
      "includesCreatedEdit": false,
      "isMinimized": false,
      "minimizedReason": "",
      "reactionGroups": [],
      "url": "https://github.com/temporalio/sdk-java/issues/2391#issuecomment-2619999646",
      "viewerDidAuthor": false
    },
    {
      "id": "IC_kwDODN12PM6cKgWp",
      "author": {
        "login": "josiah-roberts"
      },
      "authorAssociation": "NONE",
      "body": "Watching this issue; right now we're able to write tests for our no-sleep workflows, but not workflows that sleep.",
      "createdAt": "2023-02-22T01:19:24Z",
      "includesCreatedEdit": false,
      "isMinimized": false,
      "minimizedReason": "",
      "reactionGroups": [],
      "url": "https://github.com/temporalio/sdk-java/issues/2391#issuecomment-2619999657",
      "viewerDidAuthor": false
    }
  ],
  "createdAt": "2023-02-17T15:28:02Z",
  "labels": [
    {
      "id": "MDU6TGFiZWwxNjIyNzE5ODQx",
      "name": "bug",
      "description": "Something isn't working",
      "color": "d73a4a"
    },
    {
      "id": "LA_kwDODN12PM8AAAABzzHCJQ",
      "name": "test server",
      "description": "Related to the test server",
      "color": "A71076"
    }
  ],
  "milestone": null,
  "number": 2391,
  "reactionGroups": [
    {
      "content": "THUMBS_UP",
      "users": {
        "totalCount": 1
      }
    }
  ],
  "state": "OPEN",
  "title": "[Bug] Cancelling an activity results in `FailedPrecondition: ACTIVITY_UNKNOWN` error on time skipping server",
  "updatedAt": "2025-01-28T20:33:03Z",
  "url": "https://github.com/temporalio/sdk-java/issues/2391"
}
