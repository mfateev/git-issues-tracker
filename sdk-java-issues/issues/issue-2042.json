{
  "assignees": [],
  "author": {
    "id": "MDQ6VXNlcjE0NjM2MjI=",
    "is_bot": false,
    "login": "mfateev",
    "name": "Maxim Fateev"
  },
  "body": "## Expected Behavior\r\nThere are six potential sources for activity options:\r\n\r\n1. [WorkflowImplementationOptions#defaultActivityOptions](https://github.com/temporalio/sdk-java/blob/1a0738c068a060f9aa174cf4286ffc357251b2a6/temporal-sdk/src/main/java/io/temporal/worker/WorkflowImplementationOptions.java#L97)\r\n2. [WorkflowImplementationOptions#activityOptions](https://github.com/temporalio/sdk-java/blob/1a0738c068a060f9aa174cf4286ffc357251b2a6/temporal-sdk/src/main/java/io/temporal/worker/WorkflowImplementationOptions.java#L84) map\r\n3. Workflow.setDefaultActivityOptions\r\n4. Workflow.applyActivityOptions map\r\n5. options argument passed to [WorkflowInternal#newActivityStub](https://github.com/temporalio/sdk-java/blob/bff4b6fe837095f610247806e97f03333a454cd0/temporal-sdk/src/main/java/io/temporal/workflow/Workflow.java#L105)\r\n6. activityMethodOptions map argument passed to [WorkflowInternal#newActivityStub](https://github.com/temporalio/sdk-java/blob/bff4b6fe837095f610247806e97f03333a454cd0/temporal-sdk/src/main/java/io/temporal/workflow/Workflow.java#L105)\r\n\r\nWhen all these options are specified for the given activity type, the logical behavior is to merge them in the same order as specified above.\r\n\r\n## Actual Behavior\r\n\r\nThe current logic is split between:\r\n\r\nhttps://github.com/temporalio/sdk-java/blob/8af4a2647dacab2cb0d4a3a613482e00bc297a39/temporal-sdk/src/main/java/io/temporal/internal/sync/WorkflowInternal.java#L303\r\n\r\nand \r\n\r\nhttps://github.com/temporalio/sdk-java/blob/16755a1bb7ebba29fb820b86a001c079cf4ffb62/temporal-sdk/src/main/java/io/temporal/internal/sync/ActivityInvocationHandler.java#L70\r\n\r\nThe short description is:\r\n\r\n1. options = options argument passed to [WorkflowInternal#newActivityStub] ? WorkflowImplementationOptions#defaultActivityOptions // not that they are not merged if the argument is present.\r\n\r\n2. WorkflowImplementationOptions#activityOptions map is overridden by options found in activityMethodOptions map argument passed to WorkflowInternal#newActivityStub\r\n\r\n3. options (from step 1) are overridden by a value (with the key equal to the activity type) from the map generated by step (2)\r\n\r\nI believe that we should fix the merging logic to match the intuitive behavior explained in the \"Expected Behavior\" section.",
  "closedAt": null,
  "comments": [
    {
      "id": "IC_kwDODN12PM569zbI",
      "author": {
        "login": "Quinn-With-Two-Ns"
      },
      "authorAssociation": "MEMBER",
      "body": "Ignoring backwards compatibility for a moment\r\n\r\n>, the logical behavior is to merge them in the same order as specified above.\r\n\r\nI would disagree that is intuitive or logical. Before reading the docs I would not expect all the options to be merged in order. Specifically I would not expect the default activity options to be merged with the specific activity options. If I pass a specific option it is because I don't want the default, I would not expect the default to still get merged if I passed a more specific option. Looking at the docs for [setActivityOptions](https://github.com/temporalio/sdk-java/blob/1a0738c068a060f9aa174cf4286ffc357251b2a6/temporal-sdk/src/main/java/io/temporal/worker/WorkflowImplementationOptions.java#L84) supports this.",
      "createdAt": "2024-04-18T05:20:58Z",
      "includesCreatedEdit": false,
      "isMinimized": false,
      "minimizedReason": "",
      "reactionGroups": [],
      "url": "https://github.com/temporalio/sdk-java/issues/2042#issuecomment-2063021768",
      "viewerDidAuthor": false
    },
    {
      "id": "IC_kwDODN12PM57H81z",
      "author": {
        "login": "mfateev"
      },
      "authorAssociation": "MEMBER",
      "body": "I see two separate questions here:\r\n\r\n1. Do we merge options at all, or are they always replaced completely?\r\n2. What is the precedence of merging/replacement?\r\n\r\nI personally think we want merging as it allows overriding either specific values as well as all values.\r\n\r\nThe precedence outlined above is the only one that makes sense to me.\r\n\r\nI see a specific exception for testing where the options sometimes need to be forcefully replaced through WorkflowTestEnvironment.\r\n\r\n> Looking at the docs for `setActivityOptions` supports this.\r\n\r\nThe doc explicitly says about merging:\r\n\r\n>      * Set individual activity options per activityType. Will be merged with the map from {@link\r\n>      * io.temporal.workflow.Workflow#newActivityStub(Class, ActivityOptions, Map)} which has the\r\n>      * highest precedence.",
      "createdAt": "2024-04-19T03:27:06Z",
      "includesCreatedEdit": true,
      "isMinimized": false,
      "minimizedReason": "",
      "reactionGroups": [],
      "url": "https://github.com/temporalio/sdk-java/issues/2042#issuecomment-2065681779",
      "viewerDidAuthor": true
    },
    {
      "id": "IC_kwDODN12PM57IAa3",
      "author": {
        "login": "Quinn-With-Two-Ns"
      },
      "authorAssociation": "MEMBER",
      "body": ">The precedence outlined above is the only one that makes sense to me.\r\n\r\nI disagree, I find the outlined approach unintuitive for the reasons I state above , specifically merging defaultActivityOptions and activityOptions, and it disagrees with our documentation. ",
      "createdAt": "2024-04-19T03:47:55Z",
      "includesCreatedEdit": false,
      "isMinimized": false,
      "minimizedReason": "",
      "reactionGroups": [],
      "url": "https://github.com/temporalio/sdk-java/issues/2042#issuecomment-2065696439",
      "viewerDidAuthor": false
    },
    {
      "id": "IC_kwDODN12PM57ICos",
      "author": {
        "login": "mfateev"
      },
      "authorAssociation": "MEMBER",
      "body": " Would you specify the currently implemented rules for the 6 sources of options and what is the logic behind them?",
      "createdAt": "2024-04-19T03:56:00Z",
      "includesCreatedEdit": false,
      "isMinimized": false,
      "minimizedReason": "",
      "reactionGroups": [],
      "url": "https://github.com/temporalio/sdk-java/issues/2042#issuecomment-2065705516",
      "viewerDidAuthor": true
    },
    {
      "id": "IC_kwDODN12PM57L86s",
      "author": {
        "login": "Quinn-With-Two-Ns"
      },
      "authorAssociation": "MEMBER",
      "body": "I am specifically talking about:\r\n \r\n[WorkflowImplementationOptions#defaultActivityOptions](https://github.com/temporalio/sdk-java/blob/1a0738c068a060f9aa174cf4286ffc357251b2a6/temporal-sdk/src/main/java/io/temporal/worker/WorkflowImplementationOptions.java#L97)\r\n[WorkflowImplementationOptions#activityOptions](https://github.com/temporalio/sdk-java/blob/1a0738c068a060f9aa174cf4286ffc357251b2a6/temporal-sdk/src/main/java/io/temporal/worker/WorkflowImplementationOptions.java#L84) map\r\n\r\nIf I set a default value for something and a specific value I would not expect them to be merged, the documentation does not say they will be merged.\r\n\r\nThe documentation for `setDefaultActivityOptions` explicitly say it will be overwritten. Ignoring the subjective concept of what is intuitive, I think from a backwards compatibility perspective I don't think we should change how the default options interact.\r\n\r\n```\r\n     * These activity options have the lowest precedence across all activity options. Will be\r\n     * overwritten entirely by {@link io.temporal.workflow.Workflow#newActivityStub(Class,\r\n     * ActivityOptions)} and then by the individual activity options if any are set through {@link\r\n     * #setActivityOptions(Map)}\r\n     *\r\n     * @param defaultActivityOptions ActivityOptions for all activities in the workflow.\r\n     */\r\n```",
      "createdAt": "2024-04-19T14:42:33Z",
      "includesCreatedEdit": false,
      "isMinimized": false,
      "minimizedReason": "",
      "reactionGroups": [],
      "url": "https://github.com/temporalio/sdk-java/issues/2042#issuecomment-2066730668",
      "viewerDidAuthor": false
    },
    {
      "id": "IC_kwDODN12PM57N82I",
      "author": {
        "login": "Quinn-With-Two-Ns"
      },
      "authorAssociation": "MEMBER",
      "body": "To clarify my opinion is default options should not be used if a more specific option for an activity type is specified. A default is a preselect option if no other is present, not a base to build more specific options form . This is \r\nhow we document `setDefaultActivityOptions`\r\n```\r\n  /**\r\n   * Sets the default activity options that will be used for activity stubs that have no {@link\r\n   * ActivityOptions} specified.<br>\r\n   * This overrides a value provided by {@link\r\n   * WorkflowImplementationOptions#getDefaultActivityOptions}.<br>\r\n   * A more specific per-activity-type option specified in {@link\r\n   * WorkflowImplementationOptions#getActivityOptions} or {@link #applyActivityOptions(Map)} takes\r\n   * precedence over this setting.\r\n   *\r\n   * @param defaultActivityOptions {@link ActivityOptions} to be used as a default\r\n   */\r\n  public static void setDefaultActivityOptions(ActivityOptions defaultActivityOptions) {\r\n    WorkflowInternal.setDefaultActivityOptions(defaultActivityOptions);\r\n  }\r\n```\r\n\r\nThe only time the default options should be considered is if no options are provided so , ignoring `null` options, I believe that is only if this method is used to construct a stub.\r\n\r\n```\r\nWorkflow.newActivityStub(Class<T> activityInterface)\r\n```\r\n\r\nOtherwise, If activity options are provides we should use the activity options, again ignoring `null` options, with this method\r\n\r\n```\r\n /**\r\n   * Creates client stub to activities that implement given interface.\r\n   *\r\n   * @param activityInterface interface type implemented by activities\r\n   * @param options options that together with the properties of {@link\r\n   *     io.temporal.activity.ActivityMethod} specify the activity invocation parameters\r\n   * @param activityMethodOptions activity method-specific invocation parameters\r\n   */\r\n  public static <T> T newActivityStub(\r\n      Class<T> activityInterface,\r\n      ActivityOptions options,\r\n      Map<String, ActivityOptions> activityMethodOptions) \r\n```\r\n* [WorkflowImplementationOptions#activityOptions](https://github.com/temporalio/sdk-java/blob/1a0738c068a060f9aa174cf4286ffc357251b2a6/temporal-sdk/src/main/java/io/temporal/worker/WorkflowImplementationOptions.java#L84)\r\n* [Workflow.applyActivityOptions](https://github.com/temporalio/sdk-java/blob/ed211fa611112288b576a2c979be9284e17fec89/temporal-sdk/src/main/java/io/temporal/internal/sync/WorkflowInternal.java#L276)\r\n* `options`\r\n* `activityMethodOptions`\r\n\r\nEdit: I believe this is the documented and intended behaviour, but the documentation and code is spread out enough that it is not trivial obvious which we should fix.",
      "createdAt": "2024-04-19T20:38:59Z",
      "includesCreatedEdit": true,
      "isMinimized": false,
      "minimizedReason": "",
      "reactionGroups": [],
      "url": "https://github.com/temporalio/sdk-java/issues/2042#issuecomment-2067254664",
      "viewerDidAuthor": false
    }
  ],
  "createdAt": "2024-04-18T01:21:27Z",
  "labels": [],
  "milestone": null,
  "number": 2042,
  "reactionGroups": [],
  "state": "OPEN",
  "title": "Activity options merging logic is not correct",
  "updatedAt": "2024-04-23T17:07:47Z",
  "url": "https://github.com/temporalio/sdk-java/issues/2042"
}
