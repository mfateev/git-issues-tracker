{
  "assignees": [
    {
      "id": "MDQ6VXNlcjExOTQyMg==",
      "login": "tsurdilo",
      "name": "Tihomir Surdilovic",
      "databaseId": 0
    }
  ],
  "author": {
    "id": "MDQ6VXNlcjUzMjEwOA==",
    "is_bot": false,
    "login": "Spikhalskiy",
    "name": "Dmitry Spikhalsky"
  },
  "body": "## Actual behavior\r\n\r\nhttps://github.com/Spikhalskiy/java-sdk/commit/40c0d626e0ea4778a956e388d33754e67bde23a8#diff-7cfba47d2337ff3ee746b09a4d916e5e839f9b8bff45a26e588727667437c160R94\r\n```\r\n  @Test\r\n  public void executeAndGetResultFromStub() throws InterruptedException, ExecutionException {\r\n    TestNoArgsWorkflowProc stubP =\r\n        testWorkflowRule.newWorkflowStubTimeoutOptions(TestNoArgsWorkflowProc.class);\r\n    WorkflowStub workflowStub = WorkflowStub.fromTyped(stubP);\r\n    CompletableFuture<Void> executeCF = WorkflowClient.execute(stubP::proc);\r\n\r\n    // This test hangs (times out), but uncommenting of either if these two lines makes it\r\n    // pass, which doesn't make much sense\r\n    // sleep(1000);\r\n    // executeCF.get();\r\n    workflowStub.getResult(Void.class);\r\n  }\r\n```\r\n\r\nThis unit test for a trivial workflow, that finishes immediately, hangs.\r\nUncommenting on either sleep or waiting for a completable future makes it pass.\r\nReplacing execute with start (that returns `WorkflowExecution`) also makes this test pass.\r\n\r\n## Expected behavior\r\n\r\nThe test passes.",
  "closedAt": null,
  "comments": [
    {
      "id": "IC_kwDODN12PM49sZjx",
      "author": {
        "login": "joelmarty"
      },
      "authorAssociation": "NONE",
      "body": "I am seeing a similar issue with `WorkflowClient.execute()` but not sure if it is exactly the same situation, as calling `Thread.sleep()` or waiting on the future does not fix it:\r\n\r\nThe use case looks like this:\r\n```java\r\nclass EventConsumer {\r\n\r\n  private WorkflowClient workflowClient;\r\n\r\n  public EventConsumer(WorkflowClient client) {\r\n    this.workflowClient = client;\r\n  }\r\n\r\n  public void accept(Stream<SomeEvent> eventStream) {\r\n    eventStream.forEach(event -> {\r\n      final var workflowOptions = WorkflowOptions.newBuilder()\r\n        .setTaskQueue(\"someQueue)\r\n        .setWorkflowId(event.getId())\r\n        .setWorkflowIdReusePolicy(WORKFLOW_ID_REUSE_POLICY_ALLOW_DUPLICATE_FAILED_ONLY)\r\n        .build();\r\n      final var workflow = workflowClient.newWorkflowStub(MyWorkflow.class, workflowOptions);\r\n      WorkflowClient.execute(workflow::processEvent, event)\r\n        .whenComplete((v, throwable) -> log.info(\"completed\"));\r\n    });\r\n  }\r\n}\r\n```\r\n\r\nThe test case uses junit5 extension:\r\n```java\r\nclass EventConsumerTest {\r\n  @RegisterExtension\r\n  public static final TestWorkflowExtension testWorkflowExtension = TestWorkflowExtension.newBuilder()\r\n    .setWorkflowClientOptions(WorkflowClientOptions.newBuilder()\r\n      .setNamespace(\"namespace\")\r\n      .build())\r\n    .setWorkflowTypes(MyWorkflow.class)\r\n    .setDoNotStart(true)\r\n    .build();\r\n\r\n  @Test\r\n  void startWorkflow(TestWorkflowEnvironment testEnv, Worker worker) {\r\n    MyActivity activity = mock(MyActivity.class, withSettings().withoutAnnotations());\r\n    worker.registerActivitiesImplementations(activity);\r\n    testEnv.start();\r\n\r\n    EventConsumer consumer = new EventConsumer(testEnv.getWorkflowClient());\r\n\r\n    // assertJ assertion\r\n    assertThatCode(() -> consumer.accept(Stream.of(event))).doesNotThrowAnyException();\r\n\r\n    // mockito verification\r\n    then(activity).should(timeout(5000)).doSomething();\r\n}\r\n```\r\n\r\nThe test times out after 5s as specified on the mockito verification and the (anonymized) log trace looks like this:\r\n```\r\n16:11:05.761 [main] INFO io.temporal.serviceclient.WorkflowServiceStubsImpl - Created GRPC client for channel: ManagedChannelOrphanWrapper{delegate=ManagedChannelImpl{logId=1, target=directaddress:///3c1827fc-4a62-4d7d-a725-efe16cfef991}}\r\n16:11:05.777 [main] INFO io.temporal.serviceclient.WorkflowServiceStubsImpl - Created GRPC client for channel: ManagedChannelOrphanWrapper{delegate=ManagedChannelImpl{logId=5, target=directaddress:///06e8951f-ef30-489d-80fb-ec06add9150e}}\r\n16:11:05.881 [main] INFO io.temporal.internal.worker.Poller - start: Poller{name=Workflow Poller taskQueue=\"WorkflowTest-startWorkflow(TestWorkflowEnvironment, Worker)-[engine:junit-jupiter]/[class:com.xyz.EventConsumerTest]/[method:startWorkflow(io.temporal.testing.TestWorkflowEnvironment, io.temporal.worker.Worker)]\", namespace=\"namespace\", identity=37008@myhostname}\r\n16:11:05.885 [main] INFO io.temporal.internal.worker.Poller - start: Poller{name=Local Activity Poller taskQueue=\"WorkflowTest-startWorkflow(TestWorkflowEnvironment, Worker)-[engine:junit-jupiter]/[class:com.xyz.EventConsumerTest]/[method:startWorkflow(io.temporal.testing.TestWorkflowEnvironment, io.temporal.worker.Worker)]\", namespace=\"namespace\", identity=37008@myhostname}\r\n16:11:05.887 [main] INFO io.temporal.internal.worker.Poller - start: Poller{name=Activity Poller taskQueue=\"namespace\", namespace=\"WorkflowTest-startWorkflow(TestWorkflowEnvironment, Worker)-[engine:junit-jupiter]/[class:com.xyz.EventConsumerTest]/[method:startWorkflow(io.temporal.testing.TestWorkflowEnvironment, io.temporal.worker.Worker)]\", identity=37008@myhostname}\r\n16:11:05.888 [main] INFO io.temporal.internal.worker.Poller - start: Poller{name=Host Local Workflow Poller, identity=90621874-bf17-42a0-b6b4-16b5f6433a3b}\r\n16:11:11.266 [main] INFO io.temporal.worker.WorkerFactory - shutdownNow: WorkerFactory{identity=37008@myhostname, uniqueId=90621874-bf17-42a0-b6b4-16b5f6433a3b}\r\n16:11:11.266 [main] INFO io.temporal.internal.worker.Poller - shutdown: Poller{name=Host Local Workflow Poller, identity=90621874-bf17-42a0-b6b4-16b5f6433a3b}\r\n16:11:11.272 [main] INFO io.temporal.worker.WorkerFactory - awaitTermination begin: WorkerFactory{identity=37008@myhostname, uniqueId=90621874-bf17-42a0-b6b4-16b5f6433a3b}\r\n16:11:11.272 [Host Local Workflow Poller: 3] INFO io.temporal.internal.worker.Poller - poll loop is terminated: io.temporal.internal.worker.Poller$PollLoopTask@2f410cb5\r\n16:11:11.272 [Host Local Workflow Poller: 4] INFO io.temporal.internal.worker.Poller - poll loop is terminated: io.temporal.internal.worker.Poller$PollLoopTask@1da8bb99\r\n16:11:11.272 [Host Local Workflow Poller: 2] INFO io.temporal.internal.worker.Poller - poll loop is terminated: io.temporal.internal.worker.Poller$PollLoopTask@368de08f\r\n16:11:11.272 [Host Local Workflow Poller: 1] INFO io.temporal.internal.worker.Poller - poll loop is terminated: io.temporal.internal.worker.Poller$PollLoopTask@56e21162\r\n16:11:11.272 [Host Local Workflow Poller: 5] INFO io.temporal.internal.worker.Poller - poll loop is terminated: io.temporal.internal.worker.Poller$PollLoopTask@18cc9d5b\r\n16:11:11.526 [TemporalShutdownManager: 1] INFO io.temporal.internal.worker.Poller - shutdown: Poller{name=Workflow Poller taskQueue=\"WorkflowTest-startWorkflow(TestWorkflowEnvironment, Worker)-[engine:junit-jupiter]/[class:com.xyz.EventConsumerTest]/[method:startWorkflow(io.temporal.testing.TestWorkflowEnvironment, io.temporal.worker.Worker)]\", namespace=\"namespace\", identity=37008@myhostname}\r\n16:11:11.527 [Workflow Poller taskQueue=\"WorkflowTest-startWorkflow(TestWorkflowEnvironment, Worker)-[engine:junit-jupiter]/[class:com.xyz.EventConsumerTest]/[method:startWorkflow(io.temporal.testing.TestWorkflowEnvironment, io.temporal.worker.Worker)]\", namespace=\"namespace\": 1] INFO io.temporal.internal.worker.Poller - poll loop is terminated: io.temporal.internal.worker.Poller$PollLoopTask@1d1ce3ca\r\n16:11:11.527 [Workflow Poller taskQueue=\"WorkflowTest-startWorkflow(TestWorkflowEnvironment, Worker)-[engine:junit-jupiter]/[class:com.xyz.EventConsumerTest]/[method:startWorkflow(io.temporal.testing.TestWorkflowEnvironment, io.temporal.worker.Worker)]\", namespace=\"namespace\": 2] INFO io.temporal.internal.worker.Poller - poll loop is terminated: io.temporal.internal.worker.Poller$PollLoopTask@61c24b97\r\n16:11:11.529 [TemporalShutdownManager: 1] INFO io.temporal.internal.worker.Poller - shutdown: Poller{name=Activity Poller taskQueue=\"namespace\", namespace=\"WorkflowTest-startWorkflow(TestWorkflowEnvironment, Worker)-[engine:junit-jupiter]/[class:com.xyz.EventConsumerTest]/[method:startWorkflow(io.temporal.testing.TestWorkflowEnvironment, io.temporal.worker.Worker)]\", identity=37008@myhostname}\r\n16:11:11.529 [TemporalShutdownManager: 1] INFO io.temporal.internal.worker.Poller - shutdown: Poller{name=Local Activity Poller taskQueue=\"WorkflowTest-startWorkflow(TestWorkflowEnvironment, Worker)-[engine:junit-jupiter]/[class:com.xyz.EventConsumerTest]/[method:startWorkflow(io.temporal.testing.TestWorkflowEnvironment, io.temporal.worker.Worker)]\", namespace=\"namespace\", identity=37008@myhostname}\r\n16:11:11.530 [Local Activity Poller taskQueue=\"WorkflowTest-startWorkflow(TestWorkflowEnvironment, Worker)-[engine:junit-jupiter]/[class:com.xyz.EventConsumerTest]/[method:startWorkflow(io.temporal.testing.TestWorkflowEnvironment, io.temporal.worker.Worker)]\", namespace=\"namespace\": 1] INFO io.temporal.internal.worker.Poller - poll loop is terminated: io.temporal.internal.worker.Poller$PollLoopTask@775ac2f4\r\n16:11:11.530 [Activity Poller taskQueue=\"namespace\", namespace=\"WorkflowTest-startWorkflow(TestWorkflowEnvironment, Worker)-[engine:junit-jupiter]/[class:com.xyz.EventConsumerTest]/[method:startWorkflow(io.temporal.testing.TestWorkflowEnvironment, io.temporal.worker.Worker)]\": 3] INFO io.temporal.internal.worker.Poller - poll loop is terminated: io.temporal.internal.worker.Poller$PollLoopTask@13f7bf0c\r\n16:11:11.530 [Activity Poller taskQueue=\"namespace\", namespace=\"WorkflowTest-startWorkflow(TestWorkflowEnvironment, Worker)-[engine:junit-jupiter]/[class:com.xyz.EventConsumerTest]/[method:startWorkflow(io.temporal.testing.TestWorkflowEnvironment, io.temporal.worker.Worker)]\": 5] INFO io.temporal.internal.worker.Poller - poll loop is terminated: io.temporal.internal.worker.Poller$PollLoopTask@17e59124\r\n16:11:11.530 [Activity Poller taskQueue=\"namespace\", namespace=\"WorkflowTest-startWorkflow(TestWorkflowEnvironment, Worker)-[engine:junit-jupiter]/[class:com.xyz.EventConsumerTest]/[method:startWorkflow(io.temporal.testing.TestWorkflowEnvironment, io.temporal.worker.Worker)]\": 2] INFO io.temporal.internal.worker.Poller - poll loop is terminated: io.temporal.internal.worker.Poller$PollLoopTask@1604dc95\r\n16:11:11.530 [Activity Poller taskQueue=\"namespace\", namespace=\"WorkflowTest-startWorkflow(TestWorkflowEnvironment, Worker)-[engine:junit-jupiter]/[class:com.xyz.EventConsumerTest]/[method:startWorkflow(io.temporal.testing.TestWorkflowEnvironment, io.temporal.worker.Worker)]\": 1] INFO io.temporal.internal.worker.Poller - poll loop is terminated: io.temporal.internal.worker.Poller$PollLoopTask@130e4636\r\n16:11:11.530 [Activity Poller taskQueue=\"namespace\", namespace=\"WorkflowTest-startWorkflow(TestWorkflowEnvironment, Worker)-[engine:junit-jupiter]/[class:com.xyz.EventConsumerTest]/[method:startWorkflow(io.temporal.testing.TestWorkflowEnvironment, io.temporal.worker.Worker)]\": 4] INFO io.temporal.internal.worker.Poller - poll loop is terminated: io.temporal.internal.worker.Poller$PollLoopTask@72885c3d\r\n16:11:11.783 [main] INFO io.temporal.worker.WorkerFactory - awaitTermination done: WorkerFactory{identity=37008@myhostname, uniqueId=90621874-bf17-42a0-b6b4-16b5f6433a3b}\r\n16:11:11.784 [main] INFO io.temporal.serviceclient.WorkflowServiceStubsImpl - shutdownNow\r\n16:11:11.790 [ForkJoinPool.commonPool-worker-19] DEBUG io.temporal.internal.retryer.GrpcAsyncRetryer - Retrying after failure\r\nio.grpc.StatusRuntimeException: UNAVAILABLE: Channel shutdownNow invoked\r\n```",
      "createdAt": "2022-02-10T15:24:06Z",
      "includesCreatedEdit": true,
      "isMinimized": false,
      "minimizedReason": "",
      "reactionGroups": [],
      "url": "https://github.com/temporalio/sdk-java/issues/856#issuecomment-1035049201",
      "viewerDidAuthor": false
    }
  ],
  "createdAt": "2021-11-03T22:36:18Z",
  "labels": [
    {
      "id": "MDU6TGFiZWwxNjIyNzE5ODQx",
      "name": "bug",
      "description": "Something isn't working",
      "color": "d73a4a"
    }
  ],
  "milestone": {
    "number": 12,
    "title": "Next",
    "description": "",
    "dueOn": null
  },
  "number": 856,
  "reactionGroups": [],
  "state": "OPEN",
  "title": "WorkflowClient#execute doesn't pair correctly with workflowStub.getResult()",
  "updatedAt": "2022-04-13T22:05:30Z",
  "url": "https://github.com/temporalio/sdk-java/issues/856"
}
