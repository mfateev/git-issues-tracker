{"assignees":[{"id":"MDQ6VXNlcjYzNTAzMDE=","login":"jbreiding","name":"Jeremy","databaseId":0}],"author":{"id":"MDQ6VXNlcjE2MTcxNzI2","is_bot":false,"login":"darewreck54","name":"Derek"},"body":"The exception below is thrown when trying to complete an activity.  \r\n\r\nbased on this thread https://community.temporal.io/t/reasonable-values-for-task-pollers/2257/2?u=darewreck it states that this could be due to \r\n\r\n```\r\ndue to activity timeouts. When an activity takes longer to complete than its StartToClose timeout the call to the service with the activity result is rejected with this message.\r\n```\r\n\r\nIn my case, the argument gets thrown because the activity is already completed.   Shouldn't another exception be thrown vs. `INVALID_ARGUMENT`\r\n\r\n```\r\n\"io.grpc.StatusRuntimeException: INVALID_ARGUMENT: Cannot locate Activity ScheduleID\r\n\tat io.grpc.stub.ClientCalls.toStatusRuntimeException(ClientCalls.java:262)\r\n\tat io.grpc.stub.ClientCalls.getUnchecked(ClientCalls.java:243)\r\n\tat io.grpc.stub.ClientCalls.blockingUnaryCall(ClientCalls.java:156)\r\n\tat io.temporal.api.workflowservice.v1.WorkflowServiceGrpc$WorkflowServiceBlockingStub.respondActivityTaskCompletedById(WorkflowServiceGrpc.java:2762)\r\n\tat io.temporal.internal.client.external.ManualActivityCompletionClientImpl.complete(ManualActivityCompletionClientImpl.java:135)\r\n\t... 85 common frames omitted\r\nWrapped by: io.temporal.client.ActivityCompletionFailureException: ActivityId=2be5aea6-d792-3e8d-b0ee-9117f6b246a8\r\n\tat io.temporal.internal.client.external.ManualActivityCompletionClientImpl.processException(ManualActivityCompletionClientImpl.java:294)\r\n\tat io.temporal.internal.client.external.ManualActivityCompletionClientImpl.complete(ManualActivityCompletionClientImpl.java:137)\r\n\tat io.temporal.internal.sync.ActivityCompletionClientImpl.complete(ActivityCompletionClientImpl.java:53)\r\n\tat jdk.internal.reflect.GeneratedMethodAccessor454.invoke(Unknown Source)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n\tat io.temporal.internal.WorkflowThreadMarker.lambda$protectFromWorkflowThread$1(WorkflowThreadMarker.java:80)\r\n\tat com.sun.proxy.$Proxy112.complete(Unknown Source)\r\n```","closedAt":"2022-03-02T23:41:37Z","comments":[{"id":"IC_kwDODNqesM4-lk_f","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"This is not a JavaSDK issue, this response code is defined by the server - transferring the issue into temporal/temporal repo.","createdAt":"2022-02-24T16:32:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2538#issuecomment-1050038239","viewerDidAuthor":false},{"id":"IC_kwDODNqesM4-lmfQ","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"It looks that `NOT_FOUND` or maybe `FAILED_PRECONDITION` is indeed a more correct code for this situation.\r\n\r\nAlso, Temporal Server may return a better message to help users understand what is the reason for the rejection.\r\nThe wording \"cannot locate\" should change, because it's surely in the workflow history for example. We either should say \"cannot locate in the mutable state\" or rephrase if we don't want to expose the implementation details and make it friendlier for users.\r\n\r\nMaybe something like `io.grpc.StatusRuntimeException: NOT_FOUND: Cannot find in-progress Activity Execution with the ScheduleID, it was never scheduled or already closed`.\r\n\r\nThis way we don't disclose internal implementation details about the mutable state but provide enough information that the activity has to be in-progress at the moment.","createdAt":"2022-02-24T16:39:11Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/2538#issuecomment-1050044368","viewerDidAuthor":false},{"id":"IC_kwDODNqesM4-2aww","author":{"login":"jbreiding"},"authorAssociation":"CONTRIBUTOR","body":"@Spikhalskiy This all makes sense. Changing the grpc code to `FAILED_PRECONDITION` or `NOT_FOUND`, would the SDK respond differently in either case?\r\n\r\n`NOT_FOUND` seems to make the most sense, this piece of the suggested message seems off `it was never scheduled or already closed`.\r\n\r\nGiven the SDK has the information about the activity if the response code is `NOT_FOUND` the sdk could lookup the activities last state and provide the exact cause for the activity and schedule ID not being in mutable state?","createdAt":"2022-02-28T16:47:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2538#issuecomment-1054452784","viewerDidAuthor":false},{"id":"IC_kwDODNqesM4-2fbm","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"@jbreiding \r\n> Changing the grpc code to FAILED_PRECONDITION or NOT_FOUND, would the SDK respond differently in either case?\r\n\r\nNo, SDK just has `io.temporal.client.ActivityCompletionFailureException` right now, which looks correct, SDK doesn't have much additional info other than the server error. But the underlying wrapped raw gRPC exception will make more sense for the users.\r\n\r\n> Given the SDK has the information about the activity if the response code is NOT_FOUND the sdk could lookup the activities last state and provide the exact cause for the activity and schedule ID not being in mutable state?\r\n\r\nIt's not really given. When we use ManualActivityCompletionClientImpl we are even outside of Temporal worker. The only thing that we have is basically an activityId and temporal API. \r\nBut even inside Temporal SDK, there is no way for SDK to figure out what happened here. Theoretically, we can try to query workflow history and try to analyze what happened with this activity, but it's a very heavy approach for a simple problem,\r\nSo it looks to me that the Server has to provide enough clues in the error for users to don't be lost.","createdAt":"2022-02-28T17:08:15Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2538#issuecomment-1054471910","viewerDidAuthor":false},{"id":"IC_kwDODNqesM4-2iBs","author":{"login":"jbreiding"},"authorAssociation":"CONTRIBUTOR","body":"I will update the error code and message.\r\n\r\nThe server during this api call only has the context for lookup in mutable state.\r\n\r\nPerhaps instead of `it was never scheduled or already closed.` the error message could suggest to look through workflow execution history to determine activity state?","createdAt":"2022-02-28T17:19:07Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2538#issuecomment-1054482540","viewerDidAuthor":false},{"id":"IC_kwDODNqesM4-2ir4","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"> Perhaps instead of it was never scheduled or already closed. the error message could suggest to look through workflow execution history to determine activity state?\r\n\r\nThis is a safe and 100% correct message, yeah. \r\n\r\nBut I was just thinking that we may give users the 99% message, but that may be immediately actionable and clear for them without even looking at history. I believe that in the vast majority of cases these two reasons will be causing the absence of activity in the mutable state if things work correctly and there are no bugs or some operational concerns that brought the mutable state in an incorrect state. Just keep in mind that history is a little bit scary for a lot of users. And often we say to users, they may be using Temporal without even deeply understanding the concept of history.","createdAt":"2022-02-28T17:21:54Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/2538#issuecomment-1054485240","viewerDidAuthor":false},{"id":"IC_kwDODNqesM4-2jRA","author":{"login":"jbreiding"},"authorAssociation":"CONTRIBUTOR","body":"Makes sense, I was hoping to have a more directional error message.\r\nLeading the user `where` to look for this state rather than just providing the possible causes.","createdAt":"2022-02-28T17:24:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2538#issuecomment-1054487616","viewerDidAuthor":false}],"createdAt":"2022-02-24T09:24:21Z","labels":[],"milestone":null,"number":2538,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"INVALID_ARGUMENT thrown when trying to complete an activity thats already completed","updatedAt":"2022-03-02T23:41:37Z","url":"https://github.com/temporalio/temporal/issues/2538"}
