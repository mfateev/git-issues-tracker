{"assignees":[],"author":{"id":"MDQ6VXNlcjMyNzI1NjM=","is_bot":false,"login":"giuliohome","name":"Giulio"},"body":"## Expected Behavior\r\n\r\nWe would expect a way to make Temporal aware of the key rotation.\r\n\r\n## Actual Behavior\r\n\r\nIt looks like Temporal caches the RSA keys returned from \"keySourceURIs\". See https://stackoverflow.com/questions/77305403/need-with-with-authentication-in-temporal-cluster\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nSteps described for example here https://devblogs.microsoft.com/ise/2023/07/12/temporal-mtls-sso/#3-running-temporal-server-with-authorization-enabled\r\n\r\n## Specifications\r\n\r\n  - Version: Latest Temporal.io\r\n  - Platform: Kubernetes installation via Helm Chart\r\n","closedAt":"2023-11-16T23:13:00Z","comments":[{"id":"IC_kwDODNqesM5sIOFr","author":{"login":"giuliohome"},"authorAssociation":"NONE","body":"Actually the [callback](https://github.com/temporalio/temporal/blob/a93926c8df968e784caadc030e7bdb9f2635ffde/common/authorization/default_token_key_provider.go#L119-L133) should periodically refresh the key\r\n\r\n```golang\r\nfunc (a *defaultTokenKeyProvider) timerCallback() {\r\n\tfor {\r\n\t\tselect {\r\n\t\tcase <-a.stop:\r\n\t\t\treturn\r\n\t\tcase <-a.ticker.C:\r\n\t\t}\r\n\t\tif a.config.HasSourceURIsConfigured() {\r\n\t\t\terr := a.updateKeys()\r\n\t\t\tif err != nil {\r\n\t\t\t\ta.logger.Error(\"error while refreshing token keys: \", tag.Error(err))\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n\r\nWill close this soon if it is confirmed to work.","createdAt":"2023-11-16T09:39:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5127#issuecomment-1814094187","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5sNS2e","author":{"login":"giuliohome"},"authorAssociation":"NONE","body":"Tested with personal azure subscription and demo cluster DOKR.\r\nThe configuration is done via environment variables:\r\n\r\n```yaml\r\nweb:\r\n    additionalEnv:\r\n      - name: \"TEMPORAL_AUTH_ENABLED\"\r\n        value: \"true\"\r\n      - name: \"TEMPORAL_AUTH_PROVIDER_URL\"\r\n        value: \"https://login.microsoftonline.com/.../v2.0\"\r\n      - name: \"TEMPORAL_AUTH_ISSUER_URL\"\r\n        value: \"https://login.microsoftonline.com/.../v2.0\"\r\n      - name: \"TEMPORAL_AUTH_CALLBACK_URL\"\r\n        value: \"https://mytemporal.giuliohome.com/auth/sso/callback\"\r\n      - name: \"TEMPORAL_AUTH_SCOPES\"\r\n        value: \"openid,api://.../default\"\r\n      - name: \"TEMPORAL_AUTH_CLIENT_ID\"\r\n        value: \"...\"\r\n      - name: \"TEMPORAL_AUTH_CLIENT_SECRET\"\r\n        value: \"...\"\r\n    config:\r\n      auth:\r\n        enabled: true\r\n        authorization:\r\n          authorizer: default\r\n          claimMapper: default\r\n          permissionsClaimName: roles\r\n          jwtKeyProvider:\r\n            keySourceURIs:\r\n              - https://login.microsoftonline.com/.../discovery/discovery/v2.0/keys\r\n            refreshInterval: \"5m\"\r\n```\r\n\r\n\r\nin my case I used cloudflare dns to get automatic tls and I have to add an annotation for my nginx ingress\r\n\r\n```yaml\r\n  annotations:\r\n    kubernetes.io/ingress.class: nginx\r\n    nginx.ingress.kubernetes.io/proxy-buffer-size: 10k\r\n```\r\nThe key rotation process seems to be (semi)manual afaics. I've had to add a new secret in the client secrets tab of azure app registration and then I've had to `helm upgrade -f` the new value of\r\n\r\n```yaml\r\nweb:\r\n    additionalEnv:\r\n\r\n      - name: \"TEMPORAL_AUTH_CLIENT_SECRET\"\r\n        value: \"...\"\r\n```\r\n\r\n![immagine](https://github.com/temporalio/temporal/assets/3272563/6c7a2c79-6b33-409a-a7ac-828fd39e8c0b)\r\n","createdAt":"2023-11-16T22:36:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5127#issuecomment-1815424414","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5sNc7Y","author":{"login":"giuliohome"},"authorAssociation":"NONE","body":"I would conclude that Temporal does not cache the key when a `refreshInterval` is defined. Therefore, I assume that there is no problem when Microsoft rotates the signing keys. However, I have no way to further verify this since it is a process managed by Microsoft Azure.","createdAt":"2023-11-16T23:13:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5127#issuecomment-1815465688","viewerDidAuthor":false}],"createdAt":"2023-11-16T09:29:45Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":5127,"reactionGroups":[],"state":"CLOSED","title":"Key Rotation for Temporal Authentication and Authorization using Azure AD","updatedAt":"2023-11-16T23:13:01Z","url":"https://github.com/temporalio/temporal/issues/5127"}
