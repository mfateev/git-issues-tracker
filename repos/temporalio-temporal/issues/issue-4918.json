{"assignees":[{"id":"MDQ6VXNlcjg0NDExMDE0","login":"yiminc","name":"Yimin Chen","databaseId":0}],"author":{"id":"MDQ6VXNlcjg3NjI4OTM=","is_bot":false,"login":"wxing1292","name":"Wenquan Xing"},"body":"## Expected Behavior\r\nWhen TLS certs are updated, properly propagate the cert changes to admin / frontend / matching / history clients\r\n\r\n## Actual Behavior\r\nSeems that \r\n[GetRemoteAdminClient](https://github.com/temporalio/temporal/blob/main/client/client_bean.go#L177)\r\n[GetRemoteFrontendClient](https://github.com/temporalio/temporal/blob/main/client/client_bean.go#L226)\r\nboth functions will cache created admin / frontend client forever, even after TLS certs are updated\r\n","closedAt":"2023-10-17T17:12:37Z","comments":[{"id":"IC_kwDODNqesM5oZWAV","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"Have you verified this? I just walked through the code and it looks like it's doing all the right things to refresh certs everywhere, including remote admin/frontend connections. (Just because the grpc client isn't changing doesn't mean the underlying tls connection isn't reloading certs.)","createdAt":"2023-10-06T22:41:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4918#issuecomment-1751474197","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5oZh0f","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"I have verified that TLS cert refresh does not work; Cert is updated in k8s but client cannot talk to remote; rolling restart fixed the issue; this is probably the second time we have seems this issue;\r\n\r\nfrom my reading the clients are created and cached in memory; never refreshed (see above link) \r\nSo can you point me to the logic which updates the clients?  ","createdAt":"2023-10-07T00:20:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4918#issuecomment-1751522591","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5oqfYY","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"Just to be sure, did you set `refreshInterval` within `global.tls`? It defaults to 0 (no refresh)\r\n\r\nReloading certs happens way below creation of grpc clients. See e.g.\r\nhttps://github.com/temporalio/temporal/blob/main/common/auth/tls_config_helper.go#L65-L67\r\nhttps://github.com/temporalio/temporal/blob/main/common/rpc/encryption/local_store_tls_provider.go#L318\r\nIt sets callbacks and the Go TLS stack calls them when appropriate, you don't need to recreate the grpc client.\r\nThe refresh is here:\r\nhttps://github.com/temporalio/temporal/blob/main/common/rpc/encryption/local_store_cert_provider.go#L81-L85\r\nhttps://github.com/temporalio/temporal/blob/main/common/rpc/encryption/local_store_cert_provider.go#L523\r\n","createdAt":"2023-10-10T18:05:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/4918#issuecomment-1755969048","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5oq0Al","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"> Just to be sure, did you set `refreshInterval` within `global.tls`? It defaults to 0 (no refresh)\r\n> \r\n> Reloading certs happens way below creation of grpc clients. See e.g. https://github.com/temporalio/temporal/blob/main/common/auth/tls_config_helper.go#L65-L67 https://github.com/temporalio/temporal/blob/main/common/rpc/encryption/local_store_tls_provider.go#L318 It sets callbacks and the Go TLS stack calls them when appropriate, you don't need to recreate the grpc client. The refresh is here: https://github.com/temporalio/temporal/blob/main/common/rpc/encryption/local_store_cert_provider.go#L81-L85 https://github.com/temporalio/temporal/blob/main/common/rpc/encryption/local_store_cert_provider.go#L523\r\n\r\ncc @dynajoe ","createdAt":"2023-10-10T18:55:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4918#issuecomment-1756053541","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5pN0OJ","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"I tried to reproduce this in a bunch of ways:\r\n\r\n1. I set up two development servers (A and B) connected to each other with one CA and each one using a different cert.\r\n`refreshInterval` was set to 10s on both.\r\nAfter setting up the connections, I replaced B's certs with a cert signed by a different CA and then restarted the servers.\r\nAs expected, B started logging errors connecting to A (which was rejecting the cert signed by the wrong CA).\r\n(I'm not entirely sure why A didn't log errors connection to B here.)\r\nWithout restarting B, I replaced its cert with a good one again.\r\nEventually (after both worker and history reloaded certs), it stopped logging errors.\r\nI confirmed (by adding printfs) that it does not do another call to `grpc.Dial` after startup, the cert reload was enough.\r\n\r\n2. Then I tried replacing B's good cert with a bad one again, without restarting the server.\r\nThings continued working for several minutes using the established connection, but within 5 minutes (maybe a total connection length limit?), it started logging errors.\r\nI replaced B's cert with a good one (again without restarting), and both eventually stopped logging errors.\r\n\r\n4. Last, I replaced B's cert with one that expires in 5 minutes and started both clusters.\r\nAfter 5 minutes, I didn't see any errors immediately, but within 5 more minutes it started logging errors (client: `connection error: desc = \"transport: authentication handshake failed: tls: failed to verify certificate: x509: certificate has expired or is not yet valid: current time 2023-10-16T13:21:01-07:00 is after 2023-10-16T20:16:47Z\"`, server: `connection error: desc = \"error reading server preface: remote error: tls: expired certificate\"`).\r\nI replaced B's cert with a good one again, and both eventually stopped logging errors.\r\n\r\nSo it looks like cert reloading does seem to work in a local test setup.\r\n","createdAt":"2023-10-16T20:34:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4918#issuecomment-1765229449","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5pT9Bn","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"Closing this since the code in this repo is working fine, the problem @wxing1292 was observing is elsewhere.","createdAt":"2023-10-17T17:12:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4918#issuecomment-1766838375","viewerDidAuthor":false}],"createdAt":"2023-09-29T22:21:21Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4918,"reactionGroups":[],"state":"CLOSED","title":"Propagate TLS certs updates to admin / frontend / matching / history clients","updatedAt":"2023-10-17T17:12:37Z","url":"https://github.com/temporalio/temporal/issues/4918"}
