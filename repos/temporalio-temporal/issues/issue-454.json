{"assignees":[],"author":{"id":"MDQ6VXNlcjUyMjI1MTI=","is_bot":false,"login":"hazcod","name":"Niels Hofmans"},"body":"## Expected Behavior\r\ntemporal connecting to my cockroachdb instance.\r\n\r\n## Actual Behavior\r\n```\r\npostgres started\r\n\r\nsetup postgres schema\r\n\r\n2020/06/15 10:12:18 error creating database:pq: database \"temporal\" already exists\r\n\r\n+ temporal-sql-tool --plugin postgres --ep postgres -u root --pw ''\\'''\\''' -p 26257 --db temporal setup-schema -v 0.0\r\n\r\n2020/06/15 10:12:18 Starting schema setup, config=&{SchemaFilePath: InitialVersion:0.0 Overwrite:false DisableVersioning:false}\r\n\r\n2020/06/15 10:12:18 Setting up version tables\r\n\r\n2020/06/15 10:12:18 pq: relation \"schema_version\" already exists\r\n\r\n+ temporal-sql-tool --plugin postgres --ep postgres -u root --pw ''\\'''\\''' -p 26257 --db temporal update-schema -d /etc/temporal/schema/postgres/temporal/versioned\r\n\r\n2020/06/15 10:12:18 UpdateSchemeTask started, config=&{DBName: TargetVersion: SchemaDir:/etc/temporal/schema/postgres/temporal/versioned IsDryRun:false}\r\n\r\n2020/06/15 10:12:18 found zero updates from current version 1.0\r\n\r\n2020/06/15 10:12:18 UpdateSchemeTask done\r\n\r\n+ VISIBILITY_SCHEMA_DIR=/etc/temporal/schema/postgres/visibility/versioned\r\n\r\n+ temporal-sql-tool --plugin postgres --ep postgres -u root --pw ''\\'''\\''' -p 26257 create --db temporal_visibility\r\n\r\n2020/06/15 10:12:18 error creating database:pq: database \"temporal_visibility\" already exists\r\n\r\n+ temporal-sql-tool --plugin postgres --ep postgres -u root --pw ''\\'''\\''' -p 26257 --db temporal_visibility setup-schema -v 0.0\r\n\r\n2020/06/15 10:12:18 Starting schema setup, config=&{SchemaFilePath: InitialVersion:0.0 Overwrite:false DisableVersioning:false}\r\n\r\n2020/06/15 10:12:18 Setting up version tables\r\n\r\n2020/06/15 10:12:18 pq: relation \"schema_version\" already exists\r\n\r\n+ temporal-sql-tool --plugin postgres --ep postgres -u root --pw ''\\'''\\''' -p 26257 --db temporal_visibility update-schema -d /etc/temporal/schema/postgres/visibility/versioned\r\n\r\n2020/06/15 10:12:18 UpdateSchemeTask started, config=&{DBName: TargetVersion: SchemaDir:/etc/temporal/schema/postgres/visibility/versioned IsDryRun:false}\r\n\r\n2020/06/15 10:12:18 found zero updates from current version 1.0\r\n\r\n2020/06/15 10:12:18 UpdateSchemeTask done\r\n\r\n+ '[' '' '!=' true ']'\r\n\r\n+ + '[' false == true ']'\r\n\r\n+ bash /start-temporal.sh\r\n\r\nregister_default_namespace\r\n\r\n+ echo 'Temporal CLI Address: 172.18.0.4:7233'\r\n\r\nTemporal CLI Address: 172.18.0.4:7233\r\n\r\n^B\r\n\r\n+ sleep 5\r\n\r\n+ dockerize -template /etc/temporal/config/config_template.yaml:/etc/temporal/config/docker.yaml\r\n\r\n+ exec temporal-server --root /etc/temporal --env docker start --services=history,matching,frontend,worker\r\n\r\n2020/06/15 10:12:19 Loading config; env=docker,zone=,configDir=/etc/temporal/config\r\n\r\n2020/06/15 10:12:19 Loading configFiles=[/etc/temporal/config/docker.yaml]\r\n\r\n2020/06/15 10:12:19 sql schema version compatibility check failed: unable to create SQL connection: dial tcp 127.0.0.1:26257: connect: connection refused\r\n\r\n+ DB=postgres\r\n\r\n+ ENABLE_ES=false\r\n\r\n+ ES_PORT=9200\r\n\r\n+ RF=1\r\n\r\n+ DEFAULT_NAMESPACE=default\r\n\r\n+ DEFAULT_NAMESPACE_RETENTION=1\r\n\r\n+ export TEMPORAL_CLI_ADDRESS=172.18.0.4:7233\r\n\r\n+ TEMPORAL_CLI_ADDRESS=172.18.0.4:7233\r\n\r\n+ export KEYSPACE=temporal\r\n\r\n+ KEYSPACE=temporal\r\n\r\n+ export VISIBILITY_KEYSPACE=temporal_visibility\r\n\r\n+ VISIBILITY_KEYSPACE=temporal_visibility\r\n\r\n+ export DBNAME=temporal\r\n\r\n+ DBNAME=temporal\r\n\r\n+ export VISIBILITY_DBNAME=temporal_visibility\r\n\r\n+ VISIBILITY_DBNAME=temporal_visibility\r\n\r\n+ export DB_PORT=26257\r\n\r\n+ DB_PORT=26257\r\n\r\n+ '[' true = true ']'\r\n\r\n+ auto_setup\r\n\r\n+ wait_for_db\r\n\r\n+ '[' postgres == mysql ']'\r\n\r\n+ '[' postgres == postgres ']'\r\n\r\n+ wait_for_postgres\r\n\r\n++ awk -F , '{print $1}'\r\n\r\n++ echo postgres\r\n\r\n+ server=postgres\r\n\r\n+ nc -z postgres 26257\r\n\r\npostgres started\r\n\r\nsetup postgres schema\r\n\r\n+ '[' 0 -eq 0 ']'\r\n\r\n+ echo 'postgres started'\r\n\r\n+ '[' '' '!=' true ']'\r\n\r\n+ setup_schema\r\n\r\n+ '[' postgres == mysql ']'\r\n\r\n+ '[' postgres == postgres ']'\r\n\r\n+ echo 'setup postgres schema'\r\n\r\n+ setup_postgres_schema\r\n\r\n+ SCHEMA_DIR=/etc/temporal/schema/postgres/temporal/versioned\r\n\r\n+ temporal-sql-tool --plugin postgres --ep postgres -u root --pw ''\\'''\\''' -p 26257 create --db temporal\r\n\r\n2020/06/15 10:12:21 error creating database:pq: database \"temporal\" already exists\r\n\r\n+ temporal-sql-tool --plugin postgres --ep postgres -u root --pw ''\\'''\\''' -p 26257 --db temporal setup-schema -v 0.0\r\n\r\n2020/06/15 10:12:21 Starting schema setup, config=&{SchemaFilePath: InitialVersion:0.0 Overwrite:false DisableVersioning:false}\r\n\r\n2020/06/15 10:12:21 Setting up version tables\r\n\r\n2020/06/15 10:12:21 pq: relation \"schema_version\" already exists\r\n\r\n+ temporal-sql-tool --plugin postgres --ep postgres -u root --pw ''\\'''\\''' -p 26257 --db temporal update-schema -d /etc/temporal/schema/postgres/temporal/versioned\r\n\r\n2020/06/15 10:12:21 UpdateSchemeTask started, config=&{DBName: TargetVersion: SchemaDir:/etc/temporal/schema/postgres/temporal/versioned IsDryRun:false}\r\n\r\n2020/06/15 10:12:21 found zero updates from current version 1.0\r\n\r\n2020/06/15 10:12:21 UpdateSchemeTask done\r\n\r\n+ VISIBILITY_SCHEMA_DIR=/etc/temporal/schema/postgres/visibility/versioned\r\n\r\n+ temporal-sql-tool --plugin postgres --ep postgres -u root --pw ''\\'''\\''' -p 26257 create --db temporal_visibility\r\n\r\n2020/06/15 10:12:21 error creating database:pq: database \"temporal_visibility\" already exists\r\n\r\n+ temporal-sql-tool --plugin postgres --ep postgres -u root --pw ''\\'''\\''' -p 26257 --db temporal_visibility setup-schema -v 0.0\r\n\r\n2020/06/15 10:12:21 Starting schema setup, config=&{SchemaFilePath: InitialVersion:0.0 Overwrite:false DisableVersioning:false}\r\n\r\n2020/06/15 10:12:21 Setting up version tables\r\n\r\n2020/06/15 10:12:21 pq: relation \"schema_version\" already exists\r\n\r\n+ temporal-sql-tool --plugin postgres --ep postgres -u root --pw ''\\'''\\''' -p 26257 --db temporal_visibility update-schema -d /etc/temporal/schema/postgres/visibility/versioned\r\n\r\n2020/06/15 10:12:21 UpdateSchemeTask started, config=&{DBName: TargetVersion: SchemaDir:/etc/temporal/schema/postgres/visibility/versioned IsDryRun:false}\r\n\r\n2020/06/15 10:12:21 found zero updates from current version 1.0\r\n\r\n2020/06/15 10:12:21 UpdateSchemeTask done\r\n\r\n+ '[' '' '!=' true ']'\r\n\r\nTemporal CLI Address: 172.18.0.4:7233\r\n\r\n+ + register_default_namespace\r\n\r\n+ echo 'Temporal CLI Address: 172.18.0.4:7233'\r\n\r\n^B\r\n\r\n+ sleep 5\r\n\r\n'[' false == true ']'\r\n\r\n+ bash /start-temporal.sh\r\n\r\n+ dockerize -template /etc/temporal/config/config_template.yaml:/etc/temporal/config/docker.yaml\r\n\r\n+ exec temporal-server --root /etc/temporal --env docker start --services=history,matching,frontend,worker\r\n\r\n2020/06/15 10:12:21 Loading config; env=docker,zone=,configDir=/etc/temporal/config\r\n\r\n2020/06/15 10:12:21 Loading configFiles=[/etc/temporal/config/docker.yaml]\r\n\r\n2020/06/15 10:12:21 sql schema version compatibility check failed: unable to create SQL connection: dial tcp 127.0.0.1:26257: connect: connection refused\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n```yaml\r\n  temporal:\r\n    image: temporalio/auto-setup:0.23.1\r\n    restart: \"on-failure:5\"\r\n    networks:\r\n    - backend\r\n    environment:\r\n      - \"DB=postgres\"\r\n      - \"DB_PORT=26257\"\r\n      - \"POSTGRES_USER=root\"\r\n      - \"POSTGRES_PWD=''\"\r\n      - \"POSTGRES_SEEDS=postgres\"\r\n    links:\r\n    - temporaldb:postgres\r\n    ports:\r\n    - 7233\r\n    depends_on:\r\n    - temporaldb\r\n```\r\n","closedAt":"2020-06-16T09:22:25Z","comments":[],"createdAt":"2020-06-15T10:13:56Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":454,"reactionGroups":[],"state":"CLOSED","title":"dial tcp 127.0.0.1:26257: connect: connection refused","updatedAt":"2020-06-16T09:22:25Z","url":"https://github.com/temporalio/temporal/issues/454"}
