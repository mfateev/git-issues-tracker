{"assignees":[{"id":"MDQ6VXNlcjg0NDExMDE0","login":"yiminc","name":"Yimin Chen","databaseId":0}],"author":{"id":"MDQ6VXNlcjQ3MTI0MzA=","is_bot":false,"login":"danielhochman","name":"Daniel Hochman"},"body":"**Is your feature request related to a problem? Please describe.**\r\nMy team is working on a new deployment of Temporal and we recently spent an entire day debugging an issue related to a missing key in configuration due to lack of error messaging and validation by the bootstrap code.\r\n\r\nExample:\r\n```\r\nmetrics:\r\n  hostPort: \"127.0.0.1:8125\"\r\n  prefix: \"temporal\"\r\n```\r\nneeded to be \r\n```\r\nmetrics:\r\n  statsd:\r\n    hostPort: \"127.0.0.1:8125\"\r\n    prefix: \"temporal\"\r\n```\r\n\r\nThe server started up fine, the logic to configure the [bootstrap code looked for any of the custom configured reporters](https://github.com/temporalio/temporal/blob/e153684480968b9b271574b589abaedd5525a255/common/metrics/config.go#L260-L271), didn't find any, and everything booted as normal, only we were not getting any stats.\r\n\r\n**Describe the solution you'd like**\r\nI would like the option for strict config validation. If a key is unrecognized, the server should fail to start so it can be corrected.\r\n\r\nI'm happy to put together a PR for option 1 below if someone can give their thoughts and approval on the approach.\r\n\r\n**Describe alternatives you've considered**\r\n\r\n- **Option 1**\r\nChange YAML unmarshaling to reject unknown fields (see [yaml.Decoder.KnownFields](https://pkg.go.dev/gopkg.in/yaml.v3#Decoder.KnownFields)), and ideally expand the use of the `gopkg.in/validator.v2` throughout the config structs.\r\nCould we move to this as a default? If not add a flag which the server supports to unmarshal the config in strict mode. \r\n\r\n- **Option 2**\r\nMove to protobuf for configuration specifications. This would have the benefit of centralizing config specifications in a single place and definition language rather than scattering structs throughout the code base.\r\nI previously made this suggestion in a [`#development Slack thread](https://temporalio.slack.com/archives/CTQU95E84/p1639591413096200):\r\n> Has the team considered moving to protobuf for the config schema? discovery and validation are subpar with how it's all done with structs currently. Example from our project [lyft/clutch](github.com/lyft/clutch) which uses proto for defining config and uses [envoyproxy/protoc-gen-validate](https://github.com/envoyproxy/protoc-gen-validate) for validation:\r\n> - Config definition: [api/config/gateway/v1/gateway.proto](https://github.com/lyft/clutch/blob/43aa67e73d776f3d232ea5d1188f01e194c50b63/api/config/gateway/v1/gateway.proto).\r\n> - Example YAML conforming to definition: [clutch-config.yaml](https://github.com/lyft/clutch/blob/43aa67e73d776f3d232ea5d1188f01e194c50b63/backend/clutch-config.yaml)\r\n> - Example output from a bad config: `{\"level\":\"fatal\",\"ts\":1641326218.3299987,\"caller\":\"gateway/config.go:71\",\"msg\":\"configuration proto validation failed\",\"file\":\"clutch-config.yaml\",\"error\":\"invalid Config.Gateway: embedded message failed validation | caused by: invalid GatewayOptions.Listener: value is required\"}`","closedAt":null,"comments":[{"id":"IC_kwDODNqesM48CGys","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"@danielhochman , option 1 looks good to me. I would like the behavior to enforce strict mode only for known configs. So, below example will fail the validation because hostPort and prefix is unknown field to metrics:\r\n```\r\nmetrics:\r\n  hostPort: \"127.0.0.1:8125\"\r\n  prefix: \"temporal\"\r\n```\r\nAnd ideally, this should be enforced when opt-in so we don't break any production cluster when user upgrade to newer version. \r\n\r\n~~However, I don't want this restriction to apply to other top level config that is unknown to temporal. For example, there might be a zookeeper config in the file as top level config that temporal does not know about but is used by some other part of the process. So below config should not fail validation:~~\r\n```\r\nmetrics:\r\n  statsd:\r\n    hostPort: \"127.0.0.1:8125\"\r\n    prefix: \"temporal\"\r\nmyLeaderElection:\r\n  someConfigKey: someValue\r\n```\r\n~~The `myLeaderElection` is unknown, but we should ignore it and any field underneath it.~~\r\n\r\n~~Does that make sense?~~\r\n","createdAt":"2022-01-07T07:02:20Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2341#issuecomment-1007185068","viewerDidAuthor":false},{"id":"IC_kwDODNqesM48JqZ_","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"I don't really like the idea of ignoring unknown top-level fields. If it's going to be strict, it should all be strict.\r\n\r\nMixing config for multiple applications in the same file seems a little weird to me. What if the apps both specify some of the same top-level keys? If you want to do it, how about this instead: There can be an optional flag that takes a key name. If specified, use the value of that key in the yaml file as the temporal config, instead of the top level. That is, if you want to mix, it could look like:\r\n\r\n```\r\ntemporal:\r\n  metrics:\r\n    statsd:\r\n      ...\r\notherApp:\r\n  myLeaderElection:\r\n    ...\r\n```\r\n\r\nAnd then run `temporal-server --env=myenv --configsubkey=temporal`. Any other apps would also need to accept a similar flag.","createdAt":"2022-01-10T17:38:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2341#issuecomment-1009165951","viewerDidAuthor":false},{"id":"IC_kwDODNqesM48Ky7b","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Another approach in handling the config for other parts of the app is to require them to be organized in different config files. I think that might be cleaner. So I agree with @dnr to either enable or not enable for strict mode for the whole config. @danielhochman I would be welcome your proposed option 1 solution, it would be great if you could contribute to this work. :) ","createdAt":"2022-01-10T23:46:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2341#issuecomment-1009463003","viewerDidAuthor":false},{"id":"IC_kwDODNqesM48NQ3V","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I agree with @dnr - I don't like ignoring unknown top-level fields. If you want to reuse the config struct yourself and add other top-level fields, you can embed it and add the `inline` field tag or something.","createdAt":"2022-01-11T16:02:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2341#issuecomment-1010109909","viewerDidAuthor":false}],"createdAt":"2022-01-04T20:12:59Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwzMTM4ODI4MTE3","name":"up-for-grabs","description":"Issues to consider for external contribution","color":"69CD90"}],"milestone":null,"number":2341,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"OPEN","title":"config: strict mode for configuration parsing","updatedAt":"2023-03-03T20:21:13Z","url":"https://github.com/temporalio/temporal/issues/2341"}
