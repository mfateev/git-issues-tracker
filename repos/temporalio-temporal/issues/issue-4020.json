{"assignees":[{"id":"MDQ6VXNlcjM3NzA0Nzg=","login":"yux0","name":"Yu Xia","databaseId":0}],"author":{"id":"MDQ6VXNlcjEwNzQ5MzYx","is_bot":false,"login":"emmercm","name":"Christian Emmer"},"body":"## Expected Behavior\r\nWhen:\r\n\r\n* Making use of `Workflow.sleep()`\r\n* Using multi-cluster replication\r\n* Switching the active cluster for a namespace\r\n\r\nThen the time between `TimerStarted` and `TimerFired` should be minimal.\r\n\r\n## Actual Behavior\r\nI've observed the time between `TimerStarted` and `TimerFired` to be more than 10 minutes.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n1. Have two Temporal clusters, `cluster-a` and `cluster-b`, with multi-cluster replication enabled\r\n1. Have one Java service with two SDK clients, one for each cluster\r\n1. Make a workflow with the following steps:\r\n  a. Execute an activity that returns immediately\r\n  b. `Workflow.sleep(500)`\r\n  c. Execute an activity that returns immediately\r\n  d. `Workflow.sleep(500)`\r\n  e. Execute an activity that returns immediately\r\n  f. `Workflow.sleep(500)`\r\n  g. Execute an activity that returns immediately\r\n  h. `Workflow.sleep(500)`\r\n  i. Execute an activity that returns immediately\r\n  j. `Workflow.sleep(500)`\r\n1. Schedule that workflow on a short cron:\r\n\r\n    ```shell\r\n    tctl --namespace sandbox workflow start --taskqueue sandbox --workflow_type DummyWorkflow --cron \"@every 10s\"\r\n    ```\r\n\r\n1. Change the active cluster for the namespace in the middle of workflow execution:    \r\n\r\n    ```shell\r\n    tctl --namespace sandbox namespace update --active_cluster cluster-b\r\n    ```\r\n\r\n1. Repeat the previous step until the workflow's event history appears to be stuck waiting for `TimerFired` (the last event in history is `TimerStarted`). Only repeat the step every ~60sec so the thrash isn't crippling.\r\n1. Wait ~10 minutes\r\n1. Observe that `TimerFired` did eventually fire\r\n\r\n## Specifications\r\n\r\n* Version: local `temporal/auto-setup:1.19.0` with Java SDK v1.18.2\r\n* Platform: macOS Ventura v13.2.1 Intel, Docker v20.10.23\r\n\r\nI'm hoping there is a simple answer to this behavior, such as a timeout I'm missing. I'm not setting explicit timeouts in the above `tctl` commands, and I'm not setting explicit activity timeouts in the workflow code. The UI doesn't show a timeout for timer tasks in the way it does for workflow tasks, so I'm not positive I can affect this behavior.\r\n\r\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM5Xash5","author":{"login":"yux0"},"authorAssociation":"MEMBER","body":"The repeated 10s cron with 500 milliseconds sleeps is very aggressive. Could you double check if the e2e timer latency is high? (metrics: task_latency_queue_bucket with operation=\"TimerActive*\" or \"TimerStandby*\"). I guess there is backlog in timer queue.","createdAt":"2023-03-13T17:45:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4020#issuecomment-1466615929","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5YAQY0","author":{"login":"emmercm"},"authorAssociation":"NONE","body":"It's definitely aggressive, and it's not realistic. I wanted to create a scenario that was putting a constant load on Temporal, and chose to use one workflow instead of many.\r\n\r\nI will check out those metrics now!","createdAt":"2023-03-20T15:35:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4020#issuecomment-1476462132","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5YGMsX","author":{"login":"emmercm"},"authorAssociation":"NONE","body":"I set up Grafana with a local Docker Compose to visualize this, but I'm less familiar with Grafana, I usually have a Datadog agent scrape Prometheus, and then I visualize metrics in the Datadog UI. Let me know if I'm missing anything below.\r\n\r\nReproducing the scenario where the workflow is stuck after `TimerStarted`, waiting on `TimerFired`, I see:\r\n\r\n- `histogram_quantile(0.95, sum by(le, operation) (rate(task_latency_queue_bucket{operation=~\"TimerActive.+|TimerStandby.+\"}[$__rate_interval])))` stops plotting points, `task_latency_queue_bucket{operation=~\"TimerActive.+|TimerStandby.+\"}` stays flat for the ~10min the problem happens for\r\n- Using [Tihomirs's dashboards](https://github.com/tsurdilo/my-temporal-dockercompose) I see:\r\n  - Workflow and activity task scheduled, started, and completed all halt (expected)\r\n  - State transition halts (expected)\r\n  - No significant change to memory or goroutines\r\n  - Changes to `services_requests`:\r\n    - Some stayed flat/consistent (in order of most to the least requests): `PollActivityTaskQueue`, `GetReplicationMessages`, `PollWorkflowTaskQueue`, `GetNamespaceReplicationMessages` decreased to near zero if not zero.\r\n    - Some increased during the problem (in no particular order): `DescribeTaskQueue`, `DescribeWorkflowExecution`, `GetMutableState`, `GetWorkflowExecutionHistory`, `GetWorkflowExecutionHistoryReverse`, `PollMutableState`\r\n  - Changes to `persistence_requests`:\r\n    - Some stayed flat/consistent (in no particular order): `UpdateTaskQueue`, `GetAckLevel`, `UpdateAckLevel`, `GetMetadata`, `UpsertClusterMembership`, `AssertShardOwnership`, `ListClusterMetadata`, `ListNamespaces`, `ReadQueueMessages`, `UpdateShard`, `UpdateTaskQueue`\r\n    - Only one increased during the problem: `ReadHistoryBranchReverse`\r\n\r\nAnd if it's helpful:\r\n\r\n```shell\r\n$ docker ps\r\n\r\nCONTAINER ID   IMAGE                           COMMAND                  CREATED          STATUS          PORTS                                                                                              NAMES\r\na4ddb403fdff   temporalio/admin-tools:1.19.0   \"tail -f /dev/null\"      29 minutes ago   Up 29 minutes                                                                                                      temporal-admin-tools-b\r\n4dbc4e652f85   temporalio/ui:2.11.1            \"./start-ui-server.sh\"   29 minutes ago   Up 29 minutes   0.0.0.0:8081->8080/tcp                                                                             temporal-ui-b\r\nd02517932c2d   temporalio/ui:2.11.1            \"./start-ui-server.sh\"   29 minutes ago   Up 29 minutes   0.0.0.0:8080->8080/tcp                                                                             temporal-ui-a\r\n37ac6cb260a3   temporalio/admin-tools:1.19.0   \"tail -f /dev/null\"      29 minutes ago   Up 29 minutes                                                                                                      temporal-admin-tools-a\r\n68ee231ac1cf   grafana/grafana:latest          \"/run.sh\"                29 minutes ago   Up 29 minutes   0.0.0.0:3000->3000/tcp                                                                             temporal-grafana\r\n67ed30f2940a   temporalio/auto-setup:1.19.0    \"/etc/temporal/entry…\"   29 minutes ago   Up 29 minutes   6933-6935/tcp, 6939/tcp, 7234-7235/tcp, 7239/tcp, 0.0.0.0:8001->8001/tcp, 0.0.0.0:8233->7233/tcp   temporal-b\r\n44071ca264e5   temporalio/auto-setup:1.19.0    \"/etc/temporal/entry…\"   29 minutes ago   Up 29 minutes   6933-6935/tcp, 6939/tcp, 7234-7235/tcp, 0.0.0.0:7233->7233/tcp, 7239/tcp, 0.0.0.0:8000->8000/tcp   temporal-a\r\n4d19a4e4099d   prom/prometheus:latest          \"/bin/prometheus --c…\"   29 minutes ago   Up 29 minutes   0.0.0.0:9090->9090/tcp                                                                             temporal-prometheus\r\n32a784d644ee   mysql:8                         \"docker-entrypoint.s…\"   29 minutes ago   Up 29 minutes   33060/tcp, 0.0.0.0:3308->3306/tcp                                                                  temporal-mysql-b\r\n859f9317ca5f   elasticsearch:7.10.1            \"/tini -- /usr/local…\"   29 minutes ago   Up 29 minutes   9300/tcp, 0.0.0.0:9202->9200/tcp                                                                   temporal-elasticsearch-b\r\n604ba2ebe913   mysql:8                         \"docker-entrypoint.s…\"   29 minutes ago   Up 29 minutes   33060/tcp, 0.0.0.0:3307->3306/tcp                                                                  temporal-mysql-a\r\nbd3df70b564a   elasticsearch:7.10.1            \"/tini -- /usr/local…\"   29 minutes ago   Up 29 minutes   9300/tcp, 0.0.0.0:9201->9200/tcp                                                                   temporal-elasticsearch-a\r\n```","createdAt":"2023-03-21T15:14:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4020#issuecomment-1478019863","viewerDidAuthor":false}],"createdAt":"2023-03-07T01:30:53Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4020,"reactionGroups":[],"state":"OPEN","title":"Unexpected lag between TimerStarted and TimerFired when switching a namespace's active cluster","updatedAt":"2023-03-21T15:14:40Z","url":"https://github.com/temporalio/temporal/issues/4020"}
