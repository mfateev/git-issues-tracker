{"assignees":[],"author":{"id":"MDQ6VXNlcjgwNDQ3NjM=","is_bot":false,"login":"yifeili3","name":"Yifei Li"},"body":"## Context: \r\n\r\nI'm implementing RDS IAM auth for Temporal server since there's a recent [support for pgx](https://github.com/temporalio/temporal/pull/4913) that enables the options to configure db driver with [OptionBeforeConnect](https://pkg.go.dev/github.com/jackc/pgx/v4/stdlib#OptionOpenDB) when opening a new db connection. This addressed the issue mentioned in https://github.com/temporalio/temporal/issues/3077 where the token expires and the server loses the connection.\r\n\r\n## Expected Behavior\r\n\r\nI got the RDS IAM auth working with the latest build.  I was able to establish persistent connections and run workflows with the remote RDS instance from my local machine only under the condition that database is wiped out before server starts/restarts. I expect the server to read the registered namespace before trying to create a new namespace during initialization.\r\n\r\n## Actual Behavior\r\n\r\n```\r\n{\"level\":\"error\",\"ts\":\"2023-11-09T15:28:53.273Z\",\"msg\":\"Operation failed with internal error.\",\"error\":\"CreateNamespace: ERROR: duplicate key value violates unique constraint \\\"namespaces_pkey\\\" (SQLSTATE 23505)\",\"operation\":\"InitializeSystemNamespace\",\"logging-call-at\":\"persistence_metric_clients.go:1281\"}\r\n```\r\nThe server crashes because of an underlying SQL error when it tries to register the same system namespace. This seems to be a consistent issue whether using RDS IAM Auth or not. I dived into the code and found that it hardcoded the primary key so that explains the error.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n1. I was able to reproduce the same error using vanilla 1.22.1 server with Postgres 13.8 by just changing the db driverName from pg to pgx. (https://github.com/temporalio/temporal/blob/v1.22.1/common/persistence/sql/sqlplugin/postgresql/session/session.go#L82)\r\n2. No issue in the latest main branch with configuration `pluginName: \"postgres_pgx\"`.\r\n3. No issue in the latest main branch with RDS IAM support when temporal db is wiped. Reproduced the issue when server is killed and restarted without wiping DB\r\n\r\n## Specifications\r\n\r\n  - Version: 1.22.1\r\n  - Platform: local & k8s\r\n","closedAt":"2023-11-09T22:33:01Z","comments":[{"id":"IC_kwDODNqesM5rjN8x","author":{"login":"ndtretyak"},"authorAssociation":"CONTRIBUTOR","body":"> I was able to reproduce the same error using vanilla 1.22.1 server with Postgres 13.8 by just changing the db driverName from pg to pgx. \r\n\r\nHi, you can not just change `driverName` constant in the code, since error handling depends on the driver. Since the uniqueness error is not processed correctly, the service crashes.","createdAt":"2023-11-09T18:51:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5097#issuecomment-1804394289","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5rkt77","author":{"login":"yifeili3"},"authorAssociation":"NONE","body":"@ndtretyak Thanks for the reply. I just found out about this issue as well. the pgConn type assertion failed to recognize the dub entry error and bypass the logic to catch this error when namespace is initialized. I used pgx v4 to implement the auth options instead of v5 so that causes the error. Issue is fixed now","createdAt":"2023-11-09T22:33:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5097#issuecomment-1804787451","viewerDidAuthor":false}],"createdAt":"2023-11-09T17:01:59Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":5097,"reactionGroups":[],"state":"CLOSED","title":"Temporal Services Crash on Namespace Initialization ","updatedAt":"2023-11-09T22:33:02Z","url":"https://github.com/temporalio/temporal/issues/5097"}
