{"assignees":[],"author":{"id":"MDQ6VXNlcjEyMDM4OTM=","is_bot":false,"login":"josh-berry","name":"Josh Berry"},"body":"The Temporal CLI tests hit a couple rare failures in CI after updating to Server 1.25 that we (Dan and I) believe to be a Server issue—we see spurious errors of the form: `Current branch token and request branch token doesn't match.`\r\n\r\nThese seem very rare because neither Dan nor I were able to repro them on our local machines (despite ~100 attempts each), and when we re-ran the failing CI job, the tests succeeded.\r\n\r\n## Expected Behavior\r\n\r\nSuccessful CLI test run (no such errors reported)\r\n\r\n## Actual Behavior\r\n\r\nThe following two CLI tests failed — full log output here: https://github.com/temporalio/cli/actions/runs/10885937402/job/30204717954\r\n\r\nIn TestSharedServerSuite/TestWorkflow_Reset_ReapplyExclude:\r\n\r\n```\r\n=== FAIL: temporalcli TestSharedServerSuite/TestWorkflow_Reset_ReapplyExclude (0.02s)\r\n    commands.workflow_reset_test.go:287: \r\n        \tError Trace:\t/home/runner/actions-runner/_work/cli/cli/temporalcli/commands.workflow_reset_test.go:287\r\n        \tError:      \tReceived unexpected error:\r\n        \t            \tCurrent branch token and request branch token doesn't match.\r\n        \tTest:       \tTestSharedServerSuite/TestWorkflow_Reset_ReapplyExclude\r\n```\r\n\r\nIn TestSharedServerSuite/TestActivity_Complete:\r\n\r\n```\r\n=== FAIL: temporalcli TestSharedServerSuite/TestActivity_Complete (0.12s)\r\n    commands_test.go:182: Calling: activity complete --activity-id dev-activity-id --workflow-id bb9450c4-9cf0-4ee6-b0f5-c5e1c1390db5 --result \"complete-activity-result\" --identity MyIdentity --address 127.0.0.1:37747\r\n    commands.activity_test.go:27: \r\n        \tError Trace:\t/home/runner/actions-runner/_work/cli/cli/temporalcli/commands.activity_test.go:27\r\n        \tError:      \tReceived unexpected error:\r\n        \t            \tCurrent branch token and request branch token doesn't match.\r\n        \tTest:       \tTestSharedServerSuite/TestActivity_Complete\r\n```\r\n\r\n[TestActivity_Complete](https://github.com/temporalio/cli/blob/main/temporalcli/commands.activity_test.go#L12) is particularly interesting because there are no workflow resets performed during this test. This test is quite simple; here's what it does:\r\n\r\n1. Launch a workflow\r\n2. Wait for the workflow to launch an activity that never completes\r\n3. Try to force-complete the activity using the CLI command: `temporal activity complete […] --result […] --identity […]`\r\n\r\nI think this is a server-side issue because nothing in the test actually does a workflow reset, and so there should be no reason why the workflow history has diverging branches. (We are also not using clustering or MRN or anything like that; this is just a single-process dev-server, so replication doesn't come into play at all.)\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Check out `temporalio/cli`\r\n  1. `go test -v -count 1 -run '^TestSharedServerSuite/(TestWorkflow_Reset_ReapplyExclude|TestActivity_Complete)$' github.com/temporalio/cli/temporalcli`\r\n\r\n## Specifications\r\n\r\n  - Version: 1.25\r\n  - Platform: ubuntu-arm\r\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM6O6K3N","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"This same issue is happening in new Ruby SDK CI when fetching history:\r\n\r\n```\r\ntime=2024-10-07T18:24:25.428 level=ERROR msg=\"service failures\" operation=PollWorkflowExecutionHistory wf-namespace=default error=\"Current branch token and request branch token doesn't match.\"\r\ntime=2024-10-07T18:24:25.428 level=ERROR msg=\"service failures\" operation=PollWorkflowExecutionHistory wf-namespace=default wf-id=wf-72884a17-e275-4ce9-807b-e49efed0537a wf-run-id=dd5e4b6f-141d-4804-8d79-3afda01f96e5 error=\"Current branch token and request branch token doesn't match.\"\r\nE, [2024-10-07T18:24:25.443796 #9419] ERROR -- : Block failure (beginning worker shutdown)\r\nE, [2024-10-07T18:24:25.443853 #9419] ERROR -- : Current branch token and request branch token doesn't match. (Temporalio::Error::RPCError)\r\n/Users/runner/work/sdk-ruby/sdk-ruby/temporalio/lib/temporalio/client/connection/service.rb:35:in `rescue in invoke_rpc'\r\n/Users/runner/work/sdk-ruby/sdk-ruby/temporalio/lib/temporalio/client/connection/service.rb:24:in `invoke_rpc'\r\n/Users/runner/work/sdk-ruby/sdk-ruby/temporalio/lib/temporalio/client/connection/workflow_service.rb:160:in `get_workflow_execution_history'\r\n/Users/runner/work/sdk-ruby/sdk-ruby/temporalio/lib/temporalio/internal/client/implementation.rb:161:in `block (2 levels) in fetch_workflow_history_events'\r\n/Users/runner/work/sdk-ruby/sdk-ruby/temporalio/lib/temporalio/internal/client/implementation.rb:160:in `loop'\r\n/Users/runner/work/sdk-ruby/sdk-ruby/temporalio/lib/temporalio/internal/client/implementation.rb:160:in `block in fetch_workflow_history_events'\r\n/Users/runner/hostedtoolcache/Ruby/3.1.6/arm64/lib/ruby/gems/3.1.0/gems/rake-13.2.1/lib/rake/rake_test_loader.rb:in `each'\r\n/Users/runner/hostedtoolcache/Ruby/3.1.6/arm64/lib/ruby/gems/3.1.0/gems/rake-13.2.1/lib/rake/rake_test_loader.rb:in `each'\r\nFull cause chain:\r\nException: RuntimeError - Neutered Exception Temporalio::Error::RPCError: Current branch token and request branch token doesn't match.\r\nBacktrace:\r\n/Users/runner/work/sdk-ruby/sdk-ruby/temporalio/lib/temporalio/client/connection/service.rb:35:in `rescue in invoke_rpc'\r\n/Users/runner/work/sdk-ruby/sdk-ruby/temporalio/lib/temporalio/client/connection/service.rb:24:in `invoke_rpc'\r\n/Users/runner/work/sdk-ruby/sdk-ruby/temporalio/lib/temporalio/client/connection/workflow_service.rb:160:in `get_workflow_execution_history'\r\n/Users/runner/work/sdk-ruby/sdk-ruby/temporalio/lib/temporalio/internal/client/implementation.rb:161:in `block (2 levels) in fetch_workflow_history_events'\r\n/Users/runner/work/sdk-ruby/sdk-ruby/temporalio/lib/temporalio/internal/client/implementation.rb:160:in `loop'\r\n/Users/runner/work/sdk-ruby/sdk-ruby/temporalio/lib/temporalio/internal/client/implementation.rb:160:in `block in fetch_workflow_history_events'\r\n/Users/runner/hostedtoolcache/Ruby/3.1.6/arm64/lib/ruby/gems/3.1.0/gems/rake-13.2.1/lib/rake/rake_test_loader.rb:in `each'\r\n/Users/runner/hostedtoolcache/Ruby/3.1.6/arm64/lib/ruby/gems/3.1.0/gems/rake-13.2.1/lib/rake/rake_test_loader.rb:in `each'\r\n```","createdAt":"2024-10-07T18:31:35Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6525#issuecomment-2397613517","viewerDidAuthor":false}],"createdAt":"2024-09-16T18:16:19Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":6525,"reactionGroups":[],"state":"OPEN","title":"Rare test failure in CLI: \"Current branch token and request branch token doesn't match.\"","updatedAt":"2024-10-07T18:32:23Z","url":"https://github.com/temporalio/temporal/issues/6525"}
