{"assignees":[],"author":{"id":"MDQ6VXNlcjE3NjY1MTU=","is_bot":false,"login":"samarabbas","name":"Samar Abbas"},"body":"Gocql client only resolve hosts once on session creation.  This is a problem if you are running Cassandra on kubernetes using persisted volumes as all your Cassandra hosts might move at the same time.  This will result in unavailability of Temporal cluster as it won't be able to connect to Cassandra anymore.\r\n\r\nCurrent view of Kubernetes cluster:\r\n```\r\nNAME                                          READY   STATUS    RESTARTS   AGE\r\npod/cadence-cassandra-0                       1/1     Running   0          25m\r\npod/cadence-frontend-7bc4f86d8c-vtpvx         1/1     Running   4          3d22h\r\npod/cadence-frontend-tunnel-6dfbb958b-tz5pj   1/1     Running   0          3d20h\r\npod/cadence-history-8459c46456-rs2gr          1/1     Running   4          3d22h\r\npod/cadence-matching-6c74bd46bd-csbjn         1/1     Running   4          3d22h\r\npod/cadence-web-555f9c9dbc-ctncs              1/1     Running   0          3d21h\r\npod/cadence-worker-fffdb84dc-982j8            1/1     Running   0          25m\r\nNAME                                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)                                        AGE\r\nservice/cadence-cassandra           ClusterIP   None             <none>        7000/TCP,7001/TCP,7199/TCP,9042/TCP,9160/TCP   3d22h\r\nservice/cadence-frontend            ClusterIP   100.67.186.49    <none>        7933/TCP                                       3d22h\r\nservice/cadence-frontend-headless   ClusterIP   None             <none>        7933/TCP,9090/TCP                              3d22h\r\nservice/cadence-frontend-tunnel     ClusterIP   100.71.154.160   <none>        7933/TCP                                       3d20h\r\nservice/cadence-history-headless    ClusterIP   None             <none>        7934/TCP,9090/TCP                              3d22h\r\nservice/cadence-matching-headless   ClusterIP   None             <none>        7935/TCP,9090/TCP                              3d22h\r\nservice/cadence-web                 ClusterIP   100.70.110.201   <none>        80/TCP                                         3d22h\r\nservice/cadence-worker-headless     ClusterIP   None             <none>        7939/TCP,9090/TCP                              3d22h\r\nNAME                                      READY   UP-TO-DATE   AVAILABLE   AGE\r\ndeployment.apps/cadence-frontend          1/1     1            1           3d22h\r\ndeployment.apps/cadence-frontend-tunnel   1/1     1            1           3d20h\r\ndeployment.apps/cadence-history           1/1     1            1           3d22h\r\ndeployment.apps/cadence-matching          1/1     1            1           3d22h\r\ndeployment.apps/cadence-web               1/1     1            1           3d22h\r\ndeployment.apps/cadence-worker            1/1     1            1           3d22h\r\nNAME                                                DESIRED   CURRENT   READY   AGE\r\nreplicaset.apps/cadence-frontend-7bc4f86d8c         1         1         1       3d22h\r\nreplicaset.apps/cadence-frontend-tunnel-6dfbb958b   1         1         1       3d20h\r\nreplicaset.apps/cadence-history-8459c46456          1         1         1       3d22h\r\nreplicaset.apps/cadence-matching-6c74bd46bd         1         1         1       3d22h\r\nreplicaset.apps/cadence-web-555f9c9dbc              1         1         1       3d21h\r\nreplicaset.apps/cadence-web-57bb9fc7cf              0         0         0       3d22h\r\nreplicaset.apps/cadence-web-69795497b8              0         0         0       3d21h\r\nreplicaset.apps/cadence-worker-fffdb84dc            1         1         1       3d22h\r\nNAME                                 READY   AGE\r\nstatefulset.apps/cadence-cassandra   1/1     3d22h\r\n```\r\n\r\nFrontend Logs:\r\n```\r\n{\"level\":\"error\",\"ts\":\"2020-04-21T16:26:58.340Z\",\"msg\":\"Operation failed with internal error.\",\"service\":\"cadence-frontend\",\"error\":\"gocql: no hosts available in the pool\",\"metric-scope\":40,\"logging-call-at\":\"persistenceMetricClients.go:779\",\"stacktrace\":\"github.com/uber/cadence/common/log/loggerimpl.(*loggerImpl).Error\\n\\t/cadence/common/log/loggerimpl/logger.go:134\\ngithub.com/uber/cadence/common/persistence.(*metadataPersistenceClient).updateErrorMetric\\n\\t/cadence/common/persistence/persistenceMetricClients.go:779\\ngithub.com/uber/cadence/common/persistence.(*metadataPersistenceClient).GetMetadata\\n\\t/cadence/common/persistence/persistenceMetricClients.go:757\\ngithub.com/uber/cadence/common/cache.(*domainCache).refreshDomainsLocked\\n\\t/cadence/common/cache/domainCache.go:417\\ngithub.com/uber/cadence/common/cache.(*domainCache).refreshDomains\\n\\t/cadence/common/cache/domainCache.go:409\\ngithub.com/uber/cadence/common/cache.(*domainCache).refreshLoop\\n\\t/cadence/common/cache/domainCache.go:393\"}\r\n```\r\n\r\nCassandra cluster seems to come up correctly after restart:\r\n```\r\nINFO  [main] 2020-04-21 16:21:02,808 StorageService.java:1446 - JOINING: Finish joining ring\r\nINFO  [main] 2020-04-21 16:21:02,886 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence_visibility', ColumnFamily='schema_update_history')\r\nINFO  [main] 2020-04-21 16:21:02,887 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence_visibility', ColumnFamily='schema_version')\r\nINFO  [main] 2020-04-21 16:21:02,887 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence_visibility', ColumnFamily='closed_executions')\r\nINFO  [main] 2020-04-21 16:21:02,887 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence_visibility', ColumnFamily='open_executions')\r\nINFO  [main] 2020-04-21 16:21:02,888 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence_visibility', ColumnFamily='closed_executions_v2')\r\nINFO  [main] 2020-04-21 16:21:02,888 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence', ColumnFamily='domains')\r\nINFO  [main] 2020-04-21 16:21:02,888 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence', ColumnFamily='history_node')\r\nINFO  [main] 2020-04-21 16:21:02,888 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence', ColumnFamily='queue_metadata')\r\nINFO  [main] 2020-04-21 16:21:02,888 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence', ColumnFamily='events')\r\nINFO  [main] 2020-04-21 16:21:02,889 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence', ColumnFamily='executions')\r\nINFO  [main] 2020-04-21 16:21:02,889 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence', ColumnFamily='history_tree')\r\nINFO  [main] 2020-04-21 16:21:02,889 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence', ColumnFamily='schema_version')\r\nINFO  [main] 2020-04-21 16:21:02,889 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence', ColumnFamily='domains_by_name_v2')\r\nINFO  [main] 2020-04-21 16:21:02,889 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence', ColumnFamily='schema_update_history')\r\nINFO  [main] 2020-04-21 16:21:02,890 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence', ColumnFamily='queue')\r\nINFO  [main] 2020-04-21 16:21:02,890 SecondaryIndexManager.java:509 - Executing pre-join tasks for: CFS(Keyspace='cadence', ColumnFamily='tasks')\r\nINFO  [main] 2020-04-21 16:21:02,973 StorageService.java:2289 - Node /100.104.128.29 state jump to NORMAL\r\nINFO  [main] 2020-04-21 16:21:02,981 Gossiper.java:1692 - Waiting for gossip to settle...\r\n```","closedAt":"2021-03-04T19:35:37Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDYxNzM0NTQ0NQ==","author":{"login":"samarabbas"},"authorAssociation":"MEMBER","body":"gocql retry policy:\r\nhttps://github.com/gocql/gocql/blob/68212b7a2cd01dfdd006839a57f77b320a42fc4d/cluster.go#L185","createdAt":"2020-04-21T18:45:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/317#issuecomment-617345445","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDYxNzM0Njc3Mw==","author":{"login":"samarabbas"},"authorAssociation":"MEMBER","body":"Gocql keeps on trying to connect to old IP of cassandra cluster:\r\nhttps://github.com/gocql/gocql/blob/68212b7a2cd01dfdd006839a57f77b320a42fc4d/cluster.go#L38","createdAt":"2020-04-21T18:47:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/317#issuecomment-617346773","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDYxNzM3NzI3NQ==","author":{"login":"samarabbas"},"authorAssociation":"MEMBER","body":"link to gocql issue:\r\nhttps://github.com/gocql/gocql/issues/831","createdAt":"2020-04-21T19:48:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/317#issuecomment-617377275","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc5MDg3NTUwMQ==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"solved by #1342 #1343 #1344 #1345","createdAt":"2021-03-04T19:35:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/317#issuecomment-790875501","viewerDidAuthor":false}],"createdAt":"2020-04-21T18:43:37Z","labels":[],"milestone":null,"number":317,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"Ability for server to connect back to Cassandra when all host moves","updatedAt":"2021-03-04T19:35:37Z","url":"https://github.com/temporalio/temporal/issues/317"}
