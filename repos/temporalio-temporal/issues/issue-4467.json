{"assignees":[],"author":{"id":"MDQ6VXNlcjM4MTgwNTE=","is_bot":false,"login":"lerminou","name":"Nicolas DUBUT"},"body":"We use temporal in kubernetes for a while.\r\nTo update our temporal version, we run the admin-tools container to migrate the database.\r\n\r\nWe use a standalone container admin-tools\r\n\r\n  => Use a simple pod admin-tools with this basic definition\r\n  ```\r\n      apiVersion: v1\r\n      kind: Pod\r\n      metadata:\r\n        name: admin-tools\r\n      spec:\r\n        containers:\r\n          - name: admin-tools\r\n            image: temporalio/admin-tools:1.20.3\r\n            imagePullPolicy: IfNotPresent\r\n```\r\n\r\n## Expected Behavior\r\nthe container fails to connect to cassandra if deployed in the same namespace as cassandra\r\n\r\n## Actual Behavior\r\nThe container can connect with cassandra  if deployed in the same namespace\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n\r\n\r\n  1. create the resource in the same namespace as cassandra and run the command to create the database for example\r\n  ```\r\n/etc/temporal $ temporal-cassandra-tool --endpoint cassandra.dev.svc -u nexus -pw xxxx create-Keyspace -k temporal --rf 3 -v\r\npanic: error getting env CASSANDRA_PORT\r\n\r\ngoroutine 1 [running]:\r\ngo.temporal.io/server/environment.GetCassandraPort()\r\n\t/home/builder/temporal/environment/env.go:153 +0xa5\r\ngo.temporal.io/server/tools/cassandra.buildCLIOptions()\r\n\t/home/builder/temporal/tools/cassandra/main.go:70 +0x1a5\r\ngo.temporal.io/server/tools/cassandra.RunTool({0xc00003e1a0, 0xd, 0xd})\r\n\t/home/builder/temporal/tools/cassandra/main.go:40 +0x28\r\nmain.main()\r\n\t/home/builder/temporal/cmd/tools/cassandra/main.go:34 +0x2e\r\n```\r\n  \r\n  2. run the command `printenv` in the container to show default env vars\r\n```\r\n/etc/temporal $ printenv\r\nCASSANDRA_PORT_8080_TCP_PROTO=tcp\r\nKUBERNETES_SERVICE_PORT=443\r\nKUBERNETES_PORT=tcp://10.43.0.1:443\r\nCASSANDRA_SERVICE_PORT=9042\r\nCASSANDRA_PORT=tcp://10.43.109.12:9042\r\nHOSTNAME=admin-toolsa\r\nSHLVL=1\r\nHOME=/home/temporal\r\nCASSANDRA_PORT_9042_TCP=tcp://10.43.109.12:9042\r\nCASSANDRA_PORT_8080_TCP=tcp://10.43.109.12:8080\r\nCASSANDRA_SERVICE_PORT_METRICS=8080\r\nCASSANDRA_SERVICE_PORT_CQL=9042\r\nTERM=xterm\r\nKUBERNETES_PORT_443_TCP_ADDR=10.43.0.1\r\nPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\r\nKUBERNETES_PORT_443_TCP_PORT=443\r\nKUBERNETES_PORT_443_TCP_PROTO=tcp\r\nKUBERNETES_SERVICE_PORT_HTTPS=443\r\nKUBERNETES_PORT_443_TCP=tcp://10.43.0.1:443\r\nKUBERNETES_SERVICE_HOST=10.43.0.1\r\nPWD=/etc/temporal\r\nCASSANDRA_PORT_9042_TCP_ADDR=10.43.109.12\r\nCASSANDRA_SERVICE_HOST=10.43.109.12\r\nCASSANDRA_PORT_8080_TCP_ADDR=10.43.109.12\r\nCASSANDRA_PORT_9042_TCP_PORT=9042\r\nCASSANDRA_PORT_9042_TCP_PROTO=tcp\r\nCASSANDRA_PORT_8080_TCP_PORT=8080\r\n\r\n```\r\n\r\n=> it seems that the container can auto detect cassandra endpoint and some informations\r\n\r\n  3. Do the same actions to deploy the container in another namespace\r\n  ```\r\n/etc/temporal $ temporal-cassandra-tool --endpoint cassandra.dev.svc -u nexus -pw xxxx create-Keyspace -k temporal --rf 3 -v\r\n2023-06-09T07:40:23.057Z\tINFO\tValidating connection to cassandra cluster.\t{\"logging-call-at\": \"cqlclient.go:111\"}\r\n2023-06-09T07:40:23.967Z\tINFO\tConnection validation succeeded.\t{\"logging-call-at\": \"cqlclient.go:122\"}\r\n2023-06-09T07:40:23.967Z\tINFO\tCreating Keyspace temporal using SimpleStrategy with RF=3.\t{\"logging-call-at\": \"cqlclient.go:169\"}\r\n```\r\n check env vars\r\n```\r\n/etc/temporal $ printenv\r\nKUBERNETES_SERVICE_PORT=443\r\nKUBERNETES_PORT=tcp://10.43.0.1:443\r\nHOSTNAME=admin-tools\r\nSHLVL=1\r\nHOME=/home/temporal\r\nTERM=xterm\r\nKUBERNETES_PORT_443_TCP_ADDR=10.43.0.1\r\nPATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin\r\nKUBERNETES_PORT_443_TCP_PORT=443\r\nKUBERNETES_PORT_443_TCP_PROTO=tcp\r\nKUBERNETES_SERVICE_PORT_HTTPS=443\r\nKUBERNETES_PORT_443_TCP=tcp://10.43.0.1:443\r\nKUBERNETES_SERVICE_HOST=10.43.0.1\r\nPWD=/etc/temporal\r\n/etc/temporal $\r\n```\r\n\r\n=> when env var `CASSANDRA_PORT` is not present, the connection is successfull.\r\n\r\n## Specifications\r\n\r\n  - Version: 1.20.3\r\n  - Platform: Kubernetes\r\n","closedAt":"2023-10-21T19:37:28Z","comments":[{"id":"IC_kwDODNqesM5pu6DC","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"The temporal-cassandra-tool expect CASSANDRA_PORT to be a valid integer port number (like 9042). In your case, the environment variable was set to something else (CASSANDRA_PORT=tcp://10.43.109.12:9042) that cause the tool to panic. This is expected behavior. If you want to avoid this panic, you can pass in port as argument by `--port`. \r\n\r\nWhen you run it in other namespace where there is no CASSANDRA_PORT, the tool would fallback to use default port which is 9042.\r\n\r\nTo make the tool work, you either pass in your port via command line argument, or you specify a CASSANDRA_PORT to a valid port number. If neighter are present, a default 9042 is used.\r\n","createdAt":"2023-10-21T19:37:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4467#issuecomment-1773904066","viewerDidAuthor":false}],"createdAt":"2023-06-09T08:06:34Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4467,"reactionGroups":[],"state":"CLOSED","title":"standalone admin-tools fails to connect in kubernetes","updatedAt":"2023-10-21T19:37:28Z","url":"https://github.com/temporalio/temporal/issues/4467"}
