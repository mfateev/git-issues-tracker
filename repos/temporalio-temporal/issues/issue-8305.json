{"assignees":[],"author":{"id":"U_kgDOBXfF3g","is_bot":false,"login":"christopher-watanabe-snkeos","name":"Christopher Watanabe"},"body":"## Expected Behavior\nUpdating from 1.27.1 to 1.28.1, a standalone, containerized Temporal service with postgresql persistence running on a host system with a proxy configured should be able to successfully start. \n\n## Actual Behavior\nUpdating from 1.27.1 to 1.28.1, internal clients in a standalone, containerized Temporal service are unable to establish connections to the internal frontend service. \n\nThe logs show the following warning: \n```json\n{\n   \"level\":\"warn\",\n   \"msg\":\"error creating sdk client\",\n   \"service\":\"worker\",\n   \"error\":\"failed reaching server: connection error: desc = \\\"transport: Error while dialing: failed to do connect handshake, response: \\\"HTTP/1.1 403 Forbidden\\\" ... The requested URL could not be retrieved. The following error was encountered while trying to retrieve the URL: 127.0.0.1:58322\",\n   \"logging-call-at\":\"common/sdk/factory.go:98\"\n}\n```\n\nI've configured the NO_PROXY of the docker daemon to bypass the proxy for local connections inside the containers, so establishing a connection to the internal frontend service should be allowed. It could be a source of error if the proxy environment is not being respected in 1.28.1 due to code changes, maybe?\n\n## Steps to Reproduce the Problem\n\nReproduction is quite time-intensive given the complexity of the host system. However, setup would go something like: \n\n  1. Create a host system with a proxy, i.e. an AWS EC2 instance with outgoing security group rules that routes traffic through a proxy.\n  2. Containerize the temporal solution, building from version v1.28.1. \n  3. Setup a persistence server. I used postgres, but ultimately the error suggests that it's an internal connection that is disallowed by the proxy.\n  4. Run the dockerized service, ensuring that the environment is configured in such a way that temporal contacts the persistence server from step 3 and that the NO_PROXY environment variable lists any container-local and DB connections to proceed without being proxied (i.e. 127.0.0.1 and whatever hostname the DB can be contacted under).\n  5. Notice that the service fails to start because a connection to the internal frontend service cannot be established.\n\n## Specifications\n\n  - Version: v1.28.1\n  - Platform: MS Windows Server 2022 Standard\n\n\n## Additional Information\nThe only change to the container that I run the service in was that one is built from the 1.27.1 source and the other is built from the 1.28.1 source. I haven't dived deep into the original source yet, but my suspicion is that somewhere a grpc client is no longer configured to respect the proxy environment.","closedAt":"2025-09-18T22:46:20Z","comments":[{"id":"IC_kwDODNqesM7C9Wsc","author":{"login":"christopher-watanabe-snkeos"},"authorAssociation":"NONE","body":"From having a look at the configuration template, I noticed there's a `USE_INTERNAL_FRONTEND` configuration param. When I set this to `true`, the error string in the description goes away, but then a different error is thrown when creating an sdk client for the worker: \n\n```json\n{\n   \"level\":\"warn\",\n   \"ts\":\"2025-09-09T15:54:14.314+0200\",\n   \"msg\":\"error creating sdk client\",\n   \"service\":\"worker\",\n   \"error\":\"failed reaching server: context deadline exceeded\",\"logging-call-at\":\"C:/temporal-server/common/sdk/factory.go:98\"}\n```","createdAt":"2025-09-09T13:55:55Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8305#issuecomment-3270863644","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7DQHAT","author":{"login":"ethan-gallant"},"authorAssociation":"NONE","body":"Not sure if I'm going crazy here but it seems the frontend no longer actually compiles due to some issues, I've been struggling to get our integrated server working accordingly.\n\n```\n../../../../../go/pkg/mod/go.temporal.io/server@v1.28.1/client/frontend/client.go:21:47: cannot use (*clientImpl)(nil) (value of type *clientImpl) as workflowservice.WorkflowServiceClient value in variable declaration: *clientImpl does not implement workflowservice.WorkflowServiceClient (missing method FetchWorkerConfig)\n../../../../../go/pkg/mod/go.temporal.io/server@v1.28.1/client/frontend/client.go:35:9: cannot use &clientImpl{‚Ä¶} (value of type *clientImpl) as workflowservice.WorkflowServiceClient value in return statement: *clientImpl does not implement workflowservice.WorkflowServiceClient (missing method FetchWorkerConfig)\n../../../../../go/pkg/mod/go.temporal.io/server@v1.28.1/client/frontend/metric_client.go:15:47: cannot use (*metricClient)(nil) (value of type *metricClient) as workflowservice.WorkflowServiceClient value in variable declaration: *metricClient does not implement workflowservice.WorkflowServiceClient (missing method FetchWorkerConfig)\n../../../../../go/pkg/mod/go.temporal.io/server@v1.28.1/client/frontend/metric_client.go:29:9: cannot use &metricClient{‚Ä¶} (value of type *metricClient) as workflowservice.WorkflowServiceClient value in return statement: *metricClient does not implement workflowservice.WorkflowServiceClient (missing method FetchWorkerConfig)\n../../../../../go/pkg/mod/go.temporal.io/server@v1.28.1/client/frontend/retryable_client.go:8:47: cannot use (*retryableClient)(nil) (value of type *retryableClient) as workflowservice.WorkflowServiceClient value in variable declaration: *retryableClient does not implement workflowservice.WorkflowServiceClient (missing method FetchWorkerConfig)\n../../../../../go/pkg/mod/go.temporal.io/server@v1.28.1/client/frontend/retryable_client.go:18:9: cannot use &retryableClient{‚Ä¶} (value of type *retryableClient) as workflowservice.WorkflowServiceClient value in return statement: *retryableClient does not implement workflowservice.WorkflowServiceClient (missing method FetchWorkerConfig)\n```\n","createdAt":"2025-09-10T17:05:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8305#issuecomment-3275780115","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7DTJce","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"@ethan-gallant the compilation is likely failing because you have a newer version of `go.temporal.io/api` than what the server version that you are working with supports.","createdAt":"2025-09-10T21:15:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8305#issuecomment-3276576542","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7DTKJD","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I'm not aware of any changes between 1.27 to 1.28 that would have changed the behavior but let me check internally with the team.","createdAt":"2025-09-10T21:17:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8305#issuecomment-3276579395","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7DTa_Z","author":{"login":"ethan-gallant"},"authorAssociation":"NONE","body":"> I'm not aware of any changes between 1.27 to 1.28 that would have changed the behavior but let me check internally with the team.\n\nI figured it out, importing both the server and the client in the same project is a recipe for trouble. Needed to create two separate go projects for it to work (even though they share a codebase).","createdAt":"2025-09-10T21:44:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8305#issuecomment-3276648409","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7DchVX","author":{"login":"christopher-watanabe-snkeos"},"authorAssociation":"NONE","body":"We had a look and tried to build from the most recent patch of 1.27, which is 1.27.3. This build encounters the same issue, so if it helps narrow the scope, 1.27.1 works but 1.27.3 does not. We didn't try 1.27.2, but [the changelog between 1.27.2 to 1.27.3 only updates the version string and adds a comment](https://github.com/temporalio/temporal/compare/v1.27.2...v1.27.3), so I believe somewhere in [the 1.27.1 to 1.27.2 changelog](https://github.com/temporalio/temporal/compare/v1.27.1...v1.27.2), there's an update that's affecting the internal grpc comms in the container when hosted on a system with a proxy.\n\nCould it be related to the grpc library updates? \n\nLet me know if there's any other tests I can run to yield more information about the problem!","createdAt":"2025-09-11T08:00:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8305#issuecomment-3279033687","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7DlOwJ","author":{"login":"christopher-watanabe-snkeos"},"authorAssociation":"NONE","body":"An important point: We are setting the NO_PROXY env var of the container so as to allow all local comms within the container. This is a reason that I think that it must be a grpc client issue such that the client is not respecting the proxy environment. ","createdAt":"2025-09-11T15:09:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8305#issuecomment-3281316873","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7DpLe9","author":{"login":"mathias-kogler-snkeos"},"authorAssociation":"NONE","body":"Looking at the go grpc library I found two issues, that could be the root cause:\n- https://github.com/grpc/grpc-go/issues/8327 (fixed in v1.72.2)\n- https://github.com/grpc/grpc-go/issues/8207 (fixed in 1.72.1)\n\nTemporal 1.27.1 uses google.golang.org/grpc v1.70.0, which works\nTemporal 1.27.2/v1.27.3 uses \tgoogle.golang.org/grpc v1.71.0, which doesn't work\nTemporal main uses google.golang.org/grpc v1.72.2, which already contains fixes for the two issues above.","createdAt":"2025-09-11T19:26:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/8305#issuecomment-3282352061","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7Dz6Af","author":{"login":"christopher-watanabe-snkeos"},"authorAssociation":"NONE","body":"> Looking at the go grpc library I found two issues, that could be the root cause:\n> \n> * [`NO_PROXY` environment variable no longer respected on custom resolver results¬†grpc/grpc-go#8327](https://github.com/grpc/grpc-go/issues/8327) (fixed in v1.72.2)\n> * [grpc.Dial fails to connect to unix domain socket when https_proxy is set¬†grpc/grpc-go#8207](https://github.com/grpc/grpc-go/issues/8207) (fixed in 1.72.1)\n> \n> Temporal 1.27.1 uses google.golang.org/grpc v1.70.0, which works Temporal 1.27.2/v1.27.3 uses google.golang.org/grpc v1.71.0, which doesn't work Temporal main uses google.golang.org/grpc v1.72.2, which already contains fixes for the two issues above.\n\nIt is indeed the mentioned bugs that affect the proxy behavior!!! Great find. As a workaround, we apply a git patch to the version of the library prior to build so that we can still use the 1.28.1 release. If possible, we'd love to see the library updated in a future patch of 1.28 üôèüèº Otherwise, we have a workaround and hope for a more permanent fix in 1.29 ü§ûüèº ","createdAt":"2025-09-12T12:49:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8305#issuecomment-3285164063","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7FSYni","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"1.29 is going to be released in the upcoming weeks, and AFAIU, will fix this issue. Closing for now.","createdAt":"2025-09-18T22:46:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8305#issuecomment-3309930978","viewerDidAuthor":false}],"createdAt":"2025-09-09T13:40:02Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":8305,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"Container built from 1.28.1 source can no longer startup on host system with proxy due to internal frontend connection failure","updatedAt":"2025-09-18T22:46:20Z","url":"https://github.com/temporalio/temporal/issues/8305"}
