{"assignees":[{"id":"MDQ6VXNlcjg3NjI4OTM=","login":"wxing1292","name":"Wenquan Xing","databaseId":0}],"author":{"id":"MDQ6VXNlcjU5MDkzMzQ=","is_bot":false,"login":"Lercher","name":"Martin Lercher"},"body":"... and it also introduces a hard dependency on the two pre-fabricated plugins in tools/sql/handler.go, normally it is only found in main.go files and in tests, where it is ok:\r\n\r\n```go\r\n\t\"go.temporal.io/server/common/persistence/sql/sqlplugin/mysql\"\r\n\t\"go.temporal.io/server/common/persistence/sql/sqlplugin/postgresql\"\r\n```\r\n\r\n\r\n## Expected Behavior\r\n\r\nData schema checking should be handled by a plug-in's method via an interface: I suppose there is the server's expectation of a version number. If so, it should be checked against the used plugin's static version number (via a plugin interface method) and if that succeeds the plugin should be asked to check (or return) the database stored schema version number. If there is any mismatch an error (or a panic?) should be returned by `VerifyCompatibleVersion()` <https://github.com/temporalio/temporal/blob/ee8451102b2ce5b67dc2e3e5b8cb0b02a547ec6a/tools/sql/handler.go#L46>\r\n\r\nWithout a hard dependency on mysql and pg, their respective drivers and temporal plug-ins doesn't need to be downloaded, built, security checked and delivered for a temporal server built for a different sql plugin.\r\n\r\n## Actual Behavior\r\n\r\nVersion checking is done via a type-switch anti-pattern (see e.g. <https://refactoring.guru/smells/switch-statements>). Moreover there is a panic if an unknown sql plugin type is recognized, effectively rendering the plug-in concept useless for `sql`-kind plug-ins. The hard dependency imports a lot of \"dead\" i.e. mostly unused code.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. copy the server's main.go file\r\n  1. remove the mysql and pg plugin imports\r\n  1. add new plugin code\r\n  1. change development.yaml to load and configure the new `sql` plugin\r\n  2. build and start the server \r\n  3. notice the panic `\"unknown sql store drier: %v\"`\r\n\r\nFor more detailed insight (work in progress for an mssql server plugin, however):\r\n\r\n1. clone <https://gitlab.com/lercher/temporal-sqls>\r\n2. remove `replace go.temporal.io/server => ../../../github.com/temporalio/temporal` from `go.mod`\r\n3. cd cmd/server\r\n4. go build\r\n5. ./server start\r\n6. panic\r\n\r\n## Specifications\r\n\r\n  - Version: 1.5.1\r\n  - Platform: any\r\n\r\n## Request\r\n\r\nCould you please consider a redesign of the `VerifyCompatibleVersion()` implementation.","closedAt":"2021-02-20T16:54:44Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDc4MDk2NjY0OA==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"let us try if #1299 can unblock you at least for now.\r\none thing to mention here, SQL persistence interface is mostly stable, we might make more minor changes in the future.","createdAt":"2021-02-18T01:17:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1292#issuecomment-780966648","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4MTI2MTk4Ng==","author":{"login":"Lercher"},"authorAssociation":"NONE","body":"Thanks for that. I‘m traveling today so that I can’t evaluate it right now, sorry.\r\n\r\nPlease note, that I wasn’t really blocked in constructing the sql Server plugin, however, I can’t reasonably publish it without such a patch that you provided. Furthermore, I guess I can deal with minor changes in the sql layer. Thanks again.","createdAt":"2021-02-18T11:00:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1292#issuecomment-781261986","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4MTU4MTY0Mw==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"the above PR is landed, plz let me know if there are other potential blocking issue\r\n\r\nkeep the issue open just in case","createdAt":"2021-02-18T19:28:00Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1292#issuecomment-781581643","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4MjE2NDMzMQ==","author":{"login":"Lercher"},"authorAssociation":"NONE","body":"I've upgraded references to go.temporal.io/server@v1.7.0 now and it works with it. Thanks.\r\n\r\n---\r\n\r\nHowever @wxing1292, I'm not sure about this issue(?) in schema versioning: is there a flaw using the database name taken from the configuration file as an index into `TABLE schema_version`? Suppose you wanted to put main and visibility both to the same database, what would you insert into the table?\r\n\r\n```sql\r\nINSERT into schema_version\r\n  (version_partition, db_name, creation_time, curr_version, min_compatible_version) \r\nVALUES \r\n  (0,                 DB_NAME(), GETDATE(),  '1.4',        '1.4') -- for main 1.4 and for visibility 1.1? Can't be both.\r\n;\r\n```\r\n\r\ni.e. is `dbKind` a better index than `dbName`?\r\n\r\n```go\r\nfunc checkCompatibleVersion(\r\n\tcfg *config.SQL,\r\n\tr resolver.ServiceResolver,\r\n\tdbKind sqlplugin.DbKind,\r\n) error {\r\n\tdb, err := NewSQLAdminDB(cfg, r)\r\n\tif err != nil {\r\n\t\treturn err\r\n\t}\r\n\tdefer func() { _ = db.Close() }()\r\n\r\n\t// code currently. What about the service resolver (introduced in v1.6)?\r\n\treturn schema.VerifyCompatibleVersion(db, cfg.DatabaseName, db.ExpectedVersion(dbKind)) \t\r\n\r\n\treturn schema.VerifyCompatibleVersion(db, dbKind, db.ExpectedVersion(dbKind)) // dbKind only, better?\r\n\treturn schema.VerifyCompatibleVersion(db, cfg.DatabaseName, dbKind, db.ExpectedVersion(dbKind)) // both, even better?\r\n}\r\n```","createdAt":"2021-02-19T15:54:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1292#issuecomment-782164331","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4MjI5ODc2MA==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"> Suppose you wanted to put main and visibility both to the same database\r\n\r\nsorry, we only allow dedicated database for main (execution) / visibility, one database serving core functionalities, one database serving visibility traffic\r\n\r\n","createdAt":"2021-02-19T19:41:36Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/1292#issuecomment-782298760","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4MjMwMDQ4Mw==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"BTW, you need to use the master branch for the development, e.g. any commit after `c71d197c394aa440338ffd6f36f23a87ef9bad84` (will be part of 1.8)\r\n\r\ngo.temporal.io/server@v1.7.0 does NOT contain the above commit","createdAt":"2021-02-19T19:45:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1292#issuecomment-782300483","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4MjcxNDI0Mw==","author":{"login":"Lercher"},"authorAssociation":"NONE","body":"I see, concerning exclusive databases. I wasn't aware of this, sorry. It's a non-issue then.\r\n\r\nConcerning master vs. v1.7.0: version checking is actually done by the driver in v1.7.0 as requested above. So in fact, I really don't know if your patch was effective or not. However v1.7.0 resolves my issue, so I'm closing this ticket. You may want to re-open it, of course. Thanks for your help and explanations @wxing1292, I appreciate it very much.","createdAt":"2021-02-20T16:54:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1292#issuecomment-782714243","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4MjcxNjQ3NA==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"go get go.temporal.io/server@c71d197c394aa440338ffd6f36f23a87ef9bad84\n\nThe interface of sql admin db was changed. The above change will be part of 1.8.x. I would advice using above commit to avoid more code changes on your side until 1.8.x is out.","createdAt":"2021-02-20T17:09:29Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1292#issuecomment-782716474","viewerDidAuthor":false}],"createdAt":"2021-02-16T16:20:53Z","labels":[{"id":"MDU6TGFiZWwyMDE5OTA0OTIw","name":"discussion","description":"","color":"3ffcb0"}],"milestone":null,"number":1292,"reactionGroups":[],"state":"CLOSED","title":"func VerifyCompatibleVersion blocks usage of different type of sql plugin","updatedAt":"2021-02-20T17:11:35Z","url":"https://github.com/temporalio/temporal/issues/1292"}
