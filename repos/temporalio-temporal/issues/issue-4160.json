{"assignees":[{"id":"MDQ6VXNlcjIwNjgxMjQ=","login":"rodrigozhou","name":"Rodrigo Zhou","databaseId":0}],"author":{"id":"MDQ6VXNlcjQ1MjM5NTU=","is_bot":false,"login":"longquanzheng","name":"Quanzheng Long"},"body":"## Expected Behavior\r\nThe search attributes should never got lost after registering \r\n\r\n## Actual Behavior\r\nSometimes it will get lost\r\n\r\n## Steps to Reproduce the Problem\r\nThis is the script that I used to register search attributes automatically after service is up running in docker. \r\nIt happens occasionally that one of the three (randomly) will be lost after the CLI command show up the registering is succeeded.\r\n\r\nE.g. in this integ test failure: https://github.com/indeedeng/iwf/actions/runs/4682724673/jobs/8297177058\r\n\r\nIn dump docker logs you can see:\r\n```\r\n You are about to add search attributes [IwfWorkflowType:Keyword]. Continue? Y/N yes\r\n  Search attributes have been added\r\n  You are about to add search attributes [IwfGlobalWorkflowVersion:Int]. Continue? Y/N yes\r\n  Search attributes have been added\r\n  You are about to add search attributes [IwfExecutingStateIds:Keyword]. Continue? Y/N yes\r\n  Search attributes have been added\r\n```\r\n\r\nAnd then test fails:\r\n```\r\nERROR\tloggerimpl/logger.go:135\tencounter error for API\t{\"error\": \"search attribute IwfWorkflowType is not defined\", \"logging-call-at\": \"service.go:389\"}\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: 1.20.1 , 1.19.1\r\n  - Platform: docker\r\n","closedAt":"2023-05-11T20:25:22Z","comments":[{"id":"IC_kwDODNqesM5Z9lCj","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"What persistence storage you're using? Can you run `temporal operator search-attribute list` to list the search attributes?\r\n\r\nAfter adding search attributes, you may have to wait up to 1 min to be able to use it. The command above should list all search attributes though.","createdAt":"2023-04-14T21:43:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4160#issuecomment-1509314723","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5Z9nDE","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"I checked your PR https://github.com/indeedeng/iwf/pull/245, and it shouldn't be necessary to add those `sleep`. Also, you can add multiple search attributes in a single call. Eg:\r\n```\r\n$ temporal search-attribute create --namespace default \\\r\n    --name CustomKeywordField --type Keyword \\\r\n    --name CustomIntField --type Int\r\n```","createdAt":"2023-04-14T21:54:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4160#issuecomment-1509322948","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5aNy2X","author":{"login":"longquanzheng"},"authorAssociation":"CONTRIBUTOR","body":"> I checked your PR https://github.com/indeedeng/iwf/pull/245, and it shouldn't be necessary to add those sleep\r\n\r\n@rodrigozhou yeah the sleep doesn't always work...So I finally have to do a workaround using list and wait in https://github.com/indeedeng/iwf/pull/256\r\n\r\n> you can add multiple search attributes in a single call\r\n\r\nGood to know. Thanks! I will update it later.","createdAt":"2023-04-18T17:41:55Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4160#issuecomment-1513565591","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5aNzJY","author":{"login":"longquanzheng"},"authorAssociation":"CONTRIBUTOR","body":"> What persistence storage you're using?\r\n\r\nI am using docker see: \r\nhttps://github.com/indeedeng/iwf/blob/main/docker-compose/ci-temporal-dependencies.yml\r\nhttps://github.com/indeedeng/iwf/blob/main/docker-compose/.env","createdAt":"2023-04-18T17:43:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4160#issuecomment-1513566808","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5aNzTq","author":{"login":"longquanzheng"},"authorAssociation":"CONTRIBUTOR","body":"> After adding search attributes, you may have to wait up to 1 min to be able to use it\r\n\r\nInteresting.. why it that? Is the list command enough to wait?","createdAt":"2023-04-18T17:43:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4160#issuecomment-1513567466","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5aN1-_","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"> Interesting.. why it that? Is the list command enough to wait?\r\n\r\nThere are caches that are refreshed once every minute. The list command bypasses the caches, and looks at the persistence directly, so it should have the up to date information.","createdAt":"2023-04-18T17:53:48Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4160#issuecomment-1513578431","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5aPxf4","author":{"login":"longquanzheng"},"authorAssociation":"CONTRIBUTOR","body":"> > Interesting.. why it that? Is the list command enough to wait?\r\n> \r\n> There are caches that are refreshed once every minute. The list command bypasses the caches, and looks at the persistence directly, so it should have the up to date information.\r\n\r\nActually, from what I observed it locally, the search attributes wonâ€™t show up after even hours , until I ran the command to re-register the same search attribute. ","createdAt":"2023-04-19T03:34:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4160#issuecomment-1514084344","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5aQio1","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"Do you have repro steps? Or logs from `tctl` and Server? I can try to investigate more.","createdAt":"2023-04-19T07:45:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4160#issuecomment-1514285621","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5a11AO","author":{"login":"jupudibhaskar967"},"authorAssociation":"NONE","body":"@rodrigozhou  I'm able to reproduce this with server version 1.20.2 and using go-sdk to add search attributes:\r\n\r\nServer version: 1.20.2\r\nVisibility store: postgres\r\nDeployment: Local kubernetes\r\n\r\nSteps to reproduce:\r\n1. Create a namespace and wait for namespace to be created.\r\n2. Add around 14 search attributes in one go using this code snippet:\r\n\r\n```\r\nif _, err := tClient.OperatorService().AddSearchAttributes(ctx,\r\n\t&tos.AddSearchAttributesRequest{\r\n\t\tSearchAttributes: addSearchAttrMap,\r\n\t\tNamespace:        nsConfig.Name,\r\n\t},\r\n); err != nil {\r\n\tzap.S().Errorf(\"Error occured while adding search attributes %+v for namespace %s: %s\",\r\n\t\taddSearchAttrMap, nsConfig.Name, err.Error())\r\n\treturn err\r\n}\r\n```\r\nHere, we are passing around 14 search attributes in total, where each type has 2 search attributes for example:\r\n\r\n```\r\nnsConfig.SearchAttributesConfig.KeywordKeys = []string{\"key1\", \"key2\"}\r\nnsConfig.SearchAttributesConfig.KeywordListKeys = []string{\"key3\", \"key4\"}\r\nnsConfig.SearchAttributesConfig.TextKeys = []string{\"key5\", \"key6\"}\r\nnsConfig.SearchAttributesConfig.BoolKeys = []string{\"key7\", \"key8\"}\r\nnsConfig.SearchAttributesConfig.IntKeys = []string{\"key9\", \"key10\"}\r\nnsConfig.SearchAttributesConfig.DatetimeKeys = []string{\"key11\", \"key12\"}\r\nnsConfig.SearchAttributesConfig.DoubleKeys = []string{\"key13\", \"key14\"}\r\n```\r\n\r\nWe form the addSearchAttrMap from the array pasted above and the golang code snippet to add search attribute returns success but some of the search attributes are always missing in the namespace:\r\n\r\nIteration1: key8 is missing.\r\nIteration2: key2, key6, key8, key12 are missing and so-on\r\n\r\nThe keys which are missing are not very deterministic but no matter how long we wait, the search attributes does not show up in that namespace.\r\n\r\nNOTE: We are using postgres as visibility store.\r\n\r\nSome logs from front end server:\r\n\r\n```\r\n{\"level\":\"info\",\"ts\":\"2023-04-26T21:04:33.811Z\",\"msg\":\"Register namespace succeeded\",\"service\":\"frontend\",\"wf-namespace\":\"fee2c71e-5f83-4a37-83f5-885d27d4f6fd\",\"wf-namespace-id\":\"5c19be8b-a70c-4a0f-958d-9e2d00a33112\",\"logging-call-at\":\"namespace_handler.go:312\"}\r\n{\"level\":\"info\",\"ts\":\"2023-04-26T21:04:38.004Z\",\"msg\":\"Update namespace succeeded\",\"service\":\"frontend\",\"wf-namespace\":\"fee2c71e-5f83-4a37-83f5-885d27d4f6fd\",\"wf-namespace-id\":\"5c19be8b-a70c-4a0f-958d-9e2d00a33112\",\"logging-call-at\":\"namespace_handler.go:655\"}\r\n{\"level\":\"error\",\"ts\":\"2023-04-26T21:04:39.284Z\",\"msg\":\"Unable to call matching.PollWorkflowTaskQueue.\",\"service\":\"frontend\",\"wf-task-queue-name\":\"temporal-matching-98f59b947-9zr4b:80398918-1c0d-4163-bea0-dbc88df9fd04\",\"timeout\":\"1m9.999585571s\",\"error\":\"Namespace 5c19be8b-a70c-4a0f-958d-9e2d00a33112 is not found.\",\"logging-call-at\":\"workflow_handler.go:912\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/home/builder/temporal/common/log/zap_logger.go:150\\ngo.temporal.io/server/service/frontend.(*WorkflowHandler).PollWorkflowTaskQueue\\n\\t/home/builder/temporal/service/frontend/workflow_handler.go:912\\ngo.temporal.io/api/workflowservice/v1._WorkflowService_PollWorkflowTaskQueue_Handler.func1\\n\\t/go/pkg/mod/go.temporal.io/api@v1.18.2-0.20230324225508-f2c7ab685b44/workflowservice/v1/service.pb.go:1516\\ngo.temporal.io/server/common/rpc/interceptor.(*RetryableInterceptor).Intercept.func1\\n\\t/home/builder/temporal/common/rpc/interceptor/retry.go:63\\ngo.temporal.io/server/common/backoff.ThrottleRetryContext\\n\\t/home/builder/temporal/common/backoff/retry.go:199\\ngo.temporal.io/server/common/rpc/interceptor.(*RetryableInterceptor).Intercept\\n\\t/home/builder/temporal/common/rpc/interceptor/retry.go:67\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1164\\ngo.temporal.io/server/common/rpc/interceptor.(*CallerInfoInterceptor).Intercept\\n\\t/home/builder/temporal/common/rpc/interceptor/caller_info.go:80\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1164\\ngo.temporal.io/server/common/rpc/interceptor.(*SDKVersionInterceptor).Intercept\\n\\t/home/builder/temporal/common/rpc/interceptor/sdk_version.go:69\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1164\\ngo.temporal.io/server/common/rpc/interceptor.(*RateLimitInterceptor).Intercept\\n\\t/home/builder/temporal/common/rpc/interceptor/rate_limit.go:86\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1164\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceRateLimitInterceptor).Intercept\\n\\t/home/builder/temporal/common/rpc/interceptor/namespace_rate_limit.go:91\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1164\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceCountLimitInterceptor).Intercept\\n\\t/home/builder/temporal/common/rpc/interceptor/namespace_count_limit.go:111\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1164\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceValidatorInterceptor).StateValidationIntercept\\n\\t/home/builder/temporal/common/rpc/interceptor/namespace_validator.go:194\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1164\\ngo.temporal.io/server/common/authorization.(*interceptor).Interceptor\\n\\t/home/builder/temporal/common/authorization/interceptor.go:153\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1164\\ngo.temporal.io/server/common/rpc/interceptor.(*TelemetryInterceptor).Intercept\\n\\t/home/builder/temporal/common/rpc/interceptor/telemetry.go:157\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1164\\ngo.temporal.io/server/service/frontend.(*RedirectionInterceptor).handleRedirectAPIInvocation.func2\\n\\t/home/builder/temporal/service/frontend/redirection_interceptor.go:227\\ngo.temporal.io/server/service/frontend.(*NoopRedirectionPolicy).WithNamespaceRedirect\\n\\t/home/builder/temporal/service/frontend/dcRedirectionPolicy.go:125\\ngo.temporal.io/server/service/frontend.(*RedirectionInterceptor).handleRedirectAPIInvocation\\n\\t/home/builder/temporal/service/frontend/redirection_interceptor.go:224\\ngo.temporal.io/server/service/frontend.(*RedirectionInterceptor).Intercept\\n\\t/home/builder/temporal/service/frontend/redirection_interceptor.go:184\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1164\\ngo.temporal.io/server/common/metrics.NewServerMetricsContextInjectorInterceptor.func1\\n\\t/home/builder/temporal/common/metrics/grpc.go:66\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1164\\ngo.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc.UnaryServerInterceptor.func1\\n\\t/go/pkg/mod/go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc@v0.36.4/interceptor.go:341\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1164\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceLogInterceptor).Intercept\\n\\t/home/builder/temporal/common/rpc/interceptor/namespace_logger.go:84\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1164\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceValidatorInterceptor).NamespaceValidateIntercept\\n\\t/home/builder/temporal/common/rpc/interceptor/namespace_validator.go:111\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1164\\ngo.temporal.io/server/common/rpc.ServiceErrorInterceptor\\n\\t/home/builder/temporal/common/rpc/grpc.go:137\\ngoogle.golang.org/grpc.chainUnaryInterceptors.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1155\\ngo.temporal.io/api/workflowservice/v1._WorkflowService_PollWorkflowTaskQueue_Handler\\n\\t/go/pkg/mod/go.temporal.io/api@v1.18.2-0.20230324225508-f2c7ab685b44/workflowservice/v1/service.pb.go:1518\\ngoogle.golang.org/grpc.(*Server).processUnaryRPC\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1345\\ngoogle.golang.org/grpc.(*Server).handleStream\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:1722\\ngoogle.golang.org/grpc.(*Server).serveStreams.func1.2\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.54.0/server.go:966\"}\r\n```","createdAt":"2023-04-26T21:20:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4160#issuecomment-1524060174","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5a13T2","author":{"login":"longquanzheng"},"authorAssociation":"CONTRIBUTOR","body":"> Do you have repro steps? Or logs from `tctl` and Server? I can try to investigate more.\r\n\r\nSorry for late response\r\nThanks @jupudibhaskar967 for providing the repro steps. \r\nMy repro steps would be just run the integ test in iWF without the workaround in https://github.com/indeedeng/iwf/pull/256 \r\nOne out of ten there should be a repro. But I think @jupudibhaskar967 's step would be much easier to follow","createdAt":"2023-04-26T21:30:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4160#issuecomment-1524069622","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5bPqHX","author":{"login":"jupudibhaskar967"},"authorAssociation":"NONE","body":"@rodrigozhou  Any updates on this?","createdAt":"2023-05-02T03:50:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4160#issuecomment-1530831319","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5bZrsF","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"@jupudibhaskar967 I found your issue. It happens when trying to add multiple search attributes of same type (eg: adding 2 keyword type search attributes). It might happen that one of them might be lost. This [PR](https://github.com/temporalio/temporal/pull/4273) should fix it.\r\n\r\n@longquanzheng I recommend you to update your commands to use [Temporal CLI](https://github.com/temporalio/cli) instead of `tctl`. The latter will be deprecated eventually, and although we're trying to keep both in sync at this moment, we'll stop eventually. I just noticed that the code path of `tctl` was not up-to-date relative to Temporal CLI, and this might be the issue you're facing. I'm updating together with the PR above, and hopefully it will fix it.","createdAt":"2023-05-03T17:48:16Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4160#issuecomment-1533459205","viewerDidAuthor":false}],"createdAt":"2023-04-12T21:04:00Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4160,"reactionGroups":[],"state":"CLOSED","title":"Search attributes registration is lost after successfully adding","updatedAt":"2023-05-11T20:25:22Z","url":"https://github.com/temporalio/temporal/issues/4160"}
