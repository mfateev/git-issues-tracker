{"assignees":[],"author":{"id":"MDQ6VXNlcjY5NjA0MDA=","is_bot":false,"login":"ytaben","name":"Yaroslav Taben"},"body":"## Expected Behavior\r\nHistory pods operate normally when redeployed from 1.20.4 to 1.21.6\r\n\r\n## Actual Behavior\r\nHistory pods panic with the following trace:\r\n```\r\nmain.PanicErrorWrapper\r\npanic: unable to find queue category by queye category ID: 5\r\n\r\ngoroutine 3960 [running]:\r\ngo.temporal.io/server/service/history/shard.loadShardInfoCompatibilityCheckWithoutReplication(0xc000f40500)\r\n\t/go/pkg/mod/go.temporal.io/server@v1.21.6/service/history/shard/compatibility.go:65 +0x334\r\ngo.temporal.io/server/service/history/shard.loadShardInfoCompatibilityCheck({0x304b310, 0xc00098a210}, 0xc001f6a810?)\r\n\t/go/pkg/mod/go.temporal.io/server@v1.21.6/service/history/shard/compatibility.go:47 +0x3f\r\ngo.temporal.io/server/service/history/shard.(*ContextImpl).loadShardMetadata(0xc000423680, 0xc001f7be7f)\r\n\t/go/pkg/mod/go.temporal.io/server@v1.21.6/service/history/shard/context_impl.go:1670 +0x1e9\r\ngo.temporal.io/server/service/history/shard.(*ContextImpl).acquireShard.func1()\r\n\t/go/pkg/mod/go.temporal.io/server@v1.21.6/service/history/shard/context_impl.go:1821 +0x46\r\ngo.temporal.io/server/common/backoff.ThrottleRetry.func1({0xc001c9bcf8, 0x40594a})\r\n\t/go/pkg/mod/go.temporal.io/server@v1.21.6/common/backoff/retry.go:119 +0x1b\r\ngo.temporal.io/server/common/backoff.ThrottleRetryContext({0x3035c20, 0xc00013c000}, 0xc001f7be28, {0x3015760, 0xc00052e630}, 0x28?)\r\n\t/go/pkg/mod/go.temporal.io/server@v1.21.6/common/backoff/retry.go:145 +0x20a\r\ngo.temporal.io/server/common/backoff.ThrottleRetry(0x0?, {0x3015760?, 0xc00052e630?}, 0x3?)\r\n\t/go/pkg/mod/go.temporal.io/server@v1.21.6/common/backoff/retry.go:120 +0x59\r\ngo.temporal.io/server/service/history/shard.(*ContextImpl).acquireShard(0xc000423680)\r\n\t/go/pkg/mod/go.temporal.io/server@v1.21.6/service/history/shard/context_impl.go:1889 +0x106\r\ncreated by go.temporal.io/server/service/history/shard.(*ContextImpl).transition.func1\r\n\t/go/pkg/mod/go.temporal.io/server@v1.21.6/service/history/shard/context_impl.go:1483 +0x11a\r\npanic: unable to find queue category by queye category ID: 5\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Run Temporal cluster version 1.20.4 with archival enabled\r\n  1. Disable archival globally in the static config\r\n  1. Attempt to upgrade to 1.21.6\r\n\r\n## Specifications\r\n\r\n  - Version: 1.20.4\\1.21.6\r\n  - Platform: Linux amd64\r\n\r\n## Additional Info:\r\nThe code that panics was introduced in [this PR](https://github.com/temporalio/temporal/pull/4190) (CC @wxing1292 )\r\n\r\nWe are not entirely sure how Temporal stores stuff in the persistence layer (a lot of it is blobs) but there appear to be shards with  archival queues while archival is actually disabled.\r\n\r\nGiven this server version is old and the code that bugs out appears to be migrationary in nature - we are ok with a workaround just for the upgrade but we wanted to make sure that whatever we do is safe.\r\n\r\nSpecifically - if we were to enable archival globally (but not for any namespace in particular), perform the upgrade and then again disable archival again - would we face any future issues?\r\nAlternatively - should we hack the code to load the archival category for the compatibility code to work? (it appears to be loaded conditionally on archival being enabled cluster wide)\r\n\r\nWe were looking for a way to do the upgrade without archival since we disabled it because it has previously caused a different panic (patched in a newer version of Temporal we're not on yet)\r\n\r\nHappy to provide additional info or help with the investigation in any way.\r\nThank you!","closedAt":null,"comments":[{"id":"IC_kwDODNqesM6FW6bi","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"i believe the 1.21.x version does not take workflow archival into considersation and caused this issue. \r\nthe bug should be fixed by 1.22.x? cc @yycptt\r\ni will let oss server team to take over this conversation \r\n\r\n[1.21.x logic](https://github.com/temporalio/temporal/blame/v1.21.6/service/history/shard/context_impl.go#L1670)\r\n[1.22.x logic](https://github.com/temporalio/temporal/blame/v1.22.7/service/history/shard/context_impl.go#L1670)","createdAt":"2024-07-18T19:29:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6307#issuecomment-2237376226","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6GSpas","author":{"login":"ytaben"},"authorAssociation":"CONTRIBUTOR","body":"Hey @wxing1292 @yycptt,\r\n\r\nAny chance you were able to take a look?\r\nYou mentioned that the bug is allegedly fixed in 1.22.x but unless it's safe to jump to 1.22.x (which I assume it isn't) - we need a safe way to upgrade to 1.21.x\r\n\r\nWe would be happy to help with the investigation and\\or make a fix contribution, we just aren't familiar enough with the codebase and shard structure to be certain our fix works and we don't introduce another regression\r\n","createdAt":"2024-07-26T15:47:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6307#issuecomment-2253035180","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6GS6z8","author":{"login":"yycptt"},"authorAssociation":"MEMBER","body":"One way I can think of is \r\n- Set `history.archivalProcessorSchedulerWorkerCount` dynamic config to 0 (this will prevent any archival task from being executed). You can also set `history.queuePendingTasksMaxCount` to a lower value like 1000 to prevent loading too many tasks into memory as there's no worker to process them.\r\n- Enable archival in the static config (this will register the queue category so shard context logic won't panic). \r\n- Deploy 1.21, and then 1.22. \r\n- Revert both config changes and restart the service\r\n\r\nIf you don't care about archival task is executed or not, I guess just enabled the static config for archival, do the upgrade for 1.21 and 1.22 and then disable. ","createdAt":"2024-07-26T16:33:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6307#issuecomment-2253106428","viewerDidAuthor":false}],"createdAt":"2024-07-18T15:20:26Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":6307,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"OPEN","title":"Panic When Upgrading From 1.20.4 To 1.21.6","updatedAt":"2024-07-26T16:33:13Z","url":"https://github.com/temporalio/temporal/issues/6307"}
