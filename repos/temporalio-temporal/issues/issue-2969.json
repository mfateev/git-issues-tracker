{"assignees":[{"id":"MDQ6VXNlcjQ2NjcyMw==","login":"dnr","name":"David Reiss","databaseId":0}],"author":{"id":"MDQ6VXNlcjQ2NjcyMw==","is_bot":false,"login":"dnr","name":"David Reiss"},"body":"## Expected Behavior\r\nCalling e.g. `DescribeTaskQueue` on a task queue that exists but is not currently loaded should return the correct metadata.\r\n\r\n## Actual Behavior\r\nWhat happens is that `matchingEngine` creates a `taskQueueManager` and then immediately calls `DescribeTaskQueue` on it. The tqm creates a `taskReader` and `taskWriter`, and it's the `taskWriter` that acquires the initial lease (or if it doesn't exist, creates the record in the db). But that takes a little time and the tqm doesn't wait for it, so it sees no data loaded.\r\n\r\nThe same problem could happen for other rpcs.\r\n\r\nPossible solution:\r\n\r\nAdd a method to tqm that blocks (up to the context timeout) until taskWriter has acquired the lease (or failed to), and call that from most of the matchingEngine methods. This would probably need one extra channel in tqm to signal readiness.\r\n\r\nAlternately, we could make `newTaskQueueManager` just not return until it's acquired the lease (or failed). It would have to take a context for timeout/cancellation.\r\n\r\n\r\ncc @Sushisource ","closedAt":"2022-07-15T00:26:31Z","comments":[],"createdAt":"2022-06-07T23:17:19Z","labels":[{"id":"MDU6TGFiZWwyNTc2NTM1ODQ2","name":"difficulty: easy","description":"","color":"68d662"},{"id":"LA_kwDODNqesM7iefm2","name":"matching","description":"","color":"AC7693"}],"milestone":null,"number":2969,"reactionGroups":[],"state":"CLOSED","title":"matching rpcs should block while loading/acquiring lease","updatedAt":"2022-07-15T00:26:31Z","url":"https://github.com/temporalio/temporal/issues/2969"}
