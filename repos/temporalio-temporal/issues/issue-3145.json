{"assignees":[{"id":"MDQ6VXNlcjE3MjM4ODEw","login":"maoyi16","name":"Yi","databaseId":0}],"author":{"id":"MDQ6VXNlcjc3NTQxMjA=","is_bot":false,"login":"yycptt","name":"Yichao Yang"},"body":"## Expected Behavior\r\nOnly valid (started) tasks should count towards per task queue ratelimiting. (when user specifies `TaskQueueActivitiesPerSecond ` in worker config)\r\n\r\n## Actual Behavior\r\nhttps://github.com/temporalio/temporal/blob/master/service/matching/matcher.go#L228\r\n\r\nAll tasks, regardless of whether its expired or failed to start or successfully started will consume token from the rate limiter, since we perform the rate limiting step when attempting a match.\r\n\r\nFor example when there's a backlog of expired tasks in the task buffer, all tasks will consume the rate limiting token and throttle how fast the backlog can be drained. However, from user/worker perspective, there's no dispatched tasks at all.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1.\r\n  1.\r\n  1.\r\n\r\n## Specifications\r\n\r\n  - Version:\r\n  - Platform:\r\n","closedAt":null,"comments":[],"createdAt":"2022-07-26T22:49:30Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":3145,"reactionGroups":[],"state":"OPEN","title":"Per task queue ratelimiting should only count valid activity tasks","updatedAt":"2023-03-03T20:19:44Z","url":"https://github.com/temporalio/temporal/issues/3145"}
