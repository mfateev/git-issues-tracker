{"assignees":[{"id":"MDQ6VXNlcjIwNjgxMjQ=","login":"rodrigozhou","name":"Rodrigo Zhou","databaseId":0}],"author":{"id":"MDQ6VXNlcjE2Nzg0Nw==","is_bot":false,"login":"Hades32","name":"Martin Rauscher"},"body":"## Expected Behavior\r\nscripts to work on CRDB\r\n\r\n## Actual Behavior\r\n` ERROR   Unable to update SQL schema.    {\"error\": \"error executing statement:pq: unimplemented: extension \\\"btree_gin\\\" is not yet supported\", \"logging-call-at\": \"handler.go:78\"}`\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. run `./temporal-sql-tool update-schema -schema-dir schema/postgresql/v96/temporal/versioned` against a CRDB v22.2.7\r\n\r\n## Specifications\r\n\r\n  - Version: Temporal 1.20.1\r\n  - Platform: Linux\r\n","closedAt":"2023-10-21T20:20:09Z","comments":[{"id":"IC_kwDODNqesM5ZJt0P","author":{"login":"Hades32"},"authorAssociation":"NONE","body":"This also prevents advanced visibility to be used with the SQL backend","createdAt":"2023-04-04T10:24:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4136#issuecomment-1495719183","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5ZKTmS","author":{"login":"Hades32"},"authorAssociation":"NONE","body":"@rodrigozhou why is this even used in [1] and [2]? According to https://www.postgresql.org/docs/current/btree-gin.html this is rarely useful and from looking at the other migrations it's not actually used as indexes created without `USING GIN` will use the default index\r\n\r\n[1] https://github.com/temporalio/temporal/blob/6f1f02280f72bc92212c98a87c8a21122724490b/schema/postgresql/v12/visibility/schema.sql#L1\r\n[2] https://github.com/temporalio/temporal/blob/6f1f02280f72bc92212c98a87c8a21122724490b/schema/postgresql/v12/visibility/versioned/v1.2/advanced_visibility.sql#L1","createdAt":"2023-04-04T12:18:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4136#issuecomment-1495873938","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5ZMDmc","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"@Hades32 Postgres needs to enable btree_gin extension to enable creating multi-column GIN index.\nWith CockroachDB, it seems that it's not necessary and it works out of the box: https://www.cockroachlabs.com/docs/v22.2/inverted-indexes#multi-column-gin-indexes\nCan you try just removing the line `CREATE EXTENSION btree_gin;`?","createdAt":"2023-04-04T17:19:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4136#issuecomment-1496332700","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5ZMS-Z","author":{"login":"Hades32"},"authorAssociation":"NONE","body":"I will try tomorrow and get back to you.\r\n\r\nIs that because of the data types you're indexing? Since 8.4 postgres supports multicolumn indexes with GIN without that extension for default types","createdAt":"2023-04-04T18:12:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4136#issuecomment-1496395673","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5ZQUM-","author":{"login":"Hades32"},"authorAssociation":"NONE","body":"@rodrigozhou so it's not so easy it seems. CRDB isn't happy about a few things\r\n* the `convert_ts` function: PSQL isn't supported yet (as in many pg-compatible DBs)\r\n* conversion of an timestamp to one with a timezone is a context dependent operation, not sure why plain Plostgres allows this, but CRDB forces you to use `parse_timestamp`\r\n* the `::tsvector` vector cast isn't supported. I'm not sure why but seems the next CRDB version (v23) might\r\n\r\nSo yeah... I'm not sure how far you'd be willing to go to keep the CRDB support going?\r\n\r\nAnd one general issue: You're not running those migrations in a transaction! I was stuck in the middle of a half-applied migration :(\r\n\r\n","createdAt":"2023-04-05T13:01:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4136#issuecomment-1497449278","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5ZQqGW","author":{"login":"danthegoodman1"},"authorAssociation":"NONE","body":"I'd definitely want to see CRDB fully supported, lots of large companies are moving from Postgres to CRDB or choosing CRDB over Postgres to boot (DoorDash, Twitter). It's also very in-line with the concept of Temporal, especially seeing as Cassandra is the preferred persistence layer.\r\n\r\nPlus my guess is if you support CRDB then Postgres support comes free as long as you don't use any CRDB-specific syntax :D","createdAt":"2023-04-05T14:00:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":4}}],"url":"https://github.com/temporalio/temporal/issues/4136#issuecomment-1497538966","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5ZnYZC","author":{"login":"danthegoodman1"},"authorAssociation":"NONE","body":"TSvector is the main problem. Not sure why that `convert_ts` function exists but it can be replaced either with a cast or CRDB's UDF creation format.\r\n\r\nSeems like support for `tsvector` has been merged ~~, but unsure about release~~: https://github.com/cockroachdb/cockroach/pull/90842\r\n\r\nrelease soon: https://www.cockroachlabs.com/docs/releases/v23.1.html#v23-1-0-alpha-5-sql-language-changes","createdAt":"2023-04-11T14:38:45Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4136#issuecomment-1503495746","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5glWSA","author":{"login":"Hades32"},"authorAssociation":"NONE","body":"Opened a PR for this","createdAt":"2023-07-04T14:56:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4136#issuecomment-1620403328","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5pu8Qw","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Close this one as there is another one to track support for CRDB.","createdAt":"2023-10-21T20:20:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4136#issuecomment-1773913136","viewerDidAuthor":false}],"createdAt":"2023-04-03T13:57:38Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4136,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":4}}],"state":"CLOSED","title":"v1.21 is supposed to drop Postgres v9.6 support, but v12 scripts fail on CockroachDB","updatedAt":"2023-10-21T20:20:09Z","url":"https://github.com/temporalio/temporal/issues/4136"}
