{"assignees":[{"id":"MDQ6VXNlcjc3NTQxMjA=","login":"yycptt","name":"Yichao Yang","databaseId":0}],"author":{"id":"MDQ6VXNlcjg3NjI4OTM=","is_bot":false,"login":"wxing1292","name":"Wenquan Xing"},"body":"Currently, when signaling current workflow (run ID being empty), the logic will\r\n1. get current run ID from DB\r\n2. using above current run ID for workflow lock\r\n3. check if workflow is still running\r\n  a. if still running, signal workflow\r\n  b. if completed, return not found error\r\n\r\nabove logic can encounter race condition if target workflow does continue as new, e.g.\r\nT = 0: current run ID is '1234-5678'\r\nT = 1: (signal caller) get current run ID from DB: '1234-5678'\r\nT = 2: current run '1234-5678' does continue as new to 'abcd-efgh'\r\nT = 3: (signal caller) using above current run ID '1234-5678' for workflow lock\r\nT = 4: (signal caller) see target workflow '1234-5678' is finished, while the actually current workflow is 'abcd-efgh'\r\n\r\none way to solve above issue is to swap the logic of this `if block`https://github.com/temporalio/temporal/blob/2ebc73eedfd0a096568ed6c15f0bc26776f22d87/service/history/historyEngine.go#L1976-L1978 with \r\n```go\r\nif !mutableState.IsWorkflowExecutionRunning() {\r\n\t_, status := mutableState.GetWorkflowStateStatus()\r\n\tif status == enumspb.WORKFLOW_EXECUTION_STATUS_CONTINUED_AS_NEW && currentWorkflow {\r\n\t\treturn nil, serviceerror.NewUnavailable(\"try again\")\r\n\t}\r\n\treturn nil, consts.ErrWorkflowCompleted\r\n}\r\n```\r\n\r\nthe idea is, retry if workflow is continued-as-new & run ID is empty","closedAt":"2022-04-20T00:24:01Z","comments":[{"id":"IC_kwDODNqesM5BwueV","author":{"login":"yycptt"},"authorAssociation":"MEMBER","body":"I believe the logic [here](https://github.com/temporalio/temporal/blob/master/service/history/historyEngine.go#L3629) already cover this case.\r\n\r\nThe link logic will first get current runID from DB, lock the execution and then check if the workflow is running or not. If it's not running, the logic will query current runID again and make sure the current runID doesn't change before returning. \r\n\r\nThis basically means at T = 4, the logic will realize the workflow is not running and query the current ID again, and see 'abcd-efgh' ","createdAt":"2022-04-20T00:24:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2694#issuecomment-1103292309","viewerDidAuthor":false}],"createdAt":"2022-03-31T23:34:39Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg0","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":2694,"reactionGroups":[],"state":"CLOSED","title":"Guarantee signal is delivered to current workflow during continue as new","updatedAt":"2022-04-20T00:24:01Z","url":"https://github.com/temporalio/temporal/issues/2694"}
