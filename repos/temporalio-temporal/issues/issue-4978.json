{"assignees":[{"id":"MDQ6VXNlcjIwNjgxMjQ=","login":"rodrigozhou","name":"Rodrigo Zhou","databaseId":0}],"author":{"id":"MDQ6VXNlcjQ2NjcyMw==","is_bot":false,"login":"dnr","name":"David Reiss"},"body":"## Expected Behavior\r\n\r\nFor any query that triggers an error in the parser, it should be returned to the client immediately.\r\n\r\n## Actual Behavior\r\n\r\nOn SQL advanced visibility (not ES) the error gets swallowed somewhere and retried internally, while the client is blocked and eventually times out.\r\n\r\nServer logs:\r\n\r\n```\r\n{\"level\":\"error\",\"ts\":\"2023-10-13T13:20:16.581-0400\",\"msg\":\"Operation failed with an error.\",\"error\":\"syntax error at position 32\",\"logging-call-at\":\"visiblity_manager_metrics.go:265\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/home/dnr/t/temporal/common/log/zap_logger.go:156\\ngo.temporal.io/server/common/persistence/visibility.(*visibilityManagerMetrics).updateErrorMetric\\n\\t/home/dnr/t/temporal/common/persistence/visibility/visiblity_manager_metrics.go:265\\ngo.temporal.io/server/common/persistence/visibility.(*visibilityManagerMetrics).ListWorkflowExecutions\\n\\t/home/dnr/t/temporal/common/persistence/visibility/visiblity_manager_metrics.go:209\\ngo.temporal.io/server/service/frontend.(*WorkflowHandler).ListWorkflowExecutions\\n\\t/home/dnr/t/temporal/service/frontend/workflow_handler.go:1940\\ngo.temporal.io/api/workflowservice/v1._WorkflowService_ListWorkflowExecutions_Handler.func1\\n\\t/home/dnr/t/go/pkg/mod/go.temporal.io/api@v1.24.1-0.20231003165936-bb03061759c8/workflowservice/v1/service.pb.go:2039\\ngo.temporal.io/server/common/rpc/interceptor.(*RetryableInterceptor).Intercept.func1\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/retry.go:63\\ngo.temporal.io/server/common/backoff.ThrottleRetryContext\\n\\t/home/dnr/t/temporal/common/backoff/retry.go:143\\ngo.temporal.io/server/common/rpc/interceptor.(*RetryableInterceptor).Intercept\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/retry.go:67\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/common/rpc/interceptor.(*CallerInfoInterceptor).Intercept\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/caller_info.go:80\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/common/rpc/interceptor.(*SDKVersionInterceptor).Intercept\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/sdk_version.go:69\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/common/rpc/interceptor.(*RateLimitInterceptor).Intercept\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/rate_limit.go:88\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceRateLimitInterceptor).Intercept\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/namespace_rate_limit.go:93\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/common/rpc/interceptor.(*ConcurrentRequestLimitInterceptor).Intercept\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/concurrent_request_limit.go:121\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceValidatorInterceptor).StateValidationIntercept\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/namespace_validator.go:196\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/common/authorization.(*interceptor).Interceptor\\n\\t/home/dnr/t/temporal/common/authorization/interceptor.go:162\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/common/rpc/interceptor.(*TelemetryInterceptor).UnaryIntercept\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/telemetry.go:160\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/service/frontend.(*RedirectionInterceptor).handleRedirectAPIInvocation.func2\\n\\t/home/dnr/t/temporal/service/frontend/redirection_interceptor.go:238\\ngo.temporal.io/server/service/frontend.(*NoopRedirectionPolicy).WithNamespaceRedirect\\n\\t/home/dnr/t/temporal/service/frontend/dc_redirection_policy.go:125\\ngo.temporal.io/server/service/frontend.(*RedirectionInterceptor).handleRedirectAPIInvocation\\n\\t/home/dnr/t/temporal/service/frontend/redirection_interceptor.go:235\\ngo.temporal.io/server/service/frontend.(*RedirectionInterceptor).Intercept\\n\\t/home/dnr/t/temporal/service/frontend/redirection_interceptor.go:195\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/service/frontend.GrpcServerOptionsProvider.NewServerMetricsContextInjectorInterceptor.func1\\n\\t/home/dnr/t/temporal/common/metrics/grpc.go:66\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc.UnaryServerInterceptor.func1\\n\\t/home/dnr/t/go/pkg/mod/go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc@v0.42.0/interceptor.go:344\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceLogInterceptor).Intercept\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/namespace_logger.go:84\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceValidatorInterceptor).NamespaceValidateIntercept\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/namespace_validator.go:113\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/common/rpc.ServiceErrorInterceptor\\n\\t/home/dnr/t/temporal/common/rpc/grpc.go:145\\ngoogle.golang.org/grpc.NewServer.chainUnaryServerInterceptors.chainUnaryInterceptors.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1186\\ngo.temporal.io/api/workflowservice/v1._WorkflowService_ListWorkflowExecutions_Handler\\n\\t/home/dnr/t/go/pkg/mod/go.temporal.io/api@v1.24.1-0.20231003165936-bb03061759c8/workflowservice/v1/service.pb.go:2041\\ngoogle.golang.org/grpc.(*Server).processUnaryRPC\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1376\\ngoogle.golang.org/grpc.(*Server).handleStream\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1753\\ngoogle.golang.org/grpc.(*Server).serveStreams.func1.1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:998\"}\r\n{\"level\":\"error\",\"ts\":\"2023-10-13T13:20:16.581-0400\",\"msg\":\"service failures\",\"operation\":\"ListWorkflowExecutions\",\"wf-namespace\":\"default\",\"error\":\"syntax error at position 32\",\"logging-call-at\":\"telemetry.go:334\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/home/dnr/t/temporal/common/log/zap_logger.go:156\\ngo.temporal.io/server/common/rpc/interceptor.(*TelemetryInterceptor).handleError\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/telemetry.go:334\\ngo.temporal.io/server/common/rpc/interceptor.(*TelemetryInterceptor).UnaryIntercept\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/telemetry.go:169\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/service/frontend.(*RedirectionInterceptor).handleRedirectAPIInvocation.func2\\n\\t/home/dnr/t/temporal/service/frontend/redirection_interceptor.go:238\\ngo.temporal.io/server/service/frontend.(*NoopRedirectionPolicy).WithNamespaceRedirect\\n\\t/home/dnr/t/temporal/service/frontend/dc_redirection_policy.go:125\\ngo.temporal.io/server/service/frontend.(*RedirectionInterceptor).handleRedirectAPIInvocation\\n\\t/home/dnr/t/temporal/service/frontend/redirection_interceptor.go:235\\ngo.temporal.io/server/service/frontend.(*RedirectionInterceptor).Intercept\\n\\t/home/dnr/t/temporal/service/frontend/redirection_interceptor.go:195\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/service/frontend.GrpcServerOptionsProvider.NewServerMetricsContextInjectorInterceptor.func1\\n\\t/home/dnr/t/temporal/common/metrics/grpc.go:66\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc.UnaryServerInterceptor.func1\\n\\t/home/dnr/t/go/pkg/mod/go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc@v0.42.0/interceptor.go:344\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceLogInterceptor).Intercept\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/namespace_logger.go:84\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceValidatorInterceptor).NamespaceValidateIntercept\\n\\t/home/dnr/t/temporal/common/rpc/interceptor/namespace_validator.go:113\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1195\\ngo.temporal.io/server/common/rpc.ServiceErrorInterceptor\\n\\t/home/dnr/t/temporal/common/rpc/grpc.go:145\\ngoogle.golang.org/grpc.NewServer.chainUnaryServerInterceptors.chainUnaryInterceptors.func1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1186\\ngo.temporal.io/api/workflowservice/v1._WorkflowService_ListWorkflowExecutions_Handler\\n\\t/home/dnr/t/go/pkg/mod/go.temporal.io/api@v1.24.1-0.20231003165936-bb03061759c8/workflowservice/v1/service.pb.go:2041\\ngoogle.golang.org/grpc.(*Server).processUnaryRPC\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1376\\ngoogle.golang.org/grpc.(*Server).handleStream\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:1753\\ngoogle.golang.org/grpc.(*Server).serveStreams.func1.1\\n\\t/home/dnr/t/go/pkg/mod/google.golang.org/grpc@v1.58.2/server.go:998\"}\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. `./temporal-server --env development-sqlite start`\r\n  1. `temporal operator namespace create default`\r\n  1. `temporal workflow list -q '1 == 1'`\r\n\r\nIt looks like most obvious syntax errors are handled fine, but anything with a substring `==` seems to fail this way.\r\n\r\n## Specifications\r\n\r\n  - Version: 1.22\r\n  - Platform:\r\n","closedAt":"2023-12-04T21:02:09Z","comments":[],"createdAt":"2023-10-13T17:45:23Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4978,"reactionGroups":[],"state":"CLOSED","title":"some visibility query syntax errors aren't returned to the client","updatedAt":"2023-12-04T21:02:09Z","url":"https://github.com/temporalio/temporal/issues/4978"}
