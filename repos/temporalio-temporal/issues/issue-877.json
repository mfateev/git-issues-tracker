{"assignees":[{"id":"MDQ6VXNlcjg3NjI4OTM=","login":"wxing1292","name":"Wenquan Xing","databaseId":0}],"author":{"id":"MDQ6VXNlcjUyMjI1MTI=","is_bot":false,"login":"hazcod","name":"Niels Hofmans"},"body":"## Expected Behavior\r\ntemporal should not hardcode database hostnames since most people will want to dedicate a custom name to the database, such as `temporal-db`.\r\n\r\n## Actual Behavior\r\ntemporal `start.sh` script expects the database name to be `postgresql` for the right seeds & wait sequence to be selected. Better would be to check for `POSTGRES_SEEDS` being non-empty or an additional argument `DB_TYPE-postgresql`. This is worsened by the fact that link aliases in Docker are being deprecated, not allowing for service names to be overwritten in Docker.\r\n\r\n## Steps to Reproduce the Problem\r\n```yaml\r\n  temporal:\r\n    image: temporalio/auto-setup:1.0.0\r\n    restart: \"on-failure:10\"\r\n    security_opt:\r\n    - \"no-new-privileges\"\r\n    cap_drop:\r\n    - ALL\r\n    tty: false\r\n    networks:\r\n    - backend\r\n    environment:\r\n    - \"LOG_LEVEL=warn\"\r\n    - \"AUTO_SETUP=true\"\r\n    - \"DB=temporaldb\"\r\n    - \"DB_PORT=26257\"\r\n    - \"POSTGRES_USER=root\"\r\n    - \"POSTGRES_PWD=postgres\"\r\n    - \"POSTGRES_SEEDS=postgresql\"\r\n    - \"SKIP_DEFAULT_NAMESPACE_CREATION=true\"\r\n    ports:\r\n    - 7233\r\n    depends_on:\r\n    - temporaldb\r\n```\r\n\r\nLogs:\r\n```\r\n+ cqlsh --cqlversion=3.4.4\r\nConnection error: ('Unable to connect to any servers', {'127.0.0.1:9042': error(111, \"Tried connecting to [('127.0.0.1', 9042)]. Last error: Connection refused\")})\r\n+ echo 'waiting for cassandra to start up'\r\nwaiting for cassandra to start up\r\n+ sleep 1\r\n\r\n```\r\n\r\n## Specifications\r\nhttps://github.com/temporalio/temporal/blob/master/docker/start.sh#L147\r\n","closedAt":"2020-10-27T21:41:06Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDcxMjMxMDA4OA==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"Hi\r\n\r\n**PostgreSQL is not officially supported yet (will be in few days)**\r\n\r\nThere are few docker / startup script changes related to PostgreSQL, plz wait for the official release\r\n\r\nOn master branch:\r\n```zsh\r\ndocker build . -t temporalio/auto-setup:local --build-arg TARGET=auto-setup\r\n```\r\nthen use yaml\r\n```yaml\r\nversion: \"3\"\r\nservices:\r\n  temporaldb:\r\n    image: postgres:9.6\r\n    ports:\r\n      - \"5432:5432\"\r\n    environment:\r\n      POSTGRES_USER: temporal\r\n      POSTGRES_PASSWORD: temporal\r\n  temporal:\r\n    image: temporalio/auto-setup:${SERVER_TAG:-1.1.0}\r\n    ports:\r\n      - \"7233:7233\"\r\n    volumes:\r\n      - ${DYNAMIC_CONFIG_DIR:-../config/dynamicconfig}:/etc/temporal/config/dynamicconfig\r\n    environment:\r\n      - \"DB=postgresql\"\r\n      - \"DB_PORT=5432\"\r\n      - \"POSTGRES_USER=temporal\"\r\n      - \"POSTGRES_PWD=temporal\"\r\n      - \"POSTGRES_SEEDS=temporaldb\"\r\n      - \"DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development.yaml\"\r\n    depends_on:\r\n      - temporaldb\r\n```\r\nalong with \r\n```zsh\r\nSERVER_TAG=local docker-compose -f docker/docker-compose-postgres.yml up\r\n```\r\nworks\r\n","createdAt":"2020-10-19T17:17:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/877#issuecomment-712310088","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDcxNDI4ODg1MQ==","author":{"login":"ivanr"},"authorAssociation":"NONE","body":"@wxing1292 We would be interested in using Temporal with Postgres, but, if I am reading this correctly, you appear to be targeting 9.6, which is ancient? There have been at least four major Postgres releases since (10-13), with tremendous improvements. Perhaps 13 is too recent (last month), but 12 wouldn't be controversial :)","createdAt":"2020-10-22T07:22:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/877#issuecomment-714288851","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDcxNDI5MjU5Mw==","author":{"login":"hazcod"},"authorAssociation":"CONTRIBUTOR","body":"@ivanr IMO recent postgres support has been working fine for a while, I've been using cockroachdb.\r\nAlbeit there is the limitation this ticket is about.\r\n\r\n@wxing1292 wouldn't `POSTGRES_SEEDS` refer to the database seed script to use? Kind of odd parameter name usage.\r\nI would think:\r\n```yaml\r\n    environment:\r\n      - \"DB=postgresql\" # name of db\r\n      - \"DB_PORT=5432\"\r\n      - \"POSTGRES_USER=temporal\"\r\n      - \"POSTGRES_PWD=temporal\"\r\n      - \"POSTGRES_TYPE=postgres\" # type of db, also infers seeds to use\r\n      - \"DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development.yaml\"\r\n```","createdAt":"2020-10-22T07:29:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/877#issuecomment-714292593","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDcxNTM4MjQzOA==","author":{"login":"mnichols"},"authorAssociation":"MEMBER","body":"~~This is probably known, but when i followed @wxing1292 steps above on fresh `master` pull this morning, cassandra is still being attempted for connection over and over. Disabling it in the startup script and rebuilding didnt seem to make it go away~~:\r\n```\r\n+ echo 'waiting for cassandra to start up'\r\ntemporal_1           | + sleep 1\r\ntemporal_1           | waiting for cassandra to start up\r\ntemporal_1           | + cqlsh --cqlversion=3.4.4\r\ntemporal_1           | Connection error: ('Unable to connect to any servers', {'127.0.0.1:9042': error(111, \"Tried connecting to [('127.0.0.1', 9042)]. Last error: Connection refused\")})\r\ntemporal_1           | + echo 'waiting for cassandra to start up'\r\ntemporal_1           | waiting for cassandra to start up\r\ntemporal_1           | + sleep 1\r\ntemporal_1           | + cqlsh --cqlversion=3.4.4\r\n```\r\n\r\nEDIT: I started all over again and this time I didnt get the cassandra ping script. Sorry about the noise!\r\n","createdAt":"2020-10-23T14:37:44Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/877#issuecomment-715382438","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDcxNzU1NjkzMQ==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"solved in 1.2.1 release\r\nhttps://github.com/temporalio/temporal/releases/tag/v1.2.1","createdAt":"2020-10-27T21:41:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/877#issuecomment-717556931","viewerDidAuthor":false}],"createdAt":"2020-10-19T07:54:40Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":877,"reactionGroups":[],"state":"CLOSED","title":"docker image expects database name to be postgresql","updatedAt":"2020-10-27T21:41:06Z","url":"https://github.com/temporalio/temporal/issues/877"}
