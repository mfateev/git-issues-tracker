{"assignees":[],"author":{"id":"MDQ6VXNlcjU0MzI1MTcw","is_bot":false,"login":"vinodnaidu02","name":""},"body":"**Is your feature request related to a problem? Please describe.**\r\nTrying to set schema namespace which temporal has to use but not able to set using sql-tool.\r\n\r\n**Describe the solution you'd like**\r\nbased on the search path selection, temporal has to use that schema.\r\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM5KgO3X","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"Sounds like a good idea. Are you willing to contribute? \r\nSchema file is here: https://github.com/temporalio/temporal/blob/master/schema/postgresql/v96/temporal/schema.sql\r\nQueries are here:\r\nhttps://github.com/temporalio/temporal/tree/master/common/persistence/sql/sqlplugin/postgresql (almost in every file).\r\n\r\nVisibility schema/queries are also needs to be updated.","createdAt":"2022-09-17T00:51:22Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3383#issuecomment-1249963479","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5KgXo5","author":{"login":"vinodnaidu02"},"authorAssociation":"NONE","body":"Hi Alex\r\n\r\nI am able to set schema while using sql-tool. I used the below command while installing. The only problem is there is no documentation that explains how to use search_path,\r\n\r\n```\r\n SQL_DATABASE=temporal ./temporal-sql-tool --ca search_path=temporal setup-schema -v 0.0\r\n```\r\n \r\nThe main issue I faced was configuring the temporal server to use this schema, I also found a vague solution to fix this. still I am not very sure if this is proper,\r\n\r\n```\r\nconnectAttributes: \r\n                    search_path:  \"{{ default .Env.SCHEMA_NAME \"temporal\" }}\"\r\n```\r\n\r\nThe above config value is part of Mysql config_template, however, for Postgres, there is no option. By adding this line to both temporal and visibility databases in the Postgres part, the temporal server is connecting to the respective schema.\r\n\r\n\r\nPlease let me know if you want I can do these changes(Hopefully my approach is correct).\r\n                 \r\n","createdAt":"2022-09-17T04:49:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3383#issuecomment-1249999417","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5U3Sd3","author":{"login":"anjulaendowus"},"authorAssociation":"NONE","body":"@vinodnaidu02 Anything changed with this approach? Im facing this same problem.","createdAt":"2023-02-09T08:00:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3383#issuecomment-1423779703","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5U3sCa","author":{"login":"vinodnaidu02"},"authorAssociation":"NONE","body":"@anjulaendowus  I am still using the above approach I mentioned. I created a docker image based on the above config which accepts schema ENV and uses that while connecting. ","createdAt":"2023-02-09T09:29:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3383#issuecomment-1423884442","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5U3ur7","author":{"login":"anjulaendowus"},"authorAssociation":"NONE","body":"@vinodnaidu02 DId u use this command? \r\n`SQL_DATABASE=temporal_visibility ./temporal-sql-tool update -schema-dir schema/postgresql/v96/visibility/versioned`\r\ndid you pass the --ca flag as well for this? Does this work with postgres? Thanks for the reply","createdAt":"2023-02-09T09:38:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3383#issuecomment-1423895291","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5U3wua","author":{"login":"vinodnaidu02"},"authorAssociation":"NONE","body":"Yes I did use the command and pass the --ca flag and it is working with the Postgres. Not sure if something has changed recently.","createdAt":"2023-02-09T09:45:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3383#issuecomment-1423903642","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5U34Od","author":{"login":"anjulaendowus"},"authorAssociation":"NONE","body":"Did u manually create the schema @vinodnaidu02 ?\r\n","createdAt":"2023-02-09T10:08:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3383#issuecomment-1423934365","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5U39gA","author":{"login":"vinodnaidu02"},"authorAssociation":"NONE","body":"Yes, I manually created the schema inside DB before temporal starts.","createdAt":"2023-02-09T10:24:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/3383#issuecomment-1423955968","viewerDidAuthor":false},{"id":"IC_kwDODNqesM51y0pL","author":{"login":"chlunde"},"authorAssociation":"NONE","body":"https://www.percona.com/blog/public-schema-security-upgrade-in-postgresql-15/\r\n\r\nSo I think we need a  `CREATE SCHEMA IF NOT EXISTS schema_name` (which is manual today), in addition to the `search_path` (which is possible to set, but only as an attribute which means that temporal doesn't really know what's going on).\r\n\r\n@alexshtin do you have any input on how to implement this? I'm not familiar with this code base, so I wonder what's the natural place to:\r\n1. Define the schema name as a property (for templating the above query below and possibly setting search_path automatically)\r\n2. Put the CREATE statement. Maybe after `CREATE DATABASE` (but I would like an `IF NOT EXISTS` on that too, because the database provider might have created the db but not the schema, or neither db and schema).\r\n","createdAt":"2024-03-04T10:27:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3383#issuecomment-1976257099","viewerDidAuthor":false},{"id":"IC_kwDODNqesM52BOoe","author":{"login":"bkcsfi"},"authorAssociation":"NONE","body":"I encountered a problem today with temporal-sql-tool not working with postgres when the database already exists and the db user is NOT a superuser.\r\n\r\nI am using temporal-operator in conjunction with cloudnative-pg. The later handles database creation, replication and lifecycle operations. Therefore the database already exists by the time the `temporal-sql-tool create` operation is executed by the temporal-operator.\r\n\r\nIn addition, cloudnative-pg no longer creates users with superuser access. \r\n\r\nThe temporal-sql-tool postgres module checks for \"duplicate database\" error AFTER attempting to create the database. However since the user does not  have superuser access, temporal-sql-tool create fails with `pq: permission denied to create database`\r\n\r\nIs this a reasonable issue on which to graft \"check for existing database before attempting to create\"?\r\n\r\nIf that change were implemented, its possible that a non-superuser database account would work properly with temporal-sql-tool.   (though I don't know what roles the schema upgrade steps require).\r\n\r\n\r\n\r\n","createdAt":"2024-03-06T03:42:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3383#issuecomment-1980033566","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6BkKgr","author":{"login":"hansliu"},"authorAssociation":"NONE","body":"Could we add the **connectAttributes: search_path** to the default [config_template.yaml](https://github.com/temporalio/temporal/blob/main/docker/config_template.yaml)?\r\n\r\nOr how to override the config_template.yaml from docker hub temporalio/server image?","createdAt":"2024-06-17T15:39:28Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3383#issuecomment-2173741099","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6VfZBZ","author":{"login":"enricojonas"},"authorAssociation":"NONE","body":"We would also like a custom schema name, either automatically created or created beforehand.","createdAt":"2024-11-29T15:28:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3383#issuecomment-2508034137","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6jh_AR","author":{"login":"justinrixx"},"authorAssociation":"NONE","body":"i'd like this ability as well.\n\none workaround that seems to work in an internal test is to create a new schema and set the search path to the new schema:\n\n```\nCREATE SCHEMA <schema_name>;\nALTER ROLE <admin_user> SET search_path TO <schema_name>, '$user', public;\n```\n\nthis works as long as temporal doesn't reference the `public` schema directly, but rather continues to use the default search path. like i said, this appears to work in an internal test, but i'm hesitant to rely on it without confirmation from the project that this contract won't be broken later.\n\nedit: fwiw i'm using the helm chart","createdAt":"2025-03-21T14:50:07Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3383#issuecomment-2743595025","viewerDidAuthor":false}],"createdAt":"2022-09-14T20:15:35Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":3383,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":4}}],"state":"OPEN","title":"Schema name selection for postgres","updatedAt":"2025-03-21T14:52:59Z","url":"https://github.com/temporalio/temporal/issues/3383"}
