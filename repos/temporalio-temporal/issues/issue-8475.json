{"assignees":[{"id":"MDQ6VXNlcjIwNjgxMjQ=","login":"rodrigozhou","name":"Rodrigo Zhou","databaseId":0}],"author":{"id":"MDQ6VXNlcjU0MDM2OTg5","is_bot":false,"login":"HoangViet144","name":"Trần Hoàng Việt"},"body":"I am using Mysql for Visibility store with enabling advanced search attribute\n\nWhenever a workflow is running, it creates a query like this:\n```\nINSERT INTO custom_search_attributes (\n\t\t\tnamespace_id, run_id, search_attributes, _version\n\t\t) VALUES ('4989d4b2-6814-470f-b7b4-012a3b869e6b', '0198113a-fcea-76e8-b4bc-903066f4a063', '{\\\"BuildIds\\\":[\\\"unversioned\\\",\\\"unversioned:356c8c9a4707f996228198f1b1f61fd2\\\",\\\"unversioned:e3c4e67c302df47dfb7607478e82e839\\\",\\\"unversioned:2c3743053e73629030f82ac06f7821bc\\\"],\\\"TemporalNamespaceDivision\\\":\\\"TemporalScheduler\\\",\\\"TemporalSchedulePaused\\\":false}', 119579357) **ON DUPLICATE KEY UPDATE** search_attributes = IF(_version < VALUES(_version), VALUES(search_attributes), search_attributes), _version = IF(_version < VALUES(_version), VALUES(_version), _version)\n```\nHowever, after reaching 30 million records in custom_search_attributes table, the lock for each insert is very large, which impacts the overall of mysql instance. Mysql crashed with this log: \n```\nInnoDB: ###### Diagnostic info printed to the standard error stream\n2017-11-16T13:18:39.650036Z 0 [ERROR] [FATAL] InnoDB: Semaphore wait has lasted > 600 seconds. We intentionally crash the server because it appears to be hung\n```\n## Expected Behavior\nCustom search attribute for mysql should not have very large lock and cause mysql to crash\n\n## Actual Behavior\nWhen  number of records is over 30 million, each insert into custom_search_attributes run really slow with high lock time\n\n## Specifications\n\n  - Version: 1.28.1\n  - Platform: self host on K8S\n","closedAt":"2025-10-21T11:51:20Z","comments":[{"id":"IC_kwDODNqesM7MBrTT","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"Is it only the `custom_search_attributes` table that is locking? This table is supposed to have the same number of rows as the main table `executions_visibility`. Could you check this?\n\nBesides this, maybe you've reached the limits of MySQL and need a scaling strategy (eg: sharding the data, Vitess perhaps), or migrate to Elasticsearch.","createdAt":"2025-10-20T17:03:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8475#issuecomment-3422991571","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7MN9CM","author":{"login":"HoangViet144"},"authorAssociation":"NONE","body":"Yes, both table have the same row, but only custom_search_attributes holds the lock too long. btw, I also believe that I have hit MySQL limit. My temporal and my database are ok after having migrated visibility store to ElasticSearch. \nMaybe insert ... on duplicate key update is not good for large table","createdAt":"2025-10-21T11:51:20Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/8475#issuecomment-3426209932","viewerDidAuthor":false}],"createdAt":"2025-10-11T02:44:43Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":8475,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"High mysql lock when enabling custom search attribute with large number of workflow","updatedAt":"2025-10-21T11:52:05Z","url":"https://github.com/temporalio/temporal/issues/8475"}
