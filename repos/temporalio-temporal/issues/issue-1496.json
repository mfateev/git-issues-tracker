{"assignees":[{"id":"MDQ6VXNlcjk1NjM=","login":"robholland","name":"Rob Holland","databaseId":0},{"id":"MDQ6VXNlcjIyMzI1MjQ=","login":"alexshtin","name":"Alex Shtin","databaseId":0},{"id":"MDQ6VXNlcjg3NjI4OTM=","login":"wxing1292","name":"Wenquan Xing","databaseId":0}],"author":{"id":"MDQ6VXNlcjMyMTQ1NjUy","is_bot":false,"login":"junjieli1","name":"Junjie Li"},"body":"**Is your feature request related to a problem? Please describe.**\r\nWe need some namespace level authorization. The best bet currently is https://github.com/temporalio/temporal/blob/release/v1.8.x/cmd/server/main.go#L154. However, we'd have to implement our authorizer in temporal's repo and build the docker image from that.\r\n\r\n**Describe the solution you'd like**\r\nIdeally, as a customer, we don't have to build our own image. We can just use images like temporalio/auto-setup:1.8.2 and inject or plug in our own implementation of the authorizer somehow.\r\n\r\n**Describe alternatives you've considered**\r\nWe're currently modifying temporal open source project and build our own image.\r\n\r\n**Additional context**\r\n\r\n","closedAt":"2021-05-19T00:42:46Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDgyNzI0NjE4Mw==","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"Instead of modifying Temporal code, have you looked at using server options as shown in the [extensibility/authorizer sample](https://github.com/temporalio/customization-samples/tree/master/extensibility/authorizer)?","createdAt":"2021-04-27T01:39:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1496#issuecomment-827246183","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgyNzc1MTEwMQ==","author":{"login":"junjieli1"},"authorAssociation":"NONE","body":"HI @sergeybykov, yes. However, I assume your sample still require the users to compile our own image right? We currently just use the image \"temporalio/auto-setup:1.8.2\" and I couldn't figure out where to put [this](https://github.com/temporalio/customization-samples/blob/master/extensibility/authorizer/server/main.go#L51) without touching the compiled auto-setup image. ","createdAt":"2021-04-27T16:41:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1496#issuecomment-827751101","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgyNzc2MzYxMg==","author":{"login":"robholland"},"authorAssociation":"MEMBER","body":"We are adding go-plugin support to tctl to help with this kind of issue. I'm not convinced about adding such things to the server though due to the performance and reliability implications of having to hit these interfaces over net/RPC or GRPC as they are out of the main process.","createdAt":"2021-04-27T17:00:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1496#issuecomment-827763612","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgyNzgyODI4Nw==","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"@junjieli1 Yes, this approach does require customers to build their own images. This is caused by the limitation of Go with regards to loadable modules. As @robholland mentioned, Go plugins don't strike us as a good mechanism for this, especially considering that authorizer is invoked on the hot path.\r\n\r\nFor this reason, our extensibility story is based on the [mechanism of server options](https://docs.temporal.io/docs/server/options/). It does require building your own images, but that's only way we found to provide the flexibility of customizing Temporal Server.","createdAt":"2021-04-27T18:35:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1496#issuecomment-827828287","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgyNzg1MDgzMQ==","author":{"login":"junjieli1"},"authorAssociation":"NONE","body":"I see. This is basically what I'm doing now. Create my own Authorizer and feed to this [line](https://github.com/temporalio/temporal/blob/master/cmd/server/main.go#L154). Then build the auto-start image. The thing is we didn't want to own the process of maintaining our own clone, pulling update from upstream periodically, building our own image, and then releasing. I will take it though if this is the best shot we have. Let me know if the story changes. Thanks! ","createdAt":"2021-04-27T19:11:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1496#issuecomment-827850831","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgyNzg3NjQ3NQ==","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"I just want to be clear with terminology here. This approach doesn't require you to have a clone/fork of Temporal repo. In fact, it allowed some of our users to move away from forking Temporal code for customization. Instead, you reference Temporal as an upstream dependency and control which version you use, like with any other Go dependency (as in the [sample](https://github.com/temporalio/customization-samples/blob/8e769938d1814bede2499df48cdaa9e1d3d93a32/extensibility/go.mod#L10)).\r\n\r\nWe expect many if not most production users to leverage the server options approach eventually because everyone seems to need some level of customization, which is impossible to get with stock docker images.","createdAt":"2021-04-27T19:43:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1496#issuecomment-827876475","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgyNzk0MTEyNQ==","author":{"login":"junjieli1"},"authorAssociation":"NONE","body":"Ah I see. Then I need to build an image that wraps around the server starting code? Currently, we use the auto-start image (temporalio/auto-setup:1.8.2). Is there any instruction/example/suggestion on how to build a similar image with this customized server starting code so that I can just replace the `temporalio/auto-setup:1.8.2` with my own image without changing anything else? I'm mainly concerned about missing some configurations that exist in the auto-setup image but not in my customized image.","createdAt":"2021-04-27T21:24:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1496#issuecomment-827941125","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgyODAwMjQ3OA==","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"You can build a layer on top our image, copy your server binary, and replace [start-temporal.sh](https://github.com/temporalio/temporal/blob/master/docker/start-temporal.sh) with your version. We are looking to add a sample dockerfile for this exact use case after a minor refactoring very soon. /cc @alexshtin  ","createdAt":"2021-04-27T23:01:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1496#issuecomment-828002478","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgyODAyOTQyOA==","author":{"login":"junjieli1"},"authorAssociation":"NONE","body":"Nice! Can't wait to see the sample dockerfile! I think authZ is an import topic in any application. So this solution should benefit a lot of people.","createdAt":"2021-04-27T23:47:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":2}}],"url":"https://github.com/temporalio/temporal/issues/1496#issuecomment-828029428","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg0MzYyNTA4Mg==","author":{"login":"junjieli1"},"authorAssociation":"NONE","body":"Reporting back, I'm able to create my customized Authorizer and replace the temporal server binary in the auto-start image with my own temporal server binary that has the customized Authorizer.\r\n\r\nMy dockerfile:\r\n```\r\n##### Temporal builder #####\r\nFROM temporalio/base-builder:1.0.0 AS temporal-builder\r\nWORKDIR /mycompany-temporal-image\r\nCOPY . .\r\nRUN make bins\r\nFROM temporalio/auto-setup:1.9.2\r\nWORKDIR /etc/temporal\r\nCOPY --from=temporal-builder  /mycompany-temporal-image/temporal-server /usr/local/bin/temporal-server\r\n```\r\n\r\nMy makefile:\r\n```\r\nbins:\r\n    CGO_ENABLED=0 go build -o temporal-server cmd/main.go \r\n```\r\n\r\nMy cmd/main.go code\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"github.mycompany/authorizer\"\r\n\t\"go.temporal.io/server/common/dynamicconfig\"\r\n\ttlog \"go.temporal.io/server/common/log\"\r\n\t\"go.temporal.io/server/common/log/tag\"\r\n\t_ \"go.temporal.io/server/common/persistence/sql/sqlplugin/mysql\"      // needed to load mysql plugin\r\n\t\"log\"\r\n\r\n\t\"go.temporal.io/server/common/config\"\r\n\t\"go.temporal.io/server/temporal\"\r\n)\r\n\r\nfunc main(){\r\n\r\n\tcfg, err := config.LoadConfig(\"docker\", \"./config\", \"\")\r\n\tif err != nil {\r\n\t\tlog.Fatal(err)\r\n\t}\r\n\r\n\tlogger := tlog.NewZapLogger(tlog.BuildZapLogger(cfg.Log))\r\n\tdynamicConfigClient, err := dynamicconfig.NewFileBasedClient(&cfg.DynamicConfigClient, logger, temporal.InterruptCh())\r\n\tif err != nil {\r\n\t\tlogger.Info(\"Unable to create file based dynamic config client, use no-op config client instead.\", tag.Error(err))\r\n\t\tdynamicConfigClient = dynamicconfig.NewNoopClient()\r\n\t}\r\n\r\n\ts := temporal.NewServer(\r\n\t\ttemporal.ForServices(temporal.Services),\r\n\t\ttemporal.WithConfig(cfg),\r\n\t\ttemporal.WithDynamicConfigClient(dynamicConfigClient),\r\n\t\ttemporal.WithLogger(logger),\r\n\t\ttemporal.InterruptOn(temporal.InterruptCh()),\r\n\t\ttemporal.WithAuthorizer(authorizer.NewMyOwnMeshAuthorizer()),\r\n\t)\r\n\r\n\tlogger.Info(\"Going to start Temporal server...\")\r\n\terr = s.Start()\r\n\tif err != nil{\r\n\t\tlog.Fatal(err)\r\n\t}\r\n\r\n\tlogger.Info(\"All services are stopped.\")\r\n} \r\n```\r\n\r\nOf course, in the go.mod file, you need to pin `go.temporal.io/server v1.9.2` to match with the auto-start image.","createdAt":"2021-05-18T23:08:38Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/1496#issuecomment-843625082","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg0MzY0ODg4Mg==","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"@junjieli1 Great! Can we close this issue now?","createdAt":"2021-05-19T00:12:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1496#issuecomment-843648882","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg0MzY1OTg5OQ==","author":{"login":"junjieli1"},"authorAssociation":"NONE","body":"Yeah we can close it now","createdAt":"2021-05-19T00:42:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/1496#issuecomment-843659899","viewerDidAuthor":false}],"createdAt":"2021-04-26T23:44:54Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwyODE3MDk3ODQ0","name":"planning","description":"","color":"006b75"}],"milestone":null,"number":1496,"reactionGroups":[],"state":"CLOSED","title":"Inject or plug in a customized Authorizer without having to build the temporal image by users","updatedAt":"2021-05-19T00:42:46Z","url":"https://github.com/temporalio/temporal/issues/1496"}
