{"assignees":[{"id":"MDQ6VXNlcjg3NjI4OTM=","login":"wxing1292","name":"Wenquan Xing","databaseId":0}],"author":{"id":"MDQ6VXNlcjE5ODY5NTA=","is_bot":false,"login":"paymog","name":"Paymahn Moghadasian"},"body":"## Expected Behavior\r\nI expect the temporal server to startup when running in GKE and using the GCP Cloud SQL Proxy \r\n\r\n## Actual Behavior\r\nThe temporal server hangs forever waiting for postgres to be available.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n1. Set up a kubernetes cluster in GKE\r\n2. Set up a Cloud SQL instance in GCP\r\n3. Run the `temporalio/auto-setup:1.8.1` image in GKE with a cloud sql side car. Make sure you set the env var `DB_ADDRESS` to `127.0.0.1` when running this deployment\r\n4. Observe that if you tail the logs of the temporal pods you'll see them stuck with\r\n\r\n```\r\n+ echo 'waiting for postgresql to start up'\r\n+ sleep 1\r\n+ nc -z 5432\r\n```\r\n\r\n5. `kubectl exec` into the temporal pod\r\n6. Run `nc -z localhost:5432` and see that it returns immediately\r\n7. Run `nc -z 127.0.0.1:5432` and see that it returns immediately\r\n8.  Run `nc -z 5432` and notice it hangs, just like in the temporal startup script\r\n\r\n## Specifications\r\n\r\n  - Version: 1.8.1\r\n  - Platform: I believe the auto-setup 1.8.1 image runs on alpine linux\r\n","closedAt":"2021-06-09T21:26:36Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDgxNzE0MjI2Mg==","author":{"login":"paymog"},"authorAssociation":"NONE","body":"Ah, looks like I need to set `POSTGRES_SEEDS` to `localhost` for this to work: https://github.com/temporalio/temporal/blob/30c89b9f91dafc13d2d75fda266d81ce8bc72f3e/docker/start.sh#L133","createdAt":"2021-04-10T14:07:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1451#issuecomment-817142262","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgxNzE0NTQyMQ==","author":{"login":"paymog"},"authorAssociation":"NONE","body":"Setting the postgres seed fixed this. It's confusing that `DB_ADDRESS` doesn't work. https://github.com/temporalio/temporal/blob/30c89b9f91dafc13d2d75fda266d81ce8bc72f3e/tools/cli/flags.go#L38","createdAt":"2021-04-10T14:29:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1451#issuecomment-817145421","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgyMTcyMDg2Mg==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"\"db_address\"  is used by CLI, not server, server use `POSTGRES_SEEDS`\r\n\r\nref: \r\nhttps://github.com/temporalio/temporal/blob/v1.8.1/docker/config_template.yaml\r\nhttps://github.com/temporalio/temporal/blob/v1.8.1/docker/start-temporal.sh#L5","createdAt":"2021-04-16T23:24:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1451#issuecomment-821720862","viewerDidAuthor":false}],"createdAt":"2021-04-10T13:59:10Z","labels":[{"id":"MDU6TGFiZWwyMDE5OTA0OTIw","name":"discussion","description":"","color":"3ffcb0"},{"id":"MDU6TGFiZWwyNzcwMzY2NzYw","name":"close-after-30-days","description":"","color":"1d76db"}],"milestone":null,"number":1451,"reactionGroups":[],"state":"CLOSED","title":"Temporal Hangs Indefinitely When Use GCP Cloud SQL Sidecar Proxy","updatedAt":"2021-06-09T21:26:36Z","url":"https://github.com/temporalio/temporal/issues/1451"}
