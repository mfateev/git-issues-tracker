{"assignees":[],"author":{"id":"MDQ6VXNlcjE2NTAxNzAy","is_bot":false,"login":"sp13ceg","name":"Shanmugaprabhu"},"body":"## Expected Behavior\r\nWe get frequent errors in temporal, when this happens we see a considerable delay in creating child workflows.\r\n\r\n```\r\nAppendHistoryNodes: expected 1 row to be affected for node table, got 2\",\"metric-scope\":4,\"logging-call-at\":\"persistenceMetricClients.go:640\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\r\n\t/temporal/common/log/zap_logger.go:143\r\ngo.temporal.io/server/common/persistence.(*executionPersistenceClient).updateErrorMetric\r\n\t/temporal/common/persistence/persistenceMetricClients.go:640\r\ngo.temporal.io/server/common/persistence.(*executionPersistenceClient).CreateWorkflowExecution\r\n\t/temporal/common/persistence/persistenceMetricClients.go:215\r\ngo.temporal.io/server/service/history/shard.(*ContextImpl).CreateWorkflowExecution\r\n\t/temporal/service/history/shard/context_impl.go:442\r\ngo.temporal.io/server/service/history/workflow.createWorkflowExecutionWithRetry.func1\r\n\t/temporal/service/history/workflow/transaction_impl.go:306\r\ngo.temporal.io/server/common/backoff.Retry.func1\r\n\t/temporal/common/backoff/retry.go:104\r\ngo.temporal.io/server/common/backoff.RetryContext\r\n\t/temporal/common/backoff/retry.go:125\r\ngo.temporal.io/server/common/backoff.Retry\r\n\t/temporal/common/backoff/retry.go:105\r\ngo.temporal.io/server/service/history/workflow.createWorkflowExecutionWithRetry\r\n\t/temporal/service/history/workflow/transaction_impl.go:310\r\ngo.temporal.io/server/service/history/workflow.(*ContextImpl).CreateWorkflowExecution\r\n\t/temporal/service/history/workflow/context.go:439\r\ngo.temporal.io/server/service/history.(*historyEngineImpl).StartWorkflowExecution\r\n\t/temporal/service/history/historyEngine.go:575\r\ngo.temporal.io/server/service/history.(*Handler).StartWorkflowExecution\r\n\t/temporal/service/history/handler.go:551\r\ngo.temporal.io/server/api/historyservice/v1._HistoryService_StartWorkflowExecution_Handler.func1\r\n\t/temporal/api/historyservice/v1/service.pb.go:861\r\ngo.temporal.io/server/common/rpc/interceptor.(*RateLimitInterceptor).Intercept\r\n\t/temporal/common/rpc/interceptor/rate_limit.go:83\r\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\r\n\t/go/pkg/mod/google.golang.org/grpc@v1.39.0/server.go:1133\r\ngo.temporal.io/server/common/rpc/interceptor.(*TelemetryInterceptor).Intercept\r\n\t/temporal/common/rpc/interceptor/telemetry.go:108\r\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\r\n\t/go/pkg/mod/google.golang.org/grpc@v1.39.0/server.go:1133\r\ngo.temporal.io/server/common/metrics.NewServerMetricsTrailerPropagatorInterceptor.func1\r\n\t/temporal/common/metrics/grpc.go:113\r\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\r\n\t/go/pkg/mod/google.golang.org/grpc@v1.39.0/server.go:1133\r\ngo.temporal.io/server/common/metrics.NewServerMetricsContextInjectorInterceptor.func1\r\n\t/temporal/common/metrics/grpc.go:66\r\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\r\n\t/go/pkg/mod/google.golang.org/grpc@v1.39.0/server.go:1133\r\ngo.temporal.io/server/common/rpc.ServiceErrorInterceptor\r\n\t/temporal/common/rpc/grpc.go:131\r\ngoogle.golang.org/grpc.chainUnaryServerInterceptors.func1\r\n\t/go/pkg/mod/google.golang.org/grpc@v1.39.0/server.go:1119\r\ngo.temporal.io/server/api/historyservice/v1._HistoryService_StartWorkflowExecution_Handler\r\n\t/temporal/api/historyservice/v1/service.pb.go:863\r\ngoogle.golang.org/grpc.(*Server).processUnaryRPC\r\n\t/go/pkg/mod/google.golang.org/grpc@v1.39.0/server.go:1292\r\ngoogle.golang.org/grpc.(*Server).handleStream\r\n\t/go/pkg/mod/google.golang.org/grpc@v1.39.0/server.go:1617\r\ngoogle.golang.org/grpc.(*Server).serveStreams.func1.2\r\n\t/go/pkg/mod/google.golang.org/grpc@v1.39.0/server.go:940\r\n```\r\n\r\n## Actual Behavior\r\n\r\nAnd the error seems to be coming from [here](https://github.com/temporalio/temporal/blob/14ed6a8f720fdc675955a5692c35ce6996368239/common/persistence/sql/history_store.go#L104)\r\n\r\n```\r\nif rowsAffected != 1 {\r\n    return fmt.Errorf(\"expected 1 row to be affected for node table, got %v\", rowsAffected)\r\n}\r\n```\r\n\r\nCorresponding insert statement is [this](https://github.com/temporalio/temporal/blob/14ed6a8f720fdc675955a5692c35ce6996368239/common/persistence/sql/sqlplugin/mysql/events.go#L36)\r\n\r\n```\r\n\t\tINSERT INTO history_node (...)\r\n\t\tON DUPLICATE KEY UPDATE (...) (...)\r\n```\r\n\r\nThis particular statement can affect 2 rows at the max. But the check above was `if rowsAffected != 1` which seems to be causing the issue\r\n\r\nI cloned temporal, changed the if check to if `rowsAffected > 2` and the issue got fixed. I donâ€™t see the errors any more.\r\n\r\nCould this be a bug ?\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nThis is happens in our workflow code with business logic. I am not sure exactly what code is causing the issue, but I am not able to reproduce it with a simple example.\r\n\r\n## Specifications\r\n\r\n  - Version: 1.14.3\r\n  - Platform: MacOS docker-compose\r\n","closedAt":"2022-01-24T20:55:55Z","comments":[{"id":"IC_kwDODNqesM481JwZ","author":{"login":"sp13ceg"},"authorAssociation":"NONE","body":"Thanks for the super fast update. Just curious - what kind of set up can cause this issue ? I was never able to reproduce with a simple example.","createdAt":"2022-01-24T21:28:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2408#issuecomment-1020566553","viewerDidAuthor":false}],"createdAt":"2022-01-24T16:28:21Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":2408,"reactionGroups":[],"state":"CLOSED","title":"Temporal Mysql bug","updatedAt":"2022-01-24T21:28:53Z","url":"https://github.com/temporalio/temporal/issues/2408"}
