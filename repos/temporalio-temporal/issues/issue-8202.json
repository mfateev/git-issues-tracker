{"assignees":[],"author":{"id":"MDQ6VXNlcjQ4MDg0MTE3","is_bot":false,"login":"aunjaffery","name":"AunOx"},"body":"## Expected Behavior\n\n\n## Actual Behavior\nI'm using temporal on my GKE cluster. with following values. it works perfectly but i have an issue. whenever there is an gke update and node gets replaced. temporal crashes and goes in CrashLoopBackOff and cannot recover. complains about no usable database connection. I have to manual redeploy with helm.\n```\nserver:\n  config:\n    namespaces:\n      create: true\n      namespace:\n        - name: default\n          retention: 1d\n    persistence:\n      default:\n        driver: \"sql\"\n        sql:\n          driver: \"postgres12\"\n          host: my-postgresql.microservices.svc.cluster.local\n          port: 5432\n          database: temporal\n          user: postgres\n          password: \"mypass\"\n          maxConns: 20\n          maxIdleConns: 20\n          maxConnLifetime: \"1h\"\n      visibility:\n        driver: \"sql\"\n\n        sql:\n          driver: \"postgres12\"\n          host: my-postgresql.microservices.svc.cluster.local\n          port: 5432\n          database: temporal_visibility\n          user: postgres\n          password: \"mypass\"\n          maxConns: 20\n          maxIdleConns: 20\n          maxConnLifetime: \"1h\"\ncassandra:\n  enabled: false\n\nmysql:\n  enabled: false\n\npostgresql:\n  enabled: true\n\nprometheus:\n  enabled: false\n\ngrafana:\n  enabled: false\n\nelasticsearch:\n  enabled: false\n\nschema:\n  createDatabase:\n    enabled: true\n  setup:\n    enabled: true\n  update:\n    enabled: true\n```\n\n## Specifications\n\n  - Version: temporal-0.65.0\n  - App-Version: 1.28.1\n  - Platform: GKE\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM7IfD0L","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Sorry for the delayed response. We are looking into it but no timeline for when we would be able to properly investigate.","createdAt":"2025-10-02T23:19:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8202#issuecomment-3363585291","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7SZQ8x","author":{"login":"yycptt"},"authorAssociation":"MEMBER","body":"We have some connection [refresh](https://github.com/temporalio/temporal/blob/d59c5d7eb38f749e05044b937555dfc06f8407e6/common/persistence/sql/sqlplugin/db_handle.go#L165) logic implemented for certain error types returned from driver. \n\nI am guessing in this case the error returned is not recognized by the logic [here](https://github.com/temporalio/temporal/blob/d59c5d7eb38f749e05044b937555dfc06f8407e6/common/persistence/sql/sqlplugin/postgresql/driver/interface.go#L26) so didn't trigger the refresh and requires a service deployment/restart to re-establish the connection.  \n\nAre you able to access server logs and see what's error returned when the update happens? Also see if there's any warn/error message that starts with `sql handle: `","createdAt":"2025-11-13T21:43:49Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8202#issuecomment-3529838385","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7SZV0F","author":{"login":"aunjaffery"},"authorAssociation":"NONE","body":"Because of this crash problem, I had GKE auto-upgrade tuned off. I saved the error in my notes.\n```\n[Fx] Error returned: received non-nil error from function \"go.temporal.io/server/temporal\".ServerOptionsProvider                                                                                                 │\n│     /home/runner/work/docker-builds/docker-builds/temporal/temporal/fx.go:182:                                                                                                                                   │\n│ sql schema version compatibility check failed: unable to read DB schema version keyspace/database: temporal error: no usable database connection found                                                           │\n│ [Fx] ERROR        Failed to initialize custom logger: could not build arguments for function \"go.uber.org/fx\".(*module).constructCustomLogger.func2                                                              │\n│     /home/runner/go/pkg/mod/go.uber.org/fx@v1.23.0/module.go:294:                                                                                                                                                │\n│ failed to build fxevent.Logger:                                                                                                                                                                                  │\n│ could not build arguments for function \"go.temporal.io/server/temporal\".init.func7                                                                                                                               │\n│     /home/runner/work/docker-builds/docker-builds/temporal/temporal/fx.go:1008:                                                                                                                                  │\n│ failed to build log.Logger:                                                                                                                                                                                      │\n│ received non-nil error from function \"go.temporal.io/server/temporal\".ServerOptionsProvider                                                                                                                      │\n│     /home/runner/work/docker-builds/docker-builds/temporal/temporal/fx.go:182:                                                                                                                                   │\n│ sql schema version compatibility check failed: unable to read DB schema version keyspace/database: temporal error: no usable database connection found                                                           │\n│ Unable to create server. Error: could not build arguments for function \"go.uber.org/fx\".(*module).constructCustomLogger.func2 (/home/runner/go/pkg/mod/go.uber.org/fx@v1.23.0/module.go:294): failed to build fx │\n│ stream closed EOF for microservices/temporaltest-worker-656b4fbbb5-kl6tx (temporal-worker)\n```","createdAt":"2025-11-13T21:51:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8202#issuecomment-3529858309","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7ZMz4i","author":{"login":"gow"},"authorAssociation":"MEMBER","body":"This was closed by mistake (due to a faulty integration). Reopening it.","createdAt":"2025-12-11T22:15:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8202#issuecomment-3644014114","viewerDidAuthor":false}],"createdAt":"2025-08-17T13:35:31Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":8202,"reactionGroups":[],"state":"OPEN","title":"CrashLoopBackOff on GKE cluster.","updatedAt":"2025-12-11T22:15:20Z","url":"https://github.com/temporalio/temporal/issues/8202"}
