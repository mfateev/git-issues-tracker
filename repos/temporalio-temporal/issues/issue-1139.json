{"assignees":[],"author":{"id":"MDQ6VXNlcjM2NTYxMQ==","is_bot":false,"login":"shaunco","name":"Shaun"},"body":"## Expected Behavior\r\nWhen an activity is retried, the `deadline` value in the activity environment should reflect the start time of the retry attempt + StartToCloseTimeout.\r\n\r\n## Actual Behavior\r\nWhen an activity is retried, the `deadline` value in the activity environment is still the original activity execution time + StartToCloseTimeout.\r\n\r\nNothing changed in the go-sdk (still 1.2.0), and this deadline value comes from Temporal server. Additionally, this worked fine in 1.3.2 but is broken in 1.5.0.\r\n\r\nWhile I can ignore it and just use context.Background(), it seems the deadline in this context should be correct.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. While the worker is in a debugger, set a breakpoint at the start of an activity\r\n  1. Have a workflow execute an activity\r\n  1. Terminate the worker\r\n  1. Wait a few minutes (or until StartToCloseTimeout has passed)\r\n  1. Restart the worker in the debugger, with the same activity breakpoint\r\n  1. Note that ctx is immediately past its deadline by checking `ctx.Err()`, which will return `context deadline exceeded`\r\n\r\n## Specifications\r\n\r\n  - Version: 1.5.0  (was working fine in 1.3.2)\r\n  - Platform: Ubuntu / go-sdk\r\n","closedAt":"2020-12-30T00:34:07Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDc1MjIzNjE2MQ==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"@shaunco \r\n\r\nCan you please provide the activity timeout settings?","createdAt":"2020-12-29T20:47:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1139#issuecomment-752236161","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1MjIzNzgxNw==","author":{"login":"shaunco"},"authorAssociation":"NONE","body":"They are the defaults I copied from https://docs.temporal.io/docs/go-run-your-first-app/#the-workflow-function as I've yet to have a need to make them different.\r\n\r\n```go\r\n    // RetryPolicy specifies how to automatically handle retries if an Activity fails.\r\n    retrypolicy := &temporal.RetryPolicy{\r\n        InitialInterval:    time.Second,\r\n        BackoffCoefficient: 2.0,\r\n        MaximumInterval:    time.Minute,\r\n        MaximumAttempts:    500,\r\n    }\r\n    options := workflow.ActivityOptions{\r\n        // Timeout options specify when to automatically timeout Actvitivy functions.\r\n        StartToCloseTimeout: time.Minute,\r\n        // Optionally provide a customized RetryPolicy.\r\n        // Temporal retries failures by default, this is just an example.\r\n        RetryPolicy: retrypolicy,\r\n    }\r\n```","createdAt":"2020-12-29T20:53:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1139#issuecomment-752237817","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1MjI1MDYxNw==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"@shaunco\r\n\r\nseems that i cannot repo the issue, let us sync in slack (Wenquan Xing)\r\n\r\nactivity config\r\n```go\r\nretryPolicy := &temporal.RetryPolicy{\r\n\tInitialInterval:    time.Second,\r\n\tBackoffCoefficient: 2.0,\r\n\tMaximumInterval:    time.Minute,\r\n\tMaximumAttempts:    500,\r\n}\r\nactivityCtx := workflow.WithActivityOptions(ctx, workflow.ActivityOptions{\r\n\tTaskQueue:              taskQueueName,\r\n\tStartToCloseTimeout:    time.Minute,\r\n\tRetryPolicy:            retryPolicy,\r\n})\r\n```\r\n\r\nactivity function\r\n```go\r\nfunc retryOnTimeoutActivity(ctx context.Context, scheduledTimeNanos int64) (int, error) {\r\n\r\n\tfmt.Print(\"#### \")\r\n\tdeadline, ok := ctx.Deadline()\r\n\tfmt.Printf(\"%v-%v\\n\", deadline, ok)\r\n\tfmt.Print(\"#### \")\r\n\r\n\treturn 0, errors.New(\"123\")\r\n}\r\n```\r\n\r\n```\r\n#### 2020-12-29 21:32:24.744947 +0000 UTC-true\r\n#### 2020-12-29 21:32:25.754631 +0000 UTC-true\r\n#### 2020-12-29 21:32:27.765819 +0000 UTC-true\r\n#### 2020-12-29 21:32:31.773322 +0000 UTC-true\r\n#### 2020-12-29 21:32:39.783182 +0000 UTC-true\r\n#### 2020-12-29 21:32:54.757266 +0000 UTC-true\r\n#### 2020-12-29 21:32:55.766048 +0000 UTC-true\r\n#### 2020-12-29 21:32:55.793084 +0000 UTC-true\r\n#### 2020-12-29 21:32:57.781462 +0000 UTC-true\r\n#### 2020-12-29 21:33:01.790029 +0000 UTC-true\r\n#### 2020-12-29 21:33:09.800278 +0000 UTC-true\r\n```","createdAt":"2020-12-29T21:39:08Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1139#issuecomment-752250617","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1MjI1NjQwNA==","author":{"login":"shaunco"},"authorAssociation":"NONE","body":"On my side the retry executions land in https://github.com/temporalio/sdk-go/blame/56a1a18c4db896e1a8d4fe4dbf95eb97131fc01f/internal/activity.go#L264 ... which was added 19 days ago. It looks like [`task.GetScheduledTime()`](https://github.com/temporalio/sdk-go/blob/56a1a18c4db896e1a8d4fe4dbf95eb97131fc01f/internal/activity.go#L253) is the value that never changes, so even though I never set a `ScheduleToCloseTimeout` it seems to be set to 60 seconds.\r\n\r\nTry letting your retry task execute again >60 seconds later to see if you end up in the \"minimum of two deadlines\" code that was added.","createdAt":"2020-12-29T22:03:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1139#issuecomment-752256404","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1MjI3NTU5Mw==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"thanks for reporting: #1141 ","createdAt":"2020-12-29T23:31:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":2}}],"url":"https://github.com/temporalio/temporal/issues/1139#issuecomment-752275593","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1MjI3NjU1OA==","author":{"login":"shaunco"},"authorAssociation":"NONE","body":"Awesome! Thank you!","createdAt":"2020-12-29T23:37:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1139#issuecomment-752276558","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1MjI5ODIzOA==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"please use the patch release https://github.com/temporalio/temporal/releases/tag/v1.5.1","createdAt":"2020-12-30T01:44:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/1139#issuecomment-752298238","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1MjMwNDQ2Nw==","author":{"login":"shaunco"},"authorAssociation":"NONE","body":"Confirmed fixed in 1.5.1\r\n\r\nThanks for the amazingly fast turn around!","createdAt":"2020-12-30T02:24:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1139#issuecomment-752304467","viewerDidAuthor":false}],"createdAt":"2020-12-29T19:59:50Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":1139,"reactionGroups":[],"state":"CLOSED","title":"Activity environment deadline is not updated for activity retries","updatedAt":"2020-12-30T02:24:52Z","url":"https://github.com/temporalio/temporal/issues/1139"}
