{"assignees":[{"id":"MDQ6VXNlcjE3NjY1MTU=","login":"samarabbas","name":"Samar Abbas","databaseId":0}],"author":{"id":"MDQ6VXNlcjE0NjM2MjI=","is_bot":false,"login":"mfateev","name":"Maxim Fateev"},"body":"**Is your feature request related to a problem? Please describe.**\r\nOnce an activity or workflow task is scheduled its task queue name is fixed. In many cases for development/troubleshooting and other scenarios ability to route all or subset of tasks to a different task queue can be very useful. See this @robzienert [forum post](https://community.temporal.io/t/using-dynamic-task-queues-for-traffic-routing/3045) for some usage examples.\r\n\r\n**Describe the solution you'd like**\r\nAdd API to manage routing rules that forward tasks to other queues.\r\n\r\n**Describe alternatives you've considered**\r\nUse SDK library as described by @robzienert  in his post.\r\n\r\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM43aLMc","author":{"login":"Multiply"},"authorAssociation":"NONE","body":"We'd be very interested in this, assuming it hits the go-sdk.\r\n\r\nOur primary headache is running all microservices locally, and we've been trying various solutions to intercept traffic and route it to local environments.\r\nThis feature could solve that to some degree, at least for the things running inside Temporal.","createdAt":"2021-09-28T20:40:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1988#issuecomment-929608476","viewerDidAuthor":false},{"id":"IC_kwDODNqesM44Dx8p","author":{"login":"jlegrone"},"authorAssociation":"CONTRIBUTOR","body":"We've written some tooling to propagate request-scoped routing rules that allow targeting new task queues for child workflows or activities, including when these are deeply nested in the call stack. This approach is heavily inspired by Envoy's [http routing rules](https://www.envoyproxy.io/docs/envoy/latest/intro/arch_overview/http/http_routing).\r\n\r\nRight now we use this technique primarily to support local dev in a shared Temporal cluster. Developers start a version of the worker they're making changes to locally, register this worker on a unique task queue, then make requests with routing rules on the context which target their new worker version.\r\n\r\nI think this approach is complementary to the one described by Rob, as we also have use cases that require writing code to map task queues to worker topology based on the contents of the request or the client's environment. These rules are universally enforced and encoded in the worker/client binaries however, while request scoped routing rules allow targeted, last mile customization and support debugging without needing to deploy new worker versions.\r\n\r\nThis is something we've been considering open sourcing. Happy to go into more detail, but for now here's the API we're using to define routing rules. You'll see lots of reserved fields; we've considered use cases beyond modifying the task queue, including routing requests to a new workflow or activity type.\r\n\r\n```proto\r\nsyntax = \"proto3\";\r\n\r\npackage temporal.router.v1;\r\n\r\nmessage RoutingRule {\r\n    message StringMatchRule {\r\n        oneof match {\r\n            // Match full text of string\r\n            string exact = 1;\r\n            // Match if string has prefix\r\n            string prefix = 2;\r\n        }\r\n    }\r\n    message MatchCondition {\r\n        // Temporal task queue. This is required.\r\n        StringMatchRule task_queue = 1;\r\n        // Temporal namespace. If unset, all namespaces will match.\r\n        reserved \"namespace\"; // not available for non-worker clients\r\n        // Other fields that apply to both workflows and activities\r\n        reserved 2 to 50;\r\n        // The workflow name (also referred to as workflow type)\r\n        reserved \"workflow_name\";\r\n        // Other fields that apply only to workflows\r\n        reserved 51 to 100;\r\n        // The activity name (also referred to as activity type)\r\n        reserved \"activity_name\";\r\n        // Other fields that apply only to activities\r\n        reserved 101 to 150;\r\n    }\r\n    message Destination {\r\n        // New task queue\r\n        string task_queue = 1;\r\n        reserved 2 to 50;\r\n        // New workflow name\r\n        reserved \"workflow_name\";\r\n        reserved 51 to 100;\r\n        // New activity name\r\n        reserved \"activity_name\";\r\n        reserved 101 to 150;\r\n    }\r\n    // A human-readable name for the routing rule. Useful for debugging.\r\n    string name = 1;\r\n    // A set of conditions that determine whether the rule should be applied. When multiple\r\n    // conditions are supplied, only one must match in order for the rule to apply.\r\n    repeated MatchCondition match = 2;\r\n    // A destination that determines how the request should be modified.\r\n    Destination destination = 3;\r\n    // A weight from 1-100 that represents the percentage of traffic to which this rule\r\n    // should be applied.\r\n    reserved \"runtime_weight\";\r\n}\r\n\r\nmessage RoutingRules {\r\n    // A list of rules that will be matched, in order, for outgoing requests.\r\n    // The first rule in the list which matches the request will be used.\r\n    repeated RoutingRule rules = 1;\r\n}\r\n```","createdAt":"2021-10-11T23:25:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":3}},{"content":"EYES","users":{"totalCount":2}}],"url":"https://github.com/temporalio/temporal/issues/1988#issuecomment-940515113","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6Ol3jY","author":{"login":"ikonst"},"authorAssociation":"NONE","body":"> Once an activity or workflow task is scheduled its task queue name is fixed.\r\n\r\n@robzienert's post was about routing when scheduling, not after scheduling (i.e, \"moving\" queues). Did you also mean routing when scheduling, or is this issue about something else?","createdAt":"2024-10-03T20:39:17Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1988#issuecomment-2392291544","viewerDidAuthor":false}],"createdAt":"2021-09-28T20:29:00Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1988,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":15}},{"content":"LAUGH","users":{"totalCount":1}},{"content":"HOORAY","users":{"totalCount":1}},{"content":"HEART","users":{"totalCount":2}},{"content":"ROCKET","users":{"totalCount":1}},{"content":"EYES","users":{"totalCount":1}}],"state":"OPEN","title":"Implement dynamic task queue routing","updatedAt":"2024-10-03T20:39:31Z","url":"https://github.com/temporalio/temporal/issues/1988"}
