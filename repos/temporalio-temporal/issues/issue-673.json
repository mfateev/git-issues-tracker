{"assignees":[{"id":"MDQ6VXNlcjIyMzI1MjQ=","login":"alexshtin","name":"Alex Shtin","databaseId":0}],"author":{"id":"MDQ6VXNlcjQ2MDczMjQ0","is_bot":false,"login":"MisterCodo","name":""},"body":"## Expected Behavior\r\n\r\nSet env variable PROMETHEUS_ENDPOINT and have working endpoints for all service roles.\r\n\r\n## Actual Behavior\r\n\r\nGetting some warning logs on launch, seem to be missing some metrics when scraping with Prometheus:\r\n\r\n```\r\n\"level\":\"warn\",\"ts\":\"2020-08-06T20:10:45.028Z\",\"msg\":\"error in prometheus reporter\",\"error\":\"listen tcp 0.0.0.0:9090: bind: address already in use\",\"logging-call-at\":\"metrics.go:135\"}\r\n\"level\":\"warn\",\"ts\":\"2020-08-06T20:10:45.087Z\",\"msg\":\"error in prometheus reporter\",\"error\":\"listen tcp 0.0.0.0:9090: bind: address already in use\",\"logging-call-at\":\"metrics.go:135\"}\r\n\"level\":\"warn\",\"ts\":\"2020-08-06T20:10:45.192Z\",\"msg\":\"error in prometheus reporter\",\"error\":\"listen tcp 0.0.0.0:9090: bind: address already in use\",\"logging-call-at\":\"metrics.go:135\"}\r\n\"level\":\"warn\",\"ts\":\"2020-08-06T20:10:45.481Z\",\"msg\":\"error in prometheus reporter\",\"error\":\"a previously registered descriptor with the same fully-qualified name as Desc{fqName: \\\"forwarded\\\", help: \\\"forwarded counter\\\", constLabels: {}, variableLabels: [operation]} has different label names or a different help string\",\"logging-call-at\":\"metrics.go:135\"}\r\n\"level\":\"warn\",\"ts\":\"2020-08-06T20:10:45.534Z\",\"msg\":\"error in prometheus reporter\",\"error\":\"a previously registered descriptor with the same fully-qualified name as Desc{fqName: \\\"forwarded\\\", help: \\\"forwarded counter\\\", constLabels: {}, variableLabels: [operation]} has different label names or a different help string\",\"logging-call-at\":\"metrics.go:135\"}\r\n\"level\":\"warn\",\"ts\":\"2020-08-06T20:10:49.293Z\",\"msg\":\"error in prometheus reporter\",\"error\":\"a previously registered descriptor with the same fully-qualified name as Desc{fqName: \\\"history_size\\\", help: \\\"history_size histogram\\\", constLabels: {}, variableLabels: [namespace stats_type operation]} has different label names or a different help string\",\"logging-call-at\":\"metrics.go:135\"}\r\n\"level\":\"warn\",\"ts\":\"2020-08-06T20:10:49.293Z\",\"msg\":\"error in prometheus reporter\",\"error\":\"a previously registered descriptor with the same fully-qualified name as Desc{fqName: \\\"history_size\\\", help: \\\"history_size histogram\\\", constLabels: {}, variableLabels: [stats_type operation namespace]} has different label names or a different help string\",\"logging-call-at\":\"metrics.go:135\"}\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Launch Temporal with following docker-compose file:\r\n\r\n```yaml\r\nversion: '3.7'\r\nservices:\r\n  postgres:\r\n    image: postgres:12.3\r\n    restart: unless-stopped\r\n    ports:\r\n      - '5432:5432'\r\n    environment:\r\n      POSTGRES_USER: temporal\r\n      POSTGRES_PASSWORD: placeholder\r\n    volumes:\r\n      - postgres-data-volume:/var/lib/postgresql/data\r\n  temporal-server:\r\n    image: temporalio/server:0.28.0\r\n    restart: unless-stopped\r\n    ports:\r\n      - '7233:7233'\r\n    environment:\r\n      AUTO_SETUP: 'true'\r\n      DB: 'postgres'\r\n      DB_PORT: '5432'\r\n      POSTGRES_USER: 'temporal'\r\n      POSTGRES_PWD: 'placeholder'\r\n      POSTGRES_SEEDS: 'postgres'\r\n      DYNAMIC_CONFIG_FILE_PATH: 'config/dynamicconfig/development.yaml'\r\n      PROMETHEUS_ENDPOINT: '0.0.0.0:9090'\r\n    depends_on:\r\n      - postgres\r\n  temporal-web:\r\n    image: temporalio/web:0.28.0\r\n    restart: unless-stopped\r\n    ports:\r\n      - '8088:8088'\r\n    environment:\r\n      TEMPORAL_GRPC_ENDPOINT: temporal-server:7233\r\n    depends_on:\r\n      - temporal-server\r\nvolumes:\r\n  postgres-data-volume:\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: v0.28.0\r\n  - Platform: docker-compose\r\n","closedAt":"2020-10-28T20:18:26Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDcwMzgxMTkzMQ==","author":{"login":"miroswan"},"authorAssociation":"NONE","body":"After taking a look I believe this is happening because the same port is being used for the four different services: frontend, history, matching, worker. Each service is instantiated with same listen address, causing the error. Since docker compose runs each service on the same host, we'll need four different prometheus ports for TCP binding. ","createdAt":"2020-10-05T18:33:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/673#issuecomment-703811931","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDcwMzgzOTcwNg==","author":{"login":"samarabbas"},"authorAssociation":"MEMBER","body":"@miroswan thanks for looking into it.  We recommended running each role as a separate pod in kubernetes so it won't be an issue if you run the server where each role is running under it's own process.  But we should absolutely support this.","createdAt":"2020-10-05T19:26:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/673#issuecomment-703839706","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDcxNzE4NjAzOQ==","author":{"login":"evilnoxx"},"authorAssociation":"NONE","body":"This fix seems to have only been merged into miroswan/temporal and not into temporalio/temporal. Will it be merged into the main temporal repo?","createdAt":"2020-10-27T11:44:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/673#issuecomment-717186039","viewerDidAuthor":false}],"createdAt":"2020-08-12T19:00:30Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":673,"reactionGroups":[],"state":"CLOSED","title":"Setting PROMETHEUS_ENDPOINT in docker-compose results in prometheus reporter errors","updatedAt":"2020-10-28T20:18:26Z","url":"https://github.com/temporalio/temporal/issues/673"}
