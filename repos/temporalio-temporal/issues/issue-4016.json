{"assignees":[{"id":"MDQ6VXNlcjIwNjgxMjQ=","login":"rodrigozhou","name":"Rodrigo Zhou","databaseId":0}],"author":{"id":"MDQ6VXNlcjEyMzc1NDIx","is_bot":false,"login":"auyer","name":"Rafael Passos"},"body":"## Expected Behavior\nI am installing Temporal via the Airbyte Helm chart (it relies on Temporal).\nAfter an upgrade to Postgres 15 (AWS RDS), Temporal stopped working.\nI've tested various configuration options, and could not get it to work.\nOnce I pointed it at a Postgres 14 installation, it worked fine.\n\n## Actual Behavior\nTemporal fails to validate the connection. In some of my attempts, it created the temporal and temporal_visibility databases, but still failed.\n\n```\n+ DB=postgresql\n+ SKIP_SCHEMA_SETUP=false\n+ KEYSPACE=temporal\n+ VISIBILITY_KEYSPACE=temporal_visibility\n+ CASSANDRA_SEEDS=\n+ CASSANDRA_PORT=9042\n+ CASSANDRA_USER=\n+ CASSANDRA_PASSWORD=\n+ CASSANDRA_TLS_ENABLED=\n+ CASSANDRA_CERT=\n+ CASSANDRA_CERT_KEY=\n+ CASSANDRA_CA=\n+ CASSANDRA_REPLICATION_FACTOR=1\n+ DBNAME=temporal\n+ VISIBILITY_DBNAME=temporal_visibility\n+ DB_PORT=5432\n+ MYSQL_SEEDS=\n+ MYSQL_USER=\n+ MYSQL_PWD=\n+ MYSQL_TX_ISOLATION_COMPAT=false\n+ POSTGRES_SEEDS=rds**************com\n+ POSTGRES_USER=dbuser\n+ POSTGRES_PWD=************\n+ ENABLE_ES=false\n+ ES_SCHEME=http\n+ ES_SEEDS=\n+ ES_PORT=9200\n+ ES_USER=\n+ ES_PWD=\n+ ES_VERSION=v7\n+ ES_VIS_INDEX=temporal_visibility_v1_dev\n+ ES_SCHEMA_SETUP_TIMEOUT_IN_SECONDS=0\n+ TEMPORAL_CLI_ADDRESS=10.12.87.28:7233\n+ SKIP_DEFAULT_NAMESPACE_CREATION=false\n+ DEFAULT_NAMESPACE=default\n+ DEFAULT_NAMESPACE_RETENTION=1\n+ SKIP_ADD_CUSTOM_SEARCH_ATTRIBUTES=false\n+ '[' false '!=' true ']'\n+ validate_db_env\n+ '[' postgresql == mysql ']'\n+ '[' postgresql == postgresql ']'\n+ '[' -z rds.**************.com ']'\n+ wait_for_db\n+ '[' postgresql == mysql ']'\n+ '[' postgresql == postgresql ']'\n+ wait_for_postgres\n+ nc -z rds.**************.com 5432\n+ echo 'PostgreSQL started.'\n+ setup_schema\n+ '[' postgresql == mysql ']'\n+ '[' postgresql == postgresql ']'\nPostgreSQL started.\nSetup PostgreSQL schema.\n+ echo 'Setup PostgreSQL schema.'\n+ setup_postgres_schema\n+ SCHEMA_DIR=/etc/temporal/schema/postgresql/v96/temporal/versioned\n+ '[' temporal '!=' dbuser ']'\n+ temporal-sql-tool --plugin postgres --ep rds.**************.com -u dbuser -p 5432 create --db temporal\n2023-03-06T17:25:23.143Z    ERROR    Unable to create SQL database.    {\"error\": \"unable to connect to DB, tried default DB names: postgres,defaultdb, errors: [pq: no pg_hba.conf entry for host \\\"10.12.87.28\\\", user \\\"dbuser\\\", database \\\"postgres\\\", no encryption pq: no pg_hba.conf entry for host \\\"10.12.87.28\\\", user \\\"dbuser\\\", database \\\"defaultdb\\\", no encryption]\", \"logging-call-at\": \"handler.go:97\"}\n2023/03/06 17:25:23 Loading config; env=docker,zone=,configDir=config\n2023/03/06 17:25:23 Loading config files=[config/docker.yaml]\n{\"level\":\"info\",\"ts\":\"2023-03-06T17:25:23.175Z\",\"msg\":\"Updated dynamic config\",\"logging-call-at\":\"file_based_client.go:143\"}\n{\"level\":\"info\",\"ts\":\"2023-03-06T17:25:23.175Z\",\"msg\":\"Starting server for services\",\"value\":[\"history\",\"matching\",\"frontend\",\"worker\"],\"logging-call-at\":\"server.go:123\"}\nUnable to start server. Error: sql schema version compatibility check failed: pq: no pg_hba.conf entry for host \"*******\", user \"dbuser\", database \"temporal\", no encryption\nStream closed EOF for airbyte/airbyte-temporal-5dc4877cb9-hkpw4 (airbyte-temporal)\n```\n\n## Steps to Reproduce the Problem\n1. Install Temporal with auto setup on Postgres 15\n or\n1. Get Airbyte helm chart here: https://github.com/airbytehq/helm-charts\n1. change configurations to reflect on your databse credentials\n1. install the helm chart\n\n## Specifications\n* Version: 1.13.0 (I also tried 1.18 and 1.20)\n* Platform: kubernetes\n\n","closedAt":"2023-06-13T15:55:05Z","comments":[{"id":"IC_kwDODNqesM5XrYbt","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"Did you upgrade to Postgres 15 from an older version? Can you check the Postgres logs? I think it's an issue with your upgrade, not Temporal Server.\r\nWhen I started a fresh DB, everything works as expected. However, if I do straight upgrade of Postgres, I get these logs from Postgres, which I believe is the issue:\r\n```\r\nPostgreSQL Database directory appears to contain a database; Skipping initialization\r\n\r\n2023-03-15 23:42:17.506 UTC [1] FATAL:  database files are incompatible with server\r\n2023-03-15 23:42:17.506 UTC [1] DETAIL:  The data directory was initialized by PostgreSQL version 13, which is not compatible with this version 15.2 (Debian 15.2-1.pgdg110+1).\r\nexited with code 1\r\n```","createdAt":"2023-03-15T23:46:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4016#issuecomment-1470990061","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5Xx6jD","author":{"login":"auyer"},"authorAssociation":"NONE","body":"It was upgraded by AWS. Its a managed service. Other services are using the same server with no problems.\r\n","createdAt":"2023-03-16T20:34:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4016#issuecomment-1472702659","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5YjkFM","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"@auyer I tried to repro here, but no success.\r\n\r\nI don't know the migration steps in AWS, but it seems that Temporal Server can't connect to PostgreSQL. From your logs above, I see this error from PostgreSQL: \"pq: no pg_hba.conf entry for host \\\"10.12.87.28\\\", user \\\"dbuser\\\", database \\\"postgres\\\", no encryption\".\r\n\r\nCan you take a look at if your `pg_hba.conf` is configured correctly to allow Temporal Server to connect to DB using the user `dbuser`?","createdAt":"2023-03-27T19:06:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4016#issuecomment-1485717836","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5euL3g","author":{"login":"roded"},"authorAssociation":"NONE","body":"Cluster deployment documentation states:\r\n```\r\nPostgreSQL v9.6 and later. Use v12 (or later) with Temporal Server v1.20 or later for Advanced Visibility capabilities.\r\n```\r\nhttps://docs.temporal.io/cluster-deployment-guide#supported-databases\r\n\r\n@rodrigozhou Can we assume Temporal supports postgres 15?\r\n\r\nThanks!","createdAt":"2023-06-13T12:02:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4016#issuecomment-1589165536","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5evpSC","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"Yes, I tested locally, and it worked as expected.","createdAt":"2023-06-13T15:31:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/4016#issuecomment-1589548162","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5ev0Dx","author":{"login":"auyer"},"authorAssociation":"NONE","body":"I suppose it is some misconfiguration in the Airbyte conf. I will close this issue. Thanks.","createdAt":"2023-06-13T15:55:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4016#issuecomment-1589592305","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6vdBuh","author":{"login":"thatmlopsguy"},"authorAssociation":"NONE","body":"Anyone tested with RDS PostgreSQL 17.4?","createdAt":"2025-06-05T10:23:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4016#issuecomment-2943622049","viewerDidAuthor":false}],"createdAt":"2023-03-06T18:07:11Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4016,"reactionGroups":[],"state":"CLOSED","title":"Temporal auto setup does not work with Postgres 15","updatedAt":"2025-06-05T10:23:38Z","url":"https://github.com/temporalio/temporal/issues/4016"}
