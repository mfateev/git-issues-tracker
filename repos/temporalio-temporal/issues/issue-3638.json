{"assignees":[],"author":{"id":"MDQ6VXNlcjcyOTc0MA==","is_bot":false,"login":"scoplin","name":"Scott Coplin"},"body":"## Expected Behavior\r\nIn a 3-node Cassandra cluster setup, I would expect that service availability would be maintained even if one of those hosts was down.  In a containerized Temporal environment, availability includes the ability to restart pods, as it may be needed for scaling or fault recovery.  This means that a degraded (but technically available) cluster should not block startup for Temporal pods.\r\n\r\n## Actual Behavior\r\nWhen one of the hosts of our Cassandra cluster is down, newly booted temporal pods of varying types (history, frontend, etc.) take nearly an hour to begin to service user requests successfully.  During the startup sequence, they report errors such as:\r\n\r\n```\r\n2022/11/21 20:53:59 gocql: unable to dial control conn xx.xx.xx.xx:9042: dial tcp xx.xx.xx.xx:9042: i/o timeout\r\n```\r\n(IP is the address of the Cassandra host that is down.)\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Configure Cassandra as a Temporal persistence store.\r\n  1. Shut down one of the Cassandra nodes.\r\n  1. Restart a temporal service (history, frontend, etc.)\r\n\r\n## Specifications\r\n\r\n  - Version: 1.18.0\r\n  - Platform: Kubernetes/Cassandra self-hosted\r\n","closedAt":"2023-08-27T20:33:52Z","comments":[{"id":"IC_kwDODNqesM5O2A9l","author":{"login":"scoplin"},"authorAssociation":"NONE","body":"I think this might be related to https://github.com/gocql/gocql/issues/1365\r\n\r\nIâ€™m wondering if wrapping the [token aware host selection policy](https://github.com/temporalio/temporal/blob/master/common/persistence/nosql/nosqlplugin/cassandra/gocql/client.go#L161) with a [single host ready policy](https://github.com/gocql/gocql/blob/6132f789ad22c1d19a66c58ac789402d5f1f9be5/policies.go#L960) might not fix the issue?","createdAt":"2022-11-21T23:14:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3638#issuecomment-1322782565","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5lA-zE","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Gocql 1.4.0 should have improved this. It is included in temporal server v1.21.5.","createdAt":"2023-08-27T20:33:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3638#issuecomment-1694756036","viewerDidAuthor":false}],"createdAt":"2022-11-21T23:13:40Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":3638,"reactionGroups":[],"state":"CLOSED","title":"Temporal services take a long time to start with degraded Cassandra cluster","updatedAt":"2023-08-27T20:33:52Z","url":"https://github.com/temporalio/temporal/issues/3638"}
