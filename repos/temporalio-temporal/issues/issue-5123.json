{"assignees":[{"id":"MDQ6VXNlcjU5NDI5NjM=","login":"MichaelSnowden","name":"Michael Snowden","databaseId":0}],"author":{"id":"MDQ6VXNlcjEyMDM4OTM=","is_bot":false,"login":"josh-berry","name":"Josh Berry"},"body":"Tests against the CLI with server v1.22.2 (not yet merged) [failed](https://github.com/temporalio/cli/actions/runs/6867519478/job/18676041242?pr=385) with a concurrent map read/write panic.\r\n\r\nOffending goroutines appear to be:\r\n\r\n```\r\n\r\ngoroutine 57 [runnable]:\r\ngithub.com/temporalio/tchannel-go/json.Register({0x1b14874f778?, 0xc000460310}, 0x32c58a3?, 0xc000164fb0)\r\n\tC:/Users/runneradmin/go/pkg/mod/github.com/temporalio/tchannel-go@v1.22.1-0.20220818200552-1be8d8cffa5b/json/handler.go:119 +0x1f2\r\ngithub.com/temporalio/ringpop-go/swim.(*Node).registerHandlers(0xc00128a1a0)\r\n\tC:/Users/runneradmin/go/pkg/mod/github.com/temporalio/ringpop-go@v0.0.0-20230606200434-b5c079f412d3/swim/handlers.go:81 +0x879\r\ngithub.com/temporalio/ringpop-go/swim.NewNode({0xc00044fa40, 0x2d}, {0xc000a06160, 0xf}, {0x3c463e8?, 0xc000460310}, 0x0?)\r\n\tC:/Users/runneradmin/go/pkg/mod/github.com/temporalio/ringpop-go@v0.0.0-20230606200434-b5c079f412d3/swim/node.go:278 +0x7b4\r\ngithub.com/temporalio/ringpop-go.(*Ringpop).init(0xc0009b0420)\r\n\tC:/Users/runneradmin/go/pkg/mod/github.com/temporalio/ringpop-go@v0.0.0-20230606200434-b5c079f412d3/ringpop.go:195 +0x2cc\r\ngithub.com/temporalio/ringpop-go.(*Ringpop).Bootstrap(0xc0009b0420, 0xdf69f0?)\r\n\tC:/Users/runneradmin/go/pkg/mod/github.com/temporalio/ringpop-go@v0.0.0-20230606200434-b5c079f412d3/ringpop.go:419 +0x3d\r\ngo.temporal.io/server/common/membership/ringpop.(*service).bootstrap.func1()\r\n\tC:/Users/runneradmin/go/pkg/mod/go.temporal.io/server@v1.22.2/common/membership/ringpop/ringpop.go:108 +0x105\r\ngo.temporal.io/server/common/backoff.ThrottleRetry.func1({0x3, 0xd0bf000000000000})\r\n\tC:/Users/runneradmin/go/pkg/mod/go.temporal.io/server@v1.22.2/common/backoff/retry.go:119 +0x1b\r\ngo.temporal.io/server/common/backoff.ThrottleRetryContext({0x3c3ea80, 0xc000054220}, 0xc000ca5300, {0x3c205c0, 0xc0005e4270}, 0x28?)\r\n\tC:/Users/runneradmin/go/pkg/mod/go.temporal.io/server@v1.22.2/common/backoff/retry.go:145 +0x20a\r\ngo.temporal.io/server/common/backoff.ThrottleRetry(0x0?, {0x3c205c0?, 0xc0005e4270?}, 0x4?)\r\n\tC:/Users/runneradmin/go/pkg/mod/go.temporal.io/server@v1.22.2/common/backoff/retry.go:120 +0x59\r\ngo.temporal.io/server/common/membership/ringpop.(*service).bootstrap(0xc000aaaae0, 0xc000ca94f8, 0x2540be400)\r\n\tC:/Users/runneradmin/go/pkg/mod/go.temporal.io/server@v1.22.2/common/membership/ringpop/ringpop.go:114 +0xee\r\ngo.temporal.io/server/common/membership/ringpop.(*service).start(...)\r\n\tC:/Users/runneradmin/go/pkg/mod/go.temporal.io/server@v1.22.2/common/membership/ringpop/ringpop.go:84\r\ngo.temporal.io/server/common/membership/ringpop.(*monitor).Start(0xc000aa9b00?)\r\n\tC:/Users/runneradmin/go/pkg/mod/go.temporal.io/server@v1.22.2/common/membership/ringpop/monitor.go:139 +0x465\r\ngo.temporal.io/server/service/worker.(*Service).Start(0xc0009b2780)\r\n\tC:/Users/runneradmin/go/pkg/mod/go.temporal.io/server@v1.22.2/service/worker/service.go:393 +0x1a4\r\ngo.uber.org/fx/internal/lifecycle.Wrap[...].func1()\r\n\tC:/Users/runneradmin/go/pkg/mod/go.uber.org/fx@v1.20.0/internal/lifecycle/lifecycle.go:80 +0x1b\r\ngo.uber.org/fx/internal/lifecycle.(*Lifecycle).runStartHook(0xc0008edce0, {0x3c3eab8, 0xc00080d500}, {0xc00082bcb0, 0xc00082bcc8, {0xc000a79940, 0x3a}, {0xc000a79a00, 0x39}, {{0xc000a79ac0, ...}, ...}})\r\n\tC:/Users/runneradmin/go/pkg/mod/go.uber.org/fx@v1.20.0/internal/lifecycle/lifecycle.go:256 +0x212\r\ngo.uber.org/fx/internal/lifecycle.(*Lifecycle).Start(0xc0008edce0, {0x3c3eab8, 0xc00080d500})\r\n\tC:/Users/runneradmin/go/pkg/mod/go.uber.org/fx@v1.20.0/internal/lifecycle/lifecycle.go:216 +0x4c8\r\ngo.uber.org/fx.(*App).start.func1({0x3c3eab8, 0xc00080d500})\r\n\tC:/Users/runneradmin/go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:679 +0x3c\r\ngo.uber.org/fx.(*App).withRollback(0xc0001e84b0, {0x3c3eab8, 0xc00080d500}, 0xc000281740?)\r\n\tC:/Users/runneradmin/go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:661 +0x38\r\ngo.uber.org/fx.(*App).start(0xc000941328?, {0x3c3eab8?, 0xc00080d500?})\r\n\tC:/Users/runneradmin/go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:678 +0x3f\r\ngo.uber.org/fx.withTimeout.func1()\r\n\tC:/Users/runneradmin/go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:782 +0x85\r\ncreated by go.uber.org/fx.withTimeout\r\n\tC:/Users/runneradmin/go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:770 +0xea\r\n```\r\n\r\nand\r\n\r\n```\r\n fatal error: concurrent map read and map write\r\n\r\ngoroutine 773 [running]:\r\ngithub.com/temporalio/tchannel-go/json.Register.func1({0x3c42788, 0xc000943530}, 0xc000a0d440)\r\n\tC:/Users/runneradmin/go/pkg/mod/github.com/temporalio/tchannel-go@v1.22.1-0.20220818200552-1be8d8cffa5b/json/handler.go:100 +0x4e\r\ngithub.com/temporalio/tchannel-go.HandlerFunc.Handle(0xc000837b00?, {0x3c42788?, 0xc000943530?}, 0xe50dc7?)\r\n\tC:/Users/runneradmin/go/pkg/mod/github.com/temporalio/tchannel-go@v1.22.1-0.20220818200552-1be8d8cffa5b/handlers.go:49 +0x2f\r\ngithub.com/temporalio/tchannel-go.(*handlerMap).Handle(0xe26e71?, {0x3c42788, 0xc000943530}, 0xc000a0d440)\r\n\tC:/Users/runneradmin/go/pkg/mod/github.com/temporalio/tchannel-go@v1.22.1-0.20220818200552-1be8d8cffa5b/handlers.go:123 +0x21c\r\ngithub.com/temporalio/tchannel-go.channelHandler.Handle({0x2ea2a00?}, {0x3c42788, 0xc000943530}, 0xc000a0d440)\r\n\tC:/Users/runneradmin/go/pkg/mod/github.com/temporalio/tchannel-go@v1.22.1-0.20220818200552-1be8d8cffa5b/handlers.go:131 +0x5a\r\ngithub.com/temporalio/tchannel-go.(*Connection).dispatchInbound(0xc001230000, 0x0?, 0x0?, 0xc000a0d440, 0x0?)\r\n\tC:/Users/runneradmin/go/pkg/mod/github.com/temporalio/tchannel-go@v1.22.1-0.20220818200552-1be8d8cffa5b/inbound.go:203 +0x454\r\ncreated by github.com/temporalio/tchannel-go.(*Connection).handleCallReq\r\n\tC:/Users/runneradmin/go/pkg/mod/github.com/temporalio/tchannel-go@v1.22.1-0.20220818200552-1be8d8cffa5b/inbound.go:125 +0xe2a\r\n```\r\n\r\nThis particular map appears to only be accessible from tchannel-go's `json.Register` and friends. Looking more into why but wanted to open this issue to track/log findings. (It's probably a server issue, but I'm opening it in CLI for now since that's where the issue was first seen. Will move once I'm sure it's actually a server problem.)","closedAt":"2023-11-16T01:50:24Z","comments":[{"id":"IC_kwDODNqesM5sGBvW","author":{"login":"josh-berry"},"authorAssociation":"NONE","body":"The farthest I've gotten so far: It seems the membership monitor for the worker service has a Ringpop which has a TChannel which is already open / handling requests when a new handler is registered. I haven't yet figured out why/how the channel gets opened before registration is done (still digging thru the code to find where the channel is created). Maybe someone in the server team who is more familiar with the code can figure this out.\r\n\r\nEither way, this definitely seems like a server issue, so will transfer there.","createdAt":"2023-11-16T00:36:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5123#issuecomment-1813519318","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5sGD79","author":{"login":"tdeebswihart"},"authorAssociation":"MEMBER","body":"I wonder if this is related to #5055...\r\nEDIT: it is not; Michael figured it out","createdAt":"2023-11-16T00:46:22Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5123#issuecomment-1813528317","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5sGGa7","author":{"login":"MichaelSnowden"},"authorAssociation":"CONTRIBUTOR","body":"The bug is in tchannel-go, specific to this function:\r\n\r\n```go\r\nfunc Register(registrar tchannel.Registrar, funcs Handlers, onError func(context.Context, error)) error {\r\n\thandlers := make(map[string]*handler)\r\n\r\n\thandler := tchannel.HandlerFunc(func(ctx context.Context, call *tchannel.InboundCall) {\r\n\t\th, ok := handlers[string(call.Method())] // read\r\n\t\tif !ok {\r\n\t\t\tonError(ctx, fmt.Errorf(\"call for unregistered method: %s\", call.Method()))\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\tif err := h.Handle(ctx, call); err != nil {\r\n\t\t\tonError(ctx, err)\r\n\t\t}\r\n\t})\r\n\r\n\tfor m, f := range funcs {\r\n\t\th, err := toHandler(f)\r\n\t\tif err != nil {\r\n\t\t\treturn fmt.Errorf(\"%v cannot be used as a handler: %v\", m, err)\r\n\t\t}\r\n\t\th.tracer = func() opentracing.Tracer {\r\n\t\t\treturn tchannel.TracerFromRegistrar(registrar)\r\n\t\t}\r\n\t\thandlers[m] = h // write\r\n\t\tregistrar.Register(handler, m) // can't do this safely until the loop exits\r\n\t}\r\n\r\n\treturn nil\r\n}\r\n```\r\n\r\nYou can see this from the goroutine dump for this goroutine:\r\n\r\n```console\r\ngoroutine 773 [running]:\r\ngithub.com/temporalio/tchannel-go/json.Register.func1({0x3c42788, 0xc000943530}, 0xc000a0d440)\r\n\tC:/Users/runneradmin/go/pkg/mod/github.com/temporalio/tchannel-go@v1.22.1-0.20220818200552-1be8d8cffa5b/json/handler.go:100 +0x4e\r\ngithub.com/temporalio/tchannel-go.HandlerFunc.Handle(0xc000837b00?, {0x3c42788?, 0xc000943530?}, 0xe50dc7?)\r\n```\r\n\r\nand this one:\r\n\r\n```console\r\ngoroutine 57 [runnable]:\r\ngithub.com/temporalio/tchannel-go/json.Register({0x1b14874f778?, 0xc000460310}, 0x32c58a3?, 0xc000164fb0)\r\n\tC:/Users/runneradmin/go/pkg/mod/github.com/temporalio/tchannel-go@v1.22.1-0.20220818200552-1be8d8cffa5b/json/handler.go:119 +0x1f2\r\n```\r\n\r\nThe first goroutine is someone calling one of the registered handlers, which looks into the handlers map, and the other goroutine is concurrently writing to the map still registering handlers.\r\nThis is made possible because we call registrar.Register(handler, m) before  weâ€™ve finished all assignments to the handlers maps. The loop should be like this instead:\r\n\r\n```go\r\n\tfor m, f := range funcs {\r\n\t\th, err := toHandler(f)\r\n\t\tif err != nil {\r\n\t\t\treturn fmt.Errorf(\"%v cannot be used as a handler: %v\", m, err)\r\n\t\t}\r\n\t\th.tracer = func() opentracing.Tracer {\r\n\t\t\treturn tchannel.TracerFromRegistrar(registrar)\r\n\t\t}\r\n\t\thandlers[m] = h\r\n\t}\r\n\tfor m := range funcs {\r\n\t\tregistrar.Register(handler, m)\r\n\t}\r\n```","createdAt":"2023-11-16T00:58:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5123#issuecomment-1813538491","viewerDidAuthor":false}],"createdAt":"2023-11-16T00:09:58Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg0","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":5123,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Race: Concurrent map read/write, probably in server","updatedAt":"2023-11-16T01:50:24Z","url":"https://github.com/temporalio/temporal/issues/5123"}
