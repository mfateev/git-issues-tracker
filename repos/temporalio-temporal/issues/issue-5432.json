{"assignees":[],"author":{"id":"MDQ6VXNlcjcwNDk0NQ==","is_bot":false,"login":"alfred-landrum","name":"Alfred Landrum"},"body":"## Expected Behavior\r\nno races during tests\r\n\r\n## Actual Behavior\r\n\r\n```\r\n\r\n==================\r\n  | WARNING: DATA RACE\r\n  | Write at 0x00c0041c4b10 by goroutine 15520:\r\n  | runtime.mapassign_faststr()\r\n  | /usr/local/go/src/runtime/map_faststr.go:203 +0x0\r\n  | go.temporal.io/server/common/cluster.(*metadataImpl).updateClusterInfoLocked()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/common/cluster/metadata.go:532 +0xc92\r\n  | go.temporal.io/server/common/cluster.(*metadataImpl).refreshClusterMetadata()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/common/cluster/metadata.go:511 +0xa85\r\n  | go.temporal.io/server/common/cluster.(*metadataImpl).refreshLoop()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/common/cluster/metadata.go:436 +0x1c6\r\n  | go.temporal.io/server/common/cluster.(*metadataImpl).refreshLoop-fm()\r\n  | <autogenerated>:1 +0x47\r\n  | go.temporal.io/server/internal/goro.(*Handle).Go.func1()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/internal/goro/goro.go:64 +0xc1\r\n  |  \r\n  | Previous read at 0x00c0041c4b10 by goroutine 16167:\r\n  | runtime.mapaccess2_faststr()\r\n  | /usr/local/go/src/runtime/map_faststr.go:108 +0x0\r\n  | go.temporal.io/server/common/cluster.(*metadataImpl).GetClusterID()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/common/cluster/metadata.go:303 +0xc8\r\n  | go.temporal.io/server/service/history/replication.(*StreamReceiverMonitorImpl).generateOutboundStreamKeys()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/service/history/replication/stream_receiver_monitor.go:214 +0x90\r\n  | go.temporal.io/server/service/history/replication.(*StreamReceiverMonitorImpl).reconcileOutboundStreams()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/service/history/replication/stream_receiver_monitor.go:170 +0x26\r\n  | go.temporal.io/server/service/history/replication.(*StreamReceiverMonitorImpl).eventLoop()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/service/history/replication/stream_receiver_monitor.go:157 +0x3d1\r\n  | go.temporal.io/server/service/history/replication.(*StreamReceiverMonitorImpl).Start.func1()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/service/history/replication/stream_receiver_monitor.go:92 +0x33\r\n  |  \r\n  | Goroutine 15520 (running) created at:\r\n  | go.temporal.io/server/internal/goro.(*Handle).Go()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/internal/goro/goro.go:60 +0xd0\r\n  | go.temporal.io/server/common/cluster.(*metadataImpl).Start()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/common/cluster/metadata.go:252 +0x6c4\r\n  | go.temporal.io/server/common/cluster.MetadataLifetimeHooks.func1()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/common/cluster/fx.go:51 +0x39\r\n  | go.uber.org/fx/internal/lifecycle.(*Lifecycle).runStartHook()\r\n  | /go/pkg/mod/go.uber.org/fx@v1.20.0/internal/lifecycle/lifecycle.go:256 +0x2bd\r\n  | go.uber.org/fx/internal/lifecycle.(*Lifecycle).Start()\r\n  | /go/pkg/mod/go.uber.org/fx@v1.20.0/internal/lifecycle/lifecycle.go:216 +0x5ef\r\n  | go.uber.org/fx.(*App).start-fm.(*App).start.func1()\r\n  | /go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:679 +0x70\r\n  | go.uber.org/fx.(*App).withRollback()\r\n  | /go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:661 +0x63\r\n  | go.uber.org/fx.(*App).start()\r\n  | /go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:678 +0x6b\r\n  | go.uber.org/fx.(*App).start-fm()\r\n  | <autogenerated>:1 +0x1f\r\n  | go.uber.org/fx.withTimeout.func1()\r\n  | /go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:782 +0xd3\r\n  |  \r\n  | Goroutine 16167 (running) created at:\r\n  | go.temporal.io/server/service/history/replication.(*StreamReceiverMonitorImpl).Start()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/service/history/replication/stream_receiver_monitor.go:92 +0xe4\r\n  | go.temporal.io/server/service/history.(*Handler).Start()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/service/history/handler.go:174 +0xa1\r\n  | go.temporal.io/server/service/history.(*Service).Start()\r\n  | /go/pkg/mod/go.temporal.io/server@v1.23.0-rc9/service/history/service.go:94 +0xe4\r\n  | go.temporal.io/server/service/history.(*Service).Start-fm()\r\n  | <autogenerated>:1 +0x33\r\n  | go.uber.org/fx/internal/lifecycle.Wrap[go.shape.func()].func1()\r\n  | /go/pkg/mod/go.uber.org/fx@v1.20.0/internal/lifecycle/lifecycle.go:80 +0x2e\r\n  | go.uber.org/fx/internal/lifecycle.(*Lifecycle).runStartHook()\r\n  | /go/pkg/mod/go.uber.org/fx@v1.20.0/internal/lifecycle/lifecycle.go:256 +0x2bd\r\n  | go.uber.org/fx/internal/lifecycle.(*Lifecycle).Start()\r\n  | /go/pkg/mod/go.uber.org/fx@v1.20.0/internal/lifecycle/lifecycle.go:216 +0x5ef\r\n  | go.uber.org/fx.(*App).start-fm.(*App).start.func1()\r\n  | /go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:679 +0x70\r\n  | go.uber.org/fx.(*App).withRollback()\r\n  | /go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:661 +0x63\r\n  | go.uber.org/fx.(*App).start()\r\n  | /go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:678 +0x6b\r\n  | go.uber.org/fx.(*App).start-fm()\r\n  | <autogenerated>:1 +0x1f\r\n  | go.uber.org/fx.withTimeout.func1()\r\n  | /go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:782 +0xd3\r\n  | ==================\r\n \r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nSeen during internal testing on 1.23.0-rc9 tag.\r\n\r\n## Specifications\r\n\r\n  - Version: 1.23.0-rc9\r\n","closedAt":"2024-02-23T22:39:29Z","comments":[{"id":"IC_kwDODNqesM50MMmZ","author":{"login":"alfred-landrum"},"authorAssociation":"MEMBER","body":"note this was already fixed in main:\r\nhttps://github.com/temporalio/temporal/pull/5317\r\n","createdAt":"2024-02-16T21:23:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5432#issuecomment-1949354393","viewerDidAuthor":false}],"createdAt":"2024-02-16T20:38:13Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":5432,"reactionGroups":[],"state":"CLOSED","title":"test detected data race in cluster metadata","updatedAt":"2024-02-23T22:39:29Z","url":"https://github.com/temporalio/temporal/issues/5432"}
