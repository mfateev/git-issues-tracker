{"assignees":[{"id":"MDQ6VXNlcjE3NjY1MTU=","login":"samarabbas","name":"Samar Abbas","databaseId":0},{"id":"MDQ6VXNlcjU1NTIzODE=","login":"mastermanu","name":"","databaseId":0}],"author":{"id":"MDQ6VXNlcjU1NTIzODE=","is_bot":false,"login":"mastermanu","name":""},"body":"Scenario: One Workflow starts 10 workflows, each of which start 10 more workflows. Those workflows execute a few activities and then ultimately wait on a timer that lasts for 4 days.\r\n\r\nExpected behavior: Terminating the \"one\" workflow causes all the descendants to also get terminated.\r\n\r\nActual behavior: Descendants are not terminated.\r\n\r\nExample (data gathered 8 minutes after WF completes):\r\n\r\n\"workflowExecutionInfo\": {\r\n    \"execution\": {\r\n      **\"workflowId\": \"pandemic-1-1-1\",**\r\n      \"runId\": \"30038897-2a50-4051-af24-b1b5716de4e2\"\r\n    },\r\n    \"type\": {\r\n      \"name\": \"config-driven-workflow\"\r\n    },\r\n    \"startTime\": \"2020-07-24T14:31:27-07:00\",\r\n    \"closeTime\": \"2020-07-24T14:32:09-07:00\",\r\n    **\"status\": \"Terminated\",**\r\n    \"historyLength\": \"44\",\r\n    \"memo\": {\r\n    },\r\n...\r\n  \"pendingChildren\": [\r\n    {\r\n      **\"workflowId\": \"pandemic-1-1-1-height-1-child-cf2bb442-4851-46cf-89d2-46112d6d1d8b\",**\r\n      \"runId\": \"512695e2-b9d7-451f-8cff-54477ae1e983\",\r\n      \"workflowTypeName\": \"config-driven-workflow\",\r\n      \"initiatedId\": \"24\",\r\n      \"parentClosePolicy\": \"Terminate\"\r\n    },\r\n\r\nAnd then it's child workflow:\r\n\r\nworkflowExecutionInfo\": {\r\n    \"execution\": {\r\n      **\"workflowId\": \"pandemic-1-1-1-height-1-child-cf2bb442-4851-46cf-89d2-46112d6d1d8b\",**\r\n      \"runId\": \"512695e2-b9d7-451f-8cff-54477ae1e983\"\r\n    },\r\n    \"type\": {\r\n      \"name\": \"config-driven-workflow\"\r\n    },\r\n    \"startTime\": \"2020-07-24T14:31:29-07:00\",\r\n    \"closeTime\": \"1969-12-31T16:00:00-08:00\",\r\n    **\"status\": \"Running\",**\r\n    \"historyLength\": \"45\",\r\n    \"parentNamespaceId\": \"e6928d9b-ec33-4662-932b-46f31a4872a7\",\r\n    \"parentExecution\": {\r\n      **\"workflowId\": \"pandemic-1-1-1\",**\r\n      \"runId\": \"30038897-2a50-4051-af24-b1b5716de4e2\"\r\n    },\r\n    \"memo\": {\r\n    },\r\n\r\n## Steps to Reproduce the Problem\r\nPandemic \"terminate\" bench test (still WIP, not yet checked-in).\r\n\r\nServer has the following error:\r\n\r\n\"level\":\"error\",\"ts\":1595626423.7177958,\"caller\":\"internal/internal_task_handlers.go:1771\",\"msg\":\"Activity panic.\",\"Namespace\":\"temporal-system\",\"TaskQueue\":\"temporal-sys-processor-parent-close-policy\",\"WorkerID\":\"2999027@temporal-dev@\",\"WorkflowID\":\"parent-close-policy-workflow-1\",\"RunID\":\"ab067650-f865-439f-896f-b64407fabc4a\",\"ActivityType\":\"temporal-sys-parent-close-policy-activity\",\r\n\r\n\"**PanicError\":\"runtime error: invalid memory address or nil pointer dereference\"**,\"\r\n\r\nPanicStack\":\"activity for temporal-sys-processor-parent-close-policy [panic]:\\n\r\ngo.temporal.io/server/common.IsValidContext(0x0, 0x0, 0x263c840, 0xc0032cb670)\\n\\t\r\n\r\n/home/manu/work/temporal/common/util.go:256 +0x26\\n\r\n\r\ngo.temporal.io/server/client/history.(*clientImpl).executeWithRedirect(0xc001370200, 0x0, 0x0, 0x263c840, 0xc0032cb670, 0xc001242b60, 0x0, 0xf6a7af)\\n\\t\r\n\r\n/home/manu/work/temporal/client/history/client.go:1058 +0x73\\n\r\n\r\ngo.temporal.io/server/client/history.(*clientImpl).TerminateWorkflowExecution(0xc001370200, 0x0, 0x0, 0xc0025a2b80, 0x0, 0x0, 0x0, 0xc00067da40, 0xc001a8dfc0, 0xc001242c28)\\n\\t\r\n\r\n/home/manu/work/temporal/client/history/client.go:641 +0x130\\n\r\ngo.temporal.io/server/client/history.(*metricClient).TerminateWorkflowExecution(0xc001453040, 0x0, 0x0, 0xc0025a2b80, 0x0, 0x0, 0x0, 0x1eb5300, 0xc001242ce0, 0x40474a)\\n\\t\r\n\r\n/home/manu/work/temporal/client/history/metricClient.go:383+0x112\\n\r\n\r\ngo.temporal.io/server/service/worker/parentclosepolicy.ProcessorActivity(0x2601c80, 0xc00320a7e0, 0xc002965d40, 0xa, 0xd, 0xc0013d6508, 0x7, 0xc0031a2720, 0x24, 0x0, ...)\\n\\t\r\n\r\n/home/manu/work/temporal/service/worker/parentclosepolicy/workflow.go:113 +0x8c5\\n\r\n\r\nreflect.Value.call(0x1d99300, 0x21d6e00, 0x13, 0x211b4c9, 0x4, 0xc000b5af90, 0x2, 0x2, 0x2, 0x18, ...)\\n\\t\r\n\r\n/snap/go/6123/src/reflect/value.go:460 +0x8ab\\n\r\n\r\nreflect.Value.Call(0x1d99300, 0x21d6e00, 0x13, 0xc000b5af90, 0x2, 0x2, 0x1, 0x1, 0x0)\\n\\t\r\n\r\n/snap/go/6123/src/reflect/value.go:321 +0xb4\\n\r\n\r\ngo.temporal.io/sdk/internal.(*activityExecutor).Execute(0xc001aa4d60, 0x2601c80, 0xc00320a7e0, 0xc002656bc0, 0xbfbef2cdeac67695, 0x30a089409d, 0x369ffe0)\\n\\t\r\n\r\n/home/manu/go/pkg/mod/go.temporal.io/sdk@v0.27.1-0.20200721191416-05a45557fecc/internal/internal_worker.go:895 +0x492\\n\r\n\r\n\r\ngo.temporal.io/sdk/internal.(*activityTaskHandlerImpl).Execute(0xc001610960, 0x2170c42, 0x2a, 0xc0004426e0, 0x0, 0x0, 0x0, 0x0)\\n\\t\r\n\r\n/home/manu/go/pkg/mod/go.temporal.io/sdk@v0.27.1-0.20200721191416-05a45557fecc/internal/internal_task_handlers.go:1797 +0x95f\\n\r\n\r\n\r\ngo.temporal.io/sdk/internal.(*activityTaskPoller).ProcessTask(0xc0006e5c70, 0x1cad3a0, 0xc002656ce0, 0xc0036b0b28, 0xf)\\n\\t/home/manu/go/pkg/mod/go.temporal.io/sdk@v0.27.1-0.20200721191416-\r\n\r\n05a45557fecc/internal/internal_task_pollers.go:897 +0x1cc\\n\r\n\r\ngo.temporal.io/sdk/internal.(*baseWorker).processTask(0xc0009f6c40, 0x1cad660, 0xc003181010)\\n\\t\r\n\r\n/home/manu/go/pkg/mod/go.temporal.io/sdk@v0.27.1-0.20200721191416-05a45557fecc/internal/internal_worker_base.go:340 +0xe0\\n\r\n\r\ncreated by go.temporal.io/sdk/internal.(*baseWorker).runTaskDispatcher\\n\\t\r\n\r\n/home/manu/go/pkg/mod/go.temporal.io/sdk@v0.27.1-0.20200721191416-05a45557fecc/internal/internal_worker_base.go:270 +0xff\",\"stacktrace\":\"go.temporal.io/sdk/internal.(*activityTaskHandlerImpl).Execute.func3\\n\\t\r\n\r\n/home/manu/go/pkg/mod/go.temporal.io/sdk@v0.27.1-0.20200721191416-05a45557fecc/internal/internal_task_handlers.go:1771\\n\r\n\r\nruntime.gopanic\\n\\t/snap/go/6123/src/runtime/panic.go:975\\nruntime.panicmem\\n\\t/snap/go/6123/src/runtime/panic.go:212\\n\r\n\r\nruntime.sigpanic\\n\\t/snap/go/6123/src/runtime/signal_unix.go:695\\ngo.temporal.io/server/common.IsValidContext\\n\\t\r\n\r\n/home/manu/work/temporal/common/util.go:256\\ngo.temporal.io/server/client/history.(*clientImpl).executeWithRedirect\\n\\t\r\n\r\n/home/manu/work/temporal/client/history/client.go:1058\\n\r\n\r\ngo.temporal.io/server/client/history.(*clientImpl).TerminateWorkflowExecution\\n\\t\r\n/home/manu/work/temporal/client/history/client.go:641\\n\r\n\r\ngo.temporal.io/server/client/history.(*metricClient).TerminateWorkflowExecution\\n\\t\r\n/home/manu/work/temporal/client/history/metricClient.go:383\\n\r\n\r\ngo.temporal.io/server/service/worker/parentclosepolicy.ProcessorActivity\\n\\t/home/manu/work/temporal/service/worker/parentclosepolicy/workflow.go:113\\n\r\n\r\nreflect.Value.call\\n\\t/snap/go/6123/src/reflect/value.go:460\\n\r\n\r\nreflect.Value.Call\\n\\t/snap/go/6123/src/reflect/value.go:321\\n\r\n\r\ngo.temporal.io/sdk/internal.(*activityExecutor).Execute\\n\\t\r\n\r\n/home/manu/go/pkg/mod/go.temporal.io/sdk@v0.27.1-0.20200721191416-05a45557fecc/internal/internal_worker.go:895\\n\r\ngo.temporal.io/sdk/internal.(*activityTaskHandlerImpl).Execute\\n\\t\r\n\r\n/home/manu/go/pkg/mod/go.temporal.io/sdk@v0.27.1-0.20200721191416-05a45557fecc/internal/internal_task_handlers.go:1797\\n\r\n\r\ngo.temporal.io/sdk/internal.(*activityTaskPoller).ProcessTask\\n\\t\r\n\r\n/home/manu/go/pkg/mod/go.temporal.io/sdk@v0.27.1-0.20200721191416-05a45557fecc/internal/internal_task_pollers.go:897\\n\r\ngo.temporal.io/sdk/internal.(*baseWorker).processTask\\n\\t\r\n\r\n/home/manu/go/pkg/mod/go.temporal.io/sdk@v0.27.1-0.20200721191416-05a45557fecc/internal/internal_worker_base.go:340\"}\r\n","closedAt":"2020-07-24T23:41:31Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDY2Mzc1MTU3NA==","author":{"login":"mastermanu"},"authorAssociation":"MEMBER","body":"Interestingly, we are passing a nil context when terminating from the system workflow for both terminate and cancel:\r\nUltimately, that causes the nil reference exception as when we validate the context, we \"assume\" that is always non-nil.\r\n\r\nEither we should pass the actual context, or we need to change the validation.\r\n\t\t\r\ncase enumspb.PARENT_CLOSE_POLICY_TERMINATE:\r\n\t\t\t_, err = client.TerminateWorkflowExecution(nil, &historyservice.TerminateWorkflowExecutionRequest{\r\n\t\t\t\tNamespaceId: request.NamespaceID,\r\n\t\t\t\tTerminateRequest: &workflowservice.TerminateWorkflowExecutionRequest{\r\n\t\t\t\t\tNamespace: request.Namespace,\r\n\t\t\t\t\tWorkflowExecution: &commonpb.WorkflowExecution{\r\n\t\t\t\t\t\tWorkflowId: execution.WorkflowID,\r\n\t\t\t\t\t\tRunId:      execution.RunID,\r\n\t\t\t\t\t},\r\n\t\t\t\t\tReason:   \"by parent close policy\",\r\n\t\t\t\t\tIdentity: processorWFTypeName,\r\n\t\t\t\t},\r\n\t\t\t})","createdAt":"2020-07-24T22:01:34Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/604#issuecomment-663751574","viewerDidAuthor":false}],"createdAt":"2020-07-24T21:43:37Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg0","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":2,"title":"Code Complete","description":"","dueOn":"2020-07-31T00:00:00Z"},"number":604,"reactionGroups":[],"state":"CLOSED","title":"Cascading terminate of parent workflow does not percolate to descendants","updatedAt":"2020-07-24T23:41:31Z","url":"https://github.com/temporalio/temporal/issues/604"}
