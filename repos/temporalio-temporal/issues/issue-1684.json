{"assignees":[],"author":{"id":"MDQ6VXNlcjEwODAzNTM1","is_bot":false,"login":"teckick","name":""},"body":"## Expected Behavior\r\n\r\nTemporal Server successfully start.\r\n\r\n## Actual Behavior\r\n\r\nTemporal Server fail to start.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. setup TiDB v4.0.x\r\n  2. local build temporal server\r\n  3. start temporal server\r\n\r\n## Specifications\r\n\r\n  - Version: master\r\n  - Platform: macOS 11.4\r\n\r\n## Possible Reason\r\n\r\nTiDB default use optimistic transaction model. When Server start, it start a new transaction, insert one record into table namespaces, and update namespace_metadata, then commit the transaction. In pessimistic transaction model like MySQL, database ERROR 1062 (Duplicate Entry) is returned when INSERT SQL is called, but in optimistic transaction model, the ERROR is returned when the transaction COMMIT. Currently, Temporal Server cannot handle ERROR 1062 in COMMIT SQL.\r\n\r\n\r\n\r\n\r\n\r\n","closedAt":"2021-06-26T01:37:27Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg2Nzg3MDQ4Nw==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"Temporal currently officially support MySQL v5.7\r\n\r\n---------\r\n1. TiDB [claims](https://docs.pingcap.com/tidb/v4.0/mysql-compatibility) that `TiDB is fully compatible with the MySQL 5.7 protocol and the common features and syntax of MySQL 5.7.`\r\n\r\nHowever, seems that TiDB (v4.0.13 & v5.0.2 & 5.1.0) does not seem to support shared lock? \r\n```zsh\r\nfunction LOCK IN SHARE MODE has only noop implementation in tidb now, use tidb_enable_noop_functions to enable these functions\r\n```\r\n\r\n---------\r\n2. We currently do not have the bandwidth to work on supporting TiDB's optimistic transaction model, but contribution is welcomed, if you want to proceed, let us sync first.\r\n","createdAt":"2021-06-24T18:43:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1684#issuecomment-867870487","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg2ODc3MDU4OQ==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"after setting both global variables to TiDB 4.0.13, seems that local canary (multiple test scenarios) can run without any issue.\r\n* `SET GLOBAL tidb_enable_noop_functions=1;`\r\n* `SET GLOBAL tidb_txn_mode=\"pessimistic\";` \r\n\r\naccording to TiDB documents below:\r\nenabling `tidb_enable_noop_functions` will not break the existing SQL persistence layer logic (there might be edge cases), even if select for shared mode behaves differently, i.e. commit of a transaction will return an error causing business logic layer to retry.\r\n\r\nRef: \r\n* [tidb_enable_noop_functions](https://docs.pingcap.com/tidb/stable/system-variables#tidb_enable_noop_functions-new-in-v40)\r\n* [behavior difference between TiDB vs MySQL inno DB](https://docs.pingcap.com/zh/tidb/dev/pessimistic-transaction#%E5%92%8C-mysql-innodb-%E7%9A%84%E5%B7%AE%E5%BC%82)\r\n* [handling of commit transaction](https://github.com/temporalio/temporal/blob/v1.10.5/common/persistence/sql/common.go#L59-L86)","createdAt":"2021-06-25T18:58:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/1684#issuecomment-868770589","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg2ODkyMDkwMA==","author":{"login":"teckick"},"authorAssociation":"CONTRIBUTOR","body":"Temporal server starts successfully with these settings. Thanks a lot!","createdAt":"2021-06-26T01:36:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1684#issuecomment-868920900","viewerDidAuthor":false}],"createdAt":"2021-06-24T12:43:53Z","labels":[{"id":"MDU6TGFiZWwzMTE0NDY0ODcw","name":"compatibility","description":"","color":"34A95C"}],"milestone":null,"number":1684,"reactionGroups":[],"state":"CLOSED","title":"Temporal Server fail to start using TiDB","updatedAt":"2021-06-26T01:37:27Z","url":"https://github.com/temporalio/temporal/issues/1684"}
