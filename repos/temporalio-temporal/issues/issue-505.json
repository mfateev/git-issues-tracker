{"assignees":[{"id":"MDQ6VXNlcjM0MzgwODA2","login":"flossypurse","name":"Cully","databaseId":0}],"author":{"id":"MDQ6VXNlcjE2NzI1NzUw","is_bot":false,"login":"pauldemarco","name":"Paul DeMarco"},"body":"## Expected Behavior\r\nI should be able to add a new search attribute \"UserID\" of type Keyword to Temporal for filtering.\r\n\r\n## Actual Behavior\r\nI initially receive an error when trying to add attribute. Upon listing added keys, I see the newly added key but it is of the wrong type (String).\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Deploy the latest Temporal 0.26.0 with Elasticsearch enabled.\r\n  2. Add a new search attribute by running the following command: `tctl --namespace default adm cl asa --search_attr_key UserID --search_attr_type 1`\r\n  3. Observe the following error and stack trace:\r\n```\r\nbash-5.0# tctl  --namespace default adm cl asa --search_attr_key UserID --search_attr_type 1\r\nAre you trying to add key [UserID] with Type [Keyword]? Y/N y\r\n\r\nError: Add search attribute failed.\r\nError Details: Failed to update dynamic config, err: unable to update key.\r\nStack trace:\r\ngoroutine 1 [running]:\r\nruntime/debug.Stack(0xd, 0x0, 0x0)\r\n\t/usr/local/go/src/runtime/debug/stack.go:24 +0x9d\r\nruntime/debug.PrintStack()\r\n\t/usr/local/go/src/runtime/debug/stack.go:16 +0x22\r\ngithub.com/temporalio/temporal/tools/cli.printError(0x1c5008f, 0x1c, 0x2003cc0, 0xc00000c300)\r\n\t/temporal/tools/cli/util.go:526 +0x2ad\r\ngithub.com/temporalio/temporal/tools/cli.ErrorAndExit(0x1c5008f, 0x1c, 0x2003cc0, 0xc00000c300)\r\n\t/temporal/tools/cli/util.go:537 +0x49\r\ngithub.com/temporalio/temporal/tools/cli.AdminAddSearchAttribute(0xc000127b80)\r\n\t/temporal/tools/cli/adminClusterCommands.go:61 +0x50f\r\ngithub.com/temporalio/temporal/tools/cli.newAdminClusterCommands.func1(0xc000127b80)\r\n\t/temporal/tools/cli/admin.go:812 +0x2b\r\ngithub.com/urfave/cli.HandleAction(0x18cf500, 0x1cc9b88, 0xc000127b80, 0xc000127b80, 0x0)\r\n\t/go/pkg/mod/github.com/urfave/cli@v1.22.4/app.go:528 +0x7c\r\ngithub.com/urfave/cli.Command.Run(0x1c3692d, 0xf, 0x0, 0x0, 0xc0006998c0, 0x1, 0x1, 0x1c4d6ff, 0x1a, 0x0, ...)\r\n\t/go/pkg/mod/github.com/urfave/cli@v1.22.4/command.go:174 +0x57a\r\ngithub.com/urfave/cli.(*App).RunAsSubcommand(0xc0004d9c00, 0xc000127760, 0x0, 0x0)\r\n\t/go/pkg/mod/github.com/urfave/cli@v1.22.4/app.go:407 +0x915\r\ngithub.com/urfave/cli.Command.startApp(0x1c2a872, 0x7, 0x0, 0x0, 0xc0006999f0, 0x1, 0x1, 0x1c551de, 0x1e, 0x0, ...)\r\n\t/go/pkg/mod/github.com/urfave/cli@v1.22.4/command.go:373 +0x845\r\ngithub.com/urfave/cli.Command.Run(0x1c2a872, 0x7, 0x0, 0x0, 0xc0006999f0, 0x1, 0x1, 0x1c551de, 0x1e, 0x0, ...)\r\n\t/go/pkg/mod/github.com/urfave/cli@v1.22.4/command.go:102 +0xa2b\r\ngithub.com/urfave/cli.(*App).RunAsSubcommand(0xc0004d9a40, 0xc000127600, 0x0, 0x0)\r\n\t/go/pkg/mod/github.com/urfave/cli@v1.22.4/app.go:407 +0x915\r\ngithub.com/urfave/cli.Command.startApp(0x1c27ae6, 0x5, 0x0, 0x0, 0xc000699970, 0x1, 0x1, 0x1c3df67, 0x13, 0x0, ...)\r\n\t/go/pkg/mod/github.com/urfave/cli@v1.22.4/command.go:373 +0x845\r\ngithub.com/urfave/cli.Command.Run(0x1c27ae6, 0x5, 0x0, 0x0, 0xc000699970, 0x1, 0x1, 0x1c3df67, 0x13, 0x0, ...)\r\n\t/go/pkg/mod/github.com/urfave/cli@v1.22.4/command.go:102 +0xa2b\r\ngithub.com/urfave/cli.(*App).Run(0xc0004d96c0, 0xc00010c000, 0xa, 0xa, 0x0, 0x0)\r\n\t/go/pkg/mod/github.com/urfave/cli@v1.22.4/app.go:279 +0x7c7\r\nmain.main()\r\n\t/temporal/cmd/tools/cli/main.go:37 +0x4b\r\n```\r\n4. List the search attributes and notice the wrong type:\r\n```\r\nbash-5.0#  tctl --namespace default cl get-search-attr\r\n+-----------------------+------------+\r\n|          KEY          | VALUE TYPE |\r\n+-----------------------+------------+\r\n| BinaryChecksums       | Keyword    |\r\n| CloseTime             | Int        |\r\n| CustomBoolField       | Bool       |\r\n| CustomDatetimeField   | Datetime   |\r\n| CustomDoubleField     | Double     |\r\n| CustomIntField        | Int        |\r\n| CustomKeywordField    | Keyword    |\r\n| CustomStringField     | String     |\r\n| ExecutionStatus       | Int        |\r\n| ExecutionTime         | Int        |\r\n| HistoryLength         | Int        |\r\n| NamespaceId           | Keyword    |\r\n| RunId                 | Keyword    |\r\n| StartTime             | Int        |\r\n| TaskQueue             | Keyword    |\r\n| TemporalChangeVersion | Keyword    |\r\n| UserID                | String     |\r\n| WorkflowId            | Keyword    |\r\n| WorkflowType          | Keyword    |\r\n+-----------------------+------------+\r\n```\r\n## Additional Questions\r\nNow that I have an incorrect attribute added, is there any way to edit or remove it?\r\nDoes the search attribute need to be registered explicitly by the CLI before it can be used elsewhere (go-sdk)?  The docs mention something here but it's still a bit unclear: https://docs.temporal.io/docs/learn-workflow-filtering#search-attributes-go-client-usage\r\n\r\n## Specifications\r\n\r\n  - Version: 0.26.0\r\n  - Platform: Ubuntu 18.04\r\n","closedAt":"2020-07-14T19:27:33Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDY1NTE2OTA1Nw==","author":{"login":"pauldemarco"},"authorAssociation":"NONE","body":"I've just noticed that the attribute type registered is always 1 less than what was specified. For example, if I specify type 1 (Keyword), it registers as type 0 (String). Perhaps some indexing issue with the list?\r\n\r\nIt should be [0:String, 1:Keyword, 2:Int, 3:Double, 4:Bool, 5:Datetime] (default: -1)\r\n","createdAt":"2020-07-07T22:27:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-655169057","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NTY5NzEzMw==","author":{"login":"pauldemarco"},"authorAssociation":"NONE","body":"It seems I cannot use the search attribute after all. I see the following failure when I attempt to upsert search attributes from go code:\r\n![image](https://user-images.githubusercontent.com/16725750/86959172-590cff80-c12b-11ea-9068-015ade8e7e89.png)\r\n","createdAt":"2020-07-08T18:57:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-655697133","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NTcxNjgwNg==","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"As for indexes, doc is wrong. 0 is now UNSPECIFIED and the should start with one. We need to update doc.","createdAt":"2020-07-08T19:41:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-655716806","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NTcyMjcwMg==","author":{"login":"samarabbas"},"authorAssociation":"MEMBER","body":"@cullywakelin can you look into updating the docs to reflect this?","createdAt":"2020-07-08T19:53:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-655722702","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NTc0ODgzNg==","author":{"login":"pauldemarco"},"authorAssociation":"NONE","body":"Would anyone be able to verify they are also seeing the error from Step 3?  I'd like to rule out any potential deployment issues on my end.","createdAt":"2020-07-08T20:48:25Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-655748836","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NTc2NzY0OQ==","author":{"login":"mastermanu"},"authorAssociation":"MEMBER","body":"Hey @pauldemarco, we were not able to reproduce the error you got, at least against a docker container deployed on the local environment. Do you have temporal-frontend logs you can share?","createdAt":"2020-07-08T21:28:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-655767649","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NTc3NDk1NA==","author":{"login":"pauldemarco"},"authorAssociation":"NONE","body":"@mastermanu These are the logs created in temporal-frontend after running `tctl --namespace default adm cl asa --search_attr_key UserID --search_attr_type 1`\r\n```\r\n$ kubectl -n temporal logs service/temporal-frontend-headless -f\r\n+ DB=cassandra\r\n+ ENABLE_ES=true\r\n+ ES_PORT=9200\r\n+ RF=1\r\n+ DEFAULT_NAMESPACE=default\r\n+ DEFAULT_NAMESPACE_RETENTION=1\r\n+ export TEMPORAL_CLI_ADDRESS=10.42.0.54:7233\r\n+ TEMPORAL_CLI_ADDRESS=10.42.0.54:7233\r\n+ export KEYSPACE=temporal\r\n+ KEYSPACE=temporal\r\n+ export VISIBILITY_KEYSPACE=temporal_visibility\r\n+ VISIBILITY_KEYSPACE=temporal_visibility\r\n+ export DBNAME=temporal\r\n+ DBNAME=temporal\r\n+ export VISIBILITY_DBNAME=temporal_visibility\r\n+ VISIBILITY_DBNAME=temporal_visibility\r\n+ export DB_PORT=3306\r\n+ DB_PORT=3306\r\n+ '[' '' = true ']'\r\n+ '[' true == true ']'\r\n+ wait_for_es\r\n++ awk -F , '{print $1}'\r\n++ echo elasticsearch-master-headless\r\n+ server=elasticsearch-master-headless\r\n+ URL=http://elasticsearch-master-headless:9200\r\n+ curl -s http://elasticsearch-master-headless:9200\r\n+ '[' 0 -eq 0 ']'\r\n+ echo 'elasticsearch started'\r\nelasticsearch started\r\n+ setup_es_template\r\n+ SCHEMA_FILE=/etc/temporal/schema/elasticsearch/visibility/index_template.json\r\n++ echo elasticsearch-master-headless\r\n++ awk -F , '{print $1}'\r\n+ server=elasticsearch-master-headless\r\n+ URL=http://elasticsearch-master-headless:9200/_template/temporal-visibility-template\r\n+ curl -X PUT http://elasticsearch-master-headless:9200/_template/temporal-visibility-template -H 'Content-Type: application/json' --data-binary @/etc/temporal/schema/elasticsearch/visibility/index_template.json\r\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n                                 Dload  Upload   Total   Spent    Left  Speed\r\n100  1917  100    21  100  1896   1050  94800 --:--:-- --:--:-- --:--:-- 95850\r\n+ URL=http://elasticsearch-master-headless:9200/temporal-visibility-dev\r\n+ curl -X PUT http://elasticsearch-master-headless:9200/temporal-visibility-dev\r\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n                                 Dload  Upload   Total   Spent    Left  Speed\r\n100   433  100   433    0     0  72166      0 --:--:-- --:--:-- --:--:-- 72166\r\n+ bash /start-temporal.sh\r\n+ dockerize -template /etc/temporal/config/config_template.yaml:/etc/temporal/config/docker.yaml\r\n+ exec temporal-server --root /etc/temporal --env docker start --services=frontend\r\n2020/07/08 21:37:22 Loading config; env=docker,zone=,configDir=/etc/temporal/config\r\n2020/07/08 21:37:22 Loading configFiles=[/etc/temporal/config/docker.yaml]\r\n2020/07/08 21:37:22 error creating file based dynamic config client, use no-op config client instead. error: error checking dynamic config file at path , error: stat : no such file or directory\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:22.947Z\",\"msg\":\"PProf listen on \",\"port\":7936,\"logging-call-at\":\"pprof.go:74\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:22.949Z\",\"msg\":\"Get dynamic config\",\"name\":\"history.persistenceMaxQPS\",\"value\":\"3000\",\"default-value\":\"3000\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:22.965Z\",\"msg\":\"Get dynamic config\",\"name\":\"system.advancedVisibilityWritingMode\",\"value\":\"on\",\"default-value\":\"on\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:22.965Z\",\"msg\":\"Get dynamic config\",\"name\":\"system.enableGlobalNamespace\",\"value\":\"false\",\"default-value\":\"false\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:22.989Z\",\"msg\":\"Starting service frontend\",\"logging-call-at\":\"server.go:254\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:22.990Z\",\"msg\":\"Get dynamic config\",\"name\":\"frontend.historyMgrNumConns\",\"value\":\"10\",\"default-value\":\"10\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:22.990Z\",\"msg\":\"Get dynamic config\",\"name\":\"frontend.throttledLogRPS\",\"value\":\"20\",\"default-value\":\"20\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:22.991Z\",\"msg\":\"Created gRPC listener\",\"service\":\"frontend\",\"address\":\"0.0.0.0:7233\",\"logging-call-at\":\"rpc.go:134\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:22.991Z\",\"msg\":\"Get dynamic config\",\"name\":\"frontend.persistenceGlobalMaxQPS\",\"value\":\"0\",\"default-value\":\"0\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:22.991Z\",\"msg\":\"Get dynamic config\",\"name\":\"frontend.persistenceMaxQPS\",\"value\":\"2000\",\"default-value\":\"2000\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:23.021Z\",\"msg\":\"Get dynamic config\",\"name\":\"system.enableReadFromClosedExecutionV2\",\"value\":\"false\",\"default-value\":\"false\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:23.021Z\",\"msg\":\"Get dynamic config\",\"name\":\"system.enableVisibilitySampling\",\"value\":\"true\",\"default-value\":\"true\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:23.039Z\",\"msg\":\"frontend starting\",\"service\":\"frontend\",\"logging-call-at\":\"service.go:233\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:23.040Z\",\"msg\":\"Get dynamic config\",\"name\":\"frontend.rps\",\"value\":\"1200\",\"default-value\":\"1200\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:23.040Z\",\"msg\":\"Get dynamic config\",\"name\":\"system.minRetentionDays\",\"value\":\"1\",\"default-value\":\"1\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:23.040Z\",\"msg\":\"RuntimeMetricsReporter started\",\"service\":\"frontend\",\"logging-call-at\":\"runtime.go:173\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:23.042Z\",\"msg\":\"Membership heartbeat upserted successfully\",\"service\":\"frontend\",\"address\":\"10.42.0.54\",\"port\":6933,\"hostId\":\"356b6de8-c163-11ea-9113-b60cfeed8717\",\"logging-call-at\":\"rpMonitor.go:212\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:23.046Z\",\"msg\":\"Current reachable members\",\"service\":\"frontend\",\"component\":\"service-resolver\",\"service\":\"matching\",\"addresses\":\"[10.42.0.66:6935]\",\"logging-call-at\":\"rpServiceResolver.go:263\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:23.047Z\",\"msg\":\"Current reachable members\",\"service\":\"frontend\",\"component\":\"service-resolver\",\"service\":\"frontend\",\"addresses\":\"[10.42.0.54:6933]\",\"logging-call-at\":\"rpServiceResolver.go:263\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:23.047Z\",\"msg\":\"Current reachable members\",\"service\":\"frontend\",\"component\":\"service-resolver\",\"service\":\"history\",\"addresses\":\"[10.42.0.53:6934]\",\"logging-call-at\":\"rpServiceResolver.go:263\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:23.051Z\",\"msg\":\"Service resources started\",\"service\":\"frontend\",\"address\":\"10.42.0.54:7233\",\"logging-call-at\":\"resourceImpl.go:380\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:23.051Z\",\"msg\":\"Get dynamic config\",\"name\":\"frontend.enableCleanupReplicationTask\",\"value\":\"true\",\"default-value\":\"true\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:23.051Z\",\"msg\":\"Starting to serve on frontend listener\",\"service\":\"frontend\",\"logging-call-at\":\"service.go:283\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:24.032Z\",\"msg\":\"Get dynamic config\",\"name\":\"frontend.enableClientVersionCheck\",\"value\":\"false\",\"default-value\":\"false\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:24.032Z\",\"msg\":\"Get dynamic config\",\"name\":\"limit.maxIDLength\",\"value\":\"1000\",\"default-value\":\"1000\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:32.781Z\",\"msg\":\"Received a ring changed event\",\"service\":\"frontend\",\"component\":\"service-resolver\",\"service\":\"matching\",\"logging-call-at\":\"rpServiceResolver.go:216\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:32.781Z\",\"msg\":\"Received a ring changed event\",\"service\":\"frontend\",\"component\":\"service-resolver\",\"service\":\"history\",\"logging-call-at\":\"rpServiceResolver.go:216\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:32.781Z\",\"msg\":\"Received a ring changed event\",\"service\":\"frontend\",\"component\":\"service-resolver\",\"service\":\"worker\",\"logging-call-at\":\"rpServiceResolver.go:216\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:32.781Z\",\"msg\":\"Received a ring changed event\",\"service\":\"frontend\",\"component\":\"service-resolver\",\"service\":\"frontend\",\"logging-call-at\":\"rpServiceResolver.go:216\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:32.781Z\",\"msg\":\"Current reachable members\",\"service\":\"frontend\",\"component\":\"service-resolver\",\"service\":\"worker\",\"addresses\":\"[10.42.0.65:6939]\",\"logging-call-at\":\"rpServiceResolver.go:263\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:32.852Z\",\"msg\":\"Get dynamic config\",\"service\":\"frontend\",\"name\":\"matching.numTaskqueueReadPartitions\",\"value\":\"1\",\"default-value\":\"1\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:36.681Z\",\"msg\":\"Get dynamic config\",\"name\":\"frontend.globalNamespacerps\",\"value\":\"0\",\"default-value\":\"0\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:36.681Z\",\"msg\":\"Get dynamic config\",\"name\":\"frontend.namespacerps\",\"value\":\"1200\",\"default-value\":\"1200\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:36.682Z\",\"msg\":\"Get dynamic config\",\"name\":\"limit.blobSize.error\",\"value\":\"2097152\",\"default-value\":\"2097152\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:37:36.682Z\",\"msg\":\"Get dynamic config\",\"name\":\"limit.blobSize.warn\",\"value\":\"262144\",\"default-value\":\"262144\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"warn\",\"ts\":\"2020-07-08T21:38:07.064Z\",\"msg\":\"error in prometheus reporter\",\"error\":\"a previously registered descriptor with the same fully-qualified name as Desc{fqName: \\\"service_authorization_latency\\\", help: \\\"service_authorization_latency histogram\\\", constLabels: {}, variableLabels: [type operation]} has different label names or a different help string\",\"logging-call-at\":\"metrics.go:135\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:38:07.413Z\",\"msg\":\"Get dynamic config\",\"name\":\"system.enableReadVisibilityFromES\",\"value\":\"true\",\"default-value\":\"true\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:38:07.413Z\",\"msg\":\"Get dynamic config\",\"name\":\"frontend.esIndexMaxResultWindow\",\"value\":\"10000\",\"default-value\":\"10000\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:38:28.389Z\",\"msg\":\"Get dynamic config\",\"name\":\"history.enableAdminProtection\",\"value\":\"false\",\"default-value\":\"false\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:38:28.404Z\",\"msg\":\"Register namespace succeeded\",\"service\":\"frontend\",\"wf-namespace\":\"default\",\"wf-namespace-id\":\"213f88f1-5524-4008-a673-058822631107\",\"logging-call-at\":\"handler.go:279\"}\r\n{\"level\":\"warn\",\"ts\":\"2020-07-08T21:39:12.532Z\",\"msg\":\"error in prometheus reporter\",\"error\":\"a previously registered descriptor with the same fully-qualified name as Desc{fqName: \\\"service_latency\\\", help: \\\"service_latency histogram\\\", constLabels: {}, variableLabels: [type operation]} has different label names or a different help string\",\"logging-call-at\":\"metrics.go:135\"}\r\n{\"level\":\"warn\",\"ts\":\"2020-07-08T21:39:12.532Z\",\"msg\":\"error in prometheus reporter\",\"error\":\"a previously registered descriptor with the same fully-qualified name as Desc{fqName: \\\"service_requests\\\", help: \\\"service_requests counter\\\", constLabels: {}, variableLabels: [type operation]} has different label names or a different help string\",\"logging-call-at\":\"metrics.go:135\"}\r\n{\"level\":\"error\",\"ts\":\"2020-07-08T21:39:12.532Z\",\"msg\":\"Internal service error\",\"service\":\"frontend\",\"error\":\"Failed to update dynamic config, err: unable to update key.\",\"logging-call-at\":\"adminHandler.go:1170\",\"stacktrace\":\"github.com/temporalio/temporal/common/log/loggerimpl.(*loggerImpl).Error\\n\\t/temporal/common/log/loggerimpl/logger.go:138\\ngithub.com/temporalio/temporal/service/frontend.(*AdminHandler).error\\n\\t/temporal/service/frontend/adminHandler.go:1170\\ngithub.com/temporalio/temporal/service/frontend.(*AdminHandler).AddSearchAttribute\\n\\t/temporal/service/frontend/adminHandler.go:165\\ngithub.com/temporalio/temporal/service/frontend.(*AdminNilCheckHandler).AddSearchAttribute\\n\\t/temporal/service/frontend/adminNilCheckHandler.go:113\\ngithub.com/temporalio/temporal/.gen/proto/adminservice/v1._AdminService_AddSearchAttribute_Handler.func1\\n\\t/temporal/.gen/proto/adminservice/v1/service.pb.go:579\\ngithub.com/temporalio/temporal/service/frontend.interceptor\\n\\t/temporal/service/frontend/service.go:323\\ngithub.com/temporalio/temporal/.gen/proto/adminservice/v1._AdminService_AddSearchAttribute_Handler\\n\\t/temporal/.gen/proto/adminservice/v1/service.pb.go:581\\ngoogle.golang.org/grpc.(*Server).processUnaryRPC\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.30.0/server.go:1171\\ngoogle.golang.org/grpc.(*Server).handleStream\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.30.0/server.go:1494\\ngoogle.golang.org/grpc.(*Server).serveStreams.func1.2\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.30.0/server.go:834\"}\r\n{\"level\":\"info\",\"ts\":\"2020-07-08T21:41:52.948Z\",\"msg\":\"Get dynamic config\",\"name\":\"frontend.validSearchAttributes\",\"value\":\"map[BinaryChecksums:Keyword CloseTime:Int CustomBoolField:Bool CustomDatetimeField:Datetime CustomDoubleField:Double CustomIntField:Int CustomKeywordField:Keyword CustomStringField:String ExecutionStatus:Int ExecutionTime:Int HistoryLength:Int NamespaceId:Keyword RunId:Keyword StartTime:Int TaskQueue:Keyword TemporalChangeVersion:Keyword UserID:1 WorkflowId:Keyword WorkflowType:Keyword]\",\"default-value\":\"map[BinaryChecksums:Keyword CloseTime:Int CustomBoolField:Bool CustomDatetimeField:Datetime CustomDoubleField:Double CustomIntField:Int CustomKeywordField:Keyword CustomStringField:String ExecutionStatus:Int ExecutionTime:Int HistoryLength:Int NamespaceId:Keyword RunId:Keyword StartTime:Int TaskQueue:Keyword TemporalChangeVersion:Keyword UserID:1 WorkflowId:Keyword WorkflowType:Keyword]\",\"logging-call-at\":\"config.go:78\"}\r\n{\"level\":\"error\",\"ts\":\"2020-07-08T21:43:31.913Z\",\"msg\":\"Internal service error\",\"service\":\"frontend\",\"error\":\"Failed to update dynamic config, err: unable to update key.\",\"logging-call-at\":\"adminHandler.go:1170\",\"stacktrace\":\"github.com/temporalio/temporal/common/log/loggerimpl.(*loggerImpl).Error\\n\\t/temporal/common/log/loggerimpl/logger.go:138\\ngithub.com/temporalio/temporal/service/frontend.(*AdminHandler).error\\n\\t/temporal/service/frontend/adminHandler.go:1170\\ngithub.com/temporalio/temporal/service/frontend.(*AdminHandler).AddSearchAttribute\\n\\t/temporal/service/frontend/adminHandler.go:165\\ngithub.com/temporalio/temporal/service/frontend.(*AdminNilCheckHandler).AddSearchAttribute\\n\\t/temporal/service/frontend/adminNilCheckHandler.go:113\\ngithub.com/temporalio/temporal/.gen/proto/adminservice/v1._AdminService_AddSearchAttribute_Handler.func1\\n\\t/temporal/.gen/proto/adminservice/v1/service.pb.go:579\\ngithub.com/temporalio/temporal/service/frontend.interceptor\\n\\t/temporal/service/frontend/service.go:323\\ngithub.com/temporalio/temporal/.gen/proto/adminservice/v1._AdminService_AddSearchAttribute_Handler\\n\\t/temporal/.gen/proto/adminservice/v1/service.pb.go:581\\ngoogle.golang.org/grpc.(*Server).processUnaryRPC\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.30.0/server.go:1171\\ngoogle.golang.org/grpc.(*Server).handleStream\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.30.0/server.go:1494\\ngoogle.golang.org/grpc.(*Server).serveStreams.func1.2\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.30.0/server.go:834\"}\r\n```\r\n\r\n\r\nThis is an interesting line here: `2020/07/08 21:37:22 error creating file based dynamic config client, use no-op config client instead. error: error checking dynamic config file at path , error: stat : no such file or directory`, since the no-op client is the only thing that can produce a \"unable to update key\" error message.","createdAt":"2020-07-08T21:46:56Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-655774954","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NTc4NzUzMQ==","author":{"login":"mastermanu"},"authorAssociation":"MEMBER","body":"Ok, let me dig into this and get back to you regarding the error you are getting. \r\n\r\nOn a separate FYI, we're landing a change so that the --search_attr_type parameter takes in the actual case-insensitive type-name (e.g. string, keyword, int, etc) so that you don't have to look at a reverse mapping to an integer. We were able to confirm that adding attributes / searching workflows by those attributes worked properly with that change.","createdAt":"2020-07-08T22:20:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-655787531","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NTgxNzUxMw==","author":{"login":"mastermanu"},"authorAssociation":"MEMBER","body":"So an update here:\r\n\r\n1) We assume that you are using our helm charts to deploy Temporal onto a Kubernetes cluster. If this is not the case, let us know, but the rest of the explanation should still be correct.\r\n\r\n2) The yaml element called \"dynamicConfigClient\" within the configuration template (and therefore the configuration file) is not present. (See /etc/temporal/config/docker.yaml on your running node). Because that element is absent, the dynamic config client we generate is the \"no-op\" client (as you discovered above). A no-op client rejects any attempts to change it.\r\n\r\n3) For a deployed cluster with more than one temporal server node, even if we specified the dynamicConfigClient configuration, if you were to run the tctl command to create a new search attribute key/value type, it would persist the change to ONLY the node which that tctl command hit...but not any of the other nodes. Also if that pod were to be recycled / re-imaged, that change would be lost.\r\n\r\n4) Thus, we are currently at a point where the included dynamicconfiguration file has to be set in the docker container image itself or copied over on startup.\r\n\r\nIn other words, you would create the dynamicconfiguration file ahead of time (with whatever additional attributes you want indexed) and then make sure it is included in the temporal server container image you are deploying. If you ssh into one of your server nodes, you'll notice that the /etc/temporal/config/dynamicconfig/development_es.yaml already exists. So you'd be adding the appropriate lines to that file, add it to your temporal server image, and then deploy that image.\r\n\r\nYou also need to make sure the dynamicConfigClient yaml element is added to the config-template file.\r\nSee here: https://github.com/temporalio/temporal-helm-charts/blob/master/templates/server-configmap.yaml (it would be added just below the publicClient element, at the same level of indentation as publicClient with the following fields, like so):\r\n\r\n```\r\npublicClient:\r\n   ...\r\n\r\ndynamicConfigClient:\r\n    filepath: config/dynamicconfig/development_es.yaml\r\n    pollInterval: \"60s\"\r\n\r\n```\r\n\r\nYou can also run the tctl tool on a local dev box environment to add all the attributes, then grab the dynamic config file from the local container running locally and then copy it over if you don't want to edit the file by hand. For instance, this is what the file looked like when I added UserID as a key and Keyword as the Type:\r\n\r\n```\r\nfrontend.enableClientVersionCheck:\r\n- value: true\r\n  constraints: {}\r\nfrontend.validSearchAttributes:\r\n- value:\r\n    BinaryChecksums: Keyword\r\n    CloseTime: Int\r\n    CustomBoolField: Bool\r\n    CustomDatetimeField: Datetime\r\n    CustomDoubleField: Double\r\n    CustomIntField: Int\r\n    CustomKeywordField: Keyword\r\n    CustomNamespace: Keyword\r\n    CustomStringField: String\r\n    ExecutionTime: Int\r\n    HistoryLength: Int\r\n    NamespaceId: Keyword\r\n    Operator: Keyword\r\n    RolloutId: Keyword\r\n    RunId: Keyword\r\n    StartTime: Int\r\n    Status: Int\r\n    TaskQueue: Keyword\r\n    TemporalChangeVersion: Keyword\r\n    UserID: 2\r\n    WorkflowId: Keyword\r\n    WorkflowType: Keyword\r\n    addon: Keyword\r\n    addon-type: Keyword\r\n    environment: Keyword\r\n    project: Keyword\r\n    service: Keyword\r\n    user: Keyword\r\n  constraints: {}\r\nsystem.advancedVisibilityWritingMode:\r\n- value: \"on\"\r\n  constraints: {}\r\nsystem.enableReadVisibilityFromES:\r\n- value: true\r\n  constraints: {}\r\nsystem.minRetentionDays:\r\n- value: 0\r\n  constraints: {}\r\n```\r\n_(Notice that UserID has a value of '2' that maps to Keyword. You could also get away with putting Keyword or w/e accepted type name you wanted instead of having to put in the corresponding integer)_\r\n\r\nIt is on our roadmap to:\r\n    1) Enable dynamic configuration of a multi-node cluster via the tctl tool (e.g. enabling you to add search attributes on the fly)\r\n    2) To support removing search attribute keys (which was another question you also asked). This is also currently not possible.\r\n\r\nLet us know if we can provide any further clarifications here or provide other assistance.\r\n","createdAt":"2020-07-08T23:58:37Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-655817513","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NTg4NDk3NQ==","author":{"login":"pauldemarco"},"authorAssociation":"NONE","body":"@mastermanu  Correct, I am using the official Temporal helm chart and deploying to a dev server running kubernetes.\r\n\r\n\r\nI've added the dynamicConfigClient to the configmap and re-deployed: https://github.com/pauldemarco/temporal-helm-charts/commit/bae60f73a445c19aa5791b6221893042369c7af7\r\n\r\nI verified it shows up by running the following on temporal-frontend pod:\r\n`bash-5.0# cat /etc/temporal/config/docker.yaml`\r\n\r\nI can now also successfully register a new key on the admin-tools pod:\r\n```\r\nbash-5.0# tctl --namespace default adm cl asa --search_attr_key UserID --search_attr_type 2\r\nAre you trying to add key [UserID] with Type [Int]? Y/N y\r\n\r\nSuccess\r\n```\r\n\r\nI am still however receiving errors when running the workflow:\r\n![image](https://user-images.githubusercontent.com/16725750/86995390-e32e8580-c176-11ea-8d2f-6dc4e8b61898.png)\r\n\r\nReading out the file `bash-5.0# cat /etc/temporal/config/dynamicconfig/development_es.yaml ` shows the new key added only for the pod where `tctl` was run, like you mentioned.\r\n\r\nAt this point, it seems I need to include this custom **development_es.yaml** file with startup. I haven't yet had to customize the temporal server image that I use with the helm chart, and I'm not exactly sure how. I usually just increment the version number (currently 0.26.0). Any suggestions?","createdAt":"2020-07-09T04:03:04Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-655884975","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NjE1NjQxMw==","author":{"login":"flossypurse"},"authorAssociation":"CONTRIBUTOR","body":"The docs have been updated to reflect @mastermanu's change for adding a new **search-attr-type** via CLI: http://docs.temporal.io/docs/learn-workflow-filtering/#allow-listing-search-attributes","createdAt":"2020-07-09T14:19:44Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-656156413","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NjI1MDI2Mw==","author":{"login":"mastermanu"},"authorAssociation":"MEMBER","body":"Hey @pauldemarco,\r\n\r\nYou would do the following:\r\n\r\n 1) Clone the temporal repo\r\n```\r\ngit clone git@github.com/temporalio/temporal\r\ngit checkout v0.26.0\r\n```\r\n\r\n 2) Update the deployment_es.yaml and schema/elasticsearch/visibility/index_template.json files with the properties you want to search for\r\n\r\n3) Run\r\n```\r\nmake docker-images\r\n```\r\n\r\n4) Commit / tag that built server image (https://www.scalyr.com/blog/create-docker-image/)\r\n \r\n5) Upload the image to your repository dockerhub (https://ropenscilabs.github.io/r-docker-tutorial/04-Dockerhub.html)\r\n\r\n6) Change the helm values.yaml file (https://github.com/temporalio/helm-charts/blob/master/values.yaml) under the \"server/image\" section to point to your repository in DockerHub (or you can override using the --set command line option on helm install command)\r\n\r\n7) Deploy the helm chart.\r\n\r\n_NOTE: Steps updated based on outcome of discussion below_\r\n\r\n","createdAt":"2020-07-09T17:17:46Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-656250263","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NjI3MzA0Mw==","author":{"login":"mastermanu"},"authorAssociation":"MEMBER","body":"FYI, we will try and make the injection of dynamic configuration more seamless as well so that you don't have to create a custom image as has been outlined above. For now, the above steps should unblock you for experimentation purposes though.","createdAt":"2020-07-09T18:07:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-656273043","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NjMwMTk4OQ==","author":{"login":"pauldemarco"},"authorAssociation":"NONE","body":"Thanks for the writeup. I had to pull down **docker-compose-es.yml** instead of the default in step 1 since it was erroring during the tctl command, stating something about visibility not enabled. I created the image here after registering my custom keys: https://hub.docker.com/layers/pauldemarco/paul_temporal/paul_temporal/images/sha256-398e7f7e36fb67fee888b3c50d8bb63d049c2014bc679b8973d859ff16b12dcb?context=repo\r\n\r\nI've pointed the helm chart to my custom image and deployed to kubernetes.\r\n\r\nAll services come up successfully:\r\n![image](https://user-images.githubusercontent.com/16725750/87081336-2e887880-c1f7-11ea-81a7-6d232240f4d0.png)\r\n\r\nI can shell into temporal-frontend and verify the development_es.yaml contains my custom keys:\r\n```\r\nbash-5.0# cat /etc/temporal/config/dynamicconfig/development_es.yaml \r\nfrontend.enableClientVersionCheck:\r\n- value: true\r\n  constraints: {}\r\nfrontend.validSearchAttributes:\r\n- value:\r\n    BinaryChecksums: Keyword\r\n    CloseTime: Int\r\n    CustomBoolField: Bool\r\n    CustomDatetimeField: Datetime\r\n    CustomDoubleField: Double\r\n    CustomIntField: Int\r\n    CustomKeywordField: Keyword\r\n    CustomNamespace: Keyword\r\n    CustomStringField: String\r\n    ExecutionTime: Int\r\n    HistoryLength: Int\r\n    NamespaceId: Keyword\r\n    Operator: Keyword\r\n    Payload: 1\r\n    RolloutId: Keyword\r\n    RunId: Keyword\r\n    StartTime: Int\r\n    Status: Int\r\n    TaskQueue: Keyword\r\n    TemporalChangeVersion: Keyword\r\n    UserID: 2\r\n    WorkflowId: Keyword\r\n    WorkflowType: Keyword\r\n    addon: Keyword\r\n    addon-type: Keyword\r\n    environment: Keyword\r\n    project: Keyword\r\n    service: Keyword\r\n    user: Keyword\r\n  constraints: {}\r\nsystem.advancedVisibilityWritingMode:\r\n- value: \"on\"\r\n  constraints: {}\r\nsystem.enableReadVisibilityFromES:\r\n- value: true\r\n  constraints: {}\r\nsystem.minRetentionDays:\r\n- value: 0\r\n  constraints: {}\r\n```\r\n\r\nTemporal-web is now showing this error message:\r\n![image](https://user-images.githubusercontent.com/16725750/87080779-41e71400-c1f6-11ea-8515-b7c66dc8d6c2.png)\r\n\r\nChecking the logs for temporal-frontend show the following spam:\r\n```\r\n+ cqlsh --cqlversion=3.4.4 cassandra\r\nConnection error: ('Unable to connect to any servers', {'92.242.140.21:9042': error(None, \"Tried connecting to [('92.242.140.21', 9042)]. Last error: timed out\")})\r\n+ echo 'waiting for cassandra to start up'\r\nwaiting for cassandra to start up\r\n+ sleep 1\r\n+ cqlsh --cqlversion=3.4.4 cassandra\r\nConnection error: ('Unable to connect to any servers', {'92.242.140.21:9042': error(None, \"Tried connecting to [('92.242.140.21', 9042)]. Last error: timed out\")})\r\n+ echo 'waiting for cassandra to start up'\r\n+ sleep 1\r\nwaiting for cassandra to start up\r\n+ cqlsh --cqlversion=3.4.4 cassandra\r\nConnection error: ('Unable to connect to any servers', {'92.242.140.21:9042': error(None, \"Tried connecting to [('92.242.140.21', 9042)]. Last error: timed out\")})\r\n+ echo 'waiting for cassandra to start up'\r\n+ sleep 1\r\nwaiting for cassandra to start up\r\n+ cqlsh --cqlversion=3.4.4 cassandra\r\n```\r\n\r\nIs it possible when I created the docker image it somehow \"snapshotted\" incorrect connection info for cassandra?\r\n\r\nI should mention that if I revert the helm chart image back to temporalio/server@0.26.0 there are no connection issues.\r\n\r\n**Update:** I attempted Step 1 again using _docker-compose.yml_ and bypassing tctl by directly modifying development_es.yaml. I created the image here: https://hub.docker.com/layers/pauldemarco/paul_temporal/latest/images/sha256-58e5e8f3458dddd061ed257d2d31e0ecbbf214f8af387dcd21c17c78d0bd0867?context=repo\r\nI still receive the same connection issues to cassandra.","createdAt":"2020-07-09T19:11:36Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-656301989","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NjMzNDUzNA==","author":{"login":"mastermanu"},"authorAssociation":"MEMBER","body":"Can you paste the startup logs for the temporal-frontend along with the config_template.yaml and docker.yaml file that is in that pod's configuration directory?\r\n\r\nAlso, I assume if you switch back to a \"regular\" image, then this problem goes away? We can compare the docker.yaml file from a functional deployment and a non-functional one to see what the difference might be here.\r\n\r\n@markmark206 might also be able to provide better insight here as he is a bigger expert in this area :)","createdAt":"2020-07-09T20:26:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-656334534","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NjM4MjM5OQ==","author":{"login":"pauldemarco"},"authorAssociation":"NONE","body":"> Can you paste the startup logs for the temporal-frontend along with the config_template.yaml and docker.yaml file that is in that pod's configuration directory?\r\n\r\nIf the below guide is way off, or you feel it would still be constructive for me to supply this info, let me know.\r\n\r\n> Also, I assume if you switch back to a \"regular\" image, then this problem goes away? We can compare the docker.yaml file from a functional deployment and a non-functional one to see what the difference might be here.\r\n\r\nCorrect.\r\n\r\n### Setting up custom search attributes\r\n\r\nThese are the steps that I've taken to get everything up and running:\r\n\r\n1. Clone the temporal repo\r\n```\r\ngit clone git@github.com/temporalio/temporal\r\ngit checkout v0.26.0\r\n```\r\n\r\n2. Add the custom keys to config/dynamicconfig/development_es.yaml\r\n```\r\nfrontend.enableClientVersionCheck:\r\n  - value: true\r\nsystem.advancedVisibilityWritingMode:\r\n  - value: \"on\"\r\nsystem.enableReadVisibilityFromES:\r\n  - value: true\r\nfrontend.validSearchAttributes:\r\n  - value:\r\n      NamespaceId: \"Keyword\"\r\n      WorkflowId: \"Keyword\"\r\n      RunId: \"Keyword\"\r\n      WorkflowType: \"Keyword\"\r\n      StartTime: \"Int\"\r\n      ExecutionTime: \"Int\"\r\n      CloseTime: \"Int\"\r\n      Status: \"Int\"\r\n      HistoryLength: \"Int\"\r\n      TaskQueue: \"Keyword\"\r\n      CustomStringField: \"String\"\r\n      CustomKeywordField: \"Keyword\"\r\n      CustomIntField: \"Int\"\r\n      CustomDoubleField: \"Double\"\r\n      CustomBoolField: \"Bool\"\r\n      CustomDatetimeField: \"Datetime\"\r\n      project: \"Keyword\"\r\n      service: \"Keyword\"\r\n      environment: \"Keyword\"\r\n      addon: \"Keyword\"\r\n      addon-type: \"Keyword\"\r\n      user: \"Keyword\"\r\n      CustomNamespace: \"Keyword\"\r\n      Operator: \"Keyword\"\r\n      RolloutId: \"Keyword\"\r\n      TemporalChangeVersion: \"Keyword\"\r\n      BinaryChecksums: \"Keyword\"\r\n      UserID: \"Keyword\"\r\nsystem.minRetentionDays:\r\n    - value: 0\r\n```\r\n\r\n3. Build the docker images\r\n```\r\nmake docker-images\r\n```\r\n\r\n4. Tag and push to docker hub\r\n```\r\ndocker images\r\ndocker tag 3a6eef54b87a pauldemarco/paul_temporal:0.26.0-config2\r\ndocker push pauldemarco/paul_temporal\r\n```\r\n\r\n5. Update the helm chart to point to this new image (values.yaml)\r\n```\r\nserver:\r\n  enabled: true\r\n  image:\r\n    repository: pauldemarco/paul_temporal\r\n    tag: 0.26.0-config2\r\n    pullPolicy: IfNotPresent\r\n```\r\n\r\n6. Redeploy the helm chart\r\n```\r\nhelm -n temporal install temporal . --timeout 900s\r\n```\r\n\r\n### Issue: custom keys returns zero results\r\n\r\nAt this point everything is starting properly and I'm able to successfully upsert attributes from workflows:\r\n![image](https://user-images.githubusercontent.com/16725750/87096473-ed04c700-c210-11ea-8dde-9a938f8b2c65.png)\r\n\r\nUnfortunately, performing any queries for my custom keys returns zero results. I've even set CustomKeywordField and UserID to the same value in my go code:\r\n```\r\nattr := map[string]interface{}{\r\n\t\t\"UserID\":             \"user1234\",\r\n\t\t\"CustomKeywordField\": \"user1234\",\r\n\t}\r\n```\r\n`tctl --ns default wf list -q 'CustomKeywordField=\"user1234\"'`\r\nReturns results.\r\n`tctl --ns default wf list -q 'UserID=\"user1234\"'`\r\nReturns zero results.\r\n\r\nI'm stumped again, sorry!\r\n","createdAt":"2020-07-09T22:31:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-656382399","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NjQ0MjI0MQ==","author":{"login":"mastermanu"},"authorAssociation":"MEMBER","body":"Hey Paul,\r\n\r\nFirst of all, the way of building the docker image is much preferred over that short-cut I mentioned earlier. Thanks for pointing this out...I will update my answer to incorporate your suggestion to just clone the repo and build directly.\r\n\r\nSecondly, I forgot one more vital step: In addition to updating the development_es.yaml file, you also have to update the schema/elasticsearch/visibility/index_template.json file so that it actually adds the index to the Elastic Search cluster when the Temporal server boots up. I went ahead and added a key/value pair \"UserID\" : { \"type\": {\"keyword\"} to the properties dictionary under \"Attr\" and tested locally, and after that, I was able to query workflows using the property.\r\n\r\nSo TL;DR, it looks like there are TWO files that have to be customized on the server image:\r\n\r\ndevelopment_es.yaml\r\nschema/elasticsearch/visibility/index_template.json\r\n\r\nReally sorry for the inconvenience here. That should fix it, and we'll look to make this clearer via documentation and have a more seamless way to configure these types of things in the future.","createdAt":"2020-07-10T02:15:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-656442241","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY1NjcyMjM4OA==","author":{"login":"pauldemarco"},"authorAssociation":"NONE","body":"That did the trick!\r\n\r\n> have a more seamless way to configure these types of things in the future.\r\n\r\nYes, although currently fine for experimentation, having to recompile the image to add a elasticsearch attribute is a bit of a pain, especially during development where these are constantly changing.  It would be great if these could be changed either on the fly through tctl, or getting some first class Kubernetes support through a configmap or volume mount.\r\n\r\nThanks a bunch for the help Manu!\r\n\r\n(Feel free to close this issue)","createdAt":"2020-07-10T15:02:45Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-656722388","viewerDidAuthor":false},{"id":"IC_kwDODNqesM42YVLe","author":{"login":"johanforssell"},"authorAssociation":"NONE","body":"If you happen to find this issue today, this is no longer relevant (might be obvious, I don't know).\r\nAs per https://github.com/temporalio/temporal/issues/1442#issuecomment-878705053 and https://docs.temporal.io/docs/server/workflow-search#local-testing, you have to use tctl now.","createdAt":"2021-09-03T08:10:13Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/505#issuecomment-912347870","viewerDidAuthor":false}],"createdAt":"2020-07-07T22:11:44Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":505,"reactionGroups":[],"state":"CLOSED","title":"Error: Add search attribute failed","updatedAt":"2021-09-03T08:10:40Z","url":"https://github.com/temporalio/temporal/issues/505"}
