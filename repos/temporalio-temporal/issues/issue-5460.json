{"assignees":[],"author":{"id":"MDQ6VXNlcjEyNjUxMzUx","is_bot":false,"login":"abhimanyusinghgaur","name":"Abhimanyu Singh Gaur"},"body":"## Actual Behavior\r\nWe have a workflow with the following query handler:\r\n```\r\nvar state = &models.Execution{ ... }\r\nqueryHandler := func() (*models.Execution, error) { return state, nil }\r\nif err := workflow.SetQueryHandler(ctx, \"status\", queryHandler); err != nil {\r\n\treturn err\r\n}\r\n\r\n// state gets updated later as workflow progresses\r\n```\r\nThe `models.Execution` looks like this:\r\n```\r\ntype Execution struct {\r\n\tID           string             `gorm:\"column:id;primaryKey;type:uuid;not null\"`\r\n\tType         v1.ExecutionType   `gorm:\"column:type;type:smallint;not null\"`\r\n\tInput        string             `gorm:\"column:input;not null\"`\r\n\tSchema       *string            `gorm:\"column:schema\"`\r\n\tNumberOfRows *int32             `gorm:\"column:number_of_rows\"`\r\n\tSizeInBytes  *int32             `gorm:\"column:size_in_bytes\"`\r\n\tStatus       v1.ExecutionStatus `gorm:\"column:status;type:smallint;not null\"`\r\n\tError        *string            `gorm:\"column:error;type:text\"`\r\n\tCreatedBy    string             `gorm:\"column:created_by;not null\"`\r\n\tCreatedAt    time.Time          `gorm:\"column:created_at;not null\"`\r\n\tStartedAt    *time.Time         `gorm:\"column:started_at\"`\r\n\tFinishedAt   *time.Time         `gorm:\"column:finished_at\"`\r\n}\r\n```\r\nThe problem is with `StartedAt` and `FinishedAt` fields. `StartedAt` is set at the very beginning of the workflow, and `FinishedAt` is set the end of the workflow.\r\n\r\nWhile the workflow is running, we get the following response from the query:\r\n```\r\n{\r\n    \"type\": \"...\",\r\n    \"input\": \"...\",\r\n    \"schema\": \"...\",\r\n    \"status\": \"...\",\r\n    \"createdBy\": \"...\",\r\n    \"createdAt\": \"2024-02-21T21:08:39.667Z\",\r\n    \"startedAt\": \"2024-02-21T21:08:39.710Z\",\r\n    \"finishedAt\": null\r\n}\r\n```\r\nAs you can see, the `startedAt` is just some milliseconds after `createdAt`. That's expected.\r\nOnce the workflow has finished, we get this response from the query:\r\n```\r\n{\r\n    \"type\": \"...\",\r\n    \"input\": \"...\",\r\n    \"schema\": \"...\",\r\n    \"numberOfRows\": ...,\r\n    \"sizeInBytes\": ...,\r\n    \"status\": \"...\",\r\n    \"createdBy\": \"...\",\r\n    \"createdAt\": \"2024-02-21T21:08:39.667Z\",\r\n    \"startedAt\": \"2024-02-21T21:08:51.663Z\",\r\n    \"finishedAt\": \"2024-02-21T21:08:51.663Z\"\r\n}\r\n```\r\nHere you see that `startedAt` suddenly becomes exactly same as `finishedAt`. That's completely weird!\r\n\r\nWe have rechecked this multiple times in our codebase, and we are not doing any silly pointer mistakes here. We were even saving the `Execution` struct into our own postgres instance at the end of workflow, and there the values are completely correct. The values in our postgres instance are:\r\n```\r\nstartedAt: \"2024-02-21T21:08:39.710Z\"\r\nfinishedAt: \"2024-02-21T21:08:51.663Z\"\r\n```\r\nSo, it seems that temporal query isn't able to retrieve the values it stores for completed workflows correctly. Some problem with either unmarshalling its stored query response payload for completed workflows or marshalling the query response payload before temporal stores it.\r\n\r\n### More observations\r\n* Everytime I call that temporal query, the values for `startedAt` and `finishedAt` turn out to be the latest local time on my machine. That is even weirder. The way we are initializing those values is this:\r\n```\r\nfunc NowFunc() time.Time {\r\n\treturn time.UnixMilli(time.Now().UnixMilli()).Local()\r\n}\r\n\r\nfunc NowFuncPtr() *time.Time {\r\n\tnow := NowFunc()\r\n\treturn &now\r\n}\r\n\r\n// initial initialization at start of workflow\r\nstate := &models.Execution{\r\n\t\tID:        ...,\r\n\t\tCreatedBy: ...,\r\n\t\tCreatedAt: params.CreatedAt,\r\n\t\tStartedAt: NowFuncPtr(),\r\n\t\tType:      ...,\r\n\t\tStatus: ...,\r\n\t}\r\n\r\n// later when workflow is finished, we do this:\r\nstate.FinishedAt = NowFuncPtr()\r\n```\r\nSo, once set within workflow, the values should not have changed. But, they seem to be changing on every call to the query handler. I have verified even their pointer addresses:\r\n```\r\n\"startedAtPtr\": \"0xc000e4ec60\", \"finishedAtPtr\": \"0xc000e4ede0\"\r\n```\r\nthey are indeed two different memory locations, but the values still turn out to be the same and the latest time on my machine.\r\n\r\n## Expected Behavior\r\nTemporal query should return correct values. i.e., in our case, the `startedAt` and `finishedAt` fields should not have changed at all.\r\n\r\n## Specifications\r\n\r\n  - Version: docker image - `temporalio/server:1.22.4`\r\n  - Platform: \r\n    - Go: `go version go1.21.5` (don't think this would matter)\r\n    - OS: Doesn't matter, happens on both mac or linux.\r\n","closedAt":"2024-03-19T22:47:54Z","comments":[{"id":"IC_kwDODNqesM52YWRg","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"This is a bug in your workflow code, you should not be using `time.Now` in workflow code since the result is not deterministic across [replay](https://docs.temporal.io/workflows#replays). You need to use [workflow.Now](https://pkg.go.dev/go.temporal.io/sdk/workflow#Now) inside workflows.","createdAt":"2024-03-08T17:17:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5460#issuecomment-1986094176","viewerDidAuthor":false},{"id":"IC_kwDODNqesM53tBsi","author":{"login":"abhimanyusinghgaur"},"authorAssociation":"NONE","body":"Thanks, that fixed it. It is not a bug in temporal.","createdAt":"2024-03-19T22:47:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5460#issuecomment-2008292130","viewerDidAuthor":false}],"createdAt":"2024-02-28T12:24:54Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":5460,"reactionGroups":[],"state":"CLOSED","title":"Temporal query reporting wrong value","updatedAt":"2024-03-19T22:47:54Z","url":"https://github.com/temporalio/temporal/issues/5460"}
