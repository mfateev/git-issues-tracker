{"assignees":[{"id":"MDQ6VXNlcjIyMzI1MjQ=","login":"alexshtin","name":"Alex Shtin","databaseId":0}],"author":{"id":"MDQ6VXNlcjYxNTY4","is_bot":false,"login":"GreyTeardrop","name":"Mykola Rybak"},"body":"## Description\r\n\r\nLooking at some scripts at this repository and at the Helm chart, it all expects Elasticsearch indexes to be found at `schema/elasticsearch/visibility/index_template_{elastic_version}.json`. However, the Docker images published to the Docker hub have it at `schema/elasticsearch/{elastic_version}/visibility/index_template.json`.\r\n\r\n```\r\n$ docker run  -it --rm --entrypoint '/bin/bash'  temporalio/admin-tools:1.10.5 -c 'apk add tree >/dev/null 2>&1 && tree -D schema/elasticsearch'\r\nschema/elasticsearch\r\n├── [Jun 24 22:24]  v6\r\n│   └── [Jun 24 22:24]  visibility\r\n│       └── [Jun 24 22:24]  index_template.json\r\n└── [Jun 24 22:24]  v7\r\n    └── [Jun 24 22:24]  visibility\r\n        └── [Jun 24 22:24]  index_template.json\r\n\r\n4 directories, 2 files\r\n```\r\n\r\nOddly enough, the image built directly from the repo has it at the expected location\r\n\r\n```\r\n$ docker build . -t temporalio/admin-tools:local --build-arg TARGET=admin-tools\r\n...\r\n$ docker run  -it --rm --entrypoint '/bin/bash'  temporalio/admin-tools:local -c 'apk add tree >/dev/null 2>&1 && tree -D schema/elasticsearch'\r\nschema/elasticsearch\r\n└── [Jul  2 13:52]  visibility\r\n    ├── [Jun 25 15:59]  index_template_v6.json -> versioned/v1/index_template_v6.json\r\n    ├── [Jun 25 15:59]  index_template_v7.json -> versioned/v1/index_template_v7.json\r\n    └── [Jul  2 13:52]  versioned\r\n        ├── [Jul  2 13:52]  v0\r\n        │   ├── [Jun 15 11:12]  index_template_v6.json\r\n        │   └── [Jun 15 11:12]  index_template_v7.json\r\n        └── [Jul  2 13:52]  v1\r\n            ├── [Jun 25 15:59]  index_template_v6.json\r\n            ├── [Jun 25 15:59]  index_template_v7.json\r\n            ├── [Jun 25 15:59]  reindex.json\r\n            ├── [Jun 25 15:59]  reindex.painless\r\n            └── [Jun 25 15:59]  reindex.sh\r\n\r\n4 directories, 9 files\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Deploy new Temporal cluster via official Helm chart, with Elasticsearch enabled\r\n  2. Watch that the `es-index-setup` job logs warnings saying it can't find `index_template_v7.json` and then Elasticsearch responds to curls saying that POST body is required.\r\n\r\n**Note**: this might as well be an issue with the Helm chart, but looking at the scripts at this repository, it also seems to refer to `schema/elasticsearch/visibility/index_template_{elastic_version}.json`, so I thought the Helm chart is fine, it's just \r\n\r\n## Specifications\r\n\r\n  - Version: 1.10.3, latest master; seems to be the case for images since 1.6.0\r\n\r\n","closedAt":"2021-07-02T22:43:30Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg3MzI4OTQ3OQ==","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"Yes, directory structure was changed recently and `master` on this repo should match `master` on https://github.com/temporalio/helm-charts repo. To run latest server release docker image you should use [this commit](https://github.com/temporalio/helm-charts/commit/803035f5dfeb07191b1563c118d4340a8ff0aa2a) in a helm-chart repo.","createdAt":"2021-07-02T22:43:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1702#issuecomment-873289479","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg3MzM3MzAyOA==","author":{"login":"GreyTeardrop"},"authorAssociation":"NONE","body":"Hey @alexshtin, sorry for the potential confusion. I was using the latest `master` commit of the Helm chart and was deploying the latest Temporal server release (1.10.5). \r\n\r\n**Update**: I have initially misunderstood your message. Looking at the exact commit you've mentioned (version 1.10.1 of the chart) it seems like it indeed seems to match the structure of the server image 1.10.5. I was confused at first as there were several more released in of the chart which I assumed were matching corresponding server releases.\r\n\r\nThank you! So, to clarify/summarize, do I understand it correctly that\r\n* Temporal server image 1.10.5 requires Helm chart 1.10.1 to deploy\r\n* Helm chart 1.10.5 has some incompatibilities with the server images 1.10.5 and targets the latest `master` of the server\r\n* The latest Helm chart release should match the upcoming stable server version (1.10.6 or 1.11.0)","createdAt":"2021-07-03T08:58:12Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1702#issuecomment-873373028","viewerDidAuthor":false}],"createdAt":"2021-07-02T14:24:38Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":1702,"reactionGroups":[],"state":"CLOSED","title":"admin-tools Docker images from Dockerhub have Elasticsearch schemas at a wrong place","updatedAt":"2021-07-03T19:30:18Z","url":"https://github.com/temporalio/temporal/issues/1702"}
