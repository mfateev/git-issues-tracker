{"assignees":[],"author":{"id":"MDQ6VXNlcjE2MTY2Mjg=","is_bot":false,"login":"Tarang","name":"Tarang"},"body":"### What are you really trying to do?\r\n\r\nI am trying to create a workflow that can respond to cancellations gracefully, by waiting for either a timeout or cancellation, whichever is first. Afterwards if there is a cancellation to skip the last activity. I use a disconnected context to allow the timer to continue despite the cancellation, since it has to wait on additional work first.\r\n\r\nThe expected behaviour is the workflow finishes and skips the last activity.\r\n\r\n### Describe the bug\r\n\r\nThe workflow fails with \r\n`BadRequestCancelActivityAttributes: invalid history builder state for action: add-activitytask-cancel-requested-event`\r\n\r\n### Minimal Reproduction\r\n\r\nUse temporalite as a server\r\n\r\nUse the `cancellation` example from samples-go with the following workflow code instead\r\n\r\n1. Start worker\r\n2. Run starter\r\n3. Run cancellation\r\n\r\nThe key thing is using a disconnected context to control the timer.\r\n\r\nWorkflow.go\r\n\r\n\r\n```\r\npackage cancellation\r\n\r\nimport (\r\n\t\"errors\"\r\n\t\"fmt\"\r\n\t\"time\"\r\n\r\n\t\"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\n// @@@SNIPSTART samples-go-cancellation-workflow-definition\r\n// YourWorkflow is a Workflow Definition that shows how it can be canceled.\r\nfunc YourWorkflow(ctx workflow.Context) error {\r\n\tao := workflow.ActivityOptions{\r\n\t\tStartToCloseTimeout: 30 * time.Minute,\r\n\t\tHeartbeatTimeout:    5 * time.Second,\r\n\t\tWaitForCancellation: true,\r\n\t}\r\n\tctx = workflow.WithActivityOptions(ctx, ao)\r\n\tlogger := workflow.GetLogger(ctx)\r\n\tlogger.Info(\"cancel workflow started\")\r\n\tdefer func() {\r\n\r\n\t\tif !errors.Is(ctx.Err(), workflow.ErrCanceled) {\r\n\t\t\treturn\r\n\t\t}\r\n\r\n\t\t// When the Workflow is canceled, it has to get a new disconnected context to execute any Activities\r\n\t\tnewCtx, _ := workflow.NewDisconnectedContext(ctx)\r\n\t\terr := workflow.ExecuteActivity(newCtx, CleanupActivity).Get(ctx, nil)\r\n\t\tif err != nil {\r\n\t\t\tlogger.Error(\"CleanupActivity failed\", \"Error\", err)\r\n\t\t}\r\n\t}()\r\n\r\n\t//Create selector\r\n\ts := workflow.NewSelector(ctx)\r\n\r\n\tnewCtx, _ := workflow.NewDisconnectedContext(ctx)\r\n\tnewCtx, cancel := workflow.WithCancel(newCtx)\r\n\r\n\ttimer1 := workflow.NewTimer(newCtx, 5*time.Minute)\r\n\r\n\ts.AddFuture(timer1, func(f workflow.Future) {\r\n\t\tfmt.Println(\"Timer Cancelled\")\r\n\t})\r\n\r\n\ts.AddReceive(ctx.Done(), func(c workflow.ReceiveChannel, more bool) {\r\n\t\tc.Receive(ctx, nil)\r\n\t\tcancel()\r\n\t\ts.Select(ctx)\r\n\t})\r\n\r\n\ts.Select(ctx)\r\n\r\n\tvar result string\r\n\terr := workflow.ExecuteActivity(ctx, ActivityToBeCanceled).Get(ctx, &result)\r\n\tlogger.Info(fmt.Sprintf(\"ActivityToBeCanceled returns %v, %v\", result, err))\r\n\r\n\treturn nil\r\n}\r\n\r\n```\r\n\r\nmain.go\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"log\"\r\n\r\n\t\"go.temporal.io/sdk/client\"\r\n\t\"go.temporal.io/sdk/worker\"\r\n\r\n\t\"github.com/temporalio/samples-go/cancellation\"\r\n)\r\n\r\n// @@@SNIPSTART samples-go-cancellation-worker-starter\r\nfunc main() {\r\n\t// The client and worker are heavyweight objects that should be created once per process.\r\n\tc, err := client.Dial(client.Options{\r\n\t\tHostPort: client.DefaultHostPort,\r\n\t})\r\n\tif err != nil {\r\n\t\tlog.Fatalln(\"Unable to create client\", err)\r\n\t}\r\n\tdefer c.Close()\r\n\r\n\tw := worker.New(c, \"cancel-activity\", worker.Options{})\r\n\r\n\tw.RegisterWorkflow(cancellation.YourWorkflow)\r\n\tw.RegisterActivity(cancellation.ActivityToBeSkipped)\r\n\tw.RegisterActivity(cancellation.ActivityToBeCanceled)\r\n\tw.RegisterActivity(cancellation.CleanupActivity)\r\n\r\n\terr = w.Run(worker.InterruptCh())\r\n\tif err != nil {\r\n\t\tlog.Fatalln(\"Unable to start worker\", err)\r\n\t}\r\n}\r\n\r\n// @@@SNIPEND\r\n\r\n```\r\n\r\nactivity.go\r\n```\r\npackage cancellation\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"time\"\r\n\r\n\t\"go.temporal.io/sdk/activity\"\r\n)\r\n\r\n// @@@SNIPSTART samples-go-cancellation-activity-definition\r\n\r\nfunc ActivityToBeCanceled(ctx context.Context) (string, error) {\r\n\tlogger := activity.GetLogger(ctx)\r\n\tlogger.Info(\"activity started, to cancel the Workflow Execution, use 'go run cancellation/cancel/main.go \" +\r\n\t\t\"-w <WorkflowID>' or use the CLI: 'tctl wf cancel -w <WorkflowID>'\")\r\n\tfor {\r\n\t\tselect {\r\n\t\tcase <-time.After(1 * time.Second):\r\n\t\t\tlogger.Info(\"heartbeating...\")\r\n\t\t\tactivity.RecordHeartbeat(ctx, \"\")\r\n\t\tcase <-ctx.Done():\r\n\t\t\tlogger.Info(\"context is cancelled\")\r\n\t\t\treturn \"I am canceled by Done\", nil\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunc CleanupActivity(ctx context.Context) error {\r\n\tlogger := activity.GetLogger(ctx)\r\n\tlogger.Info(\"Cleanup Activity started\")\r\n\treturn nil\r\n}\r\n\r\nfunc ActivityToBeSkipped(ctx context.Context) error {\r\n\tlogger := activity.GetLogger(ctx)\r\n\tlogger.Info(\"this Activity will be skipped due to cancellation\")\r\n\treturn nil\r\n}\r\n\r\n// @@@SNIPEND\r\n\r\n```\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: M1 Mac\r\n- Temporal Version: Temporalite with temporalite version (devel) (server 1.19.1)\r\n\r\n### Additional context\r\n\r\n<img width=\"1613\" alt=\"Screenshot 2023-07-22 at 11 03 21â€¯pm\" src=\"https://github.com/temporalio/samples-go/assets/1616628/74b758ea-0f5d-452e-ac89-d1ce8fd2d9bb\">\r\n","closedAt":"2023-10-06T00:23:16Z","comments":[{"id":"IC_kwDODNqesM5iugXW","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"Duplicate of https://github.com/temporalio/sdk-go/issues/1176 which seems to be fixed in https://github.com/temporalio/sdk-go/pull/1181.","createdAt":"2023-07-28T21:37:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4673#issuecomment-1656358358","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5oTDw8","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Should be fixed by the linked sdk PR.","createdAt":"2023-10-06T00:23:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4673#issuecomment-1749826620","viewerDidAuthor":false}],"createdAt":"2023-07-23T06:30:52Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4673,"reactionGroups":[],"state":"CLOSED","title":"BadRequestCancelActivityAttributes invalid history builder state for action","updatedAt":"2023-10-06T00:23:16Z","url":"https://github.com/temporalio/temporal/issues/4673"}
