{"assignees":[{"id":"MDQ6VXNlcjM3NzA0Nzg=","login":"yux0","name":"Yu Xia","databaseId":0}],"author":{"id":"MDQ6VXNlcjI5NjM1NA==","is_bot":false,"login":"hferentschik","name":"Hardy Ferentschik"},"body":"## Expected Behavior\r\n\r\nWe are trying to setup multi-cluster replication and for that purpose need to configure the `clusterMetadata` of the Temporal configuration. This is described [here](https://docs.temporal.io/references/configuration#clustermetadata). Specific to the rpcAddress the docs says:\r\n\r\n> rpcAddress - indicate the remote service address (host:port). Host can be DNS name. Use dns:/// prefix to enable round-robin between IP address for DNS name.\r\n\r\nWe are using this prefix everywhere where we create a gRPC client. In particular our workers connect via ` dns:///<service-address>:7233`. The reason to explicitly specify the dns resolver is that grpc-go deviates from the gRPC spec and does not use the dns resolver as default. See https://github.com/grpc/grpc-go/issues/3544#issuecomment-618689886. It uses a so called \"passthrough\" as default. If one wants to use dns, one needs to explicitly specify the resolver using `dns:///`.\r\n\r\nIt seems in most cases Temporal allows the use of the prefix, except for `clusterInformation.rpcAddress`.\r\n\r\n## Actual Behavior\r\n\r\nWhen configuring the `clusterInformation.rpcAddress` with something like  `dns:///<host>:7233` an error is returned when one tried to use cluster replication commands, for example `temporal operator cluster upsert` in order to establish a connection between two clusters. The returned error is:\r\n\r\n```\r\naddress dns:///myhost:7233: too many colons in address\r\n```\r\n\r\nSee also https://go.dev/play/p/9Rwow_gtcCF\r\n\r\nThe problem is that [RPCFactory#CreateRemoteFrontendGRPCConnection](https://github.com/temporalio/temporal/blob/e62c22f27cfae97956b9ebb75f178f55c99f3cee/common/rpc/rpc.go#L186-L203) uses `net.SplitHostPort` to extract the hostname from the configured rpcAddress in order to lookup the client config for the host.\r\n`net.SplitHostPort` cannot handle the `dns:///` prefix.\r\n\r\n```Go\r\nfunc (d *RPCFactory) CreateRemoteFrontendGRPCConnection(rpcAddress string) *grpc.ClientConn {\r\n\tvar tlsClientConfig *tls.Config\r\n\tvar err error\r\n\tif d.tlsFactory != nil {\r\n\t\thostname, _, err2 := net.SplitHostPort(rpcAddress)\r\n\t\tif err2 != nil {\r\n\t\t\td.logger.Fatal(\"Invalid rpcAddress for remote cluster\", tag.Error(err2))\r\n\t\t}\r\n\t\ttlsClientConfig, err = d.tlsFactory.GetRemoteClusterClientConfig(hostname)\r\n\r\n\t\tif err != nil {\r\n\t\t\td.logger.Fatal(\"Failed to create tls config for gRPC connection\", tag.Error(err))\r\n\t\t\treturn nil\r\n\t\t}\r\n\t}\r\n\r\n\treturn d.dial(rpcAddress, tlsClientConfig)\r\n}\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Use the `dns:///` prefix in the  `clusterInformation.rpcAddress` of the Temporal server in order to enforce the dns resolver in grpc-go\r\n  1. Use an operation which calls `CreateRemoteFrontendGRPCConnection`, eg try enabling a cluster connection between two clusters.\r\n  \r\n## Specifications\r\n\r\n  - Version: v1.22.7\r\n","closedAt":"2025-06-01T19:44:08Z","comments":[{"id":"IC_kwDODNqesM5-wwVk","author":{"login":"hferentschik"},"authorAssociation":"NONE","body":"Something like this https://go.dev/play/p/403gj5Zovy7 could work (assuming the port is mandatory):\r\n\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"fmt\"\r\n\t\"net\"\r\n\t\"net/url\"\r\n\t\"strings\"\r\n)\r\n\r\nfunc main() {\r\n\thost, err := hostname(\"myhost:7233\")\r\n\tfmt.Printf(\"host: %s, error: %v\\n\", host, err)\r\n\r\n\thost, err = hostname(\"dns:///myhost:7233\")\r\n\tfmt.Printf(\"host: %s, error: %v\\n\", host, err)\r\n}\r\n\r\nfunc hostname(rpcAddress string) (string, error) {\r\n\thostname, _, err := net.SplitHostPort(rpcAddress)\r\n\tif err != nil {\r\n\t\tgrpcUrl, parseErr := url.Parse(rpcAddress)\r\n\t\tif parseErr != nil {\r\n\t\t\treturn \"\", parseErr\r\n\t\t}\r\n\r\n\t\t// Check the host field, if set rpcAddress is in plain host:port format\r\n\t\t// If the host is not set the address specified a resolver, eg dns:///host:port.\r\n\t\t// In this case the address is in the path of the URL.\r\n\t\t// See https://github.com/grpc/grpc-go/blob/c8083227ee3181db60cf37005940e11865a572b4/resolver/resolver.go#L272-L288\r\n\t\taddress := grpcUrl.Host\r\n\t\tif address == \"\" {\r\n\t\t\taddress = grpcUrl.Path\r\n\t\t}\r\n\t\tif address == \"\" {\r\n\t\t\taddress = grpcUrl.Opaque\r\n\t\t}\r\n\r\n\t\taddress = strings.TrimPrefix(address, \"/\")\r\n\t\thostname, _, _ = net.SplitHostPort(address)\r\n\t\terr = nil\r\n\r\n\t}\r\n\treturn hostname, err\r\n}\r\n```\r\n\r\nAlternatively one could just use `strings.CutPrefix` to remove `dns:///`, but then that would only cover the single dns resolver. \r\n\r\nHappy to create/work on a PR if we can agree on the approach. Or maybe I am still missing something here?","createdAt":"2024-05-23T10:00:05Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5979#issuecomment-2126710116","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6Abz24","author":{"login":"hferentschik"},"authorAssociation":"NONE","body":"@yux0 wdyt? Did you have a chance to look at this?","createdAt":"2024-06-07T12:51:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5979#issuecomment-2154773944","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6L4u9b","author":{"login":"yux0"},"authorAssociation":"MEMBER","body":"This is merged. https://github.com/temporalio/temporal/pull/6430. The newClient should use dns by default.","createdAt":"2024-09-12T17:53:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/5979#issuecomment-2346905435","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6t_Glh","author":{"login":"robholland"},"authorAssociation":"MEMBER","body":"I think this can be closed then?","createdAt":"2025-05-29T10:37:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/5979#issuecomment-2919000417","viewerDidAuthor":false}],"createdAt":"2024-05-23T08:43:35Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":5979,"reactionGroups":[],"state":"CLOSED","title":"Unable to use dns:// prefix for clusterInformation.rpcAddress configuration","updatedAt":"2025-06-01T19:44:08Z","url":"https://github.com/temporalio/temporal/issues/5979"}
