{"assignees":[],"author":{"id":"MDQ6VXNlcjE1ODE3MjY=","is_bot":false,"login":"ajbeach2","name":"kanto-bot"},"body":"I am currently upgrading a temporal cluster from 1.9 -> 1.12 and search is no longer working. It seems that the ListClosedWorkflowExecutions query cannot be created. I created a brand new index and brand new namespaces in the upgraded cluster, and there are no workflows in this namespace.\r\n\r\n## Expected Behavior\r\nWorking Search\r\n\r\n## Actual Behavior\r\n<img width=\"1789\" alt=\"Screen Shot 2021-09-29 at 3 32 24 PM\" src=\"https://user-images.githubusercontent.com/1581726/135337815-c691aa26-d3ba-4a2b-9670-c3237e5dc777.png\">\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Spin up helm chart with version 1.12.1\r\n  2. Enable auto setup of ES\r\n  3. Observe Error\r\n\r\n## Specifications\r\n  - Version: 1.12.1, 1.11 for web\r\n  - ES version: Open Distro 7.10.2\r\n","closedAt":"2021-10-01T17:17:49Z","comments":[{"id":"IC_kwDODNqesM43dnSu","author":{"login":"ajbeach2"},"authorAssociation":"NONE","body":"It looks like the query changed? its now using a string instead of an int\r\n```go\r\n\r\n// old\r\nexecutionStatusQuery := elastic.NewBoolQuery().MustNot(elastic.NewMatchQuery(searchattribute.ExecutionStatus, int(enumspb.WORKFLOW_EXECUTION_STATUS_RUNNING)))\r\n\t\r\n//new\r\nboolQuery := elastic.NewBoolQuery().\r\n\t\tMustNot(elastic.NewTermQuery(searchattribute.ExecutionStatus, enumspb.WORKFLOW_EXECUTION_STATUS_RUNNING.String()))\r\n```\r\n\r\nhttps://github.com/temporalio/temporal/blob/master/common/persistence/visibility/store/elasticsearch/visibility_store.go#L254","createdAt":"2021-09-29T20:15:23Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1992#issuecomment-930509998","viewerDidAuthor":false},{"id":"IC_kwDODNqesM43d-bK","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"For any version below 1.11, you need to go through this manual process to upgrade to 1.11 first.\r\nhttps://github.com/temporalio/temporal/releases/tag/v1.11.2","createdAt":"2021-09-29T22:56:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1992#issuecomment-930604746","viewerDidAuthor":false},{"id":"IC_kwDODNqesM43h6Zk","author":{"login":"ajbeach2"},"authorAssociation":"NONE","body":"Thanks. I was able to resolve. I am maintaining a separate helm chart from the official in order to control the setup scripts and i have a job that creates the index mapping in the utils image.\r\n\r\n```\r\n  SCHEMA_FILE=${TEMPORAL_HOME}/schema/elasticsearch/visibility/index_template_${ES_VERSION}.json;\r\n  ES_SERVER=$(echo \"${ES_SEEDS}\" | awk -F ',' '{print $1}');\r\n  TEMPLATE_URL=\"${ES_SCHEME}://${ES_SERVER}:${ES_PORT}/_template/temporal_visibility_v1_template\";\r\n  INDEX_URL=\"${ES_SCHEME}://${ES_SERVER}:${ES_PORT}/${ES_VIS_INDEX}\";\r\n  curl --user \"${ES_USER}\":\"${ES_PWD}\" -X PUT \"${TEMPLATE_URL}\" -H 'Content-Type: application/json' --data-binary \"@${SCHEMA_FILE}\" --write-out \"\\n\";\r\n  curl --user \"${ES_USER}\":\"${ES_PWD}\" -X PUT \"${INDEX_URL}\" --write-out \"\\n\";\r\n  ```\r\n                ","createdAt":"2021-09-30T20:21:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1992#issuecomment-931636836","viewerDidAuthor":false}],"createdAt":"2021-09-29T19:46:51Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":1992,"reactionGroups":[],"state":"CLOSED","title":" ListClosedWorkflowExecutions failed. failed to create query: For input string: \"Running\"","updatedAt":"2021-10-01T17:17:49Z","url":"https://github.com/temporalio/temporal/issues/1992"}
