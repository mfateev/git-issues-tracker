{"assignees":[{"id":"MDQ6VXNlcjEzNzE0NjI0","login":"jmbarzee","name":"Jacob Barzee","databaseId":0}],"author":{"id":"MDQ6VXNlcjg5MTI2NA==","is_bot":false,"login":"aromanovich","name":"Anton Romanovich"},"body":"## Expected Behavior\r\nVisibility data is eventually consistent.\r\n\r\n## Actual Behavior\r\nIn some of our self-hosted clusters we observed occasional inconsistency between the primary and the advanced visibilty storages, e.g. completed workflows being listed as running in ListWorkflowExecutions response until they're deleted by the retention policy.\r\nI guess the same issue was reported by other Temporal users in [community](https://community.temporal.io/t/temporal-ui-not-displaying-correct-status-for-a-workflow/255) and [Slack](https://temporalio.slack.com/archives/CTRCR8RBP/p1709045810443349).\r\n\r\n## Steps to Reproduce the Problem\r\nAs far as I understand, the immediate queue implementation and its FIFO scheduler do not guarantee any particular order of tasks execution. A queue reader selects tasks in batch, and the scheduler dispatches them among multiple workers ([512 by default](https://github.com/temporalio/temporal/blob/d4876f204396d4b0ed11c9afea8529c147e94149/service/history/configs/config.go#L562) for visibility processor). And if a single task processing gets delayed (for any reason, could be the database or the workflow context being busy), tasks ahead could be executed and completed meanwhile.\r\n\r\nFor a single execution, transfer tasks are serialized by mutable state conditions and database concurrency control mechanisms; but visibility tasks seem to allow arbitrary order of execution, and the visibility storage doesn't implement any concurrency control.\r\n\r\n---\r\n\r\nhttps://github.com/temporalio/temporal/compare/main...aromanovich:temporal:visibility-race shows how this becomes an issue:\r\n`go test  . -persistenceType=sql -persistenceDriver=postgres12 -run 'AdvancedVisibilitySuite/TestVisibilityRace' -v` will fail when `SLOWDOWN_VISIBILITY_UPSERT=1` env var is set and succeed otherwise.\r\n\r\nThe test is very simple: it starts an execution, changes its search attributes and terminates it without any delays; then waits for some time and checks that the visibility data is consistent with the workflow state.\r\n`SLOWDOWN_VISIBILITY_UPSERT=1` [slows down](https://github.com/temporalio/temporal/compare/main...aromanovich:temporal:visibility-race#diff-a30852b700897cbb7fda15236f572355759a2b22c508af34e16bf4e7cedb83d6R236) UpsertExecutionVisibilityTask by one second, imitating an occasional persistence delay.\r\nThis delay causes UpsertExecutionVisibilityTask to succeed _after_ CloseExecutionVisibilityTask, which leaves the visibility data in an inconsistent state:\r\n\r\n```\r\n2024-04-02T00:19:01.581+0200\tinfo\tSleeping for 1 second\t{\"shard-id\": 2, \"address\": \"127.0.0.1:7231\", \"component\": \"visibility-queue-processor\", \"logging-call-at\": \"visibility_queue_task_executor.go:237\"}\r\n2024-04-02T00:19:01.602+0200\tinfo\tprocessCloseExecution\t{\"shard-id\": 2, \"address\": \"127.0.0.1:7231\", \"component\": \"visibility-queue-processor\", \"startedAt\": \"2024-04-01T22:19:01.600Z\", \"finishedAt\": \"2024-04-01T22:19:01.602Z\", \"logging-call-at\": \"visibility_queue_task_executor.go:256\"}\r\n2024-04-02T00:19:02.581+0200\tinfo\tFinished sleeping for 1 second\t{\"shard-id\": 2, \"address\": \"127.0.0.1:7231\", \"component\": \"visibility-queue-processor\", \"logging-call-at\": \"visibility_queue_task_executor.go:239\"}\r\n2024-04-02T00:19:02.585+0200\tinfo\tprocessUpsertExecution\t{\"shard-id\": 2, \"address\": \"127.0.0.1:7231\", \"component\": \"visibility-queue-processor\", \"startedAt\": \"2024-04-01T22:19:01.580Z\", \"finishedAt\": \"2024-04-01T22:19:02.585Z\", \"logging-call-at\": \"visibility_queue_task_executor.go:200\"}\r\n```\r\n\r\n## Specifications\r\n  - Version: 1.22.5\r\n  - Platform: All","closedAt":"2025-02-28T03:18:01Z","comments":[{"id":"IC_kwDODNqesM6QbpJq","author":{"login":"mattbrandman"},"authorAssociation":"NONE","body":"Just wanted to say I have seen this exact behavior as well. Was very confusing and worried that database updates may cause further issues like this when they have small amounts of downtime","createdAt":"2024-10-18T20:13:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5643#issuecomment-2423165546","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6VibhC","author":{"login":"dcaputo-harmoni"},"authorAssociation":"NONE","body":"We are experiencing this same issue with a mysql8 backend for both the primary and visibility db's, would love to see it addressed as the web ui dashboards become cluttered with incorrect information.  When clicking on the workflows, the correct status is shown on the details page.","createdAt":"2024-11-30T04:57:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5643#issuecomment-2508830786","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6V621F","author":{"login":"dcaputo-harmoni"},"authorAssociation":"NONE","body":"For anyone who is using mysql for visibility and would like a band aid fix for this problem, simply run:\r\n\r\n```\r\nUPDATE temporal_visibility.executions_visibility v\r\nJOIN temporal.current_executions t ON v.workflow_id = t.workflow_id AND v.run_id = BIN_TO_UUID(t.run_id)\r\nSET v.status = t.status, v.close_time = NOW(), v.execution_duration = CAST((NOW() - v.start_time) * 1000000000 AS SIGNED)\r\nWHERE v.status = 1 AND v.status <> t.status;\r\n```\r\nThis will bring your visibility workflow statuses back into sync with actual workflow statuses.\r\n\r\nOr if you'd like to simply see the out-of-sync visibility workflows, you can use this query:\r\n\r\n```\r\nSELECT v.workflow_id, v.status AS v_status, t.status AS t_status\r\nFROM temporal_visibility.executions_visibility v\r\nJOIN temporal.current_executions t ON v.workflow_id = t.workflow_id AND v.run_id = BIN_TO_UUID(t.run_id)\r\nWHERE v.status = 1 AND v.status <> t.status;\r\n```\r\n\r\n@jmbarzee let me know if I can help on the permanent fix in any way, as this is not a real solution to the problem.","createdAt":"2024-12-03T17:55:08Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5643#issuecomment-2515234117","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6WeoTp","author":{"login":"aleskovets"},"authorAssociation":"NONE","body":"Data point - have the same issue with postgres12. Issue popped after upgrading from 1.21 to 1.24","createdAt":"2024-12-06T23:26:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":3}}],"url":"https://github.com/temporalio/temporal/issues/5643#issuecomment-2524611817","viewerDidAuthor":false},{"id":"IC_kwDODNqesM60p3gj","author":{"login":"genek96"},"authorAssociation":"NONE","body":"I have the same issue on temporal server 1.26 with primary database on cassandra and visibility on postgres 16. Looks like the problem is still alive.","createdAt":"2025-07-03T05:42:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5643#issuecomment-3030874147","viewerDidAuthor":false},{"id":"IC_kwDODNqesM69LsJB","author":{"login":"shilenkoalexander"},"authorAssociation":"NONE","body":"I've faced this in 1.28.0 with Postgres 16 + strongly synchronized replicas, recently. Very rarely but still happens","createdAt":"2025-08-11T09:36:36Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5643#issuecomment-3173958209","viewerDidAuthor":false}],"createdAt":"2024-04-02T10:27:00Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":5643,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":14}}],"state":"CLOSED","title":"Visibility data can become inconsistent","updatedAt":"2025-08-11T09:37:05Z","url":"https://github.com/temporalio/temporal/issues/5643"}
