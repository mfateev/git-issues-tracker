{"assignees":[],"author":{"id":"MDQ6VXNlcjQ5NjQ1MjU=","is_bot":false,"login":"sergeimonakhov","name":"Sergei Monakhov"},"body":"## Expected Behavior\n\n\n## Actual Behavior\n\n```json\n{\"level\":\"info\",\"ts\":\"2025-02-22T19:08:01.765Z\",\"msg\":\"history client encountered error\",\"service\":\"frontend\",\"error\":\"lockCurrentExecutionIfExists failed. Failed to get current_executions row for (shard,namespace,workflow) = (216, 32049b68-7872-4094-8e63-d0dd59896a83, temporal-sys-history-scanner). Error: sql: Scan error on column index 10, name \\\"data_encoding\\\": converting NULL to string is unsupported\",\"service-error-type\":\"serviceerror.Unavailable\",\"logging-call-at\":\"/home/runner/work/docker-builds/docker-builds/temporal/client/history/metric_client.go:103\"}\n{\"level\":\"info\",\"ts\":\"2025-02-22T19:08:01.950Z\",\"msg\":\"history client encountered error\",\"service\":\"frontend\",\"error\":\"lockCurrentExecutionIfExists failed. Failed to get current_executions row for (shard,namespace,workflow) = (216, 32049b68-7872-4094-8e63-d0dd59896a83, temporal-sys-history-scanner). Error: sql: Scan error on column index 10, name \\\"data_encoding\\\": converting NULL to string is unsupported\",\"service-error-type\":\"serviceerror.Unavailable\",\"logging-call-at\":\"/home/runner/work/docker-builds/docker-builds/temporal/client/history/metric_client.go:103\"}\n{\"level\":\"error\",\"ts\":\"2025-02-22T19:08:01.951Z\",\"msg\":\"service failures\",\"operation\":\"StartWorkflowExecution\",\"wf-namespace\":\"temporal-system\",\"grpc_code\":\"Unavailable\",\"wf-id\":\"temporal-sys-history-scanner\",\"error\":\"lockCurrentExecutionIfExists failed. Failed to get current_executions row for (shard,namespace,workflow) = (216, 32049b68-7872-4094-8e63-d0dd59896a83, temporal-sys-history-scanner). Error: sql: Scan error on column index 10, name \\\"data_encoding\\\": converting NULL to string is unsupported\",\"logging-call-at\":\"/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/telemetry.go:423\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/log/zap_logger.go:154\\ngo.temporal.io/server/common/rpc/interceptor.(*TelemetryInterceptor).logErrors\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/telemetry.go:423\\ngo.temporal.io/server/common/rpc/interceptor.(*TelemetryInterceptor).HandleError\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/telemetry.go:393\\ngo.temporal.io/server/common/rpc/interceptor.(*TelemetryInterceptor).UnaryIntercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/telemetry.go:200\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1212\\ngo.temporal.io/server/common/rpc/interceptor.(*Redirection).handleRedirectAPIInvocation.func2\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/redirection.go:265\\ngo.temporal.io/server/common/rpc/interceptor.(*NoopRedirectionPolicy).WithNamespaceRedirect\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/dc_redirection_policy.go:125\\ngo.temporal.io/server/common/rpc/interceptor.(*Redirection).handleRedirectAPIInvocation\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/redirection.go:262\\ngo.temporal.io/server/common/rpc/interceptor.(*Redirection).Intercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/redirection.go:222\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1212\\ngo.temporal.io/server/common/authorization.(*Interceptor).Intercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/authorization/interceptor.go:178\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1212\\ngo.temporal.io/server/service/frontend.GrpcServerOptionsProvider.NewServerMetricsContextInjectorInterceptor.func2\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/metrics/grpc.go:65\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1212\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceLogInterceptor).Intercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/namespace_logger.go:84\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1212\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceValidatorInterceptor).NamespaceValidateIntercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/namespace_validator.go:132\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1212\\ngo.temporal.io/server/service/frontend.GrpcServerOptionsProvider.NewFrontendServiceErrorInterceptor.func1\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/grpc.go:178\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1212\\ngo.temporal.io/server/common/rpc.ServiceErrorInterceptor\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/grpc.go:157\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1212\\ngo.temporal.io/server/common/rpc/interceptor.(*MaskInternalErrorDetailsInterceptor).Intercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/mask_internal_error.go:65\\ngoogle.golang.org/grpc.NewServer.chainUnaryServerInterceptors.chainUnaryInterceptors.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1203\\ngo.temporal.io/api/workflowservice/v1._WorkflowService_StartWorkflowExecution_Handler\\n\\t/home/runner/go/pkg/mod/go.temporal.io/api@v1.44.1/workflowservice/v1/service_grpc.pb.go:2405\\ngoogle.golang.org/grpc.(*Server).processUnaryRPC\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1400\\ngoogle.golang.org/grpc.(*Server).handleStream\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1810\\ngoogle.golang.org/grpc.(*Server).serveStreams.func2.1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1030\"}\n```\n## Steps to Reproduce the Problem\n\n  1. Upgrade to 1.27.0 from 1.26.2\n\n## Specifications\n\n  - Version:  1.27.0\n  - Platform:\n","closedAt":"2025-03-06T22:40:51Z","comments":[{"id":"IC_kwDODNqesM6fnBYb","author":{"login":"jeenadeepak"},"authorAssociation":"NONE","body":"@yycptt : Any update on this, I am facing same issue after upgrade.","createdAt":"2025-02-24T09:10:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7376#issuecomment-2677806619","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6fnh3A","author":{"login":"jeenadeepak"},"authorAssociation":"NONE","body":"**Temporal history Error:** \n\n{\"level\":\"info\",\"ts\":\"2025-02-24T09:55:48.092Z\",\"msg\":\"none\",\"shard-id\":205,\"address\":\"10.11.82.208:7234\",\"lifecycle\":\"Started\",\"component\":\"shard-context\",\"logging-call-at\":\"/home/runner/work/docker-builds/docker-builds/temporal/service/history/shard/context_impl.go:1631\"}\n{\"level\":\"error\",\"ts\":\"2025-02-24T09:55:48.092Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":205,\"address\":\"10.11.82.208:7234\",\"wf-namespace-id\":\"7d67fc38-8f86-484a-a1ee-cdaf4dcfa498\",\"wf-id\":\"FBCAR5BOS0VIBTOG\",\"wf-run-id\":\"2b8fbd29-ab84-40aa-ac59-ada2c6e1bf33\",\"store-operation\":\"update-wf-execution\",\"error\":\"assertCurrentExecution failed. Unable to load current record. Error: sql: Scan error on column index 10, name \\\"data_encoding\\\": converting NULL to string is unsupported\",\"logging-call-at\":\"/home/runner/work/docker-builds/docker-builds/temporal/service/history/workflow/transaction_impl.go:510\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/log/zap_logger.go:154\\ngo.temporal.io/server/service/history/workflow.updateWorkflowExecution\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/service/history/workflow/transaction_impl.go:510\\ngo.temporal.io/server/service/history/workflow.(*TransactionImpl).UpdateWorkflowExecution\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/service/history/workflow/transaction_impl.go:188\\ngo.temporal.io/server/service/history/workflow.(*ContextImpl).UpdateWorkflowExecutionWithNew\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/service/history/workflow/context.go:654\\ngo.temporal.io/server/service/history/workflow.(*ContextImpl).UpdateWorkflowExecutionAsActive\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/service/history/workflow/context.go:502\\ngo.temporal.io/server/service/history/api.UpdateWorkflowWithNew\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/service/history/api/update_workflow_util.go:138\\ngo.temporal.io/server/service/history/api.GetAndUpdateWorkflowWithNew\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/service/history/api/update_workflow_util.go:59\\ngo.temporal.io/server/service/history/api/recordactivitytaskstarted.Invoke\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/service/history/api/recordactivitytaskstarted/api.go:62\\ngo.temporal.io/server/service/history.(*historyEngineImpl).RecordActivityTaskStarted\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/service/history/history_engine.go:534\\ngo.temporal.io/server/service/history.(*Handler).RecordActivityTaskStarted\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/service/history/handler.go:342\\ngo.temporal.io/server/api/historyservice/v1._HistoryService_RecordActivityTaskStarted_Handler.func1\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/api/historyservice/v1/service_grpc.pb.go:1677\\ngo.temporal.io/server/common/rpc/interceptor.(*RetryableInterceptor).Intercept.func1\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/retry.go:62\\ngo.temporal.io/server/common/backoff.ThrottleRetryContext\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/backoff/retry.go:89\\ngo.temporal.io/server/common/rpc/interceptor.(*RetryableInterceptor).Intercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/retry.go:66\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1212\\ngo.temporal.io/server/common/rpc/interceptor.(*RateLimitInterceptor).Intercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/rate_limit.go:88\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1212\\ngo.temporal.io/server/common/rpc/interceptor.(*TelemetryInterceptor).UnaryIntercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/telemetry.go:197\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1212\\ngo.temporal.io/server/service.GrpcServerOptionsProvider.getUnaryInterceptors.NewServerMetricsTrailerPropagatorInterceptor.func6\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/metrics/grpc.go:112\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1212\\ngo.temporal.io/server/service.GrpcServerOptionsProvider.getUnaryInterceptors.NewServerMetricsContextInjectorInterceptor.func5\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/metrics/grpc.go:65\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1212\\ngo.temporal.io/server/common/rpc.ServiceErrorInterceptor\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/grpc.go:157\\ngoogle.golang.org/grpc.NewServer.chainUnaryServerInterceptors.chainUnaryInterceptors.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1203\\ngo.temporal.io/server/api/historyservice/v1._HistoryService_RecordActivityTaskStarted_Handler\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/api/historyservice/v1/service_grpc.pb.go:1679\\ngoogle.golang.org/grpc.(*Server).processUnaryRPC\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1400\\ngoogle.golang.org/grpc.(*Server).handleStream\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1810\\ngoogle.golang.org/grpc.(*Server).serveStreams.func2.1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.70.0/server.go:1030\"}\n\n\n**Temporal matching error:**\n\n{\"level\":\"info\",\"ts\":\"2025-02-24T09:58:52.737Z\",\"msg\":\"history client encountered error\",\"service\":\"matching\",\"error\":\"assertCurrentExecution failed. Unable to load current record. Error: sql: Scan error on column index 10, name \\\"data_encoding\\\": converting NULL to string is unsupported\",\"service-error-type\":\"serviceerror.Unavailable\",\"logging-call-at\":\"/home/runner/work/docker-builds/docker-builds/temporal/client/history/metric_client.go:103\"}\n{\"level\":\"info\",\"ts\":\"2025-02-24T09:58:52.771Z\",\"msg\":\"history client encountered error\",\"service\":\"matching\",\"error\":\"assertCurrentExecution failed. Unable to load current record. Error: sql: Scan error on column index 10, name \\\"data_encoding\\\": converting NULL to string is unsupported\",\"service-error-type\":\"serviceerror.Unavailable\",\"logging-call-at\":\"/home/runner/work/docker-builds/docker-builds/temporal/client/history/metric_client.go:103\"}\n\n\n**Also there is spike in database wait time and CPU, sharing screenshot for reference, below screenshot is for 90 minute, I have updated temporal 75 minute ago.**\n \n<img width=\"1728\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/1fd04aa8-6a47-434f-8902-cb919e111b46\" />\n","createdAt":"2025-02-24T10:06:44Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7376#issuecomment-2677939648","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6fn5li","author":{"login":"danieljoos"},"authorAssociation":"NONE","body":"We're seeing the same error in our testing environment.\n\nI believe it was introduced with #7080 as it [adds the `data_encoding` column ](https://github.com/temporalio/temporal/pull/7080/files#diff-16e2e23ee3b51a4e27fb4d57a2213ff19119208a1872f0c715187797ef452ebfR60) to the `current_executions` table as nullable.\n\nHowever, the model in Go [uses a `string`](https://github.com/temporalio/temporal/pull/7080/files#diff-4c7f7d86bf11f7c0fad3eddb5816dae85cba4f1866d745cfdd9ec1c57361cb33R74) for that column. This fails to unmarshal when fetching a `NULL` value from the DB.\n\nPausing the upgrade to 1.27 for now.","createdAt":"2025-02-24T10:44:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7376#issuecomment-2678036834","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6fqC6H","author":{"login":"makholm"},"authorAssociation":"NONE","body":"Seeing the same thing here...\n\nThere seems to be some inconsistencies in the schema definitions as well...\n\nMigrations for sqlite, mysql and postgresql all migrated to a nullable current_executions.data_encoding column:\n\nhttps://github.com/temporalio/temporal/blob/main/schema/sqlite/v3/temporal/versioned/v0.7/add_current_executions_data.sql\nhttps://github.com/temporalio/temporal/blob/main/schema/mysql/v8/temporal/versioned/v1.15/add_current_executions_data.sql\nhttps://github.com/temporalio/temporal/blob/main/schema/postgresql/v12/temporal/versioned/v1.15/add_current_executions_data.sql\n\n...but in the full schema definitions, current_executions.data_encoding is NOT NULL for sqlite:\n\nhttps://github.com/temporalio/temporal/blob/main/schema/sqlite/v3/temporal/schema.sql#L59\n\n...but nullable for mysql and postgresql:\n\nhttps://github.com/temporalio/temporal/blob/main/schema/mysql/v8/temporal/schema.sql#L60\nhttps://github.com/temporalio/temporal/blob/main/schema/postgresql/v12/temporal/schema.sql#L60\n","createdAt":"2025-02-24T14:29:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7376#issuecomment-2678599303","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6f0hER","author":{"login":"saz"},"authorAssociation":"NONE","body":"There's a [PR](https://github.com/temporalio/temporal/pull/7383) to resolve this issue.","createdAt":"2025-02-25T09:40:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7376#issuecomment-2681344273","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6hPJNf","author":{"login":"yycptt"},"authorAssociation":"MEMBER","body":"Yes the issue is fixed in [v1.27.1](https://github.com/temporalio/temporal/releases/tag/v1.27.1). Please skip v1.27.0 and upgrade directly to v1.27.1.","createdAt":"2025-03-06T22:40:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7376#issuecomment-2705101663","viewerDidAuthor":false}],"createdAt":"2025-02-22T19:33:34Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":7376,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":3}}],"state":"CLOSED","title":"error converting NULL to string is unsupported after upgrade to v1.27.0","updatedAt":"2025-03-06T22:40:53Z","url":"https://github.com/temporalio/temporal/issues/7376"}
