{"assignees":[{"id":"MDQ6VXNlcjIwNjgxMjQ=","login":"rodrigozhou","name":"Rodrigo Zhou","databaseId":0}],"author":{"id":"MDQ6VXNlcjE3ODAyNjYz","is_bot":false,"login":"ericvg97","name":"Eric Valls"},"body":"When use our own temporal cluster hosted in Aurora and when running\r\n`temporal operator search-attribute create --name ReverStatus --type Keyword`\r\nwe get this error \r\n`unable to add search attributes: Unable to create search attributes: cannot have more than 0 search attribute of type Keyword.`\r\n\r\nWe just upgraded from v1.19 to v1.22.\r\n\r\nWe compared the db with the one in a fresh install and we found that the cluster_metadata_info data (binary) is quite different. In the fresh install, there are mentions to Custom Attributes, but in our production version there aren't. We don't know if this means we had a problem when upgrading.\r\n\r\n[cluster_metadata_info_fresh_install.txt](https://github.com/temporalio/temporal/files/13269974/cluster_metadata_info_fresh_install.txt)\r\n[cluster_metadata_info_prod.txt](https://github.com/temporalio/temporal/files/13269976/cluster_metadata_info_prod.txt)\r\n\r\nOther relevant info:\r\n1. When running `temporal operator cluster describe -o json` we get\r\n```\r\n\"persistence_store\": \"postgres12\",\r\n\"visibility_store\": \"postgres12\"\r\n```\r\n2. With tctl we get the same issue\r\n3. Our config in /etc/temporal/config/docker.yaml is\r\n```\r\nlog:\r\n    stdout: true\r\n    level: info\r\n\r\npersistence:\r\n    numHistoryShards: 64\r\n    defaultStore: default\r\n    visibilityStore: visibility\r\n    datastores:\r\n        default:\r\n            sql:\r\n                pluginName: \"postgres12\"\r\n                databaseName: \"temporal\"\r\n                connectAddr: \"XXXX\"\r\n                connectProtocol: \"tcp\"\r\n                user: \"XXXX\"\r\n                password: \"XXXX\"\r\n                maxConns: 20\r\n                maxIdleConns: 20\r\n                maxConnLifetime: 1h\r\n                tls:\r\n                    enabled: false\r\n                    caFile:\r\n                    certFile:\r\n                    keyFile:\r\n                    enableHostVerification: false\r\n                    serverName:\r\n        visibility:\r\n            sql:\r\n                pluginName: \"postgres12\"\r\n                databaseName: \"temporal_visibility\"\r\n                connectAddr: \"XXXX\"\r\n                connectProtocol: \"tcp\"\r\n                user: \"XXXX\"\r\n                password: \"XXXX\"\r\n                maxConns: 10\r\n                maxIdleConns: 10\r\n                maxConnLifetime: 1h\r\n                tls:\r\n                    enabled: false\r\n                    caFile:\r\n                    certFile:\r\n                    keyFile:\r\n                    enableHostVerification: false\r\n                    serverName:\r\n\r\nglobal:\r\n    membership:\r\n        maxJoinDuration: 30s\r\n        broadcastAddress: \"\"\r\n    pprof:\r\n        port: 0\r\n    tls:\r\n        refreshInterval: 0s\r\n        expirationChecks:\r\n            warningWindow: 0s\r\n            errorWindow: 0s\r\n            checkInterval: 0s\r\n        internode:\r\n            # This server section configures the TLS certificate that internal temporal\r\n            # cluster nodes (history, matching, and internal-frontend) present to other\r\n            # clients within the Temporal Cluster.\r\n            server:\r\n                requireClientAuth: false\r\n                certFile:\r\n                keyFile:\r\n                certData:\r\n                keyData:\r\n\r\n            # This client section is used to configure the TLS clients within\r\n            # the Temporal Cluster that connect to an Internode (history, matching, or\r\n            # internal-frontend)\r\n            client:\r\n                serverName:\r\n                disableHostVerification: false\r\n        frontend:\r\n            # This server section configures the TLS certificate that the Frontend\r\n            # server presents to external clients.\r\n            server:\r\n                requireClientAuth: false\r\n                certFile:\r\n                keyFile:\r\n                certData:\r\n                keyData:\r\n\r\n            # This client section is used to configure the TLS clients within\r\n            # the Temporal Cluster (specifically the Worker role) that connect to the Frontend service\r\n            client:\r\n                serverName:\r\n                disableHostVerification: false\r\n    authorization:\r\n        jwtKeyProvider:\r\n            keySourceURIs:\r\n            refreshInterval: 1m\r\n        permissionsClaimName: permissions\r\n        authorizer:\r\n        claimMapper:\r\nservices:\r\n    frontend:\r\n        rpc:\r\n            grpcPort: 7233\r\n            membershipPort: 6933\r\n            bindOnIP: XXXX\r\n            httpPort: 7243\r\n\r\n    matching:\r\n        rpc:\r\n            grpcPort: 7235\r\n            membershipPort: 6935\r\n            bindOnIP: XXXX\r\n\r\n    history:\r\n        rpc:\r\n            grpcPort: 7234\r\n            membershipPort: 6934\r\n            bindOnIP: XXXX\r\n\r\n    worker:\r\n        rpc:\r\n            grpcPort: 7239\r\n            membershipPort: 6939\r\n            bindOnIP: XXXX\r\n\r\nclusterMetadata:\r\n    enableGlobalNamespace: false\r\n    failoverVersionIncrement: 10\r\n    masterClusterName: \"active\"\r\n    currentClusterName: \"active\"\r\n    clusterInformation:\r\n        active:\r\n            enabled: true\r\n            initialFailoverVersion: 1\r\n            rpcName: \"frontend\"\r\n            rpcAddress: XXXX\r\n\r\ndcRedirectionPolicy:\r\n    policy: \"noop\"\r\n\r\narchival:\r\n  history:\r\n    state: \"enabled\"\r\n    enableRead: true\r\n    provider:\r\n      filestore:\r\n        fileMode: \"0666\"\r\n        dirMode: \"0766\"\r\n  visibility:\r\n    state: \"enabled\"\r\n    enableRead: true\r\n    provider:\r\n      filestore:\r\n        fileMode: \"0666\"\r\n        dirMode: \"0766\"\r\n\r\nnamespaceDefaults:\r\n  archival:\r\n    history:\r\n      state: \"disabled\"\r\n      URI: \"file:///tmp/temporal_archival/development\"\r\n    visibility:\r\n      state: \"disabled\"\r\n      URI: \"file:///tmp/temporal_vis_archival/development\"\r\n\r\n\r\ndynamicConfigClient:\r\n    filepath: \"/etc/temporal/config/dynamicconfig/docker.yaml\"\r\n    pollInterval: \"60s\"\r\n```\r\n\r\n\r\n\r\n\r\n","closedAt":"2024-05-07T21:20:04Z","comments":[{"id":"IC_kwDODNqesM5sUIl6","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"How did you do the upgrade? Here's the general guide about how to do upgrades: https://docs.temporal.io/cluster-deployment-guide#upgrade-server\r\n\r\nAlso, you want to take a look this release notes: https://github.com/temporalio/temporal/releases/tag/v1.20.0#:~:text=Advanced%20visibility%20on%20SQL%20DB%20(beta%20testing)","createdAt":"2023-11-17T22:48:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5079#issuecomment-1817217402","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5tfddh","author":{"login":"jaredLunde"},"authorAssociation":"NONE","body":"This happens with Aurora PostgreSQL clusters even with fresh Temporal installs. Here's another occurrence from the Community Support forum: https://community.temporal.io/t/unable-to-add-search-attributes/9946\r\n\r\nAs with the OP in the forum post, I was able to fix it by using pure Postgres.","createdAt":"2023-12-02T00:44:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5079#issuecomment-1836963681","viewerDidAuthor":false}],"createdAt":"2023-11-06T16:46:18Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":5079,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"Unable to add search attribute when upgrading from v1.19 to v1.22","updatedAt":"2024-05-07T21:20:04Z","url":"https://github.com/temporalio/temporal/issues/5079"}
