{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"## Required context\r\n\r\nThere are two distinct situations that lead to firing `ScheduleToClose` timeout of an activity. Let's call them \"Speculative\" (not a precise term) and \"Factual\".\r\n\r\n\"Factual\" mode: The last Activity attempt is scheduled or started, but not finished yet. `ScheduleToClose` timeout timer fires on the Server. Temporal Server fails the Activity Execution with an `ActivityFailure` caused by `ScheduleToClose` timeout, because it was actually reached.\r\n\r\n\"Speculative\" mode: After an activity retry is failed, Temporal Server calculates how long is it until the next attempt of this activity. If the next attempt should happen after `ScheduleToClose` deadline is reached, there is no reason to wait for the next attempt, because it will never happen. Temporal Server proactively fails the Activity Execution with an `ActivityFailure` caused by `ScheduleToClose` timeout, because `ScheduleToClose` timeout will happen earlier than the next attempt. \r\n\r\n## Expected Behavior\r\n\r\nI expect the situations above to be aligned in the way how they are returned to the SDK. \r\nI would expect to receive `ActivityFailure(retryState=Timeout)` and `TimeoutFailureInfo(timeoutType=ScheduleToClose)` as a cause.\r\n\r\n## Actual Behavior\r\n\"Factual\" mode returns as `ActivityFailure(retryState=Timeout)` with `TimeoutFailureInfo(timeoutType=ScheduleToClose)` as expected.\r\n\r\n\"Speculative\" mode returns as `ActivityFailure(retryState=NonRetryableError)` with `TimeoutFailureInfo(timeoutType=ScheduleToClose)`.\r\n\r\nThis does not look right. \r\n\r\n`RetryState=NonRetryableError` happens and should happen when an activity attempt is failed with a type explicitly set as non-retryable by the user and only in this situation. Otherwise, it significantly complicates the way for users to check for situations if one of the explicitly stated NonRetryableErrors has been thrown. \r\n\r\nOn the other hand, `ActivityFailure(retryState=Timeout)` is reserved specifically for server-enforced timeouts and currently happens only with `ScheduleToClose` timeout. `StartToClose` timeout always returns with `MaximumAttemptsReached`, which makes sense, because an actual reason for timing out is that there are no attempts left, not the `StartToClose` itself.\r\n\r\n## Additional Context\r\n\r\nScheduleToStart timeout also arrives with NonRetryableFailure, which also doesn't look right.\r\nTests covering all of the timeout modes and specifically the \"Factual\" mode:\r\n https://github.com/temporalio/sdk-java/blob/c5f0ebbe8a5cd52ee018809ecdd466379b5a7339/temporal-sdk/src/test/java/io/temporal/workflow/activityTests/ActivityTimeoutTest.java#L594\r\nhttps://github.com/temporalio/sdk-java/blob/c5f0ebbe8a5cd52ee018809ecdd466379b5a7339/temporal-sdk/src/test/java/io/temporal/workflow/activityTests/ActivityTimeoutTest.java#L650","closedAt":null,"comments":[{"id":"IC_kwDODNqesM5PLkrK","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"If I were designing it now without thinking about backward compatibility:\r\n\r\nI think we should return all the available information about failure:\r\n\r\n* The last activity failure as a cause. This can be either ApplicationFailure or TimeoutFailure for StartToCloseTimeout.\r\n* The information about why retry is not possible\r\n\r\nTimeoutFailureInfo should be returned only in case of StartToClose timeout.\r\n\r\nActivityFailure\r\n    retryState=..., \r\n    lastHeartbeatDetails=...\r\n    cause=    ApplicationFailure | TimeoutFailure (only if the last failure was StartToClose timeout)","createdAt":"2022-11-28T02:06:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3667#issuecomment-1328433866","viewerDidAuthor":true}],"createdAt":"2022-11-28T00:11:36Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg0","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":3667,"reactionGroups":[],"state":"OPEN","title":"Temporal Server returns incorrect RetryState in some cases of scheduleToClose timeout","updatedAt":"2023-03-03T20:17:19Z","url":"https://github.com/temporalio/temporal/issues/3667"}
