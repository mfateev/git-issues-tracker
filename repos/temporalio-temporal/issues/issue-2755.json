{"assignees":[{"id":"MDQ6VXNlcjYzNTAzMDE=","login":"jbreiding","name":"Jeremy","databaseId":0}],"author":{"id":"MDQ6VXNlcjIwNzMxMDE5","is_bot":false,"login":"capythulhu","name":"Thiago"},"body":"## Expected Behavior\r\nTemporal should work normally on a development container\r\n\r\n## Actual Behavior\r\nTemporal does not work on a development container\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n**Step-by-step better specified [here](https://github.com/temporalio/temporal/issues/2755#issuecomment-1107393456).**\r\n\r\n~1. Clone [this repository](https://github.com/thzoid/temporal-bug) and open it with Visual Studio Code;~\r\n~2. On VSCode terminal, run `docker-compose up`;~\r\n~3. Wait for Temporal container to be deployed;~\r\n~4. Watch Temporal work perfectly;~\r\n~5. Stop and delete the Docker container;~\r\n~6. On VSCode, press `F1` and type `Remote-Contianers: Rebuild and Reopen in Container`. Press enter;~\r\n~7. Wait for the development container to be fully deployed;~\r\n~8. On VSCode terminal (now running inside the dev container) run `docker-compose up`;~\r\n~9. Wait for about 1 minute and watch the service `temporal` to exit with code `1`;~\r\n~10. The logs says: `Unable to create dynamic config client. Error: unable to validate dynamic config: dynamic config:\r\nconfig/dynamicconfig/development_sql_es.yaml: stat config/dynamicconfig/development_sql_es.yaml: no such file or directory`~\r\n\r\n## Specifications\r\n\r\n  - Version: 1.16.1\r\n  - Platform: Windows 11 with WSL\r\n","closedAt":"2022-04-25T20:26:18Z","comments":[{"id":"IC_kwDODNqesM5B93u9","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Please try temporal's official docker compose: https://github.com/temporalio/docker-compose\r\nFollow the steps there and let us know if it does not work. Thanks.","createdAt":"2022-04-22T17:57:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2755#issuecomment-1106738109","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5CAXuw","author":{"login":"capythulhu"},"authorAssociation":"NONE","body":"My repository is just a minimal version of that repo, but if you want to reproduce the bug only using original repositories, please, follow these steps:\r\n\r\n### On Windows\r\n1. Start Docker\r\n2. Open a WSL terminal\r\n\r\n### On WSL\r\n1. `git clone https://github.com/temporalio/docker-compose.git`\r\n2. `cd docker-compose`\r\n> At this point, if you run `docker-compose up`, Temporal will start and work normally. Follow the next steps to set up the development container.\r\n3. `mkdir .devcontainer`\r\n4. `cd .devcontainer`\r\n5. `wget -q https://raw.githubusercontent.com/qdm12/basedevcontainer/master/.devcontainer/devcontainer.json`\r\n6. `wget -q https://raw.githubusercontent.com/qdm12/basedevcontainer/master/.devcontainer/docker-compose.yml`\r\n7. `wget -q https://raw.githubusercontent.com/qdm12/basedevcontainer/master/.devcontainer/Dockerfile`\r\n8. `code ../`\r\n\r\n### On Visual Studio Code\r\n> Make sure you have [Remote Containers](https://marketplace.visualstudio.com/items?itemName=ms-vscode-remote.remote-containers) extension installed.\r\n1. Press `F1`\r\n2. Type `Remote-Containers: Rebuild and Reopen in Container` and press `Enter`\r\n\r\n### On development container terminal (on Visual Studio Code)\r\n1. `rm ~/.docker/config.json` (necessary because of [some Windows-Docker issue](https://forums.docker.com/t/docker-credential-desktop-exe-executable-file-not-found-in-path-using-wsl2/100225))\r\n2. `docker-compose up`\r\n> At this point, Temporal service will exit after a few seconds with the following log: ```Unable to create dynamic config client. Error: unable to validate dynamic config: dynamic config: config/dynamicconfig/development_sql_es.yaml: stat config/dynamicconfig/development_sql_es.yaml: no such file or directory```","createdAt":"2022-04-23T06:30:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/2755#issuecomment-1107393456","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5CA2t3","author":{"login":"jbreiding"},"authorAssociation":"CONTRIBUTOR","body":"I work solely in dev containers and this is because of how bind mounts work with docker.\r\n\r\nThe best option here to get this to work is to use the docker-compose variant of dev containers and push these services to the main docker-compose file.\r\n\r\nAn example is here\r\nhttps://github.com/microsoft/vscode-dev-containers/tree/main/containers/go-postgres\r\n\r\nI’m hoping when this feature lands this will be simpler\r\nhttps://github.com/moby/moby/issues/32582","createdAt":"2022-04-23T15:23:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2755#issuecomment-1107520375","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5CBVR6","author":{"login":"capythulhu"},"authorAssociation":"NONE","body":"@jbreiding, unfortunately, that's far from the desired solution. I was opting for Docker in Docker because my application has almost 10 services running on containers, and I didn't want them to start along with the dev container itself (in fact, even when testing features, most of time one wouldn't even need to start all services at once) because developers don't need them all running on background while they're coding. Is there a way to prevent that?","createdAt":"2022-04-23T20:39:31Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2755#issuecomment-1107645562","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5CBaVC","author":{"login":"jbreiding"},"authorAssociation":"CONTRIBUTOR","body":"If you have the docker extension installed you can stop any of the containers if they are running and start then again when needed\r\n\r\nYou can also not make the dev service dependent on the extra services and only identify the dev service to start.\r\nThis is defaulted to app in most cases.\r\n\r\nit’s actually pretty close to ideal and works well.\r\n\r\nIf you insist on this path simply change the bind mounts to reference the fully qualified path accessible to your docker daemon.\r\n\r\nthis is likely the full path to your workspace folder in wsl. The context path is coming from the container mapping so very likely ‘/workspace’ which is not available to the docker daemon.\r\n\r\nthere are lots of options available to accomplish this.\r\n\r\nhttps://code.visualstudio.com/docs/remote/devcontainerjson-reference#_docker-compose-specific-properties\r\n","createdAt":"2022-04-23T23:41:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2755#issuecomment-1107666242","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5CDC2z","author":{"login":"capythulhu"},"authorAssociation":"NONE","body":"Thanks for explaining that. Could you clarify some questions I have on that behalf? How exactly one would accomplish not making the dev service dependent on extra services? Below is a `docker-compose.yml` from Visual Studio Code \"Go & PostgreSQL\" development container preset (original avaiable [here](https://github.com/microsoft/vscode-dev-containers/blob/main/containers/go-postgres/.devcontainer/docker-compose.yml)). I'm trying to make the `db` service not auto-initializable while allowing the developer to start it from inside the dev container using the Docker extension, as you said.\r\n```yml\r\nversion: '3.8'\r\n\r\nvolumes:\r\n  postgres-data:\r\n    null\r\n\r\nservices:\r\n  app:\r\n    build:\r\n      context: .\r\n      dockerfile: Dockerfile\r\n      args:\r\n        VARIANT: 1.18-bullseye\r\n        NODE_VERSION: \"lts/*\"\r\n    env_file:\r\n      - .env\r\n\r\n    volumes:\r\n      - ..:/workspace:cached\r\n\r\n    command: sleep infinity\r\n\r\n    network_mode: service:db\r\n\r\n  db:\r\n    image: postgres:latest\r\n    restart: unless-stopped\r\n    volumes:\r\n      - postgres-data:/var/lib/postgresql/data\r\n    env_file:\r\n      - .env\r\n```\r\n\r\n- Does `network_mode: service:db` make the `app` service dependent on `db`? If so, how to achieve both running on the same network without making them co-dependent?\r\n- Is changing `restart: unless-stopped` to `restart: no` the correct way of telling Docker to not automatically initialize the service?\r\n\r\nThanks again for clarifying the situation.","createdAt":"2022-04-25T05:29:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2755#issuecomment-1108094387","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5CFZaa","author":{"login":"jbreiding"},"authorAssociation":"CONTRIBUTOR","body":"I don't have a lot of experience running this way, but this may help you\r\nhttps://docs.docker.com/compose/profiles/\r\n\r\nIf you encounter any issues from there its best to get some community help from vscode dev containers team. You will likely find someone running a similar setup.","createdAt":"2022-04-25T15:17:38Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2755#issuecomment-1108711066","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5CGhtN","author":{"login":"capythulhu"},"authorAssociation":"NONE","body":"I have tried compose profiles before, but unfortunately, anything that seems to stop services from auto-initializing (including `restart: no`) result in an error from the command that Remote-Containers extension runs:\r\n```Start: Run: docker-compose -f /home/usr/go/src/github.com/foo/go-postgres/.devcontainer/docker-compose.yml --profile * config\r\nStop (109 ms): Run: docker-compose -f /home/usr/go/src/github.com/foo/go-postgres/.devcontainer/docker-compose.yml --profile * config\r\nError: Command failed: docker-compose -f /home/usr/go/src/github.com/foo/go-postgres/.devcontainer/docker-compose.yml --profile * config\r\n    at Ru (/home/usr/.vscode-remote-containers/dist/dev-containers-cli-0.231.6/dist/spec-node/devContainersSpecCLI.js:210:813)\r\n    at processTicksAndRejections (node:internal/process/task_queues:96:5)\r\n    at async pR (/home/usr/.vscode-remote-containers/dist/dev-containers-cli-0.231.6/dist/spec-node/devContainersSpecCLI.js:182:643)\r\n    at async dR (/home/usr/.vscode-remote-containers/dist/dev-containers-cli-0.231.6/dist/spec-node/devContainersSpecCLI.js:179:2075)\r\n    at async IR (/home/usr/.vscode-remote-containers/dist/dev-containers-cli-0.231.6/dist/spec-node/devContainersSpecCLI.js:224:2195)\r\n    at async Xw (/home/usr/.vscode-remote-containers/dist/dev-containers-cli-0.231.6/dist/spec-node/devContainersSpecCLI.js:224:3221)\r\n    at async kR (/home/usr/.vscode-remote-containers/dist/dev-containers-cli-0.231.6/dist/spec-node/devContainersSpecCLI.js:224:13925)\r\n    at async TR (/home/usr/.vscode-remote-containers/dist/dev-containers-cli-0.231.6/dist/spec-node/devContainersSpecCLI.js:224:13650)\r\nStop (391 ms): Run in Host: /home/usr/.vscode-server/bin/dfd34e8260c270da74b5c2d86d61aee4b6d56977/node /home/usr/.vscode-remote-containers/dist/dev-containers-cli-0.231.6/dist/spec-node/devContainersSpecCLI.js up --container-data-folder .vscode-server/data/Machine --container-system-data-folder /var/vscode-server --workspace-folder /home/usr/go/src/github.com/foo/go-postgres --workspace-mount-consistency cached --id-label vsch.local.folder=\\\\wsl.localhost\\Ubuntu-20.04\\home\\usr\\go\\src\\github.com\\foo\\go-postgres --id-label vsch.quality=stable --log-level debug --config /home/usr/go/src/github.com/foo/go-postgres/.devcontainer/devcontainer.json --remove-existing-container --mount type=volume,source=vscode,target=/vscode,external=true --skip-post-create --update-remote-user-uid-default on --mount-workspace-git-root t\r\nExit code 1\r\nCommand failed: /home/usr/.vscode-server/bin/dfd34e8260c270da74b5c2d86d61aee4b6d56977/node /home/usr/.vscode-remote-containers/dist/dev-containers-cli-0.231.6/dist/spec-node/devContainersSpecCLI.js up --container-data-folder .vscode-server/data/Machine --container-system-data-folder /var/vscode-server --workspace-folder /home/usr/go/src/github.com/foo/go-postgres --workspace-mount-consistency cached --id-label vsch.local.folder=\\\\wsl.localhost\\Ubuntu-20.04\\home\\usr\\go\\src\\github.com\\foo\\go-postgres --id-label vsch.quality=stable --log-level debug --config /home/usr/go/src/github.com/foo/go-postgres/.devcontainer/devcontainer.json --remove-existing-container --mount type=volume,source=vscode,target=/vscode,external=true --skip-post-create --update-remote-user-uid-default on --mount-workspace-git-root true\r\n```\r\n\r\nDev containers, at least for now, just seem to be too much headache. I'll look for other alternatives. Thank you!\r\n\r\nEdit: In case anyone also stumbles on this problem, the discussion continues [here](https://stackoverflow.com/questions/72005582/how-do-i-deploy-a-dev-container-without-running-every-other-service).","createdAt":"2022-04-25T20:26:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2755#issuecomment-1109007181","viewerDidAuthor":false}],"createdAt":"2022-04-21T02:58:49Z","labels":[{"id":"MDU6TGFiZWwyMDE5OTA0OTIw","name":"discussion","description":"","color":"3ffcb0"},{"id":"MDU6TGFiZWwyMDE5OTE0ODQ5","name":"docker","description":"","color":"eda6d4"},{"id":"MDU6TGFiZWwyMDE5OTIzNjU1","name":"devexp","description":"","color":"9350b7"},{"id":"MDU6TGFiZWwyNzcwMzY2NzYw","name":"close-after-30-days","description":"","color":"1d76db"}],"milestone":null,"number":2755,"reactionGroups":[],"state":"CLOSED","title":"Temporal won't run on development containers","updatedAt":"2022-04-25T23:14:53Z","url":"https://github.com/temporalio/temporal/issues/2755"}
