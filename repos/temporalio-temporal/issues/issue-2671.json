{"assignees":[{"id":"MDQ6VXNlcjIyMzI1MjQ=","login":"alexshtin","name":"Alex Shtin","databaseId":0}],"author":{"id":"MDQ6VXNlcjEwNzk1NDc=","is_bot":false,"login":"nshazly","name":""},"body":"## Expected Behavior\r\nPrevious issue described here, suggested steps show the Elasticsearch index and schema were created and the issue persists, https://github.com/temporalio/temporal/issues/2649\r\n\r\nRunning `tctl workflow list` should respond with a list of running works flows or an empty list. Not an error.\r\n\r\n## Actual Behavior\r\n\r\n```\r\n$ tctl workflow list                                                       \r\nError: Failed to list closed workflow.\r\nError Details: context deadline exceeded\r\n('export TEMPORAL_CLI_SHOW_STACKS=1' to see stack traces)\r\n```\r\nAnd the web interface shows the following error:\r\n\r\n![image](https://user-images.githubusercontent.com/1079547/160196915-1dd3f65e-a214-4e30-8f06-a551f23c216b.png)\r\n\r\nAdditionally, \r\n```\r\n$ tctl wf start --tq fake.queue --wt fake.workflow\r\nStarted Workflow Id: bf730e6e-5f21-476f-a0ae-7b2e39707326, run Id: 00356ebe-2a10-4034-844e-735cfa2f2b16\r\n\r\n$   tctl wf term -w bf730e6e-5f21-476f-a0ae-7b2e39707326     \r\nError: Terminate workflow failed.\r\nError Details: sql: no rows in result set\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Fresh install of temporal IO using elasticsearch/postgresql, version 1.15.2\r\n  2. Run the auto-setup indexes (https://github.com/temporalio/docker-builds/blob/main/docker/auto-setup.sh#L268-L276)\r\n  ```\r\n$ curl -X PUT \"${INDEX_URL}\" --write-out \"\\n\"\r\n{\"error\":{\"root_cause\":[{\"type\":\"resource_already_exists_exception\",\"reason\":\"index [temporal_visibility/KbYZaZBjTuucfbR0z8si4g] \r\nalready exists\",\"index_uuid\":\"KbYZaZBjTuucfbR0z8si4g\",\"index\":\"temporal_visibility\"}],\"type\":\"resource_already_exists_exception\",\"reason\":\"index [temporal_visibility/KbYZaZBjTuucfbR0z8si4g] already exists\",\"index_uuid\":\"KbYZaZBjTuucfbR0z8si4g\",\"index\":\"temporal_visibility\"},\"status\":400}\r\n```\r\n  4. Run the command `tctl n re default` to create a namespace\r\n  5. Start a workflow `tctl wf start --tq fake.queue --wt fake.workflow --et 10`\r\n  6. Run `tctl workflow list`\r\nOR\r\n   Log into the WEB Interface\r\n\r\n## Specifications\r\n\r\n  - Version: 1.15.2\r\n  - Platform: K8s\r\n\r\n$   tctl wf term -w bf730e6e-5f21-476f-a0ae-7b2e39707326     \r\nError: Terminate workflow failed.\r\nError Details: sql: no rows in result set\r\n","closedAt":"2022-04-01T22:22:55Z","comments":[{"id":"IC_kwDODNqesM5AwN9a","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"Elasticsearch creates indexes on demand using index template. Index name should match one of `index_patterns` specified [here](https://github.com/temporalio/temporal/blob/master/schema/elasticsearch/visibility/versioned/v1/index_template_v7.json#L4).\r\n\r\nYou index name doesn't match it and therefore it was created without applying proper template. In this case Elasticsearch created it using default \"best guess\" schema. In this schema `RunId` is of type `Text` (instead of `Keyword`) and it can't be used for sorting. This is what error message says. \r\n\r\nYou need to upload modified index schema template (which will match your index name) or change your index name to match the pattern. Then delete existing index and it will be recreated by Elasticsearch automatically or you can do it with `curl` command.\r\n","createdAt":"2022-04-01T22:22:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2671#issuecomment-1086381914","viewerDidAuthor":false}],"createdAt":"2022-03-29T17:17:27Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":2671,"reactionGroups":[],"state":"CLOSED","title":"Fresh install and workflow results in ListClosedWorkflowExecutions, Elasticsearch error persists","updatedAt":"2022-04-01T22:22:55Z","url":"https://github.com/temporalio/temporal/issues/2671"}
