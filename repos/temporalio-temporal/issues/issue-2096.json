{"assignees":[{"id":"MDQ6VXNlcjIyMzI1MjQ=","login":"alexshtin","name":"Alex Shtin","databaseId":0}],"author":{"id":"MDQ6VXNlcjE1NzA4Mw==","is_bot":false,"login":"krousey","name":"Kris Rousey"},"body":"**Is your feature request related to a problem? Please describe.**\r\n\r\ngRPC health checks don't support empty queries. The implementation also prevents health checking of multiple gRPC services running on the same server.\r\n\r\nUsing https://github.com/grpc-ecosystem/grpc-health-probe, `grpc_health_probe -addr localhost:7233` fails, but `grpc_health_probe -addr localhost:7233 -service temporal.api.workflowservice.v1.WorkflowService` succeeds. This works, but it means I have to craft separate health probes commands for the workflow, history, and matching services.\r\n\r\n**Describe the solution you'd like**\r\n\r\nHealth checking without specifying a service should respond with the overall health of the server. The gRPC project provides a default implementation that supports empty querying, multiple services, and even the Watch api.\r\n\r\nhttps://pkg.go.dev/google.golang.org/grpc@v1.41.0/health\r\n","closedAt":"2023-09-01T23:08:52Z","comments":[{"id":"IC_kwDODNqesM4_iIB1","author":{"login":"jbreiding"},"authorAssociation":"CONTRIBUTOR","body":"I’m not sure empty is really valid but the default service for health checks should be\r\n\r\ngrpc.health.v1.Health\r\n\r\nthat is the service for “system” health status","createdAt":"2022-03-12T16:14:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2096#issuecomment-1065910389","viewerDidAuthor":false},{"id":"IC_kwDODNqesM4_nPA1","author":{"login":"krousey"},"authorAssociation":"MEMBER","body":"Yea, so there are two issue here. \r\n\r\n1. The `grpc_health_probe` tool does not default the service to `grpc.health.v1.Health`. They probably never hit this because https://pkg.go.dev/google.golang.org/grpc@v1.41.0/health defaults to handling the empty service.\r\n\r\n2. In some cases, we explicitly check against our service and ignore all others. We could also handle the `grpc.health.v1.Health` in these handlers. https://github.com/temporalio/temporal/blob/fcd3148ba6fc8d24d81e5bd375edbb8df089ec2b/service/matching/handler.go#L123-L127","createdAt":"2022-03-14T20:20:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2096#issuecomment-1067249717","viewerDidAuthor":false},{"id":"IC_kwDODNqesM4_nuIB","author":{"login":"jbreiding"},"authorAssociation":"CONTRIBUTOR","body":"Okay, I see now.\r\nThe health checks do work if the temporal grpc service that is deployed is specified?\r\neg:\r\n* temporal.server.api.matchingservice.v1\r\n* temporal.server.api.historyservice.v1\r\n* temporal.api.workflowservice.v1\r\n\r\nBut empty works for frontend only?\r\n\r\nIt looks only the frontend uses health server from the grpc package.","createdAt":"2022-03-14T22:48:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2096#issuecomment-1067377153","viewerDidAuthor":false},{"id":"IC_kwDODNqesM4_rDNk","author":{"login":"krousey"},"authorAssociation":"MEMBER","body":"Yes, the health check works if we specify each service individually. At the time I tested, I don't think no specifying the service worked on any of the components, but I could be mistaken.\r\n\r\nWhat I want is to be able to have a single `grpc_health_probe` command that works for all components. So `grpc_health_probe -addr localhost:7223 -service grpc.health.v1.Health` would be fine. It would be even nicer if `grpc_health_probe -addr localhost:7223` worked by handling the empty string.\r\n\r\nUsing the standard package (as the title suggests) is just a possible way to do this.","createdAt":"2022-03-15T17:22:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/2096#issuecomment-1068249956","viewerDidAuthor":false},{"id":"IC_kwDODNqesM4_sCrT","author":{"login":"jbreiding"},"authorAssociation":"CONTRIBUTOR","body":"This will require a deeper look, because frontend does use the standard health server\r\n\r\n[here](https://github.com/temporalio/temporal/blob/704a9331502dc061c5fdefe6e9de1c224a0907c3/service/frontend/fx.go#L363\r\n)\r\n[and here](https://github.com/temporalio/temporal/blob/6fa5b4a00e996711860886157d2b553b44aece62/service/frontend/service.go#L250)","createdAt":"2022-03-15T21:58:12Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2096#issuecomment-1068509907","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5liIO3","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Just checked, this is working now. Verified using https://github.com/temporalio/cli/releases/tag/v0.10.5\r\n```\r\n~/go/bin 16:06:55\r\n$ ./grpc-health-probe -addr localhost:7233 -service temporal.api.workflowservice.v1.WorkflowService\r\nstatus: SERVING\r\n~/go/bin 16:07:20\r\n$ ./grpc-health-probe -addr localhost:7233\r\nstatus: SERVING\r\n```","createdAt":"2023-09-01T23:08:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2096#issuecomment-1703445431","viewerDidAuthor":false}],"createdAt":"2021-10-26T23:12:16Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":2096,"reactionGroups":[],"state":"CLOSED","title":"replace gRPC health check implementation with standard package","updatedAt":"2023-09-01T23:08:52Z","url":"https://github.com/temporalio/temporal/issues/2096"}
