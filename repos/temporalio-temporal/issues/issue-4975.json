{"assignees":[{"id":"MDQ6VXNlcjIwNjgxMjQ=","login":"rodrigozhou","name":"Rodrigo Zhou","databaseId":0}],"author":{"id":"MDQ6VXNlcjE2Nzg0Nw==","is_bot":false,"login":"Hades32","name":"Martin Rauscher"},"body":"## Expected Behavior\r\nConnections rarely getting opened\r\n\r\n## Actual Behavior\r\n50% of all CPU load (4 cores) just from opening new connections\r\n\r\n![image](https://github.com/temporalio/temporal/assets/167847/0b1cc327-1d8c-47a7-921c-678fcd14ffd9)\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. cluster with 2k shards (I assume that's the culprit)\r\n  1. use Postgres v97 plugin (actual Postgres is v14, we still have to upgrade the plugin)\r\n  1.\r\n\r\n## Specifications\r\n\r\n  - Version: v1.20\r\n  - Platform: Linux, AWS, EKS\r\n","closedAt":"2023-11-28T07:28:44Z","comments":[{"id":"IC_kwDODNqesM5pAsBE","author":{"login":"Hades32"},"authorAssociation":"NONE","body":"Looking through the code I see that Temporal tries to do its own connection pooling, but I didn't figure out if that's on the shard level or the node level.\r\n\r\nWhy not use a well-established connection pooling library like `pgx` and have one pool per node per type of connection (history, visibility, etc)?","createdAt":"2023-10-13T16:28:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4975#issuecomment-1761787972","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5pMNa9","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"@Hades32 `pgx` support was added recently in https://github.com/temporalio/temporal/pull/4913. Give it a try. You'll need to build Temporal from source though (not in a release yet), and you'll have to change the plugin name to `postgres_pgx` or `postgres12_pgx`.\r\n","createdAt":"2023-10-16T16:04:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4975#issuecomment-1764808381","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5pNtWZ","author":{"login":"tdeebswihart"},"authorAssociation":"MEMBER","body":"> @Hades32 `pgx` support was added recently in #4913. Give it a try. You'll need to build Temporal from source though (not in a release yet), and you'll have to change the plugin name to `postgres_pgx` or `postgres12_pgx`.\r\n\r\nUnfortunately we don't use pgx's conn pooling","createdAt":"2023-10-16T20:14:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4975#issuecomment-1765201305","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5pNuLj","author":{"login":"Hades32"},"authorAssociation":"NONE","body":"Are there plans to change that?","createdAt":"2023-10-16T20:17:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4975#issuecomment-1765204707","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5pTtlw","author":{"login":"tdeebswihart"},"authorAssociation":"MEMBER","body":"There are no plans that I'm aware of to use pgx's connection pool. We'd definitely fix our own before that","createdAt":"2023-10-17T16:33:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4975#issuecomment-1766775152","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5pTzOU","author":{"login":"Hades32"},"authorAssociation":"NONE","body":"So, this bug affects all database backends? Is there an issue for tracking the fix for your own connection pooling? I'm surprised you even have custom one","createdAt":"2023-10-17T16:45:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/4975#issuecomment-1766798228","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5s-NRx","author":{"login":"Hades32"},"authorAssociation":"NONE","body":"There is a related issue that TLS certs are not re-used and thus crazy load is put on the system in terms of CPU for GC \r\n<img width=\"1175\" alt=\"image\" src=\"https://github.com/temporalio/temporal/assets/167847/8ac66219-663e-4484-80a2-dc2be17e00aa\">\r\n\r\n@tdeebswihart is that something that could be fixed independently?","createdAt":"2023-11-27T16:56:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4975#issuecomment-1828246641","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5s-WHk","author":{"login":"tdeebswihart"},"authorAssociation":"MEMBER","body":"> ...\r\n> @tdeebswihart is that something that could be fixed independently?\r\n\r\nCould you share the perf recording you're analyzing? That'd help me answer ðŸ˜› ","createdAt":"2023-11-27T17:17:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4975#issuecomment-1828282852","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5s-XVm","author":{"login":"Hades32"},"authorAssociation":"NONE","body":"@tdeebswihart  haha, sure, I didn't want you to bother with analyzing the whole thing. AFAICT the main issue is still the connections not being re-used and as a side-effect, the cert being re-created all the time.\r\nI'll still attach them for your convenience :)\r\nAllocs: [pprof.temporal-server.alloc_objects.alloc_space.inuse_objects.inuse_space.005.pb.gz](https://github.com/temporalio/temporal/files/13478313/pprof.temporal-server.alloc_objects.alloc_space.inuse_objects.inuse_space.005.pb.gz)\r\nHeap: [pprof.temporal-server.alloc_objects.alloc_space.inuse_objects.inuse_space.004.pb.gz](https://github.com/temporalio/temporal/files/13478315/pprof.temporal-server.alloc_objects.alloc_space.inuse_objects.inuse_space.004.pb.gz)\r\nCPU: [pprof.temporal-server.samples.cpu.003.pb.gz](https://github.com/temporalio/temporal/files/13478316/pprof.temporal-server.samples.cpu.003.pb.gz)\r\n","createdAt":"2023-11-27T17:20:34Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4975#issuecomment-1828287846","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5s-bHr","author":{"login":"tdeebswihart"},"authorAssociation":"MEMBER","body":"> So, this bug affects all database backends? Is there an issue for tracking the fix for your own connection pooling? I'm surprised you even have custom one\r\n\r\nTo clarify: we use sqlx's connection pooling, we haven't built our own.","createdAt":"2023-11-27T17:30:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4975#issuecomment-1828303339","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5s-dri","author":{"login":"tdeebswihart"},"authorAssociation":"MEMBER","body":"What have you set the `persistence.datastores.*.sql.maxConns` and `persistence.datastores.*.sql.maxIdleConns` configuration values to? If unspecified we'll fall back to [sqlx's defaults](http://jmoiron.github.io/sqlx/) (look for \"The Connection Pool\") which are:\r\n- Maximum of 2 idle conns\r\n- Unbounded connection pool size (maxConns = 0)\r\n\r\nI see a lot of calls to pq's connection opening code, which screams \"you should set idle conns higher\" to me. This would also cause the GC load you're seeing\r\n","createdAt":"2023-11-27T17:37:09Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4975#issuecomment-1828313826","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5tCDEi","author":{"login":"Hades32"},"authorAssociation":"NONE","body":"ohhh, that's some _very_ low default. Yes, we didn't have that one configured and adding it seems to have basically removed connection handling from CPU and memory profiles.\r\nThanks!\r\n\r\nWill close this, as the main issue is solved, and the constant TLS cert re-loading is negligible with proper pooling","createdAt":"2023-11-28T07:28:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4975#issuecomment-1829253410","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5tFXYd","author":{"login":"tdeebswihart"},"authorAssociation":"MEMBER","body":"> ohhh, that's some _very_ low default. Yes, we didn't have that one configured and adding it seems to have basically removed connection handling from CPU and memory profiles. Thanks!\r\n> \r\n> Will close this, as the main issue is solved, and the constant TLS cert re-loading is negligible with proper pooling\r\n\r\nExcellent, Iâ€™m glad that solved your problem!","createdAt":"2023-11-28T15:44:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4975#issuecomment-1830123037","viewerDidAuthor":false}],"createdAt":"2023-10-13T16:25:49Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4975,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"Postgres connection pooling not working","updatedAt":"2023-11-28T15:44:11Z","url":"https://github.com/temporalio/temporal/issues/4975"}
