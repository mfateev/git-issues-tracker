{"assignees":[{"id":"MDQ6VXNlcjgyNDg4MDY=","login":"sergeybykov","name":"Sergey Bykov","databaseId":0}],"author":{"id":"MDQ6VXNlcjM2NTYxMQ==","is_bot":false,"login":"shaunco","name":"Shaun"},"body":"**Is your feature request related to a problem? Please describe.**\r\nWorkflows and Activities need to be able to read claims/permissions and other fields from validated JWT tokens\r\n\r\n**Describe the solution you'd like**\r\nWhen using the authorizer and claimMappers, workflows and activities should be able to obtain the parsed and validated JWT, claims/permissions contained in the JWT, and the original bearer token - perhaps through `workflow.Context` in workflows and `context.Context` in activities\r\n\r\n**Describe alternatives you've considered**\r\nOur current implementation uses a propagator to pass these fields along from client to workflow to activity, but it is clunky and re-validating the token in the workflow is less than ideal (needing to fetch JWKS, side effects, and all). The new `authorizer` and `claimMappers` look great, but each workflow/activity should be able to reuse the provided token for calling other services, executing child workflows, and executing activities and should also be able to obtain/check/use claims and other token fields (like `sub` for Auth0 tokens).\r\n","closedAt":"2020-12-30T20:09:01Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDc1MTkxMDU4OA==","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"The authorization interceptor already [adds mapped claims to the context](https://github.com/temporalio/temporal/blob/77acf2c4699e33e51ebf02035820f9284e767024/common/authorization/interceptor.go#L105) so that downstream components can leverage information about Temporal claims associated with the caller.\r\n\r\nAlso, `Claims` struct includes a `Subject` field that allows claim mapper to put an arbitrary string there. So, you could put a Bearer token and any other information into with a custom claim mapper. Does that allow you to do what you need, even if indirectly?\r\n\r\nWe could consider adding raw Bearer token explicitly into context. My concern about doing that is that it would impose a performance tax on everybody, even customers that don't need it, or would require yet another config switch to turn the behavior on or off.\r\n\r\nIn the current implementation, claim mapper only cares about permission claims in the JWT token and ignores everything else. One potential option I see here it to allow for claim mappers to add raw claims in addition to handling permission claims. Would that solve your problem and allow to keep validation and parsing of token in one place - in the claim mapper? I also see a counter-argument that this sounds like a feature creep with claim mapper functionality growing beyond what was originally intended - to enable authorization.","createdAt":"2020-12-29T01:02:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1135#issuecomment-751910588","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1MjEwNzg3MA==","author":{"login":"shaunco"},"authorAssociation":"NONE","body":"> The authorization interceptor already [adds mapped claims to the context](https://github.com/temporalio/temporal/blob/77acf2c4699e33e51ebf02035820f9284e767024/common/authorization/interceptor.go#L105) so that downstream components can leverage information about Temporal claims associated with the caller.\r\n\r\nThanks, I had totally missed this!\r\n\r\n> Also, `Claims` struct includes a `Subject` field that allows claim mapper to put an arbitrary string there. So, you could put a Bearer token and any other information into with a custom claim mapper. Does that allow you to do what you need, even if indirectly?\r\n\r\nDepends on the disposition of #1134. If we end up building our own server and containers, this will work. \r\n\r\n> We could consider adding raw Bearer token explicitly into context. My concern about doing that is that it would impose a performance tax on everybody, even customers that don't need it, or would require yet another config switch to turn the behavior on or off.\r\n\r\nI'm not sure what Temporal's plans for the official docker images are, but if that is a route that is to continue forward, then having config to access built-in functionality seems necessary. I don't think anyone has ever complained that a server is too configurable...","createdAt":"2020-12-29T14:55:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1135#issuecomment-752107870","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1MjIxNDk0Mg==","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"I commented in #1134 that we do want to support official docker images as much as possible. With that in mind, there are still multiple options here:\r\n* Add Bearer token to context as is\r\n* Have JWT claim mapper extract all claims and add non-permission ones to context\r\n* Do both things\r\n\r\nWhat would be your preference here?","createdAt":"2020-12-29T19:29:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1135#issuecomment-752214942","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1MjI3MjIzMQ==","author":{"login":"shaunco"},"authorAssociation":"NONE","body":"My vote would be for all aspects of the parsed and validated token to be available to workflows and activities. It seems like any omission of [public claims](https://www.iana.org/assignments/jwt/jwt.xhtml) or private claims (including `permissions`) is going to end up with someone asking for them. That is, I believe, your `both` option.\r\n\r\nFrom a security and performance perspective, I'd rather see _only_ the original auth passed in the server headers to the client, and the client re-parse and re-validate it before activating the workflow or activity. With much of JWT moving to asymmetric (RSA or ECDSA based) tokens, this provides the best security posture, as the token can't be tampered with in Temporal's backing data store, and each workflow/activity knows that the token has been locally validated before execution rather than believing already parsed claims/permissions that arrived in headers. It also means that long lived workflows can fail if the original caller's authentication/authorization is revoked or expired. ... the catch to this is that it means authorizer and claimMappers need to be on both the server side and on the worker side to prevent trust from becoming transitive.","createdAt":"2020-12-29T23:13:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1135#issuecomment-752272231","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1MjMwOTUwNQ==","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"> From a security and performance perspective, I'd rather see only the original auth passed in the server headers to the client, and the client re-parse and re-validate it before activating the workflow or activity. \r\n\r\nI was thinking along similar lines that passing just the original token might be cleaner and cheaper performance wise. My concern is that even if we were to pass all claims, somebody might ask for signature or something. That leads me to option 1, which would allow client to implement any scenario it needs while leaving the claim mapper / authorizer responsible only for authorizing calls to Temporal frontends. ","createdAt":"2020-12-30T02:55:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1135#issuecomment-752309505","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1MjMzNzY2Mw==","author":{"login":"shaunco"},"authorAssociation":"NONE","body":"Agreed on all points.\r\n\r\n> while leaving the claim mapper / authorizer responsible only for authorizing calls to Temporal frontends\r\n\r\nIt would be really nice if the client could pass the same authorizers and claim mappers to `client.NewClient` via `client.ConnectionOptions` in the sdk-go, as the structure and JWT code you put together is pretty nice, and having all JWT clients roll their own would be a shame... but any extensible mechanism that can be passed to `NewClient()`, `RegisterWorkflow()`, or `RegisterActivity()` would be great if the raw token arrives in a header.\r\n\r\nThat said, and a total tangent from above, we recently switched from jwt-go to https://github.com/lestrrat-go/jwx while implementing full JWKS support, as it is a *complete* JWT/JWK/JWA/JWS/JWE implementation, and is fantastically maintained and supported. JWKS support is as simple as:\r\n```go\r\nset, err := jwk.FetchHTTP(uri)\r\ntoken, err := jwt.ParseString(\r\n\ttokenStr,\r\n\tjwt.WithKeySet(set),\r\n)\r\njwt.Validate(token, opts...)\r\n```\r\n\r\nClaim/audience/clock/skew/issuer/subject/jwtID/ validation is all built-in via options.","createdAt":"2020-12-30T05:53:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1135#issuecomment-752337663","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1MjY5Mjc2Nw==","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"Interesting. We haven't considered reusing the authorization components on the client side. Let us take a look into it. But I think it deserves to be tracked by a separate issue. We discussed creating a new repo for code shared between server and client, but haven't started that yet.\r\n\r\nThanks for the pointer to https://github.com/lestrrat-go/jwx. I'll check it out.","createdAt":"2020-12-30T17:07:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/1135#issuecomment-752692767","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1MjcwNjYyNA==","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"I submitted #1144. It passes the authorization header rather than just the token, for symmetry with what claim mapper expect.","createdAt":"2020-12-30T17:56:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/1135#issuecomment-752706624","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1Mjc0MTM3OA==","author":{"login":"shaunco"},"authorAssociation":"NONE","body":"Fantastic, thank you!","createdAt":"2020-12-30T20:03:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/1135#issuecomment-752741378","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1Mjc0MzMxNQ==","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"Resolved via #1144.","createdAt":"2020-12-30T20:09:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1135#issuecomment-752743315","viewerDidAuthor":false}],"createdAt":"2020-12-28T23:32:01Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1135,"reactionGroups":[],"state":"CLOSED","title":"Workflows and Activities should be able to access claims/permissions and other fields from validated JWT tokens","updatedAt":"2020-12-30T20:09:02Z","url":"https://github.com/temporalio/temporal/issues/1135"}
