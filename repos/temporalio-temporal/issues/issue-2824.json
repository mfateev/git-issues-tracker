{"assignees":[],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"Some users reports a spike in the following Query failures **after an upgrade from 1.14 to 1.15.2**:\r\n\r\n```\r\nINVALID_ARGUMENT: java.lang.IllegalArgumentException: Unknown query type: getReservation, knownTypes=[]\r\n\tat io.temporal.internal.sync.QueryDispatcher.handleQuery(QueryDispatcher.java:79)\r\n\tat io.temporal.internal.sync.SyncWorkflowContext.handleQuery(SyncWorkflowContext.java:275)\r\n\tat io.temporal.internal.sync.WorkflowExecuteRunnable.handleQuery(WorkflowExecuteRunnable.java:118)\r\n\tat io.temporal.internal.sync.SyncWorkflow.query(SyncWorkflow.java:187)\r\n\tat io.temporal.internal.replay.ReplayWorkflowExecutor.query(ReplayWorkflowExecutor.java:136)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleQueryWorkflowTask(ReplayWorkflowRunTaskHandler.java:241)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithQuery(ReplayWorkflowTaskHandler.java:117)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:97)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handleTask(WorkflowWorker.java:277)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:231)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:173)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:93)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n\tat java.base/java.lang.Thread.run(Thread.java:829)\r\n```\r\n\r\nIt's a direct (legacy) Query path. This typically happens when a direct query comes to a worker with a history not containing a single completed Workflow Task like it's described in #2300. \r\nThere are no cron, no workflow failures, and no Workflow Task failures as confirmed by the user. Also, the issue happens right after the workflow calls Continue-as-New.\r\n\r\nIt likely means that the query is getting dispatched to the worker before scheduling a first Workflow Task after Continue-as-New. But this should never happen. Temporal always schedules a first Workflow Task immediately after a Workflow Start or Continue-as-New and the Query should be buffered as a part of this first Workflow Task and not being sent as a direct Query.","closedAt":"2022-05-10T23:33:53Z","comments":[{"id":"IC_kwDODNqesM5C79IS","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Closed by #2826","createdAt":"2022-05-10T23:33:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2824#issuecomment-1123013138","viewerDidAuthor":false}],"createdAt":"2022-05-10T04:57:16Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":2824,"reactionGroups":[],"state":"CLOSED","title":"Potential race of direct query and scheduling of the first workflow tasks of the workflow","updatedAt":"2022-05-10T23:33:54Z","url":"https://github.com/temporalio/temporal/issues/2824"}
