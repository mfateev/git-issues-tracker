{"assignees":[],"author":{"id":"MDQ6VXNlcjE3NzcyMTE=","is_bot":false,"login":"wenerme","name":"陈杨文"},"body":"**Is your feature request related to a problem? Please describe.**\r\n\r\nJWT has issuer, the cert path is predictable\r\n\r\n1. predictable by provider - e.g. jwk for keycloak always located at `<issuer>/protocol/openid-connect/certs`\r\n2. predictable by make one more request to OpenID Endpoint (`<issuer>/.well-known/openid-configuration`) Configuration\r\n\r\nbenefit\r\n\r\n- This allowed the impl decouple from the real JWK place - e.g. only limit on domain names\r\n- support customized jwt auth\r\n  - jwk url is based on namespace\r\n  - saas like service\r\n\r\n**Describe the solution you'd like**\r\n\r\nmake TokenKeyProvider more general\r\n\r\n```go\r\ntype TokenKeyProvider interface {\r\n\tGetKey(token *jwt.Token) (interface{}, error)\r\n\tSupportedMethods() []string\r\n\tClose()\r\n}\r\n```\r\n\r\n**Describe alternatives you've considered**\r\n\r\nCurrent TokenKeyProvider restricted to hmac, rsa,  ecdsa, but this restriction should consider for default impl only, not for TokenKeyProvider interface.\r\n\r\n**Additional context**\r\n\r\n","closedAt":"2022-02-01T00:44:02Z","comments":[{"id":"IC_kwDODNqesM48freX","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"@wenerme Thank you for opening the issue. Could you please help me understand the problem you are suggesting to solve here.\r\n\r\nValidation of token happens of the hot path, and the expectation is that all necessary keys have already been prefetched by the token key provider (otherwise, the roundtrip of fetching a key would add to the latency of the call). Hence, the provider needs to be able to fetch those keys without knowing what JWT tokens will need to be validated. So, I'm confused why a token key provider should ever need to see a JWT token.\r\n\r\nIf token keys are frefetched and each key has a unique `kid`, why wouldn't be insufficient to pass an `alg`/`kid` pair to the provider to looks up the right key?","createdAt":"2022-01-17T22:54:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2382#issuecomment-1014937495","viewerDidAuthor":false},{"id":"IC_kwDODNqesM48gg6E","author":{"login":"wenerme"},"authorAssociation":"CONTRIBUTOR","body":"@sergeybykov This is my current impl\r\n\r\n```go\r\n\r\nfunc NewFollowIssuerTokenKeyProvider() *FollowIssuerTokenKeyProvider {\r\n\tcache, err := lru.New(200)\r\n\tif err != nil {\r\n\t\tpanic(err)\r\n\t}\r\n\treturn &FollowIssuerTokenKeyProvider{cache: cache}\r\n}\r\n\r\ntype FollowIssuerTokenKeyProvider struct {\r\n\tcache *lru.Cache\r\n}\r\n\r\nfunc (wa *FollowIssuerTokenKeyProvider) ParseWithClaims(tokenString string, claims jwt.Claims) (*jwt.Token, error) {\r\n\treturn jwt.ParseWithClaims(tokenString, claims, wa.GetKey)\r\n}\r\n\r\nfunc (wa *FollowIssuerTokenKeyProvider) GetKey(token *jwt.Token) (key interface{}, err error) {\r\n\tkc, _ := token.Claims.(jwt.MapClaims)\r\n\tif kc == nil {\r\n\t\treturn nil, errors.New(\"server invalid claims\")\r\n\t}\r\n\tiss, _ := kc[\"iss\"].(string)\r\n\tif iss == \"\" {\r\n\t\treturn nil, errors.New(\"missing issuer\")\r\n\t}\r\n\r\n\t// keycloak\r\n\t// /protocol/openid-connect/certs\r\n\t// common\r\n\t// /.well-known/openid-configuration\r\n\t// TODO refresh\r\n\tcv, _ := wa.cache.Get(iss)\r\n\tset, _ := cv.(jwk.Set)\r\n\tif set == nil {// for keycloak only\r\n\t\tjwkUrl := iss + \"/protocol/openid-connect/certs\"\r\n\t\tset, err = jwk.Fetch(context.Background(), jwkUrl)\r\n\t\tif err != nil {\r\n\t\t\tzap.S().With(\"jwk\", jwkUrl, \"err\", err).Error(\"load jwk\")\r\n\t\t\treturn nil, errors.Wrapf(err, \"load jwk: %q\", jwkUrl)\r\n\t\t}\r\n\t\tzap.S().With(\"jwk\", jwkUrl).Info(\"load jwk\")\r\n\t\twa.cache.Add(iss, set)\r\n\t}\r\n\r\n\tkid, _ := token.Header[\"kid\"].(string)\r\n\tif kid == \"\" {\r\n\t\tkeys, _ := set.Get(0)\r\n\t\tif keys != nil && set.Len() == 1 && keys.KeyID() == \"\" {\r\n\t\t\treturn key, keys.Raw(&key)\r\n\t\t}\r\n\t\treturn nil, errors.New(\"jwt header missing kid\")\r\n\t}\r\n\tif keys, found := set.LookupKeyID(kid); found {\r\n\t\treturn key, keys.Raw(&key)\r\n\t}\r\n\treturn nil, fmt.Errorf(\"jwk key not found: %q\", kid)\r\n}\r\n```\r\n\r\nGetKey should get the current context, but GetClaims can not get context.\r\n\r\nwhen GetClaims, will check the iss domain name first.\r\n\r\nIt's impossible to prefetch pubkey, issuer like `*.example.com` is all valid issuer, they point to different keycloak like service.","createdAt":"2022-01-18T08:01:24Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2382#issuecomment-1015156356","viewerDidAuthor":false},{"id":"IC_kwDODNqesM48rtnF","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"Thanks for the explanation. This would be a breaking change. Let me ask a couple of people what they think and circle back here.","createdAt":"2022-01-21T01:58:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2382#issuecomment-1018091973","viewerDidAuthor":false},{"id":"IC_kwDODNqesM48vQ8I","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"@wenerme, the current interface is more user friendly as it is easier to deal with for most use cases. However, your use case is also a valid case. We don't want to break existing users. So proposal would be to create a separate interface like:\r\n```go\r\ntype RawTokenKeyProvider interface {\r\n\tGetKey(token *jwt.Token) (interface{}, error)\r\n\tSupportedMethods() []string\r\n\tClose()\r\n}\r\n```\r\nAnd adjust defaultJWTClaimMapper so it can work with either interfaces. Basically keep NewDefaultJWTClaimMapper() that takes TokenKeyProvider, and add another one NewDefaultJWTClaimMapperWithRawKeyProvider() that takes RawTokenKeyProvider. \r\nDoes that sounds reasonable? \r\nWe would welcome PR for this if you are willing to contribute. :) ","createdAt":"2022-01-22T02:42:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2382#issuecomment-1019023112","viewerDidAuthor":false}],"createdAt":"2022-01-17T11:53:08Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":2382,"reactionGroups":[],"state":"CLOSED","title":"pass Token to authorization.TokenKeyProvider when get keys","updatedAt":"2022-02-01T00:44:02Z","url":"https://github.com/temporalio/temporal/issues/2382"}
