{"assignees":[],"author":{"id":"MDQ6VXNlcjUxNzY4Mw==","is_bot":false,"login":"Sushisource","name":"Spencer Judge"},"body":"## Expected Behavior\nThe client ought to see a returned status with the `ResourceExhausted` error code, and a message along the lines of \"Can't accept new workflow because `<xyz>`\"\n\n## Actual Behavior\nClient sees `Unknown` error code with this message: \"Cache capacity is fully occupied with pinned elements\" - which, while perhaps a true message, isn't terribly useful.\n\nThis also causes a _ton_ of errors with full stack traces to get dumped into the logs. Since the right thing to do here is just exert back-pressure, it should probably just log some warnings at most.\n\nErrors include (omitting stacks):\n`{\"operation\": \"PollMutableState\", \"wf-namespace\": \"default\", \"error\": \"Cache capacity is fully occupied with pinned elements\", \"logging-call-at\": \"telemetry.go:278\"}`\n\n\n```\n{\n  \"level\": \"error\",\n  \"ts\": \"2023-01-11T10:07:09.909-0800\",\n  \"msg\": \"Persistent fetch operation Failure\",\n  ...\n  \"store-operation\": \"get-wf-execution\",\n  \"error\": \"context canceled\",\n  \"logging-call-at\": \"transaction_impl.go:423\",\n  ...\n```\n\n## Steps to Reproduce the Problem\nI was able to trigger this 100% reliably by starting 1k workflows concurrently against temporalite - the workflows do nothing but run one activity and finish.\n\n## Specifications\n* Version: 1.19 (inside temporalite)\n* Platform: Linux\n\n","closedAt":"2024-03-26T21:26:29Z","comments":[{"id":"IC_kwDODNqesM5kTTlC","author":{"login":"ukd1"},"authorAssociation":"NONE","body":"@Sushisource I've just hit this btw ðŸ˜…","createdAt":"2023-08-17T18:40:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3802#issuecomment-1682782530","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5kVBGK","author":{"login":"ukd1"},"authorAssociation":"NONE","body":"Is there a workaround for this? I don't see an obvious way to change the cache size?","createdAt":"2023-08-18T02:12:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3802#issuecomment-1683231114","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5kYsJl","author":{"login":"yycptt"},"authorAssociation":"MEMBER","body":"Cache size can be configured by changed the value of `history.cacheMaxSize`, but default is 512 which should be large enough unless there's big backlog in transfer/timer task processing. \r\n\r\nAlso if you see the error when using release [v1.21.3](https://github.com/temporalio/temporal/releases/tag/v1.21.3), please upgrade to 1.21.4, .3 version has known issue with the cache size calculation.\r\n\r\nRe. backpressure, looks like this should be a resource exhausted error? cc @yiminc WDYT?","createdAt":"2023-08-18T17:02:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3802#issuecomment-1684193893","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5kxYUj","author":{"login":"ukd1"},"authorAssociation":"NONE","body":"@yiminc thanks - I was running 1.21.3 - I'm upgrading and will report back. \r\n\r\nWhat does \"big backlog\" mean - I might have 100k+ easily?","createdAt":"2023-08-23T21:29:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3802#issuecomment-1690666275","viewerDidAuthor":false},{"id":"IC_kwDODNqesM54faz5","author":{"login":"prathyushpv"},"authorAssociation":"MEMBER","body":"https://github.com/temporalio/temporal/pull/4796 fixed this issue.","createdAt":"2024-03-26T21:26:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3802#issuecomment-2021502201","viewerDidAuthor":false}],"createdAt":"2023-01-11T22:51:40Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":3802,"reactionGroups":[],"state":"CLOSED","title":"Hammering instance w/ small cache count results in ungraceful response to client","updatedAt":"2024-03-26T21:26:29Z","url":"https://github.com/temporalio/temporal/issues/3802"}
