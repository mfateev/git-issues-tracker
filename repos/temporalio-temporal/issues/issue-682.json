{"assignees":[],"author":{"id":"MDQ6VXNlcjE2NzI1NzUw","is_bot":false,"login":"pauldemarco","name":"Paul DeMarco"},"body":"## Expected Behavior\r\nA workflow should be able to signal any workflow using a workflow ID, including itself.\r\n\r\n## Actual Behavior\r\nThrows a UnknownExternalWorkflowExecution when attempting to signal itself.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Try the following workflow code:\r\n```\r\nfunc TestWorkflow(ctx workflow.Context) error {\r\n\twe := workflow.GetInfo(ctx).WorkflowExecution\r\n\terr := workflow.SignalExternalWorkflow(ctx, we.ID, we.RunID, \"messages\", \"hello\").Get(ctx, nil)\r\n\tif err != nil {\r\n\t\tpanic(fmt.Errorf(\"could not signal external workflow: %v\", err))\r\n\t}\r\n\treturn nil\r\n}\r\n```\r\n  2. Error shows in temporal web history:\r\n![image](https://user-images.githubusercontent.com/16725750/90581990-a359b580-e19a-11ea-862a-7e73994c8a82.png)\r\n\r\n  3. The worker logs the error:\r\n```\r\n2020/08/18 21:29:57 ERROR Workflow panic. Namespace default TaskQueue test WorkerID 465773@beast-ubuntu@ WorkflowID TestWorkflow RunID 254db1e2-ebcc-489a-9835-1f5e2e3fb8f8 PanicError could not signal external workflow: UnknownExternalWorkflowExecution PanicStack coroutine root [panic]:\r\nmyproject.com/domain/root.TestWorkflow(0x1003500, 0xc000498a00, 0x0, 0x0)\r\n        /home/paul/myproject.com/domain/root/testworkflow.go:41 +0x17a\r\nreflect.Value.call(0xd69c40, 0xefbd48, 0x13, 0xeaf2fa, 0x4, 0xc000486de0, 0x1, 0x1, 0xfd2270, 0xe8e420, ...)\r\n        /usr/local/go/src/reflect/value.go:460 +0x8ab\r\nreflect.Value.Call(0xd69c40, 0xefbd48, 0x13, 0xc000486de0, 0x1, 0x1, 0xfd2270, 0xe8e420, 0xc0004b4640)\r\n        /usr/local/go/src/reflect/value.go:321 +0xb4\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteWorkflow(0xc0004b4640, 0x1003500, 0xc000498a00, 0xc0000362c0, 0xc, 0x0, 0x0, 0x0, 0x0, 0x0, ...)\r\n        /home/paul/go-sdk/internal/workflow.go:370 +0x2b2\r\ngo.temporal.io/sdk/internal.(*workflowExecutor).Execute(0xc000498940, 0x1003500, 0xc000498a00, 0x0, 0xc0004f3738, 0xc68596, 0x0)\r\n        /home/paul/go-sdk/internal/internal_worker.go:759 +0x334\r\ngo.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func1(0x10036c0, 0xc00009b0e0)\r\n        /home/paul/go-sdk/internal/internal_workflow.go:491 +0xf3\r\n^C2020/08/18 21:30:00 INFO  Stopped Worker Namespace default TaskQueue test WorkerID 465773@beast-ubuntu@\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: 0.28.0\r\n  - Platform: Helm-chart\r\n","closedAt":null,"comments":[{"id":"MDEyOklzc3VlQ29tbWVudDY3NjU2NjI0Nw==","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"This is by design. Server has special code to handle this case: https://github.com/temporalio/temporal/blob/0ae59f62c4d0282aa5b7821706540a7f049473a4/service/history/transferQueueActiveTaskExecutor.go#L456. You may also check: https://github.com/uber/cadence/pull/539 and https://github.com/uber/cadence/issues/531.","createdAt":"2020-08-19T17:41:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/682#issuecomment-676566247","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY3NjU5ODQ3OQ==","author":{"login":"pauldemarco"},"authorAssociation":"NONE","body":"You'll have to forgive me as I'm not very familiar with how signals are handled under the hood.\r\nIMHO, from an end-user perspective, it would be nice if we could SignalWorkflow + SignalWorkflowWithStart from within workflow code and not have to worry about making sure the target workflow is external.\r\nIs there a reason we have a special SignalExternalWorkflow instead of just SignalWorkflow(withStart bool) for workflow context?\r\n\r\n**Note:** I'm aware of the performance implications when sending a signal to self rather than just directly placing in some internal queue. That's a decision I'd like to make for myself as an end-user. If I'm enforcing a signal-driven architecture a top temporal, than I'd like all tasks to be driven by actual Signals that are forced through temporal. Circumventing this feels like a hidden side effect and will not show in monitoring / middleware that I might utilize in the future.","createdAt":"2020-08-19T18:49:00Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/682#issuecomment-676598479","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY3NzM0MjI2MQ==","author":{"login":"samarabbas"},"authorAssociation":"MEMBER","body":"Temporal server does not have support for signal command which tries to send a signal to itself.  Implementation of signal command processing is written in a way where it holds a lock on the source execution while it is writing a signal to target execution.  If source and target are the same then it results in a deadlock and transfer task processing for that signal command will never succeed.  This is the reason server has a protection in place to not allow sending signal to itself.\r\nI agree that it is a side effect of particular implementation choice made for processing of signal command.  But I don't think this is a bug.  I will convert this into a feature request which we could potentially consider to support in the future.\r\n\r\nI still think that a workflow sending a signal to itself does not make much sense as it could simplify send a message through a channel.  I don't see why it requires a full round trip back from server just to deliver a message on signal channel. ","createdAt":"2020-08-20T06:46:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/682#issuecomment-677342261","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY3NzgxMDM5NQ==","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"Probably we should improve error message there though. Report something like `WorkflowCantSignalItself` instead of `UnknownExternalWorkflowExecution` we currently have.","createdAt":"2020-08-20T17:53:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/682#issuecomment-677810395","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY3NzgzMzI1MQ==","author":{"login":"pauldemarco"},"authorAssociation":"NONE","body":"@samarabbas that makes sense. I think the only reason would be to have clear metrics. For instance, Signals per minute in Grafana would not be a true representation of a signal driven architecture if a significant amount of self signals are not being sensed.\r\n\r\nI have things working for now using a local workflow channel, and piping into that from Signal channel and local self signals.\r\n\r\nI would appreciate having this as an enhancement, but if itâ€™s a serious anti pattern to the way things are working under the hood I definitely would not make sacrifices for it.\r\n\r\nThanks.\r\n","createdAt":"2020-08-20T18:42:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/682#issuecomment-677833251","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY3NzkzNzMyOA==","author":{"login":"samarabbas"},"authorAssociation":"MEMBER","body":"Understood.  I have converted this to a future enhancement which we can re-evaluate later.  For now looks like you have a reasonable workaround which is working.","createdAt":"2020-08-20T22:24:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/682#issuecomment-677937328","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5Q6Nu7","author":{"login":"mattpercy-anz"},"authorAssociation":"NONE","body":"Hi @samarabbas, any movement on this? I've just encountered the same problem, and would love to help work towards a solution here","createdAt":"2022-12-19T10:36:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/682#issuecomment-1357437883","viewerDidAuthor":false}],"createdAt":"2020-08-19T01:35:16Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwyNTc2NTM1ODQ2","name":"difficulty: easy","description":"","color":"68d662"},{"id":"MDU6TGFiZWwzMTM4ODI4MTE3","name":"up-for-grabs","description":"Issues to consider for external contribution","color":"69CD90"}],"milestone":null,"number":682,"reactionGroups":[],"state":"OPEN","title":"Signal to self error in Workflow code","updatedAt":"2024-01-17T15:36:10Z","url":"https://github.com/temporalio/temporal/issues/682"}
