{"assignees":[{"id":"MDQ6VXNlcjU1MTU2Nzg=","login":"shawnhathaway","name":"Shawn Hathaway","databaseId":0}],"author":{"id":"MDQ6VXNlcjU1MTU2Nzg=","is_bot":false,"login":"shawnhathaway","name":"Shawn Hathaway"},"body":"**Summary**\r\n\r\n- Ringpop seed membership via config to be removed and instead use the persistence layer to coordinate. \r\n- Support custom host identity in order to support bind on 0.0.0.0 (See Samar's write-up on issue - https://github.com/uber/cadence/issues/2942)\r\n- Support separate broadcast address vs bind address for nat'd networking setups. See Cassandra setting write-up [here](https://docs.datastax.com/en/archived/cassandra/3.0/cassandra/configuration/configCassandra_yaml.html#configCassandra_yaml__broadcast_address).\r\n\r\n**Scope of changes - Configuration Layer**\r\n- Deprecate ringpop.bootstrapMode, ringpop.bootstrapHosts, ringpop.bootstrapFile\r\n  - Bootstrapping from persistence will be the only way moving forward\r\n- Add rpc.BroadcastAddress to support a separate address that will be connected to for ringpop and rpc. \r\n- Add ringpop.CustomHostIdentity to support a unique custom host identity for the cluster and in ringpop. \r\n\r\n**Scope of changes - Persistence Layer**\r\n- General Schema -\r\n```CREATE TABLE cluster_membership\r\n    host_id        string, \r\n    rpc_address    inet,\r\n    session_start  timestamp,\r\n    last_heartbeat timestamp,\r\n    record_expiry timestamp\r\n    PRIMARY KEY (host_id)\r\n```\r\n- `host_id` will be a unique identifier for the host to prevent collisions. The value used is fetched from ringpop.CustomHostIdentity if set, otherwise rpc.BroadcastAddress if set, otherwise from the listening address of ringpop.\r\n- `rpc_address` will be the address to connect to for rpc_operations on this host. The value used will be rpc.BroadcastAddress if set otherwise the listening address of ringpop.\r\n- `session_start` will be the timestamp of the service startup, ie: process lifetime\r\n- `last_heartbeat` will be the timestamp of the last time this row was updated and considered fresh\r\n- TTLs will be supported by using the `record_expiry` field in postgres/mysql and using a db-level trigger created by the schema to perform limited deletions of expired rows on new inserts. This means these tables in these implementations would be lazily cleaned up.\r\n  - The `record_expiry` field will not exist in the Cassandra implementation as the TTL option will be used on insert.\r\n- ClusterMetadata Store/Manager interfaces\r\n  - Add ```GetActiveClusterMembers()```\r\n      - Request - `LastHeartbeatWithin time.Duration`\r\n      - Response - List of Active Cluster Members that have heartbeated since duration\r\n  - Add `UpsertClusterMembership()`\r\n      - Request is represented by schema above with added recordExpiresOn field for TTL creation.\r\n\r\n**Scope of changes - Ringpop Layer**\r\nTo bootstrap itself from the persistence layer, the service will:\r\n   1.  First, write its identity and metadata to the cluster_membership table using `UpsertClusterMembership()`\r\n   1.  Use ```GetActiveClusterMembers()``` to get back current healthy members within say the last 10 minutes.\r\n   1.  Bootstrap ringpop using the values\r\n   1.  Create a go routine to continuing writing its identity to the cluster_membership table on some interval (ie: 1 minute)\r\n\r\nQuestions/Notes:\r\n- What happens if the go routine crashes?\r\n  - Inclination is to continue with metrics/errors in log and allow service to continue to perform work. It will be propagated by other healthy cluster members it had already connected to. If there is a bug, this could lead to a zombie cluster where new nodes would not find any other nodes in the table and form their own cluster.\r\n\r\n\r\n","closedAt":"2020-07-15T18:19:37Z","comments":[],"createdAt":"2020-01-24T21:34:52Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":{"number":1,"title":"Initial Temporal Release","description":"","dueOn":null},"number":83,"reactionGroups":[],"state":"CLOSED","title":"Persisting Ringpop Membership & Custom Host Identity","updatedAt":"2020-07-15T18:19:37Z","url":"https://github.com/temporalio/temporal/issues/83"}
