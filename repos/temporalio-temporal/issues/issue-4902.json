{"assignees":[{"id":"MDQ6VXNlcjQ2NjcyMw==","login":"dnr","name":"David Reiss","databaseId":0}],"author":{"id":"MDQ6VXNlcjIyNzg5ODUx","is_bot":false,"login":"ndtretyak","name":"Nikolay Tretyak"},"body":"**Is your feature request related to a problem? Please describe.**\r\nThere is a `HeadersProvider` interface in the go-sdk which I use together with custom `Authorizer` to implement custom authentication mechanism for workers. But  I couldn't find anything similar to `HeadersProvider` in the server side code. So, I think there is no way to replace client certificates with other authentication method for the requests between Temporal's microservices.\r\n\r\n**Describe the solution you'd like**\r\nI'd like to define some interceptor for all requests between Temporal's microservices, so that these requests contain additional information for custom authentication.\r\n\r\nIf you are okay with this idea, I'd be happy to work on it.\r\n\r\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM5nkqpm","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"This isn't a priority for the team so it's unlikely to happen soon. We do recommend mTLS for securing the connections between services. Depending on the complexity, I think it's possible we could accept something like HeadersProvider as a contribution, but no guarantees. Before spending too much time on it, maybe a proposal with a little more detail (i.e. interfaces) would be helpful.","createdAt":"2023-09-27T15:50:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1737665126","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5oDeYn","author":{"login":"ndtretyak"},"authorAssociation":"CONTRIBUTOR","body":"I've made a draft PR https://github.com/temporalio/temporal/pull/4928 adding `WithClientHeadersProvider` option that accepts `HeadersProvider` interface from the go-sdk.\r\n","createdAt":"2023-10-03T21:18:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":3}}],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1745741351","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5od_jW","author":{"login":"amitbet"},"authorAssociation":"NONE","body":"How is it not a priority, if this means that you have to accept **nil** in the Authorizer in order to allow for inter-process communication? does this not negate the whole concept of the custom auth, and allow anyone without a token to pass?","createdAt":"2023-10-09T09:49:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1752692950","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5oghMS","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"You can use mTLS to secure inter-node communication within a temporal cluster. The Authorizer (custom or otherwise) is not used for inter-node communication, except for one case (server worker→frontend), and you can use internal-frontend to eliminate that case.\r\n\r\nSupporting token-based authentication for worker→frontend is desirable, but the lack of it does not negate the existing security features for external client→frontend traffic.","createdAt":"2023-10-09T16:56:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1753355026","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5ollZC","author":{"login":"amitbet"},"authorAssociation":"NONE","body":"But even when implementing mTLS for worker->frontend and tokens for external, \r\nin order to accept the worker->frontend traffic without a token the Authorizer must allow nil token headers (it can't discern between external and internal traffic) - this means that malicious traffic coming from the outside can create a message with a nil header, and it will go right through auth... \r\n**this makes the whole token based auth mechanism completely useless**\r\nIt might also mean that the Temporal cloud has a huge security vulnerability","createdAt":"2023-10-10T08:26:43Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1754682946","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5opyjN","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"1. The Authorizer is not given TLS connection metadata or tokens, it's given claims from the ClaimMapper. The ClaimMapper is given both TLS metadata and authorization tokens, and can construct claims based on one or the other or both. E.g. it can require either mTLS or a valid token, but not neither; if there's no token, it can require mTLS, if there's no mTLS, it can require a token. (Yes, you can pass anything from ClaimMapper to Authorizer in the Extensions field but that doesn't change the point.)\r\n2. Using internal-frontend gives an easy way to differentiate internal and external traffic without writing a custom ClaimMapper. Internal traffic bypasses the ClaimMapper (i.e. it always gets full admin claims), external traffic does not. It's not the only way to do it, you can also use more complicated TLS configs, but internal-frontend is probably easier.","createdAt":"2023-10-10T16:20:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1755785421","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5oxFUv","author":{"login":"pilotofbalance"},"authorAssociation":"NONE","body":"@dnr in case of implementing custom ClaimMapper, it is not given...not just an authorization.AuthInfo is empty, but **GetClaims** method is not triggered at all, so how token or mTLS could be checked for temporal services or web ui?","createdAt":"2023-10-11T13:25:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1757697327","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5o1qrZ","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"I'm not sure I understand. You can see the logic here: https://github.com/temporalio/temporal/blob/main/common/authorization/interceptor.go#L102\r\n\r\nIf a claim mapper and authorizer are set, and then if either 1. the connection has a client certificate, 2. the connection has an `authorization` header, or 3. the claim mapper returns false for `AuthInfoRequired`, then the claim mapper is called with whatever `AuthInfo` it can put together from those.\r\n\r\n(Note that the change to allow customizing the name of the `authorization` header isn't released yet.)\r\n\r\nI don't know that much about the web ui, but my understanding is that it will forward an `authorization` header with its requests.","createdAt":"2023-10-12T04:38:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1758898905","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5o2UHe","author":{"login":"pilotofbalance"},"authorAssociation":"NONE","body":"@dnr I'm talking about this case: https://github.com/temporalio/samples-server/blob/main/extensibility/authorizer/myClaimMapper.go. Now if you are running only temporal default services + web ui, without any workers, so this method: `func (c myClaimMapper) GetClaims(authInfo *authorization.AuthInfo) (*authorization.Claims, error) {` is not even triggered, if it's not triggered, you can't really check client cert or auth header and return claims with some flag. Although this method is always triggered `\r\nfunc (a *myAuthorizer) Authorize(_ context.Context, claims *authorization.Claims,\r\n\ttarget *authorization.CallTarget) (authorization.Result, error) {\r\n` ,but with no claims (nil)","createdAt":"2023-10-12T07:19:47Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1759068638","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5o5eKp","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"Can you confirm that the web ui sending a grpc header named `authorization`? If it is, and the claim mapper is still not getting called, then that's a bug and we should probably split it to another issue. My guess is that the web ui is not sending that header for some reason.","createdAt":"2023-10-12T15:53:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1759896233","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5pABth","author":{"login":"pilotofbalance"},"authorAssociation":"NONE","body":"@dnr let's say I'm a hacker and I'm running my own web ui, I decided not to send `authorization` token to the temporal cluster? Temporal cluster should validate token or certificate in any case and not cos web ui or other internal temporal services have it...pls, try to run this code https://github.com/temporalio/samples-server/tree/main/extensibility/authorizer and debug ClaimMapper method you will see that it's never called.","createdAt":"2023-10-13T14:26:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1761614689","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5pAHc1","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"If you don't send an authorization token and don't authenticate with a client cert, then as you said, the claim mapper is not called, and `claims` will be `nil` when passed to the Authorizer. The authorizer (either default or custom) should reject any request with nil claims, except for health checks. I still don't see any problem here.","createdAt":"2023-10-13T14:42:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1761638197","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5pAkZ-","author":{"login":"pilotofbalance"},"authorAssociation":"NONE","body":"@dnr so we are returning to the original issue, there is no option to send authorization token from \"matching\", \"history\" and \"worker\" services to the \"frontend\" and this is what this PR is about, as you said the only option is to configure mTLS, but then there is no point for custom authorizer and claimMapper implementation, they just useless..(btw you just mentioned health checks, how I can recognize health check in case of **nil** claims?)","createdAt":"2023-10-13T16:04:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1761756798","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5pA2O8","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"Yes, we should fix the original issue. No, the lack of ability to send tokens for internode communication does not mean that custom authorizer+claimmappers are useless: it's perfectly reasonable to use mTLS to authenticate internode communication and tokens to authenticate external clients, and you can do that with the current state of the code.\r\n\r\nFor health checks, see https://github.com/temporalio/temporal/blob/main/common/authorization/frontend_api.go#L46. The default authorizer allows calls to those two methods even with no claims, and you probably want to have your custom authorizer do the same. This allows kubernetes or similar systems to do readiness probes without needing to use mTLS there.","createdAt":"2023-10-13T17:02:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1761829820","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5pEmfJ","author":{"login":"pilotofbalance"},"authorAssociation":"NONE","body":"@dnr I didn't find it in temporal documentation...you said that for custom Authorizer and ClaimMapper there have to be `external frontend` and for temporal services `internal frontend` with mTLS...may be it worth it to provide kinda example or at least HL documentation..\r\nDefault authorizer require \"sub\" claim which should be optional and not mandatory + in my case only I can't change token structure and include \"permissions\"","createdAt":"2023-10-14T10:37:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4902#issuecomment-1762813897","viewerDidAuthor":false}],"createdAt":"2023-09-26T14:30:14Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":4902,"reactionGroups":[],"state":"OPEN","title":"Custom authentication between frontend and other services","updatedAt":"2023-10-14T10:37:51Z","url":"https://github.com/temporalio/temporal/issues/4902"}
