{"assignees":[{"id":"MDQ6VXNlcjQ2NjcyMw==","login":"dnr","name":"David Reiss","databaseId":0}],"author":{"id":"MDQ6VXNlcjExODM1Mw==","is_bot":false,"login":"antstorm","name":"Anthony D"},"body":"## Expected Behavior\r\n\r\nWhen cancelling polling requests workflow & activity tasks should not get dropped, but instead dispatched to a different poller or wait until there's an available poller\r\n\r\n## Actual Behavior\r\n\r\nBoth workflow & activity tasks can get dropped resulting in a timeout and a later retry.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Single worker / server setup, create workflow that schedules lots of parallel activities (e.g. 100)\r\n  2. Start the workflow\r\n  3. Restart the worker (Ctrl+C & launch again) couple times while it's churning through the activities\r\n  4. At this point there should be activity and/or workflow tasks hanging waiting for a timeout and not dispatched to the worker\r\n\r\n## Specifications\r\n\r\n  - Version: 1.3.2\r\n  - Platform: MacOS X\r\n","closedAt":"2023-11-11T05:06:05Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDc0MTAwNDkwOA==","author":{"login":"antstorm"},"authorAssociation":"CONTRIBUTOR","body":"CC @mfateev ","createdAt":"2020-12-08T20:47:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1058#issuecomment-741004908","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc0MTAxMzM0MQ==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"just some clarification:\r\n\r\nif a task is polled by the worker then worker restart, timeout is the correct behavior.\r\n\r\ncan you check the workflow history events? specifically looking for `WorkflowTaskStarted` and `ActivityTaskStarted`\r\nif above events exists, it means the workers / pollers already have the task and only thing server can do is timeout.","createdAt":"2020-12-08T20:54:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1058#issuecomment-741013341","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc0MTA1NDQyMw==","author":{"login":"antstorm"},"authorAssociation":"CONTRIBUTOR","body":"@wxing1292 I'm closely monitoring the GRPC responses on the poller and can confirm that poll requests are getting canceled and no tasks are received when this happens. So it's not like the worker drops these tasks, but more looks like they are dispatched over a cancelled GRPC channel (I'm speculating here).\r\n\r\n\"Started\" events do not exist in these cases, activities time out with the \"started_event_id\" of zero (see the screenshot attached).\r\n\r\n<img width=\"1422\" alt=\"Screenshot 2020-12-08 at 21 18 55\" src=\"https://user-images.githubusercontent.com/118353/101543029-91935c80-399b-11eb-97ef-4cf32b143101.png\">\r\n","createdAt":"2020-12-08T21:23:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1058#issuecomment-741054423","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc0MTA3Njc1Nw==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"@antstorm thanks for reporting the issue, we will look into this","createdAt":"2020-12-08T21:40:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/1058#issuecomment-741076757","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc0NzgwODA4OQ==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"@antstorm \r\ncould you plz provide the activity timeout settings? especially the schedule to start timeout configuration, seems that the timeout is 10s, meaning the activity is timed out before server able to dispatch the tasks (since workers are being restarted) \r\n(did not notice the short timeout before.)\r\n\r\n","createdAt":"2020-12-18T01:24:23Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1058#issuecomment-747808089","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg3MzY1MDAwMQ==","author":{"login":"samarabbas"},"authorAssociation":"MEMBER","body":"@mmcshane looks like we need some help with reproducing this issue.  The claim is we are dispatching tasks over a cancelled connection.","createdAt":"2021-07-04T19:43:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1058#issuecomment-873650001","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5rr-Vp","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Not repro.","createdAt":"2023-11-11T05:06:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1058#issuecomment-1806689641","viewerDidAuthor":false}],"createdAt":"2020-12-08T20:47:09Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"},{"id":"MDU6TGFiZWwzMTM4ODUyODY2","name":"needs-investigation","description":"","color":"0052cc"}],"milestone":null,"number":1058,"reactionGroups":[],"state":"CLOSED","title":"Dropped tasks when cancelling polling requests under load","updatedAt":"2023-11-11T05:06:05Z","url":"https://github.com/temporalio/temporal/issues/1058"}
