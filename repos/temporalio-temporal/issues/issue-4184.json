{"assignees":[{"id":"MDQ6VXNlcjIwNjgxMjQ=","login":"rodrigozhou","name":"Rodrigo Zhou","databaseId":0}],"author":{"id":"MDQ6VXNlcjE0NjQ1MTk=","is_bot":false,"login":"wilsoniya","name":"Michael Wilson"},"body":"## Expected Behavior\r\n**Log behavior**: `temporal-history` visibility queue processor can process JSONB fields.\r\n**UI behavior**:  Actually completed workflows are shown as _Completed_ in both the workflow list and details UIs.\r\n\r\n## Actual Behavior\r\n**Logged behavior**: `temporal-history` visibility queue processor apparently fails to read rows containing JSONB fields, failing with the error: `pq: unsupported jsonb version number 123`. \r\n\r\nIn my limited spot checking, Temporal appears otherwise functional. Hello world and more realistic workflows complete as expected.\r\n\r\nLogging example:\r\n\r\n```\r\n{\"level\":\"error\",\"ts\":\"2023-04-18T21:24:12.940Z\",\"msg\":\"Operation failed with an error.\",\"error\":\"pq: unsupported jsonb version number 123\",\"logging-call-at\":\"visiblity_manager_metrics.go:258\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error                                                                                               /home/runner/work/temporal/temporal/common/log/zap_logger.go:150\r\ngo.temporal.io/server/common/persistence/visibility.(*visibilityManagerMetrics).updateErrorMetric\r\n    /home/runner/work/temporal/temporal/common/persistence/visibility/visiblity_manager_metrics.go:258\r\ngo.temporal.io/server/common/persistence/visibility.(*visibilityManagerMetrics).RecordWorkflowExecutionClosed\r\n    /home/runner/work/temporal/temporal/common/persistence/visibility/visiblity_manager_metrics.go:102\r\ngo.temporal.io/server/service/history.(*visibilityQueueTaskExecutor).recordCloseExecution\r\n    /home/runner/work/temporal/temporal/service/history/visibilityQueueTaskExecutor.go:443\r\ngo.temporal.io/server/service/history.(*visibilityQueueTaskExecutor).processCloseExecution\r\n    /home/runner/work/temporal/temporal/service/history/visibilityQueueTaskExecutor.go:392\r\ngo.temporal.io/server/service/history.(*visibilityQueueTaskExecutor).Execute\r\n    /home/runner/work/temporal/temporal/service/history/visibilityQueueTaskExecutor.go:120\r\ngo.temporal.io/server/service/history/queues.(*executableImpl).Execute\r\n    /home/runner/work/temporal/temporal/service/history/queues/executable.go:203\r\ngo.temporal.io/server/common/tasks.(*FIFOScheduler[...]).executeTask.func1\r\n    /home/runner/work/temporal/temporal/common/tasks/fifo_scheduler.go:231\r\ngo.temporal.io/server/common/backoff.ThrottleRetry.func1\r\n    /home/runner/work/temporal/temporal/common/backoff/retry.go:175\r\ngo.temporal.io/server/common/backoff.ThrottleRetryContext\r\n    /home/runner/work/temporal/temporal/common/backoff/retry.go:199\r\ngo.temporal.io/server/common/backoff.ThrottleRetry\r\n    /home/runner/work/temporal/temporal/common/backoff/retry.go:176\r\ngo.temporal.io/server/common/tasks.(*FIFOScheduler[...]).executeTask\r\n    /home/runner/work/temporal/temporal/common/tasks/fifo_scheduler.go:241\r\ngo.temporal.io/server/common/tasks.(*FIFOScheduler[...]).processTask\r\n    /home/runner/work/temporal/temporal/common/tasks/fifo_scheduler.go:217\"}\r\n```\r\n**UI behavior**: Actually completed workflows are shown as _Running_ in the workflow list UI, but _Completed_ in the details UI. I do not believe the root cause is related to https://github.com/temporalio/temporal/issues/888\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. run temporal (see platform notes)\r\n  1. run hello world workflow\r\n  1. load workflow list UI\r\n  1. compare to workflow detail UI\r\n\r\n## Specifications\r\n\r\n  - Version:\r\n    - Temporal: `1.20.0`\r\n    - UI version: `2.13.1`\r\n    - Visibility schema version: `1.2`\r\n  - Platform:\r\n    - deployment: Native, on `Linux xxxx 5.4.0-42-generic #46-Ubuntu SMP Fri Jul 10 00:24:02 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux`\r\n    - database: `PostgreSQL 14.5 (Ubuntu 14.5-2.pgdg22.04+2) on x86_64-pc-linux-gnu, compiled by gcc (Ubuntu 11.2.0-19ubuntu1) 11.2.0, 64-bit`\r\n    - database note: Postgres is served behind pgbouncer for connection pooling. This configuration requires temporal configured with `persistence.datastores.postgres-{default,visibility}.sql.connectAttributes.binary_parameters = yes` in order to run in transaction pooling mode. I'm running `PgBouncer 1.17.0`\r\n\r\n## TL;DR\r\nThe combination of Temporal `1.20.0+`, visibility schema version `1.2+`, pgbouncer run in transaction pooling mode, and temporal configured to use postgres with the `binary_parameters` flag set is apparently causing `temporal-history` to fail reading rows within the visibility queue processor. This somehow prevents the web UI from updating rows in the workflow list with the latest execution status.\r\n\r\n## Context\r\n* pgbouncer, prepared statements, and pooling: https://blog.bullgare.com/2019/06/pgbouncer-and-prepared-statements/\r\n* Underlying issue in `pq`: https://github.com/lib/pq/issues/528\r\n* https://community.temporal.io/t/postgres-pq-pgbouncer-and-prepared-statements/5644\r\n","closedAt":"2023-10-27T21:48:38Z","comments":[{"id":"IC_kwDODNqesM5asbJQ","author":{"login":"igorsechyn"},"authorAssociation":"NONE","body":"We are now hitting the same issue on our cluster. Is there a workaround or a timeline on fixing this issue? Also how big of an issue is this error? We are currently being alerted on it, but we could try to mute alerts on this error, if it is harmless","createdAt":"2023-04-25T11:00:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4184#issuecomment-1521594960","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5a0qrj","author":{"login":"wilsoniya"},"authorAssociation":"NONE","body":"> Is there a workaround ...? \r\n\r\n@igorsechyn I haven't tested this but I see two possible workarounds, both involving disabling the `binary_parameters` configuration:\r\n- circumvent pgbouncer, i.e., give up connection pooling and connect temporal directly to postgres\r\n- reconfigure pgbouncer to operate in session pooling mode, see: https://www.pgbouncer.org/config.html . Seems like this workaround is roughly equivalent to the first\r\n\r\nThis may or may not be possible given how you've deployed postgres (e.g., if you're using a managed service).","createdAt":"2023-04-26T16:55:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4184#issuecomment-1523755747","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5a1ORt","author":{"login":"igorsechyn"},"authorAssociation":"NONE","body":"> circumvent pgbouncer, i.e., give up connection pooling and connect temporal directly to postgres\r\n\r\nyeah, thats what we currently do, but really want to move to pgbouncer for better connection management. ","createdAt":"2023-04-26T18:58:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/4184#issuecomment-1523901549","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5bAbAX","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"I didn't have the chance to try yet, and I'm not familiar with pgbouncer, but based this discussion (https://github.com/lib/pq/issues/528), I have guess to make it work.\r\n\r\nCould you try changing this [block of code](https://github.com/temporalio/temporal/blob/7a24d8efbf6a16f3d7ba2e51096bbadf9213f6ff/common/persistence/sql/sqlplugin/visibility.go#L132-L137) to something like this?\r\n\r\n```go\r\nfunc (vsa VisibilitySearchAttributes) Value() (driver.Value, error) {\r\n\tif vsa == nil {\r\n\t\treturn nil, nil\r\n\t}\r\n\tret, err := json.Marshal(vsa)\r\n\tif err != nil {\r\n\t\treturn nil, err\r\n\t}\r\n\treturn string(ret), nil\r\n}\r\n```\r\n\r\nLet me know if it works.","createdAt":"2023-04-28T01:05:23Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4184#issuecomment-1526837271","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5bUVFM","author":{"login":"wilsoniya"},"authorAssociation":"NONE","body":"> Let me know if it works.\r\n\r\n@rodrigozhou thank you for looking into this :) Unfortunately, compiling and deploying a custom artifact in order to validate this fix isn't something I can easily do. Are you able to attempt a reproduction e.g., using docker-compose?","createdAt":"2023-05-02T19:48:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4184#issuecomment-1532055884","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5cRtG1","author":{"login":"wilsoniya"},"authorAssociation":"NONE","body":"Hi there, just checking to see if there has been any movement on this issue. Thank you!","createdAt":"2023-05-15T16:06:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4184#issuecomment-1548145077","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5qTseB","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"@wilsoniya Support for pgx was added recently in https://github.com/temporalio/temporal/pull/4913.\r\n\r\nI'm closing the issue for now. Feel free to re-open if necessary.","createdAt":"2023-10-27T21:48:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4184#issuecomment-1783547777","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5qWK4G","author":{"login":"igorsechyn"},"authorAssociation":"NONE","body":"@rodrigozhou just to confirm, `pgx support` has not been released yet right? when it is released, we will be able to switch to the new driver, which will also support transaction mode in pg bouncer?","createdAt":"2023-10-29T18:54:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4184#issuecomment-1784196614","viewerDidAuthor":false}],"createdAt":"2023-04-18T22:14:21Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4184,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":4}}],"state":"CLOSED","title":"temporal-history: pq: unsupported jsonb version number 123","updatedAt":"2023-10-29T18:54:34Z","url":"https://github.com/temporalio/temporal/issues/4184"}
