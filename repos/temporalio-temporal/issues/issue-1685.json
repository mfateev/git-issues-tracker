{"assignees":[],"author":{"id":"MDQ6VXNlcjE3NTA2NDQx","is_bot":false,"login":"rfwagner","name":"Richard Wagner"},"body":"It would be extremely useful to be able to do server side tracking of instances of workflow non-determinism.\r\n\r\nThis would allow operators to be able to pro-actively notify customers of problems with their workflows - ideally in a QA or staging environment, before the problematic code makes it to production.\r\n\r\nOne way to do this would be to add a field to the RespondWorkflowTaskFailedResponse that indicates the failure was caused by non-determinism in the worker code. The frontend could then emit a metric based on this server-side.\r\n\r\nIn addition it would be useful to add client side metrics on this also, so that customers could monitor their own metrics and watch for this.","closedAt":"2022-02-12T05:34:29Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg2ODg0MTYxNA==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"have your tried `service_errors_nondeterministic` metrics?","createdAt":"2021-06-25T21:25:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1685#issuecomment-868841614","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg3MDA4NDkwMw==","author":{"login":"rfwagner"},"authorAssociation":"NONE","body":"I didn't see any `service_errors_nondeterministic` metrics during the most recent example we saw.  Here is the exception we saw in the worker logs for that incident.\r\n\r\n```\r\n21:50:52,893 ERROR PollerOptions:138 - uncaught exception\r\njava.lang.RuntimeException: Failure processing workflow task. WorkflowId=9914c98c-5248-4fb9-b1fe-8f632ceeadef, RunId=9d15868b-0f88-452b-a04c-3585b016b067\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.wrapFailure(WorkflowWorker.java:337)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.wrapFailure(WorkflowWorker.java:275)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:79)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n\tat java.base/java.lang.Thread.run(Thread.java:834)\r\nCaused by: io.temporal.internal.replay.InternalWorkflowTaskException: Failure handling event 39 of 'EVENT_TYPE_ACTIVITY_TASK_SCHEDULED' type. IsReplaying=true, PreviousStartedEventId=37, workflowTaskStartedEventId=60, Currently Processing StartedEventId=37\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:193)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleEvent(ReplayWorkflowRunTaskHandler.java:140)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:180)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:150)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithEmbeddedQuery(ReplayWorkflowTaskHandler.java:204)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:114)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:309)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:275)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:73)\r\n\t... 3 more\r\nCaused by: java.lang.IllegalStateException: COMMAND_TYPE_SCHEDULE_ACTIVITY_TASK doesn't match EVENT_TYPE_ACTIVITY_TASK_SCHEDULED with EventId=39\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.assertMatch(WorkflowStateMachines.java:784)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.validateCommand(WorkflowStateMachines.java:737)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleCommandEvent(WorkflowStateMachines.java:272)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEventImpl(WorkflowStateMachines.java:199)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:178)\r\n```","createdAt":"2021-06-28T22:20:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1685#issuecomment-870084903","viewerDidAuthor":false},{"id":"IC_kwDODNqesM49z2is","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"This is done: https://github.com/temporalio/temporal/blob/b99986f05982cbe7184f6d5ff84fa946ac94a840/service/frontend/workflowHandler.go#L970-L977","createdAt":"2022-02-12T05:34:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1685#issuecomment-1037002924","viewerDidAuthor":false}],"createdAt":"2021-06-24T17:51:02Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwyMDE5NzgzNzUw","name":"API","description":"Issues/features involving the API","color":"3d910f"},{"id":"MDU6TGFiZWwyMDE5OTIzNjU1","name":"devexp","description":"","color":"9350b7"},{"id":"MDU6TGFiZWwzMTM4ODI4MTE3","name":"up-for-grabs","description":"Issues to consider for external contribution","color":"69CD90"}],"milestone":null,"number":1685,"reactionGroups":[],"state":"CLOSED","title":"Enhance RespondWorkflowTaskFailedResponse payload to include indication that non-determinism caused failure","updatedAt":"2022-02-12T05:34:29Z","url":"https://github.com/temporalio/temporal/issues/1685"}
