{"assignees":[{"id":"MDQ6VXNlcjg0NDExMDE0","login":"yiminc","name":"Yimin Chen","databaseId":0}],"author":{"id":"MDQ6VXNlcjUxNDkzMg==","is_bot":false,"login":"antmendoza","name":"Antonio Mendoza PÃ©rez"},"body":"## Expected Behavior\r\nScheduling a cronjob with an invalid date e.g `* * 31 2 *`  should return an immediate error (as it happens when trying to start a corn job with a invalid CronSchedule  e.g. `* * 31 2 a`\r\n\r\n## Actual Behavior\r\n\r\nReported by a user \r\n\r\n--- \r\n\r\n\r\nWe seem to have found an edge case that makes client request timeout on ExecuteWorkflow call to Temporal, suggesting there is possibly an infinite loop server side when evaluating a cron schedule.\r\n\r\nFollowing is an extract of our Golang code using temporal client v1.21.1 to execute a workflow. \r\n\r\n```\r\nfunc (t *temporal) Create(ctx context.Context, projectId uuid.UUID, envId uuid.UUID, plan schedule.Plan) error {\r\n    workflowOptions := client.StartWorkflowOptions{\r\n        ID:           plan.ID,\r\n        TaskQueue:    \"CloudEventEmitter\",\r\n        CronSchedule: \"* * 31 2 *\",\r\n    }\r\n\r\n    se := schedule.Event{\r\n        ProjectID:     \"projectid\",\r\n        EnvironmentID: \"envid\",\r\n    }\r\n\r\n    _, err := t.client.ExecuteWorkflow(ctx, workflowOptions, workflowName, se)\r\n    if err != nil {\r\n        return handleError(err)\r\n    }\r\n\r\n    return nil\r\n}\r\n\r\n```\r\nIt works fine with various Cron entries, but \"* * 31 2 *\" seems to make request timeout as is not a valid date even though it is valid cron syntax.\r\n\r\nUsing github.com/robfig/cron library (as found to be the lib used by [temporal](https://github.com/temporalio/temporal/blob/master/go.mod)) we managed to put further validation on this case in our code with the following:\r\n\r\n```\r\n       [ parser := cron.NewParser(cron.Minute | cron.Hour | cron.Dom | cron.Month | cron.Dow)](https://github.com/temporalio/temporal/blob/master/go.mod)\r\n       [ s, err := parser.Parse(plan.Schedule)](https://github.com/temporalio/temporal/blob/master/go.mod)\r\n       [ if err != nil || time.Now().After(s.Next(time.Now())) {](https://github.com/temporalio/temporal/blob/master/go.mod)\r\n           [ return errors.New(\"Invalid cron schedule\") ](https://github.com/temporalio/temporal/blob/master/go.mod)\r\n       [ }](https://github.com/temporalio/temporal/blob/master/go.mod)\r\n```\r\n\r\nAs next schedule time seems to resolve to \"0001-01-01 00:00:00 +0000 UTC\" in that case.\r\n\r\nWe have not managed to find other cases where cron schedule would cause a timeout but wanted to raise it to the team as it's possible other entries might cause a similar problem, and we are not fully aware of what side effects it has on the Temporal side.\r\n\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1.\r\n  1.\r\n  1.\r\n\r\n## Specifications\r\n\r\n  - Version:\r\n  - Platform:\r\n","closedAt":"2023-04-28T21:53:13Z","comments":[{"id":"IC_kwDODNqesM5bFWn2","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"https://github.com/temporalio/temporal/pull/4206","createdAt":"2023-04-28T21:53:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4182#issuecomment-1528130038","viewerDidAuthor":false}],"createdAt":"2023-04-18T13:03:24Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4182,"reactionGroups":[],"state":"CLOSED","title":"[possible bug] ExecuteWorkflow with CronSchedule can lead to client timeout in edge case(s)","updatedAt":"2023-04-28T21:53:14Z","url":"https://github.com/temporalio/temporal/issues/4182"}
