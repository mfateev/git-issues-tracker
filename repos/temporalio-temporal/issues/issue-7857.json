{"assignees":[],"author":{"id":"MDQ6VXNlcjU5OTA5MjIz","is_bot":false,"login":"ujala-singh","name":"Ujala Singh"},"body":"### **Summary**\nAfter enabling JWT authorization on Temporal cluster, system workers (like history scanner) fail to authenticate and cannot connect to the frontend service, resulting in \"Request unauthorized\" errors.\nEnvironment\n\n**Temporal Version: 1.24.3**\nAuthentication Method: JWT with Keycloak/OIDC\nCluster Configuration: Single frontend service with JWT authorization enabled\n\n### **Problem Description**\nWhen JWT authorization is enabled on a Temporal cluster, internal system workers cannot authenticate with the frontend service and fail with authorization errors. This appears to be a common issue where system workers need authentication credentials but there's no clear documentation or configuration method to provide them.\n\n**Error Details**\n```\n{\n  \"level\": \"error\",\n  \"ts\": \"2025-06-03T01:04:50.770Z\",\n  \"msg\": \"error starting temporal-sys-history-scanner-workflow workflow\",\n  \"service\": \"worker\",\n  \"error\": \"Request unauthorized.\",\n  \"logging-call-at\": \"scanner.go:289\",\n  \"stacktrace\": \"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/log/zap_logger.go:156\\ngo.temporal.io/server/service/worker/scanner.(*Scanner).startWorkflow\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/service/worker/scanner/scanner.go:289\\ngo.temporal.io/server/service/worker/scanner.(*Scanner).startWorkflowWithRetry.func1\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/service/worker/scanner/scanner.go:259\\ngo.temporal.io/server/common/backoff.ThrottleRetryContext\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/backoff/retry.go:143\\ngo.temporal.io/server/service/worker/scanner.(*Scanner).startWorkflowWithRetry\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/service/worker/scanner/scanner.go:258\"\n}\n```\n### **Current Configuration**\n**Authorization Configuration**\n```\nauthorization:\n  jwtKeyProvider:\n    keySourceURIs:\n      - https://myapp.domain.com/auth/realms/default/protocol/openid-connect/certs\n    refreshInterval: \"1m\"\n  permissionsClaimName: \"permissions\"\n  authorizer: default\n  claimMapper: default\n```\n**Services Configuration**\n```\nservices:\n    frontend:\n      httpPort: 7243\n      membershipPort: 6933\n      port: 7233\n      replicas: 2\n      resources:\n        limits:\n          cpu: 100m\n          memory: 256Mi\n        requests:\n          cpu: 100m\n          memory: 256Mi\n    history:\n      httpPort: 0\n      membershipPort: 6934\n      port: 7234\n      replicas: 2\n      resources:\n        limits:\n          cpu: 100m\n          memory: 256Mi\n        requests:\n          cpu: 100m\n          memory: 256Mi\n    matching:\n      httpPort: 0\n      membershipPort: 6935\n      port: 7235\n      replicas: 2\n      resources:\n        limits:\n          cpu: 100m\n          memory: 256Mi\n        requests:\n          cpu: 100m\n          memory: 256Mi\n    worker:\n      httpPort: 0\n      membershipPort: 6939\n      port: 7239\n      replicas: 2\n      resources:\n        limits:\n          cpu: 100m\n          memory: 256Mi\n        requests:\n          cpu: 100m\n          memory: 256Mi\n```\n### **Expected Behavior**\nSystem workers should be able to operate normally when JWT authorization is enabled, either by:\n\nHaving a built-in bypass mechanism for system operations\nSupporting configuration of JWT credentials for system workers\nClear documentation on how to configure system worker authentication\n\n### **Actual Behavior**\nSystem workers fail with \"Request unauthorized\" errors and cannot perform essential operations like history scanning, workflow cleanup, etc.","closedAt":"2025-06-26T22:54:56Z","comments":[{"id":"IC_kwDODNqesM6u5lMN","author":{"login":"1nu"},"authorAssociation":"NONE","body":"You'll want to use internal-frontend for the easiest integration.\n\nIt is mentioned in the release notes here: https://github.com/temporalio/temporal/releases/tag/v1.20.0 under \"Internal frontend\" It was introduced exactly to support this purpose.\n\nAnother option is to use mTLS but this requires integration in the claim mapper, similar to https://github.com/temporalio/samples-server/tree/main/tls/tls-full ","createdAt":"2025-06-03T09:24:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7857#issuecomment-2934330125","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6vJRrQ","author":{"login":"ujala-singh"},"authorAssociation":"NONE","body":"@1nu if we don't want to use mTLS for now, the only option is to use `Internal frontend` deployment.\n\n```\ninternalFrontend:\n   enabled: true\n```","createdAt":"2025-06-04T04:29:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7857#issuecomment-2938444496","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6zb5Fq","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Seems like this is working as intended by using an internal frontend role.","createdAt":"2025-06-26T22:54:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7857#issuecomment-3010433386","viewerDidAuthor":false}],"createdAt":"2025-06-03T08:59:17Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":7857,"reactionGroups":[],"state":"CLOSED","title":"System Worker fails to authenticate after enabling JWT authorization","updatedAt":"2025-06-26T22:54:56Z","url":"https://github.com/temporalio/temporal/issues/7857"}
