{"assignees":[],"author":{"id":"MDQ6VXNlcjI5NTc0MTc1","is_bot":false,"login":"cda0011","name":"Conor Allen"},"body":"## Expected Behavior\r\nWhen repeatedly running tctl -n prd workflow list --pdt --query=\"ExecutionStatus=1\"\r\n\r\nI would expect that it would return the same empty list \r\n```\r\ntemporal-admintools-9bccdbb6f-wt4jj:/etc/temporal$ tctl --ns prd workflow list --pdt --query=\"ExecutionStatus=1\"\r\n  WORKFLOW TYPE | WORKFLOW ID | RUN ID | TASK QUEUE | START TIME | EXECUTION TIME | END TIME\r\ntemporal-admintools-9bccdbb6f-wt4jj:/etc/temporal$ tctl --ns prd workflow list --pdt --query=\"ExecutionStatus=1\"\r\n     WORKFLOW TYPE    |                                 WORKFLOW ID                                 |                RUN ID                |         TASK QUEUE          |      START TIME      |    EXECUTION TIME    |       END TIME\r\n  create-dce-key      | fb8c5155-25a6-44a0-a9d4-cfb3c177961b                                        | b0a74e13-3274-4f5b-9e85-af70fec2a718 | prd.keycustodian.command | 2024-01-29T11:03:14Z | 2024-01-29T11:03:14Z | 0001-01-01T00:00:00Z\r\n  mutex-workflow      | mutex-id-piedpiper::6c67b887-b967-3e01-adab-19f07885d6ed                    | 6cd24d0b-5fa1-4420-9f18-9127b590c7ab | prd.keycustodian.command | 2024-01-29T11:03:13Z | 2024-01-29T11:03:13Z | 0001-01-01T00:00:00Z\r\n  vault-commands      | prd.attribute.pv-xQ/wsEgMSyL4pTEumHs7nTpNrHI8Rd1LdpfqyK8DynQ=            | eb31859e-2ac8-47ae-8f14-0718d4957d5c | prd.attribute.commands   | 2024-01-29T11:03:13Z | 2024-01-29T11:03:13Z | 0001-01-01T00:00:00Z\r\n  mutex-workflow      | mutex-id-piedpiper::ca1f5c5b-2907-3b75-b08d-1b4cdcdbcdd8                    | a1c72520-ad82-4c1e-b706-986f981af3a9 | prd.keycustodian.command | 2024-01-29T11:03:13Z | 2024-01-29T11:03:13Z | 0001-01-01T00:00:00Z\r\n  create-dce-key      | c7cab2ef-1fd9-4e6a-9b9f-3b778d588be6                                        | a8d26afa-f2a4-48cc-ab70-59d13b4edc2d | prd.keycustodian.command | 2024-01-29T11:03:12Z | 2024-01-29T11:03:12Z | 0001-01-01T00:00:00Z\r\n  create-dce-key      | 9e726b71-b8a0-41df-aabc-72fe767c6539                                        | cdd407bc-3115-479e-b74f-b36b9d5425f9 | prd.keycustodian.command | 2024-01-29T11:03:12Z | 2024-01-29T11:03:12Z | 0001-01-01T00:00:00Z\r\n  create-dce-key      | 0c1e5cf6-45ae-4e4f-8aa5-70ac2be9e6d4                                        | 20340756-1870-4624-a052-8bf124ceaeba | prd.keycustodian.command | 2024-01-29T11:03:12Z | 2024-01-29T11:03:12Z | 0001-01-01T00:00:00Z\r\n  mutex-workflow      | mutex-id-piedpiper::31f62401-6c0d-31f0-a6bb-d690ae1321a7                    | 45f0729b-231b-428d-8d81-f1bc8f0c2d3c | prd.keycustodian.command | 2024-01-29T11:03:12Z | 2024-01-29T11:03:12Z | 0001-01-01T00:00:00Z\r\n  mutex-workflow      | mutex-id-piedpiper::79e1a9ba-1f9e-32ea-93ae-0d9a02ede62c                    | 3d5409da-2911-490d-bcf7-92ea9796d896 | prd.keycustodian.command | 2024-01-29T11:03:12Z | 2024-01-29T11:03:12Z | 0001-01-01T00:00:00Z\r\n  update-search-index | vault-service:search-indexer:piedpiper:8e98a171-a0c6-338c-b311-a74c1e57378e | 79b5acd1-c6ac-4df6-b366-592e12d902d0 | prd.vault.commands       | 2024-01-29T11:02:37Z | 2024-01-29T11:02:37Z | 0001-01-01T00:00:00Z\r\n\r\n```\r\n\r\n## Actual Behavior\r\nWhen running \r\n```\r\ntctl -n prd workflow list --pdt --query=\"ExecutionStatus=1\"\r\n```\r\nmultiple times, occasionally a set of completed WFs are returned, as shown above\r\nExamining one of those WFs shows\r\n```\r\ntemporal-admintools-9bccdbb6f-wt4jj:/etc/temporal$ tctl --ns prd workflow desc -w c7cab2ef-1fd9-4e6a-9b9f-3b778d588be6\r\n{\r\n  \"executionConfig\": {\r\n    \"taskQueue\": {\r\n      \"name\": \"prd.keycustodian.command\",\r\n      \"kind\": \"Normal\"\r\n    },\r\n    \"workflowExecutionTimeout\": \"0s\",\r\n    \"workflowRunTimeout\": \"0s\",\r\n    \"defaultWorkflowTaskTimeout\": \"10s\"\r\n  },\r\n  \"workflowExecutionInfo\": {\r\n    \"execution\": {\r\n      \"workflowId\": \"c7cab2ef-1fd9-4e6a-9b9f-3b778d588be6\",\r\n      \"runId\": \"a8d26afa-f2a4-48cc-ab70-59d13b4edc2d\"\r\n    },\r\n    \"type\": {\r\n      \"name\": \"create-dce-key\"\r\n    },\r\n    \"startTime\": \"2024-01-29T11:03:12.943155827Z\",\r\n    \"closeTime\": \"2024-01-29T11:03:17.358251094Z\",\r\n    \"status\": \"Completed\",\r\n    \"historyLength\": \"23\",\r\n    \"memo\": {\r\n\r\n    },\r\n    \"searchAttributes\": {\r\n      \"indexedFields\": {\r\n        \"BuildIds\": \"[\\\"unversioned\\\"]\"\r\n      }\r\n    },\r\n    \"autoResetPoints\": {\r\n\r\n    },\r\n    \"stateTransitionCount\": \"14\"\r\n  }\r\n}\r\ntemporal-admintools-9bccdbb6f-wt4jj:/etc/temporal$ tctl --ns prd workflow show -w c7cab2ef-1fd9-4e6a-9b9f-3b778d588be6\r\n   1  WorkflowExecutionStarted                  {WorkflowType:{Name:create-dce-key}, ParentInitiatedEventId:0, TaskQueue:{Name:prd.keycustodian.command, Kind:Normal},\r\n                                                Input:[TlBZAGOCagZoZWFkZXIwJG1hbmV0dS5wcm90b2J1Zi5SZXF1ZXN0SGVhZGVyLXJlY29yZGOEagVtYWdpYyoArM7eagd2ZXJzaW9uAGoEdHhpZGCkMWQ1MTE\r\n                                                zYmUtNGU1ZC00YjQ1LTkwMmYtNTlkMGM3NzhkMWVkaglwcmV2LXR4aWQiagN2aWQwHm1hbmV0dS5wcm90b2J1Zi5WYXVsdElkLXJlY29yZGODagxwcm92aWR\r\n                                                lci14aWRgiXBpZWRwaXBlcmoLdmF1bHQtbGFiZWxgpGNhMWY1YzViLTI5MDctM2I3NS1iMDhkLTFiNGNkY2RiY2RkOGoIa2V5c3BhY2Ui],\r\n                                                WorkflowExecutionTimeout:0s, WorkflowRunTimeout:0s, WorkflowTaskTimeout:10s, Initiator:Unspecified,\r\n                                                OriginalExecutionRunId:a8d26afa-f2a4-48cc-ab70-59d13b4edc2d, Identity:1@mcp-keycustodian-service-gw-6566847c95-dz625,\r\n                                                FirstExecutionRunId:a8d26afa-f2a4-48cc-ab70-59d13b4edc2d, Attempt:1, FirstWorkflowTaskBackoff:0s, ParentInitiatedEventVersion:0}\r\n   2  WorkflowTaskScheduled                     {TaskQueue:{Name:prd.keycustodian.command,\r\n                                                Kind:Normal}, StartToCloseTimeout:10s,\r\n                                                Attempt:1}\r\n   3  WorkflowTaskStarted                       {ScheduledEventId:2,\r\n                                                Identity:1@mcp-keycustodian-service-cp-5bc9567c9f-zj92h,\r\n                                                RequestId:f5823e38-1d67-4522-b70e-3de33bd7c6e5,\r\n                                                SuggestContinueAsNew:false, HistorySizeBytes:620}\r\n   4  WorkflowTaskCompleted                     {ScheduledEventId:2, StartedEventId:3,\r\n                                                Identity:1@mcp-keycustodian-service-cp-5bc9567c9f-zj92h,\r\n                                                SdkMetadata:{CoreUsedFlags:[], LangUsedFlags:[1]},\r\n                                                MeteringMetadata:{NonfirstLocalActivityExecutionAttempts:0}}\r\n   5  MarkerRecorded                            {MarkerName:LocalActivity,\r\n                                                Details:map{activityId:[\"3c7ac2f4-98ef-3d90-b7b2-4aa7ce073b8e\"],\r\n                                                meta:[{\"firstSkd\":1706526193081,\"atpt\":1,\"backoff\":null}],\r\n                                                result:[TlBZAGoCb2s], time:[1706526193317],\r\n                                                type:[\"start-mutex-activity\"]}, WorkflowTaskCompletedEventId:4}\r\n   6  WorkflowExecutionSignaled                 {SignalName:prd.temporal.mutex/acquired,\r\n                                                Input:[TlBZAGOBag5hY3F1aXNpdGlvbi1pZGCkZjY2OGRiNzQtMDNkZS0zOTUyLTg0OTYtMDg4Yzg1NGNhNmUw],\r\n                                                Identity:history-service}\r\n   7  WorkflowTaskScheduled                     {TaskQueue:{Name:1@mcp-keycustodian-service-cp-5bc9567c9f-zj92h:502dcdd9-3d81-4828-ad63-8e99601c01dd,\r\n                                                Kind:Sticky}, StartToCloseTimeout:10s, Attempt:1}\r\n   8  WorkflowTaskStarted                       {ScheduledEventId:7,\r\n                                                Identity:1@mcp-keycustodian-service-cp-5bc9567c9f-zj92h,\r\n                                                RequestId:95864549-cdb7-4e72-ba25-f7649073b975,\r\n                                                SuggestContinueAsNew:false, HistorySizeBytes:1526}\r\n   9  WorkflowTaskCompleted                     {ScheduledEventId:7, StartedEventId:8,\r\n                                                Identity:1@mcp-keycustodian-service-cp-5bc9567c9f-zj92h,\r\n                                                MeteringMetadata:{NonfirstLocalActivityExecutionAttempts:0}}\r\n  10  MarkerRecorded                            {MarkerName:LocalActivity,\r\n                                                Details:map{activityId:[\"ce4d139a-1f8a-30b6-98ea-5e6f56d71ec3\"],\r\n                                                meta:[{\"firstSkd\":1706526195131,\"atpt\":1,\"backoff\":null}],\r\n                                                result:[TlBZAAk], time:[1706526194555], type:[\"dce-key-exists?\"]},\r\n                                                WorkflowTaskCompletedEventId:9}\r\n  11  MarkerRecorded                            {MarkerName:SideEffect,\r\n                                                Details:map{data:[TlBZAA8AlQTMpL6T6/fJmNVZ/BnxixMoTzdmpUQ9aimrnq1gRdj+9+JFHNpysRgln4Ck4fGANOZdbq8pB6AeqNguk6AIVm2IedpFUSt9+YHubC\r\n                                                iCF5FZDBvkuUNdtUojVz11KMXF8Ij286Yehysd9l9kj1y4lzGXydWrFxqiACIdIGb0uAKznkE92XBFUZp/aIVAhPOlL428ZSje]}, WorkflowTaskCompletedEventId:9}\r\n  12  ActivityTaskScheduled                     {ActivityId:76b7d770-0ed8-3fa7-8fc7-2623d6ffe472, ActivityType:{Name:create-dce-record!},\r\n                                                TaskQueue:{Name:prd.keycustodian.command, Kind:Normal},\r\n                                                Input:[TlBZAGOIagR0eGlkYKQxZDUxMTNiZS00ZTVkLTRiNDUtOTAyZi01OWQwYzc3OGQxZWRqA3VpZGCvcGllZHBpcGVyOjpjYTFmNWM1Yi0yOTA3LTNiNzUtYjA\r\n                                                4ZC0xYjRjZGNkYmNkZDhqBXJlYWxtYIlwaWVkcGlwZXJqBmtzcGFjZSJqBWxhYmVsYKRjYTFmNWM1Yi0yOTA3LTNiNzUtYjA4ZC0xYjRjZGNkYmNkZDhqA2t\r\n                                                leQ8AlQTMpL6T6/fJmNVZ/BnxixMoTzdmpUQ9aimrnq1gRdj+9+JFHNpysRgln4Ck4fGANOZdbq8pB6AeqNguk6AIVm2IedpFUSt9+YHubCiCF5FZDBvkuUN\r\n                                                dtUojVz11KMXF8Ij286Yehysd9l9kj1y4lzGXydWrFxqiACIdIGb0uAKznkE92XBFUZp/aIVAhPOlL428ZSjeagVzaGFyZCoAAAARag1sYXN0X3JvdGF0aW9\r\n                                                uWgAAAAAAAAAA], ScheduleToCloseTimeout:0s, ScheduleToStartTimeout:30s, StartToCloseTimeout:10s, HeartbeatTimeout:0s,\r\n                                                WorkflowTaskCompletedEventId:9, RetryPolicy:{InitialInterval:1s, BackoffCoefficient:2, MaximumInterval:1m40s, MaximumAttempts:3,\r\n                                                NonRetryableErrorTypes:[]}}\r\n  13  ActivityTaskStarted                       {ScheduledEventId:12,\r\n                                                Identity:1@mcp-keycustodian-service-cp-5bc9567c9f-zj92h,\r\n                                                RequestId:a4546f5a-1502-401c-9953-0877cb466349,\r\n                                                Attempt:1}\r\n  14  ActivityTaskCompleted                     {Result:[TlBZAGoHY3JlYXRlZA],\r\n                                                ScheduledEventId:12, StartedEventId:13,\r\n                                                Identity:1@mcp-keycustodian-service-cp-5bc9567c9f-zj92h}\r\n  15  WorkflowTaskScheduled                     {TaskQueue:{Name:1@mcp-keycustodian-service-cp-5bc9567c9f-zj92h:502dcdd9-3d81-4828-ad63-8e99601c01dd,\r\n                                                Kind:Sticky}, StartToCloseTimeout:10s, Attempt:1}\r\n  16  WorkflowTaskStarted                       {ScheduledEventId:15,\r\n                                                Identity:1@mcp-keycustodian-service-cp-5bc9567c9f-zj92h,\r\n                                                RequestId:244027ee-1e7a-46e0-80e7-532beb216d1c,\r\n                                                SuggestContinueAsNew:false, HistorySizeBytes:3293}\r\n  17  WorkflowTaskCompleted                     {ScheduledEventId:15, StartedEventId:16,\r\n                                                Identity:1@mcp-keycustodian-service-cp-5bc9567c9f-zj92h,\r\n                                                MeteringMetadata:{NonfirstLocalActivityExecutionAttempts:0}}\r\n  18  SignalExternalWorkflowExecutionInitiated  {WorkflowTaskCompletedEventId:17, NamespaceId:556fb5b4-1af3-442d-ad66-66617cca5380,\r\n                                                WorkflowExecution:{WorkflowId:mutex-id-piedpiper::ca1f5c5b-2907-3b75-b08d-1b4cdcdbcdd8},\r\n                                                SignalName:mutex-release-c7cab2ef-1fd9-4e6a-9b9f-3b778d588be6,\r\n                                                Input:[TlBZAGOCaghpbnN0YW5jZWOBag5hY3F1aXNpdGlvbi1pZGCkZjY2OGRiNzQtMDNkZS0zOTUyLTg0OTYtMDg4Yzg1NGNhNmUwagR0eXBlagdyZWxlYXNl],\r\n                                                ChildWorkflowOnly:false}\r\n  19  ExternalWorkflowExecutionSignaled         {InitiatedEventId:18, Namespace:prd,\r\n                                                NamespaceId:556fb5b4-1af3-442d-ad66-66617cca5380,\r\n                                                WorkflowExecution:{WorkflowId:mutex-id-piedpiper::ca1f5c5b-2907-3b75-b08d-1b4cdcdbcdd8}}\r\n  20  WorkflowTaskScheduled                     {TaskQueue:{Name:1@mcp-keycustodian-service-cp-5bc9567c9f-zj92h:502dcdd9-3d81-4828-ad63-8e99601c01dd,\r\n                                                Kind:Sticky}, StartToCloseTimeout:10s, Attempt:1}\r\n  21  WorkflowTaskStarted                       {ScheduledEventId:20,\r\n                                                Identity:1@mcp-keycustodian-service-cp-5bc9567c9f-zj92h,\r\n                                                RequestId:cc8b085e-7c6f-462b-9984-cfa6bb811ad8,\r\n                                                SuggestContinueAsNew:false, HistorySizeBytes:4086}\r\n  22  WorkflowTaskCompleted                     {ScheduledEventId:20, StartedEventId:21,\r\n                                                Identity:1@mcp-keycustodian-service-cp-5bc9567c9f-zj92h,\r\n                                                MeteringMetadata:{NonfirstLocalActivityExecutionAttempts:0}}\r\n  23  WorkflowExecutionCompleted                {Result:[TlBZAHFqAm9rEw],\r\n                                                WorkflowTaskCompletedEventId:22}\r\n```\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1.  run workflow list multiple times ... occasionally seeing a set of apparently completed workflows\r\n ```\r\ntctl --ns prd workflow list --pdt --query=\"ExecutionStatus=1\"\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: 1.22.4 \r\n  - Platform: kubernetes without elasticsearch extended visibility\r\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM7PB74S","author":{"login":"tlalfano"},"authorAssociation":"MEMBER","body":"Let's close this since tctl is deprecated. cc @bergundy for confirmation to close","createdAt":"2025-10-31T14:40:03Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5364#issuecomment-3473391122","viewerDidAuthor":false}],"createdAt":"2024-01-29T15:32:32Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":5364,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"OPEN","title":"Inconsistent tctl workflow list behaviour","updatedAt":"2025-10-31T14:40:16Z","url":"https://github.com/temporalio/temporal/issues/5364"}
