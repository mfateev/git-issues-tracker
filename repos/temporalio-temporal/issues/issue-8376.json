{"assignees":[],"author":{"id":"MDQ6VXNlcjUxNzY4Mw==","is_bot":false,"login":"Sushisource","name":"Spencer Judge"},"body":"## Expected Behavior\nHeartbeats should not be lost.\n\n## Actual Behavior\nIn the title\n\n## Steps to Reproduce the Problem\n\n I have a Core test (currently skipped) [here](https://github.com/temporalio/sdk-core/pull/1019/files#diff-cff51badc4842dafe76c91e12b161b8d1b2106ed50c171f2f3673013c8f7c50cR801) that reproduces this. It has the following output (`dHdv`) is \"two\", and you can see I am, in fact, completing the RPC because I get the response back, but the describe workflow call never reflects that final detail.\n\nRun the test with a local server started and use `cargo integ-test -s external activity_heartbeat_not_fl -- --nocapture`\n\n```\nrunning 1 test\n2025-09-24T22:21:30.594500Z  INFO temporal_sdk_core::worker: Initializing worker task_queue=activity_heartbeat_not_flushed_on_success_FjbSia namespace=default\n[core/src/worker/activities/activity_heartbeat_manager.rs:145:33] \"reporting\" = \"reporting\"\n[core/src/worker/activities/activity_heartbeat_manager.rs:145:33] &details = [\n    [b25l],\n]\n[core/src/worker/activities/activity_heartbeat_manager.rs:340:17] &hb.details = [\n    [dHdv],\n]\n[core/src/worker/activities/activity_heartbeat_manager.rs:406:9] \"Evicting\" = \"Evicting\"\n[core/src/worker/activities/activity_heartbeat_manager.rs:406:9] should_flush = true\n[core/src/worker/activities/activity_heartbeat_manager.rs:414:17] \"Will report\" = \"Will report\"\n[core/src/worker/activities/activity_heartbeat_manager.rs:145:33] \"reporting\" = \"reporting\"\n[core/src/worker/activities/activity_heartbeat_manager.rs:145:33] &details = [\n    [dHdv],\n]\n[core/src/worker/activities/activity_heartbeat_manager.rs:146:39] sg.record_activity_heartbeat(tt.clone(), details.into_payloads()).await = Ok(\n    RecordActivityTaskHeartbeatResponse {\n        cancel_requested: false,\n        activity_paused: false,\n        activity_reset: false,\n    },\n)\n[core/src/worker/activities/activity_heartbeat_manager.rs:146:39] sg.record_activity_heartbeat(tt.clone(), details.into_payloads()).await = Ok(\n    RecordActivityTaskHeartbeatResponse {\n        cancel_requested: false,\n        activity_paused: false,\n        activity_reset: false,\n    },\n) ðŸ’¥ <-- this is the rpc that sends \"two\" completing ðŸ’¥ \n```\n\n## Specifications\n\n  - Version: 1.28.0 (also seen on 1.29)\n  - Platform:\n","closedAt":"2025-10-03T00:00:29Z","comments":[{"id":"IC_kwDODNqesM7IfVtv","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"This is a bug in the test. I tried to reproduce this with gRPC calls and couldn't.\n\nYour test has only two activity retries so it would be flaky on slow CI.\n\nThese lines don't check if the activity is still pending in mutable state and cause the heartbeat details to be `None`.\n\nhttps://github.com/temporalio/sdk-core/pull/1019/files#diff-cff51badc4842dafe76c91e12b161b8d1b2106ed50c171f2f3673013c8f7c50cR862-R863\n\nSDKs should use the `last_heartbeat_details` in the `RespondActivityTaskFailedResponse` to deliver the last response: https://github.com/temporalio/api/blob/467d73d95e81860376d70f63382359c9b3b6fbf1/temporal/api/workflowservice/v1/request_response.proto#L604\n\n","createdAt":"2025-10-03T00:00:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8376#issuecomment-3363658607","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7Is3rb","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"\n> These lines don't check if the activity is still pending in mutable state and cause the heartbeat details to be `None`.\n> \n> https://github.com/temporalio/sdk-core/pull/1019/files#diff-cff51badc4842dafe76c91e12b161b8d1b2106ed50c171f2f3673013c8f7c50cR862-R863\n\nI don't really follow what that means. I'm looking in the pending list, and what I see is the \"one\" heartbeat - not nothing. \n\n\n> SDKs should use the `last_heartbeat_details` in the `RespondActivityTaskFailedResponse` to deliver the last response: https://github.com/temporalio/api/blob/467d73d95e81860376d70f63382359c9b3b6fbf1/temporal/api/workflowservice/v1/request_response.proto#L604\n\nSo I know we have this, but we still use the old method because that RPC didn't exist previously, and I would still expect this to work without that call. Can you confirm that you weren't using this RPC when trying to repro this?","createdAt":"2025-10-03T21:01:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8376#issuecomment-3367205595","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7Iyhiu","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"> I don't really follow what that means. I'm looking in the pending list, and what I see is the \"one\" heartbeat - not nothing.\n\nHow do you know it's one heartbeat from this code? Doesn't `and_then` just short circuit if there are zero pending activities?","createdAt":"2025-10-05T02:21:27Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8376#issuecomment-3368687790","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7Iyhrx","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"> So I know we have this, but we still use the old method because that RPC didn't exist previously, and I would still expect this to work without that call. Can you confirm that you weren't using this RPC when trying to repro this?\n\nYup, confirming.\nAnd we should probably just add a capability for this.","createdAt":"2025-10-05T02:22:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8376#issuecomment-3368688369","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7JDmHx","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"> > I don't really follow what that means. I'm looking in the pending list, and what I see is the \"one\" heartbeat - not nothing.\n> \n> How do you know it's one heartbeat from this code? Doesn't `and_then` just short circuit if there are zero pending activities?\n\nYeah it will, but (and sorry this isn't in the original issue), when I ran this what I was seeing wasn't that it was missing, it's that it was present with the value `one` not `two`","createdAt":"2025-10-06T18:07:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8376#issuecomment-3373162993","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7JI7ZQ","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Hmm... can you reproduce this with issuing just API requests so we can eliminate there's nothing in Core?","createdAt":"2025-10-06T22:55:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8376#issuecomment-3374560848","viewerDidAuthor":false}],"createdAt":"2025-09-24T22:22:31Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":8376,"reactionGroups":[],"state":"CLOSED","title":"Activity heartbeats can be lost when sent very close to activity failure","updatedAt":"2025-10-06T22:55:03Z","url":"https://github.com/temporalio/temporal/issues/8376"}
