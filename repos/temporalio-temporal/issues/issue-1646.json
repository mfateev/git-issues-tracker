{"assignees":[],"author":{"id":"MDQ6VXNlcjM3MjE0MQ==","is_bot":false,"login":"skrul","name":"Steve Krulewitz"},"body":"Note that I'm experiencing this on a cluster that is having some trouble so not clear if it is worth investigating, or perhaps I'm hitting some corner case that is exposing this issue. So take this report with a grain of salt.\r\n\r\nI am currently trying to recover a cluster that has a very large backlog of timer tasks (due to many completed workflows getting culled) and I noticed that the `trx_rseg_history_len` database metric keeps increasing as temporal churns through the backlog:\r\n\r\n![image](https://user-images.githubusercontent.com/372141/122314004-330be580-cecc-11eb-8a7a-a0c2068511c8.png)\r\n\r\nThis is a sign that there is a transaction (even possibly a read transaction) that is running for too long. It has something to do with the server having to keep track of all the changed rows in case there is an eventual rollback. This link explains it better than I can:\r\n\r\nhttps://orangematter.solarwinds.com/2015/07/20/what-is-innodb-history-list-length/\r\n\r\nThe problem is that at some point this will end and the db will have to clean it up and this can cause some heavy CPU usage, etc.\r\n\r\nTo be fair this is only happening on my cluster that is sort of misbehaving -- I don't see this in a properly working cluster.\r\n\r\n## Specifications\r\n\r\n  - Version: 1.8.2\r\n  - Platform: MySQL\r\n","closedAt":"2021-08-29T22:37:55Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg2MzQ5MzE2Nw==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"below image shows SQL persistence layer's usage of transactions:\r\n![image](https://user-images.githubusercontent.com/8762893/122457618-b0cf0000-cf63-11eb-89b8-edf7fb7f26b8.png)\r\n\r\naccording to my memory, any transaction should be done within within few ms \r\nmeaning there is no acquire lock on DB, do something that can take minutes, then release lock operation.\r\n\r\ncould you plz provide a little bit more evidence / metrics / error logs (if any)?","createdAt":"2021-06-17T19:06:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1646#issuecomment-863493167","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg3MzY2Nzk0NQ==","author":{"login":"samarabbas"},"authorAssociation":"MEMBER","body":"@skrul my understanding is cluster had a big backlog built up when this was happening.  None of the transactions performed by Temporal runs over long period of time and they are always committed within the scope of single API request.  Let us know if this is still actionable.","createdAt":"2021-07-04T21:42:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1646#issuecomment-873667945","viewerDidAuthor":false},{"id":"IC_kwDODNqesM42HUaY","author":{"login":"samarabbas"},"authorAssociation":"MEMBER","body":"Closing due to no activity.","createdAt":"2021-08-29T22:37:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1646#issuecomment-907888280","viewerDidAuthor":false}],"createdAt":"2021-06-17T01:08:12Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"},{"id":"MDU6TGFiZWwyMDE5OTA0OTIw","name":"discussion","description":"","color":"3ffcb0"},{"id":"MDU6TGFiZWwyNzcwMzY2NzYw","name":"close-after-30-days","description":"","color":"1d76db"}],"milestone":null,"number":1646,"reactionGroups":[],"state":"CLOSED","title":"innodb trx_rseg_history_len gets too big","updatedAt":"2021-08-29T22:37:55Z","url":"https://github.com/temporalio/temporal/issues/1646"}
