{"assignees":[{"id":"MDQ6VXNlcjU5NDI5NjM=","login":"MichaelSnowden","name":"Michael Snowden","databaseId":0}],"author":{"id":"MDQ6VXNlcjQ1NjU5MTc=","is_bot":false,"login":"cludden","name":"Chris Ludden"},"body":"## Expected Behavior\nS3 Archival works with global namespaces + multi cluster deployment in different regions, based on this excerpt from the docs:\n>Archival is supported in [Global Namespaces](https://docs.temporal.io/namespaces#global-namespace)Link preview icon (Namespaces that span multiple clusters). When Archival is running in a Global Namespace, it first runs on the active cluster; later it runs on the standby cluster. Before archiving, a history check is done to see what has been previously archived.\n\n## Actual Behavior\nGlobal namespace created with S3 archival enabled in region A (both active cluster and archive bucket), and after failing namespace over to cluster in region B (with archive bucket in region B), archive functionality in region B fails with errors similar to the following. Note that the log is from cluster B, but contains the archival URI that points to the bucket in region A (the default for cluster A)..\n\n\n```json\n{\n\t\"id\": \"<redacted>\",\n\t\"content\": {\n\t\t\"timestamp\": \"2023-02-26T01:06:25.798Z\",\n\t\t\"tags\": [\n\t\t\t\"region:<region-b>\"\n\t\t],\n\t\t\"service\": \"temporal\",\n\t\t\"attributes\": {\n\t\t\t\"msg\": \"failed to archive target\",\n\t\t\t\"shard-id\": 24,\n\t\t\t\"level\": \"error\",\n\t\t\t\"logger\": \"temporal\",\n\t\t\t\"source\": \"stdout\",\n\t\t\t\"error\": \"BadRequest: Bad Request\\n\\tstatus code: 400, request id: <redacted>, host id: <redacted>\",\n\t\t\t\"archival-caller-service-name\": \"history\",\n\t\t\t\"archival-URI\": \"s3://<region-a-bucket>\",\n\t\t\t\"target\": \"history\",\n\t\t\t\"caller\": \"log/with_logger.go:72\",\n\t\t\t\"stacktrace\": \"go.temporal.io/server/common/log.(*withLogger).Error\\n\\t/go/pkg/mod/go.temporal.io/server@v1.20.0/common/log/with_logger.go:72\\ngo.temporal.io/server/common/log.(*withLogger).Error\\n\\t/go/pkg/mod/go.temporal.io/server@v1.20.0/common/log/with_logger.go:72\\ngo.temporal.io/server/service/history/archival.(*archiver).recordArchiveTargetResult\\n\\t/go/pkg/mod/go.temporal.io/server@v1.20.0/service/history/archival/archiver.go:244\\ngo.temporal.io/server/service/history/archival.(*archiver).archiveHistory\\n\\t/go/pkg/mod/go.temporal.io/server@v1.20.0/service/history/archival/archiver.go:191\\ngo.temporal.io/server/service/history/archival.(*archiver).Archive.func2\\n\\t/go/pkg/mod/go.temporal.io/server@v1.20.0/service/history/archival/archiver.go:162\",\n\t\t\t\"archival-request-namespace-id\": \"<redacted>\",\n\t\t\t\"service\": \"temporal\",\n\t\t\t\"archival-request-workflow-id\": \"<redacted>\",\n\t\t\t\"archival-request-run-id\": \"<redacted>\",\n\t\t\t\"archival-request-namespace\": \"<redacted>\",\n\t\t\t\"archival-request-close-failover-version\": 2,\n\t\t\t\"timestamp\": 1677373585798,\n\t\t\t\"ts\": 1677373585.797902\n\t\t}\n\t}\n}\n```\n\n## Steps to Reproduce the Problem\n1. Deploy multi cluster with separate S3 buckets in respective regions\n1. Create global namespace with archive enabled pointing to bucket in region A\n1. Failover global namespace to cluster in region B\n\n## Specifications\n* Version: 1.20.0\n* Platform: linux amd64\n\n## Comments\nI believe this is due to the various S3 calls using the same underlying AWS session that's configured at launch with the cluster's default archival region (i.e. cluster A uses an s3 client that points to region A, cluster B uses an S3 client that points to region B, but after failover, cluster B attempts to interact with S3 objects in the other region.\n\n","closedAt":"2025-11-03T15:59:56Z","comments":[{"id":"IC_kwDODNqesM5WRThQ","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"You can only config your namespace with one S3 bucket as archival URI. The same archival URI will be replicated by namespace to all clusters where the namespace is configured to replicate to. ","createdAt":"2023-02-28T00:57:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3991#issuecomment-1447376976","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5WRUZx","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"The archival will make sure it only upload once. We assume S3 is highly available. ","createdAt":"2023-02-28T00:59:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3991#issuecomment-1447380593","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5WRZZu","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"You have to config your clusters to use same S3 bucket. \r\nBasically the same config for both cluster A and B.\r\n\tS3Archiver struct {\r\n\t\tRegion           string  `yaml:\"region\"`\r\n\t\tEndpoint         *string `yaml:\"endpoint\"`\r\n\t\tS3ForcePathStyle bool    `yaml:\"s3ForcePathStyle\"`\r\n\t}\r\n","createdAt":"2023-02-28T01:10:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3991#issuecomment-1447401070","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5WRbs3","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"you may want to take a look at S3 multi region access points:\r\nhttps://aws.amazon.com/s3/features/multi-region-access-points/","createdAt":"2023-02-28T01:15:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3991#issuecomment-1447410487","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5WVOtt","author":{"login":"cludden"},"authorAssociation":"MEMBER","body":"Thanks for confirming this is expected behavior. Re: S3 MRAP, are you able to confirm that the current S3 Archiver implementation is compatible with the [limitations](https://docs.aws.amazon.com/AmazonS3/latest/userguide/MultiRegionAccessPointRestrictions.html) of MRAP, specifically the [subset of S3 operations supported](https://docs.aws.amazon.com/AmazonS3/latest/userguide/MrapOperations.html)? When I did a cursory investigation of this approach, it looked like the current S3 Archiver implementation uses operations like `HeadBucket` which are not listed in the supported operations for MRAPs..","createdAt":"2023-02-28T15:41:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3991#issuecomment-1448405869","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5WraIQ","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"@MichaelSnowden if you could help verify if archival would work with MRAP.","createdAt":"2023-03-03T22:37:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3991#issuecomment-1454219792","viewerDidAuthor":false}],"createdAt":"2023-02-27T16:52:41Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":3991,"reactionGroups":[],"state":"CLOSED","title":"S3 archive errors with global namespaces in multiple regions","updatedAt":"2025-11-03T15:59:56Z","url":"https://github.com/temporalio/temporal/issues/3991"}
