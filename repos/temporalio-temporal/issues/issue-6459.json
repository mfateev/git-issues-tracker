{"assignees":[],"author":{"id":"MDQ6VXNlcjEyNjQ1NzMz","is_bot":false,"login":"DonForbes","name":"Donald Forbes"},"body":"## Expected Behavior\r\nUnder load the number of connections to the Postgres database backend remains fairly consistent over time.\r\n\r\n## Actual Behavior\r\nWhen under load it has been observed that there are many new connections being made to the Postgres database being used as the DB backing for the history service.  (200+ new connections per second during load test). The expectation is that the number of connections may rise to handle the load but it should achieve a steady state and relatively few connections killed and re-established.\r\n\r\nOne suggestion is that the method get may be being called frequently and for some reason the refcount is not incremented so remains at 0 and many new connections returned.  To look into the problem further to see if this theory is valid.\r\n\r\nhttps://github.com/temporalio/temporal/blob/b383ffffcbbeacdfce2fe021c30f093bab64b5d9/common/persistence/sql/factory.go#L195\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Install self-hosted platform using Postgres as the DB\r\n  2. Setup montoring for the number of connections/new connections being made to DB\r\n  3. Run load test\r\n\r\n## Specifications\r\n\r\n  - Version: 1.24\r\n  - Platform: Kubernetes via Helm charts\r\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM6lXvYq","author":{"login":"raymondregrello"},"authorAssociation":"NONE","body":"Out of curiosity, in the helm chart `values.yaml` under `server.config.persistence.default.sql`, have you set `maxIdleConns`, `maxConns` and `maxConnLifetime` to sufficiently high values?\n\nI believe the defaults for `maxIdleConns` are pretty low; we initially saw a lot of connection thrashing when load testing until we set it to a higher value.","createdAt":"2025-04-03T04:29:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6459#issuecomment-2774464042","viewerDidAuthor":false}],"createdAt":"2024-08-28T13:30:08Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":6459,"reactionGroups":[],"state":"OPEN","title":"Excessive new connections to Postgres ","updatedAt":"2025-04-03T04:29:39Z","url":"https://github.com/temporalio/temporal/issues/6459"}
