{"assignees":[{"id":"MDQ6VXNlcjU1MTU2Nzg=","login":"shawnhathaway","name":"Shawn Hathaway","databaseId":0}],"author":{"id":"MDQ6VXNlcjU1MTU2Nzg=","is_bot":false,"login":"shawnhathaway","name":"Shawn Hathaway"},"body":"[NumHistoryShards](https://github.com/temporalio/temporal/blob/master/common/service/config/config.go#L137) can currently be changed which should not be allowed. \r\n\r\n**1. How should the user configure this initially?**\r\n\r\nCurrent assumption is this will stay in config. \r\n\r\n**2. What is the proposed behavior?**\r\n\r\nThere exists three cases assuming the config value is required to be set:\r\n\r\n1. Config set, not persisted (Initialization) - Proposed Behavior: Persist and continue normally\r\n1. Config set, same as persisted - Proposed Behavior: Continue normally\r\n1. Config set, differs from persisted value - Proposed Behavior: Fatal error with clear description of differing values \r\n\r\n**3. Where will this be persisted?**\r\n\r\nA new table named CLUSTER_METADATA with columns: \r\n\r\n1. Version - int - PK - Monotonically increasing\r\n1. HistoryShardCount - int \r\n\r\nThe table would only contain HistoryShardCount as a value column for now, but in the future could be extended with additional config values as columns. \r\n\r\nAn alternative schema could be to use an attribute store with a generic schema such as:\r\n\r\n1. Attribute - text\r\n1. Value - text or byte\r\n1. ItemVersion - int\r\n\r\nwhere the PK would be compound key of all columns or a UUID.\r\n\r\nThoughts?\r\n","closedAt":"2020-01-22T18:32:58Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDU3MjMxOTIxNQ==","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"I think Fatal is too drastic. I would change it to an Error but continue as we don't want to cause cluster outages because of this.\r\n\r\n","createdAt":"2020-01-09T00:11:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/61#issuecomment-572319215","viewerDidAuthor":true},{"id":"MDEyOklzc3VlQ29tbWVudDU3MjMxOTUxMg==","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"I would go with CLUSTER_METADATA table. The next feature (of protecting DB from multiple clusters using it) would add another column (CLUSTER_ID?) in it.","createdAt":"2020-01-09T00:12:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/61#issuecomment-572319512","viewerDidAuthor":true},{"id":"MDEyOklzc3VlQ29tbWVudDU3MjgyNzMxNg==","author":{"login":"shawnhathaway"},"authorAssociation":"CONTRIBUTOR","body":"After discussion today we are moving forward with:\r\n\r\n- Creating a new table 'cluster_metadata' with data stored as serialized protobuf. No versioning, only one row should exist.\r\n- ClusterName will be plumbed through from Config as well with same check as NumHistoryShards\r\n- Mismatch behavior: Error with clear description of differing values and continue with persisted value\r\n- Create new Manager/Store interface/impl for ClusterMetadata\r\n  - Initial functions will be `UpdateClusterMetadata` and `GetClusterMetadata`\r\n- Check performed once per process in Service.go","createdAt":"2020-01-10T01:06:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/61#issuecomment-572827316","viewerDidAuthor":false}],"createdAt":"2020-01-08T23:47:11Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":61,"reactionGroups":[],"state":"CLOSED","title":"NumHistoryShards should be persisted and enforced after being initially configured","updatedAt":"2020-01-22T18:32:58Z","url":"https://github.com/temporalio/temporal/issues/61"}
