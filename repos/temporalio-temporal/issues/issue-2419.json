{"assignees":[{"id":"MDQ6VXNlcjIyMzI1MjQ=","login":"alexshtin","name":"Alex Shtin","databaseId":0}],"author":{"id":"MDQ6VXNlcjcyNjUzNg==","is_bot":false,"login":"clun","name":"Cedrick Lunven"},"body":"## Expected Behavior\r\nAs the first database to use for the persistence with temporal was Cassandra i was wondering if we could use Astra as well to avoid installing any DB locally.\r\n\r\n## Actual Behavior\r\nI download the zip file containing the different certificates and unzipping them in `./dynamicconfig. I got a username and password. Looking at the different samples I set up the server with a `docker-compose` in the following way:\r\n\r\n```yaml\r\ntemporal:\r\n    container_name: temporal\r\n    environment:\r\n      - DYNAMIC_CONFIG_FILE_PATH=/etc/temporal/config/dynamicconfig/development.yaml\r\n      - DB=cassandra\r\n      - SKIP_SCHEMA_SETUP=false\r\n      - CASSANDRA_SEEDS=<myhost>-eu-west-1.db.astra.datastax.com\r\n      - CASSANDRA_PORT=29042\r\n      - CASSANDRA_USER=<my_user>\r\n      - CASSANDRA_PASSWORD=<my_password>\r\n      - CASSANDRA_TLS_ENABLED=true\r\n      - CASSANDRA_CERT=/etc/temporal/config/dynamicconfig/cert\r\n      - CASSANDRA_CERT_KEY=/etc/temporal/config/dynamicconfig/key\r\n      - CASSANDRA_CA=/etc/temporal/config/dynamicconfig/ca.crt\r\n      - CASSANDRA_REPLICATION_FACTOR=3\r\n    image: temporalio/auto-setup:1.14.2\r\n    networks:\r\n      - temporal-network\r\n    ports:\r\n      - 7233:7233\r\n    volumes:\r\n      - ./dynamicconfig:/etc/temporal/config/dynamicconfig\r\n```\r\n\r\nUser and password are validated, port is correct but the validation does not pass:\r\n\r\n```\r\n+ temporal-cassandra-tool --ep <db>-db.astra.datastax.com validate-health\r\n2022-01-25T22:19:27.930Z INFO Validating connection to cassandra cluster. {\"logging-call-at\": \"cqlclient.go:112\"}\r\n2022/01/25 22:23:59 error: failed to connect to 63.35.186.217:29042 due to error: x509: cannot validate certificate for 63.35.186.217 because it doesn't contain any IP SANs\r\n```\r\n\r\nI do not see any extra file or hints I could provide to help this tool. Could you provide a sample file or spotting if I made something wrong ?\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Create a DB in Astra and create both temporal and temporal_visibility keyspaces\r\n  1. Download the securebundle unzip in folder dynamic config\r\n  1. use the docker-compose file above\r\n\r\n\r\n## Specifications\r\n\r\n  - Version: `1.14.2`\r\n  - Platform: Docker-compose (MAC)\r\n","closedAt":"2022-07-27T14:09:40Z","comments":[{"id":"IC_kwDODNqesM489Grs","author":{"login":"clun"},"authorAssociation":"NONE","body":"It seems the `temporal-cassandra-tool` try to validate the `IP against the cert` \r\nwhereas it should validate `the dns record against the cert`.\r\n\r\nFollowing Keys may help but are not recognized out of the box.\r\n```\r\n- CASSANDRA_TLS_DISABLE_HOST_VERIFICATION=true\r\n- CASSANDRA_TLS_SERVER_NAME=<host>.db.astra.datastax.com\r\n```\r\n\r\nFinally is it possible to disable schema creation ?\r\n","createdAt":"2022-01-26T22:12:33Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2419#issuecomment-1022651116","viewerDidAuthor":false},{"id":"IC_kwDODNqesM49TdqU","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"Absolutely possible with env `SKIP_SCHEMA_SETUP`: https://github.com/temporalio/temporal/blob/master/docker/auto-setup.sh#L299","createdAt":"2022-02-03T01:16:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2419#issuecomment-1028512404","viewerDidAuthor":false},{"id":"IC_kwDODNqesM4-qPyz","author":{"login":"vaclavbroz"},"authorAssociation":"CONTRIBUTOR","body":"Having the same issue and same root cause analysis. SKIP_SCHEMA_SETUP is maybe a workaround but still the defect should be fixed in the temporal-cassandra-tool and elsewhere if necessary.","createdAt":"2022-02-25T20:58:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2419#issuecomment-1051262131","viewerDidAuthor":false},{"id":"IC_kwDODNqesM4-qcHa","author":{"login":"vaclavbroz"},"authorAssociation":"CONTRIBUTOR","body":"It's definitely a bug.\r\n\r\nHere is a full workaround:\r\n\r\nIt is possible to use a TLS proxy, e.g. https://github.com/ghostunnel/ghostunnel that will listen to plain socket and proxy a TLS secured server. Ghostunnel is by the way also written in Go, so aka friendship. Ghosttunnel can be started in a simple container, etc...\r\n\r\nFull procedure on my dev setup (Windows WSL2):\r\n\r\n- Manually install Go 1.17\r\n- Download Ghostunnel\r\n- Make ghostnunel\r\n- Launch ghost tunnel with following:\r\n\r\n`ghostunnel client --listen 172.17.0.1:10350 --target temporaldb.cassandra.cosmos.azure.com:10350 --disable-authentication --unsafe-listen`\r\n\r\n- In your configuration use 172.17.0.1 for CASSANDRA_SEEDS\r\n\r\nYour docker host IP and your PaaS Cassandra URL may differ...","createdAt":"2022-02-25T22:12:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/2419#issuecomment-1051312602","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5HUw7d","author":{"login":"robholland"},"authorAssociation":"MEMBER","body":"Those environment variables `CASSANDRA_TLS_DISABLE_HOST_VERIFICATION` and `CASSANDRA_TLS_SERVER_NAME` should work fine when set on the auto-setup container as the `temporal-cassandra-tool` would see them in the environment. Please can you confirm that these are not having the desired effect?","createdAt":"2022-07-27T11:49:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2419#issuecomment-1196625629","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5HUxK8","author":{"login":"robholland"},"authorAssociation":"MEMBER","body":"Put another way I'm not sure what you mean by \"not supported out of the box\".","createdAt":"2022-07-27T11:50:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2419#issuecomment-1196626620","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5HVees","author":{"login":"robholland"},"authorAssociation":"MEMBER","body":"I have confirmed that this works to connect to Astra using our auto-setup docker container:\r\n\r\n```\r\n      - DB=cassandra\r\n      - SKIP_DB_CREATE=true\r\n      - CASSANDRA_SEEDS=xxxx.db.astra.datastax.com\r\n      - CASSANDRA_TLS_SERVER_NAME=xxxx.db.astra.datastax.com\r\n      - CASSANDRA_DISABLE_INITIAL_HOST_LOOKUP=true\r\n      - CASSANDRA_PORT=29042\r\n      - CASSANDRA_USER=xxxx\r\n      - CASSANDRA_PASSWORD=xxxx\r\n      - CASSANDRA_TLS_ENABLED=true\r\n      - CASSANDRA_CERT_KEY=/etc/temporal/config/dynamicconfig/key\r\n      - CASSANDRA_CERT=/etc/temporal/config/dynamicconfig/cert\r\n      - CASSANDRA_CA=/etc/temporal/config/dynamicconfig/ca.crt\r\n      - DYNAMIC_CONFIG_FILE_PATH=config/dynamicconfig/development-cass.yaml\r\n```\r\n\r\nThe initial lookup must be skipped and the server name must be set (to the same value as seeds). This is due to the way Astra's certificates are generated without IP SANS versus Cassandra's host lookup process which stores only IP addresses. More details here: https://github.com/gocql/gocql/issues/1611.\r\n\r\nI'm going to close this as there is a working solution and temporal-cassandra-tool and the auto-setup image are behaving as expected. Please re-open if I have missed something that we can fix or improve.","createdAt":"2022-07-27T14:09:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2419#issuecomment-1196812204","viewerDidAuthor":false}],"createdAt":"2022-01-25T22:26:23Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":2419,"reactionGroups":[],"state":"CLOSED","title":"Use Temporal with a Cassandra Astra Backend","updatedAt":"2022-07-27T14:09:40Z","url":"https://github.com/temporalio/temporal/issues/2419"}
