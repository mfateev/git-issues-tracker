{"assignees":[],"author":{"id":"U_kgDOCKHjkw","is_bot":false,"login":"js-michaels","name":"Joseph Michaels"},"body":"## Expected Behavior\r\nViewing the Archival tab for a namespace which has archived workflows should display them.\r\n\r\n## Actual Behavior\r\nThe Archival tab is displaying the message \"No Workflows running in this Namespace\" even though there are archived workflows present in the configured archival S3 bucket. The GET call to `api/v1/namespaces/<namespace>/archived-workflows?query=` is failing with an HTTP 400.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Create an S3 bucket for Archival.\r\n  2. Ensure that Temporal's K8s service account has the below IAM permissions, changing the bucket name here to match.\r\n```\r\n{\r\n    \"Statement\": [\r\n        {\r\n            \"Effect\": \"Allow\",\r\n            \"Action\": [\r\n                \"s3:ListBucket\",\r\n                \"s3:GetBucketLocation\",\r\n                \"s3:PutObject\",\r\n                \"s3:PutObjectAcl\",\r\n                \"s3:GetObject\",\r\n                \"s3:GetObjectAcl\",\r\n                \"s3:DeleteObject\"\r\n            ],\r\n            \"Resource\": [\r\n                \"arn:aws:s3:::temporal-workflow-archive-bucket\",\r\n                \"arn:aws:s3:::temporal-workflow-archive-bucket/*\"\r\n            ]\r\n        }\r\n    ]\r\n}\r\n```\r\n  4. Add the below configuration to the Temporal Helm chart, changing the bucket name here to match.\r\n```\r\nconfig:\r\n    archival:\r\n      history:\r\n        state: enabled\r\n        enableRead: true\r\n        provider:\r\n          s3store:\r\n            region: <aws region>\r\n      visibility:\r\n        state: enabled\r\n        enableRead: true\r\n        provider: \r\n          s3store:\r\n            region: <aws region>\r\n\r\n    namespaceDefaults:\r\n      archival:\r\n        history:\r\n          state: enabled\r\n          URI: s3://temporal-workflow-archive-bucket\r\n        visibility:\r\n          state: enabled\r\n          URI: s3://temporal-workflow-archive-bucket\r\n```\r\n  5. Turn on archival and visibility for a namespace that has workflows running, and wait for the retention period.\r\n  6. View the archival bucket and observe that there are files present for those archived workflows.\r\n  7. Go to the Archival tab for that namespace and observe the message \"No Workflows running in this Namespace\" and the failed call to `api/v1/namespaces/<namespace>/archived-workflows?query=`.\r\n\r\n## Specifications\r\n\r\n  - Version: 1.22.5\r\n  - Platform: AWS, EKS, amd64\r\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM546Ep9","author":{"login":"js-michaels"},"authorAssociation":"NONE","body":"Some more information about this issue:\r\n\r\nThe call to `api/v1/namespaces/banking/archived-workflows?query=` which returns an HTTP 400 is giving the following error:\r\n```json\r\n{\r\n  \"code\": 3,\r\n  \"message\": \"Cluster is not configured for reading archived visibility records.\"\r\n}\r\n```\r\n\r\nThis error message is defined here:\r\n```golang\r\nerrClusterIsNotConfiguredForReadingArchivalVisibility = serviceerror.NewInvalidArgument(\"Cluster is not configured for reading archived visibility records.\")\r\n```\r\nhttps://github.com/temporalio/temporal/blob/main/service/frontend/errors.go#L62\r\n\r\nAnd seems to be only used here:\r\n```golang\r\nif !wh.archivalMetadata.GetVisibilityConfig().ReadEnabled() {\r\n    return nil, errClusterIsNotConfiguredForReadingArchivalVisibility\r\n}\r\n```\r\nhttps://github.com/temporalio/temporal/blob/main/service/frontend/workflow_handler.go#L2131\r\n\r\nIt looks like ultimately the value of `wh.archivalMetadata.GetVisibilityConfig().ReadEnabled()` comes from the configuration loaded from the config yaml, since `cfg.Archival.Visibility.EnableRead` maps to the yaml key path `archival.visibility.enableRead`:\r\n```golang\r\nfunc ArchivalMetadataProvider(dc *dynamicconfig.Collection, cfg *config.Config) archiver.ArchivalMetadata {\r\n\treturn archiver.NewArchivalMetadata(\r\n\t\tdc,\r\n\t\tcfg.Archival.History.State,\r\n\t\tcfg.Archival.History.EnableRead,\r\n\t\tcfg.Archival.Visibility.State,\r\n\t\tcfg.Archival.Visibility.EnableRead,\r\n\t\t&cfg.NamespaceDefaults.Archival,\r\n\t)\r\n}\r\n```\r\nhttps://github.com/temporalio/temporal/blob/main/common/resource/fx.go#L350\r\n\r\nHowever, I can see from the temporal-frontend Pod's logs that it's loading config/docker.yaml:\r\n```\r\n2024/03/29 15:52:04 Loading config; env=docker,zone=,configDir=config\r\n2024/03/29 15:52:04 Loading config files=[config/docker.yaml]\r\n```\r\n\r\nAnd if I shell into the container, I can see the config file does have the correct configuration:\r\n```\r\ntemporal-frontend-f56454dff-7dr26:/etc/temporal$ cat config/docker.yaml\r\n<...>\r\narchival:\r\n  history:\r\n    state: \"enabled\"\r\n    enableRead: true\r\n    provider:\r\n      s3store:\r\n        logLevel: 0\r\n        region: #######\r\n  visibility:\r\n    state: \"enabled\"\r\n    enabledRead: true\r\n    provider:\r\n      s3store:\r\n        logLevel: 0\r\n        region: #######\r\n\r\nnamespaceDefaults:\r\n  archival:\r\n    history:\r\n      URI: #######\r\n      state: enabled\r\n    visibility:\r\n      URI: #######\r\n      state: enabled\r\n<...>\r\n```\r\n\r\nSo why is temporal-frontend acting like this is not configured?","createdAt":"2024-03-30T22:59:06Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/5624#issuecomment-2028489341","viewerDidAuthor":false},{"id":"IC_kwDODNqesM58dgNh","author":{"login":"gad26032"},"authorAssociation":"NONE","body":"Same issue. But i use local file system as a backend.\r\n```\r\n  archival:\r\n    history:\r\n      state: \"enabled\"\r\n      enableRead: true\r\n      provider:\r\n        filestore:\r\n          fileMode: \"0666\"\r\n          dirMode: \"0766\"\r\n    visibility:\r\n      state: \"enabled\"\r\n      enableRead: true\r\n      provider:\r\n        filestore:\r\n          fileMode: \"0666\"\r\n          dirMode: \"0766\"\r\n\r\n  namespaceDefaults:\r\n    archival:\r\n      history:\r\n        state: \"enabled\"\r\n        URI: \"file:///home/temporal/temporal_archival/data\"\r\n      visibility:\r\n        state: \"enabled\"\r\n        URI: \"file:///home/temporal/temporal_vis_archival/data\"\r\n```\r\ndescribe namespace\r\n```\r\ntemporal-admintools-94844b8c5-v5957:/etc/temporal$ temporal operator namespace describe dev\r\n  NamespaceInfo.Name                    dev                                               \r\n  NamespaceInfo.Id                      c975b631-f109-41f7-865a-04b341fbe922              \r\n  NamespaceInfo.Description                                                               \r\n  NamespaceInfo.OwnerEmail                                                                \r\n  NamespaceInfo.State                   Registered                                        \r\n  NamespaceInfo.Data                    map[]                                             \r\n  Config.WorkflowExecutionRetentionTtl  24h0m0s                                           \r\n  ReplicationConfig.ActiveClusterName   active                                            \r\n  ReplicationConfig.Clusters            [&ClusterReplicationConfig{ClusterName:active,}]  \r\n  Config.HistoryArchivalState           Enabled                                           \r\n  Config.VisibilityArchivalState        Enabled                                           \r\n  IsGlobalNamespace                     false                                             \r\n  FailoverVersion                                                                      0  \r\n  FailoverHistory                       []                                                \r\n\r\n```\r\n\r\non temporal-history pod\r\n\r\n```\r\ntemporal-history-6c4ffd4497-gdjzn:~$ tree \r\n.\r\n├── temporal_archival\r\n│   └── data\r\n│       ├── 9432711404182916402104093526875229053638092447613532531101_0.history\r\n│       ├── 94327114041829164021084163317621728861618148438391857267770_0.history\r\n│       ├── 94327114041829164021091822365132548957316345918779004043580_0.history\r\n...\r\n│       ├── 943271140418291640294944933450628752312303702040985760010_0.history\r\n│       ├── 943271140418291640295710937541081983910480885637690598829_0.history\r\n│       └── 9432711404182916402970473396858808043215067898247463723775_0.history\r\n└── temporal_vis_archival\r\n    └── data\r\n        └── c975b631-f109-41f7-865a-04b341fbe922\r\n            ├── 1714523543567043851_3107041130708393426.visibility\r\n            ├── 1714523665551876245_8603905498755678542.visibility\r\n            ├── 1714523666297386886_281047780464377597.visibility\r\n...\r\n            ├── 1714526336198869418_5221394463637855399.visibility\r\n            ├── 1714527023940092587_4563104817072754649.visibility\r\n            ├── 1714527023998615275_17488082703656383857.visibility\r\n            └── 1714527261355949256_15312822523284306755.visibility\r\n\r\n5 directories, 64 files\r\n```\r\nBut when i try to get history, i get this\r\n\r\n```\r\ntemporal-admintools-94844b8c5-v5957:/etc/temporal$ temporal workflow list --archived dev\r\nError: unable to list archived workflow executions: Namespace is not configured for visibility archival.\r\n('export TEMPORAL_CLI_SHOW_STACKS=1' to see stack traces)\r\n```\r\n\r\nWeb UI just doesn't show anything on the Archived page\r\n\r\n\r\n## UPD 2024-04-02:\r\n\r\nI've decide to redeploy temporal from scratch. \r\nAfter that logs don't show any errors but history is still not sows on Archive page.\r\nRequest from admin-tools container now works without errors but shows nothing\r\n```\r\ntemporal-admintools-94844b8c5-pptl4:/etc/temporal$ temporal workflow list --archived dev\r\ntemporal-admintools-94844b8c5-pptl4:/etc/temporal$ \r\n```\r\nHistory container do have files with history\r\n```\r\ntemporal-history-6c4ffd4497-7jxfk:~$ tree\r\n.\r\n├── temporal_archival\r\n│   └── data\r\n│       ├── 3153029508883409284100556632954027255031624317270243527795_0.history\r\n│       ├── 315302950888340928410077844079520042907189990798703046629_0.history\r\n│       ├── 31530295088834092841014179372472256450213867944691256176036_0.history\r\n...      ...\r\n│       ├── 315302950888340928494255717878218597641732674283183740556_0.history\r\n│       ├── 31530295088834092849742622859503433869401773985681693035_0.history\r\n│       └── 3153029508883409284992368164740503790016816529257862930874_0.history\r\n└── temporal_vis_archival\r\n    └── data\r\n        └── 71c27c7d-edca-4ed2-b986-1bbcd9aa94c5\r\n            ├── 1714567282922524643_8163139250068973546.visibility\r\n            ├── 1714568230253421245_10586275668407886897.visibility\r\n            ├── 1714568884468711750_1733191977649475147.visibility\r\n             ...\r\n            ├── 1714613295491251227_14703381710616799526.visibility\r\n            ├── 1714613318262705922_1624317270243527795.visibility\r\n            └── 1714613512563957127_16827496660219090821.visibility\r\n\r\n5 directories, 74 files\r\ntemporal-history-6c4ffd4497-7jxfk:~$ \r\n```\r\n\r\nAlso i've noticed that `temporal-system` namespace has weird workflows that seems stuck\r\n![Selection_144](https://github.com/temporalio/temporal/assets/11608884/18e69694-6065-4918-8283-d1ba3a1a3a85)\r\n\r\nIs it proper behavior or I have some miss-configuration.\r\n\r\nAny clues?\r\n","createdAt":"2024-05-01T07:49:56Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5624#issuecomment-2088108897","viewerDidAuthor":false}],"createdAt":"2024-03-28T18:20:25Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":5624,"reactionGroups":[],"state":"OPEN","title":"Archival does not show list of archived workflows","updatedAt":"2024-05-02T07:55:45Z","url":"https://github.com/temporalio/temporal/issues/5624"}
