{"assignees":[{"id":"MDQ6VXNlcjU5NDI5NjM=","login":"MichaelSnowden","name":"Michael Snowden","databaseId":0}],"author":{"id":"MDQ6VXNlcjI1MjE3MDE=","is_bot":false,"login":"nordiste","name":"marc druelle"},"body":"## Expected Behavior\r\nno error\r\n\r\n## Actual Behavior\r\n\r\nafter a migration process from 1.19.1 to 1.20.0, we got a lot of error : \r\n\"failed to archive target\" -> \"invalid search attribute type : Unspecified\"\r\n\"failed to archive workflow\" -> \"invalid search attribute type : Unspecified\"\r\n\"failed to process task\" -> \"invalid search attribute type : Unspecified\"\r\n\r\nfailed to archive target return this stack : \r\n```\r\n[go.temporal.io/server/common/log.(*zapLogger).Error](http://go.temporal.io/server/common/log.(*zapLogger).Error)\r\n    /home/builder/temporal/common/log/zap_logger.go:150\r\n[go.temporal.io/server/service/history/archival.(*archiver).recordArchiveTargetResult](http://go.temporal.io/server/service/history/archival.(*archiver).recordArchiveTargetResult)\r\n    /home/builder/temporal/service/history/archival/archiver.go:244\r\n[go.temporal.io/server/service/history/archival.(*archiver).archiveVisibility](http://go.temporal.io/server/service/history/archival.(*archiver).archiveVisibility)\r\n    /home/builder/temporal/service/history/archival/archiver.go:218\r\n[go.temporal.io/server/service/history/archival.(*archiver).Archive.func3](http://go.temporal.io/server/service/history/archival.(*archiver).Archive.func3)\r\n    /home/builder/temporal/service/history/archival/archiver.go:167\r\n```\r\n\r\nfailed to process task return this stack :\r\n```\r\ngo.temporal.io/server/common/log.(*zapLogger).Error](http://go.temporal.io/server/common/log.(*zapLogger).Error)\r\n    /home/builder/temporal/common/log/zap_logger.go:150\r\n[go.temporal.io/server/common/log.(*lazyLogger).Error](http://go.temporal.io/server/common/log.(*lazyLogger).Error)\r\n    /home/builder/temporal/common/log/lazy_logger.go:68\r\n[go.temporal.io/server/service/history/queues.(*executableImpl).HandleErr](http://go.temporal.io/server/service/history/queues.(*executableImpl).HandleErr)\r\n    /home/builder/temporal/service/history/queues/executable.go:321\r\n[go.temporal.io/server/common/tasks.(*FIFOScheduler[...]).executeTask.func1](http://go.temporal.io/server/common/tasks.(*FIFOScheduler%5B...%5D).executeTask.func1)\r\n    /home/builder/temporal/common/tasks/fifo_scheduler.go:232\r\n[go.temporal.io/server/common/backoff.ThrottleRetry.func1](http://go.temporal.io/server/common/backoff.ThrottleRetry.func1)\r\n    /home/builder/temporal/common/backoff/retry.go:175\r\n[go.temporal.io/server/common/backoff.ThrottleRetryContext](http://go.temporal.io/server/common/backoff.ThrottleRetryContext)\r\n    /home/builder/temporal/common/backoff/retry.go:199\r\n[go.temporal.io/server/common/backoff.ThrottleRetry](http://go.temporal.io/server/common/backoff.ThrottleRetry)\r\n    /home/builder/temporal/common/backoff/retry.go:176\r\n[go.temporal.io/server/common/tasks.(*FIFOScheduler[...]).executeTask](http://go.temporal.io/server/common/tasks.(*FIFOScheduler%5B...%5D).executeTask)\r\n    /home/builder/temporal/common/tasks/fifo_scheduler.go:241\r\n[go.temporal.io/server/common/tasks.(*FIFOScheduler[...]).processTask](http://go.temporal.io/server/common/tasks.(*FIFOScheduler%5B...%5D).processTask)\r\n    /home/builder/temporal/common/tasks/fifo_scheduler.go:217\"\r\n```\r\ni'll try to migrate to 1.20.2 but same problem.\r\n\r\nworkers seems to run normally but i get errors on temporal logs.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nmigrate from v1.19.1 to 1.20.0\r\n\r\n## Specifications\r\n\r\n  - Version: 1.20.2\r\n  - Platform: kubernetes\r\n  - archivage : S3\r\n  - database : PG (migrated to V12 but problem before)\r\n  - process using schedules\r\n\r\n```\r\ntemporal-tools-84c7c5cb75-5m55t:~$ tctl adm cl gsa\r\nCustom search attributes:\r\n+------+------+\r\n| NAME | TYPE |\r\n+------+------+\r\n+------+------+\r\nSystem search attributes:\r\n+----------------------------+-------------+\r\n|            NAME            |    TYPE     |\r\n+----------------------------+-------------+\r\n| BatcherNamespace           | Keyword     |\r\n| BatcherUser                | Keyword     |\r\n| BinaryChecksums            | KeywordList |\r\n| CloseTime                  | Datetime    |\r\n| ExecutionDuration          | Int         |\r\n| ExecutionStatus            | Keyword     |\r\n| ExecutionTime              | Datetime    |\r\n| HistoryLength              | Int         |\r\n| HistorySizeBytes           | Int         |\r\n| RunId                      | Keyword     |\r\n| StartTime                  | Datetime    |\r\n| StateTransitionCount       | Int         |\r\n| TaskQueue                  | Keyword     |\r\n| TemporalChangeVersion      | KeywordList |\r\n| TemporalNamespaceDivision  | Keyword     |\r\n| TemporalSchedulePaused     | Bool        |\r\n| TemporalScheduledById      | Keyword     |\r\n| TemporalScheduledStartTime | Datetime    |\r\n| WorkflowId                 | Keyword     |\r\n| WorkflowType               | Keyword     |\r\n+----------------------------+-------------+\r\nStorage mappings:\r\n+-------------+-------------+\r\n| COLUMN NAME | COLUMN TYPE |\r\n+-------------+-------------+\r\n+-------------+-------------+\r\nWorkflow info:\r\n{\r\n\r\n}\r\n```\r\n\r\n  \r\n\r\n","closedAt":"2023-05-09T23:32:36Z","comments":[{"id":"IC_kwDODNqesM5bmn9N","author":{"login":"MichaelSnowden"},"authorAssociation":"CONTRIBUTOR","body":"What kind of workflows are you archiving? Specifically, how old are they?","createdAt":"2023-05-05T22:26:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4270#issuecomment-1536851789","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5bnYqw","author":{"login":"yux0"},"authorAssociation":"MEMBER","body":"I think there is some issue around https://github.com/temporalio/temporal/blob/a840d75296e6d2e4562d1b77527d6f33e360b2ac/common/searchattribute/encode_value.go#L59. Can the value type is 'Unspecified' and the value from payload metadata is also 'Unspecified'?","createdAt":"2023-05-06T05:08:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4270#issuecomment-1537051312","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5byvYw","author":{"login":"nordiste"},"authorAssociation":"NONE","body":"> What kind of workflows are you archiving? Specifically, how old are they?\r\n\r\nthis is schedules generated tasks. \r\ni'll try to delete schedules and recreate, but problem continue. \r\ntheses tasks are created with V1.20.0 to V1.20.2. (1 min old to more than 2 days)\r\n\r\nhere is a task describe : \r\n```\r\nemporal-tools-c67bd679f-bnfnh:~$ tctl workflow describe --w xxxxxxxxxxx-2023-05-04T15:16:00Z --raw\r\n{\r\n  \"executionConfig\": {\r\n    \"taskQueue\": {\r\n      \"name\": \"xxxxxxxxxx\",\r\n      \"kind\": \"Normal\"\r\n    },\r\n    \"defaultWorkflowTaskTimeout\": \"10s\"\r\n  },\r\n  \"workflowExecutionInfo\": {\r\n    \"execution\": {\r\n      \"workflowId\": \"xxxxxxxxx-2023-05-04T15:16:00Z\",\r\n      \"runId\": \"5efdb3f9-3e41-4280-a120-0d2cf3da6a7d\"\r\n    },\r\n    \"type\": {\r\n      \"name\": \"xxxxxxxxxxx\"\r\n    },\r\n    \"startTime\": \"2023-05-04T15:16:00.115727404Z\",\r\n    \"closeTime\": \"2023-05-04T15:16:00.595368783Z\",\r\n    \"status\": \"Completed\",\r\n    \"historyLength\": \"11\",\r\n    \"executionTime\": \"2023-05-04T15:16:00.115727404Z\",\r\n    \"memo\": {\r\n\r\n    },\r\n    \"searchAttributes\": {\r\n      \"indexedFields\": {\r\n        \"BinaryChecksums\": {\r\n          \"metadata\": {\r\n            \"encoding\": \"anNvbi9wbGFpbg==\",\r\n            \"type\": \"S2V5d29yZExpc3Q=\"\r\n          },\r\n          \"data\": \"WyIzMWJkNmVhZmZlMDI4ZjJhYTRhZTZkOTdlZDlkZTg4NyJd\"\r\n        },\r\n        \"TemporalScheduledById\": {\r\n          \"metadata\": {\r\n            \"encoding\": \"anNvbi9wbGFpbg==\",\r\n            \"type\": \"S2V5d29yZA==\"\r\n          },\r\n          \"data\": \"ImJhbk9uQ2RuIg==\"\r\n        },\r\n        \"TemporalScheduledStartTime\": {\r\n          \"metadata\": {\r\n            \"encoding\": \"anNvbi9wbGFpbg==\",\r\n            \"type\": \"RGF0ZXRpbWU=\"\r\n          },\r\n          \"data\": \"IjIwMjMtMDUtMDRUMTU6MTY6MDBaIg==\"\r\n        }\r\n      }\r\n    },\r\n    \"autoResetPoints\": {\r\n      \"points\": [\r\n        {\r\n          \"binaryChecksum\": \"31bd6eaffe028f2aa4ae6d97ed9de887\",\r\n          \"runId\": \"5efdb3f9-3e41-4280-a120-0d2cf3da6a7d\",\r\n          \"firstWorkflowTaskCompletedId\": \"4\",\r\n          \"createTime\": \"2023-05-04T15:16:00.232380603Z\",\r\n          \"resettable\": true\r\n        }\r\n      ]\r\n    },\r\n    \"taskQueue\": \"xxxxxxxxxxxxxxxxxx\",\r\n    \"stateTransitionCount\": \"7\",\r\n    \"historySizeBytes\": \"1513\"\r\n  }\r\n}\r\n```\r\n\r\nThanks for help","createdAt":"2023-05-09T12:26:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4270#issuecomment-1540027952","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5b0Nrk","author":{"login":"MichaelSnowden"},"authorAssociation":"CONTRIBUTOR","body":"I'm not able to repro this exact issue, but here's what I have so far.\r\n1. I made a branch off of v1.20.2 that minimizes the archival delay: https://github.com/temporalio/temporal/compare/v1.20.2...snowden/4270-repo?expand=1\r\n2. I started the server and ran it against my s3 localstack\r\n3. I ran some workflows with Maru, and I then tried to describe them with tctl. I do see a warning about the `KeywordList` search attribute being invalid.\r\n```console\r\n tctl --namespace benchtest workflow describe --workflow_id 4\r\nWarning: unable to stringify search attribute: invalid search attribute type: KeywordList\r\n{\r\n    ...\r\n    \"searchAttributes\": {\r\n      \"indexedFields\": {\r\n        \"BinaryChecksums\": \"[\\\"035d2a38385e9836a609b434c77c2389\\\"]\"\r\n      }\r\n    },\r\n}\r\n```\r\n\r\n@nordiste could you go into more detail about how you were using schedules to repro this issue?","createdAt":"2023-05-09T15:36:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4270#issuecomment-1540414180","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5b0wbF","author":{"login":"MichaelSnowden"},"authorAssociation":"CONTRIBUTOR","body":"I was able to reproduce this locally with schedules--not with other workflow types. I'll update here when I find out what's wrong","createdAt":"2023-05-09T17:10:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4270#issuecomment-1540556485","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5b1Bo9","author":{"login":"MichaelSnowden"},"authorAssociation":"CONTRIBUTOR","body":"@nordiste it looks like this is a bug that exists when archiving workflows created with schedules. For now, you should be able to workaround this by setting `history.durableArchivalEnabled` to false. I'm currently working on a long-term fix ","createdAt":"2023-05-09T18:02:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4270#issuecomment-1540627005","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5b1V4m","author":{"login":"MichaelSnowden"},"authorAssociation":"CONTRIBUTOR","body":"@nordiste You can try patching https://github.com/temporalio/temporal/pull/4304 locally in the meantime to see if this fixes the issue.","createdAt":"2023-05-09T18:45:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4270#issuecomment-1540709926","viewerDidAuthor":false}],"createdAt":"2023-05-03T15:08:07Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4270,"reactionGroups":[],"state":"CLOSED","title":"archival + task error after migration from 1.19.1 to 1.20.0","updatedAt":"2023-05-09T23:32:36Z","url":"https://github.com/temporalio/temporal/issues/4270"}
