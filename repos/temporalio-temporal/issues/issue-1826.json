{"assignees":[],"author":{"id":"MDQ6VXNlcjE2MzY4OTI=","is_bot":false,"login":"AWaterColorPen","name":"Hellis"},"body":"## Expected Behavior\r\n\r\n\r\n\r\n## Actual Behavior\r\n\r\nMYSQL v8.0: version mismatch for keyspace/database: \"temporal\". Expected version: 1.6 cannot be greater than Actual version: 0.0\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n```\r\n2021-08-16T12:31:20.643314381Z + DB=mysql\r\n2021-08-16T12:31:20.643342965Z + SKIP_SCHEMA_SETUP=false\r\n2021-08-16T12:31:20.6433456Z + KEYSPACE=temporal\r\n2021-08-16T12:31:20.643347484Z + VISIBILITY_KEYSPACE=temporal_visibility\r\n2021-08-16T12:31:20.643349327Z + CASSANDRA_SEEDS=\r\n2021-08-16T12:31:20.643351742Z + CASSANDRA_PORT=9042\r\n2021-08-16T12:31:20.643353765Z + CASSANDRA_USER=\r\n2021-08-16T12:31:20.643355659Z + CASSANDRA_PASSWORD=\r\n2021-08-16T12:31:20.643357502Z + CASSANDRA_TLS_ENABLED=\r\n2021-08-16T12:31:20.643424448Z + CASSANDRA_CERT=\r\n2021-08-16T12:31:20.64343106Z + CASSANDRA_CERT_KEY=\r\n2021-08-16T12:31:20.643433224Z + CASSANDRA_CA=\r\n2021-08-16T12:31:20.643456768Z + CASSANDRA_REPLICATION_FACTOR=1\r\n2021-08-16T12:31:20.643458973Z + DBNAME=temporal\r\n2021-08-16T12:31:20.64350581Z + VISIBILITY_DBNAME=temporal_visibility\r\n2021-08-16T12:31:20.643509758Z + DB_PORT=3306\r\n2021-08-16T12:31:20.643525087Z + MYSQL_TX_ISOLATION_COMPAT=false\r\n2021-08-16T12:31:20.64352709Z + POSTGRES_SEEDS=\r\n2021-08-16T12:31:20.643552758Z + POSTGRES_USER=\r\n2021-08-16T12:31:20.643555413Z + POSTGRES_PWD=\r\n2021-08-16T12:31:20.643557207Z + ENABLE_ES=true\r\n2021-08-16T12:31:20.643568528Z + ES_SCHEME=http\r\n2021-08-16T12:31:20.643615636Z + ES_PORT=9200\r\n2021-08-16T12:31:20.643648237Z + ES_VERSION=v7\r\n2021-08-16T12:31:20.643651013Z + ES_VIS_INDEX=temporal_visibility_v1_dev\r\n2021-08-16T12:31:20.64368677Z + ES_SCHEMA_SETUP_TIMEOUT_IN_SECONDS=0\r\n2021-08-16T12:31:20.643690066Z + TEMPORAL_CLI_ADDRESS=**********\r\n2021-08-16T12:31:20.64369201Z + SKIP_DEFAULT_NAMESPACE_CREATION=false\r\n2021-08-16T12:31:20.64369763Z + DEFAULT_NAMESPACE=default\r\n2021-08-16T12:31:20.643731964Z + DEFAULT_NAMESPACE_RETENTION=-30\r\n2021-08-16T12:31:20.64373502Z + SKIP_ADD_CUSTOM_SEARCH_ATTRIBUTES=false\r\n2021-08-16T12:31:20.644735445Z + '[' false '!=' true ']'\r\n2021-08-16T12:31:20.644766874Z + validate_db_env\r\n2021-08-16T12:31:20.644772775Z + '[' mysql == mysql ']'\r\n2021-08-16T12:31:20.644776382Z + '[' -z ******** ']'\r\n2021-08-16T12:31:20.644820094Z + wait_for_db\r\n2021-08-16T12:31:20.64482345Z + '[' mysql == mysql ']'\r\n2021-08-16T12:31:20.644825414Z + wait_for_mysql\r\n2021-08-16T12:31:20.645455564Z ++ echo ******** \r\n2021-08-16T12:31:20.645598652Z ++ awk -F , '{print $1}'\r\n2021-08-16T12:31:20.646624154Z + SERVER=******** \r\n2021-08-16T12:31:20.646628042Z + nc -z ********  3306\r\n2021-08-16T12:31:20.648049887Z + echo 'MySQL started.'\r\n2021-08-16T12:31:20.648054335Z MySQL started.\r\n2021-08-16T12:31:20.648074783Z + setup_schema\r\n2021-08-16T12:31:20.648121531Z Setup MySQL schema.\r\n2021-08-16T12:31:20.648123324Z + '[' mysql == mysql ']'\r\n2021-08-16T12:31:20.648130838Z + echo 'Setup MySQL schema.'\r\n2021-08-16T12:31:20.648132762Z + setup_mysql_schema\r\n2021-08-16T12:31:20.648225646Z + '[' false == true ']'\r\n2021-08-16T12:31:20.648228932Z + MYSQL_CONNECT_ATTR=()\r\n2021-08-16T12:31:20.648261804Z + SCHEMA_DIR=/etc/temporal/schema/mysql/v57/temporal/versioned\r\n2021-08-16T12:31:20.6483346Z + temporal-sql-tool --ep ********  -u root create --db temporal\r\n2021-08-16T12:31:20.667427251Z + temporal-sql-tool --ep ********  -u root --db temporal setup-schema -v 0.0\r\n2021-08-16T12:31:20.68176972Z 2021/08/16 12:31:20 Starting schema setup, config=&{SchemaFilePath: InitialVersion:0.0 Overwrite:false DisableVersioning:false}\r\n2021-08-16T12:31:20.681785069Z 2021/08/16 12:31:20 Setting up version tables\r\n2021-08-16T12:31:20.682233941Z 2021/08/16 12:31:20 Error 1050: Table 'schema_version' already exists\r\n2021-08-16T12:31:20.704367852Z 2021/08/16 12:31:20 Loading config; env=docker,zone=,configDir=config\r\n2021-08-16T12:31:20.704384273Z 2021/08/16 12:31:20 Loading config files=[config/docker.yaml]\r\n2021-08-16T12:31:20.705351896Z {\"level\":\"info\",\"ts\":\"2021-08-16T12:31:20.705Z\",\"msg\":\"Unable to create file based dynamic config client, use no-op config client instead.\",\"error\":\"dynamic config: config/dynamic_config.yaml: stat config/dynamic_config.yaml: no such file or directory\",\"logging-call-at\":\"main.go:136\"}\r\n2021-08-16T12:31:20.705368848Z {\"level\":\"info\",\"ts\":\"2021-08-16T12:31:20.705Z\",\"msg\":\"Starting server for services\",\"value\":[\"history\",\"matching\",\"frontend\",\"worker\"],\"logging-call-at\":\"server.go:117\"}\r\n2021-08-16T12:31:20.70994818Z {\"level\":\"info\",\"ts\":\"2021-08-16T12:31:20.709Z\",\"msg\":\"Get dynamic config\",\"name\":\"system.advancedVisibilityWritingMode\",\"value\":\"on\",\"default-value\":\"on\",\"logging-call-at\":\"config.go:79\"}\r\n2021-08-16T12:31:20.713025707Z Unable to start server. Error: sql schema version compatibility check failed: version mismatch for keyspace/database: \"temporal\". Expected version: 1.6 cannot be greater than Actual version: 0.0\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: temporalio/auto-setup:v0.29\r\n  - Platform: docker\r\n","closedAt":"2022-06-23T06:01:10Z","comments":[{"id":"IC_kwDODNqesM41nsh4","author":{"login":"AWaterColorPen"},"authorAssociation":"NONE","body":"For mysql time_zone > '00:00', DEFAULT '1970-01-01 00:00:01' is a invalid value.\r\n\r\n```\r\nsession_start        TIMESTAMP DEFAULT '1970-01-01 00:00:01',\r\n```\r\n\r\n```\r\nCREATE TABLE cluster_membership\r\n(\r\n    membership_partition INT NOT NULL,\r\n    host_id              BINARY(16) NOT NULL,\r\n    rpc_address          VARCHAR(128) NOT NULL,\r\n    rpc_port             SMALLINT NOT NULL,\r\n    role                 TINYINT NOT NULL,\r\n    session_start        TIMESTAMP DEFAULT '1970-01-01 00:00:01',\r\n    last_heartbeat       TIMESTAMP DEFAULT '1970-01-01 00:00:01',\r\n    record_expiry        TIMESTAMP DEFAULT '1970-01-01 00:00:01',\r\n    INDEX (role, host_id),\r\n    INDEX (role, last_heartbeat),\r\n    INDEX (rpc_address, role),\r\n    INDEX (last_heartbeat),\r\n    INDEX (record_expiry),\r\n    PRIMARY KEY (membership_partition, host_id)\r\n);\r\n```","createdAt":"2021-08-16T15:22:32Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1826#issuecomment-899598456","viewerDidAuthor":false},{"id":"IC_kwDODNqesM41oLIR","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"@AWaterColorPen \r\n\r\nv0.29 is not a supported version.\r\ncan you try v1.11.3? my local test shows v1.11.3 works with mysql 8.0\r\n\r\nwith above said, currently Temporal only officially support mysql 5.7 / postgresql 9.6 / cassandra 3.11\r\n","createdAt":"2021-08-16T18:24:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1826#issuecomment-899723793","viewerDidAuthor":false},{"id":"IC_kwDODNqesM41pB14","author":{"login":"AWaterColorPen"},"authorAssociation":"NONE","body":"@wxing1292 \r\nFor my understanding, mysql version is not the key point. \r\n\r\nThe issue happed when `temporal-sql-tool` run `update-schema`\r\n```\r\ntemporal-sql-tool --ep mysql -u root --db temporal update-schema -d /etc/temporal/schema/mysql/v57/temporal/versioned\r\n```\r\n\r\nWhen mysql time_zone > '00:00' case, `DEFAULT '1970-01-01 00:00:01'` is an invalid value.\r\n\r\n> For mysql time_zone > '00:00', DEFAULT '1970-01-01 00:00:01' is a invalid value.\r\n> \r\n> ```\r\n> session_start        TIMESTAMP DEFAULT '1970-01-01 00:00:01',\r\n> ```\r\n> \r\n> ```\r\n> CREATE TABLE cluster_membership\r\n> (\r\n>     membership_partition INT NOT NULL,\r\n>     host_id              BINARY(16) NOT NULL,\r\n>     rpc_address          VARCHAR(128) NOT NULL,\r\n>     rpc_port             SMALLINT NOT NULL,\r\n>     role                 TINYINT NOT NULL,\r\n>     session_start        TIMESTAMP DEFAULT '1970-01-01 00:00:01',\r\n>     last_heartbeat       TIMESTAMP DEFAULT '1970-01-01 00:00:01',\r\n>     record_expiry        TIMESTAMP DEFAULT '1970-01-01 00:00:01',\r\n>     INDEX (role, host_id),\r\n>     INDEX (role, last_heartbeat),\r\n>     INDEX (rpc_address, role),\r\n>     INDEX (last_heartbeat),\r\n>     INDEX (record_expiry),\r\n>     PRIMARY KEY (membership_partition, host_id)\r\n> );\r\n> ```\r\n\r\n","createdAt":"2021-08-17T02:35:16Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1826#issuecomment-899947896","viewerDidAuthor":false},{"id":"IC_kwDODNqesM41pGi9","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"can you set MySQL to be UTC?\r\nBTW the Temporal server logic default to use UTC time","createdAt":"2021-08-17T03:33:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1826#issuecomment-899967165","viewerDidAuthor":false},{"id":"IC_kwDODNqesM42DeKy","author":{"login":"AWaterColorPen"},"authorAssociation":"NONE","body":"@wxing1292 it is hard to set whole MYSQL server to be UTC.\r\n\r\nFor my understanding, Temporal server just use one database of MYSQL. so I canâ€˜t change all database to to be UTC that will effect the data with local time zone in other databases.\r\n\r\nIs it possible to change default `CREATE TABLE cluster_membership` sql schema? OR change the `session_start        TIMESTAMP DEFAULT '1970-01-01 00:00:01'` to be TIMESTAMP with timezone?","createdAt":"2021-08-27T02:35:54Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1826#issuecomment-906879666","viewerDidAuthor":false},{"id":"IC_kwDODNqesM46meiX","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"Existing schema files should work fine with MySQL 8.0.19 and later.","createdAt":"2021-12-01T00:34:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1826#issuecomment-983165079","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5FD6n0","author":{"login":"shiva0612"},"authorAssociation":"NONE","body":"I have the same issue with the following server version :\r\ntemporal_version : 1.16.2\r\nmysql_version : 8.0.29\r\nalso I had posted the detailed description of my problem in the community forum please reply on the forum if possible\r\n\r\nhere is the link : https://community.temporal.io/t/temporal-server-startup/4989?u=shiva0612","createdAt":"2022-06-17T08:54:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1826#issuecomment-1158654452","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5FSqWg","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"It seems that `+00:00` needs to be added to all default `TIMESTAMP` values to indicate UTC time zone.","createdAt":"2022-06-22T01:24:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1826#issuecomment-1162519968","viewerDidAuthor":false}],"createdAt":"2021-08-16T12:36:48Z","labels":[{"id":"MDU6TGFiZWwyMDE5OTA0OTIw","name":"discussion","description":"","color":"3ffcb0"},{"id":"MDU6TGFiZWwyNzcwMzY2NzYw","name":"close-after-30-days","description":"","color":"1d76db"}],"milestone":null,"number":1826,"reactionGroups":[],"state":"CLOSED","title":"MYSQL v8.0: Error 1067: Invalid default value for 'session_start'","updatedAt":"2022-06-23T06:01:10Z","url":"https://github.com/temporalio/temporal/issues/1826"}
