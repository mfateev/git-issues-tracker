{"assignees":[],"author":{"id":"MDQ6VXNlcjExOTQyMg==","is_bot":false,"login":"tsurdilo","name":"Tihomir Surdilovic"},"body":"Looks as currently worker service https://github.com/temporalio/temporal/tree/master/service/worker\r\ndoes not expose a gRPC handler and the health check method like matching and history services do. \r\n\r\nPlease add this if possible.","closedAt":null,"comments":[{"id":"IC_kwDODNqesM4_g_VH","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Worker does not have a gRPC service endpoint. It would be good to have sdk to implement the health check so whoever running a worker would have it.","createdAt":"2022-03-11T22:48:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2582#issuecomment-1065612615","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5i732t","author":{"login":"paymog"},"authorAssociation":"NONE","body":"While we wait for this to get implemented, does anyone have a workaround for those of us running workers in kubernetes? We recently deployed a broken docker image for our worker and didn't realize for a few days.","createdAt":"2023-08-01T08:49:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":4}}],"url":"https://github.com/temporalio/temporal/issues/2582#issuecomment-1659862445","viewerDidAuthor":false},{"id":"IC_kwDODNqesM55Cw48","author":{"login":"tredmon"},"authorAssociation":"NONE","body":"> While we wait for this to get implemented, does anyone have a workaround for those of us running workers in kubernetes? \r\n\r\nI've just started playing with temporal in kubernetes, but a simple liveness probe could look like (assuming your image has `sh` and `pidof` installed and that your worker has a binary which is unique on your pod runtime):\r\n```yaml\r\nlivenessProbe:\r\n  exec:\r\n    command:\r\n      - /bin/sh\r\n      - -c\r\n      - pidof your-worker-binary >/dev/null\r\n```\r\n\r\nFor the readiness probe I'm considering creating a file in an `emptyDir` volume when the worker is ready, and creating another file when the worker receives a termination signal. Then the readiness probe could look for the existence of said files.","createdAt":"2024-04-01T23:12:39Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2582#issuecomment-2030767676","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6B-dwf","author":{"login":"robholland"},"authorAssociation":"MEMBER","body":"If the worker process died, the container would restart, you'd see crash backoff loop. A `pidof` health check is never going to report unhealthy.","createdAt":"2024-06-20T13:05:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2582#issuecomment-2180635679","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6B-eNN","author":{"login":"robholland"},"authorAssociation":"MEMBER","body":"@paymog do you mean your application worker, or Temporal's (internal) worker, which is what this issue relates to? In what way was your worker failing that wasn't resulting in the container exiting?","createdAt":"2024-06-20T13:06:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2582#issuecomment-2180637517","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6B-lTd","author":{"login":"paymog"},"authorAssociation":"NONE","body":"I'm referencing the application worker here and specifically interested in having a health check to make staged rollouts easier in kubernetes.","createdAt":"2024-06-20T13:18:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2582#issuecomment-2180666589","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6B-oiN","author":{"login":"robholland"},"authorAssociation":"MEMBER","body":"This issue was referring to the internal system worker. We can't provide a health check for your application workers.","createdAt":"2024-06-20T13:22:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2582#issuecomment-2180679821","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6B-pnh","author":{"login":"paymog"},"authorAssociation":"NONE","body":"ah, my bad then! I think other folks which üëç [this comment](https://github.com/temporalio/temporal/issues/2582#issuecomment-1659862445) are similarly confused. Why can't you provide a health check? There's a default way to expose prometheus metrics on a provided port, why can't the SDK spin up an http server that responds with a 200 once the worker is ready to process workflows/activities?","createdAt":"2024-06-20T13:24:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2582#issuecomment-2180684257","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6B-sjw","author":{"login":"robholland"},"authorAssociation":"MEMBER","body":"Healthy is context specific. Your application worker may be running but failing to process workflow tasks because it lacks some resource that we can't know about. The worker being able to respond 200 ok to an incoming request doesn't mean it was successfully able to connect to Temporal for all the Workers within the process (there can be many Temporal SDK Worker per process). There is just no clear meaning to what healthy means.","createdAt":"2024-06-20T13:29:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2582#issuecomment-2180696304","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6B-0T8","author":{"login":"paymog"},"authorAssociation":"NONE","body":"I see. Could temporal instead provide a sample doc of how to spin up a health check server that each user could implement and customize?","createdAt":"2024-06-20T13:38:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2582#issuecomment-2180728060","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6B-2A9","author":{"login":"robholland"},"authorAssociation":"MEMBER","body":"Maybe, but it's \"just\" spinning up a HTTP listener with one endpoint, which in most languages is very easy. The rest would all be custom, so I'm not sure how much value there is there. There would be nothing Temporal specific about it.","createdAt":"2024-06-20T13:40:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2582#issuecomment-2180735037","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6B-2WW","author":{"login":"robholland"},"authorAssociation":"MEMBER","body":"Put another way, it would be no different to how you'd add healthcheck endpoints to any other part of your application.","createdAt":"2024-06-20T13:40:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2582#issuecomment-2180736406","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6B-4Rf","author":{"login":"paymog"},"authorAssociation":"NONE","body":"Is there a canonical way to hook into the worker sdk to only spin up this server after the worker has connected to temporal?\r\n\r\nNinja edit: well this is embarrassing, turns out I already implemented this in our worker by copy-pasting https://github.com/temporalio/sdk-typescript/blob/c1e7fffcd807493298d66d0063c4618eaf851206/packages/test/src/load/worker.ts#L191\r\n\r\nEDIT: I suspect lots of users would be happy if there was a flag we could set during worker initiation that would handle this for us. Agreed that healthy is context specific, something like this will likely satisfy the vast majority of users though.","createdAt":"2024-06-20T13:44:13Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2582#issuecomment-2180744287","viewerDidAuthor":false}],"createdAt":"2022-03-07T19:04:05Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwzMTM4ODI4MTE3","name":"up-for-grabs","description":"Issues to consider for external contribution","color":"69CD90"}],"milestone":null,"number":2582,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":18}}],"state":"OPEN","title":"Add health check handler for worker service","updatedAt":"2024-06-20T13:45:28Z","url":"https://github.com/temporalio/temporal/issues/2582"}
