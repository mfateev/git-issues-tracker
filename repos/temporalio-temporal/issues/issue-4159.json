{"assignees":[],"author":{"id":"MDQ6VXNlcjQ1MjM5NTU=","is_bot":false,"login":"longquanzheng","name":"Quanzheng Long"},"body":"## Expected Behavior\r\nTemporal server should not panic and exits \r\n\r\n## Actual Behavior\r\n```\r\ntemporal                      | {\"level\":\"info\",\"ts\":\"2023-04-12T19:43:54.839Z\",\"msg\":\"Failing the workflow task.\",\"shard-id\":1,\"address\":\"172.30.2.7:7234\",\"component\":\"history-engine\",\"value\":\"UnhandledCommand\",\"wf-id\":\"any_command_combination1681328632774897000\",\"wf-run-id\":\"88da57bb-b604-4107-8e5d-0499c052d85f\",\"wf-namespace-id\":\"5d797742-e8dc-4166-bca0-7a7a6b72ed1e\",\"logging-call-at\":\"workflowTaskHandlerCallbacks.go:510\"}\r\ntemporal                      | {\"level\":\"info\",\"ts\":\"2023-04-12T19:43:54.847Z\",\"msg\":\"history client encountered error\",\"service\":\"frontend\",\"error\":\"UnhandledCommand\",\"service-error-type\":\"serviceerror.InvalidArgument\",\"logging-call-at\":\"metric_client.go:90\"}\r\ntemporal                      | panic: runtime error: slice bounds out of range [-24:] [recovered]\r\ntemporal                      | \tpanic: runtime error: slice bounds out of range [-24:]\r\ntemporal                      |\r\ntemporal                      | goroutine 34529409 [running]:\r\ntemporal                      | go.opentelemetry.io/otel/sdk/trace.(*recordingSpan).End.func1()\r\ntemporal                      | \t/go/pkg/mod/go.opentelemetry.io/otel/sdk@v1.10.0/trace/span.go:393 +0x2c\r\ntemporal                      | go.opentelemetry.io/otel/sdk/trace.(*recordingSpan).End(0x4000893b00, {0x0, 0x0, 0x40044288e0?})\r\ntemporal                      | \t/go/pkg/mod/go.opentelemetry.io/otel/sdk@v1.10.0/trace/span.go:432 +0x6e4\r\ntemporal                      | panic({0x1ceab40, 0x400489cf18})\r\ntemporal                      | \t/usr/local/go/src/runtime/panic.go:884 +0x20c\r\ntemporal                      | go.temporal.io/api/common/v1.(*WorkflowExecution).MarshalToSizedBuffer(0x4004672a80, {0x4002364280, 0xc, 0x400236429d?})\r\ntemporal                      | \t/go/pkg/mod/go.temporal.io/api@v1.13.1-0.20221110200459-6a3cb21a3415/common/v1/message.pb.go:1407 +0x290\r\ntemporal                      | go.temporal.io/api/workflow/v1.(*WorkflowExecutionInfo).MarshalToSizedBuffer(0x400433aea0, {0x4002364280, 0x0?, 0x123})\r\ntemporal                      | \t/go/pkg/mod/go.temporal.io/api@v1.13.1-0.20221110200459-6a3cb21a3415/workflow/v1/message.pb.go:1725 +0xa14\r\ntemporal                      | go.temporal.io/server/api/historyservice/v1.(*DescribeWorkflowExecutionResponse).MarshalToSizedBuffer(0x4003835540, {0x4002364280, 0x123, 0x123})\r\ntemporal                      | \t/home/builder/temporal/api/historyservice/v1/request_response.pb.go:12548 +0x134\r\ntemporal                      | go.temporal.io/server/api/historyservice/v1.(*DescribeWorkflowExecutionResponse).Marshal(0x4001403158?)\r\ntemporal                      | \t/home/builder/temporal/api/historyservice/v1/request_response.pb.go:12489 +0x50\r\ntemporal                      | google.golang.org/protobuf/internal/impl.legacyMarshal({{}, {0x2426668, 0x40049e28b0}, {0x0, 0x0, 0x0}, 0x0})\r\ntemporal                      | \t/go/pkg/mod/google.golang.org/protobuf@v1.28.1/internal/impl/legacy_message.go:402 +0x84\r\ntemporal                      | google.golang.org/protobuf/proto.MarshalOptions.size({{}, 0x1?, 0xb2?, 0xde?}, {0x2426668, 0x40049e28b0})\r\ntemporal                      | \t/go/pkg/mod/google.golang.org/protobuf@v1.28.1/proto/size.go:43 +0x8c\r\ntemporal                      | google.golang.org/protobuf/proto.MarshalOptions.Size({{}, 0x80?, 0x1b?, 0xdc?}, {0x23fc3c0?, 0x40049e28b0?})\r\ntemporal                      | \t/go/pkg/mod/google.golang.org/protobuf@v1.28.1/proto/size.go:26 +0x54\r\ntemporal                      | google.golang.org/protobuf/proto.Size(...)\r\ntemporal                      | \t/go/pkg/mod/google.golang.org/protobuf@v1.28.1/proto/size.go:16\r\ntemporal                      | github.com/golang/protobuf/proto.Size({0xffff8dde1fc8?, 0x4003835540?})\r\ntemporal                      | \t/go/pkg/mod/github.com/golang/protobuf@v1.5.2/proto/wire.go:18 +0x48\r\ntemporal                      | go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc.messageType.Event({{0x1e762ec, 0xc}, {0x4, 0x0, {0x1e64581, 0x4}, {0x0, 0x0}}}, {0x2412a50?, 0x40040ce390?}, ...)\r\ntemporal                      | \t/go/pkg/mod/go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc@v0.36.1/interceptor.go:50 +0xe4\r\ntemporal                      | go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc.UnaryServerInterceptor.func1({0x2412a50, 0x40040ce210}, {0x1d94a80, 0x40019b19e0}, 0x4004fae120, 0x4002c67d40)\r\ntemporal                      | \t/go/pkg/mod/go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc@v0.36.1/interceptor.go:360 +0x920\r\ntemporal                      | google.golang.org/grpc.chainUnaryInterceptors.func1.1({0x2412a50?, 0x40040ce210?}, {0x1d94a80?, 0x40019b19e0?})\r\ntemporal                      | \t/go/pkg/mod/google.golang.org/grpc@v1.50.1/server.go:1165 +0x8c\r\ntemporal                      | go.temporal.io/server/common/rpc.ServiceErrorInterceptor({0x2412a50?, 0x40040ce210?}, {0x1d94a80?, 0x40019b19e0?}, 0xffffb5469501?, 0x18?)\r\ntemporal                      | \t/home/builder/temporal/common/rpc/grpc.go:137 +0x34\r\ntemporal                      | google.golang.org/grpc.chainUnaryInterceptors.func1.1({0x2412a50?, 0x40040ce210?}, {0x1d94a80?, 0x40019b19e0?})\r\ntemporal                      | \t/go/pkg/mod/google.golang.org/grpc@v1.50.1/server.go:1165 +0x8c\r\ntemporal                      | google.golang.org/grpc.chainUnaryInterceptors.func1({0x2412a50, 0x40040ce210}, {0x1d94a80, 0x40019b19e0}, 0x4004fae120, 0x40019b1a10)\r\ntemporal                      | \t/go/pkg/mod/google.golang.org/grpc@v1.50.1/server.go:1167 +0x128\r\ntemporal                      | go.temporal.io/server/api/historyservice/v1._HistoryService_DescribeWorkflowExecution_Handler({0x1e26fc0?, 0x400054a9a0}, {0x2412a50, 0x40040ce210}, 0x400428ac40, 0x400039b960)\r\ntemporal                      | \t/home/builder/temporal/api/historyservice/v1/service.pb.go:1462 +0x134\r\ntemporal                      | google.golang.org/grpc.(*Server).processUnaryRPC(0x40007bc960, {0x241e700, 0x400173e9c0}, 0x400037e480, 0x4000b73050, 0x361ab88, 0x0)\r\ntemporal                      | \t/go/pkg/mod/google.golang.org/grpc@v1.50.1/server.go:1340 +0xb68\r\ntemporal                      | google.golang.org/grpc.(*Server).handleStream(0x40007bc960, {0x241e700, 0x400173e9c0}, 0x400037e480, 0x0)\r\ntemporal                      | \t/go/pkg/mod/google.golang.org/grpc@v1.50.1/server.go:1713 +0x840\r\ntemporal                      | google.golang.org/grpc.(*Server).serveStreams.func1.2()\r\ntemporal                      | \t/go/pkg/mod/google.golang.org/grpc@v1.50.1/server.go:965 +0x84\r\ntemporal                      | created by google.golang.org/grpc.(*Server).serveStreams.func1\r\ntemporal                      | \t/go/pkg/mod/google.golang.org/grpc@v1.50.1/server.go:963 +0x294\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nI ran the docker container for a few days and just saw it. \r\n\r\n## Specifications\r\n\r\n  - Version: TEMPORAL_VERSION=1.19.1\r\n  - Platform: docker","closedAt":"2023-04-28T21:47:53Z","comments":[{"id":"IC_kwDODNqesM5Z9ksY","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Looks like a otel bug. We have recently upgraded otel version, could you try with 1.20","createdAt":"2023-04-14T21:43:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4159#issuecomment-1509313304","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5Z91O6","author":{"login":"longquanzheng"},"authorAssociation":"CONTRIBUTOR","body":"> Looks like a otel bug. We have recently upgraded otel version, could you try with 1.20\r\n\r\nYeah I have upgraded and haven't ran into yet. I will let you know if this happens again with newer version. ","createdAt":"2023-04-14T23:10:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4159#issuecomment-1509381050","viewerDidAuthor":false}],"createdAt":"2023-04-12T19:47:35Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4159,"reactionGroups":[],"state":"CLOSED","title":"Temporal server panic and exits ","updatedAt":"2024-09-23T10:21:48Z","url":"https://github.com/temporalio/temporal/issues/4159"}
