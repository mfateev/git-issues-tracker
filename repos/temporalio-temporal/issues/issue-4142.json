{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNTA0MDQ5","is_bot":false,"login":"Quinn-With-Two-Ns","name":"Quinn Klassen"},"body":"## Expected Behavior\r\nUpdates completed in the last WF task of a workflow are written in history\r\n\r\n## Actual Behavior\r\nUpdates completed in the last WF task of a workflow are not written in history.\r\n\r\n\r\n## Steps to Reproduce the Problem\r\nSending an update to this workflow\r\n\r\n```go\r\nfunc UpdateWorkflow(ctx workflow.Context) (string, error) {\r\n\tchannel := workflow.NewChannel(ctx)\r\n\terr := workflow.SetUpdateHandler(ctx, \"string-update\", func(value string) (string, error) {\r\n\t\tchannel.Send(ctx, value)\r\n\t\treturn value, nil\r\n\t})\r\n\tif err != nil {\r\n\t\treturn \"\", err\r\n\t}\r\n\r\n\tvar value string\r\n\tchannel.Receive(ctx, &value)\r\n\treturn value, nil\r\n}\r\n```\r\nResults in this history, that does not have an update accepted or update completed event.\r\n\r\n```\r\n[\r\n  {\r\n    \"eventId\": \"1\",\r\n    \"eventTime\": \"2023-04-03T13:05:32.160078Z\",\r\n    \"eventType\": \"WorkflowExecutionStarted\",\r\n    \"version\": \"0\",\r\n    \"taskId\": \"1049883\",\r\n    \"workerMayIgnore\": false,\r\n    \"workflowExecutionStartedEventAttributes\": {\r\n      \"workflowType\": {\r\n        \"name\": \"UpdateWorkflow\"\r\n      },\r\n      \"parentWorkflowNamespace\": \"\",\r\n      \"parentWorkflowNamespaceId\": \"\",\r\n      \"parentWorkflowExecution\": null,\r\n      \"parentInitiatedEventId\": \"0\",\r\n      \"taskQueue\": {\r\n        \"name\": \"tq-ffc81536-2576-49e8-be6e-35c3243ae6a1-TestIntegrationSuite/TestUpdateWorkflow\",\r\n        \"kind\": \"Normal\"\r\n      },\r\n      \"input\": null,\r\n      \"workflowExecutionTimeout\": \"15s\",\r\n      \"workflowRunTimeout\": \"15s\",\r\n      \"workflowTaskTimeout\": \"1s\",\r\n      \"continuedExecutionRunId\": \"\",\r\n      \"initiator\": \"Unspecified\",\r\n      \"continuedFailure\": null,\r\n      \"lastCompletionResult\": null,\r\n      \"originalExecutionRunId\": \"816dbfbb-97d8-4b12-a9c5-3a5a551fbb76\",\r\n      \"identity\": \"73816@Quinn-Klassens-MacBook-Pro.local@\",\r\n      \"firstExecutionRunId\": \"816dbfbb-97d8-4b12-a9c5-3a5a551fbb76\",\r\n      \"retryPolicy\": null,\r\n      \"attempt\": 1,\r\n      \"workflowExecutionExpirationTime\": \"2023-04-03T13:05:47.159Z\",\r\n      \"cronSchedule\": \"\",\r\n      \"firstWorkflowTaskBackoff\": \"0s\",\r\n      \"memo\": null,\r\n      \"searchAttributes\": null,\r\n      \"prevAutoResetPoints\": null,\r\n      \"header\": {\r\n        \"fields\": {}\r\n      },\r\n      \"parentInitiatedEventVersion\": \"0\"\r\n    }\r\n  },\r\n  {\r\n    \"eventId\": \"2\",\r\n    \"eventTime\": \"2023-04-03T13:05:32.160152Z\",\r\n    \"eventType\": \"WorkflowTaskScheduled\",\r\n    \"version\": \"0\",\r\n    \"taskId\": \"1049884\",\r\n    \"workerMayIgnore\": false,\r\n    \"workflowTaskScheduledEventAttributes\": {\r\n      \"taskQueue\": {\r\n        \"name\": \"tq-ffc81536-2576-49e8-be6e-35c3243ae6a1-TestIntegrationSuite/TestUpdateWorkflow\",\r\n        \"kind\": \"Normal\"\r\n      },\r\n      \"startToCloseTimeout\": \"1s\",\r\n      \"attempt\": 1\r\n    }\r\n  },\r\n  {\r\n    \"eventId\": \"3\",\r\n    \"eventTime\": \"2023-04-03T13:05:32.167600Z\",\r\n    \"eventType\": \"WorkflowTaskStarted\",\r\n    \"version\": \"0\",\r\n    \"taskId\": \"1049893\",\r\n    \"workerMayIgnore\": false,\r\n    \"workflowTaskStartedEventAttributes\": {\r\n      \"scheduledEventId\": \"2\",\r\n      \"identity\": \"73816@Quinn-Klassens-MacBook-Pro.local@\",\r\n      \"requestId\": \"759c7b00-0b79-43db-a809-942241caf43e\",\r\n      \"suggestContinueAsNew\": false,\r\n      \"historySizeBytes\": \"798\"\r\n    }\r\n  },\r\n  {\r\n    \"eventId\": \"4\",\r\n    \"eventTime\": \"2023-04-03T13:05:32.170337Z\",\r\n    \"eventType\": \"WorkflowTaskCompleted\",\r\n    \"version\": \"0\",\r\n    \"taskId\": \"1049897\",\r\n    \"workerMayIgnore\": false,\r\n    \"workflowTaskCompletedEventAttributes\": {\r\n      \"scheduledEventId\": \"2\",\r\n      \"startedEventId\": \"3\",\r\n      \"identity\": \"73816@Quinn-Klassens-MacBook-Pro.local@\",\r\n      \"binaryChecksum\": \"8fdfc468d7abcb59aa1b177d806ee337\",\r\n      \"workerVersioningId\": null,\r\n      \"sdkMetadata\": {\r\n        \"coreUsedFlags\": [],\r\n        \"langUsedFlags\": []\r\n      },\r\n      \"meteringMetadata\": {\r\n        \"nonfirstLocalActivityExecutionAttempts\": 0\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"eventId\": \"5\",\r\n    \"eventTime\": \"2023-04-03T13:05:33.165635Z\",\r\n    \"eventType\": \"WorkflowTaskScheduled\",\r\n    \"version\": \"0\",\r\n    \"taskId\": \"1049901\",\r\n    \"workerMayIgnore\": false,\r\n    \"workflowTaskScheduledEventAttributes\": {\r\n      \"taskQueue\": {\r\n        \"name\": \"Quinn-Klassens-MacBook-Pro.local:d8f5c194-fddb-40f1-b192-8f06895a6eba\",\r\n        \"kind\": \"Sticky\"\r\n      },\r\n      \"startToCloseTimeout\": \"1s\",\r\n      \"attempt\": 1\r\n    }\r\n  },\r\n  {\r\n    \"eventId\": \"6\",\r\n    \"eventTime\": \"2023-04-03T13:05:33.166436Z\",\r\n    \"eventType\": \"WorkflowTaskStarted\",\r\n    \"version\": \"0\",\r\n    \"taskId\": \"1049902\",\r\n    \"workerMayIgnore\": false,\r\n    \"workflowTaskStartedEventAttributes\": {\r\n      \"scheduledEventId\": \"5\",\r\n      \"identity\": \"73816@Quinn-Klassens-MacBook-Pro.local@\",\r\n      \"requestId\": \"b3fdbe37-6124-4014-ae47-d691d0cadbaf\",\r\n      \"suggestContinueAsNew\": false,\r\n      \"historySizeBytes\": \"1015\"\r\n    }\r\n  },\r\n  {\r\n    \"eventId\": \"7\",\r\n    \"eventTime\": \"2023-04-03T13:05:33.171298Z\",\r\n    \"eventType\": \"WorkflowTaskCompleted\",\r\n    \"version\": \"0\",\r\n    \"taskId\": \"1049903\",\r\n    \"workerMayIgnore\": false,\r\n    \"workflowTaskCompletedEventAttributes\": {\r\n      \"scheduledEventId\": \"5\",\r\n      \"startedEventId\": \"6\",\r\n      \"identity\": \"73816@Quinn-Klassens-MacBook-Pro.local@\",\r\n      \"binaryChecksum\": \"8fdfc468d7abcb59aa1b177d806ee337\",\r\n      \"workerVersioningId\": null,\r\n      \"sdkMetadata\": {\r\n        \"coreUsedFlags\": [],\r\n        \"langUsedFlags\": []\r\n      },\r\n      \"meteringMetadata\": {\r\n        \"nonfirstLocalActivityExecutionAttempts\": 0\r\n      }\r\n    }\r\n  },\r\n  {\r\n    \"eventId\": \"8\",\r\n    \"eventTime\": \"2023-04-03T13:05:33.171325Z\",\r\n    \"eventType\": \"WorkflowExecutionCompleted\",\r\n    \"version\": \"0\",\r\n    \"taskId\": \"1049904\",\r\n    \"workerMayIgnore\": false,\r\n    \"workflowExecutionCompletedEventAttributes\": {\r\n      \"result\": {\r\n        \"payloads\": [\r\n          {\r\n            \"metadata\": {\r\n              \"encoding\": \"anNvbi9wbGFpbg==\"\r\n            },\r\n            \"data\": \"InZhbHVlIg==\"\r\n          }\r\n        ]\r\n      },\r\n      \"workflowTaskCompletedEventId\": \"7\",\r\n      \"newExecutionRunId\": \"\"\r\n    }\r\n  }\r\n]\r\n```\r\n\r\n\r\n\r\n## Specifications\r\n\r\n  - Version: Go SDK 1.20\r\n  - Platform: M1 Mac\r\n","closedAt":"2024-04-23T23:21:00Z","comments":[],"createdAt":"2023-04-03T13:08:34Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4142,"reactionGroups":[],"state":"CLOSED","title":"Updates completed in the last WF task of a workflow are not written in history","updatedAt":"2024-04-23T23:21:01Z","url":"https://github.com/temporalio/temporal/issues/4142"}
