{"assignees":[],"author":{"id":"MDQ6VXNlcjc2MDI0MTUz","is_bot":false,"login":"shiyao-afterpay","name":""},"body":"Given the CASSANDRA_SEEDS, Temporal-server/cassandra-tools will contact the seed nodes and then connect to **other** nodes returned from the seeds. However, some of the returned nodes cannot be connected due to network policy issues.\r\n\r\nIn our setup, we use a managed **multi-dc** Cassandra service. Due to regulation compliance, Cassandra application *client* residing in one area  cannot establish network connections to other data centers.\r\n\r\nThe problem is Temporal-server/Cassandra-tools is constantly making connections to the discovered nodes in Cassandra, including those in *the other* dc.\r\n\r\n1. Can we tell Temporal-server/Cassandra to only connect to Cassandra nodes in a specific DC ?\r\n2. If not, can we tell Temporal-server/Cassandra to only connect to the nodes specified in CASSANDRA_SEEDS as we can populate this variable with Cassandra nodes only in the current DC ? \r\n","closedAt":"2021-02-28T13:04:40Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDc4MzM4NjgwMw==","author":{"login":"tristan-hyams"},"authorAssociation":"NONE","body":"I am just a user, but here's my two cents.\r\n\r\n1) I don't think this is possible currently and partly by design - I will suggest an alternative. The design part has to do with service discovery, recovery of nodes, and additional nodes at runtime. This allows seamless integration of new nodes and graceful failover - in a highly desirable hands off approach.\r\n\r\n2) Absolutely, you can restrict which nodes a cluster can see by removing or truncating the table and re-adding the only ones you want. The catch here is that the nodes that can still reach the Cassandra instance(s) will join back as available services for the same reasons I mention above.\r\n     \r\nIn a multi-data center setup, you more than likely should have two Temporal Clusters pointing to two unique Cassandra hosts if at all possible. I am not 100% sure that is possible given your managed service setup only you can find it out. However, based on your own restrictions `one area cannot establish network connections to other data centers`. This to me means there should be a way for your Cassandra setup to have tables/nodes that exist in isolation. If that is the case, you can work with your DevOps or DBA to have a way to point to them uniquely with two connection strings.\r\n\r\nAlternatively, use a standup of PostreSql or Mysql in lieu of your complex Cassandra setup for one of your Clusters.","createdAt":"2021-02-22T13:46:29Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1309#issuecomment-783386803","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4MzQzMzc5MQ==","author":{"login":"tristan-hyams"},"authorAssociation":"NONE","body":"Possibly related to #1234 \r\n","createdAt":"2021-02-22T14:58:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1309#issuecomment-783433791","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4Mzc4NjQzNA==","author":{"login":"shiyao-afterpay"},"authorAssociation":"NONE","body":"> 2\\. Absolutely, you can restrict which nodes a cluster can see by removing or truncating the table and re-adding the only ones you want. The catch here is that the nodes that can still reach the Cassandra instance(s) will join back as available services for the same reasons I mention above.\r\n\r\nHi, let me clarify the current configuration: \r\nWe have two DCs, DC-a, and DC-b.\r\n\r\nThe Cassandra nodes in DC-a and DC-b can connect to each other.  There is no network restriction. However, the Cassandra client (for example, Temporal) in one DC cannot make connection to Cassandra nodes in the other DC. \r\n\r\nProblem is Temporal will unconditionally make connections to the nodes return from CASSANDRA_SEEDS, which will contain nodes in **both* DC.\r\n\r\nSo the remedy I posted in the initial question is:\r\n> Can we tell Temporal-server/Cassandra to only connect to Cassandra nodes in a specific DC ?\r\n> \r\n> If not, can we tell Temporal-server/Cassandra to only connect to the nodes specified in CASSANDRA_SEEDS as we can populate this variable with Cassandra nodes only in the current DC ?","createdAt":"2021-02-23T00:49:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1309#issuecomment-783786434","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4Mzc4NzA1Mw==","author":{"login":"shiyao-afterpay"},"authorAssociation":"NONE","body":"> Possibly related to #1234\r\n\r\nThe problem is not related to #1234. In #1234, two Temporal clusters can communicate with each other. In our problem, there is only one Temporal cluster but it connects to the Cassandra nodes in multiple DCs.","createdAt":"2021-02-23T00:51:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1309#issuecomment-783787053","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4Mzc5NzE4Mw==","author":{"login":"shiyao-afterpay"},"authorAssociation":"NONE","body":"@wxing1292 I noticed that there is already a knob `Datacenter` to filter out hosts based on datacenter, see https://github.com/temporalio/temporal/blob/35a9646bf120e5b16afb7914a8e6424976f48f91/common/service/config/config.go#L267.  However, it seems it is not exposed here: https://github.com/temporalio/temporal/blob/cf2047195d424f13e38cb3880865d2be98e277a3/tools/cassandra/cqlclient.go#L147","createdAt":"2021-02-23T01:22:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1309#issuecomment-783797183","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4NDQwNzIyMQ==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"@shiyao-afterpay let me know if #1315 can fix the issue you are facing.","createdAt":"2021-02-23T18:15:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1309#issuecomment-784407221","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4NDYxOTM2Mw==","author":{"login":"shiyao-afterpay"},"authorAssociation":"NONE","body":"@wxing1292 Thanks for the quick fix.\r\n\r\nAFAIK, Temporal has two concepts of *datacenter*s, one is to create the keyspace with network aware topology (cassandra itself side), another is to filter hosts (gocql side).\r\n\r\nThe fix seems to combine the two concepts together.  Also see another related issue: https://github.com/temporalio/temporal/issues/1278\r\n\r\n\r\n**That said, the fix should solve the connectivity problem.** But I haven't tested yet.  Is there any nightly docker image release for Temporal?","createdAt":"2021-02-24T00:02:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1309#issuecomment-784619363","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4NDYyMzIyMA==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"UPDATE: the latest tag points to master branch build, not release build\r\n\r\n@shiyao-afterpay \r\n\r\n> AFAIK, Temporal has two concepts of datacenters, one is to create the keyspace with network aware topology (cassandra itself side), another is to filter hosts (gocql side).\r\n\r\nnot an cassandra configuration expert, but i assume #1315 will fix the issue, ref: https://github.com/temporalio/temporal/blob/v1.7.0/common/cassandra/cassandraCluster.go#L64\r\n\r\nabout docker, try:\r\n`temporalio/server:latest`\r\n`temporalio/auto-setup:latest`\r\n`temporalio/admin-tools:latest`\r\n`temporalio/tctl:latest`\r\nor\r\n```zsh\r\ndocker build . -t server-auto-setup:local --build-arg TARGET=auto-setup\r\ndocker build . -t server:local --build-arg TARGET=server\r\n```\r\n","createdAt":"2021-02-24T00:11:04Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1309#issuecomment-784623220","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4NDcyNzQ1MA==","author":{"login":"shiyao-afterpay"},"authorAssociation":"NONE","body":"Thanks.\n\nWill test it.\n\n>\n","createdAt":"2021-02-24T03:35:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1309#issuecomment-784727450","viewerDidAuthor":false}],"createdAt":"2021-02-22T06:51:37Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":1309,"reactionGroups":[],"state":"CLOSED","title":"Allow only connect to the CASSANDRA_SEED nodes and not others","updatedAt":"2021-02-28T13:04:40Z","url":"https://github.com/temporalio/temporal/issues/1309"}
