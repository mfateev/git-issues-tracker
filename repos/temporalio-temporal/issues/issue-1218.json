{"assignees":[{"id":"MDQ6VXNlcjUxNzY4Mw==","login":"Sushisource","name":"Spencer Judge","databaseId":0}],"author":{"id":"MDQ6VXNlcjI2NzkwMTc0","is_bot":false,"login":"ti","name":"Nanxi"},"body":"## Expected Behavior\r\n In: https://github.com/temporalio/samples-go/tree/master/cancelactivity\r\n \r\n```\r\ngo run cancelactivity/cancel/main.go\r\n```\r\n\r\nThe Activity should receive a cancel context and the Workflow should be stop.\r\n\r\n## Actual Behavior\r\n\r\nThe Workflow State change to `PENDING_ACTIVITY_STATE_CANCEL_REQUESTED`, but the worker/main.go is still running.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n1. Clone and run temporalio in docker-compose\r\n\r\n```bash\r\ngit clone https://github.com/temporalio/docker-compose.git\r\ncd docker-compose\r\ndocker-compose up\r\n```\r\n\r\n2. Clone the samples-go\r\n\r\n```bash\r\ngit clone https://github.com/temporalio/samples-go.git\r\ncd samples-go\r\n```\r\n3. Run the cancelactivity sample\r\n\r\n3.1) Run the following command to start the worker\r\n\r\n```bash\r\ngo run cancelactivity/worker/main.go\r\n```\r\n3.2) Run the following command to start the workflow\r\n```bash\r\ngo run cancelactivity/starter/main.go\r\n```\r\n3.3) Run the following command to cancel the workflow\r\n```bash\r\ngo run cancelactivity/cancel/main.go\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: 1.6.0\r\n  - SDK: 1.4.0\r\n  - Platform: https://github.com/temporalio/docker-compose/blob/main/docker-compose.yml","closedAt":"2021-01-25T17:15:43Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDc2NjYxNTYyMA==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"after fixing the heartbeat issue there is one more\r\n@Sushisource \r\n```\r\nsamples-go|master ⇒ tctl --ns default workflow show -w workflowID-to-cancel -pdt -pev\r\n   1  2021-01-25T07:39:27Z  (Version: 0)  WorkflowExecutionStarted          {WorkflowType:{Name:Workflow}, ParentInitiatedEventId:0,                                                                              \r\n                                                                            TaskQueue:{Name:cancel-activity, Kind:Normal},                                                                                        \r\n                                                                            Input:[], WorkflowExecutionTimeout:0s,                                                                                                \r\n                                                                            WorkflowRunTimeout:0s, WorkflowTaskTimeout:10s,                                                                                       \r\n                                                                            Initiator:Unspecified, LastCompletionResult:[],                                                                                       \r\n                                                                            OriginalExecutionRunId:a3dc9593-483a-4c2e-b01f-301b5ccb0849,                                                                          \r\n                                                                            Identity:55140@wenquandeMBP@,                                                                                                         \r\n                                                                            FirstExecutionRunId:a3dc9593-483a-4c2e-b01f-301b5ccb0849,                                                                             \r\n                                                                            Attempt:1, FirstWorkflowTaskBackoff:0s,                                                                                               \r\n                                                                            Header:{Fields:map{}}}                                                                                                                \r\n   2  2021-01-25T07:39:27Z  (Version: 0)  WorkflowTaskScheduled             {TaskQueue:{Name:cancel-activity,                                                                                                     \r\n                                                                            Kind:Normal},                                                                                                                         \r\n                                                                            StartToCloseTimeout:10s,                                                                                                              \r\n                                                                            Attempt:1}                                                                                                                            \r\n   3  2021-01-25T07:39:27Z  (Version: 0)  WorkflowTaskStarted               {ScheduledEventId:2,                                                                                                                  \r\n                                                                            Identity:55115@wenquandeMBP@,                                                                                                         \r\n                                                                            RequestId:9109380d-0623-423e-8a4b-d79c9e65c905}                                                                                       \r\n   4  2021-01-25T07:39:27Z  (Version: 0)  WorkflowTaskCompleted             {ScheduledEventId:2, StartedEventId:3,                                                                                                \r\n                                                                            Identity:55115@wenquandeMBP@,                                                                                                         \r\n                                                                            BinaryChecksum:4c180311ac35b0b7359210d938bd4238}                                                                                      \r\n   5  2021-01-25T07:39:27Z  (Version: 0)  ActivityTaskScheduled             {ActivityId:5,                                                                                                                        \r\n                                                                            ActivityType:{Name:ActivityToBeCanceled},                                                                                             \r\n                                                                            TaskQueue:{Name:cancel-activity,                                                                                                      \r\n                                                                            Kind:Normal}, Header:{Fields:map{}},                                                                                                  \r\n                                                                            Input:[], ScheduleToCloseTimeout:0s,                                                                                                  \r\n                                                                            ScheduleToStartTimeout:1m0s,                                                                                                          \r\n                                                                            StartToCloseTimeout:30m0s,                                                                                                            \r\n                                                                            HeartbeatTimeout:5s,                                                                                                                  \r\n                                                                            WorkflowTaskCompletedEventId:4,                                                                                                       \r\n                                                                            RetryPolicy:{InitialInterval:1s,                                                                                                      \r\n                                                                            BackoffCoefficient:2,                                                                                                                 \r\n                                                                            MaximumInterval:1m40s, MaximumAttempts:0,                                                                                             \r\n                                                                            NonRetryableErrorTypes:[len=0]}}                                                                                                      \r\n   6  2021-01-25T07:39:42Z  (Version: 0)  WorkflowExecutionCancelRequested  {ExternalInitiatedEventId:0,                                                                                                          \r\n                                                                            Identity:55235@wenquandeMBP@}                                                                                                         \r\n   7  2021-01-25T07:39:42Z  (Version: 0)  WorkflowTaskScheduled             {TaskQueue:{Name:wenquandeMBP:ac77fae3-b487-4734-bc0d-e933e0314f28,                                                                   \r\n                                                                            Kind:Sticky}, StartToCloseTimeout:10s, Attempt:1}                                                                                     \r\n   8  2021-01-25T07:39:42Z  (Version: 0)  WorkflowTaskStarted               {ScheduledEventId:7,                                                                                                                  \r\n                                                                            Identity:55115@wenquandeMBP@,                                                                                                         \r\n                                                                            RequestId:782cc736-b4cd-40c9-aed4-18a129eb4cc1}                                                                                       \r\n   9  2021-01-25T07:39:42Z  (Version: 0)  WorkflowTaskCompleted             {ScheduledEventId:7, StartedEventId:8,                                                                                                \r\n                                                                            Identity:55115@wenquandeMBP@,                                                                                                         \r\n                                                                            BinaryChecksum:4c180311ac35b0b7359210d938bd4238}                                                                                      \r\n  10  2021-01-25T07:39:42Z  (Version: 0)  ActivityTaskCancelRequested       {ScheduledEventId:5,                                                                                                                  \r\n                                                                            WorkflowTaskCompletedEventId:9}                                                                                                       \r\n  11  2021-01-25T07:39:27Z  (Version: 0)  ActivityTaskStarted               {ScheduledEventId:5,                                                                                                                  \r\n                                                                            Identity:55115@wenquandeMBP@,                                                                                                         \r\n                                                                            RequestId:a7bad12d-8774-4a70-8191-ed21bf5cc8c3,                                                                                       \r\n                                                                            Attempt:1}                                                                                                                            \r\n  12  2021-01-25T07:39:45Z  (Version: 0)  ActivityTaskCompleted             {Result:[I am canceled by                                                                                                             \r\n                                                                            Done], ScheduledEventId:5,                                                                                                            \r\n                                                                            StartedEventId:11,                                                                                                                    \r\n                                                                            Identity:55115@wenquandeMBP@}                                                                                                         \r\n  13  2021-01-25T07:39:45Z  (Version: 0)  WorkflowTaskScheduled             {TaskQueue:{Name:wenquandeMBP:ac77fae3-b487-4734-bc0d-e933e0314f28,                                                                   \r\n                                                                            Kind:Sticky}, StartToCloseTimeout:10s, Attempt:1}                                                                                     \r\n  14  2021-01-25T07:39:45Z  (Version: 0)  WorkflowTaskStarted               {ScheduledEventId:13,                                                                                                                 \r\n                                                                            Identity:55115@wenquandeMBP@,                                                                                                         \r\n                                                                            RequestId:990e9dea-f8f2-4b87-9c7c-b605f52de82e}                                                                                       \r\n  15  2021-01-25T07:39:45Z  (Version: 0)  WorkflowTaskCompleted             {ScheduledEventId:13, StartedEventId:14,                                                                                              \r\n                                                                            Identity:55115@wenquandeMBP@,                                                                                                         \r\n                                                                            BinaryChecksum:4c180311ac35b0b7359210d938bd4238}                                                                                      \r\n  16  2021-01-25T07:39:45Z  (Version: 0)  ActivityTaskScheduled             {ActivityId:16,                                                                                                                       \r\n                                                                            ActivityType:{Name:ActivityToBeSkipped},                                                                                              \r\n                                                                            TaskQueue:{Name:cancel-activity,                                                                                                      \r\n                                                                            Kind:Normal}, Header:{Fields:map{}},                                                                                                  \r\n                                                                            Input:[], ScheduleToCloseTimeout:0s,                                                                                                  \r\n                                                                            ScheduleToStartTimeout:1m0s,                                                                                                          \r\n                                                                            StartToCloseTimeout:30m0s,                                                                                                            \r\n                                                                            HeartbeatTimeout:5s,                                                                                                                  \r\n                                                                            WorkflowTaskCompletedEventId:15,                                                                                                      \r\n                                                                            RetryPolicy:{InitialInterval:1s,                                                                                                      \r\n                                                                            BackoffCoefficient:2,                                                                                                                 \r\n                                                                            MaximumInterval:1m40s,                                                                                                                \r\n                                                                            MaximumAttempts:0,                                                                                                                    \r\n                                                                            NonRetryableErrorTypes:[len=0]}}                                                                                                      \r\n  17  2021-01-25T07:39:45Z  (Version: 0)  ActivityTaskCancelRequested       {ScheduledEventId:16,                                                                                                                 \r\n                                                                            WorkflowTaskCompletedEventId:15}                                                                                                      \r\n  18  2021-01-25T07:39:45Z  (Version: 0)  ActivityTaskCanceled              {Details:[ACTIVITY_ID_NOT_STARTED],                                                                                                   \r\n                                                                            LatestCancelRequestedEventId:17,                                                                                                      \r\n                                                                            ScheduledEventId:16, StartedEventId:0,                                                                                                \r\n                                                                            Identity:55115@wenquandeMBP@}                                                                                                         \r\n  19  2021-01-25T07:39:45Z  (Version: 0)  WorkflowTaskScheduled             {TaskQueue:{Name:wenquandeMBP:ac77fae3-b487-4734-bc0d-e933e0314f28,                                                                   \r\n                                                                            Kind:Sticky}, StartToCloseTimeout:10s, Attempt:1}                                                                                     \r\n  20  2021-01-25T07:39:45Z  (Version: 0)  WorkflowTaskStarted               {ScheduledEventId:19, Identity:55115@wenquandeMBP@,                                                                                   \r\n                                                                            RequestId:request-from-RespondWorkflowTaskCompleted}                                                                                  \r\n  21  2021-01-25T07:39:45Z  (Version: 0)  WorkflowTaskFailed                {ScheduledEventId:19, StartedEventId:20, Cause:WorkflowWorkerUnhandledFailure, Failure:{Message:invalid state                         \r\n                                                                            transition: attempt to handleCancelInitiatedEvent, CommandType: Activity, ID: 16, state=CanceledAfterInitiated, isDone()=false,       \r\n                                                                            history=[Created cancel CanceledBeforeSent handleInitiatedEvent CanceledAfterInitiated handleCancelInitiatedEvent],                   \r\n                                                                            Source:GoSDK, StackTrace:process event for cancel-activity [panic]: go.temporal.io/sdk/internal.panicIllegalState(...)                \r\n                                                                            \t/Users/wenquan.xing/go/pkg/mod/go.temporal.io/sdk@v1.4.0/in ternal/internal_decision_state_machine.go:393                             \r\n                                                                            go.temporal.io/sdk/internal.(*commandStateMachineB ... o/pkg/mod/go.temporal.io/sdk@v1.4.0/internal/internal_worker_base.go:343       \r\n                                                                            +0xba created by go.temporal.io/sdk/internal.(*baseWorker).runTaskDispatcher                                                          \r\n                                                                            \t/Users/wenquan.xing/go/pkg/mod/go.temporal.io/sdk@v1.4.0/in ternal/internal_worker_base.go:270 +0xff,                                 \r\n                                                                            FailureInfo:&Failure_ApplicationFailureInfo{ApplicationFailureInfo:&ApplicationFailureInfo{Type:PanicError,NonRetryable:true,Details  \r\n                                                                            :nil,},}}, Identity:55115@wenquandeMBP@, ForkEventVersion:0, BinaryChecksum:4c180311ac35b0b7359210d938bd4238}                         \r\nsamples-go|master ⇒ \r\n\r\n```","createdAt":"2021-01-25T07:41:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1218#issuecomment-766615620","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc2NzAzNjg4MA==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"@ti thanks for notifying us","createdAt":"2021-01-25T18:55:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1218#issuecomment-767036880","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc2NzExNTE0Mw==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"@ti plz use latest go sample & server >= 1.6.1\r\nthanks for the bug report & sorry for the inconvenience","createdAt":"2021-01-25T21:10:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}},{"content":"ROCKET","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/1218#issuecomment-767115143","viewerDidAuthor":false}],"createdAt":"2021-01-25T04:14:48Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":1218,"reactionGroups":[],"state":"CLOSED","title":"[Basic function bug] CancelWorkflow does not work in 1.6.0","updatedAt":"2021-01-25T21:10:57Z","url":"https://github.com/temporalio/temporal/issues/1218"}
