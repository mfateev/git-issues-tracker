{"assignees":[{"id":"MDQ6VXNlcjIyMzI1MjQ=","login":"alexshtin","name":"Alex Shtin","databaseId":0}],"author":{"id":"MDQ6VXNlcjE5MjcyODY=","is_bot":false,"login":"jrpedrianes","name":"Jorge RodrÃ­guez Pedrianes"},"body":"## Expected Behavior\r\nStart clean local environment using Postgres docker-compose\r\n\r\nhttps://github.com/temporalio/docker-compose\r\n\r\n## Actual Behavior\r\n\r\nStart with the next error:\r\n\r\n```\r\ntemporal                | + DB=postgresql\r\ntemporal                | + SKIP_SCHEMA_SETUP=false\r\ntemporal                | + KEYSPACE=temporal\r\ntemporal                | + VISIBILITY_KEYSPACE=temporal_visibility\r\ntemporal                | + CASSANDRA_SEEDS=\r\ntemporal                | + CASSANDRA_PORT=9042\r\ntemporal                | + CASSANDRA_USER=\r\ntemporal                | + CASSANDRA_PASSWORD=\r\ntemporal                | + CASSANDRA_TLS_ENABLED=\r\ntemporal                | + CASSANDRA_CERT=\r\ntemporal                | + CASSANDRA_CERT_KEY=\r\ntemporal                | + CASSANDRA_CA=\r\ntemporal                | + CASSANDRA_REPLICATION_FACTOR=1\r\ntemporal                | + DBNAME=temporal\r\ntemporal                | + VISIBILITY_DBNAME=temporal_visibility\r\ntemporal                | + DB_PORT=5432\r\ntemporal                | + MYSQL_SEEDS=\r\ntemporal                | + MYSQL_USER=\r\ntemporal                | + MYSQL_PWD=\r\ntemporal                | + MYSQL_TX_ISOLATION_COMPAT=false\r\ntemporal                | + POSTGRES_SEEDS=postgresql\r\ntemporal                | + POSTGRES_USER=temporal\r\ntemporal                | + POSTGRES_PWD=temporal\r\ntemporal                | + ENABLE_ES=false\r\ntemporal                | + ES_SCHEME=http\r\ntemporal                | + ES_SEEDS=\r\ntemporal                | + ES_PORT=9200\r\ntemporal                | + ES_USER=\r\ntemporal                | + ES_PWD=\r\ntemporal                | + ES_VERSION=v6\r\ntemporal                | + ES_VIS_INDEX=temporal-visibility-dev\r\ntemporal                | + ES_SCHEMA_SETUP_TIMEOUT_IN_SECONDS=0\r\ntemporal                | + TEMPORAL_CLI_ADDRESS=172.23.0.3:7233\r\ntemporal                | + SKIP_DEFAULT_NAMESPACE_CREATION=false\r\ntemporal                | + DEFAULT_NAMESPACE=default\r\ntemporal                | + DEFAULT_NAMESPACE_RETENTION=1\r\ntemporal                | + SKIP_ADD_CUSTOM_SEARCH_ATTRIBUTES=false\r\ntemporal                | + '[' false '!=' true ']'\r\ntemporal                | + validate_db_env\r\ntemporal                | + '[' postgresql == mysql ']'\r\ntemporal                | + '[' postgresql == postgresql ']'\r\ntemporal                | + '[' -z postgresql ']'\r\ntemporal                | + wait_for_db\r\ntemporal                | + '[' postgresql == mysql ']'\r\ntemporal                | + '[' postgresql == postgresql ']'\r\ntemporal                | + wait_for_postgres\r\ntemporal                | ++ awk -F , '{print $1}'\r\ntemporal                | ++ echo postgresql\r\ntemporal                | + SERVER=postgresql\r\ntemporal                | + nc -z postgresql 5432\r\ntemporal                | Waiting for PostgreSQL to startup.\r\ntemporal                | + echo 'Waiting for PostgreSQL to startup.'\r\ntemporal                | + sleep 1\r\ntemporal                | + nc -z postgresql 5432\r\ntemporal                | + echo 'PostgreSQL started.'\r\ntemporal                | + setup_schema\r\ntemporal                | + '[' postgresql == mysql ']'\r\ntemporal                | + '[' postgresql == postgresql ']'\r\ntemporal                | + echo 'Setup PostgreSQL schema.'\r\ntemporal                | + setup_postgres_schema\r\ntemporal                | PostgreSQL started.\r\ntemporal                | Setup PostgreSQL schema.\r\ntemporal                | + SCHEMA_DIR=/etc/temporal/schema/postgresql/v96/temporal/versioned\r\ntemporal                | + temporal-sql-tool --plugin postgres --ep postgresql -u temporal -p 5432 create --db temporal\r\ntemporal-postgresql     | The files belonging to this database system will be owned by user \"postgres\".\r\ntemporal-postgresql     | This user must also own the server process.\r\ntemporal-postgresql     |\r\ntemporal                | 2021/06/09 19:04:48 error creating database:pq: database \"temporal\" already exists\r\ntemporal                | 2021/06/09 19:04:48 Loading config; env=docker,zone=,configDir=config\r\ntemporal                | 2021/06/09 19:04:48 Loading config files=[config/docker.yaml]\r\ntemporal-postgresql     | The database cluster will be initialized with locale \"en_US.utf8\".\r\ntemporal-postgresql     | The default database encoding has accordingly been set to \"UTF8\".\r\ntemporal-postgresql     | The default text search configuration will be set to \"english\".\r\ntemporal-postgresql     |\r\ntemporal-postgresql     | Data page checksums are disabled.\r\ntemporal-postgresql     |\r\ntemporal                | {\"level\":\"info\",\"ts\":\"2021-06-09T19:04:48.296Z\",\"msg\":\"Updated dynamic config\",\"logging-call-at\":\"file_based_client.go:235\"}\r\ntemporal                | {\"level\":\"info\",\"ts\":\"2021-06-09T19:04:48.296Z\",\"msg\":\"Starting server for services\",\"value\":[\"history\",\"matching\",\"frontend\",\"worker\"],\"logging-call-at\":\"server.go:117\"}\r\ntemporal-postgresql     | fixing permissions on existing directory /var/lib/postgresql/data ... ok\r\ntemporal                | {\"level\":\"info\",\"ts\":\"2021-06-09T19:04:48.300Z\",\"msg\":\"Get dynamic config\",\"name\":\"system.advancedVisibilityWritingMode\",\"value\":\"off\",\"default-value\":\"off\",\"logging-call-at\":\"config.go:79\"}\r\ntemporal-postgresql     | creating subdirectories ... ok\r\ntemporal                | Unable to start server. Error: sql schema version compatibility check failed: unable to read DB schema version keyspace/database: temporal error: pq: relation \"schema_version\" does not exist\r\ntemporal-postgresql     | selecting default max_connections ... 100\r\ntemporal-postgresql     | selecting default shared_buffers ... 128MB\r\ntemporal-postgresql     | selecting default timezone ... Etc/UTC\r\ntemporal-postgresql     | selecting dynamic shared memory implementation ... posix\r\ntemporal-postgresql     | creating configuration files ... ok\r\ntemporal-postgresql     | running bootstrap script ... ok\r\ntemporal-postgresql     | performing post-bootstrap initialization ... ok\r\ntemporal-postgresql     | syncing data to disk ... ok\r\ntemporal-postgresql     |\r\ntemporal-postgresql     | Success. You can now start the database server using:\r\ntemporal-postgresql     |\r\ntemporal-postgresql     |     pg_ctl -D /var/lib/postgresql/data -l logfile start\r\ntemporal-postgresql     |\r\ntemporal-postgresql     |\r\ntemporal-postgresql     | WARNING: enabling \"trust\" authentication for local connections\r\ntemporal-postgresql     | You can change this by editing pg_hba.conf or using the option -A, or\r\ntemporal-postgresql     | --auth-local and --auth-host, the next time you run initdb.\r\ntemporal-postgresql     | waiting for server to start....LOG:  database system was shut down at 2021-06-09 19:04:44 UTC\r\ntemporal-postgresql     | LOG:  MultiXact member wraparound protections are now enabled\r\ntemporal-postgresql     | LOG:  database system is ready to accept connections\r\ntemporal-postgresql     | LOG:  autovacuum launcher started\r\ntemporal-postgresql     |  done\r\ntemporal-postgresql     | server started\r\ntemporal-postgresql     | CREATE DATABASE\r\ntemporal-postgresql     |\r\ntemporal-postgresql     |\r\ntemporal-postgresql     | /usr/local/bin/docker-entrypoint.sh: ignoring /docker-entrypoint-initdb.d/*\r\ntemporal-postgresql     |\r\ntemporal exited with code 1\r\ntemporal-postgresql     | LOG:  received fast shutdown request\r\ntemporal-postgresql     | waiting for server to shut down...LOG:  aborting any active transactions\r\ntemporal-postgresql     | .LOG:  autovacuum launcher shutting down\r\ntemporal-postgresql     | LOG:  shutting down\r\ntemporal-postgresql     | LOG:  database system is shut down\r\ntemporal-postgresql     |  done\r\ntemporal-postgresql     | server stopped\r\ntemporal-postgresql     |\r\ntemporal-postgresql     | PostgreSQL init process complete; ready for start up.\r\ntemporal-postgresql     |\r\ntemporal-postgresql     | LOG:  database system was shut down at 2021-06-09 19:04:46 UTC\r\ntemporal-postgresql     | LOG:  MultiXact member wraparound protections are now enabled\r\ntemporal-postgresql     | LOG:  database system is ready to accept connections\r\ntemporal-postgresql     | LOG:  autovacuum launcher started\r\ntemporal-postgresql     | LOG:  incomplete startup packet\r\ntemporal-postgresql     | ERROR:  database \"temporal\" already exists\r\ntemporal-postgresql     | STATEMENT:  CREATE DATABASE temporal\r\ntemporal-postgresql     | ERROR:  relation \"schema_version\" does not exist at character 26\r\ntemporal-postgresql     | STATEMENT:  SELECT curr_version from schema_version where version_partition=0 and db_name=$1\r\ntemporal-web            | establishing insecure connection...\r\ntemporal-web            | temporal-web up and listening on port 8088\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. git clone https://github.com/temporalio/docker-compose\r\n  1. cd docker-compose\r\n  1. docker-compose -f docker-compose-postgres.yml up\r\n\r\n\r\n## Specifications\r\n\r\n  - Version: 1.10.1\r\n  - Platform: Mac\r\n","closedAt":"2021-06-14T22:14:03Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg1ODQ3ODkwNQ==","author":{"login":"marcin-maciej-seweryn"},"authorAssociation":"CONTRIBUTOR","body":"Hey,\r\nI stumbled upon the same issue and it looks like it caused by two things: creation of a custom super user in PostgreSQL and [this change](https://github.com/temporalio/temporal/commit/eff23dc9a2b5b78c143c13fdd7ab4697c640cb20#diff-e8c1cc5c1ead2df4935cc43558d7dbfa6183f3f3623f10c18c768dde87776e67R3).\r\nAccording to the [PostgreSQL docs](https://hub.docker.com/_/postgres):\r\n> This optional environment variable is used in conjunction with POSTGRES_PASSWORD to set a user and its password. This variable **will create the specified user with superuser power and a database with the same name**. If it is not specified, then the default user of postgres will be used.\r\n\r\nThis means that `temporal` database is created before initialization script is run.\r\n\r\nBefore the change, the `start.sh` script would continue to execute when `temporal-sql-tool` would fail to create a database and setup the schema, but the current version of `auto-setup.sh` will stop due to `set -e` flag and leave the database uninitialized.\r\n\r\nAn easy workaround is to specify a different name for the Temporal database through `DBNAME` variable.","createdAt":"2021-06-10T09:47:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/1613#issuecomment-858478905","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5mcYfq","author":{"login":"vaibhavpatil123"},"authorAssociation":"NONE","body":"I had same issue with Docker window but able to fix with below command \r\n\r\ndocker-compose -f docker-compose-postgres12.yml up\r\n\r\nThanks ","createdAt":"2023-09-14T03:39:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"ROCKET","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/1613#issuecomment-1718716394","viewerDidAuthor":false}],"createdAt":"2021-06-09T19:07:16Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg0","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1613,"reactionGroups":[],"state":"CLOSED","title":"Unable to start local server using latest postgres docker-compose file","updatedAt":"2023-09-14T03:39:05Z","url":"https://github.com/temporalio/temporal/issues/1613"}
