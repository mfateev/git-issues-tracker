{"assignees":[{"id":"MDQ6VXNlcjQ2NjcyMw==","login":"dnr","name":"David Reiss","databaseId":0}],"author":{"id":"MDQ6VXNlcjM2NTYxMQ==","is_bot":false,"login":"shaunco","name":"Shaun"},"body":"## Expected Behavior\r\nWhen Temporal accepts a client connection it should be in a fully operable state.\r\n\r\n## Actual Behavior\r\nOn initial startup (using https://github.com/temporalio/temporal/blob/master/docker/docker-compose.yml), Temporal accepts connections from clients, but then fails when a worker attempts to `Run()` (via the sdk-go) with `Namespace default does not exist.`\r\n\r\nThe Temporal server log looks something like this:\r\n```log\r\n1  : + echo 'waiting for cassandra to start up'\r\n2  : + sleep 1\r\n3  : + temporal-cassandra-tool --ep cassandra validate-health\r\n4  : 2020/12/08 10:24:33 gocql: unable to dial control conn 172.28.0.2: dial tcp 172.28.0.2:9042: connect: connection refused\r\n5  : 2020/12/08 10:24:33 unable to establish CQL session:gocql: unable to create session: control: unable to connect to initial hosts: dial tcp 172.28.0.2:9042: connect: connection refused\r\n6  :\r\n7  : ...\r\n8  :\r\n9  : + temporal-cassandra-tool --ep cassandra validate-health\r\n10 : + echo 'cassandra started'\r\n11 : + '[' '' '!=' true ']'\r\n12 : + setup_schema\r\n13 : + '[' cassandra == mysql ']'\r\n14 : cassandra started\r\n15 : + '[' cassandra == postgresql ']'\r\n16 : + echo 'setup cassandra schema'\r\n17 : + setup_cassandra_schema\r\n18 : setup cassandra schema\r\n19 :\r\n20 : ...\r\n21 :\r\n22 : + temporal-cassandra-tool --ep cassandra validate-health\r\n23 : + echo 'cassandra started'\r\n24 : + '[' '' '!=' true ']'\r\n25 : + setup_schema\r\n26 : + '[' cassandra == mysql ']'\r\n27 : cassandra started\r\n28 : + '[' cassandra == postgresql ']'\r\n29 : + echo 'setup cassandra schema'\r\n30 : + setup_cassandra_schema\r\n31 : setup cassandra schema\r\n32 :\r\n33 : ...\r\n34 :\r\n35 : {\"level\":\"info\",\"ts\":\"2020-12-08T10:24:49.675Z\",\"msg\":\"Created gRPC listener\",\"service\":\"history\",\"address\":\"172.28.0.3:7234\",\"logging-call-at\":\"rpc.go:134\"}\r\n36 : ...\r\n37 : {\"level\":\"info\",\"ts\":\"2020-12-08T10:24:49.942Z\",\"msg\":\"Created gRPC listener\",\"service\":\"matching\",\"address\":\"172.28.0.3:7235\",\"logging-call-at\":\"rpc.go:134\"}\r\n38 : ...\r\n39 : {\"level\":\"info\",\"ts\":\"2020-12-08T10:24:50.105Z\",\"msg\":\"Created gRPC listener\",\"service\":\"frontend\",\"address\":\"172.28.0.3:7233\",\"logging-call-at\":\"rpc.go:134\"}\r\n40 : ...\r\n41 : {\"level\":\"info\",\"ts\":\"2020-12-08T10:24:50.263Z\",\"msg\":\"Created gRPC listener\",\"service\":\"worker\",\"address\":\"172.28.0.3:7239\",\"logging-call-at\":\"rpc.go:134\"}\r\n42 :\r\n43 : ...\r\n44 :\r\n45 : + echo 'Registering default namespace: default'\r\n46 : + tctl --ns default namespace describe\r\n47 :\r\n48 : Registering default namespace: default\r\n49 : {\"level\":\"info\",\"ts\":\"2020-12-08T10:24:54.470Z\",\"msg\":\"temporal-sys-history-scanner-workflow workflow successfully started\",\"service\":\"worker\",\"logging-call-at\":\"scanner.go:196\"}\r\n50 : {\"level\":\"info\",\"ts\":\"2020-12-08T10:24:54.475Z\",\"msg\":\"Get dynamic config\",\"name\":\"system.advancedVisibilityWritingMode\",\"value\":\"off\",\"default-value\":\"off\",\"logging-call-at\":\"config.go:79\"}\r\n51 : {\"level\":\"info\",\"ts\":\"2020-12-08T10:24:54.475Z\",\"msg\":\"Get dynamic config\",\"name\":\"history.historyVisibilityOpenMaxQPS\",\"value\":\"300\",\"default-value\":\"300\",\"logging-call-at\":\"config.go:79\"}\r\n52 : Error: Operation DescribeNamespace failed.\r\n53 : Error Details: rpc error: code = NotFound desc = Namespace default does not exist.\r\n54 : ('export TEMPORAL_CLI_SHOW_STACKS=1' to see stack traces)\r\n55 : + echo 'Default namespace default not found. Creating...'\r\n57 : + sleep 1\r\n58 : Default namespace default not found. Creating...\r\n59 : + tctl --ns default namespace register --rd 1 --desc 'Default namespace for Temporal Server'\r\n60 : {\"level\":\"info\",\"ts\":\"2020-12-08T10:24:55.518Z\",\"msg\":\"Get dynamic config\",\"name\":\"history.enableAdminProtection\",\"value\":\"false\",\"default-value\":\"false\",\"logging-call-at\":\"config.go:79\"}\r\n61 : {\"level\":\"info\",\"ts\":\"2020-12-08T10:24:55.519Z\",\"msg\":\"Get dynamic config\",\"name\":\"system.visibilityArchivalState\",\"value\":\"enabled\",\"default-value\":\"enabled\",\"logging-call-at\":\"config.go:79\"}\r\n62 : {\"level\":\"info\",\"ts\":\"2020-12-08T10:24:55.552Z\",\"msg\":\"Register namespace succeeded\",\"service\":\"frontend\",\"wf-namespace\":\"default\",\"wf-namespace-id\":\"d13ba738-3b3c-4eb3-b60b-7dcbe75b275f\",\"logging-call-at\":\"handler.go:278\"}\r\n63 : Namespace default successfully registered.\r\n64 : + tctl --ns default namespace describe\r\n65 : Name: default\r\n66 : Id: d13ba738-3b3c-4eb3-b60b-7dcbe75b275f\r\n67 : Description: Default namespace for Temporal Server\r\n68 : OwnerEmail:\r\n69 : NamespaceData: map[string]string(nil)\r\n70 : State: Registered\r\n71 : RetentionInDays: 24h0m0s\r\n72 : ActiveClusterName: active\r\n73 : Clusters: active\r\n74 : HistoryArchivalState: Disabled\r\n75 : VisibilityArchivalState: Disabled\r\n76 : Bad binaries to reset:\r\n77 : +-----------------+----------+------------+--------+\r\n78 : | BINARY CHECKSUM | OPERATOR | START TIME | REASON |\r\n79 : +-----------------+----------+------------+--------+\r\n80 : +-----------------+----------+------------+--------+\r\n81 : Default namespace registration complete.\r\n82 : + echo 'Default namespace registration complete.'\r\n```\r\n\r\nFrom the client it looks like this:\r\n- Lines 1-38:\r\n   ```\r\n   health check error: last connection error: connection error: desc = \\\"transport: Error while dialing dial tcp 172.28.0.3:7233: connect: connection refused\r\n   ```\r\n- Lines 39-80 (as can be seen from the server on lines 52/54 above):\r\n   ```\r\n   unable to start Temporal worker error=\"Namespace default does not exist.\"\r\n   ```\r\n- Lines 81+: All is good\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Clone the https://github.com/temporalio/hello-world-project-template-go repo\r\n  1. Since the sample code exits on first failure, we can put in some retries... Replace `worker/main.go` with:\r\n     ```golang\r\n     func main() {\r\n         // Create the client object just once per process\r\n         var err error\r\n         c, err = client.NewClient(client.Options{})\r\n         if err != nil {\r\n             // Retry up to 600 times, 1 second delay each time (5 minutes)\r\n             const maxRetries = 600\r\n             for i := 0; i < maxRetries; i++ {\r\n                 time.Sleep(time.Second)\r\n                 c, err = client.NewClient(topts)\r\n                 if err == nil {\r\n                     break\r\n                 }\r\n \r\n                 // Only log after the first failed retry\r\n                 log.Warn(\"Temporal not available, retrying...\")\r\n             }\r\n         }\r\n\r\n\t\t // If we still failed, exit\r\n         c, err := client.NewClient(client.Options{})\r\n         if err != nil {\r\n             log.Fatalln(\"unable to create Temporal client\", err)\r\n         }\r\n         defer c.Close()\r\n         // This worker hosts both Worker and Activity functions\r\n         w := worker.New(c, app.GreetingTaskQueue, worker.Options{})\r\n         w.RegisterWorkflow(app.GreetingWorkflow)\r\n         w.RegisterActivity(app.ComposeGreeting)\r\n         // Start listening to the Task Queue\r\n         err = w.Run(worker.InterruptCh())\r\n         if err != nil {\r\n             log.Fatalln(\"unable to start Worker\", err)\r\n         }\r\n     }\r\n     ```\r\n  1. `go build worker`\r\n  1. Get `curl -O -J https://raw.githubusercontent.com/temporalio/temporal/master/docker/docker-compose.yml`\r\n  1. `docker-compose pull`\r\n  1. At roughly the same time in two different shells:\r\n     1. `docker-compose up`\r\n     1. `./worker/worker`\r\n     \r\n  As described above, worker will eventually connect, and then fail when `w.Run` is called because the default namespace hasn't been created.\r\n  \r\n## Additional Notes\r\nWhile I could put a similar retry loop around the `w.Run` call, I would rather fail fast if the worker is misconfigured and using the wrong namespace or something like that. For connections a retry loop makes sense, and the Temporal client's internal grpc client will automatically reestablish the connection if it fails after the initial connect, but the initial connect seems to have no such logic.\r\n\r\nIdeally, **sdk-go** would handle retries on both the `client.NewClient` call and the `w.Run` call, but there are no retry settings in `ConnectionOptions` or `WorkerOptions`. Happy to open a separate issue in that repo, but didn't want to spam the same team.\r\n\r\nSeems like the easiest fix, for now, is to simply not accept connections until the initial setup is 100% complete.\r\n\r\n## Specifications\r\n\r\n  - Version: Temporal v1.3.2, sdk-go v1.2.0\r\n  - Platform: Ubuntu\r\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM5B1mKE","author":{"login":"marniks7"},"authorAssociation":"NONE","body":"Hi, \r\nis there any plans to improve it?\r\n\r\nI i am trying to run Temporal as a part of integration tests with TestContainers, so i do need namespace created and ready right away.\r\nI use `temporalio/auto-setup:1.15.2` and `DEFAULT_NAMESPACE=mynamespace`.\r\nNamespace is created in the end, but it was required to apply WA, otherwise i got error that it is NOT found.\r\nIt takes up to `~10s` additional seconds for namespace to be ready.\r\n\r\nWA:\r\n```java\r\npublic boolean isNamespaceExist(String namespace) {\r\n  try {\r\n      DescribeNamespaceResponse response = workfloServiceStubs.blockingStub().describeNamespace(\r\n              DescribeNamespaceRequest.newBuilder().setNamespace(namespace).build());\r\n     return true;\r\n  } catch(StatusRuntimeException ex) {\r\n       return false;\r\n  }\r\n}\r\n```\r\n\r\n```java\r\nprivate static final int NAMESPACE_CHECK_SLEEP_MILLIS = 200;\r\nprivate static final int NAMESPACE_CHECK_MAXIMUM_WAIT_MILLIS = 10000;\r\n \r\nprivate void waitForNamespaceToBeReady(String temporalNamespace) {\r\n        int millis = 0;\r\n        while (true) {\r\n            final boolean namespaceExist = isNamespaceExist(temporalNamespace);\r\n            if (namespaceExist) {\r\n                break;\r\n            } else if (millis >= NAMESPACE_CHECK_MAXIMUM_WAIT_MILLIS) {\r\n                throw new RuntimeException(\"Unable to init app cause namespace \" + temporalNamespace + \" is not found in temporal\");\r\n            } else {\r\n                try {\r\n                    millis += NAMESPACE_CHECK_SLEEP_MILLIS;\r\n                    Thread.sleep(NAMESPACE_CHECK_SLEEP_MILLIS);\r\n                } catch (InterruptedException e) {\r\n                    throw new RuntimeException(e);\r\n                }\r\n            }\r\n        }\r\n    }\r\n```\r\nAnother similar issue about that: https://github.com/temporalio/temporal/issues/1941","createdAt":"2022-04-21T00:10:55Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1057#issuecomment-1104568964","viewerDidAuthor":false}],"createdAt":"2020-12-08T11:13:03Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"},{"id":"MDU6TGFiZWwyMDE5ODkxMzc4","name":"packaging","description":"","color":"baf702"},{"id":"MDU6TGFiZWwyMDE5OTIzNjU1","name":"devexp","description":"","color":"9350b7"}],"milestone":null,"number":1057,"reactionGroups":[],"state":"OPEN","title":"On first start Temporal should not accept connections until Default namespace is setup","updatedAt":"2023-03-03T20:23:10Z","url":"https://github.com/temporalio/temporal/issues/1057"}
