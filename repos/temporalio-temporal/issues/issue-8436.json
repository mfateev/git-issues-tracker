{"assignees":[],"author":{"id":"MDQ6VXNlcjU4OTIwNjE=","is_bot":false,"login":"jtamagnan","name":"Jules Tamagnan"},"body":"## Expected Behavior\n\nI wanted to connect to my postgresql database using `sslmode:verify-ca`. I tried to set:\n\n```\n                    connectAttributes:\n                      sslmode: \"verify-ca\"\n```\n\nbut it failed.\n\n## Actual Behavior\n\nThis is unsupported and leads to errors like:\n```\npanic: duplicate connection attr: sslmode:require, sslmode:verify-ca\n```\nwhen `cfg.TLS.Enabled == true`\n\nor:\n```\npanic: duplicate connection attr: sslmode:require, sslmode:verify-ca\n```\n\nwhen `cfg.TLS.Enabled == false`\n\nThe [code](https://github.com/temporalio/temporal/blob/main/common/persistence/sql/sqlplugin/postgresql/session/session.go#L93) that causes this is pretty easy to read:\n```go\n\tif cfg.TLS != nil && cfg.TLS.Enabled {\n\t\tif !cfg.TLS.EnableHostVerification {\n\t\t\tparameters.Set(sslMode, sslModeRequire)\n\t\t} else {\n\t\t\tparameters.Set(sslMode, sslModeFull)\n\t\t}\n\n\t\t...\n\t} else {\n\t\tparameters.Set(sslMode, sslModeNoop)\n\t}\n\n\tfor k, v := range cfg.ConnectAttributes {\n\t\tkey := strings.TrimSpace(k)\n\t\tvalue := strings.TrimSpace(v)\n\t\tif parameters.Get(key) != \"\" {\n\t\t\tpanic(fmt.Sprintf(\"duplicate connection attr: %v:%v, %v:%v\",\n\t\t\t\tkey,\n\t\t\t\tparameters.Get(key),\n\t\t\t\tkey, value,\n\t\t\t))\n\t\t}\n```\n\nregardless of what set of options we put in `sslmode` will always be set to one of `require`, `disable`, or `verify-full`. This means that if we have a configuration like:\n```\n                    connectAttributes:\n                      sslmode: \"verify-ca\"\n```\nwe'll run into issues.\n\n## Steps to Reproduce the Problem\n\nSet a config like:\n```\n                    connectAttributes:\n                      sslmode: \"verify-ca\"\n```\n\n## Specifications\n\n  - Version: [Master](https://github.com/temporalio/temporal/blob/main/common/persistence/sql/sqlplugin/postgresql/session/session.go#L93)\n  - Platform: Self-hosted","closedAt":"2025-11-27T01:35:49Z","comments":[{"id":"IC_kwDODNqesM7JU1w-","author":{"login":"jtamagnan"},"authorAssociation":"CONTRIBUTOR","body":"A targeted approach for postgresql may look something like this. I'd be happy to open a PR and try to usher it through if we think this would be a desireable solution. Another solution may be to not set the sslmode if it would be disabled or to let the sslmode be overwritten\n\n<details>\n\n<summary> Diff </summary>\n\n```diff\ndiff --git a/common/auth/tls.go b/common/auth/tls.go\nindex df0f8563d..9ba18f9be 100644\n--- a/common/auth/tls.go\n+++ b/common/auth/tls.go\n@@ -12,6 +12,10 @@ type (\n \t\tKeyFile  string `yaml:\"keyFile\"`\n \t\tCaFile   string `yaml:\"caFile\"` // optional depending on server config\n \n+\t\t// If you want to verify the CA certificate (but not the hostname) then you should turn this on\n+\t\t// This is only used for PostgreSQL and provides a middle ground between require and verify-full modes\n+\t\tEnableCaVerification bool `yaml:\"enableCaVerification\"`\n+\n \t\t// If you want to verify the hostname and server cert (like a wildcard for cass cluster) then you should turn this on\n \t\t// This option is basically the inverse of InSecureSkipVerify\n \t\t// See InSecureSkipVerify in http://golang.org/pkg/crypto/tls/ for more info\ndiff --git a/common/persistence/sql/sqlplugin/postgresql/session/session.go b/common/persistence/sql/sqlplugin/postgresql/session/session.go\nindex e2dc17333..318e309b7 100644\n--- a/common/persistence/sql/sqlplugin/postgresql/session/session.go\n+++ b/common/persistence/sql/sqlplugin/postgresql/session/session.go\n@@ -20,6 +20,7 @@ const (\n \tsslMode        = \"sslmode\"\n \tsslModeNoop    = \"disable\"\n \tsslModeRequire = \"require\"\n+\tsslModeVerifyCA = \"verify-ca\"\n \tsslModeFull    = \"verify-full\"\n \n \tsslCA   = \"sslrootcert\"\n@@ -93,10 +94,12 @@ func buildDSN(\n func buildDSNAttr(cfg *config.SQL) url.Values {\n \tparameters := url.Values{}\n \tif cfg.TLS != nil && cfg.TLS.Enabled {\n-\t\tif !cfg.TLS.EnableHostVerification {\n-\t\t\tparameters.Set(sslMode, sslModeRequire)\n-\t\t} else {\n+\t\tif cfg.TLS.EnableHostVerification {\n \t\t\tparameters.Set(sslMode, sslModeFull)\n+\t\t} else if cfg.TLS.EnableCaVerification {\n+\t\t\tparameters.Set(sslMode, sslModeVerifyCA)\n+\t\t} else {\n+\t\t\tparameters.Set(sslMode, sslModeRequire)\n \t\t}\n \n \t\tif cfg.TLS.CaFile != \"\" {\n```\n</details>\n\n---\n\n\nAnother solution could be to change the logic to only set `sslModeNoop` at the very end of the function if a `connectAttributes` doesn't set it.","createdAt":"2025-10-07T16:35:02Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/8436#issuecomment-3377683518","viewerDidAuthor":false}],"createdAt":"2025-10-06T22:45:21Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":8436,"reactionGroups":[],"state":"CLOSED","title":"Temporal does not support setting postgresql sslmode=verify-ca","updatedAt":"2025-11-27T01:35:49Z","url":"https://github.com/temporalio/temporal/issues/8436"}
