{"assignees":[],"author":{"id":"MDQ6VXNlcjY0MTIxNjk=","is_bot":false,"login":"mjameswh","name":"James Watkins-Harvey"},"body":"### Describe the bug\r\n\r\nLaunching the dev server, then sending it a shutdown signal (ie. ctrl-c) quickly after, cause the process to hang out for 10 seconds before the process actually exits. If waiting for a very short time (less than a second) before sending the signal, termination is immediate.\r\n\r\nThis delay is caused by the Worker node failing to connect to Frontend, and thus waiting until expiration of its context deadline delay (thus 10 seconds).\r\n\r\nThis is most apparent when using dev server in integration tests (eg. through SDKs \"test environment\" feature), as these tests frequently execute very quickly.\r\n\r\n### Minimal Reproduction\r\n\r\n```\r\ntemporal server start-dev & ; sleep 0.1 ; kill %1 ; fg %1\r\n```\r\nresults in a 10 seconds delay, followed by this error message:\r\n\r\n```\r\n{\"level\":\"fatal\",\"ts\":\"2023-01-19T12:17:25.645-0700\",\"msg\":\"error starting scanner\",\"service\":\"worker\",\"error\":\"context deadline exceeded\",\"logging-call-at\":\"service.go:504\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Fatal\\n\\tgo.temporal.io/server@v1.18.5/common/log/zap_logger.go:151\\ngo.temporal.io/server/service/worker.(*Service).startScanner\\n\\tgo.temporal.io/server@v1.18.5/service/worker/service.go:504\\ngo.temporal.io/server/service/worker.(*Service).Start\\n\\tgo.temporal.io/server@v1.18.5/service/worker/service.go:390\\ngo.temporal.io/server/service/worker.ServiceLifetimeHooks.func1.1\\n\\tgo.temporal.io/server@v1.18.5/service/worker/fx.go:139\"}\r\n```\r\n\r\nIncrementing the sleep time in the above command to `1.0`, no hang and no error message is observed.\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: Mac M1\r\n- Temporal Version: 1.8.5","closedAt":"2024-06-13T14:12:56Z","comments":[{"id":"IC_kwDODNqesM5aHZ45","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Potentially fixed by this [PR](https://github.com/temporalio/temporal/pull/3818). Will reevaluate once the PR lands in a cli release.","createdAt":"2023-01-20T12:40:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/4174#issuecomment-1511890489","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5aHZ5F","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Can still reproduce with cli 0.5.0.","createdAt":"2023-02-24T17:06:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4174#issuecomment-1511890501","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5aHZ5T","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Users have noticed this with Temporalite too.","createdAt":"2023-02-24T17:39:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4174#issuecomment-1511890515","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5aHZ5b","author":{"login":"feedmeapples"},"authorAssociation":"CONTRIBUTOR","body":"works fine in v0.8.0. Was the fix included in v0.5.0?","createdAt":"2023-04-17T18:17:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4174#issuecomment-1511890523","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5aHZ5j","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Tested just now with 0.8.0, and it still happens.","createdAt":"2023-04-17T18:20:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4174#issuecomment-1511890531","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5aHZ5o","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"This looks like a server issue, I'll transfer to `temporalio/temporal`.","createdAt":"2023-04-17T18:38:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4174#issuecomment-1511890536","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6BF3IO","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"This appears to have been fixed in server 1.24.0 / CLI 0.13.0, presumably thanks to #5459.\r\n\r\nI tested with various sleep durations, ranging from 0.01 seconds up to 2 seconds, and in all cases, the dev server completed shutdown within 1000-1400 ms of receiving the signal.","createdAt":"2024-06-13T14:12:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4174#issuecomment-2165797390","viewerDidAuthor":false}],"createdAt":"2023-01-19T19:20:36Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg0","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":4174,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Dev Server hangs for 10 seconds on early shutdown","updatedAt":"2024-06-13T14:12:56Z","url":"https://github.com/temporalio/temporal/issues/4174"}
