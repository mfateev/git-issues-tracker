{"assignees":[{"id":"MDQ6VXNlcjU1NTIzODE=","login":"mastermanu","name":"","databaseId":0}],"author":{"id":"MDQ6VXNlcjEwNjI2OTY=","is_bot":false,"login":"shyamalprasad","name":"Shyamal Prasad"},"body":"## Expected Behavior\r\n\r\ntemporalio/server docker instance should not die as a result of tctl commands\r\n\r\n## Actual Behavior\r\n\r\nA `tq lp --taskqueue foo` request fails with\r\n\r\n```\r\nError: Operation ListTaskQueuePartitions failed.\r\nError Details: transport is closing\r\n('export TEMPORAL_CLI_SHOW_STACKS=1' to see stack traces)\r\n```\r\n\r\nThe temporalio/server process dies with a panic\r\n\r\n```\r\ntemporal_1              | panic: runtime error: invalid memory address or nil pointer dereference\r\ntemporal_1              | [signal SIGSEGV: segmentation violation code=0x1 addr=0x18 pc=0x622a46]\r\ntemporal_1              | \r\ntemporal_1              | goroutine 136359 [running]:\r\ntemporal_1              | go.temporal.io/api/taskqueue/v1.(*TaskQueuePartitionMetadata).MarshalToSizedBuffer(0x0, 0xc00121b000, 0xfa0, 0xfa0, 0x204a2c8, 0xc000aab910, 0x44cb3c)\r\ntemporal_1              | \t/go/pkg/mod/go.temporal.io/api@v0.27.0/taskqueue/v1/message.pb.go:968 +0x26\r\ntemporal_1              | go.temporal.io/server/api/matchingservice/v1.(*ListTaskQueuePartitionsResponse).MarshalToSizedBuffer(0xc001e81e00, 0xc00121b000, 0xfa0, 0xfa0, 0x40a9a3, 0x1e15c20, 0x204a280)\r\ntemporal_1              | \t/temporal/api/matchingservice/v1/request_response.pb.go:3450 +0xc3\r\ntemporal_1              | go.temporal.io/server/api/matchingservice/v1.(*ListTaskQueuePartitionsResponse).Marshal(0xc001e81e00, 0x204a280, 0xc001e81e00, 0x7f97c552e588, 0xc001e81e00, 0xc000aaba01)\r\ntemporal_1              | \t/temporal/api/matchingservice/v1/request_response.pb.go:3430 +0x7a\r\ntemporal_1              | google.golang.org/grpc/encoding/proto.codec.Marshal(0x204a280, 0xc001e81e00, 0xc000902000, 0x7f97ec1d8108, 0x40952b, 0xc000030000, 0x1e2c3c0)\r\ntemporal_1              | \t/go/pkg/mod/google.golang.org/grpc@v1.30.0/encoding/proto/proto.go:70 +0x193\r\ntemporal_1              | google.golang.org/grpc.encode(0x7f97c555f518, 0x36c1988, 0x204a280, 0xc001e81e00, 0x36c1988, 0x0, 0xc000aabb30, 0x1a92051, 0x0)\r\ntemporal_1              | \t/go/pkg/mod/google.golang.org/grpc@v1.30.0/rpc_util.go:538 +0x52\r\ntemporal_1              | google.golang.org/grpc.(*Server).sendResponse(0xc0007f4a80, 0x261caa0, 0xc0016d1e00, 0xc00053ee00, 0x204a280, 0xc001e81e00, 0x0, 0x0, 0xc001a5fbdf, 0x0, ...)\r\ntemporal_1              | \t/go/pkg/mod/google.golang.org/grpc@v1.30.0/server.go:958 +0x89\r\ntemporal_1              | google.golang.org/grpc.(*Server).processUnaryRPC(0xc0007f4a80, 0x261caa0, 0xc0016d1e00, 0xc00053ee00, 0xc000826fc0, 0x367b580, 0x0, 0x0, 0x0)\r\ntemporal_1              | \t/go/pkg/mod/google.golang.org/grpc@v1.30.0/server.go:1206 +0x5fb\r\ntemporal_1              | google.golang.org/grpc.(*Server).handleStream(0xc0007f4a80, 0x261caa0, 0xc0016d1e00, 0xc00053ee00, 0x0)\r\ntemporal_1              | \t/go/pkg/mod/google.golang.org/grpc@v1.30.0/server.go:1494 +0xccd\r\ntemporal_1              | google.golang.org/grpc.(*Server).serveStreams.func1.2(0xc000d94fb0, 0xc0007f4a80, 0x261caa0, 0xc0016d1e00, 0xc00053ee00)\r\ntemporal_1              | \t/go/pkg/mod/google.golang.org/grpc@v1.30.0/server.go:834 +0xa1\r\ntemporal_1              | created by google.golang.org/grpc.(*Server).serveStreams.func1\r\ntemporal_1              | \t/go/pkg/mod/google.golang.org/grpc@v1.30.0/server.go:832 +0x204\r\ndocker_temporal_1 exited with code 2\r\n```\r\n## Steps to Reproduce the Problem\r\n\r\nThis happens on both v0.26.0 and v0.27.0:\r\n\r\n  1. Bring up a docker composed deployment: `docker-compose up` (also happens with the `-f docker-compose-mysql.yml` file)\r\n  1. Issue command: `docker run --network=host --rm temporalio/tctl:0.27.0 tq lp --taskqueue foo`\r\n\r\nJust to be clear, I'm new to Cadence/Temporal and am learning my way around the system and trying various commands. I don't claim to understand why I should be using this command (or not). I tried reading the source and it's not clear to me how this command and `admin tq` are related (or not), and I quickly got lost in the details about how the api code is built, but I suspect the panic is real a fault in any case.\r\n\r\n## Specifications\r\n\r\n  - Version: v0.27.0\r\n  - Platform: Docker version 19.03.12, build 48a66213fe\r\n  - Platform: Darwin C02MNCWNFD57 19.6.0 Darwin Kernel Version 19.6.0: Sun Jul  5 00:43:10 PDT 2020; root:xnu-6153.141.1~9/RELEASE_X86_64 x86_64\r\n","closedAt":"2020-07-22T01:54:09Z","comments":[],"createdAt":"2020-07-21T23:12:14Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg0","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":2,"title":"Code Complete","description":"","dueOn":"2020-07-31T00:00:00Z"},"number":586,"reactionGroups":[],"state":"CLOSED","title":"A  \"tq lp --taskqueue foo\" command causes server process to panic","updatedAt":"2020-07-22T01:54:09Z","url":"https://github.com/temporalio/temporal/issues/586"}
