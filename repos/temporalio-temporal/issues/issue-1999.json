{"assignees":[],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"## Expected Behavior\r\n`describeWorkflow#pendingActivity#lastWorkerIdentity` has an identity of the activity worker that picked up the activity task.\r\n\r\nTest in Java SDK PR https://github.com/temporalio/sdk-java/pull/784/files passes for Temporal server docker-compose.\r\n\r\n\r\n## Actual Behavior\r\n`lastWorkerIdentity` is empty if the activity is picked up by the worker, pending and it's the first attempt.\r\n\r\nTest in Java SDK PR https://github.com/temporalio/sdk-java/pull/784/files fails for Temporal server docker-compose.\r\n\r\n## Root Cause\r\nIf it is the first attempt to execute the activity task, Temporal server takes an identity of the activity worker from the long poll request here:\r\nhttps://github.com/temporalio/temporal/blob/ff069578a44dac7f39d7454771e88a989f62fe61/service/history/historyEngine.go#L1296\r\n\r\nBut it persists the identity into `ActivityInfo#StartedIdentity` only and not into `ActivityInfo#RetryLastWorkerIdentity`:\r\nhttps://github.com/temporalio/temporal/blob/ff069578a44dac7f39d7454771e88a989f62fe61/service/history/workflow/mutable_state_impl.go#L1915\r\n\r\n`describeWorkflow` implementation in turn doesn't use `ActivityInfo#StartedIdentity` at all and uses `ActivityInfo#RetryLastWorkerIdentity` only:\r\nhttps://github.com/temporalio/temporal/blob/ff069578a44dac7f39d7454771e88a989f62fe61/service/history/historyEngine.go#L1196\r\n\r\nAs the result, if the activity is picked up by the worker the first time and is in-progress, `describeWorkflow` returns an empty `pendingActivity#lastWorkerIdentity`.\r\n\r\n## Proposed Fix\r\nIf we consider that activity on the server always has a retry policy and retry information, the best fix is probably to write the worker identity to `ActivityInfo#RetryLastWorkerIdentity` right after `ActivityInfo#StartedIdentity` on the first attempt.\r\nAn alternative solution could be to resolve it inside `describeWorkflow` implementation: if there wasn't a retry yet, take LastWorkerIdentity from  `ActivityInfo#StartedIdentity` and if there was a retry, take it from `ActivityInfo#RetryLastWorkerIdentity`.\r\n\r\n","closedAt":"2021-10-03T19:03:51Z","comments":[{"id":"IC_kwDODNqesM43nJAP","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Fixed with https://github.com/temporalio/temporal/pull/2007","createdAt":"2021-10-03T19:03:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/1999#issuecomment-933007375","viewerDidAuthor":false}],"createdAt":"2021-09-30T04:37:16Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg0","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1999,"reactionGroups":[],"state":"CLOSED","title":"describeWorkflow()#pendingActivity#lastWorkerIdentity is empty if it's the first attempt to execute activity","updatedAt":"2021-10-03T19:03:52Z","url":"https://github.com/temporalio/temporal/issues/1999"}
