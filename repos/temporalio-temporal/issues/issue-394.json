{"assignees":[],"author":{"id":"MDQ6VXNlcjM3MjE0MQ==","is_bot":false,"login":"skrul","name":"Steve Krulewitz"},"body":"## Expected Behavior\r\n\r\nWe have been working on rolling out a temporal cluster (with mysql persistence) including having the canary continuously running to help ensure correctness. This seemed to work pretty well on the prior release v0.21.1 but the canary is not working properly on v0.23.0. I'll try to provide as much information here as I can.\r\n\r\nTo start with, the upgrade to v0.23.0 required me to re-create the temporal database (there was no upgrade path). So the problems I am encountering happened with an empty database.\r\n\r\nOnce the cluster was upgraded, I started running the canary (with visibility, batch, cancellation, and searchAttributes excluded because these were not working on v0.21.1). It ran for almost 20 minutes then the cron workflow (that runs the sanity workflow that runs the canaries) stopped starting. The canary process did not output any logs, and restarting the process didn't help. This is a graph of the `start` metric from the canary:\r\n\r\n![image](https://user-images.githubusercontent.com/372141/82388171-bb7c3600-99ed-11ea-8a83-6a3c2ab1e37b.png)\r\n\r\nWhile the canary was running, the `reset` canary was failing every time (I don't think this happened in the previous version).\r\n\r\nOnce thing that seems unusual is how the cron workflow is behaving -- it appears to be getting run many times a second yet the sanity workflow never gets started:\r\n\r\n![image](https://user-images.githubusercontent.com/372141/82388723-1e220180-99ef-11ea-8217-b78c21097002.png)\r\n\r\nOther things I noticed, the `timer_tasks` table seems to be growing at more than 1 row per second:\r\n\r\n```\r\nmysql> select count(*) from timer_tasks;\r\n+----------+\r\n| count(*) |\r\n+----------+\r\n|   154783 |\r\n+----------+\r\n1 row in set (0.03 sec)\r\n```\r\n\r\nHere is the history of one of the many cron workflows:\r\n```\r\n# tctl --ns canary wf show -w cadence.canary.cron -r d44d5b65-3c95-4f74-b319-f4640e8060e8\r\n  1  WorkflowExecutionStarted         {WorkflowType:{Name:cronWorkflow}, ParentInitiatedEventId:0,\r\n                                       TaskList:{Name:canary-task-queue, Kind:Normal},\r\n                                       Input:{\"canary\",\"workflow.sanity\"},\r\n                                       WorkflowExecutionTimeoutSeconds:1080,\r\n                                       WorkflowRunTimeoutSeconds:1080,\r\n                                       WorkflowTaskTimeoutSeconds:10,\r\n                                       ContinuedExecutionRunId:e12a8224-44ad-4db9-b4ad-4894d484a336,\r\n                                       Initiator:CronSchedule,\r\n                                       ContinuedFailureReason:temporalInternal:Timeout StartToClose,\r\n                                       ContinuedFailureDetails:{}, LastCompletionResult:{},\r\n                                       OriginalExecutionRunId:d44d5b65-3c95-4f74-b319-f4640e8060e8,\r\n                                       FirstExecutionRunId:4178af07-f8b4-4cfe-85f3-7af8bdb64904,\r\n                                       Attempt:0,\r\n                                       WorkflowExecutionExpirationTimestamp:1589853344158000000,\r\n                                       CronSchedule:@every 30s,\r\n                                       FirstDecisionTaskBackoffSeconds:2172214,\r\n                                       PrevAutoResetPoints:{Points:[len=1]}, Header:{Fields:map{}}}\r\n  2  WorkflowExecutionContinuedAsNew  {NewExecutionRunId:9c26d2d2-3256-4dba-9eac-7147a215735b,\r\n                                       WorkflowType:{Name:cronWorkflow},\r\n                                       TaskList:{Name:canary-task-queue, Kind:Normal},\r\n                                       Input:{\"canary\",\"workflow.sanity\"},\r\n                                       WorkflowRunTimeoutSeconds:1080,\r\n                                       WorkflowTaskTimeoutSeconds:10,\r\n                                       DecisionTaskCompletedEventId:-23,\r\n                                       BackoffStartIntervalInSeconds:2172243,\r\n                                       Initiator:CronSchedule,\r\n                                       FailureReason:temporalInternal:Timeout StartToClose,\r\n                                       FailureDetails:{}, LastCompletionResult:{},\r\n                                       Header:{Fields:map{}}}\r\n```\r\n\r\nI'm happy to provide more information, I'm not sure what else I can add here. The workflow is not getting executed so I don't see much in the way of log lines or metics to report.\r\n\r\n## Specifications\r\n\r\n  - Version: Temporal v0.23.0 with mysql persistence\r\n  - Platform: Linux (k8s)\r\n","closedAt":"2020-06-06T01:11:47Z","comments":[],"createdAt":"2020-05-19T23:47:42Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg0","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":394,"reactionGroups":[],"state":"CLOSED","title":"canary not running properly on v0.23.0","updatedAt":"2020-07-18T01:08:36Z","url":"https://github.com/temporalio/temporal/issues/394"}
