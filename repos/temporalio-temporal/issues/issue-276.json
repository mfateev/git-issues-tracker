{"assignees":[{"id":"MDQ6VXNlcjE3NjY1MTU=","login":"samarabbas","name":"Samar Abbas","databaseId":0}],"author":{"id":"MDQ6VXNlcjE0NjM2MjI=","is_bot":false,"login":"mfateev","name":"Maxim Fateev"},"body":"Currently when a single decision batch contains `StartChildWorkflowExecution` and `RequestCancelExternalWorkflowExecution` the cancellation fails and the child is started.\r\nThe expected behaviour is that the child is immediately cancelled ideally by writing the following events into the history:\r\n\r\n1. `RequestCancelExternalWorkflowExecutionInitiated`\r\n2. `ExternalWorkflowExecutionCancelRequested`\r\n3. `ChildWorkflowExecutionCanceled`\r\n\r\nHere is an example history which shows the current broken behaviour:\r\n```\r\n   1  2020-04-05T16:34:53-07:00  EventTypeWorkflowExecutionStarted                         {WorkflowType:{Name:TestWorkflow_execute}, ParentInitiatedEventId:0,\r\n                                                                                           TaskList:{Name:WorkflowTest-testChildWorkflowCancellation-49a80f10-fb1d-49c6-a9f1-282b2e31f460,\r\n                                                                                           Kind:TaskListKindNormal}, Input:[\"WAIT_CANCELLATION_REQUESTED\"],\r\n                                                                                           ExecutionStartToCloseTimeoutSeconds:30, TaskStartToCloseTimeoutSeconds:5,\r\n                                                                                           Initiator:ContinueAsNewInitiatorDecider, ContinuedFailureDetails:[], LastCompletionResult:[],\r\n                                                                                           OriginalExecutionRunId:f2bc6299-a8b3-4996-9c0c-f4414f1a79bd, Identity:unknown-mac,\r\n                                                                                           FirstExecutionRunId:f2bc6299-a8b3-4996-9c0c-f4414f1a79bd, Attempt:0, ExpirationTimestamp:0,\r\n                                                                                           FirstDecisionTaskBackoffSeconds:0}\r\n   2  2020-04-05T16:34:53-07:00  EventTypeDecisionTaskScheduled                            {TaskList:{Name:WorkflowTest-testChildWorkflowCancellation-49a80f10-fb1d-49c6-a9f1-282b2e31f460,\r\n                                                                                           Kind:TaskListKindNormal}, StartToCloseTimeoutSeconds:5, Attempt:0}\r\n   3  2020-04-05T16:34:53-07:00  EventTypeWorkflowExecutionCancelRequested                 {ExternalInitiatedEventId:0,\r\n                                                                                           Identity:unknown-mac}\r\n   4  2020-04-05T16:34:53-07:00  EventTypeDecisionTaskStarted                              {ScheduledEventId:2, Identity:unknown-mac,\r\n                                                                                           RequestId:15e68a7d-672f-4e20-937c-3f3b3c646734}\r\n   5  2020-04-05T16:34:53-07:00  EventTypeDecisionTaskCompleted                            {ExecutionContext:[],\r\n                                                                                           ScheduledEventId:2,\r\n                                                                                           StartedEventId:4,\r\n                                                                                           Identity:unknown-mac}\r\n   6  2020-04-05T16:34:53-07:00  EventTypeStartChildWorkflowExecutionInitiated             {WorkflowId:68563d49-3289-3c7a-9a39-e0e0d21d39bf,\r\n                                                                                           WorkflowType:{Name:TestChildWorkflow_execute},\r\n                                                                                           TaskList:{Name:WorkflowTest-testChildWorkflowCancellation-49a80f10-fb1d-49c6-a9f1-282b2e31f460,\r\n                                                                                           Kind:TaskListKindNormal}, Input:[], ExecutionStartToCloseTimeoutSeconds:30,\r\n                                                                                           TaskStartToCloseTimeoutSeconds:10, ParentClosePolicy:ParentClosePolicyAbandon,\r\n                                                                                           Control:[], DecisionTaskCompletedEventId:5,\r\n                                                                                           WorkflowIdReusePolicy:WorkflowIdReusePolicyAllowDuplicateFailedOnly}\r\n   7  2020-04-05T16:34:53-07:00  EventTypeRequestCancelExternalWorkflowExecutionInitiated  {DecisionTaskCompletedEventId:5,\r\n                                                                                           WorkflowExecution:{WorkflowId:68563d49-3289-3c7a-9a39-e0e0d21d39bf},\r\n                                                                                           Control:[], ChildWorkflowOnly:true}\r\n   8  2020-04-05T16:34:53-07:00  EventTypeRequestCancelExternalWorkflowExecutionFailed     {Cause:CancelExternalWorkflowExecutionFailedCauseUnknownExternalWorkflowExecution,\r\n                                                                                           DecisionTaskCompletedEventId:-23, Namespace:UnitTest,\r\n                                                                                           WorkflowExecution:{WorkflowId:68563d49-3289-3c7a-9a39-e0e0d21d39bf}, InitiatedEventId:7,\r\n                                                                                           Control:[]}\r\n   9  2020-04-05T16:34:53-07:00  EventTypeDecisionTaskScheduled                            {TaskList:{Name:unknown-mac:83e37a46-43b3-40e0-bbc0-a40f27208f84,\r\n                                                                                           Kind:TaskListKindNormal}, StartToCloseTimeoutSeconds:5,\r\n                                                                                           Attempt:0}\r\n  10  2020-04-05T16:34:53-07:00  EventTypeChildWorkflowExecutionStarted                    {InitiatedEventId:6,\r\n                                                                                           WorkflowExecution:{WorkflowId:68563d49-3289-3c7a-9a39-e0e0d21d39bf,\r\n                                                                                           RunId:c4b71487-52e5-4984-a47d-105fa4478979},\r\n                                                                                           WorkflowType:{Name:TestChildWorkflow_execute}}\r\n  11  2020-04-05T16:34:53-07:00  EventTypeDecisionTaskStarted                              {ScheduledEventId:9,\r\n                                                                                           Identity:83e37a46-43b3-40e0-bbc0-a40f27208f84,\r\n                                                                                           RequestId:995457b0-b937-4333-b5c1-2b6083bee769}\r\n  12  2020-04-05T16:34:53-07:00  EventTypeDecisionTaskCompleted                            {ExecutionContext:[],\r\n                                                                                           ScheduledEventId:9,\r\n                                                                                           StartedEventId:11,\r\n                                                                                           Identity:unknown-mac}\r\n  13  2020-04-05T16:35:23-07:00  EventTypeWorkflowExecutionTimedOut                        {TimeoutType:TimeoutTypeStartToClose}\r\n```","closedAt":"2020-07-24T20:00:28Z","comments":[],"createdAt":"2020-04-05T23:53:36Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":{"number":2,"title":"Code Complete","description":"","dueOn":"2020-07-31T00:00:00Z"},"number":276,"reactionGroups":[],"state":"CLOSED","title":"Fix handling of immediate child workflow cancellation","updatedAt":"2020-07-24T20:00:28Z","url":"https://github.com/temporalio/temporal/issues/276"}
