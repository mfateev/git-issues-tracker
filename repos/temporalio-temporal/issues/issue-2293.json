{"assignees":[{"id":"MDQ6VXNlcjYzNTAzMDE=","login":"jbreiding","name":"Jeremy","databaseId":0}],"author":{"id":"MDQ6VXNlcjM4MzgwODg=","is_bot":false,"login":"michaeljguarino","name":""},"body":"## Expected Behavior\r\nI've been trying to get the temporalio/auto-setup container working with zalando's postgres operator on k8s, which requires sslmode=require or greater for all connections.  As far as I can tell, there's no way to get it to configure those ssl parameters correctly.  I've set the env var SQL_TLS_ENABLED and confirmed it generates the config file in a way that looks correct, but still no dice.  Every time the entrypoint runs it emits this message:\r\n\r\n```\r\ntemporal-sql-tool --plugin postgres --ep plural-airbyte -u airbyte -p 5432 create --db temporal\r\n2021-12-12T18:20:56.019Z        ERROR   Unable to create SQL database.  {\"error\": \"unable to connect to DB, tried default DB names: postgres,defaultdb, errors: [pq: pg_hba.conf rejects connection for host \\\"10.0.1.59\\\", user \\\"airbyte\\\", database \\\"postgres\\\", SSL off pq: pg_hba.conf rejects connection for host \\\"10.0.1.59\\\", user \\\"airbyte\\\", database \\\"defaultdb\\\", SSL off]\", \"logging-call-at\": \"handler.go:97\"} \r\n```\r\n\r\nSuggesting it reverts back to a non-tls connection\r\n\r\n## Actual Behavior\r\n\r\nUnable to create database or migrate tables due to lack of tls connection\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Provision a zalando postgres db instance (or an equivalent)\r\n  2. Run temporalio/auto-setup:1.13.1 with env vars wiring in username/secrets, etc\r\n  3. See above error log, container crashes\r\n\r\n## Specifications\r\n\r\n  - Version: 1.13.1\r\n  - Platform: docker\r\n","closedAt":"2022-04-11T15:47:48Z","comments":[{"id":"IC_kwDODNqesM47H-0H","author":{"login":"michaeljguarino"},"authorAssociation":"NONE","body":"This is the persistence block of the config file, for reference:\r\n\r\n```\r\npersistence:\r\n    numHistoryShards: 4\r\n    defaultStore: default\r\n    visibilityStore: visibility\r\n    datastores:\r\n        default:\r\n            sql:\r\n                pluginName: \"postgres\"\r\n                databaseName: \"temporal\"\r\n                connectAddr: \"plural-airbyte:5432\"\r\n                connectProtocol: \"tcp\"\r\n                user: \"airbyte\"\r\n                password: \"OMITTED\"\r\n                maxConns: 20\r\n                maxIdleConns: 20\r\n                maxConnLifetime: 1h\r\n                tls:\r\n                    enabled: true\r\n                    —ÅaFile: \r\n                    certFile: \r\n                    keyFile: \r\n                    enableHostVerification: false\r\n                    serverName: \r\n```","createdAt":"2021-12-12T18:32:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2293#issuecomment-991948039","viewerDidAuthor":false},{"id":"IC_kwDODNqesM47IA9D","author":{"login":"michaeljguarino"},"authorAssociation":"NONE","body":"Ok I think I found the workaround, by adding the following env vars:\r\n\r\n```\r\n- name: SQL_TLS\r\n   value: 'true'\r\n- name: SQL_TLS_DISABLE_HOST_VERIFICATION\r\n   value: 'true'\r\n```\r\n\r\nWhich I tracked down in the source code here: https://github.com/temporalio/temporal/blob/master/tools/sql/main.go#L110.  It was definitely not straightforwardly documented, perhaps that should be covered in the docker setup docs?","createdAt":"2021-12-12T19:31:33Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":5}}],"url":"https://github.com/temporalio/temporal/issues/2293#issuecomment-991956803","viewerDidAuthor":false},{"id":"IC_kwDODNqesM47nWnv","author":{"login":"AjayShekar01"},"authorAssociation":"NONE","body":"Thanks, this worked for me.","createdAt":"2021-12-23T09:41:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2293#issuecomment-1000172015","viewerDidAuthor":false},{"id":"IC_kwDODNqesM49Jxp9","author":{"login":"gajus"},"authorAssociation":"NONE","body":"I am getting similar error:\r\n\r\n```\r\nUnable to start server: sql schema version compatibility check failed: pq: no pg_hba.conf entry for host \"104.198.164.49\", user \"avnadmin\", database \"temporal\", no encryption.\r\n```\r\n\r\nAdding the aforementioned ENV variables did not solve it.","createdAt":"2022-01-31T16:34:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2293#issuecomment-1025972861","viewerDidAuthor":false},{"id":"IC_kwDODNqesM49J93T","author":{"login":"gajus"},"authorAssociation":"NONE","body":"Just tried downgrading to PostgreSQL v13.\r\n\r\nStill getting this error:\r\n\r\n```\r\n{\"level\":\"info\",\"ts\":\"2022-01-31T17:23:08.336Z\",\"msg\":\"Starting server for services\",\"value\":\"[history matching frontend worker]\",\"logging-call-at\":\"server.go:110\"}\r\nUnable to start server: sql schema version compatibility check failed: pq: no pg_hba.conf entry for host \"34.136.113.111\", user \"avnadmin\", database \"temporal\", SSL off.\r\n```\r\n\r\nEverything appears to be correctly applied:\r\n\r\n```yaml\r\nContainers:\r\n  airbyte-temporal:\r\n    Container ID:   containerd://4c2c1af8c9458ebaa373c1533fdba2cc1d47549e7570e9d6b537c245f1bee74a\r\n    Image:          temporalio/auto-setup:1.7.0\r\n    Image ID:       docker.io/temporalio/auto-setup@sha256:543cf318f8a12a89fdac6f5a620c347be11a6a14773cac678640ee9a053efc9f\r\n    Port:           7233/TCP\r\n    Host Port:      0/TCP\r\n    State:          Waiting\r\n      Reason:       CrashLoopBackOff\r\n    Last State:     Terminated\r\n      Reason:       Error\r\n      Exit Code:    1\r\n      Started:      Mon, 31 Jan 2022 12:23:07 -0500\r\n      Finished:     Mon, 31 Jan 2022 12:23:08 -0500\r\n    Ready:          False\r\n    Restart Count:  6\r\n    Environment:\r\n      AUTO_SETUP:                         true\r\n      DB:                                 postgresql\r\n      DB_PORT:                            23893\r\n      POSTGRES_USER:                      avnadmin\r\n      POSTGRES_PWD:                       <set to the key 'POSTGRES_PASSWORD' in secret 'contra-airbyte'>  Optional: false\r\n      POSTGRES_SEEDS:                     airbyte-contra.aivencloud.com\r\n      DYNAMIC_CONFIG_FILE_PATH:           config/dynamicconfig/development.yaml\r\n      SQL_TLS:                            true\r\n      SQL_TLS_DISABLE_HOST_VERIFICATION:  true\r\n    Mounts:\r\n      /etc/temporal/config/dynamicconfig/ from airbyte-temporal-dynamicconfig (rw)\r\n      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-2t94l (ro)\r\n```","createdAt":"2022-01-31T17:23:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2293#issuecomment-1026022867","viewerDidAuthor":false},{"id":"IC_kwDODNqesM4-fD6Y","author":{"login":"jbreiding"},"authorAssociation":"CONTRIBUTOR","body":"@michaeljguarino reading through the comments, it appears the next steps are better documentation around the environment variables you had to dig for?","createdAt":"2022-02-23T00:09:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2293#issuecomment-1048329880","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5BR95i","author":{"login":"jbreiding"},"authorAssociation":"CONTRIBUTOR","body":"Once this PR lands, https://github.com/temporalio/docker-compose/pull/82, hopefully it will be simpler to perform this task until we refactor this process.","createdAt":"2022-04-11T15:47:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2293#issuecomment-1095229026","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5dL1Wk","author":{"login":"mradb"},"authorAssociation":"NONE","body":"@gajus i ran into the same error with Azure Postgres v14.7 how did you fix it please ? ","createdAt":"2023-05-25T19:08:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/temporal/issues/2293#issuecomment-1563383204","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5hHSa4","author":{"login":"weisdd"},"authorAssociation":"NONE","body":"@mradb I had to manually modify chart (only `server-job.yaml`)  to include the vars that @michaeljguarino mentioned, namely:\r\n```yaml\r\n            - name: SQL_TLS\r\n              value: \"true\"\r\n            - name: SQL_TLS_DISABLE_HOST_VERIFICATION\r\n              value: \"true\"\r\n```\r\nAlso, had [to whitelist `btree_gin` azure.extension](https://learn.microsoft.com/en-us/azure/postgresql/flexible-server/concepts-extensions#postgres-14-extensions):\r\n```hcl\r\nresource \"azurerm_postgresql_flexible_server_configuration\" \"azure_extensions\" {\r\n  name      = \"azure.extensions\"\r\n  server_id = azurerm_postgresql_flexible_server.this.id\r\n  value     = \"btree_gin\"\r\n}\r\n```","createdAt":"2023-07-10T16:25:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2293#issuecomment-1629300408","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5s2zJ_","author":{"login":"skynet2"},"authorAssociation":"NONE","body":"Had the same issues while airbyte setup. \r\n\r\nAdding the following env variables solved the issue for auto-setup.\r\n```      \r\n      - name: SQL_TLS\r\n        value: 'true'\r\n      - name: SQL_TLS_DISABLE_HOST_VERIFICATION\r\n        value: 'true'\r\n      - name: SQL_TLS_ENABLED\r\n        value: 'true'\r\n      - name: SQL_HOST_VERIFICATION\r\n        value: 'false'\r\n````\r\nRef https://github.com/temporalio/temporal/blob/955b87c23a3e380b5f435640f1add832f14e7021/docker/config_template.yaml#L170","createdAt":"2023-11-25T13:11:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":2}}],"url":"https://github.com/temporalio/temporal/issues/2293#issuecomment-1826304639","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6udmvA","author":{"login":"munagasaikrishna1234"},"authorAssociation":"NONE","body":"In temporal engine i got a critical Jira ticket that needs to be enable SSL in temporal engine so i did the changes in temoral engine like below\\\n\nIn config_template.yml\ntls:\nenabled: {{ default .Env.SQL_TLS_ENABLED \"true\" }}\ncaFile: {{ default .Env.SQL_CA \"\" }}\ncertFile: {{ default .Env.SQL_CERT \"\" }}\nkeyFile: {{ default .Env.SQL_CERT_KEY \"\" }}\nenableHostVerification: {{ default .Env.SQL_HOST_VERIFICATION \"true\" }}\nserverName: {{ default .Env.SQL_HOST_NAME \"\" }}\n\nBefore both default .Env.SQL_TLS_ENABLED and .Env.SQL_HOST_VERIFICATION are false and i changed it to true and in\ndocker-compose.yml\ni added\nenvironment:\n- SSL=true\n- SQL_TLS=true\n- SQL_TLS_ENABLED=true\n- SQL_HOST_VERIFICATION= \"true\"\n\npls reply this ticket as early as possible as it is very critical","createdAt":"2025-06-01T10:38:39Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2293#issuecomment-2926996416","viewerDidAuthor":false}],"createdAt":"2021-12-12T18:31:04Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE2MjA1","name":"documentation","description":"","color":"bafc6f"}],"milestone":null,"number":2293,"reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"state":"CLOSED","title":"auto-setup docker container not connecting to psql over tls","updatedAt":"2025-06-01T10:54:32Z","url":"https://github.com/temporalio/temporal/issues/2293"}
