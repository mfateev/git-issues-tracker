{"assignees":[{"id":"MDQ6VXNlcjE5MjM5OTU=","login":"gow","name":"Chetan Gowda","databaseId":0},{"id":"MDQ6VXNlcjc3NTQxMjA=","login":"yycptt","name":"Yichao Yang","databaseId":0}],"author":{"id":"MDQ6VXNlcjE5OTk3MTY3","is_bot":false,"login":"AZAZELPE","name":"Luis Enrique Ruiz Cueva"},"body":"## Expected Behavior\r\n1. Go to Temporal UI\r\n2. Select the workflow from the list\r\n3. Click Terminate [workflow]\r\n4. Workflow terminated\r\n\r\n## Actual Behavior\r\n1. Go to Temporal UI\r\n2. Select the workflow from the list\r\n3. Click Terminate [workflow]\r\n4. Error message -> `cannot terminate workflow`\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Create a workflow.\r\n  2. Start the workflow with a transaction size greater than limit of 4MB.\r\n  3. Try to terminate workflow. (ERROR)\r\n\r\n## Specifications\r\n\r\n  - Version: 2.19\r\n  - Platform: Self-hosted\r\n\r\n## Error messages on the Temporal Server that are shown many times\r\n```\r\n{\"level\":\"error\",\"ts\":\"2024-09-26T16:32:30.826Z\",\"msg\":\"Operation failed with internal error.\",\"error\":\"transaction size of 5074977 bytes exceeds limit of 4194304 bytes\",\"operation\":\"UpdateWorkflowExecution\",\"logging-call-at\":\"persistenceMetricClients.go:1163\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/home/builder/temporal/common/log/zap_logger.go:144\\ngo.temporal.io/server/common/persistence.updateErrorMetric\\n\\t/home/builder/temporal/common/persistence/persistenceMetricClients.go:1163\\ngo.temporal.io/server/common/persistence.(*metricEmitter).recordRequestMetrics\\n\\t/home/builder/temporal/common/persistence/persistenceMetricClients.go:1140\\ngo.temporal.io/server/common/persistence.(*executionPersistenceClient).UpdateWorkflowExecution.func1\\n\\t/home/builder/temporal/common/persistence/persistenceMetricClients.go:243\\ngo.temporal.io/server/common/persistence.(*executionPersistenceClient).UpdateWorkflowExecution\\n\\t/home/builder/temporal/common/persistence/persistenceMetricClients.go:245\\ngo.temporal.io/server/common/persistence.(*executionRetryablePersistenceClient).UpdateWorkflowExecution.func1\\n\\t/home/builder/temporal/common/persistence/persistenceRetryableClients.go:258\\ngo.temporal.io/server/common/backoff.ThrottleRetryContext\\n\\t/home/builder/temporal/common/backoff/retry.go:194\\ngo.temporal.io/server/common/persistence.\r\n[....]\r\n```\r\n\r\nand also \r\n```\r\n{\"level\":\"error\",\"ts\":\"2024-09-26T16:32:30.827Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":1,\"address\":\"10.0.221.155:7234\",\"wf-namespace-id\":\"66e88c5d-4ba5-44e2-b1c2-84e812375fc4\",\"wf-id\":\"import-2b46bd7f-66fb-4693-a14e-411ec22d7adc-7f158055-c6dc-48bf-93ef-354380522481\",\"wf-run-id\":\"e4e45073-2a8b-4c84-884c-e0946b60bbb7\",\"store-operation\":\"update-wf-execution\",\"error\":\"transaction size of 5074977 bytes exceeds limit of 4194304 bytes\",\"logging-call-at\":\"transaction_impl.go:455\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/home/builder/temporal/common/log/zap_logger.go:144\\ngo.temporal.io/server/service/history/workflow.updateWorkflowExecution\\n\\t/home/builder/temporal/service/history/workflow/transaction_impl.go:455\\ngo.temporal.io/server/service/history/workflow.\r\n[...]\r\n```\r\n\r\n","closedAt":"2025-03-06T23:01:52Z","comments":[{"id":"IC_kwDODNqesM6SFsSJ","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"What server version are you running?","createdAt":"2024-10-31T22:34:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6638#issuecomment-2450965641","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6SF-RN","author":{"login":"AZAZELPE"},"authorAssociation":"NONE","body":"Version 1.19","createdAt":"2024-10-31T23:59:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6638#issuecomment-2451039309","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6Sqir0","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Thanks, we'll take a look.","createdAt":"2024-11-06T19:41:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6638#issuecomment-2460625652","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6d46z9","author":{"login":"gow"},"authorAssociation":"MEMBER","body":"Hi @AZAZELPE could you please elaborate step #2 in reproduction steps?\n>Start the workflow with a transaction size greater than limit of 4MB.\n\nHow did you do this?","createdAt":"2025-02-10T18:50:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/6638#issuecomment-2648943869","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6ffjPE","author":{"login":"yycptt"},"authorAssociation":"MEMBER","body":"Hello @AZAZELPE did you change the value for `system.transactionSizeLimit` to be higher than 4MB and then reduced it before terminating? Or there's no change to the config value, but the workflow just got into a state where transaction size is > 4MB and can't be terminated?\n\nI am guessing there are too many buffered events in the workflow which exceeds the 4MB and can't be flushed upon workflow termination. This issue is fixed in later releases and we will prevent buffered events from growing to be larger than 2MB.  \n\nBut if the buffered event is already there, the only way to mitigate this issue is to temporary increase the `system.transactionSizeLimit` and allow the termination to go through. Or, if possible, just delete the workflow with temporal CLI, that doesn't require the size limit config change I think. ","createdAt":"2025-02-22T00:01:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6638#issuecomment-2675848132","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6hPQWC","author":{"login":"yycptt"},"authorAssociation":"MEMBER","body":"Closing the issue due to in inactivity. Feel free to reopen with new updates/info.","createdAt":"2025-03-06T23:01:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6638#issuecomment-2705130882","viewerDidAuthor":false}],"createdAt":"2024-10-10T15:54:53Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":6638,"reactionGroups":[],"state":"CLOSED","title":"Workflow cannot be terminated","updatedAt":"2025-03-06T23:01:53Z","url":"https://github.com/temporalio/temporal/issues/6638"}
