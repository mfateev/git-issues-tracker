{"assignees":[],"author":{"id":"MDQ6VXNlcjUxNDUzMTA1","is_bot":false,"login":"NAjustin","name":"Justin Beasley"},"body":"## Expected Behavior\r\nTemporal should connect correctly regardless of what characters are contained in the password.\r\n\r\n## Actual Behavior\r\nTemporal actually has mixed results when certain characters are present:\r\n1. The `temporal-sql-tool` appears to run correctly. For example, it creates the `temporal` and `temporal_visibility` databases, as well as creates/updates the schemas. **This also proves that the password is, in fact, _valid_.**\r\n2. But that's where success ends. Once the creation/update is handled, connections begin to error: `sql schema version compatibility check failed: pq: password authentication failed for user \"example-user\"`\r\n\r\nHere's the full section of logs containing errors:\r\n```\r\n[Fx] ERROR  Failed to initialize custom logger: could not build arguments for function \"go.uber.org/fx\".(*App).constructCustomLogger.func2\r\n/go/pkg/mod/go.uber.org/fx@v1.18.2/app.go:414:\r\nfailed to build fxevent.Logger:\r\ncould not build arguments for function \"go.temporal.io/server/temporal\".glob..func8\r\n/home/builder/temporal/temporal/fx.go:1025:\r\nfailed to build log.Logger:\r\nreceived non-nil error from function \"go.temporal.io/server/temporal\".ServerOptionsProvider\r\n/home/builder/temporal/temporal/fx.go:159:\r\nsql schema version compatibility check failed: pq: password authentication failed for user \"example-user\"\r\nUnable to create server. Error: could not build arguments for function \"go.uber.org/fx\".(*App).constructCustomLogger.func2 (/go/pkg/mod/go.uber.org/fx@v1.18.2/app.go:414): failed to build fxevent.Logger: could not build arguments for function \"go.temporal.io/server/temporal\".glob..func8 (/home/builder/temporal/temporal/fx.go:1025): failed to build log.Logger: received non-nil error from function \"go.temporal.io/server/temporal\".ServerOptionsProvider (/home/builder/temporal/temporal/fx.go:159): sql schema version compatibility check failed: pq: password authentication failed for user \"example-user\".\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Use special characters in your password. Verified (failed) example: `y{0zzu2p3\\t*az<g`\r\n  2. Deploy Temporal (I used Helm)\r\n  3. Enjoy the errors\r\n\r\nChanging the password to not include the above characters makes the identical setup work correctly (and also fixes the surrounding errors). I didn't have the time to hunt down the offending character sequence, but my money is on the `\\t` getting turned into a tab somewhere in the execution (e.g. before or after the password gets turned into a DSN)â€”but because the `temporal-sql-tool` scripts run in the same deployment, I think it's safe to rule out environmental factors. It may just be that `net/url.QueryEscape` isn't the right tool for the job to always generate a valid DSN, or it may be somewhere else in that code flow.\r\n\r\n(It doesn't appear that this code flow has changed in more recent versions than what's being supplied in my upstream.)\r\n\r\n## Specifications\r\n\r\n  - Version: `1.20.1` (tested via `temporalio/auto-setup:1.20.1`)\r\n  - Platform: GKE Autopilot (password passed via env variable from Kubernetes Secret) using the Postgres plugin/DB provider to connect to Google Cloud SQL (Postgres 13).\r\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM6DtJch","author":{"login":"jaylin-sf"},"authorAssociation":"NONE","body":"I have the same issue with 1.24.2, the databases in PostgreSQL (Azure Flexible Server) have been created successfully. But it failed to build log.Logger for some reason.\r\n\r\nUnable to create server. Error: could not build arguments for function \"go.uber.org/fx\".(*module).constructCustomLogger.func2 (/home/runner/go/pkg/mod/go.uber.org/fx@v1.21.1/module.go:292): failed to build fxevent.Logger: could not build arguments for function \"go.temporal.io/server/temporal\".glob..func8 (/home/runner/work/docker-builds/docker-builds/temporal/temporal/fx.go:1009): failed to build log.Logger: received non-nil error from function \"go.temporal.io/server/temporal\".ServerOptionsProvider (/home/runner/work/docker-builds/docker-builds/temporal/temporal/fx.go:183): sql schema version compatibility check failed: pq: no pg_hba.conf entry for host \"20.227.4.75\", user \"temporal_pg_test\", database \"temporal\", no encryption.\r\n\r\nBTW: I passed in CA file in environment variables with the latest docker image (temporalio/auto-setup):\r\nPOSTGRES_TLS_ENABLED = true\r\nPOSTGRES_TLS_CA_FILE = {path from container volume}\r\n\r\nDB = postgres12","createdAt":"2024-07-04T23:59:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5729#issuecomment-2209650465","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6KZ_4n","author":{"login":"raymondregrello"},"authorAssociation":"NONE","body":"Ran into the issue as well, I believe it'll get fixed by https://github.com/temporalio/helm-charts/pull/551","createdAt":"2024-08-30T17:58:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5729#issuecomment-2322071079","viewerDidAuthor":false}],"createdAt":"2024-04-15T22:15:39Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":5729,"reactionGroups":[],"state":"OPEN","title":"Temporal fails to connect to Google Cloud SQL Postgres when password contains certain characters","updatedAt":"2024-08-30T17:58:31Z","url":"https://github.com/temporalio/temporal/issues/5729"}
