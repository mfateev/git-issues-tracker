{"assignees":[],"author":{"id":"MDQ6VXNlcjEwMTg3MjAz","is_bot":false,"login":"zoulja","name":""},"body":"## Expected Behavior\r\nAccording to https://github.com/jackc/pgx/pull/545 pgx can accept multiple Postgres hosts in the format like 2.2.2.2:1,127.0.0.1,4.2.4.2\r\nI assume that temporal passes this to a driver via POSTGRES_SEEDS env variable\r\n## Actual Behavior\r\nFrom the logs I see that temporal sees string like host1,host2 as a single PG host \"host1,host2\" so fails to connect\r\n```\r\ntemporal              | 2024-04-10T12:13:31.205Z\tERROR\tUnable to connect to SQL database.\t{\"error\": \"dial tcp: lookup temporal-pg-host1,temporal-pg-host2: no such host\", \"logging-call-at\": \"handler.go:52\"}\r\n```\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Get some Postgres cluster in master/replica mode consists of temporal-pg-host1 and temporal-pg-host2 nodes\r\n  2. Modify [docker-compose-postgres.yml](https://github.com/temporalio/docker-compose/blob/main/docker-compose-postgres.yml), comment out postgres container section and set `POSTGRES_SEEDS=temporal-pg-host1,temporal-pg-host2`\r\n  3. Run `docker compose -f docker-compose-postgres.yml up`\r\n\r\n## Specifications\r\n\r\n  - Version: Actual docker composer manifest from the official Github repo\r\n  - Platform: MacOS, Docker Compose version v2.26.1-desktop.1\r\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM598R54","author":{"login":"robholland"},"authorAssociation":"MEMBER","body":"We don't use pgx driver by default. Did you try with `DB=postgres12_pgx`?","createdAt":"2024-05-15T16:12:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5693#issuecomment-2112953976","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6EeJ9_","author":{"login":"zoulja"},"authorAssociation":"NONE","body":"Hello @robholland \r\nSorry for the late response and thanks a lot for this hint - with postgres12_pgx I really can use 2 hosts, like\r\n`POSTGRES_SEEDS: dbhost1,dbhost2`\r\nThe issue is that in this setup app can't detect which one is master and which one is replica, so tries to connect to the first host, and in case of switchover it can be a replica host.\r\nSo I get the following result:\r\n`2024-07-10T20:48:11.640Z    ERROR    Unable to setup SQL schema.    {\"error\": \"ERROR: cannot execute CREATE TABLE in a read-only transaction  (SQLSTATE 25006)\", \"logging-call-at\": \"handler.go:57\"}`\r\n\r\nDo you have any idea how to get around it? \r\nFrom PGX documentation seems it can be (at least partially) achieved via connection string, like:\r\npostgres://username:password@host1:5432,host2:5432,host3:5432/dbname?sslmode=disable&target_session_attrs=read-write&connect_timeout=10\r\n\r\nIs there some way we can pass connection string instead of list of hosts?","createdAt":"2024-07-11T09:46:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5693#issuecomment-2222497663","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6E2acw","author":{"login":"robholland"},"authorAssociation":"MEMBER","body":"We don't currently allow you to set specific connect attributes via env variables. I'm going to be working on the config template soon, I will keep this in mind. You could work around this by overriding the config template that is used. You can see an example of how the connect attributes look in the MySQL transaction isolation support: https://github.com/temporalio/temporal/blob/main/docker/config_template.yaml#L88\r\n\r\nIf you duplicated that for the target_session_attrs setting (assuming that's the one that made the difference), then that will sent to the driver, as it does when you use a URL.","createdAt":"2024-07-15T16:01:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5693#issuecomment-2228856624","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6E2boP","author":{"login":"robholland"},"authorAssociation":"MEMBER","body":"You would also need to adjust the template to cope with multiple hosts in the seeds variable. Despite the name, we unfortunately expect only one hostname in that variable, so we append \":$DB_PORT\" to it, which won't work with multiple host names. Again, given pgx supports multiple hosts, I'll give some thought to how this might look if supported by the template. Please feel free to suggest anything you come up with which feels good for you.","createdAt":"2024-07-15T16:03:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5693#issuecomment-2228861455","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6FJEEa","author":{"login":"zoulja"},"authorAssociation":"NONE","body":"Hello @robholland, thank you very much for looking into this issue!\r\nI'm really not sure what would be the best architectural/design solution in this case, the most simplest way to me would be if POSTGRES_SEEDS could accept the same formats as PGX can (if PGX is in use)   ","createdAt":"2024-07-17T16:43:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/5693#issuecomment-2233745690","viewerDidAuthor":false}],"createdAt":"2024-04-10T12:57:09Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":5693,"reactionGroups":[],"state":"OPEN","title":"Multiple Hosts in connection string are not handled properly (POSTGRES_SEEDS accepts only single host?)","updatedAt":"2024-07-17T16:43:27Z","url":"https://github.com/temporalio/temporal/issues/5693"}
