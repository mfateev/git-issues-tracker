{"assignees":[{"id":"MDQ6VXNlcjE5MjM5OTU=","login":"gow","name":"Chetan Gowda","databaseId":0}],"author":{"id":"MDQ6VXNlcjU2NTY0Njc2","is_bot":false,"login":"joshua-auchincloss","name":"Joshua Auchincloss"},"body":"**Is your feature request related to a problem? Please describe.**\n\nYes, current implementation assumes all postgres data stores have static read-write configurations (i.e. will always be read-write for the lifecycle of the temporal instance). \n\n**Describe the solution you'd like**\n\nAdd support for postgres configurations such that:\n- Nodes may utilize *dynamic* read-only/read-write (HA) postgres servers between multiple instances.\n- Where write transactions are required, fall back to available read-write (master) nodes to mitigate issues with HA compatibility.\n- Default queries only utilize read-only nodes (optional but bonus points if so).\n\n**Describe alternatives you've considered**\n\nNo alternatives, if HA is enabled between multiple postgres servers (e.g temporal does not check `pg_is_in_recovery`), temporal will eventually fail upon (postgres) instance recovery / failover.\n\n**Additional context**\n\nPostgres configured such that:\n- 1 master / read-write instance\n- 1 or more read-only instance(s)\n- Nodes may failover from read-write to read-only (and vice versa) at any point.\n\nHappy to provide docker configurations for reproducible context for the feature request.","closedAt":null,"comments":[{"id":"IC_kwDODNqesM6FARTq","author":{"login":"gow"},"authorAssociation":"MEMBER","body":"Hi @joshua-auchincloss I'm evaluating the feasibility of this feature. This is a very good feature to have. But not sure about the complexity it introduces.\r\nCould you please provide the docker setup so that I can try it out?","createdAt":"2024-07-16T17:21:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6100#issuecomment-2231440618","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6LkAoo","author":{"login":"gow"},"authorAssociation":"MEMBER","body":"Unfortunately the Temporal server application cannot clearly distinguish between purely read-only transactions and read-write transactions. So it's not possible for the server to route the queries appropriately.\r\n","createdAt":"2024-09-10T16:49:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6100#issuecomment-2341472808","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6L3yld","author":{"login":"joshua-auchincloss"},"authorAssociation":"NONE","body":"> Unfortunately the Temporal server application cannot clearly distinguish between purely read-only transactions and read-write transactions. So it's not possible for the server to route the queries appropriately.\n> \n> \n\nHey @gow, thanks for the response - apologies for the delayed response on docker configs, will get to this once there is time to do so.\n\nRegarding distinguishing read-only vs read-write transactions, the client could distinguish at the minimum between writable database hosts at runtime and reroute all queries to that database. Per transaction level is a nice-to-have, but not required. IMO, priority would be the former where all queries are routed to the 'master' write clusters to avoid e.g errors against read-only instances. This approach would be a simple [`select pg_is_in_recovery()`](https://postgresql.org/docs/current/functions-admin.html#FUNCTIONS-RECOVERY-CONTROL)","createdAt":"2024-09-12T15:49:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6100#issuecomment-2346658141","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6Q08C4","author":{"login":"gow"},"authorAssociation":"MEMBER","body":"Hi @joshua-auchincloss looks like the sql connections are all treated as read-write. There is no concept of read-only connections at the moment.\r\nA quick temporary fix for this problem could be that when we initiate a connection, we perform pg_is_in_recovery() check and drop that connection. However, this would not work in 2 cases\r\n1. PG goes into recovery mode after the connection is established.\r\n2. There are no other hosts available to connect and we end up not having any DB connections.\r\n","createdAt":"2024-10-22T16:57:03Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6100#issuecomment-2429796536","viewerDidAuthor":false}],"createdAt":"2024-06-08T17:37:25Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":6100,"reactionGroups":[],"state":"OPEN","title":"fr: add support for multi-az postgres with read-only replication","updatedAt":"2024-10-22T17:34:23Z","url":"https://github.com/temporalio/temporal/issues/6100"}
