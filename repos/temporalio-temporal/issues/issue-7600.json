{"assignees":[],"author":{"id":"MDQ6VXNlcjE4OTgyOTc=","is_bot":false,"login":"ozeranskii","name":"Sergei Ozeranskii"},"body":"## Expected Behavior\n\nStarting a workflow with the following parameters should either succeed or terminate the existing one as specified by the conflict policy:\n- id_reuse_policy: ALLOW_DUPLICATE\n- execution_timeout: 12h\n- id_conflict_policy: TERMINATE_EXISTING\n\n## Actual Behavior\nThe gRPC call start_workflow_execution fails after multiple retries with the following error:\n```\nWARN temporal_client::retry: gRPC call start_workflow_execution retried 7 times error=Status { code: Unavailable, message: \"createOrUpdateCurrentExecution failed. Failed to insert into current_executions table. Error: pq: duplicate key value violates unique constraint \\\"current_executions_pkey\\\"\", metadata: MetadataMap { headers: {\"content-type\": \"application/grpc\"} }, source: None }\n```\n\nThis suggests that a previous workflow with the same ID was not properly cleaned up, possibly due to a failed rollback transaction in Temporal, resulting in data inconsistency in the current_executions table.\n\nManual deletion of the row in the database resolves the issue:\n```sql\nDELETE FROM current_executions WHERE workflow_id = 'problem-id';\n```\n\n## Steps to Reproduce the Problem\nI haven't found a way to reproduce the problem, but the process looks like this:\n1. Attempt to start a workflow with the given parameters (ALLOW_DUPLICATE, TERMINATE_EXISTING, long timeout).\n2. Observe retries and eventual failure with the duplicate key value violates unique constraint error.\n3. Verify that the conflicting workflow ID still exists in current_executions table.\n4. Manually delete the row to allow the new workflow to start successfully.\n\n## Specifications\n\n  - Version: temporalio (python sdk) 1.10.0\n  - Platform: Temporal Version 1.27.1 (PostgreSQL).\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM6mxVXY","author":{"login":"wrbbz"},"authorAssociation":"CONTRIBUTOR","body":"Some additional info:\nIt is impossible to obtain such workflow from UI or CLI\nThe command like:\n```\n$ temporal workflow describe --workflow-id ${workflow_id}\n```\nresults with:\n```\nfailed describing workflow: workflow execution not found for workflow ID \"${workflow_id}\n```\n\nIn UI there is no result of filtering by workflow id","createdAt":"2025-04-11T20:27:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/7600#issuecomment-2797950424","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6nLJss","author":{"login":"dandavison"},"authorAssociation":"MEMBER","body":"Thanks very much for this write-up @ozeranskii and @wrbbz. We're looking into it.","createdAt":"2025-04-15T11:23:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7600#issuecomment-2804718380","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6nLze9","author":{"login":"ozeranskii"},"authorAssociation":"NONE","body":"Hi! Thanks for starting to look into it. By the way, this is not an isolated incident and it happens occasionally. So the problem is more than relevant for us. ","createdAt":"2025-04-15T12:28:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7600#issuecomment-2804889533","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6oCqQR","author":{"login":"yycptt"},"authorAssociation":"MEMBER","body":"Hi @ozeranskii!\n\nCan you help confirm if you only start to see the issue recently with v1.27.x temporal server or it happens with older versions as well?\n\nAlso want to confirm if you have any replication set up for postgresql and if there's any DB failover?\n\nRe. the issue itself, I feel it's either due to \n- An issue in the retention timer logic and it somehow leaves the record in the `current_executions` table undeleted. This is unlikely though, because our logic always deletes from `current_executions` [first](https://github.com/temporalio/temporal/blob/main/service/history/shard/context_impl.go#L1080), before deleting the actual data from `executions`. And the error basically suggests there's no matching record in `executions` table for the runID in `current_executions`.\n- A previous start workflow request failed and also failed to rollback the inserted current record.\n\nDo you see any other failures for the workflowID you are trying to start before the `duplicate key` error? \nIs the run_id in the row you manually deleted from current_execution table a runID you recognize and does it match with a previous completed run? ","createdAt":"2025-04-21T19:00:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7600#issuecomment-2819269649","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6oCsdD","author":{"login":"ozeranskii"},"authorAssociation":"NONE","body":"@yycptt Hi! Previously, before v1.27.x, we did not notice this issue. But our load profile has changed lately and it may occur when using WF quite intensively.\nNo, we don't have a replication DB.\nWe do not notice any other glitches when starting WF.\nIt seems that runID is created uniquely each time.","createdAt":"2025-04-21T19:04:49Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7600#issuecomment-2819278659","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6oGROU","author":{"login":"wrbbz"},"authorAssociation":"CONTRIBUTOR","body":"We have a replication. We are using [Patroni](https://github.com/patroni/patroni) for Postgres replication. However, we do not relay on its failovering and connect our Temporal instance with master directly\nWe tried to use pgBouncer, but there were issues with transaction mode and we switched back to direct connection","createdAt":"2025-04-22T06:37:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7600#issuecomment-2820215700","viewerDidAuthor":false}],"createdAt":"2025-04-11T18:51:11Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":7600,"reactionGroups":[],"state":"OPEN","title":"start_workflow_execution fails with duplicate key error despite TERMINATE_EXISTING policy (possible DB inconsistency)","updatedAt":"2025-04-22T06:37:09Z","url":"https://github.com/temporalio/temporal/issues/7600"}
