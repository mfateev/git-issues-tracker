{"assignees":[],"author":{"id":"MDQ6VXNlcjc3MzI2MDk=","is_bot":false,"login":"sahilvv","name":"Sahil Vazirani"},"body":"## Expected Behavior\r\n- Ability to feed separate certificates for clients (eg: matching client, history client) and their respective server certificates for each service\r\n- Ability to feed different server names for each component (Frontend, matching, history)\r\n## Actual Behavior\r\n- Assumption in code to use single certificate for dual purpose. This puts a security risk with how mTLS is implemented. Based on discussions with temporal team it seems like self-signed certs were used during implementation of this feature causing this to fail.\r\n- Another assumption in code to use same server name in SAN for all services (frontend, matching, history). This presents weak security as 1 microservice can impersonate another. \r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Create a server certificate with the following in the certificate:\r\n           X509v3 Extended Key Usage:\r\n                TLS Web Server Authentication\r\n  2. Use the cert/key pair in the TLS/internode section and bring up FE, Matching, History, Worker service\r\n  3. Use tctl to query get-search-attributes\r\n```\r\n       Error: Unable to get search attributes.\r\nError Details: rpc error: code = Unavailable desc = unable to get temporal-sys-add-search-attributes-workflow workflow state: context deadline exceeded\r\n('export TEMPORAL_CLI_SHOW_STACKS=1' to see stack traces)\r\n```\r\n\r\nIf the above steps are repeated with a client certificate containing the following:\r\n           X509v3 Extended Key Usage:\r\n                TLS Web Client Authentication\r\nError observed:\r\n`{\"level\":\"error\",\"ts\":\"2022-04-01T01:15:45.045Z\",\"msg\":\"matching client encountered error\",\"service\":\"history\",\"error\":\"last connection error: connection error: desc = \\\"transport: authentication handshake failed: x509: certificate specifies an incompatible key usage\\\"\",\"service-error-type\":\"serviceerror.Unavailable\",\"logging-call-at\":\"metricClient.go:259\",\"stacktrace\":\"...\"}\r\n`\r\n## Specifications\r\n\r\n  - Version: 1.15.0\r\n  - Platform: Linux\r\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM5Avm5O","author":{"login":"sahilvv"},"authorAssociation":"NONE","body":"@sergeybykov FYI","createdAt":"2022-04-01T18:46:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2698#issuecomment-1086221902","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5Av5SF","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"Thank you, @sahilvv, for opening this and for your help with narrowing down the problem!","createdAt":"2022-04-01T20:29:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2698#issuecomment-1086297221","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5BmU3v","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"[ClientTLS](https://github.com/temporalio/temporal/blob/67e34a34209c278dc22312629c42f1363d59c79f/common/config/config.go#L173-L177)\r\n\r\nNeed to add CertFile/CertData and KeyFile/KeyData to ClientTLS. ","createdAt":"2022-04-16T04:25:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2698#issuecomment-1100565999","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5BmZts","author":{"login":"jbreiding"},"authorAssociation":"CONTRIBUTOR","body":"I believe I understand the core issue here, we should be able to use certs which are restricted by key usage for their purpose.\r\n\r\nThis should be simple to reproduce given correctly generated certs.\r\n\r\nThe issue with the SAN will remain because of how internode connections are made and the TLS configuration available.\r\n\r\nFor something more strict a service mesh side car is going to be the recommended path to achieve a strict network policy like being described here.","createdAt":"2022-04-16T06:27:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2698#issuecomment-1100585836","viewerDidAuthor":false}],"createdAt":"2022-04-01T18:45:23Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":2698,"reactionGroups":[],"state":"OPEN","title":"Internode TLS certificates dual used as both client and server certificates","updatedAt":"2023-03-03T20:20:05Z","url":"https://github.com/temporalio/temporal/issues/2698"}
