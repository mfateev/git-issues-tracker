{"assignees":[],"author":{"id":"MDQ6VXNlcjgzMTA1NDg=","is_bot":false,"login":"javiercanillas","name":"Javier Canillas"},"body":"**Is your feature request related to a problem? Please describe.**\r\nI’m testing a helm deployment using a postgresql instance as persistance (schema I used: [temporal/schema.sql at master · temporalio/temporal · GitHub 1](https://github.com/temporalio/temporal/blob/master/schema/postgresql/v96/temporal/schema.sql)).\r\n\r\nDoing some analysis on stress testing results, I came across heavy load over the table history_node.\r\nThe queries with lots of executions and heavy IO were:\r\n\r\nINSERT INTO history_node (shard_id, tree_id, branch_id, node_id, prev_txn_id, txn_id, data, data_encoding) VALUES (?) ON CONFLICT (shard_id, tree_id, branch_id, node_id, txn_id) DO UPDATE SET prev_txn_id=$9, data=$10, data_encoding=$11\r\nDELETE FROM history_node WHERE shard_id = $1 AND tree_id = $2 AND branch_id = $3 AND node_id >= $4\r\nSELECT node_id, prev_txn_id, txn_id, data, data_encoding FROM history_node WHERE shard_id = $1 AND tree_id = $2 AND branch_id = $3 AND ((node_id = $4 AND txn_id > $5) OR node_id > $6) AND node_id < $7 ORDER BY shard_id, tree_id, branch_id, node_id, txn_id LIMIT $8\r\n\r\n**Describe the solution you'd like**\r\nFrom my simple logic, creating an index with the corresponding values (shard_id, three_id, branch_id, node_id and txn_id) can help to get rid some of the inconvenience, but it will add some little pressure over the inserts.\r\n\r\n**Describe alternatives you've considered**\r\n- Maybe partitioning those tables based on shard_id, but it requires manual effort to configure and keep sync with the `numShards` config attribute.\r\n\r\n","closedAt":"2022-08-16T18:17:17Z","comments":[{"id":"IC_kwDODNqesM5IVSSh","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"What do you mean by shard those table on shard_id? MySQL is not sharded. There is other cloud based SQL like vitess that provide sharded MySQL and you can specify shard_id as their sharding key.","createdAt":"2022-08-12T21:39:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3222#issuecomment-1213539489","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5IVV-j","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"The index you proposed is already the primary key.\r\nPRIMARY KEY (shard_id, tree_id, branch_id, node_id, txn_id)","createdAt":"2022-08-12T22:09:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3222#issuecomment-1213554595","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5IicOa","author":{"login":"javiercanillas"},"authorAssociation":"NONE","body":"> The index you proposed is already the primary key. PRIMARY KEY (shard_id, tree_id, branch_id, node_id, txn_id)\r\n\r\nTrue, My bad.","createdAt":"2022-08-16T18:17:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3222#issuecomment-1216988058","viewerDidAuthor":false}],"createdAt":"2022-08-12T13:05:09Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":3222,"reactionGroups":[],"state":"CLOSED","title":"SQL indexes improvement","updatedAt":"2022-08-16T18:17:17Z","url":"https://github.com/temporalio/temporal/issues/3222"}
