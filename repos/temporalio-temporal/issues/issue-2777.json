{"assignees":[],"author":{"id":"MDQ6VXNlcjM3NzA0Nzg=","is_bot":false,"login":"yux0","name":"Yu Xia"},"body":"## Expected Behavior\r\nNo error\r\n\r\n## Actual Behavior\r\nUnexpected panic\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n`go test -race -testify.m ^TestShardControllerClosed$ 1000`\r\n\r\n## Specifications\r\n\r\nFound in build test: https://buildkite.com/temporal/temporal-public/builds/3488#e9fe11ad-9cd3-47dc-a810-4cd68646063a\r\n\r\nI am not 100% if this is test issue or actual code bug. We need to investigate.\r\n","closedAt":"2022-05-21T02:12:29Z","comments":[{"id":"IC_kwDODNqesM5CT3Ko","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"It looks like the race is between `s.state = contextStateStopped` and something in gomock that's trying to print the value of an object. So this seems like a test/mock artifact. The shard context explicitly calls `s.engineFactory.createEngine` outside of the rwlock, but there's no reason that should touch `s.state` directly.","createdAt":"2022-04-28T17:57:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2777#issuecomment-1112502952","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5CT903","author":{"login":"yux0"},"authorAssociation":"MEMBER","body":"I tried comment out an unlock/lock logic and seems like no error after that. Do you know what use case we are optimized to have the unlock/lock?\r\n\r\n```\r\nif !s.engineFuture.Ready() {\r\n\t\t\t//s.wUnlock()\r\n\t\t\ts.maybeRecordShardAcquisitionLatency(ownershipChanged)\r\n\t\t\tengine := s.createEngine()\r\n\t\t\t//s.wLock()\r\n\t\t\tif s.state >= contextStateStopping {\r\n\t\t\t\tengine.Stop()\r\n\t\t\t\ts.engineFuture.Set(nil, errStoppingContext)\r\n\t\t\t\treturn errStoppingContext\r\n\t\t\t}\r\n\t\t\ts.engineFuture.Set(engine, nil)\r\n\t\t}\r\n```","createdAt":"2022-04-28T18:28:44Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2777#issuecomment-1112530231","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5CT_1_","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"Does the actual service work or only tests? I believe some of the things that get created as part of the history engine call back into the shard. E.g. `newTransferQueueProcessor` calls `shard.GetQueueAckLevel` which needs to rlock. It may be possible to make it work that way but it seems like a larger change. `createEngine` has been outside the shard context lock since before I refactored this part, so it's not new.","createdAt":"2022-04-28T18:38:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/2777#issuecomment-1112538495","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5CUGL9","author":{"login":"yux0"},"authorAssociation":"MEMBER","body":"I only run the test not test the service.","createdAt":"2022-04-28T19:11:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2777#issuecomment-1112564477","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5Dj_tx","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"fixed by #2879 ","createdAt":"2022-05-21T02:12:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2777#issuecomment-1133509489","viewerDidAuthor":false}],"createdAt":"2022-04-28T16:48:14Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":2777,"reactionGroups":[],"state":"CLOSED","title":"Race condition on shard state transition ","updatedAt":"2022-05-21T02:12:29Z","url":"https://github.com/temporalio/temporal/issues/2777"}
