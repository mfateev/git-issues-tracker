{"assignees":[],"author":{"id":"MDQ6VXNlcjM5NDE0MDE=","is_bot":false,"login":"thomas-maurice","name":"Thomas Maurice"},"body":"## Expected Behavior\r\n\r\nHello! I'm trying to setup a data converter that encrypts and decrypts data to and from chacha20poly1305. However the worker seems to fail to deserialise the data after it has been decrypted.\r\n\r\nI can check the payloads sent to the worker in the UI (i.e. decode them from there) as well as send them from the tempral client without any issues, similarly when the worker tries to decode the data I see the function below returning the decoded protobuf properly\r\n\r\nThis seems to come from upper layers of the temporal stack\r\n\r\n## Actual Behavior\r\nThe worker crashes with\r\n```\r\ncoroutine root [panic]:\r\ngo.temporal.io/sdk/converter.(*CodecDataConverter).FromPayloads(0xc0003ef080, 0xc00055c198?, {0xc0005b3a20, 0x1, 0x1})\r\n\t/home/thomas/go/pkg/mod/go.temporal.io/sdk@v1.29.1/converter/codec.go:228 +0xb0\r\ngo.temporal.io/sdk/internal.decodeArgsToRawValues({0xf6e0e8, 0xc0003ef080}, {0xf7aa58, 0xcc85c0}, 0xc0007db800)\r\n\t/home/thomas/go/pkg/mod/go.temporal.io/sdk@v1.29.1/internal/encode_args.go:83 +0x1f9\r\ngo.temporal.io/sdk/internal.(*workflowExecutor).Execute(0xc0004d8080, {0xf6bab8, 0xc000487920}, 0xc0007db800)\r\n\t/home/thomas/go/pkg/mod/go.temporal.io/sdk@v1.29.1/internal/internal_worker.go:845 +0x112\r\ngo.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func1({0xf6b6b8, 0xc000615710})\r\n\t/home/thomas/go/pkg/mod/go.temporal.io/sdk@v1.29.1/internal/internal_workflow.go:571 +0xc6\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nThis the code for the converter\r\n\r\n```golang\r\npackage dataconverter\r\n\r\nimport (\r\n\t\"bytes\"\r\n\t\"crypto/rand\"\r\n\t\"fmt\"\r\n\r\n\tcommonpb \"go.temporal.io/api/common/v1\"\r\n\t\"go.temporal.io/sdk/converter\"\r\n\t\"golang.org/x/crypto/chacha20poly1305\"\r\n)\r\n\r\nconst (\r\n\tchaChaEncodingName = \"encrypted/chacha20poly1305\"\r\n)\r\n\r\nvar ChaCha20poly1305DataConverter = NewDataConverter(converter.GetDefaultDataConverter())\r\n\r\nfunc NewChaCha20poly1305DataConverter(underlying converter.DataConverter, key []byte) converter.DataConverter {\r\n\treturn converter.NewCodecDataConverter(underlying, NewChaCha20poly1305PayloadCodec(key))\r\n}\r\n\r\nfunc NewChaCha20poly1305PayloadCodec(key []byte) converter.PayloadCodec {\r\n\tif len(key) != chacha20poly1305.KeySize {\r\n\t\tpanic(\"invalid key length, needs to be 32 bytes\")\r\n\t}\r\n\treturn &ChaCha20poly1305Codec{\r\n\t\tkey: key,\r\n\t}\r\n}\r\n\r\ntype ChaCha20poly1305Codec struct {\r\n\tkey []byte\r\n}\r\n\r\nfunc (e *ChaCha20poly1305Codec) Encode(payloads []*commonpb.Payload) ([]*commonpb.Payload, error) {\r\n\tresult := make([]*commonpb.Payload, len(payloads))\r\n\tfmt.Println(\"encode\")\r\n\tfor i, p := range payloads {\r\n\t\tvar err error\r\n\r\n\t\torigBytes, err := p.Marshal()\r\n\t\tif err != nil {\r\n\t\t\treturn payloads, err\r\n\t\t}\r\n\r\n\t\tcipher, err := chacha20poly1305.NewX(e.key)\r\n\t\tif err != nil {\r\n\t\t\treturn nil, err\r\n\t\t}\r\n\r\n\t\tnonce := make([]byte, chacha20poly1305.NonceSizeX)\r\n\t\t_, err = rand.Read(nonce)\r\n\r\n\t\tb := cipher.Seal(nil, nonce, origBytes, nil)\r\n\r\n\t\toutBuf := bytes.NewBuffer(nil)\r\n\t\toutBuf.Write(nonce)\r\n\t\toutBuf.Write(b)\r\n\r\n\t\tresult[i] = &commonpb.Payload{\r\n\t\t\tMetadata: map[string][]byte{converter.MetadataEncoding: []byte(chaChaEncodingName)},\r\n\t\t\tData:     outBuf.Bytes(),\r\n\t\t}\r\n\t}\r\n\r\n\treturn result, nil\r\n}\r\n\r\nfunc (e *ChaCha20poly1305Codec) Decode(payloads []*commonpb.Payload) ([]*commonpb.Payload, error) {\r\n\tresult := make([]*commonpb.Payload, len(payloads))\r\n\tfmt.Println(\"decode\")\r\n\tfor i, p := range payloads {\r\n\t\tif string(p.Metadata[converter.MetadataEncoding]) != chaChaEncodingName {\r\n\t\t\tresult[i] = p\r\n\t\t\tcontinue\r\n\t\t}\r\n\r\n\t\tcipher, err := chacha20poly1305.NewX(e.key)\r\n\t\tif err != nil {\r\n\t\t\treturn nil, err\r\n\t\t}\r\n\r\n\t\tnonce := p.Data[:chacha20poly1305.NonceSizeX]\r\n\r\n\t\tdata := p.Data[chacha20poly1305.NonceSizeX:]\r\n\r\n\t\tb, err := cipher.Open(nil, nonce, data, nil)\r\n\t\tif err != nil {\r\n\t\t\treturn nil, err\r\n\t\t}\r\n\r\n\t\tresult[i] = &commonpb.Payload{}\r\n\t\terr = result[i].Unmarshal(b)\r\n\t\tif err != nil {\r\n\t\t\treturn payloads, err\r\n\t\t}\r\n\t}\r\n\tfmt.Println(\"ok\")\r\n\treturn result, nil\r\n}\r\n\r\n```\r\n## Specifications\r\n\r\n  - Version: 1.25.1\r\n  - Platform: linux\r\n","closedAt":"2024-10-16T06:40:28Z","comments":[{"id":"IC_kwDODNqesM6P_zqK","author":{"login":"thomas-maurice"},"authorAssociation":"NONE","body":"My bad, the panic is caused by not using a `converter.GetDefaultDataConverter()` as the underlying converter in my worker, apologies for the noise","createdAt":"2024-10-16T06:40:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6661#issuecomment-2415868554","viewerDidAuthor":false}],"createdAt":"2024-10-15T17:34:11Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":6661,"reactionGroups":[],"state":"CLOSED","title":"Panic when worker tries to deserialize data from data converter","updatedAt":"2024-10-16T06:40:28Z","url":"https://github.com/temporalio/temporal/issues/6661"}
