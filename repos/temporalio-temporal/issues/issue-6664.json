{"assignees":[],"author":{"id":"MDQ6VXNlcjczMDMwMDg=","is_bot":false,"login":"TheGeniesis","name":""},"body":"## Expected Behavior\r\n\r\nI can execute CRUD commands with admin and non admin x-search-attributes without errors.\r\n\r\n## Actual Behavior\r\n\r\nI have `devl:admin` and `temporal-system:admin` roles assigned. I use only sql, postgres12 driver for \"default\" and \"visibility\" dbs.\r\n\r\nWhen I execute one of x-search-attributes command inside admintools pod it fails with error:\r\n> I use `devl` namespace as an example of not working scenario\r\n\r\n```\r\ntctl --namespace=devl admin cluster get-search-attributes\r\nError: Unable to get search attributes.\r\nError Details: rpc error: code = PermissionDenied desc = Request unauthorized.\r\n```\r\n\r\nWhen I run this command with not existing namespace I get different error: \r\n```\r\nError Details: rpc error: code = NotFound desc = Namespace searchtest2 is not found.\r\n```\r\n\r\nCluster is working:\r\n```\r\ntctl cluster health\r\ntemporal.api.workflowservice.v1.WorkflowService: SERVING\r\n```\r\n\r\nI tested other admin commands (provided auth token as an env variable) related to cluster info (`tctl --namespace=devl admin cluster describe`, `tctl --namespace=devl admin cluster list` ), namespaces (`tctl --namespace=devl namespace list`, `tctl --namespace=devl namespace describe`), etc. and they are working. Only search-attributes has this problem. Non-admin command (`tctl --namespace=devl cluster get-search-attributes`) works as expected. ~Unfortunately only admin command allows to add attributes.~ \r\nUpdate: The newest Temporal version allows to add new search attributes, admin commands are marked as deprecated.\r\n\r\nLog from frontend pod:\r\n```\r\n {\"level\":\"error\",\"ts\":\"2024-10-15T13:59:29.365Z\",\"msg\":\"service failures\",\"operation\":\"AdminGetSearchAttributes\",\"wf-namespace\":\"devl\",\"error\":\"Unable to get namespace devl info with error: Request unauthorized.\",\"logging-call-at\":\"telemetry.go:411\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/log/zap_logger.go:156\\ngo.temporal.io/server/common/rpc/interceptor.(*TelemetryInterceptor).handleError\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/telemetry.go:411\\ngo.temporal.io/server/common/rpc/interceptor.(*TelemetryInterceptor).UnaryIntercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/telemetry.go:202\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.63.2/server.go:1186\\ngo.temporal.io/server/service/frontend.(*RedirectionInterceptor).Intercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/service/frontend/redirection_interceptor.go:187\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.63.2/server.go:1186\\ngo.temporal.io/server/common/authorization.(*Interceptor).Intercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/authorization/interceptor.go:181\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.63.2/server.go:1186\\ngo.temporal.io/server/service/frontend.GrpcServerOptionsProvider.NewServerMetricsContextInjectorInterceptor.func2\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/metrics/grpc.go:66\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.63.2/server.go:1186\\ngo.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc.UnaryServerInterceptor.func1\\n\\t/home/runner/go/pkg/mod/go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc@v0.51.0/interceptor.go:315\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.63.2/server.go:1186\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceLogInterceptor).Intercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/namespace_logger.go:85\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.63.2/server.go:1186\\ngo.temporal.io/server/common/rpc/interceptor.(*NamespaceValidatorInterceptor).NamespaceValidateIntercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/namespace_validator.go:135\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.63.2/server.go:1186\\ngo.temporal.io/server/common/utf8validator.(*Validator).Intercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/utf8validator/validate.go:182\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.63.2/server.go:1186\\ngo.temporal.io/server/service/frontend.GrpcServerOptionsProvider.NewServiceErrorInterceptor.func1\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/grpc.go:178\\ngoogle.golang.org/grpc.NewServer.chainUnaryServerInterceptors.chainUnaryInterceptors.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.63.2/server.go:1177\\ngo.temporal.io/server/api/adminservice/v1._AdminService_GetSearchAttributes_Handler\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/api/adminservice/v1/service_grpc.pb.go:1062\\ngoogle.golang.org/grpc.(*Server).processUnaryRPC\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.63.2/server.go:1369\\ngoogle.golang.org/grpc.(*Server).handleStream\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.63.2/server.go:1780\\ngoogle.golang.org/grpc.(*Server).serveStreams.func2.1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.63.2/server.go:1019\"}\r\n ```\r\n\r\nStacktrace from command:\r\n```\r\nError: Unable to get search attributes.\r\nError Details: rpc error: code = Unavailable desc = Unable to get namespace devl info with error: Request unauthorized.\r\nStack trace:\r\ngoroutine 1 [running]:\r\nruntime/debug.Stack()\r\n\t/opt/hostedtoolcache/go/1.21.11/x64/src/runtime/debug/stack.go:24 +0x5e\r\nruntime/debug.PrintStack()\r\n\t/opt/hostedtoolcache/go/1.21.11/x64/src/runtime/debug/stack.go:16 +0x13\r\ngithub.com/temporalio/tctl/cli_curr.printError({0x1990e48, 0x20}, {0x1dd3940, 0xc00051c000})\r\n\t/home/runner/work/docker-builds/docker-builds/tctl/cli_curr/util.go:393 +0x218\r\ngithub.com/temporalio/tctl/cli_curr.ErrorAndExit({0x1990e48?, 0x1dfaf50?}, {0x1dd3940?, 0xc00051c000?})\r\n\t/home/runner/work/docker-builds/docker-builds/tctl/cli_curr/util.go:404 +0x25\r\ngithub.com/temporalio/tctl/cli_curr.AdminGetSearchAttributes(0xc0005371e0)\r\n\t/home/runner/work/docker-builds/docker-builds/tctl/cli_curr/admin_cluster_search_attributes_commands.go:157 +0x89\r\ngithub.com/temporalio/tctl/cli_curr.newAdminClusterCommands.func3(0xc0005371e0?)\r\n\t/home/runner/work/docker-builds/docker-builds/tctl/cli_curr/admin.go:496 +0x13\r\ngithub.com/urfave/cli.HandleAction({0x16a4dc0?, 0x1a3db98?}, 0x15?)\r\n\t/home/runner/go/pkg/mod/github.com/urfave/cli@v1.22.10/app.go:526 +0x75\r\ngithub.com/urfave/cli.Command.Run({{0x1978c96, 0x15}, {0x0, 0x0}, {0xc0006cb080, 0x1, 0x1}, {0x198e717, 0x1f}, {0x0, ...}, ...}, ...)\r\n\t/home/runner/go/pkg/mod/github.com/urfave/cli@v1.22.10/command.go:173 +0x63e\r\ngithub.com/urfave/cli.(*App).RunAsSubcommand(0xc000239880, 0xc000536f20)\r\n\t/home/runner/go/pkg/mod/github.com/urfave/cli@v1.22.10/app.go:405 +0xe07\r\ngithub.com/urfave/cli.Command.startApp({{0x195d3e0, 0x7}, {0x0, 0x0}, {0xc0006cb220, 0x1, 0x1}, {0x198c21d, 0x1e}, {0x0, ...}, ...}, ...)\r\n\t/home/runner/go/pkg/mod/github.com/urfave/cli@v1.22.10/command.go:378 +0xb58\r\ngithub.com/urfave/cli.Command.Run({{0x195d3e0, 0x7}, {0x0, 0x0}, {0xc0006cb220, 0x1, 0x1}, {0x198c21d, 0x1e}, {0x0, ...}, ...}, ...)\r\n\t/home/runner/go/pkg/mod/github.com/urfave/cli@v1.22.10/command.go:102 +0x7e5\r\ngithub.com/urfave/cli.(*App).RunAsSubcommand(0xc0002396c0, 0xc000536dc0)\r\n\t/home/runner/go/pkg/mod/github.com/urfave/cli@v1.22.10/app.go:405 +0xe07\r\ngithub.com/urfave/cli.Command.startApp({{0x19598b4, 0x5}, {0x0, 0x0}, {0xc0006cb1d0, 0x1, 0x1}, {0x1974c0a, 0x13}, {0x0, ...}, ...}, ...)\r\n\t/home/runner/go/pkg/mod/github.com/urfave/cli@v1.22.10/command.go:378 +0xb58\r\ngithub.com/urfave/cli.Command.Run({{0x19598b4, 0x5}, {0x0, 0x0}, {0xc0006cb1d0, 0x1, 0x1}, {0x1974c0a, 0x13}, {0x0, ...}, ...}, ...)\r\n\t/home/runner/go/pkg/mod/github.com/urfave/cli@v1.22.10/command.go:102 +0x7e5\r\ngithub.com/urfave/cli.(*App).Run(0xc000239340, {0xc00003e0a0, 0x5, 0x5})\r\n\t/home/runner/go/pkg/mod/github.com/urfave/cli@v1.22.10/app.go:277 +0xb27\r\nmain.main()\r\n\t/home/runner/work/docker-builds/docker-builds/tctl/cmd/tctl/main.go:47 +0xa5\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Deploy temporal on AKS cluster using modified chart\r\n  1. Create proper groups, users and service principals (I followed [medium article](https://phongthaicao.medium.com/temporal-authentication-and-authorization-using-azure-ad-f940646b61e0) with small tweaks, since it wasn't 100% up-to-date)\r\n  1. Login into admintools pod\r\n  1. Create a new namespace using UI session `temporal operator namespace create --namespace <namespace> --grpc-meta=Authorization='Bearer <token_from_ui>'` (works)\r\n  1. Run any of admin x-search-attributes command  `tctl --namespace=devl cluster get-search-attributes --auth='Bearer <token_from_ui>'` or `temporal operator search-attribute create --name email --type Keyword --grpc-meta=Authorization='Bearer <token_from_ui>'`\r\n\r\n## Specifications\r\n\r\n  - Version: 1.24.2 - after upgrade to 1.25.1 problem still exists\r\n  - Chart version: 0.44.0 ([modified](https://github.com/temporalio/helm-charts/pull/571#issuecomment-2415945554) to enable internal frontend and oAuth) - after upgrade to 0.50.0 problem still exists\r\n\r\n## Question\r\n\r\n~Do I miss something related to role assignment? I searched frontend, admintools and worker logs, but I couldn't find anything which might help me to debug this problem.~\r\n\r\nUpdate: See my comments below. Looks like a bug. Claims are not passed for DescribeNamespace and UpdateNamespace endpoints which are executed by *SearchAttributesSQL functions. This is the source of the error.\r\n\r\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM6QMtYd","author":{"login":"TheGeniesis"},"authorAssociation":"NONE","body":"I did one more test - I enabled ES (changed flag `elasticsearch.enabled: true` in a chart and the feature works.\r\n\r\nI checked [Temporal documentation](https://docs.temporal.io/visibility#custom-search-attributes) and I shouldn't have any problems with using search attributes without ES.\r\n\r\n> If you use Elasticsearch as your Visibility store, your custom Search Attributes apply globally and can be used across Namespaces. However, if using any of the [supported SQL databases](https://docs.temporal.io/self-hosted-guide/visibility) with Temporal Server v1.20 and later, your custom Search Attributes are associated with a specific Namespace and can be used for Workflow Executions in that Namespace.\r\n\r\nI just wonder if this is the reason of the problem. For PSQL it should be namespace specific, but command was created for admin.\r\n\r\nI also checked UI and `https://<host>/api/v1/namespaces/devl/search-attributes?` returns 503 in the UI when PSQL is enabled (no problem with ES).","createdAt":"2024-10-17T11:19:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6664#issuecomment-2419250717","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6QqPuV","author":{"login":"TheGeniesis"},"authorAssociation":"NONE","body":"For 503 error I added additional logs into the code and found that claims are not send for DescribeNamespace:\r\n\r\nChanges in default_authorizer.go\r\n```go\r\nfunc (a *defaultAuthorizer) Authorize(_ context.Context, claims *Claims, target *CallTarget) (Result, error) {\r\n\t// APIs that are essentially read-only health checks with no sensitive information are\r\n\t// always allowed\r\n\tif IsHealthCheckAPI(target.APIName) {\r\n\t\treturn resultAllow, nil\r\n\t}\r\n\tfmt.Println(\"Check claims for \", target.APIName)\r\n\tdbg2(claims)\r\n\tif claims == nil {\r\n\t\treturn resultDeny, nil\r\n\t}\r\n\tmetadata := api.GetMethodMetadata(target.APIName)\r\n\tfmt.Println(\"API nAME\", target.APIName)\r\n```\r\n\r\nLogs from frontend service:\r\n```\r\nCheck claims for  /temporal.api.operatorservice.v1.OperatorService/ListSearchAttributes\r\n{\"Subject\":\"DmXTqIs843B3i6f-AnAcr2cakEpztzAmMrCuG-d8DXM\",\"System\":9,\"Namespaces\":{\"devl\":9,\"intg\":9,\"uacc\":9},\"Extensions\":null}\r\nAPI nAME /temporal.api.operatorservice.v1.OperatorService/ListSearchAttributes\r\nhasRole 9\r\n\r\nCheck claims for  /temporal.api.workflowservice.v1.WorkflowService/DescribeNamespace\r\nnull\r\n```\r\n\r\nIn docker-builds/temporal/service/frontend/admin_handler.go I see function `getSearchAttributesSQL` which executes the `DescribeNamespace` function.\r\n\r\nIs there any easy way to add claims to the function execution?\r\n\r\nEdit:\r\n\r\nTo confirm I added a condition to bypass claims check for `DescribeNamespace` endpoint and UI started working.\r\n```go\r\nif (strings.Contains(target.APIName, \"DescribeNamespace\")) {\r\n  return resultAllow, nil\r\n}\r\n```\r\n\r\nEdit 2:\r\nAfter upgrade to the newest version I see commands to add search-attributes on operator level. I added the same bypass for `UpdateNamespace` and executed command - it works.","createdAt":"2024-10-21T15:20:30Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6664#issuecomment-2426993557","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6SFqEy","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Thanks for the report. While these admin APIs are deprecated and so is `tctl` there may still be an actual issue here and we'll look into it.","createdAt":"2024-10-31T22:31:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6664#issuecomment-2450956594","viewerDidAuthor":false},{"id":"IC_kwDODNqesM7S92bK","author":{"login":"underrun"},"authorAssociation":"CONTRIBUTOR","body":"This is still an issue - also it's got nothing to do with deprecated admin apis or tctl.\n\nThe place i noticed this is in the web ui when i hit a namespace endpoint at a path like `/namespaces/hello-world`\n\nThe behavior is that the top half of the page renders but i get nothing under search attributes and a little 503 toast pops up at the bottom - which happens because ListSearchAttributesSQL performs an additional client call to frontend itself to DescribeNamespace but this client call can only use the level of auth allowed by the frontend's own claims.\n\nThis can for sure be worked around by allowing whatever auth's frontend to frontend to be allowed to describe a namespace even if that identity hasn't been granted specific access to that namespace, but this shouldn't really be necessary.\n\nthere's an obvious amount of access that the server has to have to do stuff to whatever is running in the server, but it would still be nice to be able to only allow those actions that are necessary.\n\nthe workaround i've taken is to make namespaced api calls for identities whose claims don't have that namespace as part of the claim only be authorized if their system roles include both Admin and whatever the other role that's required (for describe it'd be Read).\n\nbut the issue with that is that it also means any users with system role of admin can do more than what I would really like for them to do. i could maybe special case things that are identified as temporal server specifically but i'd rather keep my auth based on roles rather than specific identities for reasons...\n\nso this isn't a \"big deal\" but it make my authorizer logic more complex than it needs to be and makes it a little difficult to separate users who are admins and temporal server service workloads from each other.","createdAt":"2025-11-16T22:30:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6664#issuecomment-3539429066","viewerDidAuthor":false}],"createdAt":"2024-10-16T10:06:18Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":6664,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"OPEN","title":"Request unauthorized for SQL search-attributes (claims are not passed)","updatedAt":"2025-11-16T22:30:39Z","url":"https://github.com/temporalio/temporal/issues/6664"}
