{"assignees":[{"id":"MDQ6VXNlcjQ2NjcyMw==","login":"dnr","name":"David Reiss","databaseId":0},{"id":"MDQ6VXNlcjIyMzI1MjQ=","login":"alexshtin","name":"Alex Shtin","databaseId":0}],"author":{"id":"MDQ6VXNlcjY3NjQ5NTc=","is_bot":false,"login":"swyxio","name":"swyx.io"},"body":"For those running the latest docker-compose, i am leaving a search trail for you to find this error, because this error is a very opaque one and what really happened is a segfault during bootstrap of docker compose.\r\n\r\n## Expected Behavior\r\n\r\ndocker compose should work as expected\r\n\r\n## Actual Behavior\r\n\r\nYou see this when you try to access Temporal Web\r\n\r\n```\r\ntemporal-web            | [2021-11-01T04:45:09.772Z] OperationalError: 14 UNAVAILABLE: DNS resolution failed\r\ntemporal-web            |     at Object.exports.createStatusError (/usr/app/node_modules/grpc/src/common.js:91:15)\r\ntemporal-web            |     at Object.onReceiveStatus (/usr/app/node_modules/grpc/src/client_interceptors.js:1209:28)\r\ntemporal-web            |     at InterceptingListener._callNext (/usr/app/node_modules/grpc/src/client_interceptors.js:568:42)\r\ntemporal-web            |     at InterceptingListener.onReceiveStatus (/usr/app/node_modules/grpc/src/client_interceptors.js:618:8)\r\ntemporal-web            |     at callback (/usr/app/node_modules/grpc/src/client_interceptors.js:847:24) {\r\ntemporal-web            |   cause: Error: 14 UNAVAILABLE: DNS resolution failed\r\ntemporal-web            |       at Object.exports.createStatusError (/usr/app/node_modules/grpc/src/common.js:91:15)\r\ntemporal-web            |       at Object.onReceiveStatus (/usr/app/node_modules/grpc/src/client_interceptors.js:1209:28)\r\ntemporal-web            |       at InterceptingListener._callNext (/usr/app/node_modules/grpc/src/client_interceptors.js:568:42)\r\ntemporal-web            |       at InterceptingListener.onReceiveStatus (/usr/app/node_modules/grpc/src/client_interceptors.js:618:8)\r\ntemporal-web            |       at callback (/usr/app/node_modules/grpc/src/client_interceptors.js:847:24) {\r\ntemporal-web            |     code: 14,\r\ntemporal-web            |     metadata: Metadata { _internal_repr: {}, flags: 0 },\r\ntemporal-web            |     details: 'DNS resolution failed'\r\ntemporal-web            |   },\r\ntemporal-web            |   isOperational: true,\r\ntemporal-web            |   code: 14,\r\ntemporal-web            |   metadata: Metadata { _internal_repr: {}, flags: 0 },\r\ntemporal-web            |   details: 'DNS resolution failed'\r\ntemporal-web            | }\r\n```\r\n\r\nThe real cause is higher up in the logs:\r\n\r\n```\r\nemporal                | PostgreSQL started.\r\ntemporal                | Setup PostgreSQL schema.\r\ntemporal                | + SCHEMA_DIR=/etc/temporal/schema/postgresql/v96/temporal/versioned\r\ntemporal                | + '[' temporal '!=' temporal ']'\r\ntemporal                | + temporal-sql-tool --plugin postgres --ep postgresql -u temporal -p 5432 --db temporal setup-schema -v 0.0\r\ntemporal                | qemu: uncaught target signal 11 (Segmentation fault) - core dumped\r\ntemporal                | ./auto-setup.sh: line 173:    27 Segmentation fault      temporal-sql-tool --plugin postgres --ep \"${POSTGRES_SEEDS}\" -u \"${POSTGRES_USER}\" -p \"${DB_PORT}\" --db \"${DBNAME}\" setup-schema -v 0.0\r\n``` \r\n\r\ni sometimes also see this `relation \"schema_version\" already exists` error on subsequent runs:\r\n\r\n```\r\ntemporal-postgresql     | ERROR:  relation \"schema_version\" already exists\r\ntemporal-postgresql     | STATEMENT:  CREATE TABLE schema_version(version_partition INT not null, db_name VARCHAR(255) not null, creation_time TIMESTAMP, curr_version VARCHAR(64), min_compatible_version VARCHAR(64), PRIMARY KEY (version_partition, db_name));\r\ntemporal                | 2021-11-01T04:50:44.866Z      ERROR   Unable to setup SQL schema.     {\"error\": \"pq: relation \\\"schema_version\\\" already exists\", \"logging-call-at\": \"handler.go:57\"}\r\ntemporal                | 2021/11/01 04:50:45 Loading config; env=docker,zone=,configDir=config\r\ntemporal                | 2021/11/01 04:50:45 Loading config files=[config/docker.yaml]\r\ntemporal                | {\"level\":\"info\",\"ts\":\"2021-11-01T04:50:45.279Z\",\"msg\":\"Updated dynamic config\",\"logging-call-at\":\"file_based_client.go:143\"}\r\ntemporal                | {\"level\":\"info\",\"ts\":\"2021-11-01T04:50:45.282Z\",\"msg\":\"Starting server for services\",\"value\":[\"history\",\"matching\",\"frontend\",\"worker\"],\"logging-call-at\":\"server.go:123\"}\r\ntemporal                | {\"level\":\"info\",\"ts\":\"2021-11-01T04:50:45.372Z\",\"msg\":\"PProf not started due to port not set\",\"logging-call-at\":\"pprof.go:67\"}\r\ntemporal-postgresql     | ERROR:  duplicate key value violates unique constraint \"namespaces_pkey\"\r\ntemporal-postgresql     | DETAIL:  Key (partition_id, id)=(54321, \\x32049b68787240948e63d0dd59896a83) already exists.\r\ntemporal-postgresql     | STATEMENT:  INSERT INTO \r\ntemporal-postgresql     |        namespaces (partition_id, id, name, is_global, data, data_encoding, notification_version)\r\ntemporal-postgresql     |        VALUES($1, $2, $3, $4, $5, $6, $7)\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nclone https://github.com/temporalio/docker-compose/commit/2f84de06e30be8dfeddc6f210ff2243ce9ddfe4d\r\n\r\nand `docker-compose up` - should repro the error.\r\n\r\n## Temporary resolution for those who run into this\r\n\r\n`docker system prune -a && git reset 0e68621 --hard && docker-compose up` and the error is gone. \r\n\r\n## Specifications\r\n\r\n  - Version: temporal 1.13\r\n  - Platform: m1 mac mini\r\n","closedAt":"2022-01-24T20:52:10Z","comments":[{"id":"IC_kwDODNqesM44-l3p","author":{"login":"swyxio"},"authorAssociation":"CONTRIBUTOR","body":"to maintainers - i dont know if this is the right place for this issue, but i couldnt create an issue in the docker compose repo. also happy to move it to the temporalio/web repo if it is related, but i suspect it is not, and temporal web is merely the symptom, not the cause.","createdAt":"2021-11-01T04:59:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2117#issuecomment-955932137","viewerDidAuthor":false},{"id":"IC_kwDODNqesM45CGVm","author":{"login":"swyxio"},"authorAssociation":"CONTRIBUTOR","body":"note from Alex: \"DNS resolution points to cgo. but I am not sure. We just need ARM images and it will mitigate all these problems.\"\r\n","createdAt":"2021-11-01T23:14:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2117#issuecomment-956851558","viewerDidAuthor":false},{"id":"IC_kwDODNqesM481CSM","author":{"login":"swyxio"},"authorAssociation":"CONTRIBUTOR","body":"this was resolved in 1.14.2","createdAt":"2022-01-24T20:52:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2117#issuecomment-1020535948","viewerDidAuthor":false}],"createdAt":"2021-11-01T04:56:22Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":2117,"reactionGroups":[],"state":"CLOSED","title":"OperationalError: 14 UNAVAILABLE: DNS resolution failed in latest docker-compose with M1 Mac and Temporal v1.13","updatedAt":"2022-01-24T20:52:17Z","url":"https://github.com/temporalio/temporal/issues/2117"}
