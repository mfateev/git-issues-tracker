{"assignees":[{"id":"MDQ6VXNlcjU5NDI5NjM=","login":"MichaelSnowden","name":"Michael Snowden","databaseId":0}],"author":{"id":"MDQ6VXNlcjc2OTcyNjgx","is_bot":false,"login":"tristan-instacart","name":"Tristan Fletcher"},"body":"## Expected Behavior\r\nNo panic\r\n\r\n## Actual Behavior\r\nPanic in history service\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. have a namespace called NAMESPACE_NAME with archival on for both visibility and history and have it make workflows that close past its retention period, i.e. it should be archiving stuff\r\n  1. Run $ tctl --ns NAMESPACE_NAME namespace update --history_archival_state disabled\r\n  1. Watch the history service panic and never survive ever again as the workflow will continuously retry to archive and die.\r\n\r\n## Specifications\r\n\r\n  - Version: 1.20.4 (confirmed code is still got the bug in 1.22)\r\n  - Platform: linux docker\r\n\r\n\r\nThe bug is here:\r\nHere is the nil value de-reference: https://github.com/temporalio/temporal/blob/f64bb0eb0f474d03775673b68a341393b48e9891/service/history/archival/archiver.go#L263\r\n\r\nHere is how it gets init to nil and never set to a value:\r\nhttps://github.com/temporalio/temporal/blob/008f056d6528142929b30aeea7a0648c2c0fef16/service/history/archival_queue_task_executor.go#L162-L201","closedAt":"2023-10-05T23:45:16Z","comments":[{"id":"IC_kwDODNqesM5myFf4","author":{"login":"ytaben"},"authorAssociation":"CONTRIBUTOR","body":"Would a proper fix be to make `archiver.uri.String` method return an empty string instead of a panic?\r\n\r\nOur understanding is that for all intents and purposes - the `HistoryURI` is not set for the visibility archival record so it should just be empty. We can fix it either in this specific place or as in the suggestion above - for any uri instance.\r\n\r\nCC @yycptt and @MichaelSnowden as you are the respective authors for the code in question","createdAt":"2023-09-18T20:58:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4879#issuecomment-1724405752","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5myfIc","author":{"login":"ytaben"},"authorAssociation":"CONTRIBUTOR","body":"Note: Since we are not actually setting the HistoryURI to nil (it's an empty interface) - we can't fix this by handling `nil` receiver alone.\r\n\r\nI've made a targeted fix [here](https://github.com/temporalio/temporal/pull/4880) instead ","createdAt":"2023-09-18T21:55:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4879#issuecomment-1724510748","viewerDidAuthor":false}],"createdAt":"2023-09-18T20:46:50Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4879,"reactionGroups":[],"state":"CLOSED","title":"Visibility Archival On, History Archival Off for a namespace causes panic","updatedAt":"2023-10-05T23:45:16Z","url":"https://github.com/temporalio/temporal/issues/4879"}
