{"assignees":[{"id":"MDQ6VXNlcjIyMzI1MjQ=","login":"alexshtin","name":"Alex Shtin","databaseId":0}],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"## Expected Behavior\r\n\r\nIf a client tries to upsert a search attribute of an incorrect type or tried to start a workflow with an incorrect type, the client should get a client exception and workflow start or workflow task should fail.\r\n\r\n## Actual Behavior\r\n\r\nIf SDK sends Search Attribute Payload with type metadata, Temporal Server uses the metadata as a target for validation, not an actual type of ES index.\r\nThis leads to an OK response to SDK and an internal failure:\r\n```\r\ntemporal                | {“level”:“error”,“ts”:“2022-03-31T18:47:21.467Z”,“msg”:“ES request failed.“,”component”:“indexer-es-processor”,“es-response-status”:400,“es-response-error”:“failed to parse field [CustomIntField] of type [long] in document with id ‘workflow-with-sa-incorrect-value-type~a3b4811e-d22d-40d8-b3b4-d5069aaa4566’. Preview of field’s value: ‘this_is_string_and_not_an_int’“,”key”:“3~1048641”,“es-doc-id”:“workflow-with-sa-incorrect-value-type~a3b4811e-d22d-40d8-b3b4-d5069aaa4566”,“es-request”:“{\\“index\\“:{\\“_index\\“:\\“temporal_visibility_v1_dev\\“,\\“_id\\“:\\“workflow-with-sa-incorrect-value-type~a3b4811e-d22d-40d8-b3b4-d5069aaa4566\\“,\\“version\\“:1048641,\\“version_type\\“:\\“external\\“}}\\n{\\“CustomIntField\\“:\\“this_is_string_and_not_an_int\\“,\\“ExecutionStatus\\“:\\“Running\\“,\\“ExecutionTime\\“:\\“2022-03-31T18:47:21.3093079Z\\“,\\“NamespaceId\\“:\\“0062c4ea-7f62-4646-8761-bb0ca86f30f4\\“,\\“RunId\\“:\\“a3b4811e-d22d-40d8-b3b4-d5069aaa4566\\“,\\“StartTime\\“:\\“2022-03-31T18:47:21.3093079Z\\“,\\“TaskQueue\\“:\\“WorkflowTest-searchAttributeIsIncorrectValueType-288bb849-874b-4626-ab35-0586dd8f2996\\“,\\“VisibilityTaskKey\\“:\\“3~1048641\\“,\\“WorkflowId\\“:\\“workflow-with-sa-incorrect-value-type\\“,\\“WorkflowType\\“:\\“TestWorkflow\\“}”,“logging-call-at”:“processor.go:267”,“stacktrace”:“[go.temporal.io/server/common/log.(*zapLogger).Error](http://go.temporal.io/server/common/log.(*zapLogger).Error)\\n\\t/home/builder/temporal/common/log/zap_logger.go:142\\[ngo.temporal.io/server/common/persistence/visibility/store/elasticsearch.(*processorImpl).bulkAfterAction](http://ngo.temporal.io/server/common/persistence/visibility/store/elasticsearch.(*processorImpl).bulkAfterAction)\\n\\t/home/builder/temporal/common/persistence/visibility/store/elasticsearch/processor.go:267\\[ngithub.com/olivere/elastic/v7.(*bulkWorker).commit](http://ngithub.com/olivere/elastic/v7.(*bulkWorker).commit)\\n\\t/go/pkg/mod/github.com/olivere/elastic/v7@v7.0.31/bulk_processor.go:588\\[ngithub.com/olivere/elastic/v7.(*bulkWorker).work](http://ngithub.com/olivere/elastic/v7.(*bulkWorker).work)\\n\\t/go/pkg/mod/github.com/olivere/elastic/v7@v7.0.31/bulk_processor.go:501”}\r\n```\r\n\r\n## Root cause\r\n\r\n`searchattribute.validator.go` calls inside Validate()\r\n```\r\n// where saType is the type of ES index\r\nif _, err = DecodeValue(saPayload, saType); err != nil {\r\n```\r\n\r\n`DecodeValue` prefers type in the Payload to the external type:\r\n```\r\nfunc DecodeValue(value *commonpb.Payload, t enumspb.IndexedValueType) (interface{}, error) {\r\n   valueTypeMetadata, metadataHasValueType := value.Metadata[MetadataType]\r\n   if metadataHasValueType {\r\n      if ivt, ok := enumspb.IndexedValueType_value[string(valueTypeMetadata)]; ok {\r\n         // MetadataType field has priority over passed type.\r\n         t = enumspb.IndexedValueType(ivt)\r\n      }\r\n   }\r\n   //...\r\n}\r\n```\r\n\r\n# Possible solutions\r\n\r\n- Validator or pre-validation code should cleanup type metadata from the Payload passed to the decoder or\r\n- there should be another mode for decoder that prefers the externally supplied type for validation purposes\r\n\r\n# Additional context\r\n\r\nAnother related problem is `DecodeValue(saPayload, saType)` fails if `saPayload `has metadata type `Unspecified` which is a valid `enumspb.IndexedValueType` enum value. Even if `saType` is supplied and matches the data in the payload. ","closedAt":"2022-04-01T21:13:03Z","comments":[],"createdAt":"2022-03-31T21:48:44Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg0","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":2693,"reactionGroups":[],"state":"CLOSED","title":"Search Attributes validation wrongfully use Payload metadata over the index type as a target for validation","updatedAt":"2022-04-01T21:13:03Z","url":"https://github.com/temporalio/temporal/issues/2693"}
