{"assignees":[{"id":"MDQ6VXNlcjg0NDExMDE0","login":"yiminc","name":"Yimin Chen","databaseId":0}],"author":{"id":"MDQ6VXNlcjEwODc0MQ==","is_bot":false,"login":"robzienert","name":"Rob Zienert"},"body":"## Expected Behavior\r\n\r\n`update-schema` should cleanly update the schema from version 0.0\r\n\r\n## Actual Behavior\r\n\r\nAfter creating the schema, running `update-schema` will make it partially through the 1.2 schema, and then fail:\r\n\r\n```\r\n2021/04/20 09:15:44 UpdateSchemeTask started, config=&{DBName: TargetVersion: SchemaDir:schema/mysql/v57/temporal/versioned IsDryRun:false}\r\n2021/04/20 09:15:44 ---- Executing updates for version 1.0 ----\r\n2021/04/20 09:15:44 CREATE TABLE namespaces(partition_id INT NOT NULL,id BINARY(16) NOT NULL,name VARCHAR(255) UNIQUE NOT NULL,notification_version BIGINT NOT NULL,data BLOB NOT NULL,data_encoding VARCHAR(16) NOT NULL,is_global TINYINT(1) NOT NULL,PRIMARY KEY(partition_id, id));\r\n2021/04/20 09:15:45 CREATE TABLE namespace_metadata (partition_id INT NOT NULL,notification_version BIGINT NOT NULL,PRIMARY KEY(partition_id));\r\n2021/04/20 09:15:45 INSERT INTO namespace_metadata (partition_id, notification_version) VALUES (54321, 1);\r\n2021/04/20 09:15:45 CREATE TABLE shards (shard_id INT NOT NULL,range_id BIGINT NOT NULL,data BLOB NOT NULL,data_encoding VARCHAR(16) NOT NULL,PRIMARY KEY (shard_id));\r\n2021/04/20 09:15:45 CREATE TABLE transfer_tasks(shard_id INT NOT NULL,task_id BIGINT NOT NULL,data BLOB NOT NULL,data_encoding VARCHAR(16) NOT NULL,PRIMARY KEY (shard_id, task_id));\r\n2021/04/20 09:15:45 CREATE TABLE executions(shard_id INT NOT NULL,namespace_id BINARY(16) NOT NULL,workflow_id VARCHAR(255) NOT NULL,run_id BINARY(16) NOT NULL,next_event_id BIGINT NOT NULL,last_write_version BIGINT NOT NULL,data BLOB NOT NULL,data_encoding VARCHAR(16) NOT NULL,state BLOB NOT NULL,state_encoding VARCHAR(16) NOT NULL,PRIMARY KEY (shard_id, namespace_id, workflow_id, run_id));\r\n2021/04/20 09:15:46 CREATE TABLE current_executions(shard_id INT NOT NULL,namespace_id BINARY(16) NOT NULL,workflow_id VARCHAR(255) NOT NULL,run_id BINARY(16) NOT NULL,create_request_id VARCHAR(64) NOT NULL,state INT NOT NULL,status INT NOT NULL,start_version BIGINT NOT NULL,last_write_version BIGINT NOT NULL,PRIMARY KEY (shard_id, namespace_id, workflow_id));\r\n2021/04/20 09:15:46 CREATE TABLE buffered_events (shard_id INT NOT NULL,namespace_id BINARY(16) NOT NULL,workflow_id VARCHAR(255) NOT NULL,run_id BINARY(16) NOT NULL,id BIGINT AUTO_INCREMENT NOT NULL UNIQUE,data MEDIUMBLOB NOT NULL,data_encoding VARCHAR(16) NOT NULL,PRIMARY KEY (shard_id, namespace_id, workflow_id, run_id, id));\r\n2021/04/20 09:15:46 CREATE TABLE tasks (range_hash INT UNSIGNED NOT NULL,task_queue_id VARBINARY(272) NOT NULL,task_id BIGINT NOT NULL,data BLOB NOT NULL,data_encoding VARCHAR(16) NOT NULL,PRIMARY KEY (range_hash, task_queue_id, task_id));\r\n2021/04/20 09:15:46 CREATE TABLE task_queues (range_hash INT UNSIGNED NOT NULL,task_queue_id VARBINARY(272) NOT NULL,range_id BIGINT NOT NULL,data BLOB NOT NULL,data_encoding VARCHAR(16) NOT NULL,PRIMARY KEY (range_hash, task_queue_id));\r\n2021/04/20 09:15:46 CREATE TABLE replication_tasks (shard_id INT NOT NULL,task_id BIGINT NOT NULL,data BLOB NOT NULL,data_encoding VARCHAR(16) NOT NULL,PRIMARY KEY (shard_id, task_id));\r\n2021/04/20 09:15:46 CREATE TABLE replication_tasks_dlq (source_cluster_name VARCHAR(255) NOT NULL,shard_id INT NOT NULL,task_id BIGINT NOT NULL,data BLOB NOT NULL,data_encoding VARCHAR(16) NOT NULL,PRIMARY KEY (source_cluster_name, shard_id, task_id));\r\n2021/04/20 09:15:47 CREATE TABLE timer_tasks (shard_id INT NOT NULL,visibility_timestamp DATETIME(6) NOT NULL,task_id BIGINT NOT NULL,data BLOB NOT NULL,data_encoding VARCHAR(16) NOT NULL,PRIMARY KEY (shard_id, visibility_timestamp, task_id));\r\n2021/04/20 09:15:47 error executing statement:Error 1146: Table 'temporal.timer_tasks' doesn't exist\r\n```\r\n\r\nSubsequent calls to `update-schema` appear to have incremented the version to 1.0, but fail with the same error:\r\n\r\n```\r\n2021/04/20 09:18:34 UpdateSchemeTask started, config=&{DBName: TargetVersion: SchemaDir:schema/mysql/v57/temporal/versioned IsDryRun:false}\r\n2021/04/20 09:18:35 ---- Executing updates for version 1.1 ----\r\n2021/04/20 09:18:35 ALTER TABLE cluster_metadata ADD data BLOB NOT NULL;\r\n2021/04/20 09:18:35 ALTER TABLE cluster_metadata ADD data_encoding VARCHAR(16) NOT NULL DEFAULT 'Proto3';\r\n2021/04/20 09:18:35 ALTER TABLE cluster_metadata ADD version BIGINT NOT NULL DEFAULT 1;\r\n2021/04/20 09:18:35 ---- Done ----\r\n2021/04/20 09:18:36 Schema updated from 1.0 to 1.1\r\n2021/04/20 09:18:36 ---- Executing updates for version 1.2 ----\r\n2021/04/20 09:18:36 ALTER TABLE queue ADD message_encoding VARCHAR(16) NOT NULL DEFAULT 'Json';\r\n2021/04/20 09:18:36 ALTER TABLE queue_metadata ADD data_encoding VARCHAR(16) NOT NULL DEFAULT 'Json';\r\n2021/04/20 09:18:36 ALTER TABLE namespaces MODIFY COLUMN data MEDIUMBLOB;\r\n2021/04/20 09:18:37 ALTER TABLE shards MODIFY COLUMN data MEDIUMBLOB;\r\n2021/04/20 09:18:37 ALTER TABLE transfer_tasks MODIFY COLUMN data MEDIUMBLOB;\r\n2021/04/20 09:18:37 ALTER TABLE executions MODIFY COLUMN data MEDIUMBLOB;\r\n2021/04/20 09:18:37 ALTER TABLE executions MODIFY COLUMN state MEDIUMBLOB;\r\n2021/04/20 09:18:37 ALTER TABLE tasks MODIFY COLUMN data MEDIUMBLOB;\r\n2021/04/20 09:18:38 ALTER TABLE task_queues MODIFY COLUMN data MEDIUMBLOB;\r\n2021/04/20 09:18:38 ALTER TABLE replication_tasks MODIFY COLUMN data MEDIUMBLOB;\r\n2021/04/20 09:18:38 ALTER TABLE replication_tasks_dlq MODIFY COLUMN data MEDIUMBLOB;\r\n2021/04/20 09:18:38 ALTER TABLE timer_tasks MODIFY COLUMN data MEDIUMBLOB;\r\n2021/04/20 09:18:38 error executing statement:Error 1146: Table 'temporal.timer_tasks' doesn't exist\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: 1.8.0\r\n  - Platform: OSX (AWS Aurora 5.7)\r\n","closedAt":"2023-08-27T17:26:50Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDgyMzQ2MTAwOA==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"1st section of logs is showing that aurora is unable to create the table `timer_tasks`\r\n```\r\n2021/04/20 09:15:47 error executing statement:Error 1146: Table 'temporal.timer_tasks' doesn't exist\r\n```\r\n\r\ndoes the script return a non 0 exit code on your side?\r\n\r\nlocal manual testing shows that a non 0 exit code is returned.\r\n","createdAt":"2021-04-20T17:19:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1477#issuecomment-823461008","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgyMzQ2MjA4Nw==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"what is the command used for the 2nd section?","createdAt":"2021-04-20T17:21:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1477#issuecomment-823462087","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgyMzQ2ODY5Mw==","author":{"login":"robzienert"},"authorAssociation":"CONTRIBUTOR","body":"@wxing1292 Yeah, it returns a non-zero code. The second output is using the exact same command as the first.","createdAt":"2021-04-20T17:32:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1477#issuecomment-823468693","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg3MzY2MTUyMw==","author":{"login":"samarabbas"},"authorAssociation":"MEMBER","body":"Seems to be similar to #1087 ","createdAt":"2021-07-04T21:00:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1477#issuecomment-873661523","viewerDidAuthor":false},{"id":"IC_kwDODNqesM446ib-","author":{"login":"mnussbaum"},"authorAssociation":"CONTRIBUTOR","body":"Not sure, but this might be fixed by https://github.com/temporalio/temporal/pull/2104. Probably worth testing if you can still repro ","createdAt":"2021-10-29T16:11:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1477#issuecomment-954869502","viewerDidAuthor":false}],"createdAt":"2021-04-20T16:52:40Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"},{"id":"MDU6TGFiZWwyMDE5OTIzNjU1","name":"devexp","description":"","color":"9350b7"},{"id":"MDU6TGFiZWwzMDAxNDk5NzYw","name":"operations","description":"","color":"f9d0c4"}],"milestone":null,"number":1477,"reactionGroups":[],"state":"CLOSED","title":"temporal-sql-tool fails to update schema","updatedAt":"2023-08-27T17:26:50Z","url":"https://github.com/temporalio/temporal/issues/1477"}
