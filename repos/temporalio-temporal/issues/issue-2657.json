{"assignees":[{"id":"MDQ6VXNlcjYzNTAzMDE=","login":"jbreiding","name":"Jeremy","databaseId":0}],"author":{"id":"MDQ6VXNlcjU5MDkzMzQ=","is_bot":false,"login":"Lercher","name":"Martin Lercher"},"body":"## Expected Behavior\r\n\r\nBuild succeeds with `CGO_ENABLED=0`, `go test ./...` should at least compile.\r\n\r\n## Actual Behavior\r\n\r\nTests don't build, see next section for details.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1.  `set CGO_ENABLED=0`\r\n  1. `go build .\\cmd\\server\\`  -> succeeds\r\n  1. `go test ./...` -> fails with this build error:\r\n\r\n```txt\r\npackage go.temporal.io/server/common/persistence/persistence-tests\r\n     imports go.temporal.io/server/common/persistence/sql/sqlplugin/sqlite: \r\n        build constraints exclude all Go files \r\n        in C:\\git\\src\\github.com\\temporalio\\temporal\\common\\persistence\\sql\\sqlplugin\\sqlite\r\n```\r\n\r\n(reformatted for better readability)\r\n\r\n## Specifications\r\n\r\n  - Version: On branch release/v1.15.x\r\n  - Platform: go version go1.18 windows/amd64 (Windows 10)\r\n\r\n## Why it is Important\r\n\r\nOperating a CGO compatible C/C++ compiler on Windows is a non-trivial task with many (installation) hurdles and quite a lot of probably incompatible C/C++ variants. Furthermore, I'm personally favoring a \"pure\" Go build.\r\n\r\n## More Information to Consider\r\n\r\nThe sources already address CGO with build constraints, as this global search indicates. It's probably an idea to use these for the test components too:\r\n\r\n<img width=\"394\" alt=\"image\" src=\"https://user-images.githubusercontent.com/5909334/160384761-12e7f66d-7426-4172-aee0-993d328bcbeb.png\">\r\n\r\nThe _impact_ is probably low: Opting out from CGO intentionally turns off sqlite support, so there is probably no personal need to test the sqlite driver package. \r\n\r\nAs an _alternative_, https://pkg.go.dev/modernc.org/sqlite advertises itself as _Package sqlite is a CGo-free port of SQLite._ I don't use it, however, and of course I don't know about its stability or fitness for temporal.\r\n\r\nThanks for considering,\r\nMartin","closedAt":"2022-04-13T22:29:40Z","comments":[{"id":"IC_kwDODNqesM5BR5Pd","author":{"login":"jbreiding"},"authorAssociation":"CONTRIBUTOR","body":"Thanks for the issue, I have been planning to move to this library and now have a PR for it.\r\n\r\nHowever our tests are meant to be run with the race detector for go which also requires CGO.\r\n\r\nUntil that requirement is removed our tests, to be complete, will need CGO to execute using the race detector.\r\n\r\nhttps://go.dev/doc/articles/race_detector","createdAt":"2022-04-11T15:38:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2657#issuecomment-1095209949","viewerDidAuthor":false}],"createdAt":"2022-03-28T11:12:29Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODQ3NDEz","name":"testing","description":"","color":"949fdd"},{"id":"MDU6TGFiZWwyNzcwMzY2NzYw","name":"close-after-30-days","description":"","color":"1d76db"}],"milestone":null,"number":2657,"reactionGroups":[],"state":"CLOSED","title":"using sqlite introduces CGO dependency for (only) tests","updatedAt":"2022-04-13T22:29:40Z","url":"https://github.com/temporalio/temporal/issues/2657"}
