{"assignees":[],"author":{"id":"MDQ6VXNlcjIyMzI1MjQ=","is_bot":false,"login":"alexshtin","name":"Alex Shtin"},"body":"After sequentially restarting all 3 Cassandra nodes (replication factor 1) while starting workflows, I got this:\r\n```\r\n$ tctl --ns benchtest wf list -op\r\n  WORKFLOW TYPE  |  WORKFLOW ID   |                RUN ID                |   TASK QUEUE   | START TIME | EXECUTION TIME\r\n  basic-workflow | basic-1-1-2144 | 571b73cc-0960-48fb-b45a-416c683c3905 | temporal-bench | 02:28:01   | 02:28:01\r\n$ tctl --ns benchtest wf show -wid  basic-1-1-2144\r\nError: Failed to get history on workflow id: basic-1-1-2144, run id: .\r\nError Details: corrupted history event batch, eventID is not continuous\r\n('export TEMPORAL_CLI_SHOW_STACKS=1' to see stack traces)\r\ncommand terminated with exit code 1\r\n$ tctl --ns benchtest admin wf desc -wid basic-1-1-2144                               \r\n{\r\n  \"shardId\": \"5\",\r\n  \"historyAddr\": \"172.31.53.222:7234\",\r\n  \"databaseMutableState\": \"{\\\"ActivityInfos\\\":{},\\\"TimerInfos\\\":{},\\\"ChildExecutionInfos\\\":{},\\\"RequestCancelInfos\\\":{},\\\"SignalInfos\\\":{},\\\"SignalRequestedIDs\\\":{},\\\"ExecutionInfo\\\":{\\\"NamespaceID\\\":\\\"54ebd830-8ba8-4e75-b3cb-69bd6d5732c5\\\",\\\"WorkflowID\\\":\\\"basic-1-1-2144\\\",\\\"RunID\\\":\\\"571b73cc-0960-48fb-b45a-416c683c3905\\\",\\\"FirstExecutionRunID\\\":\\\"571b73cc-0960-48fb-b45a-416c683c3905\\\",\\\"ParentNamespaceID\\\":\\\"\\\",\\\"ParentWorkflowID\\\":\\\"\\\",\\\"ParentRunID\\\":\\\"\\\",\\\"InitiatedID\\\":0,\\\"CompletionEventBatchID\\\":5,\\\"CompletionEvent\\\":null,\\\"TaskQueue\\\":\\\"temporal-bench\\\",\\\"WorkflowTypeName\\\":\\\"basic-workflow\\\",\\\"WorkflowRunTimeout\\\":3600,\\\"WorkflowExecutionTimeout\\\":3600,\\\"DefaultWorkflowTaskTimeout\\\":10,\\\"State\\\":3,\\\"Status\\\":7,\\\"LastFirstEventID\\\":5,\\\"LastEventTaskID\\\":0,\\\"NextEventID\\\":6,\\\"LastProcessedEvent\\\":0,\\\"StartTimestamp\\\":\\\"2020-08-29T02:28:01.106Z\\\",\\\"LastUpdatedTimestamp\\\":\\\"2020-08-29T03:28:01.108Z\\\",\\\"CreateRequestID\\\":\\\"bd268302-9ac3-4b15-912d-328dc312d793\\\",\\\"SignalCount\\\":0,\\\"WorkflowTaskVersion\\\":0,\\\"WorkflowTaskScheduleID\\\":0,\\\"WorkflowTaskStartedID\\\":0,\\\"WorkflowTaskRequestID\\\":\\\"emptyUuid\\\",\\\"WorkflowTaskTimeout\\\":0,\\\"WorkflowTaskAttempt\\\":85,\\\"WorkflowTaskStartedTimestamp\\\":0,\\\"WorkflowTaskScheduledTimestamp\\\":1598671681107428916,\\\"WorkflowTaskOriginalScheduledTimestamp\\\":0,\\\"CancelRequested\\\":false,\\\"CancelRequestID\\\":\\\"\\\",\\\"StickyTaskQueue\\\":\\\"\\\",\\\"StickyScheduleToStartTimeout\\\":0,\\\"ClientLibraryVersion\\\":\\\"\\\",\\\"ClientFeatureVersion\\\":\\\"\\\",\\\"ClientImpl\\\":\\\"\\\",\\\"AutoResetPoints\\\":{},\\\"Memo\\\":null,\\\"SearchAttributes\\\":null,\\\"Attempt\\\":1,\\\"HasRetryPolicy\\\":false,\\\"InitialInterval\\\":0,\\\"BackoffCoefficient\\\":0,\\\"MaximumInterval\\\":0,\\\"WorkflowExpirationTime\\\":\\\"2020-08-29T03:28:01.104Z\\\",\\\"MaximumAttempts\\\":0,\\\"NonRetryableErrorTypes\\\":null,\\\"BranchToken\\\":\\\"CiQ1NzFiNzNjYy0wOTYwLTQ4ZmItYjQ1YS00MTZjNjgzYzM5MDUSJDc5OTdjYWY4LWRhM2YtNGMwNC1hNzEwLTJlNDgyMzllNTU2NQ==\\\",\\\"CronSchedule\\\":\\\"\\\"},\\\"ExecutionStats\\\":null,\\\"ReplicationState\\\":null,\\\"BufferedEvents\\\":[],\\\"VersionHistories\\\":null,\\\"Checksum\\\":{\\\"Version\\\":0,\\\"Flavor\\\":0,\\\"Value\\\":null}}\"\r\n}\r\n{\r\n  \"tree_id\": \"571b73cc-0960-48fb-b45a-416c683c3905\",\r\n  \"branch_id\": \"7997caf8-da3f-4c04-a710-2e48239e5565\"\r\n}\r\nauto-reset-points:\r\n$ tctl --ns benchtest admin wf show --db_address 172.31.6.30 --db_port 9042  --tree_id 571b73cc-0960-48fb-b45a-416c683c3905 --branch_id 7997caf8-da3f-4c04-a710-2e48239e5565\r\n======== batch 1, blob len: 112 ======\r\n[{\"eventId\":\"3\",\"eventTime\":\"2020-08-29T02:31:53.981065058Z\",\"eventType\":\"WorkflowTaskStarted\",\"taskId\":\"2097394\",\"workflowTaskStartedEventAttributes\":{\"scheduledEventId\":\"2\",\"identity\":\"1@benchtest-temporal-bench-554486b44-qxzhd@\",\"requestId\":\"50ca18e1-5998-4edc-858f-8ce8881c0855\"}}]\r\n======== batch 2, blob len: 33 ======\r\n[{\"eventId\":\"4\",\"eventTime\":\"2020-08-29T02:32:03.983689465Z\",\"eventType\":\"WorkflowTaskTimedOut\",\"taskId\":\"2097441\",\"workflowTaskTimedOutEventAttributes\":{\"scheduledEventId\":\"2\",\"startedEventId\":\"3\",\"timeoutType\":\"StartToClose\"}}]\r\n======== batch 3, blob len: 28 ======\r\n[{\"eventId\":\"5\",\"eventTime\":\"2020-08-29T03:28:01.107440240Z\",\"eventType\":\"WorkflowExecutionTimedOut\",\"taskId\":\"2098353\",\"workflowExecutionTimedOutEventAttributes\":{\"retryState\":\"Timeout\"}}]\r\n======== total batches 3, total blob len: 173 ======\r\n```","closedAt":"2020-12-15T04:52:08Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDY5MDc0NzQzMw==","author":{"login":"zznate"},"authorAssociation":"NONE","body":"Without any replicas (RF=1) and a node down you _will_ loose data. We capture hints on the remaining coordinators, but that's a best effort. Is this just a side effect of the default (https://github.com/temporalio/temporal/blob/master/schema/cassandra/temporal/keyspace.cql)? \r\n\r\nAlso, would you take a patch with some details in a CQL comment about how to configure the keyspace for prod in the above file? Happy to put that together. ","createdAt":"2020-09-10T21:42:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/706#issuecomment-690747433","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc0NTA1MDkzMQ==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"issue no longer relevant","createdAt":"2020-12-15T04:52:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/706#issuecomment-745050931","viewerDidAuthor":false}],"createdAt":"2020-09-01T00:04:34Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":706,"reactionGroups":[],"state":"CLOSED","title":"Corrupted history event batch after Cassandra restart","updatedAt":"2020-12-15T04:52:08Z","url":"https://github.com/temporalio/temporal/issues/706"}
