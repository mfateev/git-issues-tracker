{"assignees":[],"author":{"id":"U_kgDOBvr6mw","is_bot":false,"login":"mxbvkn","name":"Max Bovykin"},"body":"## Expected Behavior\r\n\r\nAll tests pass\r\n\r\n## Actual Behavior\r\n\r\n```\r\n==================\r\nWARNING: DATA RACE\r\nWrite at 0x00010506ff60 by goroutine 586:\r\n  go.temporal.io/server/service/matching.setScoped[...]()\r\n      /Users/mxbvkn/Temporal/Public/temporal-mxbvkn/service/matching/task_queue_manager_test.go:78 +0x1c4\r\n  go.temporal.io/server/service/matching.TestTQMFetchesUserDataFailsAndTriesAgain()\r\n      /Users/mxbvkn/Temporal/Public/temporal-mxbvkn/service/matching/task_queue_manager_test.go:807 +0x230\r\n  testing.tRunner()\r\n      /usr/local/go/src/testing/testing.go:1576 +0x188\r\n  testing.(*T).Run.func1()\r\n      /usr/local/go/src/testing/testing.go:1629 +0x40\r\n\r\nPrevious read at 0x00010506ff60 by goroutine 490:\r\n  go.temporal.io/server/service/matching.(*taskQueueManagerImpl).fetchUserData()\r\n      /Users/mxbvkn/Temporal/Public/temporal-mxbvkn/service/matching/task_queue_manager.go:853 +0x360\r\n  go.temporal.io/server/service/matching.(*taskQueueManagerImpl).fetchUserData-fm()\r\n      <autogenerated>:1 +0x44\r\n  go.temporal.io/server/internal/goro.(*Group).Go.func1()\r\n      /Users/mxbvkn/Temporal/Public/temporal-mxbvkn/internal/goro/group.go:58 +0x94\r\n\r\nGoroutine 586 (running) created at:\r\n  testing.(*T).Run()\r\n      /usr/local/go/src/testing/testing.go:1629 +0x5e4\r\n  testing.runTests.func1()\r\n      /usr/local/go/src/testing/testing.go:2036 +0x80\r\n  testing.tRunner()\r\n      /usr/local/go/src/testing/testing.go:1576 +0x188\r\n  testing.runTests()\r\n      /usr/local/go/src/testing/testing.go:2034 +0x700\r\n  testing.(*M).Run()\r\n      /usr/local/go/src/testing/testing.go:1906 +0x950\r\n  main.main()\r\n      _testmain.go:183 +0x300\r\n\r\nGoroutine 490 (running) created at:\r\n  go.temporal.io/server/internal/goro.(*Group).Go()\r\n      /Users/mxbvkn/Temporal/Public/temporal-mxbvkn/internal/goro/group.go:56 +0xf8\r\n  go.temporal.io/server/service/matching.(*taskQueueManagerImpl).Start()\r\n      /Users/mxbvkn/Temporal/Public/temporal-mxbvkn/service/matching/task_queue_manager.go:319 +0xf4\r\n  go.temporal.io/server/service/matching.(*matchingEngineSuite).TestTaskQueueManagerGetTaskBatch_ReadBatchDone()\r\n      /Users/mxbvkn/Temporal/Public/temporal-mxbvkn/service/matching/matching_engine_test.go:1775 +0x1a8\r\n  runtime.call16()\r\n      /usr/local/go/src/runtime/asm_arm64.s:478 +0x74\r\n  reflect.Value.Call()\r\n      /usr/local/go/src/reflect/value.go:370 +0x90\r\n  github.com/stretchr/testify/suite.Run.func1()\r\n      /Users/mxbvkn/go/pkg/mod/github.com/stretchr/testify@v1.8.4/suite/suite.go:197 +0x540\r\n  testing.tRunner()\r\n      /usr/local/go/src/testing/testing.go:1576 +0x188\r\n  testing.(*T).Run.func1()\r\n      /usr/local/go/src/testing/testing.go:1629 +0x40\r\n==================\r\n2023-07-06T17:16:42.296-0700\tinfo\tnone\t{\"wf-task-queue-name\": \"/_sys/tq/1\", \"wf-task-queue-type\": \"Workflow\", \"wf-namespace\": \"\", \"lifecycle\": \"Started\", \"logging-call-at\": \"task_queue_manager.go:320\"}\r\n2023-07-06T17:16:42.397-0700\tinfo\tnone\t{\"wf-task-queue-name\": \"/_sys/tq/1\", \"wf-task-queue-type\": \"Workflow\", \"wf-namespace\": \"\", \"lifecycle\": \"Stopped\", \"logging-call-at\": \"task_queue_manager.go:350\"}\r\n--- FAIL: TestTQMFetchesUserDataFailsAndTriesAgain (0.10s)\r\n\r\n```\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Clone official `master` branch (latest as of 07/06/23 ~5:15 PDT)\r\n  2. Run steps as outlined in https://github.com/temporalio/temporal/blob/master/CONTRIBUTING.md -- up to `make test`\r\n\r\n## Specifications\r\n\r\n  - Platform: MacOS 13.4.1 (22F82), MBP M1 Max\r\n","closedAt":"2023-07-12T23:36:11Z","comments":[{"id":"IC_kwDODNqesM5hWrnh","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"Also fixed by #4604 ","createdAt":"2023-07-12T23:36:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4590#issuecomment-1633335777","viewerDidAuthor":false}],"createdAt":"2023-07-07T00:34:20Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4590,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"Data Race (while running server tests) [FAIL: TestTQMFetchesUserDataFailsAndTriesAgain]","updatedAt":"2023-07-12T23:36:12Z","url":"https://github.com/temporalio/temporal/issues/4590"}
