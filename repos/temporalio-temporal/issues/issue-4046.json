{"assignees":[{"id":"MDQ6VXNlcjIwNjgxMjQ=","login":"rodrigozhou","name":"Rodrigo Zhou","databaseId":0}],"author":{"id":"MDQ6VXNlcjI1ODY4NDEx","is_bot":false,"login":"arthosdevelops","name":""},"body":"### Expected Behavior\r\ntemporal_visibility schema upgraded to v1.9 with no errors\r\n\r\n### Actual Behavior\r\nWe get the following error:\r\n```\r\nERROR   Unable to update SQL schema.    {\"error\": \"error executing statement:pq: relation \\\"queue\\\" does not exist\", \"logging-call-at\": \"handler.go:78\"}\r\n```\r\n\r\n### Steps to Reproduce the Problem and Background\r\n\r\nWe are currently in the process of upgrading from v1.18.4 to v1.19.0. I was able to upgrade the temporal db schema by running the following command with no errors:\r\n```./temporal-sql-tool --ep DB_ENDPOINT -p 5432 -u USER -pw PASSWORD --plugin postgres --db temporal update-schema -d /etc/temporal/schema/postgresql/v96/temporal/versioned```\r\n\r\nHowever, when running the above command with the temporal_visibility DB, it fails with the following error:\r\n```\r\n2023-03-13T02:57:44.512Z        INFO    UpdateSchemeTask started        {\"config\": {\"DBName\":\"\",\"TargetVersion\":\"\",\"SchemaDir\":\"/etc/temporal/schema/postgresql/v96/temporal/versioned\",\"IsDryRun\":false}, \"logging-call-at\": \"updatetask.go:97\"}\r\n2023-03-13T02:57:44.514Z        DEBUG   Schema Dirs: [] {\"logging-call-at\": \"updatetask.go:186\"}\r\n2023-03-13T02:57:44.514Z        DEBUG   found zero updates from current version 1.8     {\"logging-call-at\": \"updatetask.go:127\"}\r\n2023-03-13T02:57:44.514Z        INFO    UpdateSchemeTask done   {\"logging-call-at\": \"updatetask.go:120\"}\r\nbash-5.1# ./temporal-sql-tool --ep temporal-aurora-pgsql-cluster.cluster-cuniohm9tqjh.ap-northeast-1.rds.amazonaws.com -p 5432 -u dbadmin -pw 0b270c2d --plugin postgres --db temporal_visibility update-schema -d /etc/temporal/schema/postgresql/v96/temporal/versioned\r\n2023-03-13T02:58:24.460Z        INFO    UpdateSchemeTask started        {\"config\": {\"DBName\":\"\",\"TargetVersion\":\"\",\"SchemaDir\":\"/etc/temporal/schema/postgresql/v96/temporal/versioned\",\"IsDryRun\":false}, \"logging-call-at\": \"updatetask.go:97\"}\r\n2023-03-13T02:58:24.462Z        DEBUG   Schema Dirs: [v1.2 v1.3 v1.4 v1.5 v1.6 v1.7 v1.8]       {\"logging-call-at\": \"updatetask.go:186\"}\r\n2023-03-13T02:58:24.462Z        INFO    Processing schema file: /etc/temporal/schema/postgresql/v96/temporal/versioned/v1.2/queue.sql   {\"logging-call-at\": \"updatetask.go:232\"}\r\n2023-03-13T02:58:24.462Z        INFO    Processing schema file: /etc/temporal/schema/postgresql/v96/temporal/versioned/v1.3/visibility_tasks.sql        {\"logging-call-at\": \"updatetask.go:232\"}\r\n2023-03-13T02:58:24.462Z        INFO    Processing schema file: /etc/temporal/schema/postgresql/v96/temporal/versioned/v1.4/cluster_metadata.sql        {\"logging-call-at\": \"updatetask.go:232\"}\r\n2023-03-13T02:58:24.462Z        INFO    Processing schema file: /etc/temporal/schema/postgresql/v96/temporal/versioned/v1.5/event.sql   {\"logging-call-at\": \"updatetask.go:232\"}\r\n2023-03-13T02:58:24.462Z        INFO    Processing schema file: /etc/temporal/schema/postgresql/v96/temporal/versioned/v1.5/executions.sql      {\"logging-call-at\": \"updatetask.go:232\"}\r\n2023-03-13T02:58:24.462Z        INFO    Processing schema file: /etc/temporal/schema/postgresql/v96/temporal/versioned/v1.5/cluster_membership.sql      {\"logging-call-at\": \"updatetask.go:232\"}\r\n2023-03-13T02:58:24.462Z        INFO    Processing schema file: /etc/temporal/schema/postgresql/v96/temporal/versioned/v1.6/queue_metadata.sql  {\"logging-call-at\": \"updatetask.go:232\"}\r\n2023-03-13T02:58:24.462Z        INFO    Processing schema file: /etc/temporal/schema/postgresql/v96/temporal/versioned/v1.7/cluster_metadata_info.sql   {\"logging-call-at\": \"updatetask.go:232\"}\r\n2023-03-13T02:58:24.462Z        INFO    Processing schema file: /etc/temporal/schema/postgresql/v96/temporal/versioned/v1.7/no_start_version.sql        {\"logging-call-at\": \"updatetask.go:232\"}\r\n2023-03-13T02:58:24.462Z        INFO    Processing schema file: /etc/temporal/schema/postgresql/v96/temporal/versioned/v1.7/tiered_storage_tasks.sql    {\"logging-call-at\": \"updatetask.go:232\"}\r\n2023-03-13T02:58:24.462Z        INFO    Processing schema file: /etc/temporal/schema/postgresql/v96/temporal/versioned/v1.8/drop_unused_tasks_table.sql {\"logging-call-at\": \"updatetask.go:232\"}\r\n2023-03-13T02:58:24.462Z        INFO    Processing schema file: /etc/temporal/schema/postgresql/v96/temporal/versioned/v1.8/alter_columns.sql   {\"logging-call-at\": \"updatetask.go:232\"}\r\n2023-03-13T02:58:24.462Z        DEBUG   ---- Executing updates for version 1.2 ----     {\"logging-call-at\": \"updatetask.go:150\"}\r\n2023-03-13T02:58:24.463Z        DEBUG   ALTER TABLE queue ADD message_encoding VARCHAR(16) NOT NULL DEFAULT 'Json';     {\"logging-call-at\": \"updatetask.go:152\"}\r\n2023-03-13T02:58:24.463Z        ERROR   Unable to update SQL schema.    {\"error\": \"error executing statement:pq: relation \\\"queue\\\" does not exist\", \"logging-call-at\": \"handler.go:78\"}\r\n```\r\n\r\nIs this a known issue? \r\n","closedAt":"2023-04-12T07:53:39Z","comments":[{"id":"IC_kwDODNqesM5XazCd","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Are you trying to upgrade schema for temporal or temporal_visibility? ","createdAt":"2023-03-13T18:00:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4046#issuecomment-1466642589","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5Xdj1i","author":{"login":"arthosdevelops"},"authorAssociation":"NONE","body":"Based on [this](https://github.com/temporalio/temporal/tree/master/tools/sql#update-schema-as-part-of-a-release), I am trying to do it for both. The temporal schema upgrade was done successfully, but we receive the above error for temporal_visibility","createdAt":"2023-03-14T05:07:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4046#issuecomment-1467366754","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5ZkAyl","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"@arthosdevelops Your command to update `temporal_visibility` database seems to be wrong.\r\nIt should be something like this:\r\n```\r\n./temporal-sql-tool --ep temporal-aurora-pgsql-cluster.cluster-cuniohm9tqjh.ap-northeast-1.rds.amazonaws.com -p 5432 -u dbadmin -pw 0b270c2d --plugin postgres --db temporal_visibility update-schema -d /etc/temporal/schema/postgresql/v96/visibility/versioned\r\n```\r\n\r\nNote the path is incorrect in your logs: `v96/temporal/versioned` -> `v96/visibility/versioned`.","createdAt":"2023-04-11T02:45:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4046#issuecomment-1502612645","viewerDidAuthor":false}],"createdAt":"2023-03-13T03:02:37Z","labels":[],"milestone":null,"number":4046,"reactionGroups":[],"state":"CLOSED","title":"Unable to upgrade PostgreSQL schema version to 1.9","updatedAt":"2023-04-12T07:53:40Z","url":"https://github.com/temporalio/temporal/issues/4046"}
