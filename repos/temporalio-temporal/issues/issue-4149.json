{"assignees":[],"author":{"id":"MDQ6VXNlcjM4NzA1MTc=","is_bot":false,"login":"Huangsir","name":""},"body":"After upgrading temporal to version 1.20.1, I found that there was a slow log when querying temporal_visibility.\r\nAfter running for a while, \"temporal-history\" started to frequently report the error \"context deadline exceeded\", andMySQL started to report SlowLogs.\r\n\r\n```\r\n{\"level\":\"error\",\"ts\":\"2023-04-07T07:12:33.752Z\",\"msg\":\"Operation failed with an error.\",\"error\":\"context deadline exceeded\",\"logging-call-at\":\"visiblity_manager_metrics.go:258\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/home/builder/temporal/common/log/zap_logger.go:150\\ngo.temporal.io/server/common/persistence/visibility.(*visibilityManagerMetrics).updateErrorMetric\\n\\t/home/builder/temporal/common/persistence/visibility/visiblity_manager_metrics.go:258\\ngo.temporal.io/server/common/persistence/visibility.(*visibilityManagerMetrics).RecordWorkflowExecutionClosed\\n\\t/home/builder/temporal/common/persistence/visibility/visiblity_manager_metrics.go:102\\ngo.temporal.io/server/service/history.(*visibilityQueueTaskExecutor).recordCloseExecution\\n\\t/home/builder/temporal/service/history/visibilityQueueTaskExecutor.go:443\\ngo.temporal.io/server/service/history.(*visibilityQueueTaskExecutor).processCloseExecution\\n\\t/home/builder/temporal/service/history/visibilityQueueTaskExecutor.go:392\\ngo.temporal.io/server/service/history.(*visibilityQueueTaskExecutor).Execute\\n\\t/home/builder/temporal/service/history/visibilityQueueTaskExecutor.go:120\\ngo.temporal.io/server/service/history/queues.(*executableImpl).Execute\\n\\t/home/builder/temporal/service/history/queues/executable.go:211\\ngo.temporal.io/server/common/tasks.(*FIFOScheduler[...]).executeTask.func1\\n\\t/home/builder/temporal/common/tasks/fifo_scheduler.go:231\\ngo.temporal.io/server/common/backoff.ThrottleRetry.func1\\n\\t/home/builder/temporal/common/backoff/retry.go:175\\ngo.temporal.io/server/common/backoff.ThrottleRetryContext\\n\\t/home/builder/temporal/common/backoff/retry.go:199\\ngo.temporal.io/server/common/backoff.ThrottleRetry\\n\\t/home/builder/temporal/common/backoff/retry.go:176\\ngo.temporal.io/server/common/tasks.(*FIFOScheduler[...]).executeTask\\n\\t/home/builder/temporal/common/tasks/fifo_scheduler.go:241\\ngo.temporal.io/server/common/tasks.(*FIFOScheduler[...]).processTask\\n\\t/home/builder/temporal/common/tasks/fifo_scheduler.go:217\"}\r\n\r\n```\r\n\r\nThis SQL statement was obtained from “show processlist”.\r\n\r\n```sql\r\nSELECT ev.namespace_id, ev.run_id, ev.workflow_type_name, ev.workflow_id, ev.start_time, ev.execution_time, ev.status, ev.close_time, ev.history_length, ev.memo, ev.encoding, ev.task_queue, ev.search_attributes FROM executions_visibility ev LEFT JOIN custom_search_attributes USING (namespace_id, run_id) WHERE namespace_id = 'f458436c-e0b6-47d6-ac5d-a633ef7d84bb' AND TemporalNamespaceDivision is null ORDER BY coalesce(close_time, cast('9999-12-31 23:59:59' as datetime)) DESC, start_time DESC, run_id LIMIT 1000\r\n```\r\n\r\nThere are approximately 3 million rows of data under this namespace.\r\n\r\n\r\n## Expected Behavior\r\n​\r\nBased on the index involvement in the table structure, MySQL should use the \"default_idx\" index. and this is the execution result after I forced the use of the \"default_idx\" index.\r\n\r\n```sql\r\nmysql> explain analyze SELECT ev.namespace_id, ev.run_id, ev.workflow_type_name, ev.workflow_id, ev.start_time, ev.execution_time, ev.status, ev.close_time, ev.history_length, ev.memo, ev.encoding, ev.task_queue, ev.search_attributes FROM executions_visibility ev USE INDEX(default_idx) LEFT JOIN custom_search_attributes USING (namespace_id, run_id) WHERE namespace_id = 'f458436c-e0b6-47d6-ac5d-a633ef7d84bb' AND TemporalNamespaceDivision is null ORDER BY coalesce(close_time, cast('9999-12-31 23:59:59' as datetime)) DESC, start_time DESC, run_id LIMIT 1000\\G;\r\n*************************** 1. row ***************************\r\nEXPLAIN: -> Limit: 1000 row(s)  (cost=115154.45 rows=1000) (actual time=0.073..18.884 rows=1000 loops=1)\r\n    -> Nested loop left join  (cost=115154.45 rows=154992) (actual time=0.072..18.796 rows=1000 loops=1)\r\n        -> Filter: ((ev.namespace_id = 'f458436c-e0b6-47d6-ac5d-a633ef7d84bb') and (ev.TemporalNamespaceDivision is null))  (cost=60907.21 rows=154992) (actual time=0.057..12.063 rows=1000 loops=1)\r\n            -> Index lookup on ev using default_idx (namespace_id='f458436c-e0b6-47d6-ac5d-a633ef7d84bb')  (cost=60907.21 rows=1549921) (actual time=0.054..11.499 rows=1000 loops=1)\r\n        -> Filter: (custom_search_attributes.namespace_id = 'f458436c-e0b6-47d6-ac5d-a633ef7d84bb')  (cost=0.25 rows=1) (actual time=0.007..0.007 rows=0 loops=1000)\r\n            -> Single-row covering index lookup on custom_search_attributes using PRIMARY (namespace_id='f458436c-e0b6-47d6-ac5d-a633ef7d84bb', run_id=ev.run_id)  (cost=0.25 rows=1) (actual time=0.006..0.006 rows=0 loops=1000)\r\n\r\n1 row in set (0.02 sec)\r\n\r\n\r\nmysql> explain SELECT ev.namespace_id, ev.run_id, ev.workflow_type_name, ev.workflow_id, ev.start_time, ev.execution_time, ev.status, ev.close_time, ev.history_length, ev.memo, ev.encoding, ev.task_queue, ev.search_attributes FROM executions_visibility ev USE INDEX(default_idx) LEFT JOIN custom_search_attributes USING (namespace_id, run_id) WHERE namespace_id = 'f458436c-e0b6-47d6-ac5d-a633ef7d84bb' AND TemporalNamespaceDivision is null ORDER BY coalesce(close_time, cast('9999-12-31 23:59:59' as datetime)) DESC, start_time DESC, run_id LIMIT 1000\\G;\r\n*************************** 1. row ***************************\r\n           id: 1\r\n  select_type: SIMPLE\r\n        table: ev\r\n   partitions: NULL\r\n         type: ref\r\npossible_keys: default_idx\r\n          key: default_idx\r\n      key_len: 256\r\n          ref: const\r\n         rows: 1549921\r\n     filtered: 10.00\r\n        Extra: Using where\r\n*************************** 2. row ***************************\r\n           id: 1\r\n  select_type: SIMPLE\r\n        table: custom_search_attributes\r\n   partitions: NULL\r\n         type: eq_ref\r\npossible_keys: PRIMARY,by_bool_01,by_bool_02,by_bool_03,by_datetime_01,by_datetime_02,by_datetime_03,by_double_01,by_double_02,by_double_03,by_int_01,by_int_02,by_int_03,by_keyword_01,by_keyword_02,by_keyword_03,by_keyword_04,by_keyword_05,by_keyword_06,by_keyword_07,by_keyword_08,by_keyword_09,by_keyword_10,by_keyword_list_01,by_keyword_list_02,by_keyword_list_03\r\n          key: PRIMARY\r\n      key_len: 512\r\n          ref: const,temporal_visibility.ev.run_id\r\n         rows: 1\r\n     filtered: 100.00\r\n        Extra: Using where; Using index\r\n2 rows in set, 1 warning (0.01 sec)\r\n```\r\n\r\n## Actual Behavior\r\n\r\nMySQL did not use the \"default_idx\" index as I forced, instead, it used the PrimaryKey as index\r\n\r\n```sql\r\n\r\nmysql> explain SELECT ev.namespace_id, ev.run_id, ev.workflow_type_name, ev.workflow_id, ev.start_time, ev.execution_time, ev.status, ev.close_time, ev.history_length, ev.memo, ev.encoding, ev.task_queue, ev.search_attributes FROM executions_visibility ev LEFT JOIN custom_search_attributes USING (namespace_id, run_id) WHERE namespace_id = 'f458436c-e0b6-47d6-ac5d-a633ef7d84bb' AND TemporalNamespaceDivision is null ORDER BY coalesce(close_time, cast('9999-12-31 23:59:59' as datetime)) DESC, start_time DESC, run_id LIMIT 1000\\G;\r\n*************************** 1. row ***************************\r\n           id: 1\r\n  select_type: SIMPLE\r\n        table: ev\r\n   partitions: NULL\r\n         type: ref\r\npossible_keys: PRIMARY,default_idx,by_execution_time,by_workflow_id,by_workflow_type,by_status,by_history_length,by_task_queue,by_temporal_change_version,by_binary_checksums,by_batcher_user,by_temporal_scheduled_start_time,by_temporal_scheduled_by_id,by_temporal_schedule_paused,by_temporal_namespace_division\r\n          key: PRIMARY\r\n      key_len: 256\r\n          ref: const\r\n         rows: 1549921\r\n     filtered: 10.00\r\n        Extra: Using where; Using filesort\r\n*************************** 2. row ***************************\r\n           id: 1\r\n  select_type: SIMPLE\r\n        table: custom_search_attributes\r\n   partitions: NULL\r\n         type: eq_ref\r\npossible_keys: PRIMARY,by_bool_01,by_bool_02,by_bool_03,by_datetime_01,by_datetime_02,by_datetime_03,by_double_01,by_double_02,by_double_03,by_int_01,by_int_02,by_int_03,by_keyword_01,by_keyword_02,by_keyword_03,by_keyword_04,by_keyword_05,by_keyword_06,by_keyword_07,by_keyword_08,by_keyword_09,by_keyword_10,by_keyword_list_01,by_keyword_list_02,by_keyword_list_03\r\n          key: PRIMARY\r\n      key_len: 512\r\n          ref: const,temporal_visibility.ev.run_id\r\n         rows: 1\r\n     filtered: 100.00\r\n        Extra: Using where; Using index\r\n2 rows in set, 1 warning (0.01 sec)\r\n\r\nmysql> explain analyze SELECT ev.namespace_id, ev.run_id, ev.workflow_type_name, ev.workflow_id, ev.start_time, ev.execution_time, ev.status, ev.close_time, ev.history_length, ev.memo, ev.encoding, ev.task_queue, ev.search_attributes FROM executions_visibility ev LEFT JOIN custom_search_attributes USING (namespace_id, run_id) WHERE namespace_id = 'f458436c-e0b6-47d6-ac5d-a633ef7d84bb' AND TemporalNamespaceDivision is null ORDER BY coalesce(close_time, cast('9999-12-31 23:59:59' as datetime)) DESC, start_time DESC, run_id LIMIT 1000\\G;\r\n*************************** 1. row ***************************\r\nEXPLAIN: -> Limit: 1000 row(s)  (cost=210064.29 rows=1000) (actual time=20665.083..20675.554 rows=1000 loops=1)\r\n    -> Nested loop left join  (cost=210064.29 rows=1549921) (actual time=20665.081..20675.468 rows=1000 loops=1)\r\n        -> Sort: coalesce(close_time,cast(_utf8mb4'9999-12-31 23:59:59' as datetime)) DESC, ev.start_time DESC, ev.run_id  (cost=16324.17 rows=1549921) (actual time=20665.033..20665.540 rows=1000 loops=1)\r\n            -> Filter: ((ev.namespace_id = 'f458436c-e0b6-47d6-ac5d-a633ef7d84bb') and (ev.TemporalNamespaceDivision is null))  (actual time=0.038..8314.438 rows=3205388 loops=1)\r\n                -> Index lookup on ev using PRIMARY (namespace_id='f458436c-e0b6-47d6-ac5d-a633ef7d84bb')  (actual time=0.035..6668.868 rows=3205388 loops=1)\r\n        -> Filter: (custom_search_attributes.namespace_id = 'f458436c-e0b6-47d6-ac5d-a633ef7d84bb')  (cost=0.25 rows=1) (actual time=0.010..0.010 rows=0 loops=1000)\r\n            -> Single-row covering index lookup on custom_search_attributes using PRIMARY (namespace_id='f458436c-e0b6-47d6-ac5d-a633ef7d84bb', run_id=ev.run_id)  (cost=0.25 rows=1) (actual time=0.010..0.010 rows=0 loops=1000)\r\n\r\n1 row in set (20.96 sec)\r\n\r\n```\r\n\r\nIt took 20 seconds to execute the SQL query.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Upgrade to v1.20.1\r\n  1. About 300w rows in temporal_visibility\r\n  1. Run temporal\r\n  2. Execute `show processlist` in MySQL \r\n\r\n## Specifications\r\n\r\n  - Version: Temporal: v1.20.1,  MySQL: 8.0.29\r\n  - Platform: K8S\r\n","closedAt":null,"comments":[],"createdAt":"2023-04-10T03:37:10Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4149,"reactionGroups":[],"state":"OPEN","title":"​ Version v1.20.1 had slow query in temporal_visibility","updatedAt":"2023-04-10T03:48:45Z","url":"https://github.com/temporalio/temporal/issues/4149"}
