{"assignees":[],"author":{"id":"MDQ6VXNlcjE2Nzg3NzI=","is_bot":false,"login":"elucidator","name":"Pieter van der Meer"},"body":"## Expected Behavior\r\nBefore start check if a specific namespace is available, when not available create the namespace and register activities and workflows.\r\n\r\nWhen registering the workflow/activies all is well and Pollers are started correctly without errors.\r\n\r\n## Actual Behavior\r\nAfter registration of the namespace all of the roller report the following stacktrace:\r\n\r\n```\r\n2021-02-04 10:14:12.422 ERROR 76618 --- [kflow Poller: 5] io.temporal.internal.worker.Poller       : Failure in thread Host Local Workflow Poller: 5\r\nio.grpc.StatusRuntimeException: NOT_FOUND: namespace: [MY_NAMESPACE] not found\r\n\tat io.grpc.stub.ClientCalls.toStatusRuntimeException(ClientCalls.java:262) ~[grpc-stub-1.34.1.jar:1.34.1]\r\n\tat io.grpc.stub.ClientCalls.getUnchecked(ClientCalls.java:243) ~[grpc-stub-1.34.1.jar:1.34.1]\r\n\tat io.grpc.stub.ClientCalls.blockingUnaryCall(ClientCalls.java:156) ~[grpc-stub-1.34.1.jar:1.34.1]\r\n\tat io.temporal.api.workflowservice.v1.WorkflowServiceGrpc$WorkflowServiceBlockingStub.pollActivityTaskQueue(WorkflowServiceGrpc.java:2696) ~[temporal-serviceclient-1.0.4.jar:na]\r\n\tat io.temporal.internal.worker.ActivityPollTask.poll(ActivityPollTask.java:105) ~[temporal-sdk-1.0.4.jar:na]\r\n\tat io.temporal.internal.worker.ActivityPollTask.poll(ActivityPollTask.java:39) ~[temporal-sdk-1.0.4.jar:na]\r\n\tat io.temporal.internal.worker.Poller$PollExecutionTask.run(Poller.java:265) ~[temporal-sdk-1.0.4.jar:na]\r\n\tat io.temporal.internal.worker.Poller$PollLoopTask.run(Poller.java:241) ~[temporal-sdk-1.0.4.jar:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[na:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[na:na]\r\n\tat java.base/java.lang.Thread.run(Thread.java:834) ~[na:an]\r\n```\t\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Create namespace:\r\n  ```\r\n  val registerNamespaceRequest = RegisterNamespaceRequest.newBuilder()\r\n        .setNamespace(namespace)\r\n        .setWorkflowExecutionRetentionPeriod(Durations.fromDays(retentionPeriod))\r\n        .build()\r\n\r\n      service.blockingStub().registerNamespace(registerNamespaceRequest)\r\n  ```\r\n  \r\n  2. Start/register workflow\r\n  \r\n  ```\r\n  val workflowClientOptions = WorkflowClientOptions.newBuilder().setNamespace(namespace).build()\r\n\r\n   client = WorkflowClient.newInstance(service, workflowClientOptions)\r\n   \r\n   val factory = WorkerFactory.newInstance(client)\r\n    val workerForCommonTaskQueue = factory.newWorker(TASK_QUEUE)\r\n    workerForCommonTaskQueue.registerWorkflowImplementationTypes([MyWorkflowImpl]::class.java)\r\n    workerForCommonTaskQueue.registerActivitiesImplementations([MyActivities])\r\n  ```\r\n  \r\nClosing connection and inserting delays between registration of namespace and registration of workflow seems to help but is not consistent.\r\n\r\nCalls to \r\n```\r\nreportedNamespace?.isInitialized\r\nreportedNamespace?.namespaceInfo?.state\r\n```\r\nReport that it is initialized and Registerd\r\n\r\n## Specifications\r\n\r\n  - Version: SDK 1.0.5\r\n  - Platform: Temporal -> 1.4.0, 1.6.1 \r\n  - Env: kotlin 1.4, Jvm 11\r\n","closedAt":"2023-06-24T03:03:08Z","comments":[{"id":"IC_kwDODNqesM429gKY","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"As we discussed with @mmcshane, `createNamespace`, `listNamespaces` and other namespace-focused APIs read and write directly to the database, while other APIs (like activity/workflow worker long polls) use a namespace cache. This cache is not a read-thought or write-through cache and takes about 10s to be updated.\r\nAs the result, there is not only a usability issue with users not being able to use namespace right after creation, but it looks like right now we lack a simple API to check if the namespace was actually propagated to the cache because namespace-centric APIs doesn't use the cache.\r\n","createdAt":"2021-09-17T21:29:09Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1941#issuecomment-922092184","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5B7MoO","author":{"login":"vcardenas"},"authorAssociation":"NONE","body":"I stumbled upon the same issue just now that I am upgrading from 1.13.1 to 1.16.1 and I was going to open an issue but then I found this one with the same underlying cause I think.\r\n\r\nIt is easy to reproduce with a simple register-namespace followed by a describe-namespace operation using tctl (although it first happened to me using the java sdk). As per a previous comment it should work because supposedly these are not cached operations, but reality says otherwise.\r\n\r\n**How to reproduce:**\r\n\r\n1. Checkout the [Temporal docker compose project](https://github.com/temporalio/docker-compose). (Temporal 1.16.1 at the writing date of this comment)\r\n2. Start up any variant, for example\r\n`docker-compose -f docker-compose-postgres.yml up`\r\n3. Once is up and ready, create and describe a namespace using for example this helper script\r\n```\r\n#!/bin/bash\r\n# file: create_namespace.sh\r\n\r\nVALUE_NS=\"${1:-testns}\"\r\ntctl() {\r\n  docker exec temporal-admin-tools tctl \"$@\"\r\n}\r\n\r\ntctl --namespace \"$VALUE_NS\" namespace register\r\nuntil tctl --namespace \"$VALUE_NS\" namespace describe ; do\r\n  echo \" *** Retrying... *** \"\r\n  sleep .5\r\ndone\r\n\r\n```\r\nExecute `./create_namespace.sh myns`\r\n\r\nYou will see an output like:\r\n```\r\nNamespace myns successfully registered.\r\nError: Operation DescribeNamespace failed.\r\nError Details: rpc error: code = NotFound desc = Namespace name \"myns\" not found\r\n('export TEMPORAL_CLI_SHOW_STACKS=1' to see stack traces)\r\n *** Retrying... ***\r\n```\r\nIt will eventually succeed within 2-10 seconds.\r\n\r\nIn 1.13.x this issue does not show up, ever.\r\nAll versions from 1.14.x up to the current 1.16.1 are affected.\r\nSame results using either tctl or the Java sdk at least.\r\n\r\nYou can edit the `.env` file to try with different Temporal versions easily.\r\n\r\nAs a workaround you can implement a polling logic or an artificial delay before you can start to use your new namespace, although both approaches equally undesirable.","createdAt":"2022-04-22T05:56:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1941#issuecomment-1106037262","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5B9_h8","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"This is a known issue, and it is not as easy to fix due to complication in cross namespace replication failover notification requirement. \r\nGood news is that, we are working on fixing this. We are currently working on restructure the background task processing logic, which will then remove the requirement of reliable notification for the namespace failover. After that, we can make the namespace cache read through and the problem will be gone. ETA for this is about 3 months, mainly because the rework on the task processing logic is a big under take.\r\n\r\nFor now, you have to add a 10s delay after you register your new namespace.\r\nWe are sorry about the inconvenient, but we are actively working on it.\r\n","createdAt":"2022-04-22T18:45:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":4}}],"url":"https://github.com/temporalio/temporal/issues/1941#issuecomment-1106770044","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5frhX6","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"This is fixed by https://github.com/temporalio/temporal/pull/3908","createdAt":"2023-06-24T03:03:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1941#issuecomment-1605244410","viewerDidAuthor":false}],"createdAt":"2021-02-04T09:20:49Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg0","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1941,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"Newly registered namespace not available when polling workflow/activity tasks","updatedAt":"2023-06-24T03:03:08Z","url":"https://github.com/temporalio/temporal/issues/1941"}
