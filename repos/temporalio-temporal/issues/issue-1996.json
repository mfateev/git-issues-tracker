{"assignees":[{"id":"MDQ6VXNlcjg0NDExMDE0","login":"yiminc","name":"Yimin Chen","databaseId":0}],"author":{"id":"MDQ6VXNlcjE3NTA2NDQx","is_bot":false,"login":"rfwagner","name":"Richard Wagner"},"body":"We would like to see a new extension point in the form of a ServerOption that lets us plug in our own gRPC request rate limiting logic to the frontend service.\r\n\r\nThe basic scenario is that we are running a multi-tenant service at scale and we need to enforce RPS limits on various aspects of namespace-specific customer workload in order to guarantee a good experience for all customers. Examples of such RPS rate limiting would be limits on new workflows/sec, new activities/sec, new signals/sec, new timers/sec.\r\n\r\nOur thought is that we would enforce rate limiting at this relatively high level of abstraction - directly related to the API calls that customers are making in their app level code - so that customers can tell us in advance expected loads in terms that they can easily understand and project, and we can enforce limits at these levels with no additional (and potentially fuzzy) math involved in translating to lower level numbers like persistence requests/sec or overall gRPC requests/sec.\r\n\r\nAs an initial strawman proposal we were thinking of adding a new ServerOption that looked like:\r\n\r\n```\r\nfunc WithRateLimiterInterceptor(rateLimiterInterceptor grpc.UnaryServerInterceptor) ServerOption {\r\n\treturn newApplyFuncContainer(func(s *serverOptions) {\r\n\t\ts.rateLimiterInterceptor = rateLimiterInterceptor\r\n\t})\r\n}\r\n```\r\n\r\nIf supplied, this interceptor would be used in place of the one that is currently configured here: https://github.com/temporalio/temporal/blob/64ef4e223785fd5ba77c51de9101157e53092820/service/frontend/service.go#L241\r\n\r\nThe idea behind allowing operators to plug in an actual gRPC `UnaryServerInterceptor` is that this gives us the ultimate flexibility to inspect the inbound gRPC request. We can inspect not only the endpoint being called but also the payload. For example, we could inspect a `RespondWorkflowTaskCompletedRequest` protobuf and look at the included `Commands` to see new activities and signals being requested. ","closedAt":"2021-11-10T19:39:01Z","comments":[{"id":"IC_kwDODNqesM432Yr0","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"We would make an extension point for general purpose custom interceptors.\r\n\r\n```\r\nfunc WithChainedFrontendGrpcInterceptors(\r\n\tinterceptors ...grpc.UnaryServerInterceptor,\r\n) ServerOption {\r\n\treturn newApplyFuncContainer(func(s *serverOptions) {\r\n\t\ts.interceptors = interceptors\r\n\t})\r\n}\r\n```\r\nUser can supply multiple ordered interceptors. The list of custom interceptors will be appended to the end of the [internal ServerInterceptors](https://github.com/temporalio/temporal/blob/2c52fd61776b64167a3220c55f156f5e6f65359a/service/frontend/service.go#L288-L301). The custom interceptors will be invoked in the order as they appear in the supplied list, after the internal ServerInterceptors. \r\n\r\nThis is for general purpose, not limiting to rate limiter. The default namespace rate limiter would still apply, and you can disable that by dynamic config if you want to have your own rate limiting logic supplied as custom interceptor.\r\n\r\n@rfwagner does the above proposal looks good to you?\r\n","createdAt":"2021-10-06T19:49:24Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/1996#issuecomment-937003764","viewerDidAuthor":false},{"id":"IC_kwDODNqesM44COts","author":{"login":"rfwagner"},"authorAssociation":"NONE","body":"@yiminc yes, this looks good thanks! I like the generality if this. Allowing operators to supply arbitrary interceptors will come in handy for sure. And it should suit at least our initial needs for custom frontend rate-limiting. Thanks.","createdAt":"2021-10-11T15:00:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1996#issuecomment-940108652","viewerDidAuthor":false},{"id":"IC_kwDODNqesM45ganZ","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Merged PR https://github.com/temporalio/temporal/pull/2156","createdAt":"2021-11-10T05:23:28Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1996#issuecomment-964798937","viewerDidAuthor":false}],"createdAt":"2021-09-29T22:13:59Z","labels":[],"milestone":null,"number":1996,"reactionGroups":[],"state":"CLOSED","title":"Provide ServerOption for custom frontend service rate limiting ","updatedAt":"2021-11-10T19:39:01Z","url":"https://github.com/temporalio/temporal/issues/1996"}
