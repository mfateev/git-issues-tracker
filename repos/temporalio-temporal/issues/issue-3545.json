{"assignees":[],"author":{"id":"U_kgDOBaJ48w","is_bot":false,"login":"ddavidyuk","name":""},"body":"## Expected Behavior\r\nNo errors in history / frontend, Temporal can successfully handle 5k workflows with disabled workflow history cache.\r\n\r\n## Actual Behavior\r\nWe started around 5k workflows with the following dynamic config (disabled workflow history cache):\r\n```yaml\r\nsystem.advancedVisibilityWritingMode:\r\n  - value: \"on\"\r\n    constraints: {}\r\nsystem.enableReadVisibilityFromES:\r\n  - value: true\r\n    constraints: {}\r\nlimit.maxIDLength:\r\n  - value: 255\r\n    constraints: {}\r\nhistory.timerProcessorEnableMultiCursor:\r\n  - value: true\r\nhistory.timerProcessorEnablePriorityTaskScheduler:\r\n  - value: true\r\nhistory.transferProcessorEnableMultiCursor:\r\n  - value: true\r\nhistory.transferProcessorEnablePriorityTaskScheduler:\r\n  - value: true\r\nhistory.visibilityProcessorEnableMultiCursor:\r\n  - value: true\r\nhistory.visibilityProcessorEnablePriorityTaskScheduler:\r\n  - value: true\r\n# Remove this after upgrading to 1.19:\r\nmatching.useOldRouting:\r\n  - value: false\r\nhistory.cacheInitialSize:\r\n  - value: 0\r\nhistory.cacheMaxSize:\r\n  - value: 0\r\n```\r\n\r\nAfter some time we observed that Temporal stopped making any progress on any of the workflows, with errors like this in the frontend service:\r\n```\r\n1/10/2022 15:18:34{\"level\":\"error\",\"ts\":\"2022-10-31T12:18:34.521Z\",\"msg\":\"getHistory: incomplete history\",\"service\":\"frontend\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:9336260:761259485868\",\"wf-run-id\":\"d145dab4-c360-49b6-a449-0d00b3a44913\",\"error\":\"Incomplete history: expected events [55-61] but got events [55-62] of length 8: isFirstPage=true,isLastPage=true,pageSize=256\",\"logging-call-at\":\"workflow_handler.go:4090\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/home/builder/temporal/common/log/zap_logger.go:143\\ngo.temporal.io/server/service/frontend.(*WorkflowHandler).getHistory\\n\\t/home/builder/temporal/service/frontend/workflow_handler.go:4090 ... \"}\r\n31/10/2022 15:29:21{\"level\":\"error\",\"ts\":\"2022-10-31T12:29:21.917Z\",\"msg\":\"getHistory: incomplete history\",\"service\":\"frontend\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"error\":\"Incomplete history: expected events [7619-7925] but got events [7619-7924] of length 306: isFirstPage=false,isLastPage=true,pageSize=256\",\"logging-call-at\":\"workflow_handler.go:4090\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/home/builder/temporal/common/log/zap_logger.go:143\\ngo.temporal.io/server/service/frontend.(*WorkflowHandler).getHistory\\n\\t/home/builder/temporal/service/frontend/workflow_handler.go:4090...\"}\r\n\r\n```\r\n\r\nhistory service:\r\n```\r\n31/10/2022 15:34:17{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:17.055Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"context deadline exceeded\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:17{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:17.131Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7042, actually 7043.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:17{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:17.204Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7042, actually 7043.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:17{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:17.276Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7042, actually 7043.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:17{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:17.386Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7043, actually 7044.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:17{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:17.527Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7042, actually 7044.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:17{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:17.527Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"context canceled\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:17{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:17.680Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7043, actually 7044.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:17{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:17.769Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7042, actually 7044.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:17{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:17.847Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7043, actually 7044.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:17{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:17.914Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7043, actually 7044.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:17{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:17.981Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7043, actually 7044.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:18{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:18.058Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7042, actually 7044.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:18{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:18.132Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7043, actually 7044.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:18{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:18.216Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7044, actually 7045.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:18{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:18.301Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7044, actually 7045.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:18{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:18.415Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7043, actually 7045.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:18{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:18.523Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7044, actually 7045.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:18{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:18.609Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7044, actually 7045.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:18{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:18.681Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7044, actually 7045.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:18{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:18.746Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7044, actually 7045.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:18{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:18.819Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7044, actually 7045.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:18{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:18.819Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"context canceled\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:18{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:18.888Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7044, actually 7045.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:18{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:18.971Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7044, actually 7045.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:19{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:19.062Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7045, actually 7046.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:19{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:19.143Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7045, actually 7046.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:19{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:19.228Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7045, actually 7046.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:19{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:19.340Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7045, actually 7046.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n31/10/2022 15:34:19{\"level\":\"error\",\"ts\":\"2022-10-31T12:34:19.449Z\",\"msg\":\"Update workflow execution operation failed.\",\"shard-id\":127,\"address\":\"10.42.255.94:7234\",\"wf-namespace-id\":\"6555cbb5-97a6-4a72-8166-975258a392ad\",\"wf-id\":\"TEST_WORKFLOW:4350838\",\"wf-run-id\":\"d7c67a79-75bd-403c-b4c0-bc9d21e4571a\",\"store-operation\":\"update-wf-execution\",\"error\":\"lockAndCheckExecution failed. DBRecordVersion expected: 7045, actually 7046.\",\"logging-call-at\":\"transaction_impl.go:464\",\"stacktrace\":\"...\"}\r\n  ```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Disable workflow history cache via dynamic config, restart the history service\r\n  1. Start 5k workflows\r\n\r\n## Specifications\r\n- Temporal v1.18.3, 1 history, 1 frontend, 1 matching, 1 worker instance\r\n- Temporal Java SDK 1.17.0\r\n- Number of shards: 512\r\n- MySQL persistence","closedAt":"2022-11-05T03:09:46Z","comments":[{"id":"IC_kwDODNqesM5NbjzH","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"@ddavidyuk does the issue repro if you don't disable history cache? What is the intention here to disable history cache?","createdAt":"2022-11-01T20:01:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3545#issuecomment-1299070151","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5Nb_Dc","author":{"login":"ddavidyuk"},"authorAssociation":"NONE","body":"@yiminc it does not reproduce with enabled history cache, the intention was to measure how much memory the history workflow cache consumes on our workload (without the event cache): we know the memory footprint when the cache is enabled, I assume if we substract the memory consumed when the cache is disabled we'll get an estimate for the cache size.\r\nMore context is here: https://community.temporal.io/t/memory-leak-in-temporal-history-service-v1-18-3/6361\r\n","createdAt":"2022-11-01T21:13:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3545#issuecomment-1299181788","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5NkuvC","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Instead of completely disable the cache size, you can reduce its size. For example, try to set it to a relatively small number like 32 and see if it solve your memory issue.\r\nComment on the community forum post as well.","createdAt":"2022-11-02T23:05:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3545#issuecomment-1301474242","viewerDidAuthor":false}],"createdAt":"2022-10-31T14:41:43Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":3545,"reactionGroups":[],"state":"CLOSED","title":"lockAndCheckExecution failed. DBRecordVersion expected: 7045, actually 7046 when running with disabled workflow history cache","updatedAt":"2022-11-05T03:09:46Z","url":"https://github.com/temporalio/temporal/issues/3545"}
