{"assignees":[{"id":"MDQ6VXNlcjIyMzI1MjQ=","login":"alexshtin","name":"Alex Shtin","databaseId":0}],"author":{"id":"MDQ6VXNlcjQ3MTUwMjI2","is_bot":false,"login":"yngfoxx","name":"Stephen Osunrinde"},"body":"## Expected Behavior\r\nThe temporal/auto-setup docker container should start and I should be able to access the temporal/ui service\r\n\r\n## Actual Behavior\r\ntemporal/auto-setup container stuck at the error as shown below:\r\n```\r\n[Fx] PROVIDE    fx.Lifecycle <= go.uber.org/fx.New.func1()\r\n[Fx] PROVIDE    fx.Shutdowner <= go.uber.org/fx.(*App).shutdowner-fm()\r\n[Fx] PROVIDE    fx.DotGraph <= go.uber.org/fx.(*App).dotGraph-fm()\r\n[Fx] PROVIDE    *temporal.ServerImpl <= go.temporal.io/server/temporal.NewServerFxImpl()\r\n[Fx] PROVIDE    *temporal.serverOptions <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    chan interface {} <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    temporal.synchronizationModeParams <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    *config.Config <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    *config.PProf <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    log.Config <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    resource.ServiceNames <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    resource.NamespaceLogger <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    resolver.ServiceResolver <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    client.AbstractDataStoreFactory <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    visibility.VisibilityStoreFactory <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    searchattribute.Mapper <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    []grpc.UnaryServerInterceptor <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    authorization.Authorizer <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    authorization.ClaimMapper <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    authorization.JWTAudienceMapper <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    map[primitives.ServiceName]static.Hosts <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    log.Logger <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    client.FactoryProvider <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    dynamicconfig.Client <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    encryption.TLSConfigProvider <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    *client.Config <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    client.Client <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    metrics.Handler <= go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] PROVIDE    archiver.ArchivalMetadata <= go.temporal.io/server/common/resource.ArchivalMetadataProvider()\r\n[Fx] PROVIDE    tasks.TaskCategoryRegistry <= go.temporal.io/server/temporal.TaskCategoryRegistryProvider()\r\n[Fx] PROVIDE    client.FactoryProviderFn <= go.temporal.io/server/temporal.PersistenceFactoryProvider()\r\n[Fx] PROVIDE    *temporal.ServicesMetadata[group = \"services\"] <= go.temporal.io/server/temporal.HistoryServiceProvider()\r\n[Fx] PROVIDE    *temporal.ServicesMetadata[group = \"services\"] <= go.temporal.io/server/temporal.MatchingServiceProvider()\r\n[Fx] PROVIDE    *temporal.ServicesMetadata[group = \"services\"] <= go.temporal.io/server/temporal.FrontendServiceProvider()\r\n[Fx] PROVIDE    *temporal.ServicesMetadata[group = \"services\"] <= go.temporal.io/server/temporal.InternalFrontendServiceProvider()\r\n[Fx] PROVIDE    *temporal.ServicesMetadata[group = \"services\"] <= go.temporal.io/server/temporal.WorkerServiceProvider()\r\n[Fx] PROVIDE    *cluster.Config <= go.temporal.io/server/temporal.ApplyClusterMetadataConfigProvider()\r\n[Fx] PROVIDE    config.Persistence <= go.temporal.io/server/temporal.ApplyClusterMetadataConfigProvider()\r\n[Fx] PROVIDE    *dynamicconfig.Collection <= go.temporal.io/server/common/dynamicconfig.init.func1()\r\n[Fx] PROVIDE    pingable.Pingable[group = \"deadlockDetectorRoots\"] <= fx.Annotate(go.temporal.io/server/common/dynamicconfig.init.func2(), fx.ResultTags([\"group:\\\"deadlockDetectorRoots\\\"\"])\r\n[Fx] PROVIDE    *pprof.PProfInitializerImpl <= go.temporal.io/server/common/pprof.NewInitializer()\r\n[Fx] PROVIDE    []trace.SpanExporter <= go.temporal.io/server/temporal.init.func2()\r\n[Fx] SUPPLY     []temporal.ServerOption\r\n[Fx] RUN        supply: stub([]temporal.ServerOption)\r\n[Fx] RUN        provide: go.temporal.io/server/temporal.ServerOptionsProvider()\r\n[Fx] Error returned: received non-nil error from function \"go.temporal.io/server/temporal\".ServerOptionsProvider\r\n        /home/runner/work/docker-builds/docker-builds/temporal/temporal/fx.go:184:\r\nsql schema version compatibility check failed: unable to read DB schema version keyspace/database: temporal error: no usable database connection found\r\n[Fx] ERROR              Failed to initialize custom logger: could not build arguments for function \"go.uber.org/fx\".(*module).constructCustomLogger.func2\r\n        /home/runner/go/pkg/mod/go.uber.org/fx@v1.22.0/module.go:292:\r\nfailed to build fxevent.Logger:\r\ncould not build arguments for function \"go.temporal.io/server/temporal\".init.func8\r\n        /home/runner/work/docker-builds/docker-builds/temporal/temporal/fx.go:1004:\r\nfailed to build log.Logger:\r\nreceived non-nil error from function \"go.temporal.io/server/temporal\".ServerOptionsProvider\r\n        /home/runner/work/docker-builds/docker-builds/temporal/temporal/fx.go:184:\r\nsql schema version compatibility check failed: unable to read DB schema version keyspace/database: temporal error: no usable database connection found\r\nUnable to create server. Error: could not build arguments for function \"go.uber.org/fx\".(*module).constructCustomLogger.func2 (/home/runner/go/pkg/mod/go.uber.org/fx@v1.22.0/module.go:292): failed to build fxevent.Logger: could not build arguments for function \"go.temporal.io/server/temporal\".init.func8 (/home/runner/work/docker-builds/docker-builds/temporal/temporal/fx.go:1004): failed to build log.Logger: received non-nil error from function \"go.temporal.io/server/temporal\".ServerOptionsProvider (/home/runner/work/docker-builds/docker-builds/temporal/temporal/fx.go:184): sql schema version compatibility check failed: unable to read DB schema version keyspace/database: temporal error: no usable database connection found.\r\n```\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Run an azure postgre database in a private network (vnet)\r\n  2. From a vm in the same network, setup temporal/auto-setup:latest, temporal/ui:latest, temporal/admin-tools:latest\r\n  3. temporal/auto-setup will emit the error\r\n\r\n## Specifications\r\n\r\n  - Version: latest (as of 2024-10-08)\r\n  - Platform: Azure & Docker\r\n","closedAt":"2024-11-19T05:19:02Z","comments":[{"id":"IC_kwDODNqesM6UGflq","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"Sorry for late response. Yes, this message is confusing. This is because we do database connection initialization using `fx` which is probably wrong. Your Temporal container doesn't have access to the database:\r\n```\r\nsql schema version compatibility check failed: unable to read DB schema version keyspace/database: temporal error: no usable database connection found\r\n```\r\nOn a startup, server, first reads schema version from DB to make sure it matches. And it needs DB connection for it. You need to check if database is accessible from `auto-setup` container.","createdAt":"2024-11-19T05:18:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/6628#issuecomment-2484730218","viewerDidAuthor":false}],"createdAt":"2024-10-08T22:35:40Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":6628,"reactionGroups":[],"state":"CLOSED","title":" Error returned: received non-nil error from function","updatedAt":"2024-11-19T05:19:02Z","url":"https://github.com/temporalio/temporal/issues/6628"}
