{"assignees":[],"author":{"id":"MDQ6VXNlcjE0NjM2MjI=","is_bot":false,"login":"mfateev","name":"Maxim Fateev"},"body":"Currently all blob payload fields do not have any associated metadata. It works only in monolithic applications, but might cause a lot of compatibility issues when Temporal is used as an asynchronous service mesh that connects multiple services. Another problem is that migrating applications from one encoding scheme to another is practically impossible while workflows are running. \r\nThe strawman solution is to change all the binary blobs to `Payload` (name is up to the discussion) which includes [Header](https://github.com/temporalio/temporal-proto/blob/143d7e4a16830e2e433c019713300b5a2ad54c75/common/common.proto#L50) field.\r\nThis would allow to specify something like: _this is an encrypted field with ## version of certificate, gziped, JSON encoded._\r\n\r\nThe API proposal (Header already exists at [common.proto](https://github.com/temporalio/temporal-proto/blob/143d7e4a16830e2e433c019713300b5a2ad54c75/common/common.proto#L50))\r\n```\r\nmessage Header {\r\n    map<string, bytes> fields = 1;\r\n}\r\n\r\nmessage Payload {\r\n    Header header = 1;\r\n    bytes data = 2;\r\n}\r\n```\r\nThen, for example,`ActivityTaskCompletedEventAttributes` change from:\r\n```\r\nmessage ActivityTaskCompletedEventAttributes {\r\n    bytes result = 1;\r\n    int64 scheduledEventId = 2;\r\n    int64 startedEventId = 3;\r\n    string identity = 4;\r\n}\r\n```\r\nto\r\n```\r\nmessage ActivityTaskCompletedEventAttributes {\r\n    Payload result = 1;\r\n    int64 scheduledEventId = 2;\r\n    int64 startedEventId = 3;\r\n    string identity = 4;\r\n}\r\n```\r\nA possible alternative that potentially reduces the size of the Payload is to use an enum instead of string for metadata key names. But having that the size of payloads measures in hundreds of kilobytes I'm not sure if it is worth the complexity.","closedAt":"2020-04-27T21:50:58Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDYwNzQ5MTE0Mw==","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"Previous issue #25.","createdAt":"2020-04-01T21:09:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/107#issuecomment-607491143","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDYwNzU4NjE1Mg==","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"I don't want to reuse `Header` as soon as they are `TransportHeader` essentially (perhaps we should rename it). Actually we don't need separate message at all. Let it be just:\r\n```\r\nmessage Payload {\r\n    map<string,bytes> metadata = 1;\r\n    bytes data = 2;\r\n}\r\n```\r\nLet's also define constants for system metadata keys/values. For now we have only encoding:\r\n```\r\nconst encoding = \"encoding\"\r\nconst encodingJson = \"json\"\r\nconst encodingProto = \"proto\"\r\n```\r\n\r\n`bytes` usages in proto files fall into following categories:\r\n1. `details`: 18 fields (history.proto, workflow_execution.proto, decision.proto),\r\n2. `result`: 6 fields (history.proto, decision.proto),\r\n3. `control`: 10 fields (history.proto, decision.proto),\r\n4. `input`: 10 fields (history.proto, decision.proto).\r\n5. Also there are 2 specific cased in common.proto:\r\n```\r\nmessage WorkflowQuery {\r\n    string queryType = 1;\r\n    bytes queryArgs = 2;\r\n}\r\n\r\nmessage WorkflowQueryResult {\r\n    enums.QueryResultType resultType = 1;\r\n    bytes answer = 2;\r\n    string errorMessage = 3;\r\n}\r\n```\r\nMost usages, I've seen just pass whatever is in request to attributes or from attributes to attributes. Changing all at once shouldn't be hard.\r\n\r\nMy general plan is to convert 4 cases from list above (1,2,4,5) to `Payload` and convert `control` to `string` (and likely removed in future). There might be some exceptions, like `details` might be used as `string`, then it will be converted to `string`. Basically goal is not to have `bytes` at all but `Payload` or `string`.\r\n\r\nAlso we have similar message type `common.DataBlob` which is used 11 times. It is uses mostly internally and for `rawHistory`. I would convert this to `Payload` also.\r\n\r\n","createdAt":"2020-04-02T02:28:58Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/107#issuecomment-607586152","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDYxMDA4OTc2NA==","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"After initial implementation, I came up with another idea. Current implementation has special [case](https://github.com/temporalio/temporal-go-sdk/blob/master/internal/encoded.go#L77) for single argument of type `[]byte`. The idea is to extend this optimization and encode every argument separately with its own metadata. Set encoding to `raw` for `[]byte` arguments.\r\n\r\nAlso add argument name as one more metadata value. It won't be used by deserializer to allow arguments rename: code will only rely on arguments sequence but not names.\r\n\r\nGiving this, new proto structure will look like:\r\n```\r\nmessage Payload {\r\n    repeated PayloadItem items = 1;\r\n}\r\n\r\nmessage PayloadItem {\r\n    map<string,bytes> metadata = 1;\r\n    bytes data = 2;\r\n}\r\n```\r\n\r\nCode constants:\r\n```\r\nconst encodingMetadata = \"encoding\"\r\nconst encodingMetadataJson = \"json\"\r\nconst encodingMetadataRaw = \"raw\"\r\nconst encodingMetadataProto = \"proto\"\r\n\r\nconst nameMetadata = \"name\"\r\n```\r\n\r\nLogically serialization of `userId int, profile UserProfile, image []byte` will look like:\r\n```\r\nitems: [{\r\n  metadata: {\r\n    name: \"userId\",\r\n    encoding: \"json\",\r\n  },\r\n  data: <userId value serialized using json.Marshal>,\r\n},\r\n{\r\n  metadata: {\r\n    name: \"profile\",\r\n    encoding: \"json\",\r\n  },\r\n  data: <profile value serialized using json.Marshal>,\r\n},\r\n{\r\n  metadata: {\r\n    name: \"image\",\r\n    encoding: \"raw\",\r\n  },\r\n data: <image value as it is>,\r\n}]\r\n```","createdAt":"2020-04-06T23:32:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/107#issuecomment-610089764","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDYxMTg5NTQ3OA==","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"One interesting case is [localActivityMarkerData](https://github.com/temporalio/temporal-go-sdk/blob/b085d9912d4a580a654ae8bfcd89a515e0ebcd7c/internal/internal_event_handlers.go#L144):\r\n```\r\nlocalActivityMarkerData struct {\r\n\tActivityID   string        `json:\"activityId,omitempty\"`\r\n\tActivityType string        `json:\"activityType,omitempty\"`\r\n\tErrReason    string        `json:\"errReason,omitempty\"`\r\n\tErrJSON      string        `json:\"errJson,omitempty\"` // string instead of []byte so the encoded blob is human readable\r\n\tResultJSON   string        `json:\"resultJson,omitempty\"`\r\n\tReplayTime   time.Time     `json:\"replayTime,omitempty\"`\r\n\tAttempt      int32         `json:\"attempt,omitempty\"` // record attempt, starting from 0.\r\n\tBackoff      time.Duration `json:\"backoff,omitempty\"` // retry backoff duration\r\n}\r\n```\r\nThis struct is serialized to JSON and has JSON fields. The idea here is to convert it to:\r\n```\r\nlocalActivityMarkerData struct {\r\n\tActivityID   string\r\n\tActivityType string\r\n\tErrReason    string\r\n\tErr          *commonpb.Payload\r\n\tResult       *commonpb.Payload\r\n\tReplayTime   time.Time\r\n\tAttempt      int32\r\n\tBackoff      time.Duration\r\n}\r\n```\r\nAnd serialize to `commopb.Payload` (the same as other fields) creating `commonpb.PayloadItem` for every field, specifying `name` and `encoding` (`json`) metadata. The only question is `*commonpb.Payload` types. I see two options:\r\n1. Add special case for this type and call the same encoding/decoding funcs recursively. New encoding type need to be introduced: `payload`, `proto-payload`, or we can use full proto type name `common.Payload`. In future, proto type itself can be saved to metadata.\r\n2. Add special case for all proto objects and serialize them to JSON using JSONPB.\r\n\r\nFirst approach gives us unlimited level of enveloping and more generic and robust code.\r\nWith second approach `Err` and `Result` fields will be human readable (although JSON will look like pseudo example above and I am not sure about `data` field).\r\n\r\nI would go with first option but will be glad to hear any feedback/input.\r\n","createdAt":"2020-04-10T06:13:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/107#issuecomment-611895478","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDYxMjEzNTM5MA==","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"Let's go with 1. Any payload should be human readable having that UI/CLI understand how to show them given metadata.","createdAt":"2020-04-10T17:33:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/107#issuecomment-612135390","viewerDidAuthor":true},{"id":"MDEyOklzc3VlQ29tbWVudDYxMzc0NDkyMw==","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"After more investigation and trying different approaches I end up with another idea. I removed `Err *commonpb.Payload` and `Result *commonpb.Payload` from the `localActivityMarkerData struct` and pass them as separate parameters to `ToData` func. This allows me not to deal with struct reflection. Custom struct deserialization is not an easy problem which I don't want to solve as part of  this change. \r\nI added another `encodingType=proto` and modified `DataConverter.ToData` and `DataConverter.FromData` to support any proto type. Proto types are serialized using binary proto serialization.\r\nGiving this, marker is saved as `common.Payload` with 3 items:\r\n- `marker localActivityMarkerData` (w/o `Result` and `Err` fields), encodingType=json,\r\n- `result *commonpb.Payload`, encodingType=proto,\r\n- `err *commonpb.Payload`, encodingType=proto.\r\n\r\nThis naturally fits all other `Payload` related changes.\r\n","createdAt":"2020-04-15T00:18:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/107#issuecomment-613744923","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDYxMzc0NzEwOA==","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"Future discussions here are:\r\n1. Replace similar types with `common.Payload`:\r\n- `common.Memo`\r\n- `common.Header`\r\n- `common.SearchAttributes`\r\n- `common.DataBlob`\r\n2. In addition to custom `DataConverter` which knows how to convert any set of arguments to `*commonpb.Payload` we might want to add field/type level converters for specific encoding types, i.e. convert one argument to `*commonpb.PayloadItem`. This will allow customers to override only specific logic but not entire `DataConverter` (which is big now).","createdAt":"2020-04-15T00:26:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/107#issuecomment-613747108","viewerDidAuthor":false}],"createdAt":"2020-02-01T22:26:32Z","labels":[],"milestone":{"number":1,"title":"Initial Temporal Release","description":"","dueOn":null},"number":107,"reactionGroups":[],"state":"CLOSED","title":"Add metadata header to all blob payload fields","updatedAt":"2020-04-27T21:50:58Z","url":"https://github.com/temporalio/temporal/issues/107"}
