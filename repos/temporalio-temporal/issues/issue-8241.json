{"assignees":[],"author":{"id":"U_kgDOCxMEXg","is_bot":false,"login":"oleg-kovrizhin-paradym","name":""},"body":"## Expected Behavior\n\nIntegration tests with Temporal should not actually sleep or wait when using `TestWorkflowEnvironment.sleep()`.  \nThe virtual time should advance instantly, regardless of other tests being executed before.\n\n## Actual Behavior\n\nIn some cases, tests sleep and wait in real time instead of using virtual time.  \nThis happens when a test using `TestWorkflowEnvironment.sleep()` runs after another test that executed a child workflow.\n\n## Steps to Reproduce the Problem\n\n1. Use Temporal library 1.30.1 with io.temporal:temporal-spring-boot-starter.\n\n2. Have a workflow with setStartDelay().\n \n3. Write an integration test that relies on TestWorkflowEnvironment.sleep(Duration.ofDays(1)).\n\n    When run in isolation, the test passes instantly (virtual time works).\n\n4. Add another test that uses a child workflow, e.g.:\n\n```\nTestWorkflow transferWorkflow =\n    Workflow.newChildWorkflowStub(\n        TestWorkflow.class,\n        ChildWorkflowOptions.newBuilder()\n            .setWorkflowId(\"test-id\")\n            .setTaskQueue(\"test-task-queues\")\n            .setParentClosePolicy(ParentClosePolicy.PARENT_CLOSE_POLICY_ABANDON)\n            .setWorkflowIdReusePolicy(WorkflowIdReusePolicy.WORKFLOW_ID_REUSE_POLICY_ALLOW_DUPLICATE)\n            .setRetryOptions(RetryOptions.newBuilder()\n                .setMaximumAttempts(MAXIMUM_ATTEMPTS)\n                .build())\n            .build()\n    );\n\n\nAsync.procedure(() -> transferWorkflow.test(test.testId()));\n\nPromise<WorkflowExecution> childExecution = Workflow.getWorkflowExecution(transferWorkflow);\nchildExecution.get();\n```\n\n\n5. Run the whole test suite.\n\nThe test with sleep(Duration.ofDays(1)) now sleeps in real time instead of advancing virtual time.\n\nNotes\n\nBehavior is consistent:\n\n✅ Works when the test with sleep is executed alone.\n\n❌ Breaks when a test with a child workflow ran before it.\n\nLooks like something in the child workflow test \"switches\" the TestWorkflowEnvironment from virtual time to real time.\n\nSpecifications\n\nVersion: 1.30.1\n\nPlatform: Java\n\nDependency: io.temporal:temporal-spring-boot-starter","closedAt":"2025-08-26T14:06:18Z","comments":[],"createdAt":"2025-08-26T13:58:26Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":8241,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"TestWorkflowEnvironment sleep incorrect behaviour","updatedAt":"2025-08-26T14:06:18Z","url":"https://github.com/temporalio/temporal/issues/8241"}
