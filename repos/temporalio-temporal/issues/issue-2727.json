{"assignees":[],"author":{"id":"U_kgDOBbeiBw","is_bot":false,"login":"laurentBT","name":""},"body":"## Expected Behavior\r\n\r\nCurrently we have the following configuration in our environment:\r\n\r\n\r\nTemporal ------------ no TLS ---------------> Haproxy --------------------- mTLS ------------------> postgresql database\r\n\r\n\r\n|________________________ K8s cluster________________|_____________________ Outside _____________________________________|\r\n\r\n\r\nWhen Temporal wants to communicate with a postgresql database, a connection (no TLS) is created between the Haproxy and Temporal (it could be temporal directly or temporal-sql-tool).\r\nThen the data is sent to the Haproxy and Haproxy will create a new mTLS connection between Haproxy and the postgresql database.\r\n\r\nIn that case, it works.\r\n\r\nBut we would like to set up a mTLS connection between Temporal and the Haproxy.\r\n\r\n## Actual Behavior\r\n\r\n\r\nWhen we try to  set up a mTLS connection between Temporal and the Haproxy, we receive a plain error message that says just TLS handshake fails without more details. We did not manage to have a more detailed message from Temporal or Haproxy.\r\n\r\nNevertheless, we manage to call our databse postgresql from the Temporal worker container through the Haproxy by doing a GET call with curl in mTLS.\r\n\r\nOur question is :\r\n\r\nIs Temporal designed to communicate with a postrgresql server through haproxy in mTLS ?\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nFor example the following command which is executed inside the temporal worker container, does not work\r\n\r\n  1. temporal-sql-tool --tls --tls-cert-file ourCert.crt --tls-key-file ourPrivateKey.key --tls-ca-file ca.crt --plugin postgres --ep hp -u admin -p ourPort create --db temporal\r\n  \r\nhp is the hostname to contact haproxy inside the k8s cluster\r\n\r\n\r\nIn the same container (temporal worker), the following curl works:\r\n  2. curl https://hp:ourPort --cacert ca.crt --cert ourCert.crt --key ourPrivateKey.key\r\n\r\n\r\n## Specifications\r\n\r\n  - Version: 1.11.2\r\n  - Platform: Temporal worker\r\n","closedAt":"2022-05-21T15:20:31Z","comments":[{"id":"IC_kwDODNqesM5BiiNF","author":{"login":"tsurdilo"},"authorAssociation":"MEMBER","body":"Forum thread: https://community.temporal.io/t/we-did-not-manage-to-connect-temporal-with-a-postgresql-database-through-a-proxy-haproxy/4441","createdAt":"2022-04-14T19:56:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2727#issuecomment-1099572037","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5DkiZc","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Replied in the forum thread.","createdAt":"2022-05-21T15:20:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2727#issuecomment-1133651548","viewerDidAuthor":false}],"createdAt":"2022-04-14T10:08:27Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":2727,"reactionGroups":[],"state":"CLOSED","title":"We did not manage to connect Temporal with a postgresql database through a proxy (Haproxy)","updatedAt":"2022-05-21T15:20:31Z","url":"https://github.com/temporalio/temporal/issues/2727"}
