{"author":{"id":"MDQ6VXNlcjEwODQ3Nzc=","is_bot":false,"login":"dlydiard","name":"Dan Lydiard"},"body":"## Expected Behavior\nNamespace is created when archival is enabled.\n\n## Actual Behavior\n> Error: Register namespace operation failed.\n> Error Details: rpc error: code = Unknown desc = something went wrong, please retry (6b50ceaa)\n\n## Steps to Reproduce the Problem\n```yaml\nglobal:\n    membership:\n        maxJoinDuration: 30s\n        broadcastAddress: '{{ default .Env.POD_IP \"0.0.0.0\" }}'\n    pprof:\n        port: 0\n        host: \"\"\n    tls:\n        internode:\n            client:\n                serverName: \"\"\n                disableHostVerification: false\n                rootCaFiles: []\n                rootCaData: []\n                forceTLS: false\n            server:\n                certFile: \"\"\n                keyFile: \"\"\n                clientCaFiles: []\n                certData: \"\"\n                keyData: \"\"\n                clientCaData: []\n                requireClientAuth: false\n            hostOverrides: {}\n        frontend:\n            client:\n                serverName: \"\"\n                disableHostVerification: false\n                rootCaFiles: []\n                rootCaData: []\n                forceTLS: false\n            server:\n                certFile: \"\"\n                keyFile: \"\"\n                clientCaFiles: []\n                certData: \"\"\n                keyData: \"\"\n                clientCaData: []\n                requireClientAuth: false\n            hostOverrides: {}\n        systemWorker:\n            certFile: \"\"\n            keyFile: \"\"\n            certData: \"\"\n            keyData: \"\"\n            client:\n                serverName: \"\"\n                disableHostVerification: false\n                rootCaFiles: []\n                rootCaData: []\n                forceTLS: false\n        remoteClusters: {}\n        expirationChecks:\n            warningWindow: 0s\n            errorWindow: 0s\n            checkInterval: 0s\n        refreshInterval: 0s\n    metrics:\n        tags:\n            type: '{{ .Env.SERVICES }}'\n        excludeTags: {}\n        prefix: \"\"\n        perUnitHistogramBoundaries: {}\n        m3: null\n        statsd: null\n        prometheus:\n            framework: \"\"\n            listenAddress: 0.0.0.0:9090\n            handlerPath: \"\"\n            loggerRPS: 0\n            listenNetwork: \"\"\n            timerType: histogram\n            defaultHistogramBoundaries: []\n            defaultHistogramBuckets: []\n            defaultSummaryObjectives: []\n            onError: \"\"\n            sanitizeOptions: null\n    authorization:\n        jwtKeyProvider:\n            keySourceURIs:\n                - https://dev.auth.test.com/.well-known/jwks.json\n            refreshInterval: 10m0s\n        permissionsClaimName: https://temporal/permissions\n        authorizer: default\n        claimMapper: default\n        authHeaderName: \"\"\n        authExtraHeaderName: \"\"\npersistence:\n    defaultStore: default\n    visibilityStore: visibility\n    secondaryVisibilityStore: \"\"\n    numHistoryShards: 4\n    datastores:\n        default:\n            faultInjection: null\n            cassandra: null\n            sql:\n                user: temporal-default-store\n                password: '{{ .Env.TEMPORAL_DEFAULT_DATASTORE_PASSWORD }}'\n                pluginName: postgres12\n                databaseName: temporal-default-store\n                connectAddr: test.us-east-1.rds.amazonaws.com:5432\n                connectProtocol: tcp\n                connectAttributes: {}\n                maxConns: 0\n                maxIdleConns: 0\n                maxConnLifetime: 0s\n                taskScanPartitions: 0\n                tls: null\n            customDatastore: null\n            elasticsearch: null\n        visibility:\n            faultInjection: null\n            cassandra: null\n            sql:\n                user: temporal-visibility-store\n                password: '{{ .Env.TEMPORAL_VISIBILITY_DATASTORE_PASSWORD }}'\n                pluginName: postgres12\n                databaseName: temporal-visibility-store\n                connectAddr: test.us-east-1.rds.amazonaws.com:5432\n                connectProtocol: tcp\n                connectAttributes: {}\n                maxConns: 0\n                maxIdleConns: 0\n                maxConnLifetime: 0s\n                taskScanPartitions: 0\n                tls: null\n            customDatastore: null\n            elasticsearch: null\n    advancedVisibilityStore: \"\"\nlog:\n    stdout: true\n    level: debug\n    outputFile: \"\"\n    format: json\n    development: false\nclusterMetadata:\n    enableGlobalNamespace: false\n    failoverVersionIncrement: 10\n    masterClusterName: temporal\n    currentClusterName: temporal\n    clusterInformation:\n        temporal:\n            enabled: true\n            initialFailoverVersion: 1\n            rpcAddress: 127.0.0.1:7233\n            httpAddress: \"\"\n    tags: {}\ndcRedirectionPolicy:\n    policy: \"\"\nservices:\n    frontend:\n        rpc:\n            grpcPort: 7233\n            membershipPort: 6933\n            bindOnLocalHost: false\n            bindOnIP: 0.0.0.0\n            httpPort: 7243\n            httpAdditionalForwardedHeaders: []\n    history:\n        rpc:\n            grpcPort: 7234\n            membershipPort: 6934\n            bindOnLocalHost: false\n            bindOnIP: 0.0.0.0\n            httpPort: 0\n            httpAdditionalForwardedHeaders: []\n    internal-frontend:\n        rpc:\n            grpcPort: 7236\n            membershipPort: 6936\n            bindOnLocalHost: false\n            bindOnIP: 0.0.0.0\n            httpPort: 0\n            httpAdditionalForwardedHeaders: []\n    matching:\n        rpc:\n            grpcPort: 7235\n            membershipPort: 6935\n            bindOnLocalHost: false\n            bindOnIP: 0.0.0.0\n            httpPort: 0\n            httpAdditionalForwardedHeaders: []\n    worker:\n        rpc:\n            grpcPort: 7239\n            membershipPort: 6939\n            bindOnLocalHost: false\n            bindOnIP: 0.0.0.0\n            httpPort: 0\n            httpAdditionalForwardedHeaders: []\narchival:\n    history:\n        state: enabled\n        enableRead: true\n        provider:\n            filestore: null\n            gstorage: null\n            s3store:\n                region: us-east-1\n                endpoint: null\n                s3ForcePathStyle: false\n                logLevel: 0\n    visibility:\n        state: enabled\n        enableRead: true\n        provider:\n            filestore: null\n            s3store:\n                region: us-east-1\n                endpoint: null\n                s3ForcePathStyle: false\n                logLevel: 0\n            gstorage: null\npublicClient:\n    hostPort: \"\"\n    httpHostPort: \"\"\n    forceTLSConfig: \"\"\ndynamicConfigClient:\n    filepath: /etc/temporal/config/dynamic_config.yaml\n    pollInterval: 1m0s\nnamespaceDefaults:\n    archival:\n        history:\n            state: enabled\n            URI: s3://temporal-system-history\n        visibility:\n            state: enabled\n            URI: s3://temporal-system-visibility\notel: {}\n```\n\nI verified the PODs have access to the S3 buckets via IRSA. All ServiceAccount annotations look correct and the IAM Role trust relationship and policies look correct.\n\ninternal-frontend logs\n```json\n{\"level\":\"error\",\"ts\":\"2025-04-18T02:16:42.922Z\",\"msg\":\"service failures\",\"operation\":\"RegisterNamespace\",\"wf-namespace\":\"test\",\"error\":\"unable to find bootstrap container for the given service name\",\"logging-call-at\":\"/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/telemetry.go:434\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/log/zap_logger.go:155\\ngo.temporal.io/server/common/rpc/interceptor.(*TelemetryInterceptor).HandleError\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/telemetry.go:434\\ngo.temporal.io/server/common/rpc/interceptor.(*TelemetryInterceptor).UnaryIntercept\\n\\t/home/runner/work/docker-builds/docker-builds/temporal/common/rpc/interceptor/telemetry.go:202\\ngoogle.golang.org/grpc.getChainUnaryHandler.func1\\n\\t/home/runner/go/pkg/mod/google.golang.org/grpc@v1.65.0/server.go:1196\\ngo.temporal.io/server/common/rpc/interceptor.(*Redirection).handl...\n```\nMain error:\n> unable to find bootstrap container for the given service name\n\n\nI do not see any s3 errors in the history POD.\nI'm running from the admintools POD:\n```sh\nexport NS=test\nexport TEMPORAL_RETENTION=\"15\"\nexport TEMPORAL_OWNER=devops@test.com\n\ntctl --namespace \"$NS\" namespace register \\\n      --description \"$NS\" \\\n      --owner_email \"$TEMPORAL_OWNER\" \\\n      --retention \"$TEMPORAL_RETENTION\" \\\n      --history_archival_state enabled \\\n      --visibility_archival_state enabled \n\nError: Register namespace operation failed.\n```\n\nIf I disable `history_archival_state` and `visibility_archival_state` the Namespace creates successfully.\n\n\n## Specifications\n\n  - Version: 1.25.2\n  - Platform: OpenShift\n","closedAt":"2025-05-29T22:33:10Z","comments":[{"id":"IC_kwDODNqesM6n1lf_","author":{"login":"dlydiard"},"authorAssociation":"NONE","body":"```sh\n$ tctl adm cl d\n{\n  \"supportedClients\": {\n    \"Nexus-go-sdk\": \"\\u003c2.0.0\",\n    \"temporal-cli\": \"\\u003c2.0.0\",\n    \"temporal-go\": \"\\u003c2.0.0\",\n    \"temporal-java\": \"\\u003c2.0.0\",\n    \"temporal-php\": \"\\u003c2.0.0\",\n    \"temporal-server\": \"\\u003c2.0.0\",\n    \"temporal-typescript\": \"\\u003c2.0.0\",\n    \"temporal-ui\": \"\\u003c3.0.0\"\n  },\n  \"serverVersion\": \"1.25.2\",\n  \"membershipInfo\": {\n    \"currentHost\": {\n      \"identity\": \"10.128.15.103:7233\"\n    },\n    \"reachableMembers\": [\n      \"10.128.15.103:6936\",\n      \"10.128.15.101:6934\",\n      \"10.130.9.185:6939\",\n      \"10.128.15.102:6935\",\n      \"10.130.11.82:6934\",\n      \"10.131.9.61:6934\",\n      \"10.131.10.198:6935\",\n      \"10.131.13.14:6935\",\n      \"10.129.11.249:6939\",\n      \"10.130.11.83:6939\"\n    ],\n    \"rings\": [\n      {\n        \"role\": \"frontend\"\n      },\n      {\n        \"role\": \"internal-frontend\",\n        \"memberCount\": 1,\n        \"members\": [\n          {\n            \"identity\": \"10.128.15.103:7233\"\n          }\n        ]\n      },\n      {\n        \"role\": \"history\",\n        \"memberCount\": 3,\n        \"members\": [\n          {\n            \"identity\": \"10.130.11.82:7234\"\n          },\n          {\n            \"identity\": \"10.131.9.61:7234\"\n          },\n          {\n            \"identity\": \"10.128.15.101:7234\"\n          }\n        ]\n      },\n      {\n        \"role\": \"matching\",\n        \"memberCount\": 3,\n        \"members\": [\n          {\n            \"identity\": \"10.131.10.198:7235\"\n          },\n          {\n            \"identity\": \"10.131.13.14:7235\"\n          },\n          {\n            \"identity\": \"10.128.15.102:7235\"\n          }\n        ]\n      },\n      {\n        \"role\": \"worker\",\n        \"memberCount\": 3,\n        \"members\": [\n          {\n            \"identity\": \"10.130.9.185:7239\"\n          },\n          {\n            \"identity\": \"10.129.11.249:7239\"\n          },\n          {\n            \"identity\": \"10.130.11.83:7239\"\n          }\n        ]\n      }\n    ]\n  },\n  \"clusterId\": \"...\",\n  \"clusterName\": \"temporal\",\n  \"historyShardCount\": 4,\n  \"persistenceStore\": \"postgres12\",\n  \"visibilityStore\": \"postgres12\",\n  \"versionInfo\": {\n    \"current\": {\n      \"version\": \"1.25.2\",\n      \"releaseTime\": \"2024-11-05T22:08:00Z\"\n    },\n    \"recommended\": {\n      \"version\": \"1.27.2\",\n      \"releaseTime\": \"2025-03-28T18:39:15Z\"\n    },\n    \"alerts\": [\n      {\n        \"message\": \"ü™ê A new release is available!\",\n        \"severity\": \"Low\"\n      }\n    ],\n    \"lastUpdateTime\": \"2025-04-18T16:13:20.317713992Z\"\n  },\n  \"failoverVersionIncrement\": \"10\",\n  \"initialFailoverVersion\": \"1\"\n}\n```","createdAt":"2025-04-18T16:53:25Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7631#issuecomment-2815842303","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6n2Cq6","author":{"login":"dlydiard"},"authorAssociation":"NONE","body":"I think this has something to do with using the internal-frontend. This is being used since auth is turned on for the frontend service. If i disable the internal-frontend and auth i'm able to create the namespace with archival enabled","createdAt":"2025-04-18T18:13:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7631#issuecomment-2815961786","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6qaMiH","author":{"login":"PADRESH"},"authorAssociation":"NONE","body":"There are two functions in provider.go which can throw this error: GetVisibilityArchiver and GetHistoryArchiver. In some cases they called with wrong wrong value of serviceName parameter. In  workflow_handler.go this call looks like this:\n\n```\nhistoryArchiver, err := wh.archiverProvider.GetHistoryArchiver(URI.Scheme(), string(primitives.FrontendService))  \nif err != nil {  \n   return nil, err  \n}\n```\n\nThe second parameter is always primitives.FrontendService, but in in case of internal-frontend there must be  primitives.InternalFrontendService.\n\nAs a quick solution, I can suggest the following:\n\n```\nvar historyArchiver archiver.HistoryArchiver  \nhistoryArchiver, err = wh.archiverProvider.GetHistoryArchiver(URI.Scheme(), string(primitives.FrontendService))  \nif err != nil {  \n   historyArchiver, err = wh.archiverProvider.GetHistoryArchiver(URI.Scheme(), string(primitives.InternalFrontendService))  \n   if err != nil {  \n      return nil, err  \n   }  \n}\n```\n\nThis fix must be applied to all calls to GetVisibilityArchiver and GetHistoryArchiver.","createdAt":"2025-05-07T15:12:27Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":2}}],"url":"https://github.com/temporalio/temporal/issues/7631#issuecomment-2858993799","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6q8wr3","author":{"login":"yycptt"},"authorAssociation":"MEMBER","body":"Thanks for reporting the issue @dlydiard and thanks for the contribution @PADRESH!\n\nI left some comments in the [PR](https://github.com/temporalio/temporal/pull/7748) you opened @PADRESH . Let's continue the discussion there.","createdAt":"2025-05-09T23:16:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/7631#issuecomment-2868054775","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6uFsrN","author":{"login":"yycptt"},"authorAssociation":"MEMBER","body":"Should be fixed by https://github.com/temporalio/temporal/pull/7766 from @dnr ","createdAt":"2025-05-29T22:33:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/7631#issuecomment-2920729293","viewerDidAuthor":false}],"createdAt":"2025-04-18T02:22:39Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"number":7631,"reactionGroups":[],"state":"CLOSED","title":"Unable to create namespace when s3 archival and internal-frontend is enabled","updatedAt":"2025-05-29T22:33:11Z"}
