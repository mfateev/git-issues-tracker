{"assignees":[],"author":{"id":"MDQ6VXNlcjMxMjMwMzQx","is_bot":false,"login":"runzexia","name":"runzexia"},"body":"## Expected Behavior\r\ntemporal frontend works fine with nginx ingress\r\n\r\n## Actual Behavior\r\ntemporal frontend sometimes shows closed connection, caused 502 bad-gateway\r\n\r\n```\r\n2021/09/27 09:59:59 [error] 48#48: *221 upstream prematurely closed connection while reading response header from upstream, client: 13.52.189.172, server: x, request: \"POST /temporal.api.workflowservice.v1.WorkflowService/PollWorkflowTaskQueue HTTP/2.0\", upstream: \"grpc://10.12.10.76:7233\", host: \"temporal-api.smec.gke-ci.eurekacloud.io:443\"\r\n2021/09/27 10:00:11 [error] 48#48: *12096 upstream prematurely closed connection while reading response header from upstream, client: 51.104.150.63, server: x, request: \"POST /temporal.api.workflowservice.v1.WorkflowService/PollWorkflowTaskQueue HTTP/2.0\", upstream: \"grpc://10.12.10.76:7233\", host: \"temporal-api.smec.gke-ci.eurekacloud.io:443\"\r\n```\r\n## Steps to Reproduce the Problem\r\ningress yaml:\r\n```\r\napiVersion: networking.k8s.io/v1\r\nkind: Ingress\r\nmetadata:\r\n  annotations:\r\n    cert-manager.io/cluster-issuer: zerossl\r\n    kubernetes.io/ingress.class: nginx\r\n    meta.helm.sh/release-name: temporal\r\n    meta.helm.sh/release-namespace: smec\r\n    nginx.ingress.kubernetes.io/backend-protocol: GRPC\r\n    nginx.ingress.kubernetes.io/server-snippet: grpc_read_timeout 3600s; grpc_send_timeout\r\n      3600s; client_body_timeout 3600s; http2_idle_timeout 10s; keepalive_timeout\r\n      10s;\r\n  creationTimestamp: \"2021-08-30T06:29:38Z\"\r\n  generation: 2\r\n  labels:\r\n    app.kubernetes.io/component: web\r\n    app.kubernetes.io/instance: temporal\r\n    app.kubernetes.io/managed-by: Helm\r\n    app.kubernetes.io/name: temporal\r\n    app.kubernetes.io/part-of: temporal\r\n    app.kubernetes.io/version: 1.11.5\r\n    helm.sh/chart: temporal-0.11.5\r\n  managedFields:\r\n  - apiVersion: networking.k8s.io/v1beta1\r\n    fieldsType: FieldsV1\r\n    fieldsV1:\r\n      f:metadata:\r\n        f:annotations:\r\n          .: {}\r\n          f:cert-manager.io/cluster-issuer: {}\r\n          f:kubernetes.io/ingress.class: {}\r\n          f:meta.helm.sh/release-name: {}\r\n          f:meta.helm.sh/release-namespace: {}\r\n          f:nginx.ingress.kubernetes.io/backend-protocol: {}\r\n          f:nginx.ingress.kubernetes.io/server-snippet: {}\r\n        f:labels:\r\n          .: {}\r\n          f:app.kubernetes.io/component: {}\r\n          f:app.kubernetes.io/instance: {}\r\n          f:app.kubernetes.io/managed-by: {}\r\n          f:app.kubernetes.io/name: {}\r\n          f:app.kubernetes.io/part-of: {}\r\n          f:app.kubernetes.io/version: {}\r\n          f:helm.sh/chart: {}\r\n      f:spec:\r\n        f:rules: {}\r\n        f:tls: {}\r\n    manager: Go-http-client\r\n    operation: Update\r\n    time: \"2021-09-27T07:28:36Z\"\r\n  - apiVersion: networking.k8s.io/v1beta1\r\n    fieldsType: FieldsV1\r\n    fieldsV1:\r\n      f:status:\r\n        f:loadBalancer:\r\n          f:ingress: {}\r\n    manager: nginx-ingress-controller\r\n    operation: Update\r\n    time: \"2021-09-27T09:41:30Z\"\r\n  name: temporal-frontend\r\n  namespace: smec\r\n  resourceVersion: \"601473624\"\r\n  uid: 4bd6492e-929a-4e21-afb1-b4bf93e52bf3\r\nspec:\r\n  rules:\r\n  - host: x\r\n    http:\r\n      paths:\r\n      - backend:\r\n          service:\r\n            name: temporal-frontend\r\n            port:\r\n              number: 7233\r\n        path: /\r\n        pathType: Prefix\r\n  tls:\r\n  - hosts:\r\n    - x\r\n    secretName: x\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: v1.11.4\r\n  - Platform: kubernetes\r\n","closedAt":"2022-01-20T18:22:22Z","comments":[{"id":"IC_kwDODNqesM43nJGE","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Please try to disable the MaxConnectionAge by set dynamic config of\r\n'frontend.keepAliveMaxConnectionAge` to 0, and see if that fixed the problem. Thanks.","createdAt":"2021-10-03T19:05:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1980#issuecomment-933007748","viewerDidAuthor":false},{"id":"IC_kwDODNqesM444yc0","author":{"login":"runzexia"},"authorAssociation":"NONE","body":"it works thanks @yiminc ","createdAt":"2021-10-29T04:00:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1980#issuecomment-954410804","viewerDidAuthor":false},{"id":"IC_kwDODNqesM60sPHG","author":{"login":"adriantaut"},"authorAssociation":"NONE","body":"Hello, sorry for being late to the party, indeed having 'frontend.keepAliveMaxConnectionAge` to 0 prevents errors from appearing. \n\nBy default is a 5mins setting [here](https://github.com/temporalio/temporal/blob/51c562a4c149b39dfc33340cc779c5e2317d77aa/common/dynamicconfig/constants.go#L816C1-L823C3):\n\n```\n\tKeepAliveMaxConnectionAge = NewGlobalDurationSetting(\n\t\t\"frontend.keepAliveMaxConnectionAge\",\n\t\t5*time.Minute,\n\t\t`KeepAliveMaxConnectionAge is a duration for the maximum amount of time a\nconnection may exist before it will be closed by sending a GoAway. A\nrandom jitter of +/-10% will be added to MaxConnectionAge to spread out\nconnection storms.`,\n\t)\n```\n\nJust wondering what are the risks of disabling this permanently? Thank you!","createdAt":"2025-07-03T09:09:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/1980#issuecomment-3031495110","viewerDidAuthor":false}],"createdAt":"2021-09-27T10:02:06Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":1980,"reactionGroups":[],"state":"CLOSED","title":"temporal server closed the connection with ingress","updatedAt":"2025-07-03T09:09:30Z","url":"https://github.com/temporalio/temporal/issues/1980"}
