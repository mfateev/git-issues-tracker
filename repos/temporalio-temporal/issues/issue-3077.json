{"assignees":[],"author":{"id":"MDQ6VXNlcjU0NjMyMTg=","is_bot":false,"login":"mazzy89","name":"Salvatore Mazzarino"},"body":"## Expected Behavior\r\n\r\nUsing the AWS RDS IAM Auth plugin and assuming an IAM role to generate the db password, I would expect that Temporal reconnects to the db.\r\n\r\n## Actual Behavior\r\n\r\nWith an IAM role with 1h of duration session (default value), once the session is expired Temporal crashes and can't reach the DB.\r\n\r\nFrom the feature implementation https://github.com/temporalio/temporal/pull/2830, I cannot see any mechanism used by Temporal to re-hydrate the token.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nRun Temporal 1.17 with the process configured with auth plugin `rds-iam-auth` to assume a role.\r\n  \r\n## Specifications\r\n\r\n  - Version: 1.17\r\n  - Platform: k8s\r\n","closedAt":"2022-09-10T00:32:33Z","comments":[{"id":"IC_kwDODNqesM5GSas8","author":{"login":"gnz00"},"authorAssociation":"CONTRIBUTOR","body":"Once a RDS connection is established it remains valid - even after the underlying session tokens are expired. On every [new session](https://github.com/temporalio/temporal/pull/2830/files#diff-e334e328efecbb432db6b97313f1d5190533f85018355ea3aef701db4d56ed10R83) the [AWS sdk is invoked to get credentials](https://github.com/temporalio/temporal/pull/2830/files#diff-357f724496a420b8acb1f8e71d84ca0a60279d034898195efdeda5c1eed557f4R99), such that no token is stored or cached and credentials are resolved at the time of session creation. \r\n\r\nMy hunch is that you're not using a rotating token mechanism that can be resolved by the AWS SDK. It would be helpful to show which credential mechanism you're using and the error logs you're seeing. \r\n\r\n","createdAt":"2022-07-08T17:51:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3077#issuecomment-1179233084","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5GSfSu","author":{"login":"mazzy89"},"authorAssociation":"NONE","body":"@gnz00 could you point to any resource that claim that the connection remain valid even after the aws session is expired? It's not mentioned anywhere on the aws side. \r\n\r\nI'm using the official eks aws oidc provider https://aws.amazon.com/blogs/containers/introducing-oidc-identity-provider-authentication-amazon-eks/ which support secret rotation automatically. So I doubt is that the issue.","createdAt":"2022-07-08T18:18:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3077#issuecomment-1179251886","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5GSiZN","author":{"login":"mazzy89"},"authorAssociation":"NONE","body":"About the error I see is the following:\r\n\r\n```\r\n{\"level\":\"error\",\"ts\":\"2022-07-08T18:15:32.681Z\",\"msg\":\"Operation failed with internal error.\",\"error\":\"GetMetadata operation failed. Error: pq: PAM authentication failed for user \\\"temporal\\\"\",\"metric-scope\":55,\"logging-call-at\":\"persistenceMetricClients.go:1424\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/home/builder/temporal/common/log/zap_logger.go:142\\ngo.temporal.io/server/common/persistence.(*metricEmitter).updateErrorMetric\\n\\t/home/builder/temporal/common/persistence/persistenceMetricClients.go:1424\\ngo.temporal.io/server/common/persistence.(*metadataPersistenceClient).GetMetadata\\n\\t/home/builder/temporal/common/persistence/persistenceMetricClients.go:861\\ngo.temporal.io/server/common/namespace.(*registry).refreshNamespaces\\n\\t/home/builder/temporal/common/namespace/registry.go:422\\ngo.temporal.io/server/common/namespace.(*registry).refreshLoop\\n\\t/home/builder/temporal/common/namespace/registry.go:399\\ngo.temporal.io/server/internal/goro.Go.func1\\n\\t/home/builder/temporal/internal/goro/goro.go:56\"}\r\n```","createdAt":"2022-07-08T18:36:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3077#issuecomment-1179264589","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5GSnMD","author":{"login":"mazzy89"},"authorAssociation":"NONE","body":"To add more context from official documents https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts-technical-overview.html\r\n\r\nHere the explanation from aws how the refresh works\r\n\r\n> The kubelet requests and stores the token on behalf of the pod. By default, the kubelet refreshes the token if it is older than 80 percent of its total TTL, or if the token is older than 24 hours. You can modify the expiration duration for any account, except the default service account, with settings in your pod spec. For more information, see Service Account Token Volume Projection in the Kubernetes documentation\r\n\r\n\r\n","createdAt":"2022-07-08T19:05:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3077#issuecomment-1179284227","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5GTQTH","author":{"login":"gnz00"},"authorAssociation":"CONTRIBUTOR","body":"I think you're right - I'd switched to password auth as I couldn't wait for the 17.0 release. It seems sqlx does cache the DSN and re-use it on connection failures. I don't think either the Postgres or Mysql drivers support any form of auth plugin. I'll probably revert the original PR in favor of using a sidecar proxy.","createdAt":"2022-07-09T01:18:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3077#issuecomment-1179452615","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5GTXeg","author":{"login":"mazzy89"},"authorAssociation":"NONE","body":"And to add also to the issue, I get the same result even when using an AWS IAM user with acess key id and secret access key.","createdAt":"2022-07-09T05:17:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3077#issuecomment-1179482016","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5KBlbU","author":{"login":"jaffarsadikk"},"authorAssociation":"NONE","body":"@mazzy89 - is this issue resolved with 1.17.0 ? Are you able to rotate the password?","createdAt":"2022-09-09T12:41:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3077#issuecomment-1241929428","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5KBl9n","author":{"login":"mazzy89"},"authorAssociation":"NONE","body":"No. Simply the author reverted the feature in 1.17. This feature can't land implemented in that way for the reasons already explained. ","createdAt":"2022-09-09T12:43:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3077#issuecomment-1241931623","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5KEC-U","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Close this issue as the AWS RDS IAM Auth is not supported currently. ","createdAt":"2022-09-10T00:32:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3077#issuecomment-1242574740","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5LvYqc","author":{"login":"sialm"},"authorAssociation":"NONE","body":"@mazzy89 thanks for pulling on this thread. I was about to make a horrible mistake \r\n\r\n@yiminc do you know of any plans to reintroduce this feature? ","createdAt":"2022-10-06T21:22:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3077#issuecomment-1270712988","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5c-u4Q","author":{"login":"CurryFishBalls9527"},"authorAssociation":"NONE","body":"@yiminc Any plan to reintroduce this feature? ","createdAt":"2023-05-23T18:32:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3077#issuecomment-1559948816","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5dGRZW","author":{"login":"gnz00"},"authorAssociation":"CONTRIBUTOR","body":"@CurryFishBalls9527 @sialm \r\nYou would need to extend each driver to override the Connect method to always fetch a new token, here is an example for PG: https://github.com/aws/aws-sdk-go/issues/3043#issuecomment-581931580. \r\n\r\nAlternatively, you could force a maxConns to 1 and maybe recreate the Session for each store on a connection failure.\r\n\r\n\r\n","createdAt":"2023-05-24T21:05:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3077#issuecomment-1561925206","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5gCac4","author":{"login":"dkravetz"},"authorAssociation":"NONE","body":"I would also like to know if there are plans to re-introduce this feature","createdAt":"2023-06-28T11:38:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":5}}],"url":"https://github.com/temporalio/temporal/issues/3077#issuecomment-1611245368","viewerDidAuthor":false},{"id":"IC_kwDODNqesM6-S6BZ","author":{"login":"attaluris"},"authorAssociation":"NONE","body":"+1 to the desire to use AWS RDS IAM auth instead of user/password auth","createdAt":"2025-08-15T20:19:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/3077#issuecomment-3192627289","viewerDidAuthor":false}],"createdAt":"2022-07-08T15:13:52Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":3077,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"Temporal servers crashes once the aws token session is expired ","updatedAt":"2025-08-15T20:19:22Z","url":"https://github.com/temporalio/temporal/issues/3077"}
