{"assignees":[{"id":"MDQ6VXNlcjIyMzI1MjQ=","login":"alexshtin","name":"Alex Shtin","databaseId":0}],"author":{"id":"MDQ6VXNlcjExODk3MTY=","is_bot":false,"login":"aybabtme","name":"Antoine Grondin"},"body":"## Expected Behavior\r\n\r\nThe program should return well formatted errors and shouldn't panic, especially not for bug-looking reasons like assigning in nil-maps.\r\n\r\n## Actual Behavior\r\n\r\n```\r\npanic: assignment to entry in nil map\r\n\r\ngoroutine 1 [running]:\r\ngo.temporal.io/server/temporal.loadClusterInformationFromStore({0x2a5fab0?, 0xc00005a080}, 0xc000578900, {0x2a697a8?, 0xc0005e6000}, {0x2a63ae0, 0xc000962a80})\r\n        /home/runner/work/temporal/temporal/temporal/fx.go:733 +0x7ae\r\ngo.temporal.io/server/temporal.ApplyClusterMetadataConfigProvider({0x2a63ae0, 0xc000878f10}, 0xc000578900, {0x2a49ba0, 0x3cd9f28}, 0x2633f08, {0x0, 0x0})\r\n        /home/runner/work/temporal/temporal/temporal/fx.go:686 +0x22eb\r\nreflect.Value.call({0x21af600?, 0x2634540?, 0x40d645?}, {0x24c790e, 0x4}, {0xc00031d200, 0x5, 0x30?})\r\n        /opt/hostedtoolcache/go/1.18.4/x64/src/reflect/value.go:556 +0x845\r\nreflect.Value.Call({0x21af600?, 0x2634540?, 0x40d9a7?}, {0xc00031d200, 0x5, 0x5})\r\n        /opt/hostedtoolcache/go/1.18.4/x64/src/reflect/value.go:339 +0xbf\r\ngo.uber.org/dig.defaultInvoker({0x21af600?, 0x2634540?, 0xc0000fae60?}, {0xc00031d200?, 0x5?, 0x2a6e588?})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/container.go:220 +0x28\r\ngo.uber.org/dig.(*constructorNode).Call(0xc00035a900, {0x2a6e588, 0xc0003580a0})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/constructor.go:154 +0x297\r\ngo.uber.org/dig.paramSingle.Build({{0x0, 0x0}, 0x0, {0x2a71500, 0x234fe60}}, {0x2a6e588, 0xc000358000})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/param.go:296 +0x2f9\r\ngo.uber.org/dig.paramObjectField.Build(...)\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/param.go:480\r\ngo.uber.org/dig.paramObject.Build({{0x2a71500, 0x245c0e0}, {0xc000366f00, 0x14, 0x20}, {0x0, 0x0, 0x0}}, {0x2a6e588, 0xc000358000})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/param.go:407 +0x155\r\ngo.uber.org/dig.paramList.BuildList({{0x2a71500, 0x20d58a0}, {0xc000332830, 0x1, 0x1}}, {0x2a6e588, 0xc000358000})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/param.go:151 +0xb9\r\ngo.uber.org/dig.(*constructorNode).Call(0xc00035a600, {0x2a6e588, 0xc000358000})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/constructor.go:145 +0x132\r\ngo.uber.org/dig.paramGroupedSlice.callGroupProviders({{0x1f49fd8, 0x8}, {0x2a71500, 0x20036e0}, 0xc000339bc0}, {0x2a6e588?, 0xc0003580a0?})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/param.go:597 +0x192\r\ngo.uber.org/dig.paramGroupedSlice.Build({{0x1f49fd8, 0x8}, {0x2a71500, 0x20036e0}, 0xc000339bc0}, {0x2a6e588, 0xc0003580a0})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/param.go:624 +0x10c\r\ngo.uber.org/dig.paramObjectField.Build(...)\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/param.go:480\r\ngo.uber.org/dig.paramObject.Build({{0x2a71500, 0x222be80}, {0xc000339c20, 0x1, 0x1}, {0x0, 0x0, 0x0}}, {0x2a6e588, 0xc0003580a0})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/param.go:407 +0x155\r\ngo.uber.org/dig.paramList.BuildList({{0x2a71500, 0x220fc80}, {0xc000358140, 0xa, 0xa}}, {0x2a6e588, 0xc0003580a0})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/param.go:151 +0xb9\r\ngo.uber.org/dig.(*constructorNode).Call(0xc00035a0c0, {0x2a6e588, 0xc0003580a0})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/constructor.go:145 +0x132\r\ngo.uber.org/dig.paramSingle.Build({{0x0, 0x0}, 0x0, {0x2a71500, 0x2164900}}, {0x2a6e588, 0xc0003580a0})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/param.go:296 +0x2f9\r\ngo.uber.org/dig.paramList.BuildList({{0x2a71500, 0x2061de0}, {0xc000332430, 0x1, 0x1}}, {0x2a6e588, 0xc0003580a0})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/param.go:151 +0xb9\r\ngo.uber.org/dig.(*constructorNode).Call(0xc00035a180, {0x2a6e588, 0xc0003580a0})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/constructor.go:145 +0x132\r\ngo.uber.org/dig.paramSingle.Build({{0x0, 0x0}, 0x0, {0x2a71500, 0x2193d40}}, {0x2a6e588, 0xc0003580a0})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/param.go:296 +0x2f9\r\ngo.uber.org/dig.paramList.BuildList({{0x2a71500, 0x207fea0}, {0xc00011d200, 0x2, 0x2}}, {0x2a6e588, 0xc0003580a0})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/param.go:151 +0xb9\r\ngo.uber.org/dig.(*Scope).Invoke(0xc0003580a0, {0x207fea0?, 0x2634588}, {0xc0007fee68?, 0x4eb245?, 0xc0007fee98?})\r\n        /home/runner/go/pkg/mod/go.uber.org/dig@v1.14.1/invoke.go:85 +0x288\r\ngo.uber.org/fx.runInvoke({0x2a5e0b0?, 0xc0003580a0?}, {{0x207fea0, 0x2634588}, {0xc000344a00, 0x7, 0x8}})\r\n        /home/runner/go/pkg/mod/go.uber.org/fx@v1.17.1/invoke.go:93 +0x1ff\r\ngo.uber.org/fx.(*module).executeInvoke(0xc0001f6090, {{0x207fea0, 0x2634588}, {0xc000344a00, 0x7, 0x8}})\r\n        /home/runner/go/pkg/mod/go.uber.org/fx@v1.17.1/module.go:174 +0x133\r\ngo.uber.org/fx.(*module).executeInvokes(0xc0001f6090)\r\n        /home/runner/go/pkg/mod/go.uber.org/fx@v1.17.1/module.go:155 +0xf1\r\ngo.uber.org/fx.New({0xc0007ff338, 0xc, 0x7?})\r\n        /home/runner/go/pkg/mod/go.uber.org/fx@v1.17.1/app.go:534 +0x887\r\ngo.temporal.io/server/temporal.NewServerFx({0xc000334000?, 0x2a63ae0?, 0xc000878f10?})\r\n        /home/runner/work/temporal/temporal/temporal/fx.go:130 +0x716\r\ngo.temporal.io/server/temporal.NewServer(...)\r\n        /home/runner/work/temporal/temporal/temporal/server.go:58\r\nmain.buildCLI.func2(0xc0004d1320?)\r\n        /home/runner/work/temporal/temporal/cmd/server/main.go:166 +0x1538\r\ngithub.com/urfave/cli/v2.(*Command).Run(0xc0004d1320, 0xc00040c4c0)\r\n        /home/runner/go/pkg/mod/github.com/urfave/cli/v2@v2.4.0/command.go:163 +0x5bb\r\ngithub.com/urfave/cli/v2.(*App).RunContext(0xc000103a00, {0x2a5fab0?, 0xc00005a068}, {0xc00004c1e0, 0x6, 0x6})\r\n        /home/runner/go/pkg/mod/github.com/urfave/cli/v2@v2.4.0/app.go:313 +0xb48\r\ngithub.com/urfave/cli/v2.(*App).Run(...)\r\n        /home/runner/go/pkg/mod/github.com/urfave/cli/v2@v2.4.0/app.go:224\r\nmain.main()\r\n        /home/runner/work/temporal/temporal/cmd/server/main.go:53 +0x45\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nUse this config file:\r\n\r\n```\r\nlog:\r\n    stdout: true\r\n    level: info\r\n\r\npersistence:\r\n    defaultStore: mysql-default\r\n    visibilityStore: mysql-visibility\r\n    numHistoryShards: 4\r\n    datastores:\r\n        mysql-default:\r\n            sql:\r\n                pluginName: \"mysql\"\r\n                databaseName: \"{{ .Env.TEMPORAL_MYSQL_DEFAULT_DBNAME }}\"\r\n                connectAddr: \"{{ .Env.TEMPORAL_MYSQL_DEFAULT_HOST }}:{{ .Env.TEMPORAL_MYSQL_DEFAULT_PORT }}\"\r\n                connectProtocol: \"tcp\"\r\n                user: \"{{ .Env.TEMPORAL_MYSQL_DEFAULT_USER }}\"\r\n                password: \"{{ .Env.TEMPORAL_MYSQL_DEFAULT_PASSWORD }}\"\r\n                maxConns: 20\r\n                maxIdleConns: 20\r\n                maxConnLifetime: \"1h\"\r\n        mysql-visibility:\r\n            sql:\r\n                pluginName: \"mysql\"\r\n                databaseName: \"{{ .Env.TEMPORAL_MYSQL_VISIBILITY_DBNAME }}\"\r\n                connectAddr: \"{{ .Env.TEMPORAL_MYSQL_VISIBILITY_HOST }}:{{ .Env.TEMPORAL_MYSQL_VISIBILITY_PORT }}\"\r\n                connectProtocol: \"tcp\"\r\n                user: \"{{ .Env.TEMPORAL_MYSQL_VISIBILITY_USER }}\"\r\n                password: \"{{ .Env.TEMPORAL_MYSQL_VISIBILITY_PASSWORD }}\"\r\n                maxConns: 2\r\n                maxIdleConns: 2\r\n                maxConnLifetime: \"1h\"\r\n\r\nglobal:\r\n    membership:\r\n        maxJoinDuration: 30s\r\n        broadcastAddress: \"127.0.0.1\"\r\n    pprof:\r\n        port: 7936\r\n    metrics:\r\n        statsd:\r\n            hostPort: \"{{ .Env.DD_AGENT_HOST }}:28125\"\r\n            prefix: \"temporal\"\r\n\r\nservices:\r\n    frontend:\r\n        rpc:\r\n            grpcPort: 7233\r\n            membershipPort: 6933\r\n            bindOnLocalHost: true\r\n\r\n    matching:\r\n        rpc:\r\n            grpcPort: 7235\r\n            membershipPort: 6935\r\n            bindOnLocalHost: true\r\n\r\n    history:\r\n        rpc:\r\n            grpcPort: 7234\r\n            membershipPort: 6934\r\n            bindOnLocalHost: true\r\n\r\n    worker:\r\n        rpc:\r\n            grpcPort: 7239\r\n            membershipPort: 6939\r\n            bindOnLocalHost: true\r\n\r\nclusterMetadata:\r\n    enableGlobalNamespace: false\r\n    failoverVersionIncrement: 10\r\n    masterClusterName: \"active\"\r\n    currentClusterName: \"active\"\r\n    clusterInformation:\r\n        active:\r\n            enabled: true\r\n            initialFailoverVersion: 1\r\n            rpcName: \"frontend\"\r\n            rpcAddress: \"localhost:7233\"\r\n\r\ndcRedirectionPolicy:\r\n    policy: \"noop\"\r\n    toDC: \"\"\r\n\r\narchival:\r\n    history:\r\n        state: \"enabled\"\r\n        enableRead: true\r\n        provider:\r\n            filestore:\r\n            fileMode: \"0666\"\r\n            dirMode: \"0766\"\r\n            gstorage:\r\n            credentialsPath: \"/tmp/gcloud/keyfile.json\"\r\n    visibility:\r\n        state: \"enabled\"\r\n        enableRead: true\r\n        provider:\r\n            filestore:\r\n            fileMode: \"0666\"\r\n            dirMode: \"0766\"\r\n\r\nnamespaceDefaults:\r\n    archival:\r\n        history:\r\n            state: \"disabled\"\r\n            URI: \"file:///tmp/temporal_archival/development\"\r\n        visibility:\r\n            state: \"disabled\"\r\n            URI: \"file:///tmp/temporal_vis_archival/development\"\r\n\r\npublicClient:\r\n    hostPort: \"localhost:7233\"\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: 1.17.2\r\n  - Platform: x86_64 GNU/Linux\r\n","closedAt":null,"comments":[],"createdAt":"2022-08-12T19:20:24Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":3223,"reactionGroups":[],"state":"OPEN","title":"panic: assignment to entry in nil map in `loadClusterInformationFromStore`","updatedAt":"2023-03-03T20:18:43Z","url":"https://github.com/temporalio/temporal/issues/3223"}
