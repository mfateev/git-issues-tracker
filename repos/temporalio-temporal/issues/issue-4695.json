{"assignees":[{"id":"MDQ6VXNlcjIwNjgxMjQ=","login":"rodrigozhou","name":"Rodrigo Zhou","databaseId":0}],"author":{"id":"MDQ6VXNlcjE5MjcwNzg1","is_bot":false,"login":"ganievs","name":"Ganiev Shamil"},"body":"## Expected Behavior\r\nTemporal cluster establishes connection with  Elasticsearch.\r\n\r\n## Actual Behavior\r\n\"no ElasticSearch node available\"\r\n\r\n## Steps to Reproduce the Problem\r\n  1. Setup elastic 8 version with enabled TLS on the HTTP layer\r\n  2. Set `scheme: \"https\"` in Temporal server config\r\n```yaml\r\n        elasticsearch:\r\n          version: \"v8\"\r\n          url:\r\n            scheme: \"https\"\r\n```\r\n\r\n## Specifications\r\n\r\n  - Temporal Version: 1.21.3\r\n  - Elasticsearch Version: 8.6.2\r\n  - Platform: Kubernetes\r\n","closedAt":"2023-08-20T14:55:22Z","comments":[{"id":"IC_kwDODNqesM5ikoOH","author":{"login":"ganievs"},"authorAssociation":"NONE","body":"Hi all! Seems like the [client library](https://github.com/temporalio/temporal/blob/fbd0de731af608acee2840673769042f15ec8404/go.mod#L26C5-L26C5)  that you're using, doesn't have actual support for 8 version of Elasticsearch and not maintained anymore https://github.com/olivere/elastic/issues/1533. \r\nDo you have any plans to move to the [official](https://github.com/elastic/go-elasticsearch) lib?","createdAt":"2023-07-27T14:45:37Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4695#issuecomment-1653769095","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5iw9qS","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"Did you set up the certs correctly? Are they from a known issuer?\r\nPlease provide more details of how you tried set up.","createdAt":"2023-07-30T02:54:53Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4695#issuecomment-1657002642","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5i01nH","author":{"login":"ganievs"},"authorAssociation":"NONE","body":"I do requests to the Elasticsearch API from my host with the same credentials and everything works.\r\nAlso, I use https://github.com/prometheus-community/elasticsearch_exporter which connects to the Elasticsearch instance and it also works well. Based on this, I can say that the certificates are configured correctly.\r\n> Are they from a known issuer?\r\n\r\nYes, I used Let's Encrypt for certificate request","createdAt":"2023-07-31T09:37:46Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4695#issuecomment-1658018247","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5i3Fgy","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"Can you share your config? Does it look like this?\r\n```\r\n      elasticsearch:\r\n        version: \"v8\"\r\n        url:\r\n          scheme: \"https\"\r\n          host: \"127.0.0.1:9200\"\r\n        username: <username>\r\n        password: <password>\r\n```","createdAt":"2023-07-31T15:31:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4695#issuecomment-1658607666","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5i3LiM","author":{"login":"ganievs"},"authorAssociation":"NONE","body":"> Can you share your config?\r\n\r\nUnfortanly I destroyed a test environment with the setup. If it would help, I'll spin up the env later and give you debug info.\r\n> Does it look like this?\r\n\r\nYes, it is.","createdAt":"2023-07-31T15:44:43Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4695#issuecomment-1658632332","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5i3bhU","author":{"login":"rodrigozhou"},"authorAssociation":"MEMBER","body":"I followed [these steps to setup ES with certs and authentication](https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html#_prepare_the_environment), and it worked.\r\n\r\nIn those instructions, it uses the ES tool to generate certs which are not from a known issuer, so I had to set a custom http client to Temporal Server that skip this check. Something like this:\r\n```\r\ntemporal.NewServer(\r\n  temporal.WithElasticsearchHttpClient(\r\n    &http.Client{\r\n      Transport: &http.Transport{\r\n        TLSClientConfig: &tls.Config{InsecureSkipVerify: true},\r\n      },\r\n    },\r\n  ),\r\n)\r\n```\r\n","createdAt":"2023-07-31T16:09:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/4695#issuecomment-1658697812","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5kc7Z3","author":{"login":"ganievs"},"authorAssociation":"NONE","body":"I also confirm that works! Would be helpful to mention the ability to define a custom HTTP client for Elasticsearch in [server-opritons](https://docs.temporal.io/references/server-options) on docs.temporal.io\r\n","createdAt":"2023-08-20T14:55:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/4695#issuecomment-1685304951","viewerDidAuthor":false}],"createdAt":"2023-07-27T14:33:48Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4695,"reactionGroups":[],"state":"CLOSED","title":"Temporal can't connect to Elasticsearch with enabled TLS","updatedAt":"2023-08-20T14:55:22Z","url":"https://github.com/temporalio/temporal/issues/4695"}
