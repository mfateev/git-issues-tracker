{"assignees":[],"author":{"id":"MDQ6VXNlcjEyMzE4MTQ=","is_bot":false,"login":"oleewere","name":"Oliv√©r Sz."},"body":"Postgres schema upgrade fails (Temporal 1.20) on creating btree_gin extension - related with advanced visibility - requires super user permissions\r\n\r\n## Expected Behavior\r\n\r\nbased on the current code, the outcome could be expected, but i did not find mentions about that the temporal_visiblity user needs to be super user with admin privileges (that can use untrusted languages with extensions)\r\n\r\n## Actual Behavior\r\n\r\nschema upgrade fails:\r\n\r\n```text\r\n2023-03-20T09:12:56.897Z\tINFO\tUpdateSchemeTask started\t{\"config\": {\"DBName\":\"\",\"TargetVersion\":\"\",\"SchemaDir\":\"schema/postgresql/v12/temporal/versioned\",\"IsDryRun\":false}, \"logging-call-at\": \"updatetask.go:98\"}\r\n2023-03-20T09:12:56.900Z\tDEBUG\tSchema Dirs: []\t{\"logging-call-at\": \"updatetask.go:187\"}\r\n2023-03-20T09:12:56.900Z\tDEBUG\tfound zero updates from current version 1.9\t{\"logging-call-at\": \"updatetask.go:128\"}\r\n2023-03-20T09:12:56.900Z\tINFO\tUpdateSchemeTask done\t{\"logging-call-at\": \"updatetask.go:121\"}\r\n2023-03-20T09:12:57.210Z\tINFO\tUpdateSchemeTask started\t{\"config\": {\"DBName\":\"\",\"TargetVersion\":\"\",\"SchemaDir\":\"schema/postgresql/v12/visibility/versioned\",\"IsDryRun\":false}, \"logging-call-at\": \"updatetask.go:98\"}\r\n2023-03-20T09:12:57.214Z\tDEBUG\tSchema Dirs: [v1.2]\t{\"logging-call-at\": \"updatetask.go:187\"}\r\n2023-03-20T09:12:57.214Z\tINFO\tProcessing schema file: schema/postgresql/v12/visibility/versioned/v1.2/advanced_visibility.sql\t{\"logging-call-at\": \"updatetask.go:233\"}\r\n2023-03-20T09:12:57.215Z\tDEBUG\t---- Executing updates for version 1.2 ----\t{\"logging-call-at\": \"updatetask.go:151\"}\r\n2023-03-20T09:12:57.215Z\tDEBUG\tCREATE EXTENSION btree_gin;\t{\"logging-call-at\": \"updatetask.go:153\"}\r\n2023-03-20T09:12:57.232Z\tERROR\tUnable to update SQL schema.\t{\"error\": \"error executing statement:pq: permission denied to create extension \\\"btree_gin\\\"\", \"logging-call-at\": \"handler.go:78\"}\r\ncommand terminated with exit code 1\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nThe requirement could be GCP specific (DB instance - Postgres 12)\r\nThere you cannot use the \"super admin\" but you can use \"postgres\" user or create a new (non-super) user \r\n\r\n- Start GCP postgres 12 instance with temporal_db and temporal_visibility_db databases and temporal / temporal_visibility user \r\n- Execute schema upgrade\r\n\r\nHere there is also a possible GCP specific issue (Im discussing this with them in the meantime) - as in the doc: \r\nhttps://cloud.google.com/sql/docs/postgres/users#superuser_restrictions\r\nyou cannot create a new super user, but you can add a role `cloudsqlsuperuser` to any user (by postgres user), but this is still not enough, my guess it's still need a super user, my guess is here: https://www.postgresql.org/docs/current/catalog-pg-language.html - the problem could be with `lanpltrusted ` field - as by default \"c\" is untrusted (that could be not considered by `cloudsqlsuperuser` role) - and that is used by btree_gin extension. Although \"postgres\" user can assign roles to the users, but cannot update `pg_language` table.\r\n\r\nNote that postgres user can create this extension, but in that case the temporal schema upgrade will fail with \"extension already exists\" error. \r\n\r\nSo, because of this, the question is, is it possible to add \"IF NOT EXISTS\" will be in the CREATE EXTENSION statement here: https://github.com/temporalio/temporal/blob/master/schema/postgresql/v12/visibility/versioned/v1.2/advanced_visibility.sql#L1\r\n?\r\nAlso if i would workaround this with passing a patched sql script on volume for our admintools container - if i will execute the schema upgrade on that, is it safe to do? (so if next time the script changes is it will re-run the schema upgrade or not)\r\n\r\n## Specifications\r\n\r\n  - Version: 1.20\r\n  - Platform: GCP / GKE\r\n","closedAt":"2023-03-22T08:11:11Z","comments":[{"id":"IC_kwDODNqesM5YKPL8","author":{"login":"oleewere"},"authorAssociation":"NONE","body":"google team helped me out so i was able to overcome on this. on temporal side, adding \"IF NOT EXISTS\" to the statement could help but not critical so im closing this","createdAt":"2023-03-22T08:11:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/temporal/issues/4061#issuecomment-1479078652","viewerDidAuthor":false}],"createdAt":"2023-03-20T13:46:05Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":4061,"reactionGroups":[],"state":"CLOSED","title":"Postgres (GCP instance) schema upgrade (1.20.0) - error executing statement:pq: permission denied to create extension btree_gin","updatedAt":"2023-03-22T08:11:12Z","url":"https://github.com/temporalio/temporal/issues/4061"}
