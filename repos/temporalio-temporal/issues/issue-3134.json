{"assignees":[],"author":{"id":"MDQ6VXNlcjg3NjI4OTM=","is_bot":false,"login":"wxing1292","name":"Wenquan Xing"},"body":"Do not block shard ownership assertion if `acquireShards` is blocked\r\nv1.17.x logic:\r\n\r\nshard controller will start a background thread periodically asserting shard ownership\r\n```go\r\nfor {\r\n\tselect {\r\n\t...\r\n\tcase <-acquireTicker.C:\r\n\t\tc.acquireShards()\r\n\t...\r\n\t}\r\n}\r\n```\r\n\r\nif acquireShards is blocked due to whatever reason, then no further acquireShards will be executed.\r\n\r\nOSS team should consider the following logic\r\n```go\r\nvar (\r\n\tShardController struct {\r\n\t\t...\r\n\r\n\t\tshardAssertionInProgressMutex sync.Mutex\r\n\t\tshardAssertionInProgress map[int32]struct{}\r\n\t\tshardIDChan chan int32\r\n\t\t...\r\n\t}\r\n)\r\n\r\nfunc (sc *ShardController) eventLoop() {\r\n\tacquireTicker := time.NewTicker(c.config.AcquireShardInterval())\r\n\tdefer acquireTicker.Stop()\r\n\r\n\tfor {\r\n\t\tselect {\r\n\t\tcase <-c.shutdownCh:\t\t\t\r\n\t\t\treturn\r\n\t\tcase <-acquireTicker.C:\r\n\t\t\tfor i = 0; i < totalShardIDs; i++ {\r\n\t\t\t\tshardAssertionInProgressMutex.Lock()\r\n\t\t\t\t_, exist = sc.shardAssertionInProgress[i]\r\n\t\t\t\tif !exist {\r\n\t\t\t\t\tsc.shardAssertionInProgress[i] = struct{}{}\r\n\t\t\t\t}\r\n\t\t\t\tshardAssertionInProgressMutex.Unlock()\r\n\t\t\t\tif !exist {\r\n\t\t\t\t\tsc.shardIDChan <- i\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunc (sc *ShardController) acquireShard() {\r\n\tfor shardID := range shardIDChan {\r\n\t\t...\r\n\t\t// shard ownership assertion logic here\r\n\t\t...\r\n\t\t\r\n\t\tshardAssertionInProgressMutex.Lock()\r\n\t\tdelete(sc.shardAssertionInProgress, shardID)\r\n\t\tshardAssertionInProgressMutex.Unlock()\r\n\t}\r\n}\r\n```\r\n","closedAt":null,"comments":[{"id":"IC_kwDODNqesM5HTEbu","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"I like that idea, I agree there's no reason to wait for one \"wave\" to finish before starting the next one. But also look at #3108, which will make `acquireShards` not block on individual shard rwlocks anymore, which might be enough so that this doesn't matter.","createdAt":"2022-07-27T01:58:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/3134#issuecomment-1196181230","viewerDidAuthor":false}],"createdAt":"2022-07-22T20:41:14Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":3134,"reactionGroups":[],"state":"OPEN","title":"Do not block shard ownership assertion if `acquireShards` is blocked","updatedAt":"2023-03-03T20:19:42Z","url":"https://github.com/temporalio/temporal/issues/3134"}
