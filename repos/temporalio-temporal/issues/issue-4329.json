{"assignees":[],"author":{"id":"MDQ6VXNlcjU5NDI5NjM=","is_bot":false,"login":"MichaelSnowden","name":"Michael Snowden"},"body":"**Is your feature request related to a problem? Please describe.**\r\nWhen testing Temporal, especially trying to test locally with multiple servers, it's painful to have to update the config with new free ports each time. \r\n\r\n**Describe the solution you'd like**\r\nAllow users to specify 0 for any port in the `config.Config` to let the OS choose a port when we bind. As soon as that port is bound, overwrite the port variable in the config to be the actual port.\r\n\r\n**Describe alternatives you've considered**\r\nCurrently, temporalite uses [freeport.go] to do this, but there's actually a race condition there because another process may bind to the \"free\" ports after the ephemeral listeners close, but before the temporalite server binds to them.\r\n\r\n**Additional context**\r\nAdd any other context or screenshots about the feature request here.\r\n\r\n[freeport.go]: https://github.com/temporalio/temporalite/blob/main/internal/liteconfig/freeport.go","closedAt":"2023-12-27T18:40:30Z","comments":[{"id":"IC_kwDODNqesM5hyQGy","author":{"login":"edmondop"},"authorAssociation":"NONE","body":"I do have a draft version that I need to rebase that you can see [here](https://github.com/temporalio/temporal/compare/master...edmondop:temporal:issue-4329?expand=1):\r\n\r\nIt uses two ideas:\r\n- using `*config.Service` instead of `config.Service`\r\n- delaying the \"get\" of the port for monitoring after the service has started\r\n\r\n\r\nHowever, this doesn't work for the worker service. As you see, for history, matching and frontend we have a \"setting bound port\" log entry, which is absent for the worker service\r\n\r\n```\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.221-0700\",\"msg\":\"Successfully saved cluster metadata.\",\"component\":\"metadata-initializer\",\"cluster-name\":\"active\",\"logging-call-at\":\"fx.go:687\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.221-0700\",\"msg\":\"Use rpc address 127.0.0.1:7233 for cluster active.\",\"component\":\"metadata-initializer\",\"logging-call-at\":\"fx.go:843\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.228-0700\",\"msg\":\"Setting bound port for\",\"service\":\"history\",\"logging-call-at\":\"rpc.go:150\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.228-0700\",\"msg\":\"Created gRPC listener\",\"service\":\"history\",\"address\":\"127.0.0.1:51941\",\"logging-call-at\":\"rpc.go:154\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.232-0700\",\"msg\":\"Setting bound port for\",\"service\":\"matching\",\"logging-call-at\":\"rpc.go:150\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.232-0700\",\"msg\":\"Created gRPC listener\",\"service\":\"matching\",\"address\":\"127.0.0.1:51943\",\"logging-call-at\":\"rpc.go:154\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.236-0700\",\"msg\":\"Setting bound port for\",\"service\":\"frontend\",\"logging-call-at\":\"rpc.go:150\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.236-0700\",\"msg\":\"Created gRPC listener\",\"service\":\"frontend\",\"address\":\"127.0.0.1:7233\",\"logging-call-at\":\"rpc.go:154\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.236-0700\",\"msg\":\"Service is not requested, skipping initialization.\",\"service\":\"internal-frontend\",\"logging-call-at\":\"fx.go:482\"}\r\nStarting UI server...\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.238-0700\",\"msg\":\"Starting server for services\",\"value\":{\"frontend\":{},\"history\":{},\"matching\":{},\"worker\":{}},\"logging-call-at\":\"server_impl.go:88\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.238-0700\",\"msg\":\"PProf listen on \",\"port\":51939,\"logging-call-at\":\"pprof.go:73\"}\r\n\r\n   ____    __\r\n  / __/___/ /  ___\r\n / _// __/ _ \\/ _ \\\r\n/___/\\__/_//_/\\___/ v4.9.0\r\nHigh performance, minimalist Go web framework\r\nhttps://echo.labstack.com\r\n____________________________________O/_______\r\n                                    O\\\r\nâ‡¨ http server started on 127.0.0.1:8233\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.241-0700\",\"msg\":\"Membership heartbeat upserted successfully\",\"address\":\"127.0.0.1\",\"port\":51942,\"hostId\":\"7fa33e1a-2588-11ee-9a1f-ca09410b0e4a\",\"logging-call-at\":\"monitor.go:257\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.241-0700\",\"msg\":\"RuntimeMetricsReporter started\",\"service\":\"matching\",\"logging-call-at\":\"runtime.go:138\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.241-0700\",\"msg\":\"bootstrap hosts fetched\",\"bootstrap-hostports\":\"127.0.0.1:51942\",\"logging-call-at\":\"monitor.go:299\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.242-0700\",\"msg\":\"RuntimeMetricsReporter started\",\"service\":\"worker\",\"logging-call-at\":\"runtime.go:138\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.242-0700\",\"msg\":\"RuntimeMetricsReporter started\",\"service\":\"frontend\",\"logging-call-at\":\"runtime.go:138\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.242-0700\",\"msg\":\"Current reachable members\",\"component\":\"service-resolver\",\"service\":\"history\",\"addresses\":[\"127.0.0.1:51941\"],\"logging-call-at\":\"service_resolver.go:280\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.242-0700\",\"msg\":\"Membership heartbeat upserted successfully\",\"address\":\"127.0.0.1\",\"port\":51944,\"hostId\":\"7fa46146-2588-11ee-9a1f-ca09410b0e4a\",\"logging-call-at\":\"monitor.go:257\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.242-0700\",\"msg\":\"Membership heartbeat upserted successfully\",\"address\":\"127.0.0.1\",\"port\":51946,\"hostId\":\"7fa54372-2588-11ee-9a1f-ca09410b0e4a\",\"logging-call-at\":\"monitor.go:257\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.242-0700\",\"msg\":\"Membership heartbeat upserted successfully\",\"address\":\"127.0.0.1\",\"port\":51940,\"hostId\":\"7fa4e364-2588-11ee-9a1f-ca09410b0e4a\",\"logging-call-at\":\"monitor.go:257\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.242-0700\",\"msg\":\"bootstrap hosts fetched\",\"bootstrap-hostports\":\"127.0.0.1:51940,127.0.0.1:51946,127.0.0.1:51942,127.0.0.1:51944\",\"logging-call-at\":\"monitor.go:299\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.242-0700\",\"msg\":\"fifo scheduler started\",\"service\":\"history\",\"logging-call-at\":\"fifo_scheduler.go:96\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.242-0700\",\"msg\":\"interleaved weighted round robin task scheduler started\",\"service\":\"history\",\"logging-call-at\":\"interleaved_weighted_round_robin.go:197\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.243-0700\",\"msg\":\"bootstrap hosts fetched\",\"bootstrap-hostports\":\"127.0.0.1:51940,127.0.0.1:51946,127.0.0.1:51942,127.0.0.1:51944\",\"logging-call-at\":\"monitor.go:299\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.243-0700\",\"msg\":\"fifo scheduler started\",\"service\":\"history\",\"logging-call-at\":\"fifo_scheduler.go:96\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.243-0700\",\"msg\":\"interleaved weighted round robin task scheduler started\",\"service\":\"history\",\"logging-call-at\":\"interleaved_weighted_round_robin.go:197\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.243-0700\",\"msg\":\"fifo scheduler started\",\"service\":\"history\",\"component\":\"memory-scheduled-queue-processor\",\"logging-call-at\":\"fifo_scheduler.go:96\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.243-0700\",\"msg\":\"bootstrap hosts fetched\",\"bootstrap-hostports\":\"127.0.0.1:51942,127.0.0.1:51944,127.0.0.1:51940,127.0.0.1:51946\",\"logging-call-at\":\"monitor.go:299\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.243-0700\",\"msg\":\"fifo scheduler started\",\"service\":\"history\",\"logging-call-at\":\"fifo_scheduler.go:96\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.243-0700\",\"msg\":\"interleaved weighted round robin task scheduler started\",\"service\":\"history\",\"logging-call-at\":\"interleaved_weighted_round_robin.go:197\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.244-0700\",\"msg\":\"RuntimeMetricsReporter started\",\"service\":\"history\",\"logging-call-at\":\"runtime.go:138\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.244-0700\",\"msg\":\"sequential scheduler started\",\"logging-call-at\":\"sequential_scheduler.go:96\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.244-0700\",\"msg\":\"history starting\",\"service\":\"history\",\"logging-call-at\":\"service.go:101\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.244-0700\",\"msg\":\"Replication task fetchers started.\",\"logging-call-at\":\"task_fetcher.go:143\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.245-0700\",\"msg\":\"none\",\"component\":\"shard-controller\",\"address\":\"127.0.0.1:51942\",\"lifecycle\":\"Started\",\"logging-call-at\":\"controller_impl.go:131\"}\r\n{\"level\":\"info\",\"ts\":\"2023-07-18T09:31:08.245-0700\",\"msg\":\"Starting to serve on history listener\",\"service\":\"history\",\"logging-call-at\":\"service.go:113\"}\r\n{\"level\":\"fatal\",\"ts\":\"2023-07-18T09:31:08.245-0700\",\"msg\":\"unable to get get bound port \",\"service\":\"worker\",\"error\":\"accessing GRPC port before it has been bound\",\"logging-call-at\":\"monitor.go:147\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Fatal\\n\\t/Users/edmondoporcu/Development/open-source/temporal/common/log/zap_logger.go:180\\ngo.temporal.io/server/common/membership/ringpop.(*monitor).Start\\n\\t/Users/edmondoporcu/Development/open-source/temporal/common/membership/ringpop/monitor.go:147\\ngo.uber.org/fx/internal/lifecycle.Wrap[...].func1\\n\\t/Users/edmondoporcu/go/pkg/mod/go.uber.org/fx@v1.20.0/internal/lifecycle/lifecycle.go:80\\ngo.uber.org/fx/internal/lifecycle.(*Lifecycle).runStartHook\\n\\t/Users/edmondoporcu/go/pkg/mod/go.uber.org/fx@v1.20.0/internal/lifecycle/lifecycle.go:256\\ngo.uber.org/fx/internal/lifecycle.(*Lifecycle).Start\\n\\t/Users/edmondoporcu/go/pkg/mod/go.uber.org/fx@v1.20.0/internal/lifecycle/lifecycle.go:216\\ngo.uber.org/fx.(*App).start.func1\\n\\t/Users/edmondoporcu/go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:679\\ngo.uber.org/fx.(*App).withRollback\\n\\t/Users/edmondoporcu/go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:661\\ngo.uber.org/fx.(*App).start\\n\\t/Users/edmondoporcu/go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:678\\ngo.uber.org/fx.withTimeout.func1\\n\\t/Users/edmondoporcu/go/pkg/mod/go.uber.org/fx@v1.20.0/app.go:782\"}\r\n```","createdAt":"2023-07-18T16:36:09Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4329#issuecomment-1640563122","viewerDidAuthor":false},{"id":"IC_kwDODNqesM5vfjeT","author":{"login":"MichaelSnowden"},"authorAssociation":"CONTRIBUTOR","body":"We decided to not do this as all major operating systems will reserve ports for 60 seconds before making them available again.","createdAt":"2023-12-27T18:40:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4329#issuecomment-1870542739","viewerDidAuthor":false}],"createdAt":"2023-05-12T17:27:27Z","labels":[{"id":"MDU6TGFiZWwxNjIxMDMwNzg3","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwxNjIxMDMwNzg5","name":"good first issue","description":"Good for newcomers","color":"7057ff"}],"milestone":null,"number":4329,"reactionGroups":[],"state":"CLOSED","title":"Allow zero port in config","updatedAt":"2023-12-27T18:40:30Z","url":"https://github.com/temporalio/temporal/issues/4329"}
