{"assignees":[],"author":{"id":"MDQ6VXNlcjM1MTEzNDQ2","is_bot":false,"login":"vikstrous2","name":"Viktor Stanchev"},"body":"## Expected Behavior\r\nGraceful error handling\r\n\r\n## Actual Behavior\r\n```\r\npanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x10 pc=0xebe954]\r\n\r\ngoroutine 1 [running]:\r\ngo.temporal.io/server/tools/sql.(*Connection).Close(0x0)\r\n\t/temporal/tools/sql/conn.go:120 +0x14\r\npanic({0xf78e80, 0x1a77a30})\r\n\t/usr/local/go/src/runtime/panic.go:1038 +0x215\r\ngo.temporal.io/server/tools/sql.(*Connection).ReadSchemaVersion(0xc000411d30)\r\n\t/temporal/tools/sql/conn.go:65 +0x14\r\ngo.temporal.io/server/tools/common/schema.(*UpdateTask).Run(0xc00071f608)\r\n\t/temporal/tools/common/schema/updatetask.go:106 +0x223\r\ngo.temporal.io/server/tools/common/schema.Update(0xc000411d30, {0x12ed200, 0x0}, {0x12e8ed8, 0xc000411d30})\r\n\t/temporal/tools/common/schema/handler.go:48 +0x98\r\ngo.temporal.io/server/tools/sql.updateSchema(0x7fea47570060, {0x12e8ed8, 0xc000411d30})\r\n\t/temporal/tools/sql/handler.go:76 +0x51a\r\ngo.temporal.io/server/tools/sql.cliHandler(0x2, 0x1126110, {0x12e8ed8, 0xc000411d30})\r\n\t/temporal/tools/sql/main.go:48 +0x56\r\ngo.temporal.io/server/tools/sql.BuildCLIOptions.func2(0xc0000b66e0)\r\n\t/temporal/tools/sql/main.go:185 +0x2b\r\ngithub.com/urfave/cli.HandleAction({0xf317a0, 0xc000411d50}, 0xd)\r\n\t/go/pkg/mod/github.com/urfave/cli@v1.22.5/app.go:526 +0x50\r\ngithub.com/urfave/cli.Command.Run({{0x10af830, 0xd}, {0x0, 0x0}, {0xc000411d90, 0x1, 0x1}, {0x10dcff0, 0x27}, {0x0, ...}, ...}, ...)\r\n\t/go/pkg/mod/github.com/urfave/cli@v1.22.5/command.go:173 +0x652\r\ngithub.com/urfave/cli.(*App).Run(0xc00045e8c0, {0xc00012c040, 0x4, 0x4})\r\n\t/go/pkg/mod/github.com/urfave/cli@v1.22.5/app.go:277 +0x705\r\ngo.temporal.io/server/tools/sql.RunTool({0xc00012c040, 0x4, 0x4})\r\n\t/temporal/tools/sql/main.go:42 +0x3c\r\nmain.main()\r\n\t/temporal/cmd/tools/sql/main.go:36 +0x2e\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nTry to run migrations:\r\n```\r\nexport SQL_PLUGIN=postgres\r\nexport SQL_HOST=127.0.0.1\r\nexport SQL_PORT=5432\r\nexport SQL_USER=temporal\r\nSQL_DATABASE=temporal temporal-sql-tool update --schema-dir /etc/temporal/schema/postgresql/v96/temporal/versioned\r\n```\r\n\r\nI'm not sure if the issue is that the migrations had already been run or something else, but this seems to panic randomly, so hopefully this is enough context.\r\n\r\n## Specifications\r\n\r\n  - Version: 1.13.1\r\n  - Platform: docker/kubernetes\r\n","closedAt":"2022-01-07T22:20:22Z","comments":[{"id":"IC_kwDODNqesM47IKTv","author":{"login":"vikstrous2"},"authorAssociation":"NONE","body":"Update: actually, this seems to happen BEFORE migrations succeed, so maybe it just has a random chance of happening. The last log entry before the panic is:\r\n```\r\nUpdateSchemeTask started\t{\"config\": {\"DBName\":\"\",\"TargetVersion\":\"\",\"SchemaDir\":\"/etc/temporal/schema/postgresql/v96/temporal/versioned\",\"IsDryRun\":false}, \"logging-call-at\": \"updatetask.go:98\"}\r\n```","createdAt":"2021-12-12T23:45:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2294#issuecomment-991995119","viewerDidAuthor":false},{"id":"IC_kwDODNqesM47bjMS","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"https://github.com/temporalio/temporal/pull/2250","createdAt":"2021-12-17T22:55:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/2294#issuecomment-997077778","viewerDidAuthor":false}],"createdAt":"2021-12-12T23:42:30Z","labels":[{"id":"MDU6TGFiZWwyMDE5ODE3MzQ2","name":"potential-bug","description":"","color":"66b9cc"}],"milestone":null,"number":2294,"reactionGroups":[],"state":"CLOSED","title":"nil pointer in temporal-sql-tool update","updatedAt":"2022-01-07T22:20:22Z","url":"https://github.com/temporalio/temporal/issues/2294"}
