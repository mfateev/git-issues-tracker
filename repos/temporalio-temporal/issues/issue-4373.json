{"assignees":[],"author":{"id":"MDQ6VXNlcjU1MzU3NDQ=","is_bot":false,"login":"akashsax14","name":"Akash Saxena"},"body":"Issue\r\n===\r\nWe are using typescript sdk to send a signal (with args) to a list of workflows using batch operation. The worker is setup with the default data convertor/default settings. When the signal is received by the workflow we get an error. \r\n\r\n### Error\r\n```\r\n{\r\n  \"message\": \"Unknown encoding: binary/protobuf\",\r\n  \"source\": \"TypeScriptSDK\",\r\n  \"stackTrace\": \"/app/workflow-bundle-5feb3d484fc78c2a5e62.js:4067\\n            throw new errors_1.ValueError(`Unknown encoding: ${encoding}`);\\n            ^\\n\\nValueError: Unknown encoding: binary/protobuf\\n    at DefaultPayloadConverter.fromPayload (/app/node_modules/@temporalio/common/src/converter/payload-converter.ts:163:12)\\n    at /app/node_modules/@temporalio/common/src/converter/payload-converter.ts:84:54\\n    at Array.map (<anonymous>)\\n    at arrayFromPayloads (/app/node_modules/@temporalio/common/src/converter/payload-converter.ts:84:18)\\n    at Activator.signalWorkflow (/app/node_modules/@temporalio/workflow/src/internals.ts:545:30)\\n    at /app/node_modules/@temporalio/workflow/src/worker-interface.ts:215:29\\n    at Object.activate (/app/node_modules/@temporalio/workflow/src/worker-interface.ts:221:2)\\n    at evalmachine.<anonymous>:1:18\",\r\n  \"encodedAttributes\": null,\r\n  \"cause\": null\r\n}\r\n```\r\n\r\n### Stack Trace\r\n```\r\n/app/workflow-bundle-5feb3d484fc78c2a5e62.js:4067\r\n            throw new errors_1.ValueError(Unknown encoding: ${encoding});\r\n            ^\r\nValueError: Unknown encoding: binary/protobuf\r\n    at DefaultPayloadConverter.fromPayload (/app/node_modules/@temporalio/common/src/converter/payload-converter.ts:163:12)\r\n    at /app/node_modules/@temporalio/common/src/converter/payload-converter.ts:84:54\r\n    at Array.map (<anonymous>)\r\n    at arrayFromPayloads (/app/node_modules/@temporalio/common/src/converter/payload-converter.ts:84:18)\r\n    at Activator.signalWorkflow (/app/node_modules/@temporalio/workflow/src/internals.ts:545:30)\r\n    at /app/node_modules/@temporalio/workflow/src/worker-interface.ts:215:29\r\n    at Object.activate (/app/node_modules/@temporalio/workflow/src/worker-interface.ts:221:2)\r\n    at evalmachine.<anonymous>:1:18\r\n```\r\n\r\n### Sample signal args received by workflow\r\n```\r\n[\r\n  {\r\n    \"metadata\": {\r\n      \"encoding\": \"YmluYXJ5L3Byb3RvYnVm\",\r\n      \"messageType\": \"dGVtcG9yYWwuYXBpLmNvbW1vbi52MS5QYXlsb2Fkcw==\",\r\n      \"encodingDecoded\": \"binary/protobuf\"\r\n    },\r\n    \"data\": \"ChwKFgoIZW5jb2RpbmcSCmpzb24vcGxhaW4SAnt9\"\r\n  }\r\n]\r\n```\r\n\r\n### Batch Request\r\n\r\n```\r\nexport async function sendSignals(\r\n  temporalClient: WorkflowClient,\r\n  temporalWorkflowIds: string[],\r\n  signalDef: string,\r\n  args: any,\r\n  reason: string,\r\n) {\r\n  const batchOperationRequest: temporal.api.workflowservice.v1.IStartBatchOperationRequest = {\r\n    namespace: TEMPORAL_NAMESPACE,\r\n    jobId: randomUUID(),\r\n    reason,\r\n    signalOperation: {\r\n      input: {\r\n        payloads: [{ etag: args[\"etag\"], isDefault: args[\"isDefault\"] }].map((arg) =>\r\n          temporalClient.options.loadedDataConverter.payloadConverter.toPayload(arg),\r\n        ),\r\n      },\r\n      signal: signalDef,\r\n    },\r\n    executions: temporalWorkflowIds.map((id) => ({ workflowId: id })),\r\n  };\r\n  await temporalClient.workflowService.startBatchOperation(batchOperationRequest);\r\n}\r\n```\r\n\r\nExpected\r\n======\r\nThat the signal args should be correctly received by the workflow when sending a signal using batch operation. ","closedAt":"2023-06-02T12:43:56Z","comments":[{"id":"IC_kwDODNqesM5cr9Fv","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"**Extra notes**\r\n\r\nThis error happens using _raw gRPC calls_ (there is no high level client API for this in any SDK). I confirmed that the structure of the protobuf request sent to the server is correct, but the server seems to reencode the signal input's payloads.","createdAt":"2023-05-19T17:47:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/temporal/issues/4373#issuecomment-1555026287","viewerDidAuthor":false}],"createdAt":"2023-05-19T17:38:19Z","labels":[],"milestone":null,"number":4373,"reactionGroups":[],"state":"CLOSED","title":"Sending signal using batch request gives error in workflow","updatedAt":"2023-06-02T12:43:56Z","url":"https://github.com/temporalio/temporal/issues/4373"}
