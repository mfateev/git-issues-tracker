{"assignees":[{"id":"MDQ6VXNlcjk5NTk3NjE=","login":"seregazhuk","name":"Sergey Zhuk","databaseId":0}],"author":{"id":"MDQ6VXNlcjQ1Mjk5NTE2","is_bot":false,"login":"LikDioxo","name":"Ihor Berest"},"body":"### What are you really trying to do?\r\n\r\nI was trying to create a Workflow that could be stopped by sending the signal and that simultaneously run several tasks.\r\nThe idea behind simultaneous tasks consists of waiting for a signal with data and trying to get this data in case that signal wasn't called.\r\nSo generally workflow consists of 4 asynchronous tasks:\r\n\r\n1. \"main\" - a task that contains all other code and can be rejected by sending a specific signal\r\n2. Rejection task - checks for signal and reject \"main\" task when the signal is received\r\n3. Task waiting for the signal with required data\r\n4. Task that calls activity to get the same data as the previous task. Also contains a timer and infinitely calls the activity until get the required data.\r\n\r\n### Describe the bug\r\n\r\nDepending on the order of declaring the two last tasks (that wait for a signal with data and that call activity to get that data) \"main\" task can either be rejected when one of the tasks finishes or can proceed successfully.\r\n\r\n### Minimal Reproduction\r\n\r\n```php\r\n    private bool $isSignaled = false;\r\n    private bool $isRejected = false;\r\n\r\n    private Workflow\\CancellationScopeInterface $first;\r\n    private Workflow\\CancellationScopeInterface $second;\r\n\r\n    #[WorkflowMethod]\r\n    public function execute(): \\Generator\r\n    {\r\n        $workflowPromise = Workflow::async(\r\n            function () {\r\n                $this->first = Workflow::async(\r\n                    function () {\r\n                        yield Workflow::await(fn() => $this->isSignaled);\r\n\r\n                        $this->second->cancel();\r\n                        print \"First finished\";\r\n                    }\r\n                );\r\n\r\n                $this->second = Workflow::async(\r\n                    function () {\r\n                        yield Workflow::timer(5);\r\n\r\n                        $this->first->cancel();\r\n                        print \"Second finished\";\r\n                    }\r\n                );\r\n\r\n                yield Promise::race([$this->second, $this->first]);\r\n\r\n                print \"Main finished\";\r\n            }\r\n        )->then(onRejected: fn() => print \"Main rejected!\");\r\n\r\n        Workflow::async(\r\n            function () use ($workflowPromise) {\r\n                yield Workflow::await(fn() => $this->isRejected);\r\n                $workflowPromise->cancel();\r\n            }\r\n        );\r\n\r\n        yield $workflowPromise;\r\n    }\r\n\r\n    #[Workflow\\SignalMethod]\r\n    public function signal(): void\r\n    {\r\n        $this->isSignaled = true;\r\n    }\r\n```\r\n\r\nIn such flow, the output is following. When the second task finishes after the timer the message \"Main rejected!\" is displayed.\r\nIn case I send a signal before the timer is finished the message \"Main finished\" is displayed which is the expected result.\r\n\r\nBut when I declare $this->second before $this->first in both cases \"Main finished\" is displayed.\r\n\r\nExpected behavior: order of declaration async tasks doesn't affect the normal flow of execution.\r\nActual behavior: in some order of declaration async tasks \"main\" task is rejected.\r\n\r\n### Additional context\r\n![image](https://user-images.githubusercontent.com/45299516/179424601-1e7a188e-01d4-43e7-8035-e9d9757417d1.png)\r\n![image](https://user-images.githubusercontent.com/45299516/179424641-4f7bd6d2-1e40-46b3-9828-ef98d1d7c07f.png)\r\n","closedAt":"2022-08-01T18:38:53Z","comments":[{"id":"IC_kwDOEY5HBM5HHULR","author":{"login":"seregazhuk"},"authorAssociation":"CONTRIBUTOR","body":"@LikDioxo I have found the issue. The problem is with `Workflow::await()`. It doesn't resolve/reject correctly. Thus the main async becomes rejected. In both your cases it should be resolved, not rejected. Even though both internal async-s were canceled/rejected the main async completes and thus `print \"Main finished\";` should be executed. Please, don't depend on the result of the main async in your code. And the fix will be released the next week (Wednesday).","createdAt":"2022-07-23T10:08:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/207#issuecomment-1193099985","viewerDidAuthor":false}],"createdAt":"2022-07-18T11:00:43Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":207,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Order of declaration async tasks completely change the execution flow of Workflow","updatedAt":"2022-08-01T18:38:53Z","url":"https://github.com/temporalio/sdk-php/issues/207"}
