{"assignees":[{"id":"MDQ6VXNlcjQxNTI0ODE=","login":"roxblnfk","name":"Aleksei Gagarin","databaseId":0}],"author":{"id":"MDQ6VXNlcjQzNDA0MzQw","is_bot":false,"login":"sdellarosa","name":"S. Dellarosa"},"body":"### What are you really trying to do?\r\n\r\nI would like to use a custom data converter that converts all payloads into an encrypted payload.\r\n\r\n### Describe the bug\r\n\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n\r\nI have created my own implementation of `DataConverterInterface`, which I supply to both the client and the worker. This new converter uses the default `DataConverter` from the SDK to convert a value into a `Payload`, then converts this payload into an encrypted payload (see class below).\r\n\r\n```php\r\nclass MyDataConverter implements DataConverterInterface\r\n{\r\n    public function __construct()\r\n    {\r\n        $this->defaultDataConverter = DataConverter::createDefault();\r\n        $this->encryptedPayloadConverter = new EncryptedPayloadConverter();\r\n    }\r\n\r\n    public function toPayload($value): Payload\r\n    {\r\n        $payload = $this->defaultDataConverter->toPayload($value);\r\n\r\n        return $this->encryptedPayloadConverter->encrypt($payload);\r\n    }\r\n\r\n    public function fromPayload(Payload $payload, $type): mixed\r\n    {\r\n        $payload = $this->encryptedPayloadConverter->decrypt($payload);\r\n\r\n        return $this->defaultDataConverter->fromPayload($payload, new Type(TYPE::TYPE_ANY));\r\n    }\r\n}\r\n\r\nclass EncryptedPayloadConverter\r\n{\r\n    public function encrypt(Payload $payload): Payload\r\n    {\r\n        $encrypted = new Payload();\r\n        $encrypted->setMetadata([EncodingKeys::METADATA_ENCODING_KEY => 'binary/encrypted']);\r\n        $encrypted->setData($this->encryptString($payload->serializeToString()));\r\n\r\n        return $encrypted;\r\n    }\r\n\r\n    public function decrypt(Payload $payload): Payload\r\n    {\r\n        $decrypted = new Payload();\r\n        $decrypted->mergeFromString($this->decryptString($payload->getData()));\r\n\r\n        return $decrypted;\r\n    }\r\n}\r\n```\r\n\r\nWhen using the client to start a workflow, I can see that the workflow execution can be successfully started, with the input arguments encoded in `binary/encrypted`, as I intended. But, when I start RoadRunner for the worker (`./rr serve`), I get the error below and my worker is unable to start.\r\n\r\n```\r\n2023-01-09T09:38:40.002Z        INFO    temporal        connected to temporal server    {\"address\": \"temporal:7233\"}\r\n2023-01-09T09:38:40.367Z        DEBUG   server          worker is allocated     {\"pid\": 23, \"internal_event_name\": \"EventWorkerConstruct\"}\r\n2023-01-09T09:38:40.742Z        DEBUG   server          worker is allocated     {\"pid\": 27, \"internal_event_name\": \"EventWorkerConstruct\"}\r\n2023-01-09T09:38:40.742Z        DEBUG   temporal        outgoing message        {\"id\": 0, \"data\": \"\", \"context\": \"\"}\r\n2023-01-09T09:38:40.816Z        DEBUG   temporal        received message        {\"command\": null, \"id\": 0, \"data\": \"\\n\\ufffd\\^G*\\ufffd\\^G\\n\\ufffd\\^F\\n\\^\\\\n\\^Hencoding\\^R\\^Pbinary/encrypted\\^R\\ufffd\\^FsIHh0C5aq1zf0KD7+z1OEv5kpwdKu2KPDsn5E8YRvxuo/uM0CsXqOFBnWwbgZc7GoioM0aLiqxBdBO+VdtGzeNziooMpIHkAUVqR4QgsB8Ge1IarnIJl7BfEF8Pet2Ov9EMrmdGEamznpDULv1UwYe/qFRhQhTgP9YwLr+SzH0KycxodQ2+/Q2BXCKnt/b7wmNyQUD1v8vdSlp7gE3EpQBY9J/BBhoAx/URGj8ruGibJ5NiFSsLS40njvvxwsw1kpgODqjh7KhgxhuyYgMm6rdNVcpauAmV3RXSSHUKkyRoelh1jQbkxeDPvnp+Om6DWBh0CQPREOH/UbG2GXtwxrfsYdrBz+kZsWSQ7MsJExe0BfyyuoJD1XIAU8tMEqjejRLfHNKohwv8rcQzPGT9B1PETWREOdbj87uFzRDjQ1cgQD9F1BThjgluj6eOtRwGlaSGykSw2KVlUOp4VubCJOvCFIhbI4zUfPLmKp4woQoDEsBNoqdZNn3sTnVwyODdcejBNXGzyKfQEVV2gwGh+yqIbH8uBn27RAfYR5n4SUDv+FsYR1za03N19G1Ph5J32MSLoHzDkpgHJRvb9LkQf4a9m2VnntmPd9qa1Etl5LvCZRCM/3zkKvsHgjtJgypjbQHyKOJjI6nBe3ah0skuJgTApig3dPESGAmPT0J4NsnU79E/XIfJHtX8za/NwIyfehzpWqPoMWkYKJiKNejQybwCt8WdBjd6tyDnRMSDiGy/kRyTNkMNMMTreQI/0BawGHlRGZl7QVpjmyG+fpCMx62hgQz63xv6jSRxPVAAuruVz8Hdh34r4AnOb6TMMaAwG83n5NP9NGxC8uHHVR6uI0+Rgkg==\"}\r\n2023-01-09T09:38:40.830Z        DEBUG   server          worker destroyed        {\"pid\": 23, \"internal_event_name\": \"EventWorkerDestruct\"}\r\n2023-01-09T09:38:40.841Z        DEBUG   server          worker destroyed        {\"pid\": 27, \"internal_event_name\": \"EventWorkerDestruct\"}\r\nhandle_serve_command: Serve error:\r\n        endure_start:\r\n        endure_serve_internal: Function call error:\r\n        endure_call_serve_fn: got initial serve error from the Vertex roadrunner_temporal.Plugin, stopping execution, error: temporal_plugin_serve:\r\n        workflow_definition_init:\r\n        workflow_fetch_wf_info: encoding binary/encrypted: payload encoding is not supported\r\n```\r\n\r\nIf I don't supply my custom data converter, my worker successfully starts with the following logs.\r\n```\r\n2023-01-09T09:37:11.500Z        INFO    temporal        connected to temporal server    {\"address\": \"temporal:7233\"}\r\n2023-01-09T09:37:12.244Z        DEBUG   server          worker is allocated     {\"pid\": 23, \"internal_event_name\": \"EventWorkerConstruct\"}\r\n2023-01-09T09:37:12.723Z        DEBUG   server          worker is allocated     {\"pid\": 27, \"internal_event_name\": \"EventWorkerConstruct\"}\r\n2023-01-09T09:37:12.723Z        DEBUG   temporal        outgoing message        {\"id\": 0, \"data\": \"\", \"context\": \"\"}\r\n2023-01-09T09:37:12.873Z        DEBUG   temporal        received message        {\"command\": null, \"id\": 0, \"data\": \"\\n\\ufffd\\^D*\\ufffd\\^D\\n\\ufffd\\^D\\n\\^V\\n\\^Hencoding\\^R\\njson/plain\\^R\\ufffd\\^D{\\\"TaskQueue\\\":\\\"default\\\",\\\"Options\\\":{\\\"MaxConcurrentActivityExecutionSize\\\":0,\\\"WorkerActivitiesPerSecond\\\":0.0,\\\"MaxConcurrentLocalActivityExecutionSize\\\":0,\\\"WorkerLocalActivitiesPerSecond\\\":0.0,\\\"TaskQueueActivitiesPerSecond\\\":0.0,\\\"MaxConcurrentActivityTaskPollers\\\":0,\\\"MaxConcurrentWorkflowTaskExecutionSize\\\":0,\\\"MaxConcurrentWorkflowTaskPollers\\\":0,\\\"StickyScheduleToStartTimeout\\\":null,\\\"WorkerStopTimeout\\\":null,\\\"EnableSessionWorker\\\":false,\\\"SessionResourceID\\\":null,\\\"MaxConcurrentSessionExecutionSize\\\":1000},\\\"Workflows\\\":[{\\\"Name\\\":\\\"HealthWorkflow\\\",\\\"Queries\\\":[],\\\"Signals\\\":[]}],\\\"Activities\\\":[]}\"}\r\n2023-01-09T09:37:12.873Z        DEBUG   temporal        worker info     {\"taskqueue\": \"default\", \"optionsError\": \"json: unsupported type: func(error)\"}\r\n2023-01-09T09:37:12.873Z        DEBUG   temporal        workflow registered     {\"taskqueue\": \"default\", \"workflow name\": \"HealthWorkflow\"}\r\n2023-01-09T09:37:12.873Z        DEBUG   temporal        workers initialized     {\"num_workers\": 1}\r\n2023-01-09T09:37:12.942Z        INFO    temporal        Started Worker  {\"Namespace\": \"default\", \"TaskQueue\": \"default\", \"WorkerID\": \"default:709d473a-d9e1-40c7-8ceb-371f2dd1c17c\"}\r\n2023-01-09T09:37:12.942Z        DEBUG   rpc             plugin was started      {\"address\": \"tcp://127.0.0.1:6001\", \"list of the plugins with RPC methods:\": [\"informer\", \"resetter\", \"temporal\"]}\r\n```\r\n\r\nTo try to at least start the worker, I decided to see if skipping conversion on the first received message would help. But to skip the message, I cannot just simply skip converting all JSON payloads because workflow input and result payloads are in the JSON format, and these are the most important for me to encrypt. So instead, I added the following to my payload converter.\r\n\r\n```php\r\nclass EncryptedPayloadConverter\r\n{\r\n    public function encrypt(Payload $payload): Payload\r\n    {\r\n        $json = json_decode($payload->getData(), associative: true);\r\n\r\n        if ($json && is_array($json) &&\r\n            array_key_exists('TaskQueue', $json) &&\r\n            array_key_exists('Options', $json) &&\r\n            array_key_exists('Workflows', $json) &&\r\n            array_key_exists('Activities', $json)\r\n        ) {\r\n            return $payload;\r\n        }\r\n\r\n        $encrypted = new Payload();\r\n        $encrypted->setMetadata([EncodingKeys::METADATA_ENCODING_KEY => 'binary/encrypted']);\r\n        $encrypted->setData($this->encryptString($payload->serializeToString()));\r\n\r\n        return $encrypted;\r\n    }\r\n}\r\n```\r\n\r\nWith this added, I can see that my worker can successfully start, and my workflow tasks are picked up and my workflow execution is completed, with the results payload encoded with `binary/encrypted`. Based on this, I suspect that the issue is that one of the underlying systems (perhaps RoadRunner, Goridge, etc) do not support the custom encoding.\r\n\r\nWhile this works, this is kind of a hacky solution, and there's no way of knowing if there is any other internal messages that cannot be converted with a custom encoding which could cause the worker to error out and stop. Is there any other way to solve this problem?\r\n\r\n### Minimal Reproduction\r\n\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\nFollow the steps above.\r\n\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: macOS Ventura (Intel)\r\n- Temporal Version: 1.18.4, and SDK version: 2.3.1\r\n- Docker\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n\r\n","closedAt":"2023-09-05T18:04:25Z","comments":[{"id":"IC_kwDOEY5HBM5STRv1","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"Can you provide logs about a worker annihilation?\r\n\r\nPlease add that section in your `rr.yaml`\r\n\r\n```yml\r\nlogs:\r\n    mode: development\r\n    level: debug\r\n    file_logger_options:\r\n        log_output: \"log.log\"\r\n```","createdAt":"2023-01-12T17:52:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1380785141","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5SYSTD","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@sdellarosa You are going to introduce new data converter type `binary/encrypted` which is not supported by Temporal GO-SDK (Roadrunner use GO-SDK under the hood).\r\n\r\nTake a look here:\r\nhttps://github.com/temporalio/sdk-go/blob/6580cbe0aa41a8b515791f95c2c15bb37db1dab1/converter/default_data_converter.go#L28\r\nhttps://github.com/temporalio/sdk-go/blob/6580cbe0aa41a8b515791f95c2c15bb37db1dab1/converter/composite_data_converter.go#L125\r\n\r\nYou need to check if Temporal itself supports own data converter.\r\n\r\n\r\n","createdAt":"2023-01-13T16:34:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1382098115","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5SgQ6V","author":{"login":"sdellarosa"},"authorAssociation":"NONE","body":"@roxblnfk This is what I got in the logs:\r\n\r\n```\r\n{\"level\":\"INFO\",\"ts\":\"2023-01-16T14:02:15.846Z\",\"logger\":\"temporal    \",\"msg\":\"connected to temporal server\",\"address\":\"temporal:7233\"}\r\n{\"level\":\"INFO\",\"ts\":\"2023-01-16T14:02:17.000Z\",\"logger\":\"server      \",\"msg\":\"{\\\"message\\\":\\\"User Deprecated: The \\\\\\\"Spiral\\\\\\\\Attributes\\\\\\\\NamedArgumentConstructorAttribute\\\\\\\" interface extends \\\\\\\"Doctrine\\\\\\\\Common\\\\\\\\Annotations\\\\\\\\NamedArgumentConstructorAnnotation\\\\\\\" that is deprecated Implementing this interface is deprecated Use the Annotation @NamedArgumentConstructor instead.\\\",\\\"context\\\":{\\\"exception\\\":{\\\"class\\\":\\\"ErrorException\\\",\\\"message\\\":\\\"User Deprecated: The \\\\\\\"Spiral\\\\\\\\Attributes\\\\\\\\NamedArgumentConstructorAttribute\\\\\\\" interface extends \\\\\\\"Doctrine\\\\\\\\Common\\\\\\\\Annotations\\\\\\\\NamedArgumentConstructorAnnotation\\\\\\\" that is deprecated Implementing this interface is deprecated Use the Annotation @NamedArgumentConstructor instead.\\\",\\\"code\\\":0,\\\"file\\\":\\\"/var/www/vendor/symfony/error-handler/DebugClassLoader.php:331\\\"}},\\\"channel\\\":\\\"deprecation\\\",\\\"severity\\\":\\\"INFO\\\",\\\"timestamp\\\":\\\"2023-01-16T14:02:16.999+00:00\\\"}\\n\"}\r\n{\"level\":\"INFO\",\"ts\":\"2023-01-16T14:02:17.001Z\",\"logger\":\"server      \",\"msg\":\"{\\\"message\\\":\\\"User Deprecated: The \\\\\\\"Spiral\\\\\\\\Attributes\\\\\\\\NamedArgumentConstructorAttribute\\\\\\\" interface extends \\\\\\\"Doctrine\\\\\\\\Common\\\\\\\\Annotations\\\\\\\\NamedArgumentConstructorAnnotation\\\\\\\" that is deprecated Implementing this interface is deprecated Use the Annotation @NamedArgumentConstructor instead.\\\",\\\"context\\\":{\\\"exception\\\":{\\\"class\\\":\\\"ErrorException\\\",\\\"message\\\":\\\"User Deprecated: The \\\\\\\"Spiral\\\\\\\\Attributes\\\\\\\\NamedArgumentConstructorAttribute\\\\\\\" interface extends \\\\\\\"Doctrine\\\\\\\\Common\\\\\\\\Annotations\\\\\\\\NamedArgumentConstructorAnnotation\\\\\\\" that is deprecated Implementing this interface is deprecated Use the Annotation @NamedArgumentConstructor instead.\\\",\\\"code\\\":0,\\\"file\\\":\\\"/var/www/vendor/symfony/error-handler/DebugClassLoader.php:331\\\"}},\\\"channel\\\":\\\"deprecation\\\",\\\"severity\\\":\\\"INFO\\\",\\\"timestamp\\\":\\\"2023-01-16T14:02:17.001+00:00\\\"}\\n\"}\r\n{\"level\":\"INFO\",\"ts\":\"2023-01-16T14:02:17.008Z\",\"logger\":\"server      \",\"msg\":\"{\\\"message\\\":\\\"User Deprecated: The \\\\\\\"Spiral\\\\\\\\Attributes\\\\\\\\NamedArgumentConstructorAttribute\\\\\\\" interface extends \\\\\\\"Doctrine\\\\\\\\Common\\\\\\\\Annotations\\\\\\\\NamedArgumentConstructorAnnotation\\\\\\\" that is deprecated Implementing this interface is deprecated Use the Annotation @NamedArgumentConstructor instead.\\\",\\\"context\\\":{\\\"exception\\\":{\\\"class\\\":\\\"ErrorException\\\",\\\"message\\\":\\\"User Deprecated: The \\\\\\\"Spiral\\\\\\\\Attributes\\\\\\\\NamedArgumentConstructorAttribute\\\\\\\" interface extends \\\\\\\"Doctrine\\\\\\\\Common\\\\\\\\Annotations\\\\\\\\NamedArgumentConstructorAnnotation\\\\\\\" that is deprecated Implementing this interface is deprecated Use the Annotation @NamedArgumentConstructor instead.\\\",\\\"code\\\":0,\\\"file\\\":\\\"/var/www/vendor/symfony/error-handler/DebugClassLoader.php:331\\\"}},\\\"channel\\\":\\\"deprecation\\\",\\\"severity\\\":\\\"INFO\\\",\\\"timestamp\\\":\\\"2023-01-16T14:02:17.007+00:00\\\"}\\n\"}\r\n{\"level\":\"INFO\",\"ts\":\"2023-01-16T14:02:17.041Z\",\"logger\":\"server      \",\"msg\":\"{\\\"message\\\":\\\"User Deprecated: The \\\\\\\"Spiral\\\\\\\\Attributes\\\\\\\\NamedArgumentConstructorAttribute\\\\\\\" interface extends \\\\\\\"Doctrine\\\\\\\\Common\\\\\\\\Annotations\\\\\\\\NamedArgumentConstructorAnnotation\\\\\\\" that is deprecated Implementing this interface is deprecated Use the Annotation @NamedArgumentConstructor instead.\\\",\\\"context\\\":{\\\"exception\\\":{\\\"class\\\":\\\"ErrorException\\\",\\\"message\\\":\\\"User Deprecated: The \\\\\\\"Spiral\\\\\\\\Attributes\\\\\\\\NamedArgumentConstructorAttribute\\\\\\\" interface extends \\\\\\\"Doctrine\\\\\\\\Common\\\\\\\\Annotations\\\\\\\\NamedArgumentConstructorAnnotation\\\\\\\" that is deprecated Implementing this interface is deprecated Use the Annotation @NamedArgumentConstructor instead.\\\",\\\"code\\\":0,\\\"file\\\":\\\"/var/www/vendor/symfony/error-handler/DebugClassLoader.php:331\\\"}},\\\"channel\\\":\\\"deprecation\\\",\\\"severity\\\":\\\"INFO\\\",\\\"timestamp\\\":\\\"2023-01-16T14:02:17.041+00:00\\\"}\\n\"}\r\n{\"level\":\"DEBUG\",\"ts\":\"2023-01-16T14:02:17.047Z\",\"logger\":\"server      \",\"msg\":\"worker is allocated\",\"pid\":24,\"internal_event_name\":\"EventWorkerConstruct\"}\r\n{\"level\":\"DEBUG\",\"ts\":\"2023-01-16T14:02:17.049Z\",\"logger\":\"server      \",\"msg\":\"worker is allocated\",\"pid\":25,\"internal_event_name\":\"EventWorkerConstruct\"}\r\n{\"level\":\"DEBUG\",\"ts\":\"2023-01-16T14:02:17.056Z\",\"logger\":\"server      \",\"msg\":\"worker is allocated\",\"pid\":23,\"internal_event_name\":\"EventWorkerConstruct\"}\r\n{\"level\":\"DEBUG\",\"ts\":\"2023-01-16T14:02:17.080Z\",\"logger\":\"server      \",\"msg\":\"worker is allocated\",\"pid\":26,\"internal_event_name\":\"EventWorkerConstruct\"}\r\n{\"level\":\"INFO\",\"ts\":\"2023-01-16T14:02:17.810Z\",\"logger\":\"server      \",\"msg\":\"{\\\"message\\\":\\\"User Deprecated: The \\\\\\\"Spiral\\\\\\\\Attributes\\\\\\\\NamedArgumentConstructorAttribute\\\\\\\" interface extends \\\\\\\"Doctrine\\\\\\\\Common\\\\\\\\Annotations\\\\\\\\NamedArgumentConstructorAnnotation\\\\\\\" that is deprecated Implementing this interface is deprecated Use the Annotation @NamedArgumentConstructor instead.\\\",\\\"context\\\":{\\\"exception\\\":{\\\"class\\\":\\\"ErrorException\\\",\\\"message\\\":\\\"User Deprecated: The \\\\\\\"Spiral\\\\\\\\Attributes\\\\\\\\NamedArgumentConstructorAttribute\\\\\\\" interface extends \\\\\\\"Doctrine\\\\\\\\Common\\\\\\\\Annotations\\\\\\\\NamedArgumentConstructorAnnotation\\\\\\\" that is deprecated Implementing this interface is deprecated Use the Annotation @NamedArgumentConstructor instead.\\\",\\\"code\\\":0,\\\"file\\\":\\\"/var/www/vendor/symfony/error-handler/DebugClassLoader.php:331\\\"}},\\\"channel\\\":\\\"deprecation\\\",\\\"severity\\\":\\\"INFO\\\",\\\"timestamp\\\":\\\"2023-01-16T14:02:17.809+00:00\\\"}\\n\"}\r\n{\"level\":\"DEBUG\",\"ts\":\"2023-01-16T14:02:17.836Z\",\"logger\":\"server      \",\"msg\":\"worker is allocated\",\"pid\":67,\"internal_event_name\":\"EventWorkerConstruct\"}\r\n{\"level\":\"DEBUG\",\"ts\":\"2023-01-16T14:02:17.837Z\",\"logger\":\"temporal    \",\"msg\":\"outgoing message\",\"id\":0,\"data\":\"\",\"context\":\"\"}\r\n{\"level\":\"DEBUG\",\"ts\":\"2023-01-16T14:02:17.891Z\",\"logger\":\"temporal    \",\"msg\":\"received message\",\"command\":null,\"id\":0,\"data\":\"\\n\\ufffd\\^D*\\ufffd\\^D\\n\\ufffd\\^D\\n\\^V\\n\\^Hencoding\\^R\\njson/plain\\^R\\ufffd\\^D{\\\"TaskQueue\\\":\\\"default\\\",\\\"Options\\\":{\\\"MaxConcurrentActivityExecutionSize\\\":0,\\\"WorkerActivitiesPerSecond\\\":0.0,\\\"MaxConcurrentLocalActivityExecutionSize\\\":0,\\\"WorkerLocalActivitiesPerSecond\\\":0.0,\\\"TaskQueueActivitiesPerSecond\\\":0.0,\\\"MaxConcurrentActivityTaskPollers\\\":0,\\\"MaxConcurrentWorkflowTaskExecutionSize\\\":0,\\\"MaxConcurrentWorkflowTaskPollers\\\":0,\\\"StickyScheduleToStartTimeout\\\":null,\\\"WorkerStopTimeout\\\":null,\\\"EnableSessionWorker\\\":false,\\\"SessionResourceID\\\":null,\\\"MaxConcurrentSessionExecutionSize\\\":1000},\\\"Workflows\\\":[{\\\"Name\\\":\\\"HealthWorkflow\\\",\\\"Queries\\\":[],\\\"Signals\\\":[]}],\\\"Activities\\\":[]}\"}\r\n{\"level\":\"DEBUG\",\"ts\":\"2023-01-16T14:02:17.892Z\",\"logger\":\"temporal    \",\"msg\":\"worker info\",\"taskqueue\":\"default\",\"optionsError\":\"json: unsupported type: func(error)\"}\r\n{\"level\":\"DEBUG\",\"ts\":\"2023-01-16T14:02:17.893Z\",\"logger\":\"temporal    \",\"msg\":\"workflow registered\",\"taskqueue\":\"default\",\"workflow name\":\"HealthWorkflow\"}\r\n{\"level\":\"DEBUG\",\"ts\":\"2023-01-16T14:02:17.894Z\",\"logger\":\"temporal    \",\"msg\":\"workers initialized\",\"num_workers\":1}\r\n{\"level\":\"INFO\",\"ts\":\"2023-01-16T14:02:17.955Z\",\"logger\":\"temporal    \",\"msg\":\"Started Worker\",\"Namespace\":\"default\",\"TaskQueue\":\"default\",\"WorkerID\":\"default:0a537940-a86b-4ffd-8ad8-5dae21ea5a12\"}\r\n{\"level\":\"DEBUG\",\"ts\":\"2023-01-16T14:02:17.957Z\",\"logger\":\"rpc         \",\"msg\":\"plugin was started\",\"address\":\"tcp://127.0.0.1:6001\",\"list of the plugins with RPC methods:\":[\"informer\",\"resetter\",\"temporal\"]}\r\n```\r\n\r\n@cv65kr Thanks, I was thinking it would indeed be related to the GO-SDK. Do you know if it's somehow possible to supply the same custom data converter there as well?","createdAt":"2023-01-16T15:06:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384189589","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Sgd6m","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@sdellarosa there are examples in Go - https://github.com/temporalio/samples-go/tree/main/encryption\r\nhttps://github.com/temporalio/samples-go/tree/main/codec-server\r\n\r\nI think it's not simple with roadrunner since you need create your own data converter and it needs to be compiled with Roadrunner. And ofc if you want to have a support of new converter in UI, you need to expose converter via server.\r\n\r\nVelox could be answer here. Maybe @rustatian can jump here? Or maybe converter server is enough :)\r\n\r\n","createdAt":"2023-01-16T15:53:31Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384242854","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Sgpkj","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"Hey @cv65kr @sdellarosa üëãüèª \r\n\r\nRR doesn't support the `binary/encrypted` payloads atm. But, that's easy to support that case. I need some repo to reproduce this case... üòÉ @sdellarosa @cv65kr Could you guys create a test-case repo? ","createdAt":"2023-01-16T16:26:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384290595","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5SgsTM","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@rustatian, `binary/encrypted` is not Temporal thing, is more custom thing and client implementation can be different. The problem I think is that you can have own codecs, not only this one case. I mean encryption/decryption is most popular thing and don't know if other case will be needed (but here you can have two cases, whole payload encryption and single field encryption).\r\n\r\nhttps://docs.temporal.io/security#payload-codec","createdAt":"2023-01-16T16:36:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384301772","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5SgtHr","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"@rustatian do we actually need to unpack all the payloads on RR end? Can't we just passthough payloads with undefined type to the server, I assume we only have to work with our internal commands.","createdAt":"2023-01-16T16:39:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384305131","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5SgtI3","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"> @rustatian, binary/encrypted is not Temporal thing, is more custom thing and client implementation can be different. The problem I think is that you can have own codecs, not only this one case. I mean encryption/decryption is most popular thing and don't know if other case will be needed (but here you can have two cases, whole payload encryption and single field encryption).\r\n\r\nhttps://docs.temporal.io/security#payload-codec\r\n\r\nYeah, I know, thanks, I need to verify with the test-repo, why we can't just redirect that payload to the custom data-converter in the PHP. Why that case leads to error. I know the particular line which throws an error, but I need to double-check.","createdAt":"2023-01-16T16:39:25Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384305207","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5SgtyM","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"> @rustatian do we actually need to unpack all the payloads on RR end? Can't we just passthough payloads with undefined type to the server, I assume we only have to work with our internal commands.\r\n\r\nThat is because I need a test-repo to check that case. We do not touch the user's payload in any way (except, you know, marshal-unmarshal, encode-decode).","createdAt":"2023-01-16T16:41:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384307852","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5ShmYD","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"In a month, we might implement interceptors.\r\nUsing interceptors you could encrypt all payloads easily.","createdAt":"2023-01-16T20:54:02Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384539651","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Shm-Q","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@rustatian in case when you still need test repo https://github.com/cv65kr/temporal-sdk-leaks/tree/data-converter\r\n\r\nError is caused because as a fallback RR using default converters from GO-SDK - https://github.com/temporalio/roadrunner-temporal/blob/master/data_converter/converter.go#L28","createdAt":"2023-01-16T20:58:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384542096","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Shot2","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@roxblnfk cool, looking forward!","createdAt":"2023-01-16T21:06:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384549238","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5ShqiQ","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"> @rustatian in case when you still need test repo https://github.com/cv65kr/temporal-sdk-leaks/tree/data-converter\r\n> \r\n> Error is caused because as a fallback RR using default converters from GO-SDK - https://github.com/temporalio/roadrunner-temporal/blob/master/data_converter/converter.go#L28\r\n\r\nYeah, I know where it fails üòÑ I just needed some test-case for that. Moreover, I don't think the interceptor is a good (and natural) place to decode the payload (since this is a data-convertor task).","createdAt":"2023-01-16T21:13:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384556688","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Sh3EC","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"Hm, so, the issue is here:\r\n```go\r\n// FromPayload converts single value from payload.\r\nfunc (r *DataConverter) FromPayload(payload *commonpb.Payload, valuePtr any) error {\r\n\treturn r.dc.FromPayload(payload, valuePtr) <-----\r\n}\r\n```\r\nSince we're converting the payload like this `err = c.dc.FromPayload(payloads[i], tmp)`.\r\nAnd later, in the `CompositeDataConverter` (temporal default), `temporal` tries to take a payload converter for the `binary/encrypted`, and, obviously, there are no such converters.\r\nAnd it fails with the error from the Bug.\r\n\r\nMight be we need to implement the `CompositeDataConverter` (to support all std payloads), but with a slightly different behavior `->` paththrough all payloads with an unknown encoder to the PHP.","createdAt":"2023-01-16T22:00:37Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384608002","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Sh4aj","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"In only-Go, this is an expected error because, for sure, you should create a data converter for your own encoder... \r\nBut here, since we don't touch the user payload, we may decode/encode well-known data types, but for the user-defined encoders, we should not return an error and pass this data to the PHP worker with the hope that PHP knows how to handle it.","createdAt":"2023-01-16T22:06:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384613539","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Sh6qO","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"It looks like an easy task üòÑ \r\nSince we don't actually need to decode the encrypted payload, we may easily detect the underlying data type with the `reflection` and use the standard decoder's approach for such payloads. Since, for example, `binary/encrypted` is binary first and then `encrypted` ‚ö° ","createdAt":"2023-01-16T22:16:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384622734","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5SiKQf","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"As is typical, upon delving into this task, it has become somewhat more complex üòÑ \r\n\r\nWhen the user sends data with an unknown converter, such as `binary/encrypted`, it is not possible to decrypt it in order to allocate workers. Specifically, we have a `payload` and a `valuePtr` pointer, which points us to the actual type that should be filled with the data in the payload. This is a standard method for converting data from a payload to its true type, also known as unmarshalling.\r\n\r\nIn the event that the payload is encrypted or encoded with an unknown converter, it cannot be decoded to the \"real\" type. For example, we have a `valuePtr` pointing to a structure with an arbitrary number of fields. We have two scenarios with two different converters:\r\n1. `json/plain`: all we need to do is unmarshal the \"[]byte\" into the schema (our structure). The process is successful and the structure (schema) is now filled with the data.\r\n2. `binary/encrypted` (or any unknown converter): Without knowing how to unmarshal, for example, this: \"ChYKCGVuY29kaW5nEgpqc29uL3BsYWluEtkEeyJUYXNrUXVldWUiOiJk\" into our real type, it is not possible to fill our `valuePtr` with the data.\r\n\r\nThe good news is that this task can be solved by allowing users to implement RR's `plugin-data-converters` in Go, similar to middleware for HTTP.\r\n","createdAt":"2023-01-17T00:09:13Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384686623","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5SjVCq","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@rustatian If I good understand correctly payload = data + metadata, maybe we could prepare fallback data converter in GO with just plain `[]byte` conversion, so every time when type in not recognised - we just forward it (it forces PHP to returns always byte[] structure).\r\n\r\nLogic responsible e.g. for encrypting should be done in PHP.\r\n\r\nMy point that logic is kinda duplicated, because in Go we have converters and in PHP we have converters.","createdAt":"2023-01-17T08:09:04Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1384992938","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5SjZqt","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"> My point that logic is kinda duplicated, because in Go we have converters and in PHP we have converters.\r\n\r\nYeah, correct. I wouldn't say I like this solution, but this is the only one acceptable. \r\nWe can't just forward the data, because we have to unmarshal it to the `valuePtr` (pointer to the real data). We can't transform the `[]byte` into the structure if the data is encrypted.","createdAt":"2023-01-17T08:24:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1385011885","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Sjhcv","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"Ok üòÑ We discussed with @wolfy-j and found a better solution.\r\n\r\nThe main problem is in the commands between the RR and PHP workers. In the case of the custom converter, we can't decode this info. We don't care about the user's data (in a good sense) because we just path through it to the Temporal (activity, workflow, etc).\r\n\r\nThe proposed solution:\r\nFor internal communication, use the `plain/json` (or `binary/proto`) converter (one of the well-known). Having that, we will always be capable of decoding our internal messages w/o touching the user's data. And, we don't need to duplicate the data-converter in Go and PHP.\r\n\r\nEDIT: The user's data will be encoded with the user's (in PHP) data converter.","createdAt":"2023-01-17T08:54:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1385043759","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5SkWxm","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"Would be nice to see some example in samples-php üòÑ ","createdAt":"2023-01-17T11:09:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1385262182","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Skcsm","author":{"login":"sdellarosa"},"authorAssociation":"NONE","body":"Hi all, thanks a lot for looking into this! üòÑ \r\n\r\nJust to be clear, the final proposed solution, would be implemented in this SDK and not on RoadRunner, correct? And if so, when can I expect to see the changes shipped?\r\n","createdAt":"2023-01-17T11:29:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1385286438","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Skdg8","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"Hey @sdellarosa üëãüèª \r\n\r\n> Just to be clear, the final proposed solution, would be implemented in this SDK and not on RoadRunner, correct? \r\n\r\nYeah, it seems that the SDK would be updated.\r\n\r\n> And if so, when can I expect to see the changes shipped?\r\n\r\nHard to say, personally, as I'm not a PHP dev, we have to wait for @roxblnfk or someone from the community üò¢ ","createdAt":"2023-01-17T11:33:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1385289788","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5SkuyS","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@rustatian big disadvantage of this solution when you are using well-known converters you are loosing possibility e.g. to decrypt payload in Temporal UI.","createdAt":"2023-01-17T12:36:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1385360530","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5SkzSA","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@sdellarosa as a temporary solution you could something like that:\r\n```php\r\n<?php\r\n\r\ndeclare(strict_types=1);\r\n\r\nnamespace App;\r\n\r\nuse Temporal\\DataConverter\\DataConverterInterface;\r\nuse Temporal\\DataConverter\\DataConverter;\r\nuse Temporal\\Api\\Common\\V1\\Payload;\r\nuse Temporal\\DataConverter\\EncodingKeys;\r\n\r\nclass Converter implements DataConverterInterface\r\n{\r\n    private DataConverterInterface $dataConverter;\r\n\r\n    public function __construct()\r\n    {\r\n        $this->dataConverter = DataConverter::createDefault();\r\n    }\r\n\r\n    public function toPayload($value): Payload\r\n    {\r\n        $payload = $this->dataConverter->toPayload($value);\r\n\r\n        // It's example object which need to be encoded\r\n        if ($value instanceof Example) {\r\n            $encrypted = new Payload();\r\n            $encrypted->setMetadata([\r\n                EncodingKeys::METADATA_ENCODING_KEY => 'json/plain',\r\n                'encrypted' => 'true'\r\n            ]);\r\n            $encrypted->setData(\r\n                base64_encode($payload->getData())\r\n            );\r\n\r\n            return $encrypted;\r\n        }\r\n\r\n        return $payload;\r\n    }\r\n\r\n    public function fromPayload(Payload $payload, $type): mixed\r\n    {\r\n        if ($payload->getMetadata()->offsetGet('encrypted') === 'true') {\r\n            $decrypted = new Payload();\r\n            $decrypted->setMetadata([EncodingKeys::METADATA_ENCODING_KEY => 'json/plain']);\r\n            $decrypted->setData(base64_decode($payload->getData()));\r\n            return $this->dataConverter->fromPayload($decrypted, $type);\r\n\r\n        }\r\n\r\n        return $this->dataConverter->fromPayload($payload, $type);\r\n    }\r\n}\r\n```\r\n\r\nIn this case concrete object `Example` is encrypted in both directions via base64.\r\n\r\nNeed to be aware about my previous comment.\r\n<img width=\"1165\" alt=\"image\" src=\"https://user-images.githubusercontent.com/9404962/212903115-6d2b3958-ea45-4629-be71-ce74a6102ad8.png\">\r\n","createdAt":"2023-01-17T12:51:29Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1385378944","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Spqxg","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"> @rustatian big disadvantage of this solution when you are using well-known converters you are loosing possibility e.g. to decrypt payload in Temporal UI.\r\n\r\nPossibly, but personally, I don't think that this is a disadvantage since data is encrypted (no one, even accidentally would see it). \r\nUnfortunately, we have to choose the best from the worst solutions, since we can't decode payload unknown to the RR converter üò¢ ","createdAt":"2023-01-18T08:18:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1386654816","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5le7zB","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"@sdellarosa Hey üëãüèª \r\nHave you tried the prev answer? Did that help you?","createdAt":"2023-09-01T11:35:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1702608065","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5lv87u","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"Hi. Feel free to reopen the issue if it is still actual.","createdAt":"2023-09-05T18:04:25Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/276#issuecomment-1707069166","viewerDidAuthor":false}],"createdAt":"2023-01-11T10:27:25Z","labels":[{"id":"MDU6TGFiZWw0MDMxNTY5NTYw","name":"enhancement","description":"","color":"a2eeef"}],"milestone":null,"number":276,"reactionGroups":[],"state":"CLOSED","title":"[Feature Request] Worker unable to start with a custom Data Converter","updatedAt":"2023-09-05T18:10:42Z","url":"https://github.com/temporalio/sdk-php/issues/276"}
