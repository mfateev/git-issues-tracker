{"assignees":[{"id":"MDQ6VXNlcjI0NjEyNTc=","login":"SerafimArts","name":"Kirill Nesmeyanov","databaseId":0}],"author":{"id":"MDQ6VXNlcjU1MzYwNTE=","is_bot":false,"login":"Zylius","name":"Zigmas Satkeviƒçius"},"body":"Hello,\r\n\r\nIs there any way to inject a custom reader into WorkerFactory/Worker?\r\n\r\nWe're switching over to temporal and I'd like to register the old activities/workflows using our old logic for now and move over to Temporal attributes as new activites/workflows appear.\r\n\r\nBut it seems, cause of all the final classes the only way to do this would be to copy over the WorkerFactory completely.\r\n\r\nIs this https://github.com/temporalio/sdk-php/issues/88 dealing with the same issue?\r\n\r\nThanks for help!","closedAt":"2021-07-26T11:12:23Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg0MzIzMjE5Nw==","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"Can you elaborate? What are you trying to achieve? \r\n\r\nYou have to manually register each activity, so you can pull it from any DI container.","createdAt":"2021-05-18T14:42:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/110#issuecomment-843232197","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg0MzQ1NDY3OQ==","author":{"login":"Zylius"},"authorAssociation":"CONTRIBUTOR","body":"Yes sure, here's an example:\r\n``` php\r\n#!/usr/bin/env php\r\n<?php\r\n\r\nuse Temporal\\WorkerFactory;\r\n\r\nclass SimpleWorker\r\n{\r\n    public function simpleActivityMethod(): string\r\n    {\r\n        return 'simple_string';\r\n    }\r\n}\r\n\r\n$existingData = [\r\n    SimpleWorker::class => [\r\n        'methodNames' => [\r\n            'simpleActivityMethod' => 'simpleMethod'\r\n        ],\r\n        'prefix' => 'simple_'\r\n    ]\r\n];\r\n\r\n$factory = WorkerFactory::create();\r\n$worker = $factory->newWorker();\r\n\r\n// How do I register the activity, without PHP8 attributes, so that its info gets loaded from\r\n// $existingData variable ? \r\n$worker->registerActivityImplementations(new SimpleWorker());\r\n\r\n$factory->run();\r\n```\r\nAnd a more elaborate explanation:  lets say I'm adding an Activity object to a Worker using [registerActivityImplementations](https://github.com/temporalio/sdk-php/blob/master/src/Worker/Worker.php#L133). It reads the activity method groups, names and other info based on PHP 8 style attributes. Since the Worker is created using Worker Factory it has a fixed reader implementation (currently [SelectiveReader or AttributeReader](https://github.com/temporalio/sdk-php/blob/f53f1627f63fca73bd0e533831a8104bacd44309/src/DataConverter/JsonConverter.php#L214)).\r\n\r\nLets say I have the activity method names list and activity prefixes in some array parameter in my DI (not PHP8 style attributes). How do I force [ActivityReader](https://github.com/temporalio/sdk-php/blob/f53f1627f63fca73bd0e533831a8104bacd44309/src/Internal/Declaration/Reader/ActivityReader.php) to read it from the array parameter instead of the PHP8 attributes?\r\n\r\nI was postulating that you could inject your own Reader instance into the WorkerFactory. But it's final and impossible. The only other two solutions I could think off would be:\r\n1. Copying the whole WorkerFactory over to my application, so I could inject my own Reader.\r\n2. Using Ocramius proxies  to create stub classes with PHP8 attributes generated.\r\n\r\nBoth of these solutions seem to have issues with maintenance and simplicity.\r\n\r\nI'm doing this in order to let our `old style activities` remain the same, while registering them with temporal.We have lots of activites and adding attributes to each and every one would be bothersome. Though, if it can't be helped we will do it :)\r\n\r\nI hope this is clearer, thank you!","createdAt":"2021-05-18T19:01:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/110#issuecomment-843454679","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg0NTg2NTc1NA==","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"We are talking internally about how to expose it easier for you. For now, I can recommend you to wrap activities.","createdAt":"2021-05-21T10:52:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/110#issuecomment-845865754","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg2ODY3MzgwNw==","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"Can making Factory non final help you to solve your case for now?","createdAt":"2021-06-25T16:11:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/110#issuecomment-868673807","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg2OTYwOTQ1NQ==","author":{"login":"Zylius"},"authorAssociation":"CONTRIBUTOR","body":"Hello, sorry for the late reply,  missed the notification.\r\n\r\nIt definitely would! I would then be able to specify my own reader.","createdAt":"2021-06-28T11:35:02Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/110#issuecomment-869609455","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg3MTI2MTY1Mw==","author":{"login":"Zylius"},"authorAssociation":"CONTRIBUTOR","body":"Just double checked it and found another issuue. I would also need \r\n\r\n```php\r\n    /**\r\n     * @return ReaderInterface\r\n     */\r\n    private function createReader(): ReaderInterface\r\n    {\r\n        if (\\interface_exists(Reader::class)) {\r\n            return new SelectiveReader([new AnnotationReader(), new AttributeReader()]);\r\n        }\r\n\r\n        return new AttributeReader();\r\n    }\r\n``` \r\n\r\nTo be protected, to be able to override it and inject my own reader nicely. The best option of course would be if I could override the default reader with my own through constructor, just like it's done with DataConverter currently.\r\n\r\n```php\r\n    public static function create(\r\n        DataConverterInterface $converter = null,\r\n        RPCConnectionInterface $rpc = null\r\n    ): WorkerFactoryInterface {\r\n        return new self(\r\n            $converter ?? DataConverter::createDefault(),\r\n            $rpc ?? Goridge::create()\r\n        );\r\n    }\r\n ```\r\n\r\n\r\nProposed:\r\n\r\n```php\r\n    public static function create(\r\n        DataConverterInterface $converter = null,\r\n        RPCConnectionInterface $rpc = null,\r\n        ReaderInterface $reader = null\r\n    ): WorkerFactoryInterface {\r\n        return new self(\r\n            $converter ?? DataConverter::createDefault(),\r\n            $rpc ?? Goridge::create(),\r\n            $reader ?? self::createReader() // This method can be static since it doesn't use anything from the instance anyways.\r\n        );\r\n    }\r\n ```","createdAt":"2021-06-30T09:55:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/110#issuecomment-871261653","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg3MjEzNDA0MQ==","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"We would gladly appreciate a PR for this issue :)","createdAt":"2021-07-01T10:50:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/110#issuecomment-872134041","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg3MjE1OTYzNA==","author":{"login":"Zylius"},"authorAssociation":"CONTRIBUTOR","body":"Will do one ;) ","createdAt":"2021-07-01T11:22:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/110#issuecomment-872159634","viewerDidAuthor":false}],"createdAt":"2021-05-18T14:36:34Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTgw","name":"Feature","description":"New feature or request","color":"8e3cc4"}],"milestone":null,"number":110,"reactionGroups":[],"state":"CLOSED","title":"[Question] Injecting custom reader into worker factory.","updatedAt":"2021-07-26T11:12:23Z","url":"https://github.com/temporalio/sdk-php/issues/110"}
