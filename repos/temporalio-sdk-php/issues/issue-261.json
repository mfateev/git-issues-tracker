{"assignees":[],"author":{"id":"MDQ6VXNlcjk5NTk3NjE=","is_bot":false,"login":"seregazhuk","name":"Sergey Zhuk"},"body":"### What are you really trying to do?\r\n\r\nHaving two nested asyncs I'm trying to cancel a child.\r\n\r\n### Describe the bug\r\n\r\nI have two nested asyncs, want to cancel the child  and continue the parent. But once the child is cancelled, the parent scope also becomes cancelled and thus any `timer` or activity call leads to `CancelFailure` error with `Attempt to send request to cancelled scope`.\r\n\r\n### Minimal Reproduction\r\n\r\nWorkflow code:\r\n```php\r\n#[WorkflowMethod(name: 'test')]\r\npublic function execute() {\r\n    $parent = Workflow::async(\r\n        function () {\r\n            $child = Workflow::async(\r\n                function () {\r\n                    yield Workflow::timer(123);\r\n                }\r\n            );\r\n            $child->cancel();\r\n            yield Workflow::timer(456); // Fails here with \"Attempt to send request to cancelled scope\"\r\n        }\r\n    );\r\n\r\n    yield $parent;\r\n}\r\n```\r\n### Environment/Versions\r\n\r\n- Temporal Version: 1.16\r\n- SDK version: 2.2.1\r\n","closedAt":"2023-07-11T12:33:27Z","comments":[{"id":"IC_kwDOEY5HBM5NlvOV","author":{"login":"seregazhuk"},"authorAssociation":"CONTRIBUTOR","body":"Or maybe it is expected behaviour? But looks weird.\r\n\r\n```php\r\n#[WorkflowInterface]\r\nclass TestWorkflow\r\n{\r\n    #[WorkflowMethod(name: 'test')]\r\n    public function execute()\r\n    {\r\n        $promise = Workflow::async(\r\n            function () {\r\n                yield Workflow::timer(5);\r\n            }\r\n        );\r\n\r\n        yield Workflow::timer(1);\r\n        $promise->cancel();\r\n\r\n        // This call fails. Any activity calls or timers (any requests) will fail.\r\n        // The parent scope of a cancelled async is also marked as cancelled.\r\n        yield Workflow::timer(1);\r\n    }\r\n}\r\n```","createdAt":"2022-11-03T07:39:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/261#issuecomment-1301738389","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Nmnpn","author":{"login":"seregazhuk"},"authorAssociation":"CONTRIBUTOR","body":"But, if I start one more async (even empty) after cancelling one - everything works ðŸ¤¯ \r\n\r\n```php\r\n#[WorkflowInterface]\r\nclass TestWorkflow\r\n{\r\n    #[WorkflowMethod(name: 'test')]\r\n    public function execute()\r\n    {\r\n        $promise = Workflow::async(\r\n            function () {\r\n                yield Workflow::timer(5);\r\n            }\r\n        );\r\n\r\n        yield Workflow::timer(1);\r\n        $promise->cancel();\r\n\r\n        Workflow::async(function () {});\r\n        \r\n        // This way it works and doesn't fail\r\n        yield Workflow::timer(1);\r\n    }\r\n}\r\n```","createdAt":"2022-11-03T11:33:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/261#issuecomment-1301969511","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5hMyfK","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"This example missing proper Try Catch, child workflow will throw an exception from it of type CancellationFailure. This is the expected behavior when you don't handle the error.","createdAt":"2023-07-11T12:33:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/261#issuecomment-1630742474","viewerDidAuthor":false}],"createdAt":"2022-10-26T06:47:05Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":261,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"[Bug] Child async cancellation cancels the parent scope","updatedAt":"2023-07-11T12:33:28Z","url":"https://github.com/temporalio/sdk-php/issues/261"}
