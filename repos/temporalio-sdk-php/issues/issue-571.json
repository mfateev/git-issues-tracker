{"assignees":[{"id":"MDQ6VXNlcjQxNTI0ODE=","login":"roxblnfk","name":"Aleksei Gagarin","databaseId":0},{"id":"MDQ6VXNlcjgwNDAzMzg=","login":"rustatian","name":"Valery Piashchynski","databaseId":0}],"author":{"id":"MDQ6VXNlcjQxNTI0ODE=","is_bot":false,"login":"roxblnfk","name":"Aleksei Gagarin"},"body":"[From Slack chat](https://temporalio.slack.com/archives/C01LK9FAMM0/p1738689191710979)\n\n\n\n### Describe the bug\n\n> I'm very infrequently getting determinism errors for a reasonably simple workflow\n> When replaying, I get a `[TMPRL1100] nondeterministic workflow: extra replay command for ScheduleActivityTask: (ActivityId:61, ActivityType:(Name:Programmes.Programme_getContent)`\n>\n> From the Temporal UI it looks like the worker did not schedule get Programme_getContent as expected (seems to have stalled?), but on replay it is doing\n>\n> ![Temporal UI](https://github.com/user-attachments/assets/b8d2f0fb-6503-49b0-936a-df47c68937ae)\n\nHistory: [d0abc853-0fca-43d9-ab68-b54c61cc5ee7_events (1).json](https://github.com/user-attachments/files/18866714/d0abc853-0fca-43d9-ab68-b54c61cc5ee7_events.1.json)\n\n### Minimal Reproduction\n\n<details>\n\n```php\n<?php\n\ndeclare(strict_types=1);\n\nnamespace Temporal\\Tests\\Workflow;\n\nuse Ramsey\\Uuid\\Uuid;\nuse React\\Promise\\PromiseInterface;\nuse Temporal\\Activity;\nuse Temporal\\Activity\\ActivityInterface;\nuse Temporal\\Client\\WorkflowClientInterface;\nuse Temporal\\Internal\\Workflow\\ActivityProxy;\nuse Temporal\\Promise;\nuse Temporal\\Workflow;\nuse Temporal\\Workflow\\WorkflowInterface;\nuse Temporal\\Workflow\\WorkflowMethod;\n\n#[WorkflowInterface]\nclass UserCaseWorkflow\n{\n    private ActivityProxy|UserCaseActivity $activity;\n    private int $moduleIndex = 0;\n    private bool $currentRead = false;\n    private string $currentUrl = '';\n\n    public function __construct()\n    {\n        $this->activity = Workflow::newActivityStub(\n            UserCaseActivity::class,\n            Activity\\ActivityOptions::new()\n                ->withStartToCloseTimeout('1 day'),\n        );\n    }\n\n    #[WorkflowMethod(name: 'UserCaseWorkflow')]\n    public function run(string $enrolment)\n    {\n        while (true) {\n            $nextContent = yield $this->activity->getContent($enrolment, $this->moduleIndex + 1);\n\n            if (!$nextContent) {\n                break;\n            }\n\n            $this->currentRead = false;\n            $this->currentUrl = $nextContent;\n            $this->moduleIndex++;\n\n            yield $this->activity->moduleStarted($enrolment, $this->moduleIndex, $nextContent);\n\n            $delay = yield Workflow::sideEffect(static fn() => '6 seconds');\n\n            yield Promise::all([\n                Workflow::timer($delay),\n                Workflow::async(function () use ($enrolment) {\n                    yield Workflow::await(fn() => $this->currentRead);\n\n                    yield $this->activity->moduleCompleted($enrolment, $this->moduleIndex);\n                }),\n            ]);\n        }\n\n        yield $this->activity->programmeCompleted($enrolment);\n    }\n\n    #[Workflow\\SignalMethod]\n    public function markCompleted(int $index): void\n    {\n        if ($this->moduleIndex === $index) {\n            $this->currentRead = true;\n        }\n    }\n}\n\n#[ActivityInterface('UserCaseActivity.')]\nclass UserCaseActivity\n{\n    public function __construct(\n        private WorkflowClientInterface $client,\n    ) {}\n\n    /**\n     * @return PromiseInterface<non-empty-string|null>\n     */\n    public function getContent(string $enrolment, int $moduleIndex)\n    {\n        return \\mt_rand(0, 10 - $moduleIndex) === 0 ? null : Uuid::uuid4()->__toString();\n    }\n\n    /**\n     * @return PromiseInterface<null>\n     */\n    public function moduleStarted(string $enrolment, int $moduleIndex, string $content)\n    {\n        \\usleep((int)\\round(2.2 * 1_000_000.0));\n\n        $this->client->newRunningWorkflowStub(\n            UserCaseWorkflow::class,\n            Activity::getInfo()->workflowExecution->getID(),\n        )->markCompleted($moduleIndex);\n    }\n\n    /**\n     * @return PromiseInterface<null>\n     */\n    public function moduleCompleted(string $enrolment, int $moduleIndex) {}\n\n    /**\n     * @return PromiseInterface<null>\n     */\n    public function programmeCompleted(string $enrolment) {}\n}\n```\n\n</details>\n\n\n---\n\nSimilar issue. Got log (PHP 8.3.19):\n\n```\nERROR    temporal        Workflow panic    {\"Namespace\": \"default\", \"TaskQueue\": \"order.creation\", \"WorkerID\": \"order.creation:9a1377d9-6662-486c-a9e3-cbbc90fd2e7f\", \"WorkflowType\": \"order.creation\", \"WorkflowID\": \"5fc5df88-0200-4a13-abde-deb61a2ed28f\", \"RunID\": \"e4570e70-10de-465c-a9ed-2c4967841532\", \"Attempt\": 5821, \"Error\": \"[TMPRL1100] lookup failed for scheduledEventID to activityID: scheduleEventID: 71, activityID: 71\", \"StackTrace\": \"process event for order.creation [panic]:\\ngo.temporal.io/sdk/internal.panicIllegalState(...)\\n\\tgo.temporal.io/sdk@v1.33.0/internal/internal_command_state_machine.go:521\\ngo.temporal.io/sdk/internal.(*commandsHelper).handleActivityTaskScheduled(0xc001c2d040, {0xc001f1c7fe, 0x2}, 0x47)\\n\\tgo.temporal.io/sdk@v1.33.0/internal/internal_command_state_machine.go:1156 +0xf8\\ngo.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).ProcessEvent(0xc00240cb58, 0xc002005e60, 0x3?, 0x0)\\n\\tgo.temporal.io/sdk@v1.33.0/internal/internal_event_handlers.go:1231 +0x3f2\\ngo.temporal.io/sdk/internal.(*workflowExecutionContextImpl).ProcessWorkflowTask(0xc0005654a0, 0xc0023aa420)\\n\\tgo.temporal.io/sdk@v1.33.0/internal/internal_task_handlers.go:1182 +0x1a8a\\ngo.temporal.io/sdk/internal.(*workflowTaskHandlerImpl).ProcessWorkflowTask(0xc001266000, 0xc0023aa420, 0xc0005654a0, 0xc001b8cba0)\\n\\tgo.temporal.io/sdk@v1.33.0/internal/internal_task_handlers.go:929 +0x59e\\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).processWorkflowTask(0xc00012a000, 0xc0023aa420)\\n\\tgo.temporal.io/sdk@v1.33.0/internal/internal_task_pollers.go:424 +0x3db\\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).ProcessTask(0xc00012a000, {0x1f67f40, 0xc0023aa420})\\n\\tgo.temporal.io/sdk@v1.33.0/internal/internal_task_pollers.go:372 +0x205\\ngo.temporal.io/sdk/internal.(*baseWorker).processTaskAsync.func1()\\n\\tgo.temporal.io/sdk@v1.33.0/internal/internal_worker_base.go:453 +0x12f\\ncreated by go.temporal.io/sdk/internal.(*baseWorker).processTaskAsync in goroutine 203\\n\\tgo.temporal.io/sdk@v1.33.0/internal/internal_worker_base.go:432 +0x8c\"}\nWARN    temporal        Failed to process workflow task.    {\"Namespace\": \"default\", \"TaskQueue\": \"order.creation\", \"WorkerID\": \"order.creation:9a1377d9-6662-486c-a9e3-cbbc90fd2e7f\", \"WorkflowType\": \"order.creation\", \"WorkflowID\": \"5fc5df88-0200-4a13-abde-deb61a2ed28f\", \"RunID\": \"e4570e70-10de-465c-a9ed-2c4967841532\", \"Attempt\": 5822, \"Error\": \"[TMPRL1100] lookup failed for scheduledEventID to activityID: scheduleEventID: 71, activityID: 71\"}\n```\n","closedAt":"2025-08-12T18:21:58Z","comments":[{"id":"IC_kwDOEY5HBM6jxtUv","author":{"login":"jackprice"},"authorAssociation":"CONTRIBUTOR","body":"This is quite rare overall, but we run a very large volume of workflows affected by this. Is there any movement on this, or any information I can provide to help?","createdAt":"2025-03-24T10:55:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/571#issuecomment-2747716911","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM6lQFzf","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"Hello. It seems you're not the only one observing similar behavior. I've attached a log snippet from another project.\n\nIt seems like an event (command) to start an Activity is just getting lost somewhere.\nIt's hard to say where it happens, as the chain is quite long.\n\nHere are my thoughts:\n- PHP SDK: The SDK code is linear and deterministic without races and concurrency. I can assume that changing the PHP version might affect something (if you look at the changelog, there are several fixes about behavior of generators in the [PHP changelog](https://www.php.net/ChangeLog-8.php)). By the way, which PHP version are you using?\n- RR: Manages PHP workers and communicates with them via the Goridge protocol. Despite the presence of IO with accompanying asynchronous stuff on the Go side, losing a piece of the message is impossible (the command to start an Activity is sent as a single message along with the completion of the Workflow Task).\n- RR Temporal Plugin <-> Temporal GoSDK <-> Temporal Service: My expertise is insufficient to comment on this. I can only hope that Workflow Task Completed and Activity Task Scheduled are recorded atomically.\n\nI haven't found similar issues in [GoSDK](https://github.com/temporalio/sdk-go), so it looks like the issue might be related with PHP-SDK / RR / PHP.","createdAt":"2025-04-02T12:48:39Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/571#issuecomment-2772458719","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM64mrE2","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"Hi @jackprice \nPlease note [this release](https://github.com/temporalio/sdk-php/releases/tag/v2.15.1): we found and fixed a bug that was likely causing non-deterministic behavior in your case.","createdAt":"2025-07-21T15:01:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/571#issuecomment-3097145654","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM66q8Q-","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"@jackprice Could you please tell me if you were able to reproduce the non-deterministic behavior on the latest version of SDK?","createdAt":"2025-07-29T10:33:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/571#issuecomment-3131819070","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM69knDW","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"Closing due to inactivity. The issue is presumably resolved in release [2.15.1](https://github.com/temporalio/sdk-php/releases/tag/v2.15.1).\n","createdAt":"2025-08-12T18:21:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/571#issuecomment-3180490966","viewerDidAuthor":false}],"createdAt":"2025-02-19T11:12:05Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":38,"title":"2.15.1","description":"","dueOn":null},"number":571,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Very rare nondeterministic error","updatedAt":"2025-08-12T18:22:24Z","url":"https://github.com/temporalio/sdk-php/issues/571"}
