{"assignees":[],"author":{"id":"U_kgDOBYFlyQ","is_bot":false,"login":"pfy-oleksii-storozhylov","name":"Oleksii Storozhylov"},"body":"### What are you really trying to do?\nI want to use await function to ensure that activities are completed with or without an errors\n\n### Describe the bug\nWhen any activity is completed with error, await function doesn't continue workflow immediately, it waits for the full interval\n\n### Minimal Reproduction\n```php\n            foreach ($anticipationPromises as $promise) {\n                $promise\n                    ->then(function() use (&$index) {\n                        $index++;\n                        file_put_contents('/srv/app/ddd.log', time().\" success $index\\n\", FILE_APPEND);\n                    })\n                    ->otherwise(function() use (&$index) {\n                        $index++;\n                        file_put_contents('/srv/app/ddd.log', time().\" error $index\\n\", FILE_APPEND);\n                    });\n            }\n\n            file_put_contents('/srv/app/ddd.log', time(). \" start awaiting $index\\n\", FILE_APPEND);\n\n            yield \\Temporal\\Workflow::awaitWithTimeout(\n                 CarbonInterval::seconds(60),\n                \\React\\Promise\\all($anticipationPromises)\n             );\n\n            file_put_contents('/srv/app/ddd.log', time(). \" complete $index\\n\", FILE_APPEND);\n```\n\nResult when 2 activities have no errors looks good\n\n```\n1708030014 start awaiting 0\n1708030016 success 1\n1708030018 success 2\n1708030018 complete 2\n```\n\nResult when one of the activities has an error looks good (completion takes 60 seconds)\n\n```\n1708030094 start awaiting 0\n1708030096 error 1\n1708030098 success 2\n1708030154 complete 2\n```\n\n### Environment/Versions\n* temporal/sdk 2.7+\n\n### Additional context\n<!-- Add any other context about the problem here. -->\n\n","closedAt":null,"comments":[{"id":"IC_kwDOEY5HBM50Egbx","author":{"login":"pfy-oleksii-storozhylov"},"authorAssociation":"CONTRIBUTOR","body":"workarround with a counter and deferred promise could be used\r\n```php\r\n$index = 0;\r\n\r\n            $deferred = new Deferred();\r\n            $deferred->promise()\r\n                ->then(function () use (&$index) {\r\n                    file_put_contents('/srv/app/ddd.log', time() . \" deferred resolved $index\\n\", FILE_APPEND);\r\n                });\r\n\r\n            foreach ($anticipationPromises as $promise) {\r\n                $promise\r\n                    ->then(function () use (&$index, $deferred) {\r\n                        $index++;\r\n                        file_put_contents('/srv/app/ddd.log', time() . \" success $index\\n\", FILE_APPEND);\r\n\r\n                        if ($index >= 2) {\r\n                            $deferred->resolve(true);\r\n                        }\r\n                    })\r\n                    ->otherwise(function () use (&$index, $deferred) {\r\n                        $index++;\r\n                        file_put_contents('/srv/app/ddd.log', time() . \" error $index\\n\", FILE_APPEND);\r\n\r\n                        if ($index >= 2) {\r\n                            $deferred->resolve(true);\r\n                        }\r\n                    });\r\n            }\r\n\r\n            file_put_contents('/srv/app/ddd.log', time() . \" start awaiting $index\\n\", FILE_APPEND);\r\n\r\n            yield \\Temporal\\Workflow::awaitWithTimeout(\r\n                CarbonInterval::seconds(60),\r\n                $deferred->promise()\r\n            );\r\n```\r\n\r\nAnd the result looks good\r\n```\r\n1708030906 start awaiting 0\r\n1708030908 error 1\r\n1708030910 success 2\r\n1708030910 deferred resolved 2\r\n1708030910 complete 2\r\n```","createdAt":"2024-02-15T21:05:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/399#issuecomment-1947338481","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM50HjdH","author":{"login":"pfy-oleksii-storozhylov"},"authorAssociation":"CONTRIBUTOR","body":"Seems not an issue, `all` promise is rejected if any of promises is rejected, so the solution here is\r\n```php\r\n            yield \\Temporal\\Workflow::awaitWithTimeout(\r\n                CarbonInterval::seconds(60),\r\n                \\Temporal\\Promise::all(array_map(\r\n                    fn (ExtendedPromiseInterface $promise) => $promise->otherwise(fn () => false),\r\n                    $promises\r\n                ))\r\n            );\r\n```","createdAt":"2024-02-16T10:38:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/399#issuecomment-1948137287","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM50LEiP","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"I would like to keep this issue open for our records, so we can check the await behavior in combination with promise chaining.","createdAt":"2024-02-16T18:24:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/399#issuecomment-1949059215","viewerDidAuthor":false}],"createdAt":"2024-02-15T20:54:10Z","labels":[{"id":"LA_kwDOEY5HBM8AAAABMGprrQ","name":"Tests","description":"Update tests or testing tools","color":"0E8A16"}],"milestone":null,"number":399,"reactionGroups":[],"state":"OPEN","title":"[Not a Bug] await doesn't interrupts on the activity with error","updatedAt":"2024-08-30T03:22:59Z","url":"https://github.com/temporalio/sdk-php/issues/399"}
