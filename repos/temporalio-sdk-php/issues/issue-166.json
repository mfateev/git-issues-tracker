{"assignees":[{"id":"MDQ6VXNlcjk5NTk3NjE=","login":"seregazhuk","name":"Sergey Zhuk","databaseId":0}],"author":{"id":"MDQ6VXNlcjE3MjI4MjMx","is_bot":false,"login":"OlegKuro","name":"Khayatov Oleg"},"body":"### What are you really trying to do?\r\n\r\nI'm trying to write [debonce](https://lodash.com/docs/4.17.15#debounce) workflow equivalent: workflow should start and then wait for the signal **N** seconds. And then if signal is triggered within these **N** seconds, timer should be re-launched. If the signal is not triggered workflow should go further. \r\n\r\n\r\n### Describe the bug\r\n\r\nIt seems to not work at all. Workflow jams in _Running_ state instead of timer cancellation and then resetting another one. Also roadrunner writes this message:\r\n<details>\r\n<summary> Long golang-ish error from roadrunner container </summary>\r\n\r\n```\r\nroadrunner_1            | 2022-04-27T12:17:28.779Z      ERROR   temporal        Workflow panic  {\"Namespace\": \"default\", \"TaskQueue\": \"default\", \"WorkerID\": \"default:e6ab0423-3304-4edf-a4d9-ef3f2af0d391\", \"WorkflowType\": \"ExampleWorkflow\", \"WorkflowID\": \"some_id\", \"RunID\": \"0d757f3f-5c7c-4b80-bcb0-1ade96fc82cc\", \"Attempt\": 48, \"Error\": \"flush queue: SoftJobError:\\n\\tcodec_execute:\\n\\tsync_worker_exec:\\n\\tsync_worker_exec_payload: LogicException: Got the response to undefined request 9002 in /opt/app/vendor/temporal/sdk/src/Internal/Transport/Client.php:60\\nStack trace:\\n#0 /opt/app/vendor/temporal/sdk/src/WorkerFactory.php(389): Temporal\\\\Internal\\\\Transport\\\\Client->dispatch(Object(Temporal\\\\Worker\\\\Transport\\\\Command\\\\SuccessResponse))\\n#1 /opt/app/vendor/temporal/sdk/src/WorkerFactory.php(261): Temporal\\\\WorkerFactory->dispatch('\\\\n\\\\x03\\\\x08\\\\xAAF\\\\n\\\\x03\\\\x08\\\\xABF', Array)\\n#2 /opt/app/bin/worker(45): Temporal\\\\WorkerFactory->run()\\n#3 {main}\", \"StackTrace\": \"process event for default [panic]:\\ngithub.com/temporalio/roadrunner-temporal/workflow.(*process).OnWorkflowTaskStarted(0xc000d7fa40, 0xc001734ec8)\\n\\tgithub.com/temporalio/roadrunner-temporal@v1.1.0/workflow/workflow.go:144 +0x2e5\\ngithub.com/spiral/sdk-go/internal.(*workflowExecutionEventHandlerImpl).ProcessEvent(0xc000934330, 0xc000abb940, 0xc0, 0x1)\\n\\tgithub.com/spiral/sdk-go@v1.12.0/internal/internal_event_handlers.go:801 +0x1ff\\ngithub.com/spiral/sdk-go/internal.(*workflowExecutionContextImpl).ProcessWorkflowTask(0xc00027b490, 0xc001666630)\\n\\tgithub.com/spiral/sdk-go@v1.12.0/internal/internal_task_handlers.go:874 +0xca8\\ngithub.com/spiral/sdk-go/internal.(*workflowTaskHandlerImpl).ProcessWorkflowTask(0xc000294210, 0xc001666630, 0xc001578ea0)\\n\\tgithub.com/spiral/sdk-go@v1.12.0/internal/internal_task_handlers.go:723 +0x493\\ngithub.com/spiral/sdk-go/internal.(*workflowTaskPoller).processWorkflowTask(0xc000a8add0, 0xc001666630)\\n\\tgithub.com/spiral/sdk-go@v1.12.0/internal/internal_task_pollers.go:284 +0x2cd\\ngithub.com/spiral/sdk-go/internal.(*workflowTaskPoller).ProcessTask(0xc000a8add0, {0x1594180, 0xc001666630})\\n\\tgithub.com/spiral/sdk-go@v1.12.0/internal/internal_task_pollers.go:255 +0x6c\\ngithub.com/spiral/sdk-go/internal.(*baseWorker).processTask(0xc0005f2200, {0x1593d40, 0xc001807160})\\n\\tgithub.com/spiral/sdk-go@v1.12.0/internal/internal_worker_base.go:362 +0x167\\ncreated by github.com/spiral/sdk-go/internal.(*baseWorker).runTaskDispatcher\\n\\tgithub.com/spiral/sdk-go@v1.12.0/internal/internal_worker_base.go:282 +0xba\"}\r\n```\r\n\r\n</details>\r\n\r\n### Minimal Reproduction\r\n\r\n```php\r\nclass ExampleWorkflow {\r\n    private bool $stopWaiting = false;\r\n\r\n    public function run()\r\n    {\r\n        while (!$this->stopWaiting) {\r\n            $this->stopWaiting = true;\r\n\r\n            yield Workflow::awaitWithTimeout(\r\n                30,\r\n                fn () => $this->stopWaiting === false\r\n            );\r\n        }\r\n\r\n        return 'COMPLETED';\r\n    }\r\n\r\n    // signal\r\n    public function resetTimer(): void\r\n    {\r\n        $this->stopWaiting = false;\r\n    }\r\n}\r\n```\r\n\r\nTry to trigger the signal several times a second -- this will reproduce the bug for sure ðŸ˜„ \r\n\r\n### Environment/Versions\r\n\r\n- Temporal SDK Version: 1.1.1\r\n\r\n### Additional context\r\n\r\nI've implemented this logic another way. But I'm still wondering why this implementation did not work ðŸ¤¯ \r\n","closedAt":"2022-05-02T19:37:28Z","comments":[{"id":"IC_kwDOEY5HBM5CSCvi","author":{"login":"OlegKuro"},"authorAssociation":"CONTRIBUTOR","body":"I've just tried to use [proposed updatable timer implementation](https://github.com/temporalio/samples-php/blob/master/app/src/UpdatableTimer/UpdatableTimer.php). And it does not work ðŸ˜­ \r\n\r\nThese issues are related to attempt to re-launch `awaitWithTimeout` method I guess ðŸ¥² \r\nBecause I've tried to implement updatable timer logic via simple `Workflow::timer` method (_Instead of termination and fair re-launching the timer I wrote new awakeTime into variable and looked on it after each awakening_) and it worked. \r\n\r\n_Temporal version: 1.13.3\r\nTemporal php-SDK version: 1.1.1_","createdAt":"2022-04-28T10:14:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/166#issuecomment-1112026082","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5CSdVY","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"That is weird. We will check the behaviour. ","createdAt":"2022-04-28T12:19:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/166#issuecomment-1112135000","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5CeefH","author":{"login":"seregazhuk"},"authorAssociation":"CONTRIBUTOR","body":"@OlegKuro the parent **should wait** for its child. Using abandon policy means that once parent is canceled/terminated the child continues working.\r\nRelated docs:\r\n- [Policy](https://docs.temporal.io/docs/concepts/what-is-a-parent-close-policy/)\r\n- [Execution concepts](https://docs.temporal.io/docs/concepts/what-is-a-child-workflow-execution/)","createdAt":"2022-05-02T19:37:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/166#issuecomment-1115285447","viewerDidAuthor":false}],"createdAt":"2022-04-27T22:10:31Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":166,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Workflow timer debouncing does not work","updatedAt":"2022-05-02T19:37:28Z","url":"https://github.com/temporalio/sdk-php/issues/166"}
