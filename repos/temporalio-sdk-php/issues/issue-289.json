{"assignees":[{"id":"MDQ6VXNlcjQxNTI0ODE=","login":"roxblnfk","name":"Aleksei Gagarin","databaseId":0},{"id":"MDQ6VXNlcjgwNDAzMzg=","login":"rustatian","name":"Valery Piashchynski","databaseId":0}],"author":{"id":"MDQ6VXNlcjk0MDQ5NjI=","is_bot":false,"login":"cv65kr","name":"Kajetan"},"body":"### Describe the bug\r\n\r\n\"worker_exec: SoftJobError:\\n\\tsync_worker_exec_payload: LogicException: Got the response to undefined request 9002 in /src/vendor/temporal/sdk/src/Internal/Transport/Client.php:57\\nStack trace:\\n#0 /src/vendor/temporal/sdk/src/WorkerFactory.php(389): Temporal\\\\Internal\\\\Transport\\\\Client->dispatch(Object(Temporal\\\\Worker\\\\Transport\\\\Command\\\\SuccessResponse))\\n#1\r\n\r\nLooks like there is still a memory leak.\r\n\r\n### Minimal Reproduction\r\n\r\nHard to find potencial issue, because it was discovered on production for couple days without redeployment. I am using almost all options available from SDK starting from SubWorkflows across to Search attributes.\r\n\r\nMy configuration\r\n\r\n.rr.yaml\r\n```\r\ntemporal:\r\n    address: ${TEMPORAL_CLI_ADDRESS}\r\n    namespace: ${TEMPORAL_NAMESPACE}\r\n    cache_size: 100\r\n    activities:\r\n        allocate_timeout: 3600s\r\n        num_workers: 9\r\n        supervisor:\r\n            max_worker_memory: 164\r\n\r\n```\r\n\r\nIt's scaled horizontally 10 times by default.\r\n\r\nI don't know how I can help you to find issue.\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: Linux\r\n- Temporal Version: 1.18.1\r\n- SDK - 2.3.2\r\n- AWS\r\n","closedAt":"2024-01-17T08:33:41Z","comments":[{"id":"IC_kwDOEY5HBM5Uq5z5","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"@cv65kr could you add RoadRunner version?","createdAt":"2023-02-07T10:20:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1420532985","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Uq6qK","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"Please share if you have any of:\r\n1) Previous log outputs, did worker die?\r\n2) Memory metrics ahead of the crash.","createdAt":"2023-02-07T10:23:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1420536458","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5UrAdG","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@roxblnfk @wolfy-j \r\nRR version 2.12.2\r\n\r\nECS task 1:\r\n<img width=\"632\" alt=\"image\" src=\"https://user-images.githubusercontent.com/9404962/217220707-c975c321-458c-40f6-a60a-a0fda9e6f9d2.png\">\r\n\r\nECS task 2:\r\n<img width=\"632\" alt=\"image\" src=\"https://user-images.githubusercontent.com/9404962/217220902-90200de7-f695-49b3-af83-a70b2e09468b.png\">\r\n\r\nUnfortunately I don't have a metrics from RR itself, only those from AWS.\r\n\r\n```\r\n2023-02-07T07:32:44.535Z\tERROR\tserver      \tno free workers in the pool, wait timeout exceed\t{\"reason\": \"no free workers\", \"internal_event_name\": \"EventNoFreeWorkers\", \"error\": \"worker_watcher_get_free_worker: NoFreeWorkers:\\n\\tcontext deadline exceeded\"}\r\n\r\n2023-02-07T07:32:44.847Z WARN server worker stopped, and will be restarted {\"reason\": \"worker error\", \"pid\": 640, \"internal_event_name\": \"EventWorkerError\", \"error\": \"worker_exec: SoftJobError:\\n\\tsync_worker_exec_payload: LogicException: Got the response to undefined request 17079 in /src/vendor/temporal/sdk/src/Internal/Transport/Client.php:57\\nStack trace:\\n#0 /src/vendor/temporal/sdk/src/WorkerFactory.php(389): Temporal\\\\Internal\\\\Transport\\\\Client->dispatch(Object(Temporal\\\\Worker\\\\Transport\\\\Command\\\\SuccessResponse))\\n#1 /src/vendor/temporal/sdk/src/WorkerFactory.php(261): Temporal\\\\WorkerFactory-\r\n\r\n2023-02-07T07:32:44.847Z ERROR temporal Workflow panic {\"Namespace\": \"default\", \"TaskQueue\": \"default\", \"WorkerID\": \"default:b450078f-8739-4167-a74a-628e35151e15\", \"WorkflowType\": \"myWorkflow\", \"WorkflowID\": \"1234444\", \"RunID\": \"e71e05fc-cefe-408e-8cc8-597966e96177\", \"Attempt\": 1, \"Error\": \"worker_exec: SoftJobError:\\n\\tsync_worker_exec_payload: LogicException: Got the response to undefined request 17079 in /src/vendor/temporal/sdk/src/Internal/Transport/Client.php:57\\nStack trace:\\n#0 /src/vendor/temporal/sdk/src/WorkerFactory.php(389): Temporal\\\\Internal\\\\Transport\\\\Client->dispatch(Object(Temporal\\\\Worker\\\\Transport\\\\Command\\\\SuccessResponse))\\n#1 /src/vendor/temporal/sdk/src/WorkerFactory.php(261): \r\n\r\n2023-02-07T07:32:45.326Z WARN temporal Failed to poll for task. {\"Namespace\": \"default\", \"TaskQueue\": \"default\", \"WorkerID\": \"default:b450078f-8739-4167-a74a-628e35151e15\", \"WorkerType\": \"WorkflowWorker\", \"Error\": \"worker stopping\"\r\n```\r\n\r\n\r\nI extract unique logs, the rest it more likely `worker_exec: SoftJobError:\\n\\tsync_worker_exec_payload: LogicException: Got the response to undefined request 17029 in` ","createdAt":"2023-02-07T10:41:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1420560198","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5UrtWl","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@roxblnfk @wolfy-j \r\n\r\nContainer1:\r\n```\r\nWorkers of [temporal]:\r\n+---------+-----------+---------+---------+---------+--------------------+\r\n|   PID   |  STATUS   |  EXECS  | MEMORY  |  CPU%   |      CREATED       |\r\n+---------+-----------+---------+---------+---------+--------------------+\r\n|     623 | ready     |   1,124 | 61 MB   |    0.03 | 1 hour ago         |\r\n|     521 | ready     |      39 | 76 MB   |    0.02 | 1 hour ago         |\r\n|     520 | ready     |      39 | 83 MB   |    0.02 | 1 hour ago         |\r\n|     526 | ready     |      38 | 74 MB   |    0.02 | 1 hour ago         |\r\n|     511 | ready     |      39 | 75 MB   |    0.02 | 1 hour ago         |\r\n|     513 | ready     |      39 | 75 MB   |    0.02 | 1 hour ago         |\r\n|     514 | ready     |      40 | 85 MB   |    0.02 | 1 hour ago         |\r\n|     515 | ready     |      39 | 85 MB   |    0.03 | 1 hour ago         |\r\n|     512 | ready     |      39 | 112 MB  |    0.04 | 1 hour ago         |\r\n+---------+-----------+---------+---------+---------+--------------------+\r\n```\r\n\r\nContainer 2:\r\n```\r\nWorkers of [temporal]:\r\n+---------+-----------+---------+---------+---------+--------------------+\r\n|   PID   |  STATUS   |  EXECS  | MEMORY  |  CPU%   |      CREATED       |\r\n+---------+-----------+---------+---------+---------+--------------------+\r\n|     627 | ready     |     865 | 60 MB   |    0.02 | 1 hour ago         |\r\n|     516 | ready     |      37 | 75 MB   |    0.02 | 1 hour ago         |\r\n|     529 | ready     |      37 | 76 MB   |    0.02 | 1 hour ago         |\r\n|     530 | ready     |      37 | 76 MB   |    0.02 | 1 hour ago         |\r\n|     515 | ready     |      37 | 83 MB   |    0.02 | 1 hour ago         |\r\n|     517 | ready     |      38 | 104 MB  |    0.03 | 1 hour ago         |\r\n|     518 | ready     |      37 | 75 MB   |    0.02 | 1 hour ago         |\r\n|     519 | ready     |      37 | 75 MB   |    0.02 | 1 hour ago         |\r\n|     520 | ready     |      37 | 75 MB   |    0.02 | 1 hour ago         |\r\n+---------+-----------+---------+---------+---------+--------------------+\r\n```\r\n\r\n1. One of worker uses more memory in compare to other processes\r\n2. Why first process have such big amount of execs in compare to rest of processes?","createdAt":"2023-02-07T13:06:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1420744101","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5UsasT","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"Hey @cv65kr üëãüèª \r\n\r\n1. It Might be the problematic code handled by that worker.\r\n2. First is the workflow worker, and it won't be restarted if not killed or died. E.g. if the activity worker dies, RR will re-allocate that process. If you're using `./rr reset`, that command will restart everything (WF+Activity). If the WF worker dies, RR will also restart everything.","createdAt":"2023-02-07T15:07:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1420929811","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5UsmU3","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@rustatian thanks of explanation of point 2.\r\n\r\nI am quite sure that there is a leak somewhere \r\n<img width=\"615\" alt=\"image\" src=\"https://user-images.githubusercontent.com/9404962/217288988-f907516f-857e-427b-a245-cf6caef930a3.png\">\r\n\r\nI am trying to isolate workflow with separate worker to give you more details. I am not sure if this is a leak or not because here I have minimal traffic. In 3 hour it grow up with 3 mb, so it sounds like something gentle but if we imagine that multiply by some traffic it might it.\r\n<img width=\"615\" alt=\"image\" src=\"https://user-images.githubusercontent.com/9404962/217289561-7a68e580-cbd7-427e-90fd-03882b4c5272.png\">\r\n","createdAt":"2023-02-07T15:36:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1420977463","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5UsraF","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"View of workflow after `Got the response to undefined request 17029 in`. This is situation when workflow was not able to run subworkflow.\r\n<img width=\"1569\" alt=\"image\" src=\"https://user-images.githubusercontent.com/9404962/217293667-76d1da75-67e3-4662-8804-7d50a5647191.png\">\r\n","createdAt":"2023-02-07T15:49:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1420998277","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Uyfaq","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@roxblnfk I upgraded SDK to ^2.4 version and it's even worse. \r\n<img width=\"1450\" alt=\"image\" src=\"https://user-images.githubusercontent.com/9404962/217530533-5d5c1b5a-ab24-4480-b12f-493b1930825b.png\">\r\n\r\n~9% in 1 hour.\r\n\r\nSo maybe something with Marshaller?\r\n","createdAt":"2023-02-08T12:32:33Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1422522026","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5U5MwF","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"@cv65kr If we would talk only about the workflow execution (without taking into account the restart reasons), this error will only lead to the workflow retrying, and as a result, your workflow will still finish correctly, am I right?","createdAt":"2023-02-09T14:30:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1424280581","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5U5QV6","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@rustatian unfortunately no, if you look on my comment with Temporal UI screen you will see that workflow was canceled (not by me). \r\n\r\nIn the past I had a situation when because of this error couple sub-worklows was assigned to wrong parent and in result of that activity was executed with wrong input. It happened only one time and I was not able to reproduce it. \r\n\r\nThat's why for me \"Got the response to undefined request\" error sounds very dangerous.\r\n\r\nMy first suspect was that horizontal scaling issues e.g. I sent signal to Temporal and Temporal notified all workers so in fact only worker with assigned workflow was able to clean in_memory cache after receiving the signa, and for all rests of workers stayed in memory.","createdAt":"2023-02-09T14:39:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1424295290","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5U5Sgn","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"Could you let me know if you configured workflow retries?","createdAt":"2023-02-09T14:45:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1424304167","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5U5TUV","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"I have workflows with unique id, so in general it cannot be retries. Only activities are retried in my case.","createdAt":"2023-02-09T14:48:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1424307477","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5U5U7F","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"But workflow will preserve the input and ID. It depends on your requirements, but generally, I guess the lack of possibility to restart the workflow is a bad design (it's just my guess, nothing offensive). Would you consider re-designing some parts of some handlers to leave the possibility of having the retries?","createdAt":"2023-02-09T14:52:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1424314053","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5U5XRx","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"Mmmm, money üíµ \r\nAre you 100% sure that your code doesn't have any leaks?\r\n","createdAt":"2023-02-09T14:58:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1424323697","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5U5Zx2","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"I am still checking, I cannot answer you for 100%. There is too much things to check. \r\nRight now I used RR soft reset just to be safe and still looking for root cause.","createdAt":"2023-02-09T15:04:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1424333942","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5U5bIT","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"Actually, `./rr reset` is not a soft one :) This command resets all pools of workers (WF+ACT), temporal workers and purges the sticky cache.","createdAt":"2023-02-09T15:07:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1424339475","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5U5bTe","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"ttl under supervisor option as well?","createdAt":"2023-02-09T15:07:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1424340190","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5U5b4S","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"You can't set a supervisor on a WF worker, only activities. But for the activities, it resets only activities workers.","createdAt":"2023-02-09T15:09:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1424342546","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5U5cei","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"WF worker contains all info about WF executions, responses, etc. It should not be restarted w/o a significant reason. You can see it first in the `./rr worker` output.","createdAt":"2023-02-09T15:10:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1424344994","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5bQgk9","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"Hi guys, \r\n\r\ncould you please report if you still seeing this behaviour on recent SDK and RR releases? We included new mechanism which should improve worker restarts and prevent leaky ids in workers.","createdAt":"2023-05-02T08:07:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1531054397","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5bulKc","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"Sorry, but I am not able to test it now. I will try to do this with other project.","createdAt":"2023-05-08T19:38:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1538937500","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5hUslD","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"To be finally fixed in 2.7 realase.","createdAt":"2023-07-12T16:05:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1632815427","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5kZTtB","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"Hello!\r\nCould you try to use PHP SDK 2.6.0 (dev) with RoadRunner 2023.3.0-beta?\r\n\r\nWe have tested it on a lot of parallel workflows and signals with the `cache_size` option set to 1.\r\nPHP SDK 2.6.0 with RoadRunner 2023.3.0-beta shows a perfect result.\r\nNo any \"Got the response to undefined request\" errors!\r\n\r\nMore details about PHP SDK 2.6.0 (dev) are there:\r\nhttps://discord.com/channels/538114875570913290/824234752692977664/1142176919786360894\r\nhttps://temporalio.slack.com/archives/C01LK9FAMM0/p1692386951356089\r\n\r\nTo install **SDK 2.6.0** dev and RoadRunner 2023.3.0-beta:\r\n\r\n```bash\r\ncomposer require temporal/sdk ~2.6.0@dev -W\r\nvendor/bin/rr get --stability=beta\r\n```","createdAt":"2023-08-18T19:34:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":2}},{"content":"ROCKET","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1684355905","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5oeF3g","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"Hello. Have you already updated to RoadRunner 2023.3 and PHP SDK 2.6.1? Is your problem reproducible on the new versions?\r\n","createdAt":"2023-10-09T10:07:25Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1752718816","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5pnXaz","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"Closing as solved until further comments.","createdAt":"2023-10-20T01:19:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1771927219","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5s8PFD","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@roxblnfk @wolfy-j @rustatian I was opportunity to test the solution during the load test and looks like it not working I see bunch of errors like:\r\n```\r\n\"Error\": \"undefined response: Got the response to undefined request 11264\", \"StackTrace\": \"process event for test-qe [panic]:\\ngithub.com/temporalio/roadrunner-temporal/v4/aggregatedpool.(*Workflow).OnWorkflowTaskStarted(0xc00525cf00, 0x14?)\\n\\tgithub.com/temporalio/roadrunner-temporal/v4@v4.5.6/aggregatedpool/workflow.go:172 +0x319\\ngo.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).ProcessEvent(0xc003d7edf8, 0xc003c2d880, 0x80?, 0x1)\\n\\tgo.temporal.io/sdk@v1.25.1/internal/internal_event_handlers.go:1083 +0x229\\ngo.temporal.io/sdk/internal.(*workflowExecutionContextImpl).ProcessWorkflowTask(0xc0008ecb40, 0xc001a95080)\\n\\tgo.temporal.io/sdk@v1.25.1/internal/internal_task_handlers.go:1074 +0x155d\\ngo.temporal.io/sdk/internal.(*workflowTaskHandlerImpl).ProcessWorkflowTask(0xc002863ba0, 0xc001a95080, 0xc0008ecb40, 0xc0021bee40)\\n\\tgo.temporal.io/sdk@v1.25.1/internal/internal_task_handlers.go:868 +0x3bf\\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).processWorkflowTask(0xc0039e9e60, 0xc001a95080)\\n\\tgo.temporal.io/sdk@v1.25.1/internal/internal_task_pollers.go:354 +0x3a3\\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).ProcessTask(0xc0039e9e60, {0x1b414c0?, 0xc001a95080?})\\n\\tgo.temporal.io/sdk@v1.25.1/internal/internal_task_pollers.go:318 +0x87\\ngo.temporal.io/sdk/internal.(*baseWorker).processTask(0xc003990dc0, {0x1b42040?, 0xc003ff33a0})\\n\\tgo.temporal.io/sdk@v1.25.1/internal/internal_worker_base.go:505 +0x15b\\ngo.temporal.io/sdk/internal.(*baseWorker).processTaskAsync.func1()\\n\\tgo.temporal.io/sdk@v1.25.1/internal/internal_worker_base.go:356 +0x45\\ncreated by go.temporal.io/sdk/internal.(*baseWorker).processTaskAsync in goroutine 20271\\n\\tgo.temporal.io/sdk@v1.25.1/internal/internal_worker_base.go:352 +0xb8\"\r\n```\r\n\r\nI tested 100workflows/sec with limit 5k workflows, after above log it stuck in execution.  Worfklows are simple - some activity with http calls, await for signal with timeout\r\n\r\n\r\n2 containers = ECS 256cpu x 1640 mem\r\n\r\n.rr config\r\ncache_size: 15000\r\nallocate_timeout: 172800s\r\nnum_workers: 8\r\nmax_worker_memory: 160 \r\n\r\nMAX_CONCURRENT_WORKFLOW_TASK_POLLERS: 5\r\nMAX_CONCURRENT_ACTIVITY_TASK_POLLERS: 0\r\nMAX_CONCURRENT_ACTIVITY_EXECUTION_SIZE: 8","createdAt":"2023-11-27T12:19:53Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1827729731","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5s8XQO","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"Hey @cv65kr üëã \r\nWhat is your RR and `sdk-php` versions?","createdAt":"2023-11-27T12:42:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1827763214","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5s8X7r","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@rustatian I forgot to put basic information ü§¶ \r\n\r\nRR: 2023.3.6\r\nSDK: 2.6.1","createdAt":"2023-11-27T12:44:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1827765995","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5s8l_d","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@rustatian what I saw is also after redeployment there is an error `\"Error\": \"nondeterministic workflow: extra replay command for CancelTimer: (TimerId:17)\"}`\r\n\r\nOutput in workflows:\r\n<img width=\"1580\" alt=\"image\" src=\"https://github.com/temporalio/sdk-php/assets/9404962/d25153af-7b2c-4287-a074-9d505149a90d\">\r\n","createdAt":"2023-11-27T13:21:32Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1827823581","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5s9Oc3","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"Can you let us know which version you updated it from?","createdAt":"2023-11-27T14:53:02Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1827989303","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5s9UDo","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@wolfy-j \r\nRR 2.12.2 => 2023.3.6\r\nSDK 2.4.0 => 2.6.1\r\n\r\nBut I ran totally new workflows","createdAt":"2023-11-27T15:05:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1828012264","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5s9een","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"Does this workflow use signals? There was a patch in 2.5.* to address some stability issues.","createdAt":"2023-11-27T15:28:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1828054951","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5s91Vd","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@wolfy-j yes,  I mentioned about that `worfklows are simple - some activity with http calls, await for signal with timeout`\r\n\r\n> Does this workflow use signals? There was a patch in 2.5.* to address some stability issues.\r\n\r\nLike you see I upgraded everything to the newest versions.","createdAt":"2023-11-27T16:11:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1828148573","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5s9-g3","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"Ok, thank you for clarifying. As for signal handling - there are some edge-case scenarios that were handled incorrectly prior to ~2.5 version. This has been addressed, but older workflows might still have this issue.\r\n\r\nAs for the undefined workflow response... this is odd, we've used the solution that eliminates the possibility of de-sync on a conceptual level. Valery is currently on vacations, give us some time to get back with more questions to you.","createdAt":"2023-11-27T16:32:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1828186167","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5s-Nol","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"Feel free to raise questions, currently I have possibilities to do some load tests. I am attaching some metrics which might you reflects what's happened inside containers during running a 300 workflows batch in 5 sec\r\n<img width=\"1331\" alt=\"image\" src=\"https://github.com/temporalio/sdk-php/assets/9404962/ef437551-b6ba-42db-8321-f509f4bf85bd\">\r\n\r\nSo `\"Error\": \"nondeterministic workflow: extra replay command for CancelTimer: (TimerId:17)\"}` might related with `undefined request `?","createdAt":"2023-11-27T16:56:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1828248101","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5tDA3w","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"I attaching couple metrics, which shows the moment when errors start pop up\r\n\r\n<img width=\"1599\" alt=\"image\" src=\"https://github.com/temporalio/sdk-php/assets/9404962/862dc6e4-17c5-4013-a54a-a1ccaadbfba1\">\r\n\r\nCPU was high\r\n<img width=\"176\" alt=\"image\" src=\"https://github.com/temporalio/sdk-php/assets/9404962/04bf9f34-1821-4fe3-bdb6-fcf93ec554eb\">\r\n\r\n\r\nChanged configuration for tests\r\n```\r\n->withMaxConcurrentWorkflowTaskPollers(\r\n                    5\r\n                )\r\n                ->withMaxConcurrentActivityTaskPollers(\r\n                    5\r\n                )\r\n                ->withMaxConcurrentActivityExecutionSize(\r\n                    300\r\n                )\r\n                ->withMaxConcurrentWorkflowTaskExecutionSize(\r\n                    300\r\n                )\r\n```","createdAt":"2023-11-28T10:14:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1829506544","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5tE8uJ","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"> So `\"Error\": \"nondeterministic workflow: extra replay command for CancelTimer: (TimerId:17)\"}` might related with `undefined request `?\r\n\r\nYes, theoretically, it's possible that the older version of the workflow triggered the timer incorrectly (before the patch), and it might cause an extra callback. Do you have a chance to run these tests on post 2.5.3 workflows? I'm trying to ensure that de-sync issue is gone (it is based on our aggressive tests) and this problem is mostly related to post 2.5.3 behaviour.","createdAt":"2023-11-28T14:56:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1830013833","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5tGH3t","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@wolfy-j what do you mean by `it's possible that the older version of the workflow triggered the timer incorrectly`? All my workflows was run with version 2.6.1. \r\n\r\nAnd errors `Got the response to undefined request` and `extra replay command for CancelTimer` are visible in 2.6.1","createdAt":"2023-11-28T17:11:24Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1830321645","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5tVHyg","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@wolfy-j I tested now with 2.5.1 version and issues are the same.","createdAt":"2023-11-30T17:38:08Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1834253472","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5tVIde","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"You should avoid `2.5.1` and test on `2.6.1` üòÉ ","createdAt":"2023-11-30T17:39:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1834256222","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5tVIoo","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"@rustatian I tested both and effect is the same :) ","createdAt":"2023-11-30T17:40:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1834256936","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5tVJsl","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"I mean, `2.5.1` should not be involved in testing, since WF created with the outdated version might be triggered. Ideally, should be 0 WFs and testing session should be on the latest versions only, if that is possible for sure.","createdAt":"2023-11-30T17:43:28Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1834261285","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5u0ZWe","author":{"login":"cv65kr"},"authorAssociation":"CONTRIBUTOR","body":"Any updates?","createdAt":"2023-12-17T17:21:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1859229086","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5u6gMi","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"Hi, this is our pipeline to check at the beginning of Jan. We have to wrap current release first.","createdAt":"2023-12-18T15:34:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1860829986","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5w7IZX","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"Hi,\r\n\r\nWe've spent some time with the whole team over the last few days, and we can confirm that there are no memory leaks in the PHP codebase, including your use case. \r\n\r\nHowever, we managed to reproduce your issue quickly, and its root cause is pretty straightforward. So, let's go so we can finally close this ticket.\r\n\r\nIssue number one - **\"Task processing failed with error - Workflow task not found\"**. This issue is NOT connected to a memory leak but is related to your configuration. \r\n\r\nIn your current setup, it means that you can consume **300** workflows per worker in parallel - https://github.com/cv65kr/samples-php/blob/leak/app/worker.php#L37\r\n\r\nSetting such value on a small worker is possible, but it will sometimes trigger workflow **task timeout** if the worker task can not be performed in time. The reason why it can't be performed in time:\r\n1) Too much to unwind (we addressed that, see below)\r\n2) Too many workflows per worker are trying to do something in parallel.\r\n\r\nNext, you had two conflicting values in your workers:\r\n1) cache size = 15000\r\n2) PHP max_memory_limit = 128Mb (in this docker)\r\n\r\nAs a result, your worker appeared too hungry, trying to serve as many workflows from memory as possible until it hit OOM. Make sure that your sticky cache is set reasonably for your workflows and/or turn off memory limit for workflow workers. \r\n\r\nFor your particular example, 500 workflows in memory consume about 140 MB, so a 15000 sticky cache will need around 4GB.\r\n\r\nI've updated your code with:\r\n1) cache size = 500\r\n2) concurrent workflows = 200\r\n3) workflow pollers = 15\r\n\r\n![Screenshot 2024-01-16 153241](https://github.com/temporalio/sdk-php/assets/796136/e56760b0-3cbf-44fe-8745-472fab51ae6e)\r\n\r\nAs a result, we did not experience any failures or memory leaks in your code. In addition, we have found that under large workflow volume GC will slow down workflow worker, causing even more issues. \r\n\r\nOver the next few days, we will release a patch to address GC overhead, increasing the performance of use cases like yours by 3x.\r\n\r\n![Screenshot 2024-01-16 161004](https://github.com/temporalio/sdk-php/assets/796136/e31deaad-631c-4e9a-aab5-7fac2d7adcda)\r\n\r\nIn short:\r\n1) No memory leaks, your simply over-saturated your worker\r\n2) Please make sure to avoid using PHP memory limit in combination with dispoportional sticky cache size - worker killed by OOM causing ID sync issues\r\n3) Do not overconsume in your workers\r\n\r\n","createdAt":"2024-01-16T21:32:39Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1894549079","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5w-GZk","author":{"login":"mend-for-github-com"},"authorAssociation":"NONE","body":":heavy_check_mark: This issue was automatically closed by Mend because the errors have been resolved.","createdAt":"2024-01-17T08:33:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/289#issuecomment-1895327332","viewerDidAuthor":false}],"createdAt":"2023-02-07T08:47:51Z","labels":[{"id":"LA_kwDOEY5HBM7tPgJ-","name":"Mend: configuration error","description":"WhiteSource configuration error","color":"6b2296"}],"milestone":{"number":2,"title":"2.6.0","description":"Requires Roadrunner 2023.3","dueOn":"2023-09-15T00:00:00Z"},"number":289,"reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"state":"CLOSED","title":"[Bug] Memory leak: Got the response to undefined request 9009 - autoclosed","updatedAt":"2024-01-17T08:33:44Z","url":"https://github.com/temporalio/sdk-php/issues/289"}
