{"assignees":[],"author":{"id":"MDQ6VXNlcjE1MDEzNzA0","is_bot":false,"login":"agpopov","name":"Alexander"},"body":"Hello, I want to test UpdateMethod in workflow. But I get an error:\n\n```\nAssertionError: assert($result !== null)\n/var/www/html/vendor/temporal/sdk/src/Client/Update/UpdateHandle.php:128\n/var/www/html/vendor/temporal/sdk/src/Client/Update/UpdateHandle.php:89\n/var/www/html/vendor/temporal/sdk/src/Client/Update/UpdateHandle.php:75\n/var/www/html/vendor/temporal/sdk/src/Internal/Client/WorkflowProxy.php:112\n/var/www/html/tests/Workflows/UploadFileWorkflowTest.php:83\n```\n\nAt the same time, the signal and jquery tests are working fine.\n\nHere is the test code:\n\n```php\npublic function testCanSaveFileData(): void\n    {\n        $this->testService->lockTimeSkipping();\n\n        $arguments = [\n            'path' => $this->faker()->filePath(),\n            'original_name' => $this->faker()->word(),\n            'extension' => $this->faker()->fileExtension(),\n            'size' => $this->faker()->numberBetween(),\n            'is_image' => $this->faker()->boolean(),\n        ];\n\n        $file = File::factory()->make($arguments);\n\n        $workflow = $this->workflowClient->newWorkflowStub(UploadFileWorkflow::class);\n        $run = $this->workflowClient->start($workflow);\n\n        $this->assertEquals(WorkflowExecutionStatus::Running, $run->describe()->info->status);\n\n        $result = $workflow->saveTempFileData(new SaveFileDataArguments($arguments));\n\n        $this->assertEquals($file->id, $run->describe()->info->searchAttributes->getValue('FileId'));\n        $this->assertEquals($file->toArray(), $result['data']);\n\n        $this->testService->unlockTimeSkipping();\n    }\n```\n\nI tried calling UpdateMethod via `update` and `startUpdate`. the result is exactly the same\n\n","closedAt":null,"comments":[{"id":"IC_kwDOEY5HBM6gm4A2","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"Related with https://github.com/temporalio/sdk-php/pull/526\n\n> This situation can occur when the Workflow neither accepts nor rejects the Update due to:\n> - No available workers\n> - Workflow Task fails in the same tick","createdAt":"2025-03-03T14:17:59Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/577#issuecomment-2694545462","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM6gna5S","author":{"login":"agpopov"},"authorAssociation":"NONE","body":"Unfortunately, I've already checked this. The workers are running, and workflow is not crashing.\n\nHere is the config:\n\n```yaml\nversion: \"3\"\n\nrpc:\n  listen: ${TEMPORAL_TESTING_HOST:-tcp://127.0.0.1:6001}\n\nserver:\n  command: \"php worker.php\"\n\ntemporal:\n  address: ${TEMPORAL_ADDRESS:-127.0.0.1:7233}\n  activities:\n    num_workers: 2\n\nlogs:\n  level: info\n  channels:\n    server:\n      mode: debug\n      output: worker.log\n\nkv:\n  testing:\n    driver: memory\n    config:\n      interval: 10\n```\n\nHere is the worker's code:\n\n```php\n\nrequire 'vendor/autoload.php';\n$app = require 'bootstrap/app.php';\n\n$app->make(Kernel::class)->bootstrap();\n\n$factory = WorkerFactory::create(\n    rpc: new Goridge(Relay::create(config('testing.temporal.host'))),\n    activityCache: RoadRunnerActivityInvocationCache::create()\n);\n\n$worker = $factory->newWorker(\n    taskQueue: config('testing.temporal.queue'),\n    interceptorProvider: new SimplePipelineProvider(\n        app(InterceptorCollection::class)->toArray(),\n    ),\n);\n\n$worker->registerWorkflowTypes(...config('orchestrator.temporal.workflows'));\n\nforeach (config(\"orchestrator.temporal.activities\", []) as $activityType) {\n    $worker->registerActivity($activityType, fn(ReflectionClass $class) => app($class->getName()));\n}\n\n$factory->run();\n\nerror_log('stop worker');\n```","createdAt":"2025-03-03T15:00:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/577#issuecomment-2694688338","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM6gn0fF","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"> `$this->testService->lockTimeSkipping();`\n\nAre you using the Test Server? Does it already support updates?","createdAt":"2025-03-03T15:37:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/577#issuecomment-2694793157","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM6go4Gg","author":{"login":"agpopov"},"authorAssociation":"NONE","body":"I use the TestService in the base TestCase class\n```php\n $temporalAddress = getenv('TEMPORAL_ADDRESS') ?: '127.0.0.1:7233';\n $this->testService = TestService::create($temporalAddress);\n```\n\nI'm running the test server through Environment\n```php\nuse Temporal\\Testing\\Environment;\n\nrequire getcwd().'/vendor/autoload.php';\n\nif (env('TEMPORAL_TESTING_ENABLED') === true) {\n    $environment = Environment::create();\n    $environment->start(\n        rrCommand: './rr serve -d -c '.__DIR__.'/.rr.yaml -w '.__DIR__\n    );\n    register_shutdown_function(fn() => $environment->stop());\n}\n```\n\nAnd how can I find out that the test server supports updates? I didn't find it in the documentation.","createdAt":"2025-03-03T17:21:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/577#issuecomment-2695070112","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM6gxBQ8","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"> And how can I find out that the test server supports updates? I didn't find it in the documentation.\n\nThis is not in the documentation. The temporal-test-server is taken from the [release artifacts of the JAVA SDK](https://github.com/temporalio/sdk-java/releases). You can track release notes and issues.\n\nTry the [dev-server](https://github.com/temporalio/sdk-php#temporal-cli). There is no timeskipping but it works with the most Temporal features","createdAt":"2025-03-04T11:28:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/577#issuecomment-2697204796","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM6jvUJ5","author":{"login":"jmortlock"},"authorAssociation":"CONTRIBUTOR","body":"I'm also hitting the same (or similar) problem when trying to write some tests for updates on a workflow.\n\nLooks like \"test-server\" has support for update: https://github.com/temporalio/sdk-java/issues/1742\n\nI either hit a `Temporal\\Exception\\DestructMemorizedInstanceException` exception or if i disable the DestroyWorkflow process than I get a timeout.\n\nI've added debug code to the Workflow update method which shows its working nicely, it just never gets returned.\n","createdAt":"2025-03-24T07:07:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/577#issuecomment-2747089529","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM7bN-sF","author":{"login":"xepozz"},"authorAssociation":"COLLABORATOR","body":"@agpopov @jmortlock is there a reproducer?","createdAt":"2025-12-20T14:49:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/577#issuecomment-3677874949","viewerDidAuthor":false}],"createdAt":"2025-03-03T13:46:57Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":577,"reactionGroups":[],"state":"OPEN","title":"[Bug] Can't run the tests of UpdateMethod","updatedAt":"2025-12-20T14:49:57Z","url":"https://github.com/temporalio/sdk-php/issues/577"}
