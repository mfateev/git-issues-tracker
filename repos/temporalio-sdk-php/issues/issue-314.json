{"assignees":[{"id":"MDQ6VXNlcjQxNTI0ODE=","login":"roxblnfk","name":"Aleksei Gagarin","databaseId":0},{"id":"MDQ6VXNlcjgwNDAzMzg=","login":"rustatian","name":"Valery Piashchynski","databaseId":0}],"author":{"id":"MDQ6VXNlcjUxNDkzMg==","is_bot":false,"login":"antmendoza","name":"Antonio Mendoza P√©rez"},"body":"### What are you really trying to do?\r\n\r\nSchedule/invoke an activity in a signal handler\r\n\r\n<!-- \r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\n-->\r\n\r\n### Describe the bug\r\n\r\nHaving the following workflow code, where addName is a  `#[SignalMethod]`,\r\n```php\r\n\r\n    public function addName(string $name): void\r\n    {\r\n        $this->greetingActivity->composeGreeting('Hello', $name);\r\n    }\r\n\r\n```\r\n\r\nOne customer reported that sometimes the activity is not scheduled after the signal is delivered to the workflow execution.  \r\nIt does not make any difference if the activity invocation sync or async \r\n\r\nI have tried to reproduce the issue with no luck. \r\n\r\nAttaching two event histories following this same path. As can be noted, in one of them the activity is not scheduled after receiving the signal (event 15), which later causes an NDE on replay. \r\n\r\n![event-history-revised](https://github.com/temporalio/sdk-php/assets/514932/6cb34aa0-5509-4544-9fe7-6bc9f99fa49c)\r\n\r\n![event-history-revised-2](https://github.com/temporalio/sdk-php/assets/514932/b60dbaa5-9586-43eb-ba03-f447a75766db)\r\n\r\n\r\n\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n\r\n### Minimal Reproduction\r\n\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: [e.g. M1 Mac, x86 Windows, Linux]\r\n- Temporal Version: [e.g. 1.14.0?] and/or SDK version\r\n- Are you using Docker or Kubernetes or building Temporal from source?\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n","closedAt":"2023-10-19T19:58:25Z","comments":[{"id":"IC_kwDOEY5HBM5gjQjT","author":{"login":"antmendoza"},"authorAssociation":"MEMBER","body":"The customer sees this pattern in 0,75% of the workflow executions.","createdAt":"2023-07-04T09:10:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1619855571","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5gjXDd","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"Are there any details on the behavior of the primary workflow method? Does it spawn any coroutines, what is the exit condition?","createdAt":"2023-07-04T09:25:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1619882205","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5gj509","author":{"login":"dbakiu"},"authorAssociation":"NONE","body":"Hello, thanks for looking into it. \r\n\r\nThe main workflow sets several class properties, it invokes several activities (database updates, API calls to other services), and ultimately waits for a timer to expire. Once the timer expires, it continues to invoke a few more activities, after which it terminates. \r\n\r\nPlease feel free to ping me for any other questions.","createdAt":"2023-07-04T10:55:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1620024637","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5g4IT3","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"Can you provide us with some simplistic way to represent your workflow? When your timer fires and you exit - do you wait for schedules activities in signals to be completed?","createdAt":"2023-07-07T12:14:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1625326839","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5g4O6d","author":{"login":"dbakiu"},"authorAssociation":"NONE","body":"Hi Anton, here's a high level description of what the workflow does:\r\n- sets several properties of the class based on an argument that gets passed to the workflow method\r\n- executes `activityAlpha` (database call)\r\n- fetches the version of the workflow, and depending on that, performs `activityBeta` (API call via HTTP) or skips it\r\n- in a for cycle, it sleeps for a specific amount of days and upon wakeup it executes `activityGamma` (API call via HTTP), and, depending on the version again, invokes `activityBeta` (API call via HTTP) for a maximum of 3 times\r\n- once out of the cycle, depending on the version, it sleeps for several days and performs `activityBeta` (API call via HTTP), or skips it entirely\r\n- waits for another timer which sleeps for several days\r\n- upon wakeup, it executes 4 different activities (similarly to the ones above, 3 API calls via HTTP  and 1 database call)\r\n- it terminates\r\n\r\nWe're yield-ing all invocations of the activities/promises, both inside the workflow, as well as the signal. I assume this is considered as \"waiting\" for the activities to be completed. If not, then could you please clarify what you mean exactly?\r\n\r\nThanks,\r\nDriton","createdAt":"2023-07-07T12:37:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1625353885","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5g4WtN","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"@dbakium like this?\r\n\r\n```php\r\nclass TestWorkflow\r\n{\r\n    private mixed $arg1;\r\n    private mixed $arg2;\r\n    private ActivityProxy $activityAlpha;\r\n    private ActivityProxy $activityBeta;\r\n    private ActivityProxy $activityGamma;\r\n\r\n    public function handler(mixed $arg1, mixed $arg2)\r\n    {\r\n        $this->arg1 = $arg1;\r\n        $this->arg2 = $arg2;\r\n\r\n        yield $this->activityAlpha->execute();\r\n        /*if version...*/ yield $this->activityBeta->execute();\r\n\r\n        $result = [];\r\n        for ($i = 3; $i > 0; $i--) {\r\n            yield Workflow::timer('5 days');\r\n\r\n            yield $this->activityGamma->execute();\r\n            /*if version...*/ yield $this->activityBeta->execute();\r\n        }\r\n        yield Workflow::timer('5 days');\r\n\r\n        /*if version...*/ yield $this->activityBeta->execute();\r\n    }\r\n\r\n    public function signalAlpha(string $arg)\r\n    {\r\n        yield $this->activityAlpha->execute($arg);\r\n    }\r\n\r\n    public function signalBeta(string $arg)\r\n    {\r\n        yield $this->activityBeta->execute($arg);\r\n    }\r\n\r\n    public function signalGamma(string $arg)\r\n    {\r\n        yield $this->activityGamma->execute($arg);\r\n    }\r\n}\r\n```","createdAt":"2023-07-07T13:03:16Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1625385805","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5g4Y-N","author":{"login":"dbakiu"},"authorAssociation":"NONE","body":"Hi Aleksei, \r\n\r\nYes, the only difference is that the invoked signal contains several class property assignments as well, so something like:\r\n```\r\npublic function signalAlpha(bool $newStatus)\r\n    {\r\n      $this->arg1 = $newStatus;\r\n        yield $this->activityAlpha->execute(new DatabaseUpdateRequest($newStatus));\r\n    }\r\n","createdAt":"2023-07-07T13:10:55Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1625395085","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5g4grY","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"In your case the workflow may be closed before an activity from a signal method will be done\r\n\r\nSome signal method activity counter might help:\r\n\r\n```php\r\nclass Test\r\n{\r\n    private mixed $arg1;\r\n    private mixed $arg2;\r\n    private ActivityProxy $activityAlpha;\r\n    private ActivityProxy $activityBeta;\r\n    private ActivityProxy $activityGamma;\r\n    // FIX: Add signals counter\r\n    private ActivityProxy $waitingSignals;\r\n\r\n    public function handler(mixed $arg1, mixed $arg2)\r\n    {\r\n        $this->arg1 = $arg1;\r\n        $this->arg2 = $arg2;\r\n\r\n        yield $this->activityAlpha->execute();\r\n        /*if version...*/ yield $this->activityBeta->execute();\r\n\r\n        $result = [];\r\n        for ($i = 3; $i > 0; $i--) {\r\n            yield Workflow::timer('5 days');\r\n\r\n            yield $this->activityGamma->execute();\r\n            /*if version...*/ yield $this->activityBeta->execute();\r\n        }\r\n        yield Workflow::timer('5 days');\r\n\r\n        /*if version...*/ yield $this->activityBeta->execute();\r\n\r\n        // FIX: Wait signals completion\r\n        // Use awaitWithTimeout to add timeout here (better option)\r\n        /* if yet another version... */ yield Workflow::await(fn() => $this->waitingSignals === 0);\r\n    }\r\n\r\n    public function signalAlpha(string $arg)\r\n    {\r\n        // FIX\r\n        ++$this->waitingSignals;\r\n        try {\r\n            yield $this->activityAlpha->execute($arg);\r\n        } finally {\r\n            --$this->waitingSignals;\r\n        }\r\n    }\r\n\r\n    public function signalBeta(string $arg)\r\n    {\r\n        // FIX\r\n        ++$this->waitingSignals;\r\n        try {\r\n            yield $this->activityBeta->execute($arg);\r\n        } finally {\r\n            --$this->waitingSignals;\r\n        }\r\n    }\r\n\r\n    public function signalGamma(string $arg)\r\n    {\r\n        // FIX\r\n        ++$this->waitingSignals;\r\n        try {\r\n            yield $this->activityGamma->execute($arg);\r\n        } finally {\r\n            --$this->waitingSignals;\r\n        }\r\n    }\r\n}\r\n```\r\n","createdAt":"2023-07-07T13:35:34Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1625426648","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5g4oM7","author":{"login":"dbakiu"},"authorAssociation":"NONE","body":"I'm not sure that's the issue here, as the workflows in question whose signals failed to schedule the activity were/are still running, so it's not that the workflows terminated before the activity included in the signal could execute. However, that is a good suggestion and it's something we'll take a look at moving further. ","createdAt":"2023-07-07T13:57:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1625457467","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5g44Ga","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"@dbakiu do I understand correctly that versioning rules have always been followed in your code and the appearance of the activity call in the signal method on the second image cannot in any way be connected with such a possibility that in some previous revision of this activity launch code there was no?\r\n\r\n","createdAt":"2023-07-07T14:45:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1625522586","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5g6h7m","author":{"login":"dbakiu"},"authorAssociation":"NONE","body":"@roxblnfk definitely, the signal itself hasn't changed since the initial version of the workflow was deployed, so no versioning rule exists within the signal definition. ","createdAt":"2023-07-07T19:26:48Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1625956070","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5hLf2P","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"You got it. Can you also tell us which Temporal SDK version you use? We are working on reproducing this use-case...","createdAt":"2023-07-11T08:42:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1630403983","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5hLn5g","author":{"login":"dbakiu"},"authorAssociation":"NONE","body":"Hi, thanks for the update.\r\nWe're using `v2.5.0`, on an Alpine-based docker image, on Kubernetes.  ","createdAt":"2023-07-11T09:00:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1630436960","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5hP_DZ","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"Hey @dbakiu üëãüèª \r\nCould you please check, what RR version you use? `./rr --version` command output.","createdAt":"2023-07-11T22:16:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1631580377","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5hQHrZ","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"Also, if that's possible, could you please provide debug (would be super cool) or at least error logs before/after this happens?\r\n\r\nWe tried to reproduce the bug, no luck. Sending hundreds of signals to the dozens of workflows - no luck. I think that these failures happened because of the WF worker restarts due to out of memory or some other exception.","createdAt":"2023-07-11T23:03:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1631615705","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5hSavG","author":{"login":"dbakiu"},"authorAssociation":"NONE","body":"> Hey @dbakiu üëãüèª Could you please check, what RR version you use? `./rr --version` command output.\r\n\r\nHey, here you go:\r\nRoadrunner: `rr version 2023.1.1 (build time: 2023-04-20T12:40:33+0000, go1.20.3)`\r\nPHP: 8.1.18\r\n\r\n> Also, if that's possible, could you please provide debug (would be super cool) or at least error logs before/after this happens?\r\n> \r\n> We tried to reproduce the bug, no luck. Sending hundreds of signals to the dozens of workflows - no luck. I think that these failures happened because of the WF worker restarts due to out of memory or some other exception.\r\n\r\nSince the issue is only happening in production and we're unable to reproduce it locally, it is difficult to provide logs, apart from the error message that we got, which is a fairly generic one:\r\n```{\r\n  \"message\": \"nondeterministic workflow: extra replay command for ScheduleActivityTask: (ActivityId:19, ActivityType:(Name:WorkflowClassNameX.ActivityNameY.activityMethodZ), TaskQueue:(Name:default, Kind:Normal), Input:(Payloads:[len=1]), ScheduleToCloseTimeout:0s, ScheduleToStartTimeout:0s, StartToCloseTimeout:5s, HeartbeatTimeout:0s, RequestEagerExecution:true)\",\r\n  \"source\": \"GoSDK\",\r\n  \"stackTrace\": \"\",\r\n  \"encodedAttributes\": null,\r\n  \"cause\": null,\r\n  \"applicationFailureInfo\": {\r\n    \"type\": \"historyMismatchError\",\r\n    \"nonRetryable\": false,\r\n    \"details\": null\r\n  }\r\n}\r\n```\r\nRegarding your OOM suspicion, I took a look at our monitoring systems, and the memory usage on the pods has been consistently low. On average, it's around 10%, with a peak of 14% over the last 3 months. We're also monitoring the sticky cache size, and during that same period, it averages at about 220, with a maximum of 590, which is well under the default limit of 10000. Additionally, we have increased the sticky cache size to 20000, which was one advice we got from the Temporal support crew after the last batch of errors appeared. \r\n\r\nAs for any other exceptions that may occur, there's monitoring in place which should alert us if any erratic behavior is detected, and apart from the NDE-related exceptions, there have been no other exceptions in that period.","createdAt":"2023-07-12T10:03:47Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1632218054","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5hUtKQ","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"Thanks @dbakiu üëçüèª \r\nLooks like we found the problem. On it.","createdAt":"2023-07-12T16:07:00Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1632817808","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5jC81a","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"We are expecting that cumulative update by v2.5.3 and v2.5.4 will fix possible Signal issues.","createdAt":"2023-08-02T08:11:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}},{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1661717850","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5kZrku","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"@dbakiu üëãüèª \r\nHave you had a chance to try out these new versions yet ?","createdAt":"2023-08-18T21:29:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1684453678","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5kgJS7","author":{"login":"dbakiu"},"authorAssociation":"NONE","body":"Hi @rustatian,\r\n\r\nWe temporarily moved away from using activities in signals, so we weren't able to test whether the fix that was pushed as part of v2.5.3 and v.2.5.4 has addressed our issue. Since the bug is difficult to reproduce, as you saw yourself, it's also difficult to verify that it has been fixed. That being said, we will come up with a plan on reintroducing the activities and monitor the situation. \r\n\r\n","createdAt":"2023-08-21T11:25:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":3}}],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1686148283","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5khfJ0","author":{"login":"rustatian"},"authorAssociation":"COLLABORATOR","body":"Hi @dbakiu üëãüèª \r\nOf course üòÉ, the issue will remain open until you're able to test this case. Feel free to post updates here üëçüèª ","createdAt":"2023-08-21T15:01:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1686499956","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5oeGPh","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"Hello. Are there any updates on this issue?\r\n","createdAt":"2023-10-09T10:08:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1752720353","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5pmMuG","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"If the issue is still relevant, just reopen it.","createdAt":"2023-10-19T19:58:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/314#issuecomment-1771621254","viewerDidAuthor":false}],"createdAt":"2023-07-04T09:01:20Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":2,"title":"2.6.0","description":"Requires Roadrunner 2023.3","dueOn":"2023-09-15T00:00:00Z"},"number":314,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Activity not scheduled in signal handler","updatedAt":"2023-10-19T19:58:26Z","url":"https://github.com/temporalio/sdk-php/issues/314"}
