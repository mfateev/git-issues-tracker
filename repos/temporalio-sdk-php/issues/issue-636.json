{"assignees":[],"author":{"id":"MDQ6VXNlcjEzODE2NzA0","is_bot":false,"login":"root-aza","name":"Vlad Shashkov"},"body":"### What are you really trying to do?\n\nI am starting the workflow\n\n\n### Describe the bug\n\nIf an exception is thrown from PayloadConverter, it cannot be processed and is not visible in the logs or in ui temporal itself. I would like to be able to send this exception to sentry/logs\n\n\n\n### Minimal Reproduction\n\n<details>\n  <summary>ChildWorkflow Case</summary>\n\n\n```php\n<?php\n\nfinal class BRequest\n{\n    public function __construct(\n        public string $id,\n    ) {\n    }\n}\n\n\n#[WorkflowInterface]\n#[AssignWorker('mdm.client_verification.workflow')]\nfinal class BWorkflow\n{\n    #[WorkflowMethod('BWorkflow')]\n    public function start(BRequest $request): Generator\n    {\n        yield Workflow::timer(CarbonInterval::minutes(1));\n    }\n}\n\n\n#[WorkflowInterface]\n#[AssignWorker('mdm.client_verification.workflow')]\nfinal class AWorkflow\n{\n    #[WorkflowMethod('AWorkflow')]\n    public function start(): Generator\n    {\n        $workflow = Workflow::newChildWorkflowStub(\n            BWorkflow::class,\n            Workflow\\ChildWorkflowOptions::new()\n                ->withTaskQueue('mdm.client_verification.workflow')\n                ->withNamespace(Workflow::getInfo()->namespace)\n        );\n\n        yield $workflow->start(new BRequest('123'));\n    }\n}\n```\n\n\n<details>\n  <summary>DataConverter</summary>\n\n\n```php\n<?php\n\n/**\n * Temporal Bundle\n *\n * @author Vlad Shashkov <v.shashkov@pos-credit.ru>\n * @copyright Copyright (c) 2023, The Vanta\n */\n\ndeclare(strict_types=1);\n\nnamespace Vanta\\Integration\\Symfony\\Temporal\\DataConverter;\n\nuse App\\ClientVerification\\Workflow\\Join\\BRequest;\nuse Symfony\\Component\\Serializer\\Normalizer\\AbstractObjectNormalizer as ObjectNormalizer;\nuse Symfony\\Component\\Serializer\\SerializerInterface as Serializer;\nuse Temporal\\Api\\Common\\V1\\Payload;\nuse Temporal\\DataConverter\\EncodingKeys;\nuse Temporal\\DataConverter\\JsonConverter;\nuse Temporal\\DataConverter\\PayloadConverterInterface as PayloadConverter;\nuse Temporal\\DataConverter\\Type;\nuse Temporal\\Exception\\DataConverterException;\nuse Throwable;\n\nfinal readonly class SymfonySerializerDataConverter implements PayloadConverter\n{\n    private const INPUT_TYPE = 'symfony.serializer.type';\n\n\n    public function __construct(\n        private Serializer $serializer,\n        private PayloadConverter $payloadConverter = new JsonConverter(),\n    ) {\n    }\n\n\n    public function getEncodingType(): string\n    {\n        return EncodingKeys::METADATA_ENCODING_JSON;\n    }\n\n    public function toPayload($value): Payload\n    {\n        $metadata = [\n            EncodingKeys::METADATA_ENCODING_KEY => $this->getEncodingType(),\n        ];\n\n        $context = [ObjectNormalizer::PRESERVE_EMPTY_OBJECTS => true];\n\n        if (is_object($value)) {\n            $metadata[self::INPUT_TYPE] = $value::class;\n        }\n\n        try {\n            $data = $this->serializer->serialize($value, 'json', $context);\n        } catch (Throwable $e) {\n            throw new DataConverterException($e->getMessage(), $e->getCode(), $e);\n        }\n\n        $payload = new Payload();\n        $payload->setMetadata($metadata);\n        $payload->setData($data);\n\n        return $payload;\n    }\n\n    public function fromPayload(Payload $payload, Type $type): mixed\n    {\n        if (\"null\" == $payload->getData() && $type->allowsNull()) {\n            return null;\n        }\n\n        /** @var string|null $inputType */\n        $inputType = $payload->getMetadata()[self::INPUT_TYPE] ?? null;\n\n\n        if ($inputType == BRequest::class) {\n            // dump\n            throw new DataConverterException('BAM', 3, null);\n        }\n\n        if (!$type->isClass() && $inputType == null) {\n            return $this->payloadConverter->fromPayload($payload, $type);\n        }\n\n        try {\n            return $this->serializer->deserialize($payload->getData(), $inputType ?? $type->getName(), 'json');\n        } catch (Throwable $e) {\n            throw new DataConverterException($e->getMessage(), $e->getCode(), $e);\n        }\n    }\n}\n```\n\n</details>\n\n\n\n\n<details>\n  <summary>Temporal UI</summary>\n\n<img width=\"2372\" height=\"1234\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/2b7a76a3-66c9-4000-97a7-3301552938cf\" />\n</details>\n\n\n\n<details>\n  <summary>Event history</summary>\n\n[594e549a-bb6d-4d0d-8415-6172ee9e4d56_events.json](https://github.com/user-attachments/files/21363356/594e549a-bb6d-4d0d-8415-6172ee9e4d56_events.json)\n\n\n</details>\n\n\n</details>\n\n\n\n\n<details>\n  <summary>ContinueAsNew Case</summary>\n\n```php\n<?php\n\n#[WorkflowInterface]\n#[AssignWorker('mdm.client_verification.workflow')]\nfinal class AWorkflow\n{\n    #[WorkflowMethod('AWorkflow')]\n    public function start(?stdClass $foo = null): Generator\n    {\n\n        yield Workflow::timer(CarbonInterval::second(30));\n\n\n        $workflow = Workflow::newContinueAsNewStub(\n            self::class,\n            ContinueAsNewOptions::new()\n                 ->withTaskQueue('mdm.client_verification.workflow')\n        );\n\n        yield $workflow->start(new stdClass());\n    }\n}\n\n```\n\n\n\n<details>\n  <summary>DataConverter</summary>\n\n```php\n<?php\n\n/**\n * Temporal Bundle\n *\n * @author Vlad Shashkov <v.shashkov@pos-credit.ru>\n * @copyright Copyright (c) 2023, The Vanta\n */\n\ndeclare(strict_types=1);\n\nnamespace Vanta\\Integration\\Symfony\\Temporal\\DataConverter;\n\nuse App\\ClientVerification\\Workflow\\Join\\BRequest;\nuse Symfony\\Component\\Serializer\\Normalizer\\AbstractObjectNormalizer as ObjectNormalizer;\nuse Symfony\\Component\\Serializer\\SerializerInterface as Serializer;\nuse Temporal\\Api\\Common\\V1\\Payload;\nuse Temporal\\DataConverter\\EncodingKeys;\nuse Temporal\\DataConverter\\JsonConverter;\nuse Temporal\\DataConverter\\PayloadConverterInterface as PayloadConverter;\nuse Temporal\\DataConverter\\Type;\nuse Temporal\\Exception\\DataConverterException;\nuse Throwable;\n\nfinal readonly class SymfonySerializerDataConverter implements PayloadConverter\n{\n    private const INPUT_TYPE = 'symfony.serializer.type';\n\n\n    public function __construct(\n        private Serializer $serializer,\n        private PayloadConverter $payloadConverter = new JsonConverter(),\n    ) {\n    }\n\n\n    public function getEncodingType(): string\n    {\n        return EncodingKeys::METADATA_ENCODING_JSON;\n    }\n\n    public function toPayload($value): Payload\n    {\n        $metadata = [\n            EncodingKeys::METADATA_ENCODING_KEY => $this->getEncodingType(),\n        ];\n\n        $context = [ObjectNormalizer::PRESERVE_EMPTY_OBJECTS => true];\n\n        if (is_object($value)) {\n            $metadata[self::INPUT_TYPE] = $value::class;\n        }\n\n        try {\n            $data = $this->serializer->serialize($value, 'json', $context);\n        } catch (Throwable $e) {\n            throw new DataConverterException($e->getMessage(), $e->getCode(), $e);\n        }\n\n        $payload = new Payload();\n        $payload->setMetadata($metadata);\n        $payload->setData($data);\n\n        return $payload;\n    }\n\n    public function fromPayload(Payload $payload, Type $type): mixed\n    {\n        if (\"null\" == $payload->getData() && $type->allowsNull()) {\n            return null;\n        }\n\n        /** @var string|null $inputType */\n        $inputType = $payload->getMetadata()[self::INPUT_TYPE] ?? null;\n\n\n        if ($inputType == \\stdClass::class) {\n            // workflow broken ðŸ’¥\n            throw new DataConverterException('BAM', 3, null);\n        }\n\n        if (!$type->isClass() && $inputType == null) {\n            return $this->payloadConverter->fromPayload($payload, $type);\n        }\n\n        try {\n            return $this->serializer->deserialize($payload->getData(), $inputType ?? $type->getName(), 'json');\n        } catch (Throwable $e) {\n            throw new DataConverterException($e->getMessage(), $e->getCode(), $e);\n        }\n    }\n}\n```\n\n</details>\n\n\n<details>\n  <summary>Temporal UI</summary>\n\n<img width=\"2388\" height=\"1271\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/366e95a4-d25e-4d44-aed5-f027bbebf307\" />\n\n\n<img width=\"2393\" height=\"1302\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/564c90df-661e-4870-ae50-dd2ab0fb2906\" />\n</details>\n\n\n\n<details>\n  <summary>Event history</summary>\n\n[dc5c2461-ab3e-4db6-9b3d-b9975f590159_events.json](https://github.com/user-attachments/files/21425040/dc5c2461-ab3e-4db6-9b3d-b9975f590159_events.json)\n\n[ce120686-533e-4f9a-b7fd-c6f164ebf23c_events.json](https://github.com/user-attachments/files/21425046/ce120686-533e-4f9a-b7fd-c6f164ebf23c_events.json)\n\n</details>\n\n\n\n</details>\n\n\n### Environment/Versions\n\n- Temporal sdk 2.15.1\n- RoadRunner 2025.1.2\n- Temporal server 1.24.2\n","closedAt":null,"comments":[],"createdAt":"2025-07-13T06:47:25Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":636,"reactionGroups":[],"state":"OPEN","title":"[Bug] Suppressed exception in worfklow child","updatedAt":"2025-07-25T05:42:05Z","url":"https://github.com/temporalio/sdk-php/issues/636"}
