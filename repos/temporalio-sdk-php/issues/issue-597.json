{"assignees":[{"id":"MDQ6VXNlcjQxNTI0ODE=","login":"roxblnfk","name":"Aleksei Gagarin","databaseId":0}],"author":{"id":"MDQ6VXNlcjEzMzE1NTk=","is_bot":false,"login":"KorDum","name":"KorDum"},"body":"### What are you really trying to do?\n\nI had a task: I needed to run a child workflow in abandon mode. If we talk about the real task, I had a workflow of order creation, at the end it was necessary to put on execution a child workflow with automatic order canceling after 30 minutes, if the order was not paid.\n\nFor this task I used `Workflow::asyncDetached`, information about which I indirectly got from [this](https://docs.temporal.io/develop/php/asynchronous-activity-completion) documentation page, plus I looked at the available methods in the API.\n\n### Describe the bug\n\nHowever, the use of this method has led to large memory leaks in applications processing workflow tasks. These memory leaks do not occur if `Workflow::newUntypedChildWorkflowStub(...)->start()` is used.\n\n### Minimal Reproduction\n\nhttps://github.com/KorDum/samples-php/tree/demo/app/src/Child\n\n### Environment/Versions\n\n- OS and processor: Linux\n- Temporal SDK Version: 2.13.4\n- RoadRunner: 2024.3.5\n\n### Additional context\n\nDiscussion in the Russian-language thread was [here](https://discord.com/channels/538114875570913290/812248381983817730/threads/1341349286327091201).\n","closedAt":"2025-04-15T13:38:15Z","comments":[{"id":"IC_kwDOEY5HBM6nD_CP","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"I wrote a test workflow to reproduce the leak.\n\nI discovered a memory leak in cases where `Workflow::asyncDetached` is used incorrectly: without a `yield` (`await`) construction. In this case, along with action start requests from the detached scope, RoadRunner receives information that the Workflow has completed. RoadRunner sends a DestroyWorkflow command, but the requests to start actions remain in PHP memory without responses and are not cleaned up.\n\nTo permanently resolve the issue with hanging requests, I'm considering a solution where the Client instance, which stores the collection of requests, would be individual for each Workflow scope and destroyed along with it.","createdAt":"2025-04-14T19:54:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/597#issuecomment-2802839695","viewerDidAuthor":false}],"createdAt":"2025-04-14T06:53:21Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":597,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Workflow::asyncDetached memory leak","updatedAt":"2025-04-15T13:38:16Z","url":"https://github.com/temporalio/sdk-php/issues/597"}
