{"assignees":[{"id":"MDQ6VXNlcjI0NjEyNTc=","login":"SerafimArts","name":"Kirill Nesmeyanov","databaseId":0}],"author":{"id":"MDQ6VXNlcjc0Nzk0Nw==","is_bot":false,"login":"kozlice","name":"Valentin Nazarov"},"body":"**Describe the bug**\r\nI'm trying to implement a self-restarting workflow. The idea is simple: await until user balance is zero, do stuff, await until it's above zero, then restart. Here's how the workflow looks like:\r\n\r\n```php\r\n<?php\r\n\r\ndeclare(strict_types=1);\r\n\r\nnamespace Application\\BusinessProcess\\ZeroBalance;\r\n\r\nuse Application\\BusinessProcess\\BusinessProcessWorkflowInterface;\r\nuse Temporal\\Activity\\ActivityOptions;\r\nuse Temporal\\Internal\\Workflow\\ActivityProxy;\r\nuse Temporal\\Workflow;\r\n\r\n#[Workflow\\WorkflowInterface]\r\nclass ZeroBalanceWorkflow implements BusinessProcessWorkflowInterface\r\n{\r\n    private ActivityProxy|ZeroBalanceActivity $activity;\r\n    private ?int $balance = null;\r\n\r\n    public function __construct()\r\n    {\r\n        $options = ActivityOptions::new()\r\n            ->withScheduleToStartTimeout('PT1H')\r\n            ->withScheduleToCloseTimeout('P1M')\r\n            ->withStartToCloseTimeout('PT5M')\r\n        ;\r\n\r\n        $this->activity = Workflow::newActivityStub(ZeroBalanceActivity::class, $options);\r\n    }\r\n\r\n    #[Workflow\\WorkflowMethod]\r\n    public function execute(int $educationServiceId): \\Generator\r\n    {\r\n        yield Workflow::await(fn () => $this->balance === 0);\r\n        yield $this->activity->doStuffWhenZero($educationServiceId);\r\n        yield Workflow::await(fn () => $this->balance > 0);\r\n        yield $this->activity->doStuffWhenAboveZero($educationServiceId);\r\n        return Workflow::continueAsNew(self::class, [$educationServiceId]);\r\n    }\r\n\r\n    #[Workflow\\SignalMethod]\r\n    public function setBalance(int $balance): void\r\n    {\r\n        $this->balance = $balance;\r\n    }\r\n}\r\n```\r\n\r\nActivity doesn't really do anything, but just for completeness:\r\n```php\r\n<?php\r\n\r\ndeclare(strict_types=1);\r\n\r\nnamespace Application\\BusinessProcess\\ZeroBalance;\r\n\r\nuse Application\\BusinessProcess\\BusinessProcessActivityInterface;\r\nuse Psr\\Log\\LoggerAwareInterface;\r\nuse Psr\\Log\\LoggerAwareTrait;\r\nuse Temporal\\Activity;\r\n\r\n#[Activity\\ActivityInterface]\r\nclass ZeroBalanceActivity implements BusinessProcessActivityInterface, LoggerAwareInterface\r\n{\r\n    use LoggerAwareTrait;\r\n\r\n    #[Activity\\ActivityMethod]\r\n    public function doStuffWhenZero(int $educationServiceId): int\r\n    {\r\n        $this->logger->info(sprintf('Doing stuff for ID %d, balance is zero', $educationServiceId));\r\n\r\n        return 42;\r\n    }\r\n\r\n    #[Activity\\ActivityMethod]\r\n    public function doStuffWhenAboveZero(int $educationServiceId): int\r\n    {\r\n        $this->logger->info(sprintf('Doing stuff for ID %d, balance is ABOVE zero now', $educationServiceId));\r\n\r\n        return 42;\r\n    }\r\n}\r\n```\r\n\r\nThe tricky part is that I'm using Symfony as well. Here's the modified worker binary:\r\n```php\r\n#!/usr/bin/env php\r\n<?php\r\n\r\ndeclare(strict_types=1);\r\n\r\nuse Application\\BusinessProcess\\BusinessProcessRegistry;\r\nuse Infrastructure\\Kernel;\r\nuse Symfony\\Component\\Dotenv\\Dotenv;\r\nuse Temporal\\WorkerFactory;\r\n\r\nini_set('display_errors', 'stderr');\r\n\r\nset_time_limit(0);\r\ninclude dirname(__DIR__).'/vendor/autoload.php';\r\n\r\n(new Dotenv())->bootEnv(dirname(__DIR__).'/.env');\r\n$kernel = new Kernel((string) $_SERVER['APP_ENV'], (bool) $_SERVER['APP_DEBUG']);\r\n$kernel->boot();\r\n\r\n$factory = WorkerFactory::create();\r\n$worker = $factory->newWorker();\r\n\r\n/** @psalm-var BusinessProcessRegistry $registry */\r\n$registry = $kernel\r\n    ->getContainer()\r\n    ->get(BusinessProcessRegistry::class)\r\n;\r\n\r\nforeach ($registry->getWorkflowTypes() as $workflowType) {\r\n    $worker->registerWorkflowTypes($workflowType);\r\n}\r\n\r\nforeach ($registry->getActivityTypes() as $activityInstance) {\r\n    $worker->registerActivityImplementations($activityInstance);\r\n}\r\n\r\n$factory->run();\r\n```\r\n\r\nThe `BusinessProcessRegistry` class looks like this:\r\n```php\r\n<?php\r\n\r\ndeclare(strict_types=1);\r\n\r\nnamespace Application\\BusinessProcess;\r\n\r\nuse Generator;\r\nuse Spiral\\Tokenizer\\ClassLocator;\r\nuse Symfony\\Component\\Finder\\Finder;\r\n\r\nclass BusinessProcessRegistry\r\n{\r\n    public function __construct(\r\n        private string $projectDirectory,\r\n        private iterable $activityTypes,\r\n    )\r\n    {\r\n    }\r\n\r\n    /**\r\n     * @return Generator<class-string>\r\n     */\r\n    public function getWorkflowTypes(): Generator\r\n    {\r\n        $finder = Finder::create()\r\n            ->files()\r\n            ->name('*.php')\r\n            ->in($this->projectDirectory . '/src/Application/BusinessProcess')\r\n        ;\r\n\r\n        $locator = new ClassLocator($finder);\r\n\r\n        foreach ($locator->getClasses(BusinessProcessWorkflowInterface::class) as $class) {\r\n            if ($class->isAbstract() || $class->isInterface()) {\r\n                continue;\r\n            }\r\n\r\n            yield $class->getName();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * @return Generator<object>\r\n     */\r\n    public function getActivityTypes(): Generator\r\n    {\r\n        /** @var object $activity */\r\n        foreach ($this->activityTypes as $activity) {\r\n            yield $activity;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nInterfaces `BusinessProcessWorkflowInterface` and `BusinessProcessActivityInterface` are just dummy markers. Activities injected into constructor are Symfony services.\r\n\r\nFor testing I kickstart the workflow and then send signals to it:\r\n```php\r\n        $workflow = $this->workflowClient->newWorkflowStub(ZeroBalanceWorkflow::class,\r\n            WorkflowOptions::new()\r\n                ->withWorkflowId((string) 14069)\r\n                ->withWorkflowIdReusePolicy(IdReusePolicy::POLICY_ALLOW_DUPLICATE)\r\n        );\r\n        $this->workflowClient->startWithSignal($workflow, 'setBalance', [2], [14069]);\r\n        sleep(2);\r\n        $workflow->setBalance(0);\r\n        sleep(2);\r\n        $workflow->setBalance(8);\r\n```\r\n\r\nOnce it reaches the `continueAsNew`, things get messy. It tries to start process with FQDN class name:\r\n\r\n<img width=\"1512\" alt=\"2021-04-27_07-03-28\" src=\"https://user-images.githubusercontent.com/747947/116183816-4ea60b80-a727-11eb-9a4d-27e9ec557289.png\">\r\n\r\nWorker's log is full of errors about non-existent workflow:\r\n```log\r\n2021/04/27 03:09:36 WARN    temporal        Failed to process workflow task.    {\"Namespace\": \"default\", \"TaskQueue\": \"default\", \"WorkerID\": \"34106@Valentins-iMac.local@default@1\", \"WorkflowType\": \"Application\\\\BusinessProcess\\\\ZeroBalance\\\\ZeroBalanceWorkflow\", \"WorkflowID\": \"14069\", \"RunID\": \"e3b9ca91-6d80-449e-bfe4-46ba8f294ba9\", \"Attempt\": 70, \"Error\": \"unable to find workflow type: Application\\\\BusinessProcess\\\\ZeroBalance\\\\ZeroBalanceWorkflow. Supported types: [ZeroBalanceWorkflow]\"}\r\n2021/04/27 03:09:46 WARN    temporal        Failed to process workflow task.    {\"Namespace\": \"default\", \"TaskQueue\": \"default\", \"WorkerID\": \"34106@Valentins-iMac.local@default@1\", \"WorkflowType\": \"Application\\\\BusinessProcess\\\\ZeroBalance\\\\ZeroBalanceWorkflow\", \"WorkflowID\": \"14069\", \"RunID\": \"e3b9ca91-6d80-449e-bfe4-46ba8f294ba9\", \"Attempt\": 71, \"Error\": \"unable to find workflow type: Application\\\\BusinessProcess\\\\ZeroBalance\\\\ZeroBalanceWorkflow. Supported types: [ZeroBalanceWorkflow]\"}\r\n2021/04/27 03:09:56 WARN    temporal        Failed to process workflow task.    {\"Namespace\": \"default\", \"TaskQueue\": \"default\", \"WorkerID\": \"34106@Valentins-iMac.local@default@1\", \"WorkflowType\": \"Application\\\\BusinessProcess\\\\ZeroBalance\\\\ZeroBalanceWorkflow\", \"WorkflowID\": \"14069\", \"RunID\": \"e3b9ca91-6d80-449e-bfe4-46ba8f294ba9\", \"Attempt\": 72, \"Error\": \"unable to find workflow type: Application\\\\BusinessProcess\\\\ZeroBalance\\\\ZeroBalanceWorkflow. Supported types: [ZeroBalanceWorkflow]\"}\r\n```\r\n\r\nThe web UI was having seizures:\r\n\r\n![temporal-ui-seizures](https://user-images.githubusercontent.com/747947/116184447-72b61c80-a728-11eb-8878-a6b35bf167a3.gif)\r\n\r\nI had to kill the bad workflow instance using `tctl wf terminate`. It wasn't showing up in `tctl wf la` for some reason, good thing the run ID was present in worker's log.\r\n\r\n**Versions (please complete the following information where relevant):**\r\n - Temporal v1.8.1 running in Docker\r\n - PHP 8.0.1\r\n - Temporal PHP SDK v1.0.3\r\n - Symfony 5.2.x\r\n","closedAt":"2021-07-17T23:59:57Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDgyNzMxMzQ0NA==","author":{"login":"kozlice"},"authorAssociation":"NONE","body":"Update: found out that the problem was likely with usage of generator in `BusinessProcessRegistry::getWorkflowTypes`. Collecting and returning a list of class names instead of yielding them solves the problem:\r\n\r\n```php\r\n    /**\r\n     * @return list<class-string>\r\n     */\r\n    public function getWorkflowTypes(): iterable\r\n    {\r\n        $finder = Finder::create()\r\n            ->files()\r\n            ->name('*.php')\r\n            ->in($this->projectDirectory . '/src/Application/BusinessProcess')\r\n        ;\r\n\r\n        $locator = new ClassLocator($finder);\r\n\r\n        $types = [];\r\n\r\n        foreach ($locator->getClasses(BusinessProcessWorkflowInterface::class) as $class) {\r\n            if ($class->isAbstract() || $class->isInterface()) {\r\n                continue;\r\n            }\r\n\r\n            $types[] = $class->getName();\r\n        }\r\n\r\n        return $types;\r\n    }\r\n```","createdAt":"2021-04-27T05:01:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/108#issuecomment-827313444","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgyNzc0MTk5Mw==","author":{"login":"SerafimArts"},"authorAssociation":"CONTRIBUTOR","body":"> Update: found out that the problem was likely with usage of generator in BusinessProcessRegistry::getWorkflowTypes. Collecting and returning a list of class names instead of yielding them solves the problem:\r\n\r\nBut you then read the collection of classes anyway and register them in the worker? So replacing `yield` with an `array` should not affect the final result in `$worker`.\r\n","createdAt":"2021-04-27T16:26:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/108#issuecomment-827741993","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgyNzc5MzY1Mg==","author":{"login":"kozlice"},"authorAssociation":"NONE","body":"@SerafimArts that's correct. I've rolled back to generator solution and it still works fine. That's confusing, because I've made no other changes. Any ideas why this could happen?","createdAt":"2021-04-27T17:46:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/108#issuecomment-827793652","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM40keHi","author":{"login":"kozlice"},"authorAssociation":"NONE","body":"Can't reproduce this anymore with latest versions, so I'm closing this issue","createdAt":"2021-07-17T23:59:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/108#issuecomment-881975778","viewerDidAuthor":false}],"createdAt":"2021-04-27T04:20:32Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":108,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Workflow type is messed when using `continueAsNew`","updatedAt":"2021-07-17T23:59:58Z","url":"https://github.com/temporalio/sdk-php/issues/108"}
