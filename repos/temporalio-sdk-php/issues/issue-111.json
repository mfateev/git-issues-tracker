{"assignees":[],"author":{"id":"MDQ6VXNlcjU1MzYwNTE=","is_bot":false,"login":"Zylius","name":"Zigmas Satkeviƒçius"},"body":"I've a question regarding workflows. I know I'm asking a lot of questions, when I'll have some free time I'll try to propose some PRs for them!\r\n\r\nNow the question is: how do I inject something into a Workflow? I understand this could be a definite nono for temporal paradigm? Is it?\r\n\r\nIf not,  then, for example, currently we have our SAGA  (workflow) configs for each SAGA step (activity) in YAML files.\r\n\r\nIt's impossible to inject anything into the Workflow class. The constructor is always called without any arguments.\r\n\r\nShould I use activity to get this stuff from container? Kinda sounds like it shouldn't be an \"activity\" of a specific workflow either.\r\n\r\nHere's an example.\r\n\r\n```php\r\n#!/usr/bin/env php\r\n<?php\r\n\r\nuse Temporal\\Activity\\ActivityOptions;\r\nuse Temporal\\WorkerFactory;\r\nuse Temporal\\Workflow\\WorkflowInterface;\r\n\r\n$myConfigs = ['greet_timeout' => 30];\r\n\r\n#[WorkflowInterface]\r\nclass GreetingWorkflow\r\n{\r\n    private $greetingActivity;\r\n\r\n    public function __construct(array $timeouts = [])\r\n    {\r\n        $this->greetingActivity = Workflow::newActivityStub(\r\n            GreetingActivityInterface::class,\r\n            \r\n            // How to get this timeout setting ? \r\n            ActivityOptions::new()->withStartToCloseTimeout(\r\n                CarbonInterval::seconds($timeouts['greet_timeout'])\r\n            )\r\n        );\r\n    }\r\n\r\n    public function greet(string $name): \\Generator\r\n    {\r\n        return yield $this->greetingActivity->composeGreeting('Hello', $name);\r\n    }\r\n}\r\n\r\n$factory = WorkerFactory::create();\r\n$worker = $factory->newWorker();\r\n\r\n// How do I register the workflow and inject the constructor params?\r\n$worker->registerWorkflowTypes(GreetingWorkflow::class);\r\n\r\n$factory->run();\r\n```\r\n\r\n\r\n\r\n","closedAt":"2021-06-25T16:15:23Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg0ODMxMzY3NA==","author":{"login":"SerafimArts"},"authorAssociation":"CONTRIBUTOR","body":"Hello! We deliberately avoided the possibility of injecting any variables inside the Workflow, since changing these values can change the behavior of this Workflow, which will break absolutely the entire code.\r\n\r\nFor example:\r\n```php\r\n#[WorkflowInterface]\r\nclass GreetingWorkflow\r\n{\r\n    public function __construct(private Some $service) {}\r\n    \r\n    public function greet(string $name): \\Generator\r\n    {\r\n        if ($this->service->doSomething()) {\r\n            yield $this->greetingActivity->composeGreeting('Hello', $name);\r\n        }\r\n        \r\n        return yield $this->greetingActivity->composeGreeting('world', $name);\r\n    }\r\n}\r\n```\r\n\r\nIn this case, the argument is a reference to an external service dependency that may have side effects that will break the workflow execution.\r\n\r\nMoreover, when implementing the SDK, we focused on Java SDK, where there are no arguments for the workflow constructor.\r\n\r\nHowever, the example with your code looks quite convincing. So we need to think about how to solve your problem.","createdAt":"2021-05-25T22:35:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/111#issuecomment-848313674","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg0ODM0Njc2Mg==","author":{"login":"tsurdilo"},"authorAssociation":"MEMBER","body":"@Zylius \r\nas @SerafimArts mentioned, workflows must be deterministic, and you register the workflow type with the worker, not an instance.\r\n\r\nYou can achieve what you are looking for, I believe, with WorkflowClientInterface->startWithSignal (when you are starting your workflow execution, and not when you are registering your workflow with worker)\r\n\r\nstartWithSignal will start workflow execution (if no active ones is available) and send the signal on start. The data that you want to \"inject\" can be the signal data.\r\n\r\n","createdAt":"2021-05-25T23:47:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/111#issuecomment-848346762","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg0ODU3MDUxNg==","author":{"login":"Zylius"},"authorAssociation":"CONTRIBUTOR","body":"Hey, thanks guys! I wasn't aware of `startWithSignal` and Signal functionality. I'll try it out! \r\n\r\nSee what we're trying to do here, is generate temporal workflows (just like my past question about activities #110) from our legacy configuration. Now the example  you gave @SerafimArts, kinda got me a little worried. What I've been trying to avoid is generating \"stub\" php classes for workflows from our YAML files. But if that's what we have to do, I'll be willing to do it.\r\n\r\nUpdate concerning startWithSignal: lets say we have two services. ServiceA starts the workflow, and has its interface. ServiceB implements the workflow interface. ServiceA shouldn't be the one injecting `configuration` into ServiceB workflow, since ServiceB is the one responsible for it. So I don't think this will work in our case :/","createdAt":"2021-05-26T08:20:20Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/111#issuecomment-848570516","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg2ODY3NzA0Nw==","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"FYI, with **local activities**, you will be able to \"upload\" the workflow config via calling the activity. It will be deterministic since it will freeze the workflow state in history.  \r\n\r\n> Local Activities are planned in the 1.1 version of this SDK. In the meantime use classic activities.\r\n\r\nThis way workflow fully controls its config (i assume declarative DSL) and does not expose anything to the outside. This should solve your case without exposing anything.\r\n\r\n@tsurdilo I believe the community can greatly benefit from a simple example of how to convert legacy DSL workflows into temporal workflows.\r\n\r\n","createdAt":"2021-06-25T16:15:23Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/111#issuecomment-868677047","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg2ODY3ODE3NA==","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"Something like that:\r\n\r\n```php\r\npublic function workflowMethod(string $type) \r\n{\r\n     $yaml = yield $this->config->loadParsedConfig($type);\r\n\r\n     // do something with yaml, the workflow is not detached from your config file and even if you changes it - it will remain deterministic\r\n}\r\n```\r\n\r\nSo, in simple words, do the data DI via deterministic markers:\r\n\r\n1) Local Activity\r\n2) Activity\r\n3) Signal\r\n4) Also you can use side-effect if the file located withing the current filesystem, but be careful as it's blocking call","createdAt":"2021-06-25T16:17:08Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/111#issuecomment-868678174","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg2OTYxMTE0Mg==","author":{"login":"Zylius"},"authorAssociation":"CONTRIBUTOR","body":"Thank you very much! We've already done this and it works great. Kinda asked the question without fully understanding how temporal flow works. :bow: ","createdAt":"2021-06-28T11:38:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/111#issuecomment-869611142","viewerDidAuthor":false}],"createdAt":"2021-05-25T19:46:11Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTgw","name":"Feature","description":"New feature or request","color":"8e3cc4"},{"id":"MDU6TGFiZWwyMzM5NDMzMTkx","name":"Question","description":"Further information is requested","color":"0173a0"}],"milestone":null,"number":111,"reactionGroups":[],"state":"CLOSED","title":"[Question] Workflow DI","updatedAt":"2021-06-28T11:38:12Z","url":"https://github.com/temporalio/sdk-php/issues/111"}
