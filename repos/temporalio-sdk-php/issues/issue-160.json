{"assignees":[],"author":{"id":"MDQ6VXNlcjE3MjI4MjMx","is_bot":false,"login":"OlegKuro","name":"Khayatov Oleg"},"body":"### Workflow example to reproduce the bug:\r\n\r\n```\r\nclass ExampleWorkflow implements ExampleWorkflowInterface {\r\n\r\n    public function start(): string|\\Generator\r\n    {\r\n        $promises = [];\r\n\r\n        foreach (range(1, 20) as $i) {\r\n            $promises[] = Workflow::async(function () use ($i) {\r\n                yield Workflow::timer(random_int(5, 10));\r\n                $this->completedIds[] = $i;\r\n            });\r\n        }\r\n\r\n        Workflow::async(function () {\r\n            yield Workflow::timer(30);\r\n            $this->completedIds[] = 21;\r\n            $this->continue = true;\r\n        });\r\n\r\n        Workflow::await(\r\n            Promise::all($promises),\r\n            fn () => $this->continue,\r\n        );\r\n\r\n        return 'FINISHED';\r\n}\r\n```\r\n### Expected behavior:\r\nAfter 10 seconds of execution the workflow stops since the first clause (`Promise::all` is resolved)\r\n### Actual behavior:\r\nThe workflow never stops ðŸ˜¿ ","closedAt":"2022-04-18T07:39:41Z","comments":[{"id":"IC_kwDOEY5HBM5BjE3a","author":{"login":"OlegKuro"},"authorAssociation":"CONTRIBUTOR","body":"I've also tried following workaround:\r\n```\r\nclass ExampleWorkflow implements ExampleWorkflowInterface {\r\n\r\n    public function start(): string|\\Generator\r\n    {\r\n        $promises = [];\r\n\r\n        foreach (range(1, 20) as $i) {\r\n            $promises[] = Workflow::async(function () use ($i) {\r\n                yield Workflow::timer(random_int(5, 10));\r\n                $this->completedIds[] = $i;\r\n            });\r\n        }\r\n\r\n        Workflow::async(function () {\r\n            yield Workflow::timer(30);\r\n            $this->completedIds[] = 21;\r\n            $this->continue = true;\r\n        });\r\n\r\n        yield Promise::any([\r\n            Promise::all($promises),\r\n            Workflow::await(fn () => $this->continue),\r\n        ]);\r\n\r\n        return 'FINISHED';\r\n}\r\n```\r\n\r\nIt finishes the workflow. But only after `Workflow::await` clause resolution. But I expect to finish it after batch of promises completion.\r\n\r\nI've tried many other identical expressions (like `Workflow::await(Promise:all($promises));` instead of simple `Promise::all($promises);`), but nothing worked as I expected\r\n\r\nWhat I am trying to implement is the opportunity to stop batch of promises execution (via external workflow signal). In non-minimalist real code example these promises are allowed to never resolve at all.\r\n","createdAt":"2022-04-14T23:22:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/160#issuecomment-1099714010","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5BkTwh","author":{"login":"seregazhuk"},"authorAssociation":"CONTRIBUTOR","body":"Hi @OlegKuro! I think the problem is - missing `yield`s here. With `Workflow::await()` and `Workflow::await()` you just create promises. To actually execute the code inside you need to call `yield`. So, your first workflow can be rewritten this way:\r\n\r\n```php\r\nfinal class ExampleWorkflow\r\n{\r\n    private array $completedIds = [];\r\n    private bool $continue = false;\r\n\r\n    #[WorkflowMethod]\r\n    public function handle()\r\n    {\r\n        $promises = [];\r\n\r\n        foreach (range(1, 20) as $i) {\r\n            $promises[] = Workflow::async(function () use ($i) {\r\n                yield Workflow::timer(1);\r\n                $this->completedIds[] = $i;\r\n            });\r\n        }\r\n\r\n        yield Workflow::async(function () {\r\n            yield Workflow::timer(30);\r\n            $this->completedIds[] = 21;\r\n            $this->continue = true;\r\n        });\r\n\r\n        yield Workflow::await(\r\n            Promise::all($promises),\r\n            fn () => $this->continue,\r\n        );\r\n\r\n        return 'FINISHED';\r\n    }\r\n}\r\n```","createdAt":"2022-04-15T10:54:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/160#issuecomment-1100037153","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Bl4HM","author":{"login":"OlegKuro"},"authorAssociation":"CONTRIBUTOR","body":"Thank you for your reply! ðŸ¤— \r\n\r\nIndeed! It works if I use `yield` correctly. But it resolves after both Promise and Closure completion. What if I need to create a bunch of interruptable actions? ðŸ¤” \r\nIs there any way to implement following `main` function example using temporal capabilities?\r\n\r\n<details>\r\n<summary>JavaScript identical to what I am trying to implement snippet</summary>\r\nYou can merely paste it into a browser console and run `runAndThenInterrupt` and `runAndWaitForPromises` functions \r\n\r\n```\r\nlet doContinue = false;\r\n    \r\nfunction sleep(ms) {\r\n    return new Promise(resolve => {\r\n        setTimeout(() => resolve(), ms)\r\n    })\r\n}\r\n\r\nfunction sleepAndLog(ms, id) {\r\n    return sleep(ms).then(() => {\r\n        console.log(`${id} completed!`);\r\n    })\r\n}\r\n\r\nasync function main(interruptor) {\r\n    async function interruptor() {\r\n        return new Promise(resolve => {\r\n            let intervalId = setInterval(() => {\r\n                if (doContinue) {\r\n                    doContinue = false;\r\n                    console.log('interruption signal received!');\r\n                    clearInterval(intervalId);\r\n                    resolve();\r\n                }\r\n            }, 0);\r\n        })\r\n    }\r\n    promises = [sleepAndLog(1000, 1), sleepAndLog(500, 2), sleepAndLog(1500, 3)];\r\n\r\n    await Promise.any([\r\n        Promise.all(promises),\r\n        interruptor(),\r\n    ]);\r\n\r\n    console.log('promise any resolved!');\r\n}\r\n\r\nasync function runAndThenInterrupt() {\r\n    main();\r\n    await sleep(700);\r\n    doContinue = true;\r\n}\r\n\r\nfunction runAndWaitForPromises() {\r\n    main();\r\n}\r\n```\r\n\r\n</details>\r\n\r\nWhy [this](https://github.com/temporalio/sdk-php/issues/160#issuecomment-1099714010) example does not work as expected? ðŸ˜µ ","createdAt":"2022-04-15T22:34:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/160#issuecomment-1100448204","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5Bnj3t","author":{"login":"seregazhuk"},"authorAssociation":"CONTRIBUTOR","body":"[This](https://github.com/temporalio/sdk-php/issues/160#issuecomment-1099714010) your example you have a missing `yield` keyword before the second `Workflow::async`:\r\n\r\n```php\r\nyield Workflow::async(function () {\r\n    yield Workflow::timer(30);\r\n    $this->completedIds[] = 21;\r\n    $this->continue = true;\r\n});\r\n\r\nyield Promise::any([\r\n   Promise::all($promises),\r\n   Workflow::await(fn () => $this->continue),\r\n]);\r\n```","createdAt":"2022-04-17T14:25:40Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/160#issuecomment-1100889581","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM5BuzxB","author":{"login":"OlegKuro"},"authorAssociation":"CONTRIBUTOR","body":"Btw, I do not see `yield` before `Workflow::async` in [example](https://docs.temporal.io/docs/php/workflows#awaits) from documentation. Is it official way of using `Workflow::async` ðŸ¤” ? \r\n\r\nColuld you please explain why sometimes `Workflow::async` works without `yield` before it? \r\nFor example, If I create array of promises with help of `Workflow::async` and then wait for their resolution via` Promise::all `method, it works ðŸ¤¯ ","createdAt":"2022-04-19T15:26:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/160#issuecomment-1102789697","viewerDidAuthor":false}],"createdAt":"2022-04-14T23:10:29Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":160,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Workflow is always Running","updatedAt":"2022-04-19T15:26:02Z","url":"https://github.com/temporalio/sdk-php/issues/160"}
