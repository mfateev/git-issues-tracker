{"assignees":[{"id":"MDQ6VXNlcjQxNTI0ODE=","login":"roxblnfk","name":"Aleksei Gagarin","databaseId":0}],"author":{"id":"MDQ6VXNlcjE3MzUwOTc=","is_bot":false,"login":"Rastusik","name":"Martin Fris"},"body":"**Describe the bug**\r\nI have a parent workflow which creates some child workflows. When using custom namespace (registered properly in the workflow client) it isn't being propagated to the child worflows (or child workflow options), but it seems like it should be propagated according to this comment: https://github.com/temporalio/sdk-php/blob/master/src/Workflow/ChildWorkflowOptions.php#L44\r\n\r\n```\r\n/**\r\n     * Namespace of the child workflow.\r\n     *\r\n     * Optional: the current workflow (parent)'s namespace will be used if this\r\n     * is not provided.\r\n     */\r\n    #[Marshal(name: 'Namespace')]\r\n    public string $namespace = ClientOptions::DEFAULT_NAMESPACE;\r\n```\r\n\r\nIt also might be the case that I'm doing something wrong in my parent worflow.\r\n\r\n**To Reproduce**\r\n\r\nMy broken parent workflow looked like this:\r\n```php\r\nfinal class DefaultForkingWorkflow implements ForkingWorkflow\r\n{\r\n    public function fork(Event $event, HandlerDefinitions $definitions)\r\n    {\r\n        $promise = Workflow::async(static function () use ($event, $definitions) {\r\n            $promises = [];\r\n\r\n            foreach ($definitions as $definition) {\r\n                $options = ChildWorkflowOptions::new()\r\n                    ->withParentClosePolicy(ParentClosePolicy::POLICY_ABANDON)\r\n                    ->withSearchAttributes([\r\n                        SearchAttributes::ATTR_EVENT_ID => $event->getMetadata(Id::class)->toString(),\r\n                        SearchAttributes::ATTR_HANDLER_ID => $definition->getServiceId(),\r\n                        SearchAttributes::ATTR_HANDLER_METHOD => $definition->getHandlerMethod(),\r\n                    ]);\r\n                $handlerWorkflow = Workflow::newChildWorkflowStub(\r\n                    HandlerWorkflow::class,\r\n                    $options\r\n                );\r\n\r\n                $promises[] = Workflow::asyncDetached(\r\n                    static fn () => yield $handlerWorkflow->handle($event, $definition)\r\n                );\r\n            }\r\n\r\n            return yield Promise::all($promises);\r\n        });\r\n\r\n        try {\r\n            yield $promise;\r\n        } catch (TemporalException $e) {\r\n            //$logger->error('child workflow failed');\r\n            throw $e;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nWith this, temporal was logging this error: `Unable to schedule child execution across namespace default.` The error is correct because I changed the default namespace.\r\n\r\nTo make it work properly, I needed to propagate the namespace name from outside:\r\n\r\n```php\r\nfinal class DefaultForkingWorkflow implements ForkingWorkflow\r\n{\r\n    public function fork(Event $event, HandlerDefinitions $definitions, string $namespace)\r\n    {\r\n        $promise = Workflow::async(static function () use ($event, $definitions, $namespace) {\r\n            $promises = [];\r\n\r\n            foreach ($definitions as $definition) {\r\n                $options = ChildWorkflowOptions::new()\r\n                    ->withParentClosePolicy(ParentClosePolicy::POLICY_ABANDON)\r\n                    ->withNamespace($namespace)\r\n                    ->withSearchAttributes([\r\n                        SearchAttributes::ATTR_EVENT_ID => $event->getMetadata(Id::class)->toString(),\r\n                        SearchAttributes::ATTR_HANDLER_ID => $definition->getServiceId(),\r\n                        SearchAttributes::ATTR_HANDLER_METHOD => $definition->getHandlerMethod(),\r\n                    ]);\r\n                $handlerWorkflow = Workflow::newChildWorkflowStub(\r\n                    HandlerWorkflow::class,\r\n                    $options\r\n                );\r\n\r\n                $promises[] = Workflow::asyncDetached(\r\n                    static fn () => yield $handlerWorkflow->handle($event, $definition)\r\n                );\r\n            }\r\n\r\n            return yield Promise::all($promises);\r\n        });\r\n\r\n        try {\r\n            yield $promise;\r\n        } catch (TemporalException $e) {\r\n            //$logger->error('child workflow failed');\r\n            throw $e;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n**Expected behavior**\r\nI think there should be no explicit namespace propagation (at least according to the docblock comment in the ChildWorkflowOptions class).\r\n\r\n**Versions (please complete the following information where relevant):**\r\n - OS: Linux in Docker for mac\r\n - Temporal Version:  1.8.2\r\n - are you using Docker or Kubernetes or building Temporal from source? - nope, only when I need to dig for errors\r\n\r\n","closedAt":"2024-04-10T13:23:22Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDgyNjY5MjMxNQ==","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"@SerafimArts can you check the behavior against the Java SDK? We do transfer the **TaskQueue** but not the namespace at the moment.","createdAt":"2021-04-26T09:53:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/104#issuecomment-826692315","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM54uvrb","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"The fix for this issue needs to be revised.\r\nThe Namespace should be inherited even when the user has specified options for a ChildWorkflow that don't include a custom Namespace value.\r\n\r\nCurrently, to comfortably work with a custom namespace (such with Temporal Cloud), we must use an interceptor as follows:\r\n\r\n\r\n```php\r\nclass SetNamespaceInterceptor implements WorkflowOutboundRequestInterceptor\r\n{\r\n    public function handleOutboundRequest(RequestInterface $request, callable $next): PromiseInterface\r\n    {\r\n        (function () {\r\n            /** @var Request $this */\r\n            if (isset($this->options['options']['Namespace'])) {\r\n                $this->options['options']['Namespace'] = Workflow::getInfo()->namespace;\r\n            }\r\n        })->call($request);\r\n\r\n        return $next($request);\r\n    }\r\n}\r\n```","createdAt":"2024-03-28T15:37:33Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/104#issuecomment-2025519835","viewerDidAuthor":false}],"createdAt":"2021-04-22T11:42:30Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":11,"title":"2.9.0","description":"","dueOn":null},"number":104,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Namespace not being propagated into ChildWorflowOptions, but probably should be (according to comments)","updatedAt":"2024-04-10T13:23:23Z","url":"https://github.com/temporalio/sdk-php/issues/104"}
