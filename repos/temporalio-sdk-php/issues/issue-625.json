{"assignees":[],"author":{"id":"MDQ6VXNlcjc0NDY1MzQ=","is_bot":false,"login":"faim87","name":""},"body":"### Describe the bug\n\nWe recently discovered an interesting behavior related to cancelling a workflow with an active timer.\n\n1. A workflow with a 10-second timer is started.\n2. Another workflow is triggered that causes the worker to restart (due to a memory leak).\n3. We attempt to cancel the first workflow (while the worker is still down).\n\nIf the worker is restarted at the moment the cancellation request is made for a workflow with a timer, the timer does not get cancelled. In the Temporal UI, the following error appears:\n` Workflow Task Failed: BadCancelTimerAttributes: invalid history builder state for action: add-timer-canceled-event, TimerID: 5`\nAfter the worker restarts, the workflow with the timer remains in the Running state until the WorkflowExecutionTimeout is reached. This behavior seems incorrect.\nThe expected behavior would be for the cancellation attempt to be retried after the error, or for the entire workflow to fail with an error.\n\n### Environment/Versions\n\nTemporal: 1.26.2\n PHP: 8.2\n Roadrunner: 2024.3.5\n Symfony: 6.4\n temporal-sdk: 2.13.4\n\n### Minimal Reproduction\n\n**TimerWorkflow.php**\n\n```php\n<?php\n\ndeclare(strict_types=1);\n\nnamespace App\\Command\\MemoryLeak\\Workflow;\n\nuse Temporal\\DataConverter\\Type;\nuse Temporal\\Workflow;\nuse Temporal\\Workflow\\ReturnType;\nuse Temporal\\Workflow\\WorkflowInterface;\nuse Temporal\\Workflow\\WorkflowMethod;\n\n#[WorkflowInterface]\nfinal class TimerWorkflow\n{\n    #[WorkflowMethod('timer')]\n    #[ReturnType(Type::TYPE_STRING)]\n    public function expire(): \\Generator\n    {\n        yield Workflow::timer(10);\n\n        return yield 'Timer';\n    }\n}\n```\n\n**MemoryLeakWorkflow.php**\n\n```php\n<?php\n\ndeclare(strict_types=1);\n\nnamespace App\\Command\\MemoryLeak\\Workflow;\n\nuse Temporal\\DataConverter\\Type;\nuse Temporal\\Workflow\\ReturnType;\nuse Temporal\\Workflow\\WorkflowInterface;\nuse Temporal\\Workflow\\WorkflowMethod;\n\n#[WorkflowInterface]\nfinal class MemoryLeakWorkflow\n{\n    #[WorkflowMethod('memory-leak')]\n    #[ReturnType(Type::TYPE_STRING)]\n    public function create(): \\Generator\n    {\n        $arr = [];\n        while (true) {\n            $arr[] = 'test test test test test';\n        }\n\n        return yield 'memory-leak';\n    }\n}\n```\n\n**RunTimerCommand.php**\n\n```php\n<?php\n\ndeclare(strict_types=1);\n\nnamespace App\\Command\\MemoryLeak;\n\nuse App\\Command\\MemoryLeak\\Workflow\\MemoryLeakWorkflow;\nuse App\\Command\\MemoryLeak\\Workflow\\TimerWorkflow;\nuse Symfony\\Component\\Console\\Attribute\\AsCommand;\nuse Symfony\\Component\\Console\\Command\\Command;\nuse Symfony\\Component\\Console\\Input\\InputInterface;\nuse Symfony\\Component\\Console\\Output\\OutputInterface;\nuse Symfony\\Component\\Console\\Style\\SymfonyStyle;\nuse Temporal\\Client\\WorkflowClientInterface;\nuse Temporal\\Client\\WorkflowOptions;\nuse Temporal\\Common\\IdReusePolicy;\n\n#[AsCommand(name: 'dev:memory-leak-timer')]\nfinal class RunTimerCommand extends Command\n{\n    public function __construct(\n        private readonly WorkflowClientInterface $workflowClient,\n    ) {\n        parent::__construct();\n    }\n\n    protected function configure(): void {}\n\n    protected function execute(InputInterface $input, OutputInterface $output): int\n    {\n        $io = new SymfonyStyle($input, $output);\n\n        $workflow1 = $this->workflowClient->newWorkflowStub(\n            TimerWorkflow::class,\n            WorkflowOptions::new()\n                ->withWorkflowId('timer')\n                ->withTaskQueue('default')\n                ->withWorkflowIdReusePolicy(IdReusePolicy::AllowDuplicate)\n                ->withWorkflowRunTimeout(20)\n                ->withWorkflowExecutionTimeout(30),\n        );\n\n        $workflow2 = $this->workflowClient->newWorkflowStub(\n            MemoryLeakWorkflow::class,\n            WorkflowOptions::new()\n                ->withWorkflowId('memory-leak')\n                ->withTaskQueue('default')\n                ->withWorkflowIdReusePolicy(IdReusePolicy::AllowDuplicate)\n                ->withWorkflowRunTimeout(20)\n                ->withWorkflowExecutionTimeout(30),\n        );\n\n        $this->workflowClient->start($workflow1);\n        $io->success('Timer started');\n\n        $this->workflowClient->start($workflow2);\n        $io->success('MemoryLeak started');\n\n        $runningTimerWorkflow = $this->workflowClient->newUntypedRunningWorkflowStub('timer');\n        $runningTimerWorkflow->cancel();\n        $io->success('Timer canceled');\n\n        return Command::SUCCESS;\n    }\n}\n```\n\n","closedAt":"2025-07-21T13:50:09Z","comments":[{"id":"IC_kwDOEY5HBM6wbry7","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"Also reproduced on [RR v2024.1.5](https://github.com/roadrunner-server/roadrunner/releases/tag/v2024.1.5) (Jun 20, 2024), [SDK v2.10.3](https://github.com/temporalio/sdk-php/releases/tag/v2.10.3) (Jul 5, 2024), Tempora CLI: [v1.0.0](https://github.com/temporalio/cli/releases/tag/v1.0.0) (Aug 6, 2024).\n\n[reproduce.zip](https://github.com/user-attachments/files/20677099/reproduce.zip)","createdAt":"2025-06-10T17:18:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/625#issuecomment-2960047291","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM61dCLm","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"Should be fixed in the next RoadRunner release this Thursday","createdAt":"2025-07-07T10:04:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-php/issues/625#issuecomment-3044287206","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM64hV-B","author":{"login":"faim87"},"authorAssociation":"NONE","body":"@roxblnfk I just wanted to check if there are any updates regarding Roadrunner. It doesnâ€™t seem to have been updated yet.","createdAt":"2025-07-21T08:41:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/625#issuecomment-3095748481","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM64jOqi","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"Hi. The problem turned out to be a bit deeper, so we postponed the RR release. I hope to come back with good news soon.","createdAt":"2025-07-21T11:11:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/625#issuecomment-3096242850","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM67_eFf","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"@faim87 hi.\nDid the latest patch solve the problem 100%?","createdAt":"2025-08-05T07:55:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/625#issuecomment-3153977695","viewerDidAuthor":false}],"createdAt":"2025-06-05T07:59:21Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":38,"title":"2.15.1","description":"","dueOn":null},"number":625,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"[Bug] Incorrect timer cancellation when workflow worker is down","updatedAt":"2025-08-12T18:23:20Z","url":"https://github.com/temporalio/sdk-php/issues/625"}
