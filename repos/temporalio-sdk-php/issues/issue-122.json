{"assignees":[{"id":"MDQ6VXNlcjk5NTk3NjE=","login":"seregazhuk","name":"Sergey Zhuk","databaseId":0}],"author":{"id":"MDQ6VXNlcjE5NzQ3Mw==","is_bot":false,"login":"mixadior","name":"Diordienko Mykhail"},"body":"### Describe the bug\r\n\r\nmy workflow waits for some condition via yield Workflow::awaitWithTimeout , but after workflow \"restart\" via continueAsNewStub seems that condition never goes to true. Let me provide an example code. \r\n\r\n### To Reproduce\r\n\r\nbasic code used from https://github.com/wolfy-j/temporal-workshop\r\n\r\n```php\r\n\r\n<?php\r\n\r\nnamespace Workshop\\App\\Test;\r\n\r\nuse Temporal\\Activity\\ActivityOptions;\r\nuse Temporal\\Workflow;\r\nuse Temporal\\Workflow\\WorkflowMethod;\r\n\r\nclass Test2Workflow implements Test2WorkflowInterface {\r\n\r\n    private $photosBySourceEstateToProcess = [];\r\n    private $photosProcessActivity;\r\n\r\n    public function __construct()\r\n    {\r\n        $this->photosProcessActivity = Workflow::newActivityStub(\r\n            TestActivity::class,\r\n            ActivityOptions::new()->withStartToCloseTimeout(\\DateInterval::createFromDateString('30 seconds'))\r\n        );\r\n    }\r\n\r\n\r\n    public function run(array $initialPhotosToProcess = [])\r\n    {\r\n        if ($initialPhotosToProcess) {\r\n            $this->photosBySourceEstateToProcess = $initialPhotosToProcess;\r\n        }\r\n\r\n        file_put_contents(\"php://stderr\",\"startttt \".count($this->photosBySourceEstateToProcess));\r\n\r\n        yield Workflow::awaitWithTimeout(300, fn()=> (count($this->photosBySourceEstateToProcess) > 10) || (count($initialPhotosToProcess) > 10));\r\n        $photosToProcess = array_splice($this->photosBySourceEstateToProcess, 0, 10);\r\n\r\n        foreach ($photosToProcess as $processData) {\r\n            $processData = (array) $processData;\r\n            yield $this->photosProcessActivity->loadSePhotos($processData['id'], $processData['photos'], $processData['withPage']);\r\n        }\r\n\r\n        return Workflow::newContinueAsNewStub(self::class)->run( $this->photosBySourceEstateToProcess);\r\n    }\r\n    #[Workflow\\SignalMethod]\r\n    public function setSourceEstatePhotos(int $sourceEstateId, $photos = [], $withPage = false)\r\n    {\r\n        $this->photosBySourceEstateToProcess[] = ['id' => $sourceEstateId, 'photos' => $photos, 'withPage' => $withPage];\r\n    }\r\n\r\n    #[Workflow\\QueryMethod]\r\n    public function getSourceEstatePhotos(): array\r\n    {\r\n        return $this->photosBySourceEstateToProcess;\r\n    }\r\n}\r\n\r\n```\r\n\r\nactivity code\r\n\r\n```php\r\n\r\n<?php\r\n\r\nnamespace Workshop\\App\\Test;\r\n\r\nclass TestActivity implements TestActivityInterface {\r\n\r\n    public function hello(string $name): string\r\n    {\r\n        return sprintf(\"Hello, %s\", $name);\r\n    }\r\n\r\n    public function loadSePhotos(int $sourceEstateId, array $photos, bool $withPage): string\r\n    {\r\n        $rayId = uniqid(\"v\");\r\n        file_put_contents(\"php://stderr\", sprintf(\"%s, Working on.Load se #%d photos. Photos: %s\", $rayId, $sourceEstateId, join(\",\", $photos)));\r\n        sleep(1);\r\n        file_put_contents(\"php://stderr\", sprintf(\"%s, done\", $rayId));\r\n        return \"yes\";\r\n    }\r\n}\r\n\r\n```\r\n\r\ncommand used to start workflow:\r\n\r\n```php\r\n\r\n<?php\r\n\r\nnamespace Workshop\\App\\Test;\r\n\r\nuse Symfony\\Component\\Console\\Input\\InputInterface;\r\nuse Symfony\\Component\\Console\\Output\\OutputInterface;\r\nuse Workshop\\Util\\Command;\r\n\r\nclass Test4Command extends Command {\r\n    protected const NAME = 'run_source_photos';\r\n\r\n    public function execute(InputInterface $input, OutputInterface $output)\r\n    {\r\n        try {\r\n            $workflow = $this->workflowClient->newWorkflowStub(Test2Workflow::class);\r\n            $d = $this->workflowClient->start($workflow);\r\n\r\n\r\n            $output->writeln(sprintf(\"Id: %s\", $d->getExecution()->getID()));\r\n        } catch (\\Throwable $ex) {\r\n            $output->writeln($ex->getTraceAsString());\r\n        }\r\n        return 0;\r\n    }\r\n}\r\n\r\n```\r\n\r\ncommand used to send signals:\r\n\r\n```php\r\n\r\n<?php\r\n\r\nnamespace Workshop\\App\\Test;\r\n\r\nuse Symfony\\Component\\Console\\Input\\InputInterface;\r\nuse Symfony\\Component\\Console\\Output\\OutputInterface;\r\nuse Workshop\\Util\\Command;\r\n\r\nclass Test3Command extends Command {\r\n    protected const NAME = 'push_photos';\r\n    protected const ARGUMENTS = [\r\n        ['name' => 'wfId']\r\n    ];\r\n\r\n    public function execute(InputInterface $input, OutputInterface $output)\r\n    {\r\n        try {\r\n            $wf = $this->workflowClient->newRunningWorkflowStub(Test2Workflow::class, $input->getArgument('wfId'));\r\n\r\n            for ($i = 0;$i < 30;$i++) {\r\n                $wf->setSourceEstatePhotos($i, [\"1.jpg\", \"2.jpg\", \"3.jpg\"]);\r\n            }\r\n\r\n        } catch (\\Throwable $ex) {\r\n            $output->writeln($ex->getMessage());\r\n            $output->writeln($ex->getTraceAsString());\r\n        }\r\n        return 0;\r\n    }\r\n}\r\n\r\n```\r\n\r\nso first i execute\r\n\r\n```sh\r\n\r\nphp ./app.php run_source_photos\r\n\r\n```\r\n\r\nget an workflow id and run \r\n\r\n```sh\r\n\r\nphp ./app.php push_photos %workflow_id%\r\n\r\n```\r\n\r\n### Expected behavior\r\n\r\nthat right after processing of first 10 elements and workflow restart it will start next workflow and `yield Workflow::awaitWithTimeout` wouldn't wait for timeout, because condition will return true. \r\n\r\n### Screenshots/Terminal output\r\n\r\n![](http://feodosian.com/public/mc_mixadiorMacBook-Pro-3.localVolumesWorkspaceprojectstemporal-workshop_2021-08-18_20-34-12.png)\r\n\r\n### Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS: Linux (docker)\r\n- Temporal Version: 1.9.0\r\n- docker-compose - https://github.com/temporalio/docker-compose\r\n\r\n### Additional context\r\n\r\n.rr.yaml\r\n\r\n```yaml\r\n\r\nrpc:\r\n  listen: tcp://127.0.0.1:6001\r\n\r\nserver:\r\n  command: \"php worker.php\"\r\n  env:\r\n    XDEBUG_SESSION: 1\r\n    XDEBUG_CONFIG: idekey=PHPSTORM\r\n    PHP_IDE_CONFIG: serverName=temporalphp\r\n    \r\n\r\nlogs:\r\n  level: info\r\n  channels:\r\n    informer.mode: none\r\n\r\ntemporal:\r\n  address: host.docker.internal:7233\r\n  activities:\r\n    debug: false\r\n    num_workers: 8\r\n\r\nhttp:\r\n  address: 127.0.0.1:8080\r\n  pool:\r\n    num_workers: 8\r\n\r\n\r\n```\r\n","closedAt":"2021-12-08T11:13:42Z","comments":[{"id":"IC_kwDOEY5HBM42d06f","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"That you for the report. Added to the pipeline.","createdAt":"2021-09-06T17:43:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/122#issuecomment-913788575","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM467q1A","author":{"login":"wolfy-j"},"authorAssociation":"COLLABORATOR","body":"This issue has been addressed in 1.0.5","createdAt":"2021-12-08T11:13:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/122#issuecomment-988720448","viewerDidAuthor":false}],"createdAt":"2021-08-18T17:38:55Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"},{"id":"MDU6TGFiZWwyMzM5NDMzMTkx","name":"Question","description":"Further information is requested","color":"0173a0"}],"milestone":null,"number":122,"reactionGroups":[],"state":"CLOSED","title":"[Bug] After countinueAsNew awaitWithTimeout doesn't check for condition","updatedAt":"2021-12-08T11:13:42Z","url":"https://github.com/temporalio/sdk-php/issues/122"}
