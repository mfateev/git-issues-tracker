{"assignees":[],"author":{"id":"MDQ6VXNlcjc3MzQ4MQ==","is_bot":false,"login":"butschster","name":"Pavel Buchnev"},"body":"I encountered an error due to the Doctrine Annotations library being unable to interpret the \"@mixin\" annotation in the `Carbon\\Carbon` class.\r\n\r\n```\r\nDoctrine\\\\Common\\\\Annotations\\\\AnnotationException: [Semantical Error] \r\nThe annotation \\\"@mixin\\\" in class Carbon\\\\Carbon was never imported. Did you maybe forget to add a \\\"use\\\" statement for this annotation? in /xxx/vendor/doctrine/annotations/lib/Doctrine/Common/Annotations/AnnotationException.php:36\r\n\r\nStack trace:\r\n#0 /xxx/vendor/doctrine/annotations/lib/Doctrine/Common/Annotations/DocParser.php(790): Doctrine\\\\Common\\\\Annotations\\\\AnnotationException::semanticalError('The annotation ...')\r\n#1 /xxx/vendor/doctrine/annotations/lib/Doctrine/Common/Annotations/DocParser.php(712): Doctrine\\\\Common\\\\Annotations\\\\DocParser->Annotation()\r\n#2 /xxx/vendor/doctrine/annotations/lib/Doctrine/Common/Annotations/DocParser.php(368): Doctrine\\\\Common\\\\Annotations\\\\DocParser->Annotations()\r\n#3 /xxx/vendor/doctrine/annotations/lib/Doctrine/Common/Annotations/AnnotationReader.php(142): Doctrine\\\\Common\\\\Annotations\\\\DocParser->parse('/**\\\\n * A simple...', 'class Carbon\\\\\\\\Ca...')\r\n#4 /xxx/vendor/spiral/attributes/src/Internal/DoctrineAnnotationReader.php(29): Doctrine\\\\Common\\\\Annotations\\\\AnnotationReader->getClassAnnotations(Object(ReflectionClass))\r\n#5 /xxx/vendor/spiral/attributes/src/Internal/DoctrineAnnotationReader.php(74): Spiral\\\\Attributes\\\\Internal\\\\DoctrineAnnotationReader->Spiral\\\\Attributes\\\\Internal\\\\{closure}()\r\n#6 /xxx/vendor/spiral/attributes/src/Internal/DoctrineAnnotationReader.php(29): Spiral\\\\Attributes\\\\Internal\\\\DoctrineAnnotationReader->wrapDoctrineExceptions(Object(Closure))\r\n#7 [internal function]: Spiral\\\\Attributes\\\\Internal\\\\DoctrineAnnotationReader->getClassMetadata(Object(ReflectionClass), 'Temporal\\\\\\\\Intern...')\r\n#8 /xxx/vendor/spiral/attributes/src/Composite/Composite.php(69): iterator_to_array(Object(Generator), false)\r\n#9 /xxx/vendor/spiral/attributes/src/Composite/SelectiveReader.php(12): Spiral\\\\Attributes\\\\Composite\\\\Composite->iterableToArray(Object(Generator))\r\n#10 /xxx/vendor/spiral/attributes/src/Composite/Composite.php(27): Spiral\\\\Attributes\\\\Composite\\\\SelectiveReader->each(Object(Closure))\r\n#11 /xxx/vendor/spiral/attributes/src/Reader.php(11): Spiral\\\\Attributes\\\\Composite\\\\Composite->getClassMetadata(Object(ReflectionClass), 'Temporal\\\\\\\\Intern...')\r\n#12 /xxx/vendor/temporal/sdk/src/Internal/Marshaller/Mapper/AttributeMapper.php(108): Spiral\\\\Attributes\\\\Reader->firstClassMetadata(Object(ReflectionClass), 'Temporal\\\\\\\\Intern...')\r\n#13 /xxx/vendor/temporal/sdk/src/Internal/Marshaller/Mapper/AttributeMapper.php(68): Temporal\\\\Internal\\\\Marshaller\\\\Mapper\\\\AttributeMapper->getScope()\r\n#14 /xxx/vendor/temporal/sdk/src/Internal/Marshaller/Mapper/AttributeMapperFactory.php(37): Temporal\\\\Internal\\\\Marshaller\\\\Mapper\\\\AttributeMapper->__construct(Object(ReflectionClass), Object(Temporal\\\\Internal\\\\Marshaller\\\\TypeFactory), Object(Spiral\\\\Attributes\\\\Composite\\\\SelectiveReader))\r\n#15 /xxx/vendor/temporal/sdk/src/Internal/Marshaller/Marshaller.php(113): Temporal\\\\Internal\\\\Marshaller\\\\Mapper\\\\AttributeMapperFactory->create(Object(ReflectionClass), Object(Temporal\\\\Internal\\\\Marshaller\\\\TypeFactory))\r\n```\r\n\r\n**The error trace led me to the following files and lines of code in the sdk:**\r\n\r\nhttps://github.com/temporalio/sdk-php/blob/master/src/DataConverter/JsonConverter.php#L238\r\n\r\nThe issue seems to arise from this piece of code:\r\n\r\n\r\n```php\r\nif (\\interface_exists(Reader::class)) {\r\n    return new SelectiveReader([new AnnotationReader(), new AttributeReader()]);\r\n}\r\n\r\nreturn new AttributeReader();\r\n```\r\n\r\nHere, if the `Doctrine\\Common\\Annotations\\Reader` class exists in the system, the `SelectiveReader` is utilized. This causes potential compatibility issues with Doctrine annotations, especially if they are not meant to be handled by the `AnnotationReader`.\r\n\r\nAnd the same code is in the following classes:\r\n\r\n- https://github.com/temporalio/sdk-php/blob/master/src/WorkerFactory.php#L301\r\n- https://github.com/temporalio/sdk-php/blob/master/src/Client/WorkflowClient.php#L350\r\n- https://github.com/temporalio/sdk-php/blob/master/src/DataConverter/JsonConverter.php#L238\r\n\r\n**Suggested Fix:**\r\n\r\n- Offer an option or configuration to disable the use of SelectiveReader.\r\n- Refactor the SDK to have a central point or method to generate readers, ensuring consistent behavior across classes and easier maintainability.\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","closedAt":"2024-07-01T16:02:36Z","comments":[{"id":"IC_kwDOEY5HBM6DKYMr","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"Looks like fixed with https://github.com/spiral/attributes/pull/16","createdAt":"2024-07-01T16:02:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/352#issuecomment-2200535851","viewerDidAuthor":false}],"createdAt":"2023-09-07T09:55:32Z","labels":[{"id":"MDU6TGFiZWw0MDMxNTY5NTYw","name":"enhancement","description":"","color":"a2eeef"}],"milestone":null,"number":352,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Issue with Doctrine Annotation Reader and Need to Disable SelectiveReader`","updatedAt":"2024-07-01T16:02:37Z","url":"https://github.com/temporalio/sdk-php/issues/352"}
