{"assignees":[],"author":{"id":"MDQ6VXNlcjU1MzYwNTE=","is_bot":false,"login":"Zylius","name":"Zigmas Satkeviƒçius"},"body":"### What are you really trying to do?\r\n\r\nI'm trying to launch a batch of activity in async, each activity is wrapped in code which handles it's response, and it should be executed async as well. \r\n\r\n### Describe the bug\r\n\r\nIn `temporal/sdk ^2` if I throw an exception, the workflow quits the scope of the async batch immediately and continues on with the workflow. Which causes \"UnhandledCommand\" errors in the workflow later on, cause the remaining async requests get done AFTER the workflow finishes.\r\n\r\nIn `temporal/sdk ^1` the workflow waits on the batch, even if exception is thrown.\r\n\r\n\r\n### Minimal Reproduction\r\n\r\nWorkflow:\r\n```php\r\n<?php\r\n\r\nuse Temporal\\Activity\\ActivityOptions;\r\nuse Temporal\\Promise;\r\nuse Temporal\\Workflow;\r\nuse Temporal\\Workflow\\WorkflowInterface;\r\nuse Temporal\\Workflow\\WorkflowMethod;\r\n\r\n#[WorkflowInterface]\r\nclass TestWorkflow\r\n{\r\n    #[WorkflowMethod]\r\n    public function TestWorkflow()\r\n    {\r\n       $promise = Workflow::async(function() {\r\n          $first = Workflow::async(fn() => $this->executeAnActivityComplicated('failure'));\r\n          $second = Workflow::async(fn() => $this->executeAnActivityComplicated('success'));\r\n          $third = Workflow::async(fn() => $this->executeAnActivityComplicated('failure'));\r\n\r\n\r\n           return yield Promise::all([$first, $second, $third]);\r\n        });\r\n\r\n       yield $promise;\r\n    }\r\n\r\n    private function executeAnActivityComplicated(string $activityName)\r\n    {\r\n        $result = yield Workflow::executeActivity($activityName, [], ActivityOptions::new()->withTaskQueue('test_queue')->withStartToCloseTimeout(20));\r\n\r\n        if ($result == 'failure') {\r\n            throw new \\InvalidArgumentException(\"test\");\r\n        }\r\n\r\n        return $result;\r\n    }\r\n}\r\n```\r\n\r\nActivity:\r\n\r\n```php\r\n<?php\r\n\r\nuse Temporal\\Activity\\ActivityInterface;\r\nuse Temporal\\Activity\\ActivityMethod;\r\n\r\n#[ActivityInterface]\r\nclass TestActivity\r\n{\r\n    #[ActivityMethod]\r\n    public function failure()\r\n    {\r\n        return 'failure';\r\n    }\r\n\r\n    #[ActivityMethod]\r\n    public function success()\r\n    {\r\n        return 'success';\r\n    }\r\n\r\n}\r\n```\r\n\r\n### Environment/Versions\r\n\r\n- Ubuntu 22.04\r\n- Temporal Version: 1.14\r\n- Docker, RR version: 2.11.4, SDK version 2.2.1\r\n\r\n### Additional context\r\n\r\nHere's the result with `temporal/sdk ^2` (bad)\r\n![image](https://user-images.githubusercontent.com/5536051/196927945-6fd9e977-f9d1-4386-9136-03358720c526.png)\r\n\r\nHere's the result with `temporal/sdk ^1` (good)\r\n![image](https://user-images.githubusercontent.com/5536051/196928189-3d995839-fed8-4549-8f76-9a309f80a651.png)\r\n\r\n\r\nMaybe this isn't even a bug? Maybe I can write the code somehow differently to achieve the result in `temporal/sdk ^1`. If it is a bug, I'm willing to fix it myself, but some first-points-to-look-at would be nice ;)\r\n\r\n\r\n","closedAt":"2022-10-20T15:47:19Z","comments":[{"id":"IC_kwDOEY5HBM5Mo4ML","author":{"login":"Zylius"},"authorAssociation":"CONTRIBUTOR","body":"Not a bug, discussed this with @wolfy-j. Should handle the exception inside the scope if you want the batch to be completed.","createdAt":"2022-10-20T15:47:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/260#issuecomment-1285784331","viewerDidAuthor":false}],"createdAt":"2022-10-20T10:48:31Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":260,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Async batch gets cancelled upon Exception thrown.","updatedAt":"2022-10-20T15:47:19Z","url":"https://github.com/temporalio/sdk-php/issues/260"}
