{"assignees":[{"id":"MDQ6VXNlcjQxNTI0ODE=","login":"roxblnfk","name":"Aleksei Gagarin","databaseId":0}],"author":{"id":"U_kgDOC0lMDQ","is_bot":false,"login":"IhorBerestPaybis","name":""},"body":"### What are you really trying to do?\r\n\r\nI want to structure workflows in an easy-to-read and understandable manner, especially when the workflow's code is long enough. At my company, we have found that it is easier when we move the part of code that is related to the same action, or part of the flow (activity calls, timers, if statements) into a private function inside the workflow code. Thus we create private methods inside workflow classes that return Generators (simply because of the yield inside that method)\r\n\r\n\r\n\r\n### Describe the bug\r\n\r\nWhen an exception is thrown in the generator it returns null instead of throwing that exception in the outer scope, which results in proceeding workflow execution instead of immediate cancel of workflow. See comparison below\r\n\r\n### Minimal Reproduction\r\nWorkflow code\r\n``` php\r\n<?php\r\n\r\ndeclare(strict_types=1);\r\n\r\nnamespace App\\Workflow\\Test;\r\n\r\nuse Carbon\\CarbonInterval;\r\nuse Temporal\\Activity\\ActivityOptions;\r\nuse Temporal\\Workflow;\r\nuse Temporal\\Workflow\\WorkflowInterface;\r\nuse Temporal\\Workflow\\WorkflowMethod;\r\n\r\n#[WorkflowInterface]\r\nclass TestWorkflow\r\n{\r\n\r\n    private Workflow\\ActivityStubInterface $activity;\r\n\r\n    public function __construct()\r\n    {\r\n        $defaultActivityOptions = ActivityOptions::new()\r\n            ->withStartToCloseTimeout(CarbonInterval::seconds(45))\r\n            ->withTaskQueue('default')\r\n        ;\r\n\r\n        $this->activity = Workflow::newUntypedActivityStub($defaultActivityOptions);\r\n    }\r\n\r\n    #[WorkflowMethod]\r\n    public function execute(): \\Generator\r\n    {\r\n        var_dump(yield $this->doSomething());\r\n        echo \"Execution is processed\\n\";\r\n    }\r\n\r\n    private function doSomething(): \\Generator\r\n    {\r\n        yield $this->activity->execute('execute');\r\n    }\r\n}\r\n```\r\n\r\nActivity code\r\n``` php\r\n<?php\r\n\r\ndeclare(strict_types=1);\r\n\r\nnamespace App\\Workflow\\Test;\r\n\r\nuse Temporal\\Activity\\ActivityInterface;\r\nuse Temporal\\Activity\\ActivityMethod;\r\n\r\n#[ActivityInterface]\r\nclass TestActivity\r\n{\r\n    #[ActivityMethod]\r\n    public function execute(): void\r\n    {\r\n        throw new \\Exception(\"error\");\r\n    }\r\n}\r\n```\r\nBy running the example above we get the workflow in completed status, even though the activity has been canceled. And the `doSomething` method returns null\r\n<img width=\"1094\" alt=\"image\" src=\"https://github.com/user-attachments/assets/e0a17bc5-7d0d-47cd-8e93-ee1d91f41c95\">\r\n<img width=\"642\" alt=\"image\" src=\"https://github.com/user-attachments/assets/207fe73e-553d-4fb3-a725-81fbe9bacfa9\">\r\n\r\n\r\nIf we modify the workflow and move the activity execution from the private method into workflow method it works as expected and workflow finishes in canceled status\r\n``` php\r\n<?php\r\n\r\ndeclare(strict_types=1);\r\n\r\nnamespace App\\Workflow\\Test;\r\n\r\nuse Carbon\\CarbonInterval;\r\nuse Temporal\\Activity\\ActivityOptions;\r\nuse Temporal\\Workflow;\r\nuse Temporal\\Workflow\\WorkflowInterface;\r\nuse Temporal\\Workflow\\WorkflowMethod;\r\n\r\n#[WorkflowInterface]\r\nclass TestWorkflow\r\n{\r\n\r\n    private Workflow\\ActivityStubInterface $activity;\r\n\r\n    public function __construct()\r\n    {\r\n        $defaultActivityOptions = ActivityOptions::new()\r\n            ->withStartToCloseTimeout(CarbonInterval::seconds(45))\r\n            ->withTaskQueue('default')\r\n        ;\r\n\r\n        $this->activity = Workflow::newUntypedActivityStub($defaultActivityOptions);\r\n    }\r\n\r\n    #[WorkflowMethod]\r\n    public function execute(): \\Generator\r\n    {\r\n       yield $this->activity->execute('execute');\r\n        echo \"Execution is processed\\n\";\r\n    }\r\n}\r\n```\r\n<img width=\"1088\" alt=\"image\" src=\"https://github.com/user-attachments/assets/a86a526c-9f19-4452-b35e-43e7f331c315\">\r\n\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: Linux, Mac  \r\n- Temporal Version: minimal SDK version the issues has been found is 2.11.0, before works as expected\r\n- Using docker\r\n\r\n### Additional context\r\nNo additional context\r\n","closedAt":"2024-12-17T18:30:43Z","comments":[{"id":"IC_kwDOEY5HBM6U46i2","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"Hello. Thank you for creating this issue.\r\n\r\nLet me point out that you can achieve the desired behavior using the `yield from` construct:\r\n```php\r\nyield from $this->doSomething()\r\n```\r\nHowever, you won't be able to use this to obtain a result from the generator.\r\n\r\nI also believe that we should receive an exception in the execution flow if it occurs in the yielded generator. I will discuss with the team whether the current behavior is intended.","createdAt":"2024-11-25T12:55:07Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-php/issues/530#issuecomment-2497947830","viewerDidAuthor":false},{"id":"IC_kwDOEY5HBM6U5LTZ","author":{"login":"IhorBerestPaybis"},"authorAssociation":"NONE","body":"Hello, thank you for the tip.\r\n\r\nAs you said, we aren't able to obtain a result, and that's our problem, I am afraid.\r\nHowever, we have found another solution.\r\n\r\nWe simply wrapped the generator code in `try/catch` clause and returned the `Promise::reject` object when catching a Throwable.\r\n\r\n``` PHP\r\nprivate function doSomething(): \\Generator\r\n{\r\n    try {\r\n        yield $this->activity->execute('execute');\r\n    } catch (\\Throwable $exception) {\r\n        return Promise::reject($exception);\r\n    }\r\n}\r\n```\r\n\r\nBut wrapping every generator method in try/catch clause isn't the best-looking long-term solution.","createdAt":"2024-11-25T13:24:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-php/issues/530#issuecomment-2498016473","viewerDidAuthor":false}],"createdAt":"2024-11-25T12:37:33Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":26,"title":"2.11.4","description":"","dueOn":null},"number":530,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Generators return null when exception is thrown","updatedAt":"2024-12-17T18:30:43Z","url":"https://github.com/temporalio/sdk-php/issues/530"}
