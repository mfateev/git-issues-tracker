{"assignees":[{"id":"MDQ6VXNlcjk5NTk3NjE=","login":"seregazhuk","name":"Sergey Zhuk","databaseId":0}],"author":{"id":"MDQ6VXNlcjk5NTk3NjE=","is_bot":false,"login":"seregazhuk","name":"Sergey Zhuk"},"body":"### What are you really trying to do?\r\n\r\nCreate a coroutine with several tasks and then cancel them.\r\n\r\n### Describe the bug\r\n\r\nHave a coroutine with local and server tasks: 2 asyncs and 1 awaitWithTimeout:\r\n\r\n```php\r\n$mainFlow = Workflow::async(\r\n    function (): \\Generator {\r\n        yield Workflow::async(function () {\r\n            echo 'DEBUG: before';\r\n        });\r\n        yield Workflow::awaitWithTimeout(999, fn() => false);\r\n        yield Workflow::async(function () {\r\n            echo 'DEBUG: after';\r\n        });\r\n    }\r\n);\r\n\r\n$mainFlow->cancel();\r\n```\r\n\r\nWhen trying to cancel it, I expect the last `echo 'DEBUG: after';`, because the code should freeze with the timer. But once the timer is cancelled the last `async` is called. If I replace `awaitWithTimeout()` with `await()` everything works as expected:\r\n\r\n```php\r\n$promise = Workflow::async(\r\n    function (): \\Generator {\r\n        yield Workflow::async(fn () => $this->result[] = 'before');\r\n        yield Workflow::await(999, fn() => false);\r\n        yield Workflow::async(fn () => $this->result[] = 'after');\r\n    }\r\n);\r\n\r\n$promise->cancel();\r\n```\r\n\r\n### Additional context\r\n\r\nAs I see the problem is when we restore the context after the cancelTimer call. Even is the last `async` is cancelled we return to it. Before entering the coroutine we should check whether it is cancelled or not.\r\n","closedAt":"2022-06-16T10:15:19Z","comments":[],"createdAt":"2022-06-16T04:21:02Z","labels":[{"id":"MDU6TGFiZWwyMzM5NDMzMTc0","name":"Bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":192,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Timeout continues with cancelled tasks","updatedAt":"2022-06-16T10:15:19Z","url":"https://github.com/temporalio/sdk-php/issues/192"}
