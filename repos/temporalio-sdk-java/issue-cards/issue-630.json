{
  "summary": "Test `testShouldReturnQueryResultAfterWorkflowTimeout` is flaky and fails with 'Unknown query type' error when querying a workflow after it times out. The root cause is that query handlers are not reinitialized during workflow replay after a timeout, leaving the QueryDispatcher empty.",
  "category": "bug",
  "subcategory": "workflow-replay",
  "apis": [
    "query"
  ],
  "components": [
    "QueryDispatcher",
    "ReplayWorkflowExecutor",
    "WorkflowTaskStateMachine",
    "TestWorkflowEnvironmentInternal"
  ],
  "concepts": [
    "timeout",
    "replay",
    "query-handler",
    "event-loop",
    "state-machine",
    "flaky-test"
  ],
  "severity": "medium",
  "userImpact": "Users cannot query workflows after they timeout, and tests for this behavior are unreliable and difficult to reproduce.",
  "rootCause": "When workflow task times out and history is replayed, a new QueryDispatcher is created without query handlers. The event loop is not triggered during replay, preventing workflow from reinitializing query handlers.",
  "proposedFix": "Trigger event loop during replay to reinitialize query handlers, or move query handler initialization earlier so it executes during replay phase.",
  "workaround": null,
  "resolution": null,
  "resolutionDetails": null,
  "related": [
    391,
    531
  ],
  "keyQuote": "It creates a brand new QueryDispatcher object that doesn't have query handlers by default, and because we never run event loop during replay workflow doesn't get a chance to initialize query handlers again.",
  "number": 630,
  "repo": "temporalio-sdk-java",
  "generatedAt": "2026-01-11T18:30:16.784Z"
}