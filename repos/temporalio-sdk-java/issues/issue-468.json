{"assignees":[],"author":{"id":"MDQ6VXNlcjM3MjE0MQ==","is_bot":false,"login":"skrul","name":"Steve Krulewitz"},"body":"## Expected Behavior\r\n\r\nWe were putting some custom serialization / deserialization in place to handle our workflow/activity arguments and noticed that the DataConverter (including our custom one). Expected behavior was that this change would only apply to the workflow/activity arguments.\r\n\r\n## Actual Behavior\r\n\r\nThis change also applies to the to the custom search attributes that are set on the workflow options, which would cause errors when these encoded values were being sent to ElasticSearch.\r\n\r\nThe workaround we are using is to be more selective on which class types we apply the custom data converter to and we make sure that the primitive java types use the default converter. \r\n\r\n\r\n## Specifications\r\n\r\n  - Version: sdk 1.0.7\r\n  - Platform: java / temporal 1.6.3\r\n","closedAt":"2021-05-24T17:21:58Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDgzMzczMzkwMA==","author":{"login":"vitarb"},"authorAssociation":"CONTRIBUTOR","body":"Steve, thanks for the question. Data converter is used to serialize/deserialize all parameters that need to be sent over the wire. Your work-around sounds reasonable to me, I can see why it feels a bit hacky though. Did you expect that search attributes shouldn't be encoded at all? Do you have any proposals here or did you just want to have a discussion? If it's for the discussion then perhaps we should move the topic to our [community forum](community.temporal.io/).","createdAt":"2021-05-06T17:51:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/468#issuecomment-833733900","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgzNDYzNzgyNQ==","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"DataConverter is pluggable. But the format of the search attribute serialization is fixed by the service. So using DataConverter (at least one provided by the user) for search attributes is not correct. We should be careful here though as it can break backwards compatibility if we just stop using the provided DC.","createdAt":"2021-05-07T17:24:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/468#issuecomment-834637825","viewerDidAuthor":true},{"id":"MDEyOklzc3VlQ29tbWVudDgzNzA2NTMxMA==","author":{"login":"skrul"},"authorAssociation":"NONE","body":"So I talked to manu a bit about this and it turns out we were doing this slightly wrong (but the basic problem remains). We had implemented a `PayloadConverter` and added it as one of the converters in the list supplied to the default data converter. What we've been advised to do is to implement our own DataConverter instead.\r\n\r\nHowever, this is where things are a bit confusing as it seems that `toPayload` is used for stuff like search attributes and memo, where `toPayloads` (note the singular vs plural) is used for workflow/activity input/output. Our solution will be to use our custom serde for `toPayloads` but then delegate to the default data converter for `toPayload`.\r\n\r\nAnd I agree with maxim, stuff like search attributes and memo should be passed verbatim since these values ultimately need to be indexed by ES / read by humans so encoding them would be incorrect.\r\n\r\n","createdAt":"2021-05-10T18:05:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/468#issuecomment-837065310","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgzNzg1NTI4Nw==","author":{"login":"vitarb"},"authorAssociation":"CONTRIBUTOR","body":"Since search attributes are a `Map<String, Object>` we would need to use some data converter in order to transform it into `Map<String, Payload>`. Should we just replace custom converter with default one like I've done in [this proposal](https://github.com/temporalio/sdk-java/pull/483)?","createdAt":"2021-05-11T05:36:32Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/468#issuecomment-837855287","viewerDidAuthor":false}],"createdAt":"2021-05-05T19:03:13Z","labels":[],"milestone":null,"number":468,"reactionGroups":[],"state":"CLOSED","title":"DataConverter is (surprisingly?) used for custom search attributes","updatedAt":"2021-05-24T17:21:58Z","url":"https://github.com/temporalio/sdk-java/issues/468"}
