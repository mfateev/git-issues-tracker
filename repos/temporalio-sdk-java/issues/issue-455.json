{"assignees":[{"id":"MDQ6VXNlcjIwNTI3OTk5","login":"vkoby","name":"Vera","databaseId":0}],"author":{"id":"MDQ6VXNlcjE0NjM2MjI=","is_bot":false,"login":"mfateev","name":"Maxim Fateev"},"body":"## Expected Behavior\r\nTest passes consistently\r\n\r\n## Actual Behavior\r\nTest times out intermittently.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nRun the test a few times.\r\n\r\n## Analysis \r\n\r\nThe test fails due to gRPC channel shutdown getting blocked on the long poll emitted from a worker. Here is the stack trace:\r\n```\r\n\"Host Local Workflow Poller: 1@3179\" daemon prio=5 tid=0x1d nid=NA waiting\r\n  java.lang.Thread.State: WAITING\r\n\t blocks Time-limited test@3166\r\n\t  at sun.misc.Unsafe.park(Unsafe.java:-1)\r\n\t  at java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:215)\r\n\t  at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.awaitNanos(AbstractQueuedSynchronizer.java:2078)\r\n\t  at java.util.concurrent.LinkedBlockingQueue.poll(LinkedBlockingQueue.java:467)\r\n\t  at io.temporal.internal.testservice.TestWorkflowStoreImpl.pollWorkflowTaskQueue(TestWorkflowStoreImpl.java:346)\r\n\t  at io.temporal.internal.testservice.TestWorkflowService.pollWorkflowTaskQueue(TestWorkflowService.java:382)\r\n\t  at io.temporal.api.workflowservice.v1.WorkflowServiceGrpc$MethodHandlers.invoke(WorkflowServiceGrpc.java:3625)\r\n\t  at io.grpc.stub.ServerCalls$UnaryServerCallHandler$UnaryServerCallListener.onHalfClose(ServerCalls.java:182)\r\n\t  at io.grpc.internal.ServerCallImpl$ServerStreamListenerImpl.halfClosed(ServerCallImpl.java:331)\r\n\t  at io.grpc.internal.ServerImpl$JumpToApplicationThreadServerStreamListener$1HalfClosed.runInContext(ServerImpl.java:797)\r\n\t  at io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37)\r\n\t  at io.grpc.internal.SerializeReentrantCallsDirectExecutor.execute(SerializeReentrantCallsDirectExecutor.java:49)\r\n\t  at io.grpc.internal.ServerImpl$JumpToApplicationThreadServerStreamListener.halfClosed(ServerImpl.java:808)\r\n\t  at io.grpc.inprocess.InProcessTransport$InProcessStream$InProcessClientStream.halfClose(InProcessTransport.java:793)\r\n\t  - locked <0xda8> (a io.grpc.inprocess.InProcessTransport$InProcessStream$InProcessClientStream)\r\n\t  at io.grpc.internal.ForwardingClientStream.halfClose(ForwardingClientStream.java:72)\r\n\t  at io.grpc.internal.DelayedStream$9.run(DelayedStream.java:344)\r\n\t  at io.grpc.internal.DelayedStream.drainPendingCalls(DelayedStream.java:181)\r\n\t  at io.grpc.internal.DelayedStream.access$100(DelayedStream.java:43)\r\n\t  at io.grpc.internal.DelayedStream$4.run(DelayedStream.java:147)\r\n\t  at io.grpc.stub.ClientCalls$ThreadlessExecutor.waitAndDrain(ClientCalls.java:740)\r\n\t  at io.grpc.stub.ClientCalls.blockingUnaryCall(ClientCalls.java:149)\r\n\t  at io.temporal.api.workflowservice.v1.WorkflowServiceGrpc$WorkflowServiceBlockingStub.pollWorkflowTaskQueue(WorkflowServiceGrpc.java:2639)\r\n\t  at io.temporal.internal.worker.WorkflowPollTask.poll(WorkflowPollTask.java:81)\r\n\t  at io.temporal.internal.worker.WorkflowPollTask.poll(WorkflowPollTask.java:37)\r\n\t  at io.temporal.internal.worker.Poller$PollExecutionTask.run(Poller.java:265)\r\n\t  at io.temporal.internal.worker.Poller$PollLoopTask.run(Poller.java:241)\r\n\t  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n\t  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n\t  at java.lang.Thread.run(Thread.java:748)\r\n\r\n\"Time-limited test@3166\" daemon prio=5 tid=0x1a nid=NA waiting for monitor entry\r\n  java.lang.Thread.State: BLOCKED\r\n\t waiting for Host Local Workflow Poller: 1@3179 to release lock on <0xda8> (a io.grpc.inprocess.InProcessTransport$InProcessStream$InProcessClientStream)\r\n\t  at io.grpc.inprocess.InProcessTransport$InProcessStream$InProcessClientStream.internalCancel(InProcessTransport.java:766)\r\n\t  at io.grpc.inprocess.InProcessTransport$InProcessStream$InProcessClientStream.cancel(InProcessTransport.java:757)\r\n\t  at io.grpc.inprocess.InProcessTransport.shutdownNow(InProcessTransport.java:298)\r\n\t  at io.grpc.internal.ForwardingConnectionClientTransport.shutdownNow(ForwardingConnectionClientTransport.java:43)\r\n\t  at io.grpc.internal.CallCredentialsApplyingTransportFactory$CallCredentialsApplyingTransport.shutdownNow(CallCredentialsApplyingTransportFactory.java:196)\r\n\t  at io.grpc.internal.ForwardingConnectionClientTransport.shutdownNow(ForwardingConnectionClientTransport.java:43)\r\n\t  at io.grpc.internal.InternalSubchannel$8.run(InternalSubchannel.java:478)\r\n\t  at io.grpc.SynchronizationContext.drain(SynchronizationContext.java:95)\r\n\t  at io.grpc.SynchronizationContext.execute(SynchronizationContext.java:127)\r\n\t  at io.grpc.internal.ManagedChannelImpl.shutdownNow(ManagedChannelImpl.java:841)\r\n\t  at io.grpc.internal.ManagedChannelImpl.shutdownNow(ManagedChannelImpl.java:117)\r\n\t  at io.grpc.internal.ForwardingManagedChannel.shutdownNow(ForwardingManagedChannel.java:52)\r\n\t  at io.grpc.internal.ManagedChannelOrphanWrapper.shutdownNow(ManagedChannelOrphanWrapper.java:65)\r\n\t  at io.temporal.serviceclient.WorkflowServiceStubsImpl.shutdownNow(WorkflowServiceStubsImpl.java:245)\r\n\t  at io.temporal.testing.TestWorkflowEnvironmentInternal.close(TestWorkflowEnvironmentInternal.java:156)\r\n\t  at io.temporal.testing.TestWorkflowRule.shutdown(TestWorkflowRule.java:268)\r\n\t  at io.temporal.testing.TestWorkflowRule$2.evaluate(TestWorkflowRule.java:246)\r\n\t  at org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:299)\r\n\t  at org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:293)\r\n\t  at java.util.concurrent.FutureTask.run(FutureTask.java:266)\r\n\t  at java.lang.Thread.run(Thread.java:748)\r\n```","closedAt":"2021-07-26T22:49:59Z","comments":[],"createdAt":"2021-04-27T03:18:56Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":455,"reactionGroups":[],"state":"CLOSED","title":"Flaky test: testExceptionOnStart","updatedAt":"2021-07-26T22:49:59Z","url":"https://github.com/temporalio/sdk-java/issues/455"}
