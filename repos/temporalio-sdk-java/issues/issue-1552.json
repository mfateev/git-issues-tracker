{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjUyMzA0","is_bot":false,"login":"bergundy","name":"Roey Berman"},"body":"For the SDK side safe rollout feature we need a user-friendly API for listing workflows.\r\n\r\nWe've recently added this to TS and Python, Go already exposed a somewhat friendly API.\r\nJava needs this too.\r\n\r\nThis API belongs on `WorkflowClient` and should return some form of iterator that can be mapped into histories for the mass replayer. The history mapper ideally would support a `concurrency` option to speed up history fetching.","closedAt":"2023-01-06T01:25:45Z","comments":[{"id":"IC_kwDODN12PM5PgAwt","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"My implementation suggestion:\r\n\r\n* Add `io.temporal.client.WorkflowExecution` class that is a high-level wrapper over `temporal.api.workflow.v1.WorkflowExecutionInfo`\r\n  * Make sure it has raw proto access\r\n* Add `io.temporal.client.WorkflowExecutionDescription` class that extends `WorkflowExecution` and is a high-level wrapper over `temporal.api.workflowservice.v1.DescribeWorkflowExecutionResponse` \r\n  * Make sure it has raw proto access (it has a singular workflow execution info inside it which is why it can extend the other one)\r\n* Add `io.temporal.common.WorkflowExecutionHistory` that combines a raw `io.temporal.api.history.v1.History` and a `workflowId`\r\n  * There is already `io.temporal.internal.common.WorkflowExecutionHistory` that is used by the replayer, I suggest this replace that\r\n  * I think it'd make sense to put this in `io.temporal.client` instead, but I could understand not wanting to access client object from replayer later\r\n  * Add a static `fromJson(String workflowId, String jsonString)` that builds this from our UI/tctl JSON format (there's already a helper)\r\n  * Ideally we could have a `toJson` that doesn't store the workflow ID but does a normal proto-JSON on the history, but we either have to have that use our messed-up Go form of enum storage or have `fromJson` _also_ support the non-messed-up proto form which @Spikhalskiy has resisted this\r\n* Add `WorkflowClient.describe(String workflowId)` (and overload `describe(String workflowId, Optional<String> runId)`) that returns `WorkflowExecutionDescription`\r\n* Add `WorkflowClient.list(String query)` that returns `Stream<WorkflowExecution>`. I don't expect people to care about options to this function at this time (can add overloads later). I do not expect users need to care about pagination, but if they did, we could easily add `WorkflowClient.listPaginated` that returned `Stream<WorkflowExecutionPage>` or something.\r\n* Add `WorkflowClient.fetchHistoryEvents(String workflowId)`, `WorkflowClient.fetchHistoryEvents(String workflowId, Optional<String> runId)`, and `WorkflowClient.fetchHistoryEvents(WorkflowExecution execution)`\r\n  * This should return `Stream<io.temporal.api.history.v1.HistoryEvent>`\r\n  * I don't think people need to be able to filter to close-event only or to be able to \"wait\" just yet, but if we do think that will come and we don't want to explode the overloads, maybe we want to go ahead and require an options object\r\n* Add `WorkflowClient.fetchHistory(String workflowId)`, `WorkflowClient.fetchHistory(String workflowId, Optional<String> runId)`, and `WorkflowClient.fetchHistory(WorkflowExecution execution)`\r\n  * This should return `WorkflowExecutionHistory`\r\n  * This should leverage `fetchHistoryEvents` underneath\r\n  * I don't think people need to be able to filter to close-event only (yet)\r\n  * This obviates the need for some kind of special map from execution list to history list. Instead, they can just take their `Stream<WorkflowExecution>` and `.map(myClient::fetchHistory)` and boom, they have `Stream<WorkflowExecutionHistory>`\r\n    * And stream already has options for doing this in parallel if they want it faster somehow\r\n* Add `Worker.replayWorkflowExecution(io.temporal.common.WorkflowExecutionHistory)`\r\n  * This already exists, but would be up to discussion on whether the remove the non-workflow-ID having form or just overload it\r\n  * You do not need a special call for `Worker.replayWorkflowExecutions(Stream<io.temporal.common.WorkflowExecutionHistory>)` because the caller can easily do that (and in parallel if they want) with the existing one\r\n\r\nAll of this now makes for a really cohesive listing, history fetching, and replaying API. Take this awesome example:\r\n\r\n```java\r\npublic void runBeforeDeployment(WorkflowClient client, Worker worker, String workflowType) {\r\n  client\r\n    .list(\"WorkflowType = '\" + workflowType + \"'\")\r\n    .map(client::fetchHistory)\r\n    .parallel()\r\n    .map(worker::replayWorkflowExecution);\r\n}\r\n```\r\n\r\nThat is a pretty looking API. Of course they could have their own lambda that wraps the replay part if they want to capture errors and continue. Or they could paralellize the history fetch or whatever.\r\n\r\n> The history mapper ideally would support a concurrency option to speed up history fetching.\r\n\r\nJava already has utilities for parallel handling of streams and since we prefer to give users control over their threads on the client side, we should not add this ourselves.","createdAt":"2022-12-01T13:45:19Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1552#issuecomment-1333791789","viewerDidAuthor":false}],"createdAt":"2022-12-01T13:07:25Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQ0","name":"enhancement","description":"User experience","color":"a2eeef"}],"milestone":{"number":20,"title":"1.18.0","description":"","dueOn":"2022-11-29T00:00:00Z"},"number":1552,"reactionGroups":[],"state":"CLOSED","title":"High level API to list workflows","updatedAt":"2023-01-06T01:25:46Z","url":"https://github.com/temporalio/sdk-java/issues/1552"}
