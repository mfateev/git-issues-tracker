{
  "assignees": [],
  "author": {
    "id": "MDQ6VXNlcjIwNTA0MDQ5",
    "is_bot": false,
    "login": "Quinn-With-Two-Ns",
    "name": "Quinn Klassen"
  },
  "body": "## Expected Behavior\r\nRemoving a `Workflow.GetVersion` call should never cause a NDE\r\n\r\n## Actual Behavior\r\nRemoving a `Workflow.GetVersion` call can cause a NDE if there are multiple workflow threads running.\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n```\r\npublic class GetVersionMultithreadingRemoveTest {\r\n\r\n  private static boolean hasReplayed;\r\n\r\n  @Rule\r\n  public SDKTestWorkflowRule testWorkflowRule =\r\n      SDKTestWorkflowRule.newBuilder()\r\n          .setWorkflowTypes(TestGetVersionWorkflowImpl.class)\r\n          .setActivityImplementations(new TestActivitiesImpl())\r\n          // Forcing a replay. Full history arrived from a normal queue causing a replay.\r\n          .setWorkerOptions(\r\n              WorkerOptions.newBuilder()\r\n                  .setStickyQueueScheduleToStartTimeout(Duration.ZERO)\r\n                  .build())\r\n          .build();\r\n\r\n  @Test\r\n  public void testGetVersionMultithreadingRemoval() {\r\n    TestWorkflow1 workflowStub =\r\n        testWorkflowRule.newWorkflowStubTimeoutOptions(TestWorkflow1.class);\r\n    String result = workflowStub.execute(testWorkflowRule.getTaskQueue());\r\n    assertTrue(hasReplayed);\r\n    assertEquals(\"activity1\", result);\r\n  }\r\n\r\n  public static class TestGetVersionWorkflowImpl implements TestWorkflow1 {\r\n\r\n    @Override\r\n    public String execute(String taskQueue) {\r\n      VariousTestActivities testActivities =\r\n          Workflow.newActivityStub(\r\n              VariousTestActivities.class,\r\n              SDKTestOptions.newActivityOptionsForTaskQueue(taskQueue));\r\n\r\n      Async.procedure(\r\n          () -> {\r\n            Workflow.sleep(1000);\r\n          });\r\n\r\n      // Test removing a version check in replaying code with an additional thread running.\r\n      if (!WorkflowUnsafe.isReplaying()) {\r\n        int version = Workflow.getVersion(\"changeId\", 1, 2);\r\n        assertEquals(version, 2);\r\n      } else {\r\n        hasReplayed = true;\r\n      }\r\n      String result =\r\n          \"activity\" + testActivities.activity1(1); // This is executed in non-replay mode.\r\n      return result;\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThis happens because ` Workflow.getVersion` causes the current thread to block so when it is removed the order of execution can change.\r\n\r\n## Specifications\r\n\r\n  - Version: All\r\n  \r\n  The current workaround is to not remove the `Workflow.getVersion` call\r\n",
  "closedAt": null,
  "comments": [],
  "createdAt": "2024-11-04T23:06:39Z",
  "labels": [
    {
      "id": "MDU6TGFiZWwxNjIyNzE5ODQx",
      "name": "bug",
      "description": "Something isn't working",
      "color": "d73a4a"
    }
  ],
  "milestone": null,
  "number": 2307,
  "reactionGroups": [],
  "state": "OPEN",
  "title": "Removing a `Workflow.GetVersion` call can cause NDE if there are multiple parallel workflow threads running.",
  "updatedAt": "2024-11-05T03:06:42Z",
  "url": "https://github.com/temporalio/sdk-java/issues/2307"
}
