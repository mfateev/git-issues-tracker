{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"## Expected Behavior\r\n\r\nWhen `Workflow.await(duration, condition)` is used in workflow code and the workflow gets canceled, `CanceledFailure` should be thrown and if it's not caught, the workflow should be canceled after that.\r\n`WorkflowStub.getResult` should return with `WorkflowFailedException(CanceledFailure)`\r\n\r\n## Actual Behavior\r\nThe expected behavior is true for `Workflow.await(condition)`, but not for `Workflow.await(duration, condition)`\r\nFor `Workflow.await(duration, condition)`, CanceledFailure is thrown but after that, it's followed by:\r\n\r\n```\r\njava.lang.RuntimeException: Failure processing workflow task. WorkflowId=6124edb9-11c9-4af4-94d4-920c7a8eca3a, RunId=135d7fa9-c4be-42a4-8c35-55fa7400bcbd, Attempt=2\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.wrapFailure(WorkflowWorker.java:349)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.wrapFailure(WorkflowWorker.java:279)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:79)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n\tat java.base/java.lang.Thread.run(Thread.java:829)\r\nCaused by: java.lang.Error: closed\r\n\tat io.temporal.internal.sync.DeterministicRunnerImpl.checkClosed(DeterministicRunnerImpl.java:351)\r\n\tat io.temporal.internal.sync.DeterministicRunnerImpl.executeInWorkflowThread(DeterministicRunnerImpl.java:437)\r\n\tat io.temporal.internal.sync.SyncWorkflowContext.lambda$newTimer$d7d857c6$1(SyncWorkflowContext.java:540)\r\n\tat io.temporal.internal.replay.ReplayWorkflowContextImpl.handleTimerCallback(ReplayWorkflowContextImpl.java:291)\r\n\tat io.temporal.internal.replay.ReplayWorkflowContextImpl.lambda$newTimer$114ed502$1(ReplayWorkflowContextImpl.java:277)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.lambda$newTimer$4b87b190$1(WorkflowStateMachines.java:483)\r\n\tat io.temporal.internal.statemachines.TimerStateMachine.notifyCancellation(TimerStateMachine.java:148)\r\n\tat io.temporal.internal.statemachines.FixedTransitionAction.apply(FixedTransitionAction.java:45)\r\n\tat io.temporal.internal.statemachines.StateMachine.executeTransition(StateMachine.java:147)\r\n\tat io.temporal.internal.statemachines.StateMachine.handleCommand(StateMachine.java:111)\r\n\tat io.temporal.internal.statemachines.EntityStateMachineBase.handleCommand(EntityStateMachineBase.java:55)\r\n\tat io.temporal.internal.statemachines.CancellableCommand.handleCommand(CancellableCommand.java:63)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.prepareImpl(WorkflowStateMachines.java:352)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.prepareCommands(WorkflowStateMachines.java:335)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.eventLoop(WorkflowStateMachines.java:404)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.access$500(WorkflowStateMachines.java:68)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines$WorkflowTaskCommandsListener.workflowTaskStarted(WorkflowStateMachines.java:816)\r\n\tat io.temporal.internal.statemachines.WorkflowTaskStateMachine.handleCompleted(WorkflowTaskStateMachine.java:126)\r\n\tat io.temporal.internal.statemachines.WorkflowTaskStateMachine.handleStarted(WorkflowTaskStateMachine.java:116)\r\n\tat io.temporal.internal.statemachines.FixedTransitionAction.apply(FixedTransitionAction.java:45)\r\n\tat io.temporal.internal.statemachines.StateMachine.executeTransition(StateMachine.java:147)\r\n\tat io.temporal.internal.statemachines.StateMachine.handleHistoryEvent(StateMachine.java:101)\r\n\tat io.temporal.internal.statemachines.EntityStateMachineBase.handleEvent(EntityStateMachineBase.java:67)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEventImpl(WorkflowStateMachines.java:203)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:171)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleEvent(ReplayWorkflowRunTaskHandler.java:139)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:179)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:149)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithEmbeddedQuery(ReplayWorkflowTaskHandler.java:201)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:114)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:319)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:279)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:73)\r\n\t... 3 common frames omitted\r\n```\r\n\r\nAlso `WorkflowStub.getResult` never returns for await with duration.\r\n\r\n## Reproduction\r\n\r\nSee passing `WorkflowAwaitCancellationTest`: https://github.com/Spikhalskiy/java-sdk/commit/24717c252f7b6725cf1cf5009cce7479558a2792#diff-55aafba49213a140f44c29e66d260fce5ee1f80c45111dae78788b56e7544f9eR35\r\n\r\nand failing `WorkflowAwaitWithDurationCancellationTest`: https://github.com/Spikhalskiy/java-sdk/commit/24717c252f7b6725cf1cf5009cce7479558a2792#diff-0f7d9c0a6e2232c47c8c11568d0a621b9562c49407c96369ea8f0a279b3ed62aR36\r\n\r\nwhile they expected to behave the same.\r\nReproduces for both test service and dockerized Temporal","closedAt":"2021-10-13T17:20:23Z","comments":[],"createdAt":"2021-10-12T20:43:39Z","labels":[],"milestone":{"number":6,"title":"1.5.0","description":"","dueOn":"2021-11-02T00:00:00Z"},"number":816,"reactionGroups":[],"state":"CLOSED","title":"`Workflow.await(duration, condition)` doesn't work correctly with workflow cancelation","updatedAt":"2021-10-13T17:20:23Z","url":"https://github.com/temporalio/sdk-java/issues/816"}
