{"assignees":[],"author":{"id":"MDQ6VXNlcjM4ODA3","is_bot":false,"login":"dano","name":"Dan O'Reilly"},"body":"## Expected Behavior\r\nI expect this:\r\n``` java\r\npublic static WorkflowLocal<String> wl = WorkflowLocal.withInitial(() -> \"value\");\r\n...\r\nwl.get();\r\nwl.set(null);\r\nString s = wl.get();\r\n```\r\nTo result in the String `s` being initialized to `null`.\r\n\r\n## Actual Behavior\r\nThe call to `wl.get()` throws an NullPointerException:\r\n```\r\nCaused by: java.lang.NullPointerException\r\n\tat java.util.Objects.requireNonNull(Objects.java:221) ~[?:?]\r\n\tat java.util.Optional.<init>(Optional.java:107) ~[?:?]\r\n\tat java.util.Optional.of(Optional.java:120) ~[?:?]\r\n\tat io.temporal.internal.sync.DeterministicRunnerImpl.getRunnerLocal(DeterministicRunnerImpl.java:597) ~[temporal-sdk-1.19.1.jar:?]\r\n\tat io.temporal.internal.sync.RunnerLocalInternal.get(RunnerLocalInternal.java:30) ~[temporal-sdk-1.19.1.jar:?]\r\n\tat io.temporal.workflow.WorkflowLocal.get(WorkflowLocal.java:68) ~[temporal-sdk-1.19.1.jar:?]\r\n        at <line that called wl.get()>\r\n```\r\n\r\nNote that this works fine:\r\n``` java\r\npublic static WorkflowLocal<String> wl = WorkflowLocal.withInitial(() -> null);\r\n...\r\nwl.get();\r\n```\r\nThe problem only occurs once you've called `set(null)`.\r\n\r\n## Steps to Reproduce the Problem\r\nSee the code snippet above. The root cause of the bug is that `DeterministicRunnerImpl.getRunnerLocal.getRunnerLocal` returns an `Optional<T>`, which will return `Optional.empty()` if `WorkflowLocal.set` has not been called yet, or use `Optional.of` to wrap whatever was passed to `WorkflowLocal.set` in an `Optional`. When `set(null)` is used, the next `get()` results in a call to `Optional.of(null)`, which throws the NPE. I think that the `Optional<T>` return type just doesn't work here, since this method needs to differentiate between two states: `set` has not been called, or `set` has been called, inclusive of `set` being called with `null`, which `Optional` can't handle.\r\n\r\nI also noticed that when `get()` is called for the first time, without `set` being called first, the value returned by the `withInitial` callback is not actually stored anywhere. So repeated calls to `get()` result in repeated calls to the `withInitial` callback. This is surprising behavior to me - not sure if it's intended or not.\r\n\r\n## Specifications\r\n\r\n  - Version: Java SDK 1.19.1.\r\n  - Platform: Linux\r\n","closedAt":"2023-06-07T15:57:08Z","comments":[],"createdAt":"2023-05-03T17:10:48Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"},{"id":"LA_kwDODN12PM8AAAABTCzm8g","name":"good first issue","description":"","color":"37F0F1"}],"milestone":null,"number":1761,"reactionGroups":[],"state":"CLOSED","title":"Calling WorkflowLocal.set(null) results in the next call to WorkflowLocal.get() to throw a NullPointerException","updatedAt":"2023-06-07T15:57:08Z","url":"https://github.com/temporalio/sdk-java/issues/1761"}
