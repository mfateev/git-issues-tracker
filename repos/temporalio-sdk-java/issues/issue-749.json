{"assignees":[{"id":"MDQ6VXNlcjEzMTE2OTQ=","login":"vitarb","name":"Vitali","databaseId":0}],"author":{"id":"MDQ6VXNlcjU4MTc4NTk=","is_bot":false,"login":"smax48","name":"Maxim Chuvilyaev"},"body":"## Expected Behavior\r\nIt was working fine in SDK v1.1\r\n\r\n## Actual Behavior\r\nWhen upgraded to v1.3.1, I get this error:\r\n\r\n```\r\nOnly one of the target and channel options can be set at a time\r\njava.lang.IllegalStateException: Only one of the target and channel options can be set at a time\r\n\tat io.temporal.serviceclient.WorkflowServiceStubsOptions.<init>(WorkflowServiceStubsOptions.java:179)\r\n\tat io.temporal.serviceclient.WorkflowServiceStubsOptions.<init>(WorkflowServiceStubsOptions.java:34)\r\n\tat io.temporal.serviceclient.WorkflowServiceStubsOptions$Builder.validateAndBuildWithDefaults(WorkflowServiceStubsOptions.java:657)\r\n\tat io.temporal.serviceclient.WorkflowServiceStubsImpl.<init>(WorkflowServiceStubsImpl.java:111)\r\n\tat io.temporal.serviceclient.WorkflowServiceStubs.newInstance(WorkflowServiceStubs.java:51)\r\n\tat io.temporal.testing.TestWorkflowEnvironmentInternal.<init>(TestWorkflowEnvironmentInternal.java:80)\r\n\tat io.temporal.testing.TestWorkflowEnvironment.newInstance(TestWorkflowEnvironment.java:99)\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nThis code crashes:\r\n\r\n```\r\n    private val testEnv: TestWorkflowEnvironment = TestWorkflowEnvironment.newInstance(\r\n        TestEnvironmentOptions.newBuilder()\r\n            .setWorkflowClientOptions(\r\n                WorkflowClientOptions.newBuilder()\r\n                    .validateAndBuildWithDefaults()\r\n            ).setWorkerFactoryOptions(\r\n                WorkerFactoryOptions.newBuilder()\r\n                    .validateAndBuildWithDefaults()\r\n            ).validateAndBuildWithDefaults()\r\n    )\r\n```\r\n\r\nPS \r\nWhen I use just build() - it works OK\r\n\r\n## Specifications\r\n\r\n  - Version: Java SDK 1.3.1\r\n\r\n","closedAt":"2021-09-22T06:36:27Z","comments":[{"id":"IC_kwDODN12PM43HI4Z","author":{"login":"vitarb"},"authorAssociation":"CONTRIBUTOR","body":"Looks like the problem is that when you call validateAndBuildWithDefaults on TestEnvironmentOptions builder it creates default service options with default target address, which then gets passed to the WorkflowServiceStubsImpl that also adds a channel for the in-memory service, which causes the error you are seeing (both target and channel set). The fix is rather simple, we should remove target when we are populating the channel. PR linked above should fix the issue.","createdAt":"2021-09-22T06:14:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/749#issuecomment-924618265","viewerDidAuthor":false},{"id":"IC_kwDODN12PM43HJHB","author":{"login":"smax48"},"authorAssociation":"NONE","body":"yeah, I debugged this a bit and was thinking something similar. Just strange that I was first to pick this up :)\r\nThanks for quick response!","createdAt":"2021-09-22T06:16:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/749#issuecomment-924619201","viewerDidAuthor":false}],"createdAt":"2021-09-22T00:32:47Z","labels":[],"milestone":null,"number":749,"reactionGroups":[],"state":"CLOSED","title":"TestEnvironmentOptions.Builder.validateAndBuildWithDefaults fails","updatedAt":"2021-09-22T06:36:27Z","url":"https://github.com/temporalio/sdk-java/issues/749"}
