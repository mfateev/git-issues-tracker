{"assignees":[],"author":{"id":"MDQ6VXNlcjgwNzU1OQ==","is_bot":false,"login":"bjab","name":"Bartek Jablonski"},"body":"\r\nWe have activity, that is using \"Asynchronous Activity Completion\" and we want to test it. In our case, we just want to test, that activity will send proper kafka message, but still, we need to set up test environment, to obtain activity token, etc.\r\n\r\nIn shortest form, our test looks like this:\r\n\r\n```     \r\nvar testActivityEnvironment = TestActivityEnvironment.newInstance(TestEnvironmentOptions.getDefaultInstance());\r\ntestActivityEnvironment.registerActivitiesImplementations(activityImpl);\r\nvar testActivity = testActivityEnvironment.newActivityStub(SomeActivities.class);\r\n\r\ntestActivity.execute();\r\n```\r\n\r\nInside of `activityImpl` we use `context.doNotCompleteOnReturn();`\r\n\r\nProblem is, that `TestActivityEnvironmentInternal` expects either cancelled, failed or completed activity.\r\nIn case of not async activity, all fields of `ActivityTaskHandler.Result`  are null and we get `NullPointerException`\r\n\r\nProblematic block of code:\r\nhttps://github.com/temporalio/sdk-java/blob/master/temporal-testing/src/main/java/io/temporal/testing/TestActivityEnvironmentInternal.java#L489-L496\r\n\r\n## Expected Behavior\r\n\r\nCalling mehod of async activity will do nothing.\r\n\r\n## Actual Behavior\r\n\r\nNullPointerException at https://github.com/temporalio/sdk-java/blob/master/temporal-testing/src/main/java/io/temporal/testing/TestActivityEnvironmentInternal.java#L496 (response.getTaskFailed() is null)\r\n\r\n## Specifications\r\n\r\n  - Version: 1.23.2\r\n  - Platform: windows\r\n","closedAt":"2025-04-23T22:43:15Z","comments":[{"id":"IC_kwDODN12PM6LIIbh","author":{"login":"esikgabi"},"authorAssociation":"NONE","body":"Hi,\r\nI found a similar open issue: https://github.com/temporalio/sdk-java/issues/460\r\nThey may be connected or reflect the same issue. \r\nThere are not too many activities but maybe it is a good idea to link them. ","createdAt":"2024-09-06T14:17:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2097#issuecomment-2334164705","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6iaJxW","author":{"login":"mschirmacher"},"authorAssociation":"NONE","body":"Hi, i added a very small fix for this issue - i wonder why this bug is open for so long.\nAnyway, as a sidenote: testing async activities is should get more love, e.g. there is no TestWorkflowClient at the moment that would allow proper testing of the activity","createdAt":"2025-03-14T13:48:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2097#issuecomment-2724764758","viewerDidAuthor":false}],"createdAt":"2024-06-06T13:28:43Z","labels":[],"milestone":null,"number":2097,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"TestActivityEnvironment does not work with Asynchronous Activity Completion","updatedAt":"2025-04-23T22:43:15Z","url":"https://github.com/temporalio/sdk-java/issues/2097"}
