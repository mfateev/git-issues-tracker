{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjQwMTQxNzk=","is_bot":false,"login":"WellingR","name":"Ruud Welling"},"body":"## Expected Behavior\r\nWhile running a jacoco coverage run on my temporal project. I discovered that temporal tries to register activity types for generated (synthetic) methods.\r\n\r\nI would expect that running with or without jacoco has no influcence on the result of the test itself.\r\n\r\nJacoco generates the following method with is both static and synthetic (can be seen using reflection: `Method::isSynthetic()`\r\n`private static boolean[] com.mypackage.GreetingActivities.$jacocoInit(java.lang.invoke.MethodHandles$Lookup,java.lang.String,java.lang.Class)`\r\n\r\nThe java spec states:\r\n> A construct emitted by a Java compiler must be marked as synthetic if it does not correspond to a construct declared explicitly or implicitly in source code, unless the emitted construct is a class initialization method \r\n\r\nTo me it would make sense for temporal to ignore synthetic methods. As well as static methods.\r\n\r\n## Actual Behavior\r\n\r\n```\r\njava.lang.IllegalArgumentException: \"$jacocoInit\" activity type is already registered with the worker\r\n\tat io.temporal.internal.activity.POJOActivityTaskHandler.registerActivityImplementation(POJOActivityTaskHandler.java:140)\r\n\tat io.temporal.internal.activity.POJOActivityTaskHandler.registerActivityImplementations(POJOActivityTaskHandler.java:93)\r\n\tat io.temporal.internal.sync.SyncActivityWorker.registerActivityImplementations(SyncActivityWorker.java:91)\r\n\tat io.temporal.worker.Worker.registerActivitiesImplementations(Worker.java:313)\r\n```\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nChange `HelloActivity` in the temporal java samples as follows:\r\n\r\nEnsure there are two activity interfaces declared, which both have a static methods:\r\n```java\r\n  @ActivityInterface\r\n  public interface GreetingActivities {\r\n\r\n    @ActivityMethod\r\n    String composeGreeting(String greeting, String name);\r\n\r\n    static String name() {\r\n      return \"1\";\r\n    }\r\n  }\r\n\r\n  @ActivityInterface\r\n  public interface GreetingActivities2 {\r\n\r\n    @ActivityMethod\r\n    String composeGreeting2(String greeting, String name);\r\n\r\n    static String name() {\r\n      return \"2\";\r\n    }\r\n  }\r\n```\r\nEnsure that both interfaces are implemented (GreetingActivities already has an implementation)\r\n```java\r\n  static class GreetingActivitiesImpl2 implements GreetingActivities2 {\r\n    @Override\r\n    public String composeGreeting2(String greeting, String name) {\r\n      return greeting + \" \" + name + \"!\";\r\n    }\r\n  }\r\n```\r\nIn the first test in `HelloActivityTest`, ensure that both activity implementaitons are registered\r\n```java\r\n    testWorkflowRule\r\n        .getWorker()\r\n        .registerActivitiesImplementations(\r\n            new GreetingActivitiesImpl(), new HelloActivity.GreetingActivitiesImpl2());\r\n```\r\n\r\nEnable jacoco in build.gradle.\r\n```\r\nplugins {\r\n    ... (existing plugins here) ...\r\n    id 'jacoco'\r\n}\r\n\r\njacocoTestReport {\r\n    dependsOn test // tests are required to run before generating the report\r\n}\r\n\r\njacoco {\r\n    toolVersion = \"0.8.7\"\r\n    reportsDir = file(\"$buildDir/jacoco\")\r\n}\r\n\r\ntest {\r\n    useJUnitPlatform()\r\n    finalizedBy jacocoTestReport // report is always generated after tests run\r\n}\r\n```\r\n\r\nThen run `  ./gradlew clean  jacocoTestReport`\r\n\r\n## Specifications\r\n\r\n  - Version: The samples used temporal-sdk 1.7.0\r\n  - Platform: MacOs (Monerey M1), reproduced using both JDK 11 and 17\r\n","closedAt":"2022-03-18T21:40:15Z","comments":[{"id":"IC_kwDODN12PM48xXl9","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"An activity interface defines the signature of remote calls. Having static methods in this interface doesn't really make sense as the caller workflow and an activity implementation can reside in completely different codebases and processes. ","createdAt":"2022-01-23T21:52:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/977#issuecomment-1019574653","viewerDidAuthor":true}],"createdAt":"2022-01-14T16:14:46Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":10,"title":"1.9.0","description":"","dueOn":"2022-04-12T00:00:00Z"},"number":977,"reactionGroups":[],"state":"CLOSED","title":"Static and synthetic methods are considered Activity methods in activity interfaces","updatedAt":"2022-03-18T21:40:15Z","url":"https://github.com/temporalio/sdk-java/issues/977"}
