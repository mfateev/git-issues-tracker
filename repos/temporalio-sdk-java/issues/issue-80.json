{"assignees":[],"author":{"id":"MDQ6VXNlcjE5OTQ3NDg5","is_bot":false,"login":"chris-rcn","name":""},"body":"Take the following trivial example:\r\n```\r\n  public interface FooWorkflow {\r\n    @WorkflowMethod\r\n    void exec();\r\n    @SignalMethod\r\n    void input(int value);\r\n  }\r\n```\r\nWith V1 implementation:\r\n```\r\n  public static class FooWorkflowImpl implements FooWorkflow {\r\n    private static final Logger LOGGER = LoggerFactory.getLogger(FooWorkflowImpl.class);\r\n    private int reincarnation;\r\n    @Override\r\n    public void exec() {\r\n      int changeFoo = Workflow.getVersion(\"changeFoo\", Workflow.DEFAULT_VERSION, 1);\r\n      LOGGER.info(\"changeFoo version {}\", changeFoo);\r\n      Workflow.await(() -> reincarnation > 0);\r\n    }\r\n    @Override\r\n    public void input(int value) {\r\n      this.reincarnation = value;\r\n    }\r\n  }\r\n```\r\nAs expected, this prints:\r\n```\r\nchangeFoo version 1\r\n```\r\n\r\nNow imagine a V2 implementation that looks as follows:\r\n```\r\n    @Override\r\n    public void exec() {\r\n      int changeBar = Workflow.getVersion(\"changeBar\", Workflow.DEFAULT_VERSION, 1);\r\n      LOGGER.info(\"changeBar version {}\", changeBar);\r\n      int changeFoo = Workflow.getVersion(\"changeFoo\", Workflow.DEFAULT_VERSION, 1);\r\n      LOGGER.info(\"changeFoo version {}\", changeFoo);\r\n      Workflow.await(() -> reincarnation > 0);\r\n    }\r\n```\r\nIf I update the worker code and signal the existing workflow. Then the output it prints is:\r\n```\r\nchangeBar version -1\r\nchangeFoo version -1\r\n```\r\nWhy did changeFoo not reuse the previous version 1 from the marker?\r\n\r\nIt is falling into here, in DecisionsHelper:\r\n```\r\n    // If we have a version marker in history event but not in decisions, let's add one.\r\n    RecordMarkerDecisionAttributes marker =\r\n        new RecordMarkerDecisionAttributes()\r\n            .setMarkerName(ClockDecisionContext.VERSION_MARKER_NAME)\r\n            .setHeader(event.getMarkerRecordedEventAttributes().getHeader())\r\n            .setDetails(event.getMarkerRecordedEventAttributes().getDetails());\r\n    Decision markerDecision =\r\n        new Decision()\r\n            .setDecisionType(DecisionType.RecordMarker)\r\n            .setRecordMarkerDecisionAttributes(marker);\r\n    DecisionId markerDecisionId = new DecisionId(DecisionTarget.MARKER, nextDecisionEventId);\r\n    decisions.put(\r\n        markerDecisionId, new MarkerDecisionStateMachine(markerDecisionId, markerDecision));\r\n    nextDecisionEventId++;\r\n```\r\nBased on the comment, it should not be executing this code.","closedAt":"2020-05-11T18:33:24Z","comments":[],"createdAt":"2020-05-07T03:20:17Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":80,"reactionGroups":[],"state":"CLOSED","title":"Workflow versioning marker not respected on replay","updatedAt":"2020-05-11T18:33:24Z","url":"https://github.com/temporalio/sdk-java/issues/80"}
