{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjQyMzc5MQ==","is_bot":false,"login":"desheffer","name":"Doug Sheffer"},"body":"## Expected Behavior\r\n\r\nAfter configuring a metrics scope (similar to what is described here: https://community.temporal.io/t/how-to-enable-metrics-support-using-java-sdk/366/2), I am having issues getting \"gauge\" metrics to register properly.\r\n\r\nIt seems that I can report metrics directly to the `MicrometerClientStatsReporter`, like this:\r\n\r\n```\r\nreporter.reportGauge(\"my_gauge\", new HashMap<>(), 123.0);\r\n```\r\n\r\nOr, if I am inside the context of a Workflow, like this:\r\n\r\n```\r\nWorkflow.getMetricsScope().gauge(\"my_gauge\").update(123.0);\r\n```\r\n\r\nIn either example, I would expect to see \"my_gauge\" in my metrics backend, and I would expect to see it updated whenever this code runs.\r\n\r\n## Actual Behavior\r\n\r\nIn actuality, I am seeing the gauge value being reported, but it disappears approximately 60 seconds later. If I restart my program, the gauge starts reporting again, but it stops again after 60 seconds. If I try using a counter or a timer, then those seem to work fine. But there seems to be a problem that is specific to gauges.\r\n\r\nDigging a bit deeper... It seems that both code examples above make use of the `reportGauge` method in the `MicrometerClientStatsReporter`. This method uses the `io.micrometer.core.instrument.MeterRegistry` to create a new gauge each time it is called. Once created, it updates the gauge using a value of type `double`.\r\n\r\nThis appears to violate 2 warnings listed in the [Gauges section](https://micrometer.io/docs/concepts#_gauges) of the Micrometer documentation. To summarize from section 9.1:\r\n\r\n> Attempting to construct a gauge with a primitive number or one of its `java.lang` object forms is always incorrect.\r\n\r\nFrom section 9.3, titled \"Why is My Gauge Reporting NaN or Disappearing?\":\r\n\r\n> It is your responsibility to hold a strong reference to the state object that you are measuring with a  `Gauge`.\r\n\r\nOne more note is that if I create a `Gauge` through the `io.micrometer.core.instrument.MeterRegistry` directly (as well as using an `AtomicLong` and ensuring that it's not garbage collected), then the bug does not appear. In other words, I don't believe that my metrics backend is where the values are getting dropped.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Enable metrics as described here: https://community.temporal.io/t/how-to-enable-metrics-support-using-java-sdk/366/2\r\n  2. Create a new gauge using one of the examples above\r\n  3. Verify that the gauge is being reported to your metrics backend\r\n  4. Wait for approximately 60 seconds and the gauge _should_ stop being reported\r\n\r\n## Specifications\r\n\r\n  - Version: tested with Java SDK v1.5.0 and v1.7.0; Temporal is v1.14.0\r\n  - Platform: Docker on Linux\r\n  - Metrics backend: Prometheus","closedAt":"2022-01-26T19:25:02Z","comments":[{"id":"IC_kwDODN12PM48xq21","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Confirm, it does look like a bug in Temporal `MicrometerClientStatsReporter` where we incorrectly integrate tally and micrometer interfaces.\r\nThank you for the detailed report!","createdAt":"2022-01-24T02:22:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/979#issuecomment-1019653557","viewerDidAuthor":false}],"createdAt":"2022-01-15T00:06:35Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":9,"title":"1.8.0","description":"","dueOn":"2022-02-01T00:00:00Z"},"number":979,"reactionGroups":[],"state":"CLOSED","title":"Gauge metrics disappear after ~60 seconds","updatedAt":"2022-01-26T19:25:02Z","url":"https://github.com/temporalio/sdk-java/issues/979"}
