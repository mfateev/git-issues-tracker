{
  "assignees": [],
  "author": {
    "id": "MDQ6VXNlcjEwODgwNDc=",
    "is_bot": false,
    "login": "rpost",
    "name": "Radek Posto≈Çowicz"
  },
  "body": "## Actual Behavior\n\nUnder certain execution path `io.temporal.testing.TestWorkflowEnvironment#sleep` hangs indefinitely. \n\n## Steps to Reproduce the Problem\n\nPlease have a look at https://github.com/rpost/temporal-java-sdk-bug-2670/blob/main/src/test/java/com/example/temporalsleepbug/TemporalSleepBugApplicationTests.java\n\nExecution stops at https://github.com/rpost/temporal-java-sdk-bug-2670/blob/main/src/test/java/com/example/temporalsleepbug/TemporalSleepBugApplicationTests.java#L52 and never finishes.\n\nThread dump shows:\n\n```\n\"main\" #1 [1711914] prio=5 os_prio=0 cpu=2324,38ms elapsed=23,31s tid=0x00007cac5c033e30 nid=1711914 waiting on condition  [0x00007cac60512000]\n   java.lang.Thread.State: WAITING (parking)\n\tat jdk.internal.misc.Unsafe.park(java.base@21.0.7/Native Method)\n\t- parking to wait for  <0x00000002b9220bc8> (a io.grpc.stub.ClientCalls$ThreadlessExecutor)\n\tat java.util.concurrent.locks.LockSupport.park(java.base@21.0.7/LockSupport.java:221)\n\tat io.grpc.stub.ClientCalls$ThreadlessExecutor.waitAndDrain(ClientCalls.java:717)\n\tat io.grpc.stub.ClientCalls.blockingUnaryCall(ClientCalls.java:159)\n\tat io.temporal.api.testservice.v1.TestServiceGrpc$TestServiceBlockingStub.unlockTimeSkippingWithSleep(TestServiceGrpc.java:586)\n\tat io.temporal.testing.TestWorkflowEnvironmentInternal.sleep(TestWorkflowEnvironmentInternal.java:165)\n\tat com.example.temporalsleepbug.TemporalSleepBugApplicationTests.shouldExecuteWorkflow(TemporalSleepBugApplicationTests.java:52)\n\tat java.lang.invoke.LambdaForm$DMH/0x00007cabc8170800.invokeVirtual(java.base@21.0.7/LambdaForm$DMH)\n\tat java.lang.invoke.LambdaForm$MH/0x00007cabc86b8000.invoke(java.base@21.0.7/LambdaForm$MH)\n\tat java.lang.invoke.Invokers$Holder.invokeExact_MT(java.base@21.0.7/Invokers$Holder)\n\tat jdk.internal.reflect.DirectMethodHandleAccessor.invokeImpl(java.base@21.0.7/DirectMethodHandleAccessor.java:153)\n\tat jdk.internal.reflect.DirectMethodHandleAccessor.invoke(java.base@21.0.7/DirectMethodHandleAccessor.java:103)\n\tat java.lang.reflect.Method.invoke(java.base@21.0.7/Method.java:580)\n\tat org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:775)\n\t....\n```\n\n```\n\"workflow-method-SubscriberTerminationWorkflow-1234-84b7b4fc-bea0-42f3-a168-fb8ebac7c408\" #71 [1712086] prio=5 os_prio=0 cpu=4,69ms elapsed=20,45s tid=0x00007caaf80059f0 nid=1712086 waiting on condition  [0x00007cac14629000]\n   java.lang.Thread.State: WAITING (parking)\n\tat jdk.internal.misc.Unsafe.park(java.base@21.0.7/Native Method)\n\t- parking to wait for  <0x00000007ffd017e8> (a java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject)\n\tat java.util.concurrent.locks.LockSupport.park(java.base@21.0.7/LockSupport.java:371)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionNode.block(java.base@21.0.7/AbstractQueuedSynchronizer.java:519)\n\tat java.util.concurrent.ForkJoinPool.unmanagedBlock(java.base@21.0.7/ForkJoinPool.java:3780)\n\tat java.util.concurrent.ForkJoinPool.managedBlock(java.base@21.0.7/ForkJoinPool.java:3725)\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(java.base@21.0.7/AbstractQueuedSynchronizer.java:1712)\n\tat io.temporal.internal.sync.WorkflowThreadScheduler.yieldLocked(WorkflowThreadScheduler.java:37)\n\tat io.temporal.internal.sync.WorkflowThreadContext.yield(WorkflowThreadContext.java:70)\n\tat io.temporal.internal.sync.WorkflowThreadImpl.yield(WorkflowThreadImpl.java:378)\n\tat io.temporal.internal.sync.WorkflowThread.await(WorkflowThread.java:27)\n\tat io.temporal.internal.sync.SyncWorkflowContext.await(SyncWorkflowContext.java:1290)\n\tat io.temporal.internal.sync.WorkflowInternal.await(WorkflowInternal.java:510)\n\tat io.temporal.workflow.Workflow.await(Workflow.java:611)\n\tat com.example.temporalsleepbug.SubscriberTerminationWorkflow$SubscriberTerminationWorkflowImpl.execute(SubscriberTerminationWorkflow.java:25)\n\tat java.lang.invoke.LambdaForm$DMH/0x00007cabc8778000.invokeInterface(java.base@21.0.7/LambdaForm$DMH)\n\tat java.lang.invoke.LambdaForm$MH/0x00007cabc8778c00.invoke(java.base@21.0.7/LambdaForm$MH)\n\tat java.lang.invoke.Invokers$Holder.invokeExact_MT(java.base@21.0.7/Invokers$Holder)\n\tat jdk.internal.reflect.DirectMethodHandleAccessor.invokeImpl(java.base@21.0.7/DirectMethodHandleAccessor.java:154)\n\tat jdk.internal.reflect.DirectMethodHandleAccessor.invoke(java.base@21.0.7/DirectMethodHandleAccessor.java:103)\n\tat java.lang.reflect.Method.invoke(java.base@21.0.7/Method.java:580)\n\tat io.temporal.internal.sync.POJOWorkflowImplementationFactory$POJOWorkflowImplementation$RootWorkflowInboundCallsInterceptor.execute(POJOWorkflowImplementationFactory.java:406)\n\tat io.temporal.internal.sync.POJOWorkflowImplementationFactory$POJOWorkflowImplementation.execute(POJOWorkflowImplementationFactory.java:354)\n\tat io.temporal.internal.sync.WorkflowExecutionHandler.runWorkflowMethod(WorkflowExecutionHandler.java:51)\n\tat io.temporal.internal.sync.SyncWorkflow.lambda$start$0(SyncWorkflow.java:122)\n\tat io.temporal.internal.sync.SyncWorkflow$$Lambda/0x00007cabc8743860.run(Unknown Source)\n\tat io.temporal.internal.sync.CancellationScopeImpl.run(CancellationScopeImpl.java:99)\n\tat io.temporal.internal.sync.WorkflowThreadImpl$RunnableWrapper.run(WorkflowThreadImpl.java:92)\n\tat io.temporal.worker.ActiveThreadReportingExecutor.lambda$submit$0(ActiveThreadReportingExecutor.java:34)\n\tat io.temporal.worker.ActiveThreadReportingExecutor$$Lambda/0x00007cabc8741dc0.run(Unknown Source)\n\tat java.util.concurrent.Executors$RunnableAdapter.call(java.base@21.0.7/Executors.java:572)\n\tat java.util.concurrent.FutureTask.run$$$capture(java.base@21.0.7/FutureTask.java:317)\n\tat java.util.concurrent.FutureTask.run(java.base@21.0.7/FutureTask.java)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@21.0.7/ThreadPoolExecutor.java:1144)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(java.base@21.0.7/ThreadPoolExecutor.java:642)\n\tat java.lang.Thread.runWith(java.base@21.0.7/Thread.java:1596)\n\tat java.lang.Thread.run(java.base@21.0.7/Thread.java:1583)\n```\n\n\n```\n\"grpc-default-executor-5\" #63 [1712078] daemon prio=5 os_prio=0 cpu=134,75ms elapsed=20,72s tid=0x00007cac5fec8ce0 nid=1712078 waiting on condition  [0x00007cac14e2a000]\n   java.lang.Thread.State: WAITING (parking)\n\tat jdk.internal.misc.Unsafe.park(java.base@21.0.7/Native Method)\n\t- parking to wait for  <0x00000002b9358e08> (a java.util.concurrent.CompletableFuture$Signaller)\n\tat java.util.concurrent.locks.LockSupport.park(java.base@21.0.7/LockSupport.java:221)\n\tat java.util.concurrent.CompletableFuture$Signaller.block(java.base@21.0.7/CompletableFuture.java:1864)\n\tat java.util.concurrent.ForkJoinPool.unmanagedBlock(java.base@21.0.7/ForkJoinPool.java:3780)\n\tat java.util.concurrent.ForkJoinPool.managedBlock(java.base@21.0.7/ForkJoinPool.java:3725)\n\tat java.util.concurrent.CompletableFuture.waitingGet(java.base@21.0.7/CompletableFuture.java:1898)\n\tat java.util.concurrent.CompletableFuture.get(java.base@21.0.7/CompletableFuture.java:2072)\n\tat io.temporal.internal.testservice.TestService.unlockTimeSkippingWhileSleep(TestService.java:126)\n\tat io.temporal.internal.testservice.TestService.unlockTimeSkippingWithSleep(TestService.java:95)\n\tat io.temporal.api.testservice.v1.TestServiceGrpc$MethodHandlers.invoke(TestServiceGrpc.java:747)\n\tat io.grpc.stub.ServerCalls$UnaryServerCallHandler$UnaryServerCallListener.onHalfClose(ServerCalls.java:182)\n\tat io.grpc.PartialForwardingServerCallListener.onHalfClose(PartialForwardingServerCallListener.java:35)\n\tat io.grpc.ForwardingServerCallListener.onHalfClose(ForwardingServerCallListener.java:23)\n\tat io.grpc.internal.ServerCallImpl$ServerStreamListenerImpl.halfClosed(ServerCallImpl.java:351)\n\tat io.grpc.internal.ServerImpl$JumpToApplicationThreadServerStreamListener$1HalfClosed.runInContext(ServerImpl.java:860)\n\tat io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37)\n\tat io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:133)\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@21.0.7/ThreadPoolExecutor.java:1144)\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(java.base@21.0.7/ThreadPoolExecutor.java:642)\n\tat java.lang.Thread.runWith(java.base@21.0.7/Thread.java:1596)\n\tat java.lang.Thread.run(java.base@21.0.7/Thread.java:1583)\n```\n\n\nWhat is interesting is when I comment:\n\n```java\n        CreateCustomerWorkflow createCustomerWorkflow = workflowClient.newWorkflowStub(\n                CreateCustomerWorkflow.class,\n                WorkflowOptions.newBuilder()\n                        .setWorkflowId(CreateCustomerWorkflow.class.getSimpleName() + \"-\" + 1234L)\n                        .setTaskQueue(TemporalSleepBugApplication.TASK_QUEUE)\n                        .build()\n        );\n        WorkflowClient.execute(createCustomerWorkflow::execute, 1234L);\n\n        Thread.sleep(5000); // let previous workflow complete\n```\n\nout and leave only `SubscriberTerminationWorkflow` in test then everything runs fine, without deadlocks.\n\n## Specifications\n\n  - Version: 1.31.0\n  - Platform: n/a\n",
  "closedAt": null,
  "comments": [
    {
      "id": "IC_kwDODN12PM7Hacbk",
      "author": {
        "login": "oleg-kovrizhin-paradym"
      },
      "authorAssociation": "NONE",
      "body": "Looks like the same issue: https://github.com/temporalio/sdk-java/issues/2642",
      "createdAt": "2025-09-29T08:11:43Z",
      "includesCreatedEdit": false,
      "isMinimized": false,
      "minimizedReason": "",
      "reactionGroups": [],
      "url": "https://github.com/temporalio/sdk-java/issues/2670#issuecomment-3345598180",
      "viewerDidAuthor": false
    }
  ],
  "createdAt": "2025-09-25T11:42:26Z",
  "labels": [
    {
      "id": "LA_kwDODN12PM8AAAABzzHCJQ",
      "name": "test server",
      "description": "Related to the test server",
      "color": "A71076"
    }
  ],
  "milestone": null,
  "number": 2670,
  "reactionGroups": [],
  "state": "OPEN",
  "title": "TestWorkflowEnvironment#sleep hangs indefinitely",
  "updatedAt": "2025-09-29T08:11:43Z",
  "url": "https://github.com/temporalio/sdk-java/issues/2670"
}
