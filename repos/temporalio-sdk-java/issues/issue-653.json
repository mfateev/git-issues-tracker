{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"GRPC has a concept of gRPC deadline propagation when an absolute deadline is passed and propagated through chained GRPC calls using thread-local `io.grpc.Context`\r\n\r\nRead more here:\r\nhttps://docs.microsoft.com/en-us/aspnet/core/grpc/deadlines-cancellation?view=aspnetcore-5.0#propagating-deadlines\r\n\r\n`WorkflowExecutionUtils` calculates the Deadline (https://github.com/temporalio/sdk-java/blob/25da5d2064a6c024148e236e060c34d286283b56/temporal-sdk/src/main/java/io/temporal/internal/common/WorkflowExecutionUtils.java#L250-L253) using a timeout value passed as an argument and ignores the fact that the calculated deadline or even the current moment can already be after the absolute Deadline in the context.\r\nGRPC ignores these new deadlines that are later than the current deadline already presented in the GRPC Context: https://github.com/grpc/grpc-java/blob/master/context/src/main/java/io/grpc/Context.java#L316-L320\r\n `GrpcRetryer` doesn't check the fact that the current moment passed the absolute deadline from GRPC Context and continues to calculate the new deadline, make a call, ignore DEADLINE_EXCEEDED happening immediately later in the chain of calls, rinse and repeat.\r\n\r\nThere are two unit tests with the reproduction of this problem.\r\nIn one of the tests the deadline is reached before the workflow completes and we ignore this fact and keep retrying till the workflow is actually finished.\r\nIn another test, the deadline is reached before the workflow is even started and we end up in a cycle of Integer.MAX_VALUE milliseconds of retries (24 days)\r\n\r\nhttps://github.com/Spikhalskiy/java-sdk/commit/d8d21d3b76edf8af7b4f843115e8f57ec1b831b2#diff-41b99c4ace946461232f6ec43784563e243168821f47d1807ae1962e856cfe0fR40","closedAt":"2021-08-24T21:54:12Z","comments":[],"createdAt":"2021-08-20T00:59:51Z","labels":[],"milestone":{"number":3,"title":"v1.3.0","description":"","dueOn":"2021-08-31T00:00:00Z"},"number":653,"reactionGroups":[],"state":"CLOSED","title":"WorkflowExecutionUtils  and GrpcRetryer don't respect reaching deadline from GRPC context and downstream DEADLINE_EXCEEDED exceptions","updatedAt":"2021-08-31T01:48:19Z","url":"https://github.com/temporalio/sdk-java/issues/653"}
