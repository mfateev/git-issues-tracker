{"assignees":[],"author":{"id":"MDQ6VXNlcjQ1MjM5NTU=","is_bot":false,"login":"longquanzheng","name":"Quanzheng Long"},"body":"Hey Temporal team,\r\nWe found that Workflow.getVersion() is letting workflow thread to yield, which causes NonDeterminsticError because the thread execution ordering is changed — this has made it very hard for us to use this getVersion().\r\nImagine we have two threads:\r\n\r\nThreadA:\r\n```\r\n{\r\n    executeActivity(A)\r\n}\r\n```\r\nThreadB\r\n```\r\n{\r\n   Workflow.sleep()\r\n}\r\n```\r\nAnd  thread A is invoked first.\r\nAnd we got a JSON history for replay test. The history looks like this:\r\n```\r\nWF start\r\nWF task scheduled\r\nWF task started\r\nWF task completed\r\nactivity task scheduled\r\ntimer scheduled\r\n```\r\n\r\nThen we are changing thread A to :\r\n```\r\n{\r\n    if( Workflow.getVersion() >= X ){\r\n        executeActivity(B)\r\n    }\r\n    executeActivity(A)\r\n}\r\n```\r\nThen the replay test gets broken.\r\nBecause the thread A will yield at Workflow.getVersion() and thread B will then try to schedule before the activity A.\r\nIn Java SDK, it’s enforcing the eventId to be exactly matched with the history. So the replay test would run into NDE error.\r\n\r\nSome thoughts to improve:\r\nI think GoSDK is only forcing within a workflow task completed batch commands. This may be more reasonable because I don’t think the order really matter within a workflow task results.\r\nOr if we could do special case in Workflow.getVersion() to let it not yield the current thread…\r\n\r\n\r\n\r\n## To reproduce\r\n```\r\npublic void anyWorklfowMethod(){\r\n         Async.procedure( ()->{ \r\n             Workflow.sleep(1s)\r\n         }   \r\n         )\r\n         activityStub.hello()      \r\n}\r\n```\r\nGot a history for replay\r\nThen change the code to:\r\n```\r\npublic void anyWorklfowMethod(){\r\n         Async.procedure( ()->{ \r\n                 Workflow.sleep(1s)\r\n             }   \r\n         )\r\n         Workflow.getVersion(\"changeId, Workflow.DefaultVersion, 1) \r\n         activityStub.hello()      \r\n}\r\n```\r\nAnd this should break the replay test\r\n\r\n","closedAt":"2023-07-17T17:48:32Z","comments":[{"id":"IC_kwDODN12PM5KWaLj","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Which version of java-sdk are we talking about?\r\nCan you provide original histories and related pieces of code or a reproduction?","createdAt":"2022-09-14T23:07:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1430#issuecomment-1247388387","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5KWbDp","author":{"login":"longquanzheng"},"authorAssociation":"NONE","body":"> Which version of java-sdk are we talking about? Can you provide original histories and related pieces of code or a reproduction?\r\n\r\nThese are the versions we are using:\r\n```\r\nio.temporal:temporal-opentracing=1.13.0\r\nio.temporal:temporal-sdk=1.13.0\r\nio.temporal:temporal-serviceclient=1.13.0\r\nio.temporal:temporal-test-server=1.13.0\r\nio.temporal:temporal-testing=1.13.0\r\n```\r\n\r\n","createdAt":"2022-09-14T23:13:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1430#issuecomment-1247391977","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5KWebF","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Confirm. State machine bug.\r\nIt's happening here:\r\nhttps://github.com/temporalio/sdk-java/blob/0ab17d8d913088340a5d8fca61aca06c021f85a1/temporal-sdk/src/main/java/io/temporal/internal/sync/SyncWorkflowContext.java#L678\r\n\r\nIt needs a very careful and probably very ugly fix to keep it backwards compatible.\r\nOnly replay shouldn't yield and ONLY if the actual version from history is default, which means that the original execution didn't have this call.\r\n\r\nIf we just fix it \"right\" and make getVersion not yielding, we will break existing histories generated by yielding version.","createdAt":"2022-09-14T23:40:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1430#issuecomment-1247405765","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5KWoNy","author":{"login":"longquanzheng"},"authorAssociation":"NONE","body":"> Confirm. State machine bug. It's happening here:\r\n> \r\n> https://github.com/temporalio/sdk-java/blob/0ab17d8d913088340a5d8fca61aca06c021f85a1/temporal-sdk/src/main/java/io/temporal/internal/sync/SyncWorkflowContext.java#L678\r\n> \r\n> It needs a very careful and probably very ugly fix to keep it backwards compatible. Only replay shouldn't yield and ONLY if the actual version from history is default, which means that the original execution didn't have this call.\r\n> \r\n> If we just fix it \"right\" and make getVersion not yielding, we will break existing histories generated by yielding version.\r\n\r\nJust an idea. We could add a new field in workflow task started/completed to store some metadata of the sdk for the first workflow task of the workflow. Use the meta data (eg the sdk version) to decide the new behavior . \r\n\r\nThis new field can be generic to solve many future problems as well","createdAt":"2022-09-15T00:51:48Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1430#issuecomment-1247445874","viewerDidAuthor":false}],"createdAt":"2022-09-14T23:00:41Z","labels":[],"milestone":null,"number":1430,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"Workflow.getVersion() could cause NonDeterminsticError with multithreading + timer","updatedAt":"2023-07-17T17:48:32Z","url":"https://github.com/temporalio/sdk-java/issues/1430"}
