{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0},{"id":"MDQ6VXNlcjIwNTI3OTk5","login":"vkoby","name":"Vera","databaseId":0}],"author":{"id":"MDQ6VXNlcjEyMTE3OTIz","is_bot":false,"login":"rubyhfu","name":""},"body":"## Expected Behavior\r\nShould be able to set workflowExecutionTimeout on the workflow options as is the case outside of test environment \r\n\r\n## Actual Behavior\r\nTest hangs\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. WorkflowInterface\r\n\r\n```\r\nimport io.temporal.workflow.SignalMethod;\r\nimport io.temporal.workflow.WorkflowInterface;\r\nimport io.temporal.workflow.WorkflowMethod;\r\n\r\n@WorkflowInterface\r\npublic interface ExampleWorkflow {\r\n\r\n    @WorkflowMethod\r\n    public String execute(String s);\r\n\r\n    @SignalMethod\r\n    public void signal(boolean s);\r\n}\r\n\r\n```\r\n  2. WorkflowImpl1\r\n \r\n```\r\nimport java.time.Duration;\r\nimport io.temporal.workflow.Workflow;\r\n\r\npublic class ExampleWorkflowImpl implements ExampleWorkflow{\r\n    private boolean signal = false;\r\n\r\n    @Override\r\n    public String execute(String s) {\r\n        Workflow.await(Duration.ofMinutes(5L), () -> signal);\r\n        Workflow.sleep(Duration.ofMinutes(10L));\r\n        return s;\r\n    }\r\n\r\n    @Override\r\n    public void signal(boolean signal) {\r\n        this.signal = signal;\r\n    }\r\n}\r\n```\r\n  3. Run second test in test class\r\n \r\n```\r\npublic class ExampleWorkflowImplTest {\r\n    private TestWorkflowEnvironment testEnv;\r\n    private Worker worker1, worker2;\r\n    private WorkflowClient client;\r\n\r\n    @BeforeEach\r\n    public void setUp() {\r\n        testEnv = TestWorkflowEnvironment.newInstance();\r\n        worker1 = testEnv.newWorker(\"TEST_QUEUE1\");\r\n        worker2 = testEnv.newWorker(\"TEST_QUEUE2\");\r\n        worker1.registerWorkflowImplementationTypes(ExampleWorkflowImpl.class);\r\n        worker2.registerWorkflowImplementationTypes(ExampleWorkflow2Impl.class);\r\n        client = testEnv.getWorkflowClient();\r\n        testEnv.start();\r\n    }\r\n\r\n    @Test\r\n    public void testTerminateWorkflowSignalError() {\r\n        ExampleWorkflow workflow1 = client.newWorkflowStub(\r\n                ExampleWorkflow.class,\r\n                WorkflowOptions.newBuilder()\r\n                        .setWorkflowId(\"abc123\")\r\n                        .setTaskQueue(\"TEST_QUEUE1\")\r\n                        .build());\r\n\r\n        ExampleWorkflow workflow2 = client.newWorkflowStub(\r\n                ExampleWorkflow.class,\r\n                WorkflowOptions.newBuilder()\r\n                        .setTaskQueue(\"TEST_QUEUE2\")\r\n                        .build());\r\n\r\n        WorkflowExecution workflow1Execution = WorkflowClient.start(workflow1::execute, \"test\");\r\n\r\n        testEnv.sleep(Duration.ofMinutes(6L));\r\n\r\n        WorkflowExecution workflow2Execution = WorkflowClient.start(workflow2::execute, \"test\");\r\n        WorkflowStub workflowStub1 = WorkflowStub.fromTyped(workflow1);\r\n        workflowStub1.terminate(\"Mock terminating workflow\");\r\n\r\n        WorkflowStub workflowStub2 = WorkflowStub.fromTyped(workflow2);\r\n        workflowStub2.getResult(String.class);\r\n    }\r\n\r\n    @Test\r\n    public void testSetWorkflowExecutionTimeoutHangs() {\r\n        ExampleWorkflow workflow = client.newWorkflowStub(\r\n                ExampleWorkflow.class,\r\n                WorkflowOptions.newBuilder()\r\n                        // setting this makes the test hang... this normally works outside of TestWorkflowEnv\r\n                        .setWorkflowExecutionTimeout(Duration.ofSeconds(10))\r\n                        .setTaskQueue(\"TEST_QUEUE1\")\r\n                        .build());\r\n\r\n        WorkflowExecution workflowExecution = WorkflowClient.start(workflow::execute, \"test\");\r\n\r\n        // workflow execution timeout seems to clash with testEnv.sleep\r\n        testEnv.sleep(Duration.ofMinutes(5L));\r\n\r\n        WorkflowStub workflowStub = WorkflowStub.fromTyped(workflow);\r\n        String result = workflowStub.getResult(String.class);\r\n    }\r\n\r\n    @Test\r\n    public void testTestEnvSecondTimerSkipped() {\r\n        ExampleWorkflow workflow = client.newWorkflowStub(\r\n                ExampleWorkflow.class,\r\n                WorkflowOptions.newBuilder()\r\n                        .setTaskQueue(\"TEST_QUEUE1\")\r\n                        .build());\r\n\r\n        WorkflowExecution workflowExecution = WorkflowClient.start(workflow::execute, \"test\");\r\n\r\n        testEnv.sleep(Duration.ofMinutes(5L));\r\n\r\n        WorkflowStub workflowStub = WorkflowStub.fromTyped(workflow);\r\n        String result = workflowStub.getResult(String.class);\r\n        // why is this able to get past 2nd 10min-timer immediately without moving testEnv time further?\r\n        System.out.println(result);\r\n    }\r\n}\r\n\r\n```\r\n## Specifications\r\n\r\n  - Version: sdk 1.0.0, junit 5\r\n  - Platform: MacOS BigSur\r\n","closedAt":"2021-07-22T00:55:47Z","comments":[],"createdAt":"2021-07-07T03:52:45Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":577,"reactionGroups":[],"state":"CLOSED","title":"TestEnv: using workflowExecutionTimeout with testEnv.sleep() makes the test hang","updatedAt":"2021-07-22T00:55:47Z","url":"https://github.com/temporalio/sdk-java/issues/577"}
