{"assignees":[],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"# Actual Behavior\r\n\r\nWorkflowExecutionUtils#getInstanceCloseEvent is implemented in a way that could get into an infinite loop after a timeout.\r\n\r\n`WorkflowExecutionUtils#getInstanceCloseEvent` has the following simplified implementation:\r\n\r\n```\r\nGetWorkflowExecutionHistoryResponse response = null;\r\nlong start = System.currentTimeMillis();\r\ndo {\r\n      long elapsed = System.currentTimeMillis() - start;\r\n      long expiration = unit.toMillis(timeout) - elapsed;\r\n      if (expiration > 0) {\r\n        response = ...\r\n      }\r\n      if (response == null || !response.hasHistory()) {\r\n          //if we are here and it's a timeout - we will never return from this cycle, we will never get to the following timeout check\r\n          continue;\r\n      }\r\n      if (timeout != 0 && System.currentTimeMillis() - start > unit.toMillis(timeout)) {throw new TimeoutException(...);}\r\n      ...\r\n      }\r\n    } while (true);\r\n```\r\n\r\nThis simplified structure shows that if we got an empty response and we used up our allocated timeout - we can fall into an infinite `continue` loop which never will enforce the timeout.\r\n\r\nI found investigating an incident when after a network blip some temporal stubs stuck into \"retries\" of WorkflowExecutionUtils#getInstanceCloseEvent performed every 1ms\r\n","closedAt":"2021-05-07T16:22:58Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDgzNDU5MTEzMA==","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Fixed in #472","createdAt":"2021-05-07T16:22:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/471#issuecomment-834591130","viewerDidAuthor":false}],"createdAt":"2021-05-07T04:39:58Z","labels":[],"milestone":null,"number":471,"reactionGroups":[],"state":"CLOSED","title":"WorkflowExecutionUtils#getInstanceCloseEvent could get into infinite loop after timeout","updatedAt":"2021-05-07T16:22:58Z","url":"https://github.com/temporalio/sdk-java/issues/471"}
