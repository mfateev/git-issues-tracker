{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNTA0MDQ5","is_bot":false,"login":"Quinn-With-Two-Ns","name":"Quinn Klassen"},"body":"## Issue\r\n\r\nWhen executing workflow tasks with local activities `LocalActivityMeteringHelper` may attempt to make illegal modifications to its underlying data structure when calling `newWFTStarting` causing a `ConcurrentModificationException`\r\n\r\n## Example: \r\n```\r\njava.util.ConcurrentModificationException: null\r\n\tat java.base/java.util.HashMap$HashIterator.nextNode(HashMap.java:1605)\r\n\tat java.base/java.util.HashMap$KeyIterator.next(HashMap.java:1628)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler$LocalActivityMeteringHelper.newWFTStarting(ReplayWorkflowRunTaskHandler.java:431)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler$LocalActivityMeteringHelper.access$200(ReplayWorkflowRunTaskHandler.java:425)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:143)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithQuery(ReplayWorkflowTaskHandler.java:133)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:98)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handleTask(WorkflowWorker.java:413)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:320)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:261)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:105)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)\r\n\tat java.base/java.lang.Thread.run(Thread.java:1583)\r\n```\r\n\r\nhttps://community.temporal.io/t/concurrent-modification-exception-when-executing-workflow/12479/1\r\n\r\n## Specifications\r\n\r\n  - Platform: 1.23.1\r\n","closedAt":"2024-06-13T07:03:15Z","comments":[],"createdAt":"2024-06-12T21:24:21Z","labels":[],"milestone":null,"number":2107,"reactionGroups":[],"state":"CLOSED","title":"Concurrent Modification Exception when executing workflow with local activities","updatedAt":"2024-06-13T07:03:15Z","url":"https://github.com/temporalio/sdk-java/issues/2107"}
