{"assignees":[],"author":{"id":"MDQ6VXNlcjE2MDk2ODU=","is_bot":false,"login":"mostafacs","name":"Mostafa"},"body":"Last two months I learned temporal and changed my background jobs to use temporal and it so slink and fast and fix many issues for me because of the long-running workflows. \r\n\r\nGraalVm native image has many features like reduce memory and the start time of apps. \r\n\r\nIs it possible to support native image build?\r\n\r\n","closedAt":"2023-02-21T15:54:12Z","comments":[{"id":"IC_kwDODN12PM5Vizva","author":{"login":"averri"},"authorAssociation":"NONE","body":"Is this completed? I didn't find any Java SDK to use with native GraalVm.","createdAt":"2023-02-17T20:09:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/295#issuecomment-1435188186","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5Vi7NS","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"@averri No, it's not. \r\n\r\nWe actually do have native-image descriptors for the test server here: \r\nhttps://github.com/temporalio/sdk-java/tree/15df866f9c91219f6cf61533aee8fc2139ad7c93/temporal-test-server/src/main/resources/META-INF/native-image/io.temporal/temporal-test-server\r\nOur test server depends on java-sdk and uses some pieces of it. But I don't know if they are enough or not for a full java-sdk. They may be, but they are likely not.\r\nIf you work with Graal and want to embed java-sdk in the native image, these descriptors may be a great start. Also if you develop your own java-sdk descriptors and wish to upstream them, we will be happy to accept this contribution.","createdAt":"2023-02-17T20:15:43Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/295#issuecomment-1435218770","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5Vi8D-","author":{"login":"averri"},"authorAssociation":"NONE","body":"Hi @Spikhalskiy, thanks for informing that.\r\n\r\nThese are the issues related to using the Java SDK when building native images on Graalvm, happen at build time:\r\n\r\n```\r\nError: Classes that should be initialized at run time got initialized during image building:\r\n io.grpc.netty.shaded.io.netty.buffer.UnpooledDirectByteBuf the class was requested to be initialized at run time (subtype of io.grpc.netty.shaded.io.netty.buffer.AbstractReferenceCountedByteBuf). To see why io.grpc.netty.shaded.io.netty.buffer.UnpooledDirectByteBuf got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.buffer.UnpooledDirectByteBuf\r\nio.grpc.netty.shaded.io.netty.buffer.UnpooledByteBufAllocator$InstrumentedUnpooledUnsafeDirectByteBuf the class was requested to be initialized at run time (subtype of io.grpc.netty.shaded.io.netty.buffer.AbstractReferenceCountedByteBuf). To see why io.grpc.netty.shaded.io.netty.buffer.UnpooledByteBufAllocator$InstrumentedUnpooledUnsafeDirectByteBuf got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.buffer.UnpooledByteBufAllocator$InstrumentedUnpooledUnsafeDirectByteBuf\r\nio.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator the class was requested to be initialized at run time (from 'META-INF/native-image/io.grpc.netty.shaded.io.netty/buffer/native-image.properties' in 'file:///home/app/libs/grpc-netty-shaded-1.53.0.jar' with 'io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator'). To see why io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator\r\nio.grpc.netty.shaded.io.netty.util.AbstractReferenceCounted the class was requested to be initialized at run time (from 'META-INF/native-image/io.grpc.netty.shaded.io.netty/common/native-image.properties' in 'file:///home/app/libs/grpc-netty-shaded-1.53.0.jar' with 'io.grpc.netty.shaded.io.netty.util.AbstractReferenceCounted'). To see why io.grpc.netty.shaded.io.netty.util.AbstractReferenceCounted got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.util.AbstractReferenceCounted\r\nio.grpc.netty.shaded.io.netty.buffer.ByteBufAllocator the class was requested to be initialized at run time (from 'META-INF/native-image/io.grpc.netty.shaded.io.netty/buffer/native-image.properties' in 'file:///home/app/libs/grpc-netty-shaded-1.53.0.jar' with 'io.grpc.netty.shaded.io.netty.buffer.ByteBufAllocator'). To see why io.grpc.netty.shaded.io.netty.buffer.ByteBufAllocator got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.buffer.ByteBufAllocator\r\nio.grpc.netty.shaded.io.netty.buffer.PooledByteBuf the class was requested to be initialized at run time (subtype of io.grpc.netty.shaded.io.netty.buffer.AbstractReferenceCountedByteBuf). To see why io.grpc.netty.shaded.io.netty.buffer.PooledByteBuf got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.buffer.PooledByteBuf\r\nio.grpc.netty.shaded.io.netty.buffer.UnpooledHeapByteBuf the class was requested to be initialized at run time (subtype of io.grpc.netty.shaded.io.netty.buffer.AbstractReferenceCountedByteBuf). To see why io.grpc.netty.shaded.io.netty.buffer.UnpooledHeapByteBuf got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.buffer.UnpooledHeapByteBuf\r\nio.grpc.netty.shaded.io.netty.handler.ssl.PemPrivateKey the class was requested to be initialized at run time (subtype of io.grpc.netty.shaded.io.netty.util.AbstractReferenceCounted). To see why io.grpc.netty.shaded.io.netty.handler.ssl.PemPrivateKey got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.handler.ssl.PemPrivateKey\r\nio.grpc.netty.shaded.io.netty.handler.ssl.PemValue the class was requested to be initialized at run time (subtype of io.grpc.netty.shaded.io.netty.util.AbstractReferenceCounted). To see why io.grpc.netty.shaded.io.netty.handler.ssl.PemValue got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.handler.ssl.PemValue\r\nio.grpc.netty.shaded.io.netty.buffer.PooledSlicedByteBuf the class was requested to be initialized at run time (subtype of io.grpc.netty.shaded.io.netty.buffer.AbstractReferenceCountedByteBuf). To see why io.grpc.netty.shaded.io.netty.buffer.PooledSlicedByteBuf got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.buffer.PooledSlicedByteBuf\r\nio.grpc.netty.shaded.io.netty.buffer.AbstractReferenceCountedByteBuf the class was requested to be initialized at run time (from 'META-INF/native-image/io.grpc.netty.shaded.io.netty/buffer/native-image.properties' in 'file:///home/app/libs/grpc-netty-shaded-1.53.0.jar' with 'io.grpc.netty.shaded.io.netty.buffer.AbstractReferenceCountedByteBuf'). To see why io.grpc.netty.shaded.io.netty.buffer.AbstractReferenceCountedByteBuf got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.buffer.AbstractReferenceCountedByteBuf\r\nio.grpc.netty.shaded.io.netty.buffer.ByteBufUtil the class was requested to be initialized at run time (from 'META-INF/native-image/io.grpc.netty.shaded.io.netty/buffer/native-image.properties' in 'file:///home/app/libs/grpc-netty-shaded-1.53.0.jar' with 'io.grpc.netty.shaded.io.netty.buffer.ByteBufUtil'). To see why io.grpc.netty.shaded.io.netty.buffer.ByteBufUtil got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.buffer.ByteBufUtil\r\nio.grpc.netty.shaded.io.netty.buffer.UnpooledUnsafeDirectByteBuf the class was requested to be initialized at run time (subtype of io.grpc.netty.shaded.io.netty.buffer.AbstractReferenceCountedByteBuf). To see why io.grpc.netty.shaded.io.netty.buffer.UnpooledUnsafeDirectByteBuf got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.buffer.UnpooledUnsafeDirectByteBuf\r\nio.grpc.netty.shaded.io.netty.buffer.PooledUnsafeDirectByteBuf the class was requested to be initialized at run time (subtype of io.grpc.netty.shaded.io.netty.buffer.AbstractReferenceCountedByteBuf). To see why io.grpc.netty.shaded.io.netty.buffer.PooledUnsafeDirectByteBuf got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.buffer.PooledUnsafeDirectByteBuf\r\nio.grpc.netty.shaded.io.netty.buffer.AbstractPooledDerivedByteBuf the class was requested to be initialized at run time (subtype of io.grpc.netty.shaded.io.netty.buffer.AbstractReferenceCountedByteBuf). To see why io.grpc.netty.shaded.io.netty.buffer.AbstractPooledDerivedByteBuf got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.buffer.AbstractPooledDerivedByteBuf\r\nTo see how the classes got initialized, use --trace-class-initialization=io.grpc.netty.shaded.io.netty.buffer.UnpooledDirectByteBuf,io.grpc.netty.shaded.io.netty.buffer.UnpooledByteBufAllocator$InstrumentedUnpooledUnsafeDirectByteBuf,io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator,io.grpc.netty.shaded.io.netty.util.AbstractReferenceCounted,io.grpc.netty.shaded.io.netty.buffer.ByteBufAllocator,io.grpc.netty.shaded.io.netty.buffer.PooledByteBuf,io.grpc.netty.shaded.io.netty.buffer.UnpooledHeapByteBuf,io.grpc.netty.shaded.io.netty.handler.ssl.PemPrivateKey,io.grpc.netty.shaded.io.netty.handler.ssl.PemValue,io.grpc.netty.shaded.io.netty.buffer.PooledSlicedByteBuf,io.grpc.netty.shaded.io.netty.buffer.AbstractReferenceCountedByteBuf,io.grpc.netty.shaded.io.netty.buffer.ByteBufUtil,io.grpc.netty.shaded.io.netty.buffer.UnpooledUnsafeDirectByteBuf,io.grpc.netty.shaded.io.netty.buffer.PooledUnsafeDirectByteBuf,io.grpc.netty.shaded.io.netty.buffer.AbstractPooledDerivedByteBuf\r\nError: Use -H:+ReportExceptionStackTraces to print stacktrace of underlying exception\r\n``` \r\n\r\nAll of them are related to the `io.grpc.netty.shaded` package. \r\n\r\nI have read some of the native descriptors you mentioned above, it seems they try to fix the errors I mentioned. I'll try later and update here.","createdAt":"2023-02-17T20:19:32Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/295#issuecomment-1435222270","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5Vi9e0","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"@averri \r\nThis specific issue is most likely resolved in the test server descriptors I referenced earlier:\r\nhttps://github.com/temporalio/sdk-java/blob/cd33a808caa16f94838697e27991de7ef3577ec0/temporal-test-server/src/main/resources/META-INF/native-image/io.temporal/temporal-test-server/native-image.properties#L23\r\n\r\nTake what we already have as a starting point. I don't promise it will resolve all the issues, but it will bring you closer to the result.\r\n\r\nAlso, this Readme segment may be of use to you https://github.com/temporalio/sdk-java/blob/fd701f8903000c57feafb5db0d26487ce6e2681e/temporal-test-server/README.md#graalvm-native-image-configuration if you just start with native-image. \r\nI believe their documentation wasn't too vocal about this approach and it saves a lot of time.","createdAt":"2023-02-17T20:25:31Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/295#issuecomment-1435228084","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5VjDb2","author":{"login":"averri"},"authorAssociation":"NONE","body":"@Spikhalskiy, I have tested the descriptors, it has resolved all of the issues, except one:\r\n\r\n```\r\nError: Classes that should be initialized at run time got initialized during image building:\r\n io.grpc.netty.shaded.io.netty.util.internal.logging.Slf4JLoggerFactory$NopInstanceHolder the class was requested to be initialized at run time (from 'META-INF/native-image/io.grpc/grpc-netty-shaded/native-image.properties' in 'file:///home/app/resources/' with 'io.grpc.netty.shaded.io.netty.util.internal.logging.Slf4JLoggerFactory$NopInstanceHolder'). To see why io.grpc.netty.shaded.io.netty.util.internal.logging.Slf4JLoggerFactory$NopInstanceHolder got initialized use --trace-class-initialization=io.grpc.netty.shaded.io.netty.util.internal.logging.Slf4JLoggerFactory$NopInstanceHolder\r\nTo see how the classes got initialized, use --trace-class-initialization=io.grpc.netty.shaded.io.netty.util.internal.logging.Slf4JLoggerFactory$NopInstanceHolder\r\nError: Use -H:+ReportExceptionStackTraces to print stacktrace of underlying exception```","createdAt":"2023-02-17T20:51:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/295#issuecomment-1435252470","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5VjKuE","author":{"login":"averri"},"authorAssociation":"NONE","body":"Hi @Spikhalskiy, I have run the application with the GraalVM tracing enabled, and that generated the required descriptors. Now I can use the Temporal Java SDK with native GraalVM. Cool! \r\n\r\nThank you for your hints. ","createdAt":"2023-02-17T21:22:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/295#issuecomment-1435282308","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5VjK_t","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"@averri That's great. Please feel free to share the changes you had to make (or just the final descriptors) if you don't mind!","createdAt":"2023-02-17T21:23:39Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/295#issuecomment-1435283437","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5VjLmr","author":{"login":"averri"},"authorAssociation":"NONE","body":"Sure thing. I was about to do that. I see that the tracing has added lots of other classes from my application, I'll remove them and leave just the ones related to Temporal SDK dependencies.","createdAt":"2023-02-17T21:26:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/295#issuecomment-1435285931","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5Vjtgs","author":{"login":"averri"},"authorAssociation":"NONE","body":"I'm attaching here the complete descriptors, including extra classes from my application. It needs some cleaning, leaving only the relevant parts, like the package `io.grpc.netty.shaded` and other ones required by Temporal. I'll do the cleaning later and test again, trying to determine the minimum configuration that allows Temporal Java SDK client to work with a native binary. \r\n\r\nI think the ideal solution would be to configure a continuous integration job in the repo `/temporalio/sdk-java` to run the tracing during the automated tests, and update the `native-image` directory with the results automatically. \r\n\r\nI'm using the Maven artifact `io.temporal:temporal-sdk:1.18.1`.\r\n\r\n[META-INF.zip](https://github.com/temporalio/sdk-java/files/10772556/META-INF.zip)\r\n\r\nThe performance of a Java application running on a native image is super impressive.\r\n","createdAt":"2023-02-18T00:37:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/295#issuecomment-1435424812","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5VjtrO","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"@averri Appreciate it. And don't worry, I can do the cleaning myself and I will compare it with what we have currently to make sure it all makes sense for java-sdk. Thank you!\r\n\r\n> The performance of a Java application running on a native image is super impressive.\r\n\r\nYou just need to give the normal JVM time to heat up and do all the JIT and other optimizations for a fair comparison ;)","createdAt":"2023-02-18T00:39:25Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/295#issuecomment-1435425486","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5XRSPE","author":{"login":"carlosedp"},"authorAssociation":"NONE","body":"Thanks for this @averri ... I was battling thru making my small app work with native-image and found your package. It was a total pain finding all required configs.\r\n\r\nThe missing piece for me was:\r\n\r\n```\r\n  {\r\n    \"interfaces\": [\r\n      \"EchoWorkflow\",\r\n      \"io.temporal.internal.sync.StubMarker\"\r\n    ]\r\n  }\r\n```\r\n\r\non `proxy-config.json`. \r\n\r\nI wonder if there is a way to dynamically add my workflows to this or maybe I'll make a script that does this automatically.","createdAt":"2023-03-10T17:42:07Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/295#issuecomment-1464148932","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5XRTPy","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"@carlosedp we can't generate these descriptors for all user classes obviously (`EchoWorkflow` is not Temporal java-sdk class), so users will need to provide the native-image proxy descriptors for their own classes. \r\nI added [the info about the least painful way for users to approach it](https://github.com/temporalio/sdk-java/blob/7c534738163d6a02ce38a33815ce72a64564fecb/docs/AOT-native-image.md#native-image) to our docs with relevant links.","createdAt":"2023-03-10T17:45:41Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/295#issuecomment-1464153074","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5XRUQo","author":{"login":"carlosedp"},"authorAssociation":"NONE","body":"Thanks Dmitry, I didn't knew about the tracing agent... will look into it!","createdAt":"2023-03-10T17:49:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/295#issuecomment-1464157224","viewerDidAuthor":false}],"createdAt":"2021-01-08T03:00:53Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQ0","name":"enhancement","description":"User experience","color":"a2eeef"}],"milestone":null,"number":295,"reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"state":"CLOSED","title":"Native image descriptor for GraalVM","updatedAt":"2023-03-10T17:49:19Z","url":"https://github.com/temporalio/sdk-java/issues/295"}
