{"assignees":[],"author":{"id":"MDQ6VXNlcjIyOTcx","is_bot":false,"login":"rburgst","name":""},"body":"## Expected Behavior\r\nI have a workflow that schedules activities with 5 elements to process, on every iteration of the 5 elements, I remove the currently processed row and update the heartbeat with the remaining elements, therefore, we call heartbeat with\r\n\r\n1. hearbeat (remaining = 4)\r\n2. hearbeat(remaining = 3)\r\n3. heartbeat(remaining=2)\r\n4. heartbeat(remaining=1)\r\n\r\nIf I throw an exception in the 4th iteration, then I would expect a retry that calls me with the remaining 1 elements\r\n\r\n## Actual Behavior\r\n\r\nhowever, I am called with remaining 4)\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. define an activity as follows\r\n\r\n```java\r\npackage io.temporal.samples.springboot.propagation;\r\n\r\nimport io.temporal.activity.Activity;\r\nimport io.temporal.activity.ActivityExecutionContext;\r\nimport io.temporal.spring.boot.ActivityImpl;\r\nimport lombok.AllArgsConstructor;\r\nimport lombok.NoArgsConstructor;\r\nimport org.slf4j.Logger;\r\nimport org.slf4j.LoggerFactory;\r\nimport org.springframework.stereotype.Component;\r\n\r\nimport java.util.*;\r\n\r\nimport static io.temporal.samples.springboot.propagation.ChunkedWorkflow.*;\r\n\r\n@Component\r\n@ActivityImpl(taskQueues = \"RowTaskQueue\")\r\npublic class ChunkProcessingActivityImpl implements ChunkProcessingActivity {\r\n    private static final Logger log = LoggerFactory.getLogger(ChunkProcessingActivityImpl.class);\r\n\r\n    @AllArgsConstructor\r\n    @NoArgsConstructor\r\n    public static final class HeartbeatData {\r\n        List<String> remaining;\r\n        ProcessingResult progressSoFar;\r\n    }\r\n\r\n    @Override\r\n    public ProcessingResult processRows(List<String> rowId) {\r\n\r\n        ActivityExecutionContext context = Activity.getExecutionContext();\r\n        Optional<HeartbeatData> heartbeatDetails = context.getHeartbeatDetails(HeartbeatData.class);\r\n\r\n        ProcessingResult result =\r\n                new ProcessingResult();\r\n        result.rowsRead = 0;\r\n        result.rowsWritten = 0;\r\n\r\n        HeartbeatData heartbeatData = heartbeatDetails.orElse(new HeartbeatData(rowId, result));\r\n        List<String> remainingUuids = heartbeatData.remaining;\r\n        result = heartbeatData.progressSoFar;\r\n        log.info(\"propagating {}, heartbeat {}, rows {}\", remainingUuids.size(), heartbeatDetails, remainingUuids);\r\n\r\n        int index = 0;\r\n\r\n        List<String> newRemaining = new ArrayList<>(remainingUuids);\r\n        for (String uuid : remainingUuids) {\r\n            if (index == 4) {\r\n                throw new RuntimeException(\"foo error for uuid \" + uuid);\r\n            }\r\n            newRemaining.remove(uuid);\r\n            ProcessingResult innerResult = processSingleRow(UUID.fromString(uuid));\r\n            log.info(\"   sending heartbeat with remaining {}, {}\", newRemaining.size(), newRemaining);\r\n            result.rowsRead += innerResult.rowsRead;\r\n            result.rowsWritten += innerResult.rowsWritten;\r\n            result.rowsProcessed.addAll(innerResult.rowsProcessed);\r\n            context.heartbeat(new HeartbeatData(newRemaining, result));\r\n            index++;\r\n        }\r\n        log.info(\"processing {} rows {} … done\", remainingUuids.size(), remainingUuids);\r\n        log.info(\"processing result {}\", result);\r\n\r\n\r\n        return result;\r\n    }\r\n\r\n    private ProcessingResult processSingleRow(UUID uuid) {\r\n\r\n        ProcessingResult result =\r\n                new ProcessingResult();\r\n        result.rowsRead = 1;\r\n        result.rowsWritten = 1;\r\n        log.info(\"processing single row {}\", uuid);\r\n        result.addRowId(uuid.toString());\r\n        return result;\r\n    }\r\n}\r\n```\r\n\r\n  2. start the server with `gradle bootRun`\r\n  3. on the hello world page, start the job\r\n  4. watch the spring boot log\r\n\r\n```\r\n2024-01-06T20:17:15.028+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    : propagating 5, heartbeat Optional.empty, rows [4ab57ee9-0daf-4e46-a6de-1e0643daeec1, 557d0cb6-e9a9-4a57-a8d7-d261a2bc90fd, 1350507c-4126-4a0a-868d-d0a96e90c744, b61a2443-5b5a-4888-bc37-f3e504340e77, 56115510-3c5c-4bc8-ae77-e206bdf9f4fb]\r\n2024-01-06T20:17:15.028+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    : processing single row 4ab57ee9-0daf-4e46-a6de-1e0643daeec1\r\n2024-01-06T20:17:15.028+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    :    sending heartbeat with remaining 4, [557d0cb6-e9a9-4a57-a8d7-d261a2bc90fd, 1350507c-4126-4a0a-868d-d0a96e90c744, b61a2443-5b5a-4888-bc37-f3e504340e77, 56115510-3c5c-4bc8-ae77-e206bdf9f4fb]\r\n2024-01-06T20:17:15.049+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    : processing single row 557d0cb6-e9a9-4a57-a8d7-d261a2bc90fd\r\n2024-01-06T20:17:15.049+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    :    sending heartbeat with remaining 3, [1350507c-4126-4a0a-868d-d0a96e90c744, b61a2443-5b5a-4888-bc37-f3e504340e77, 56115510-3c5c-4bc8-ae77-e206bdf9f4fb]\r\n2024-01-06T20:17:15.049+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    : processing single row 1350507c-4126-4a0a-868d-d0a96e90c744\r\n2024-01-06T20:17:15.049+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    :    sending heartbeat with remaining 2, [b61a2443-5b5a-4888-bc37-f3e504340e77, 56115510-3c5c-4bc8-ae77-e206bdf9f4fb]\r\n2024-01-06T20:17:15.049+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    : processing single row b61a2443-5b5a-4888-bc37-f3e504340e77\r\n2024-01-06T20:17:15.049+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    :    sending heartbeat with remaining 1, [56115510-3c5c-4bc8-ae77-e206bdf9f4fb]\r\n2024-01-06T20:17:15.049+01:00  WARN 4593 --- [temporal-samples] [ce=\"default\": 1] tivityTaskExecutors$ActivityTaskExecutor : Activity failure. ActivityId=646434e9-72c7-313a-8301-214499ef42ea, activityType=ProcessRows, attempt=1\r\n\r\njava.lang.RuntimeException: foo error for uuid 56115510-3c5c-4bc8-ae77-e206bdf9f4fb\r\n\tat io.temporal.samples.springboot.propagation.ChunkProcessingActivityImpl.processRows(ChunkProcessingActivityImpl.java:68) ~[main/:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:na]\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:568) ~[na:na]\r\n\tat io.temporal.internal.activity.RootActivityInboundCallsInterceptor$POJOActivityInboundCallsInterceptor.executeActivity(RootActivityInboundCallsInterceptor.java:64) ~[temporal-sdk-1.22.2.jar:na]\r\n\tat io.temporal.internal.activity.RootActivityInboundCallsInterceptor.execute(RootActivityInboundCallsInterceptor.java:43) ~[temporal-sdk-1.22.2.jar:na]\r\n\tat io.temporal.internal.activity.ActivityTaskExecutors$BaseActivityTaskExecutor.execute(ActivityTaskExecutors.java:107) ~[temporal-sdk-1.22.2.jar:na]\r\n\tat io.temporal.internal.activity.ActivityTaskHandlerImpl.handle(ActivityTaskHandlerImpl.java:124) ~[temporal-sdk-1.22.2.jar:na]\r\n\tat io.temporal.internal.worker.ActivityWorker$TaskHandlerImpl.handleActivity(ActivityWorker.java:278) ~[temporal-sdk-1.22.2.jar:na]\r\n\tat io.temporal.internal.worker.ActivityWorker$TaskHandlerImpl.handle(ActivityWorker.java:243) ~[temporal-sdk-1.22.2.jar:na]\r\n\tat io.temporal.internal.worker.ActivityWorker$TaskHandlerImpl.handle(ActivityWorker.java:216) ~[temporal-sdk-1.22.2.jar:na]\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:105) ~[temporal-sdk-1.22.2.jar:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136) ~[na:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635) ~[na:na]\r\n\tat java.base/java.lang.Thread.run(Thread.java:840) ~[na:na]\r\n\r\n\r\n>>>>> here we are back with the first heartbeat details rather than only the single one\r\n\r\n2024-01-06T20:17:16.092+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    : propagating 4, heartbeat Optional[io.temporal.samples.springboot.propagation.ChunkProcessingActivityImpl$HeartbeatData@7d0ec774], rows [557d0cb6-e9a9-4a57-a8d7-d261a2bc90fd, 1350507c-4126-4a0a-868d-d0a96e90c744, b61a2443-5b5a-4888-bc37-f3e504340e77, 56115510-3c5c-4bc8-ae77-e206bdf9f4fb]\r\n2024-01-06T20:17:16.093+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    : processing single row 557d0cb6-e9a9-4a57-a8d7-d261a2bc90fd\r\n2024-01-06T20:17:16.093+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    :    sending heartbeat with remaining 3, [1350507c-4126-4a0a-868d-d0a96e90c744, b61a2443-5b5a-4888-bc37-f3e504340e77, 56115510-3c5c-4bc8-ae77-e206bdf9f4fb]\r\n2024-01-06T20:17:16.096+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    : processing single row 1350507c-4126-4a0a-868d-d0a96e90c744\r\n2024-01-06T20:17:16.096+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    :    sending heartbeat with remaining 2, [b61a2443-5b5a-4888-bc37-f3e504340e77, 56115510-3c5c-4bc8-ae77-e206bdf9f4fb]\r\n2024-01-06T20:17:16.096+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    : processing single row b61a2443-5b5a-4888-bc37-f3e504340e77\r\n2024-01-06T20:17:16.096+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    :    sending heartbeat with remaining 1, [56115510-3c5c-4bc8-ae77-e206bdf9f4fb]\r\n2024-01-06T20:17:16.096+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    : processing single row 56115510-3c5c-4bc8-ae77-e206bdf9f4fb\r\n2024-01-06T20:17:16.096+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    :    sending heartbeat with remaining 0, []\r\n2024-01-06T20:17:16.096+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    : processing 4 rows [557d0cb6-e9a9-4a57-a8d7-d261a2bc90fd, 1350507c-4126-4a0a-868d-d0a96e90c744, b61a2443-5b5a-4888-bc37-f3e504340e77, 56115510-3c5c-4bc8-ae77-e206bdf9f4fb] … done\r\n2024-01-06T20:17:16.097+01:00  INFO 4593 --- [temporal-samples] [ce=\"default\": 1] i.t.s.s.p.ChunkProcessingActivityImpl    : processing result ChunkedWorkflow.ProcessingResult(rowsRead=5, rowsWritten=5, rowsProcessed=[4ab57ee9-0daf-4e46-a6de-1e0643daeec1, 557d0cb6-e9a9-4a57-a8d7-d261a2bc90fd, 1350507c-4126-4a0a-868d-d0a96e90c744, b61a2443-5b5a-4888-bc37-f3e504340e77, 56115510-3c5c-4bc8-ae77-e206bdf9f4fb])\r\n```\r\n## Specifications\r\n\r\n  - Version:1.22.2\r\n  - Platform: mac / java 17 / spring boot 3.2\r\n\r\nSample repo: https://github.com/rburgst/temporal-java-heartbeat-problem\r\n( the springboot sample)\r\n","closedAt":"2025-01-06T23:45:17Z","comments":[{"id":"IC_kwDODN12PM5wJqnF","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"~Heartbeats may not always be sent to the Cluster—they may be throttled by the Worker.~\r\n\r\n~see more details here https://docs.temporal.io/activities#throttling~\r\n\r\nEdit: On review in this particular case the heartbeat details should be propagated as the Java SDK should be setting \r\n\r\nhttps://github.com/temporalio/api/blob/master/temporal/api/workflowservice/v1/request_response.proto#L504\r\n\r\n","createdAt":"2024-01-08T18:06:17Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1965#issuecomment-1881582021","viewerDidAuthor":false}],"createdAt":"2024-01-06T19:36:16Z","labels":[],"milestone":null,"number":1965,"reactionGroups":[],"state":"CLOSED","title":"Heartbeat activity retries first heartbeat data instead of last","updatedAt":"2025-01-06T23:45:17Z","url":"https://github.com/temporalio/sdk-java/issues/1965"}
