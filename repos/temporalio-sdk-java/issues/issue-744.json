{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjEyNDQzNzgx","is_bot":false,"login":"gosandhya","name":"Sandhya Gopchandani"},"body":"Some of the workflows remain in Running state while WorkFlowTask failed activity is triggered with the following error. This seems to happen only when I trigger multiple (20-100) instances of the workflow at the same time so it is a little sporadic in nature. The same workflow that works normally, hangs in ‘running’ mode with the error below:\r\n\r\n## Expected Behavior\r\nAll runs finish with 'complete' status \r\n\r\n## Actual Behavior\r\nSome runs fail with the following bug\r\n\r\n```\r\n15:25:20.731 [Workflow Executor taskQueue=\"Classify\", namespace=\"default\": 1568] ERROR i.t.internal.worker.PollerOptions - uncaught exception\r\njava.lang.RuntimeException: Failure processing workflow task. WorkflowId=438cb389-3973-49cf-b298-64cee904ad44, RunId=6810e3eb-be56-4e3b-b810-3c12bf44f76e, Attempt=798\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.wrapFailure(WorkflowWorker.java:349)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.wrapFailure(WorkflowWorker.java:279)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:79)\r\nat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n\tat java.base/java.lang.Thread.run(Thread.java:829)\r\nCaused by: io.temporal.internal.replay.InternalWorkflowTaskException: Failure handling event 302 of 'EVENT_TYPE_WORKFLOW_TASK_STARTED' type. IsReplaying=false, PreviousStartedEventId=302, workflowTaskStartedEventId=302, Currently Processing StartedEventId=302\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:188)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleEvent(ReplayWorkflowRunTaskHandler.java:140)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:180)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:150)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithEmbeddedQuery(ReplayWorkflowTaskHandler.java:201)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:114)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:319)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:279)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:73)\r\n\t... 3 common frames omitted\r\nCaused by: java.lang.RuntimeException: WorkflowTask: failure executing SCHEDULED->WORKFLOW_TASK_STARTED, transition history is [CREATED->WORKFLOW_TASK_SCHEDULED]\r\n\tat io.temporal.internal.statemachines.StateMachine.executeTransition(StateMachine.java:140)\r\n\tat io.temporal.internal.statemachines.StateMachine.handleHistoryEvent(StateMachine.java:91)\r\n\tat io.temporal.internal.statemachines.EntityStateMachineBase.handleEvent(EntityStateMachineBase.java:63)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEventImpl(WorkflowStateMachines.java:205)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:173)\r\n\t... 11 common frames omitted\r\nCaused by: java.lang.ClassCastException: class scala.runtime.NonLocalReturnControl cannot be cast to class java.lang.Exception (scala.runtime.NonLocalReturnControl is in unnamed module of loader 'app'; java.lang.Exception is in module java.base of loader 'bootstrap')\r\n\tat io.temporal.serviceclient.CheckedExceptionWrapper.wrap(CheckedExceptionWrapper.java:56)\r\n\tat io.temporal.internal.sync.WorkflowInternal.wrap(WorkflowInternal.java:412)\r\n\tat io.temporal.internal.sync.DeterministicRunnerImpl.runUntilAllBlocked(DeterministicRunnerImpl.java:211)\r\n\tat io.temporal.internal.sync.SyncWorkflow.eventLoop(SyncWorkflow.java:148)\r\n\tat io.temporal.internal.replay.ReplayWorkflowExecutor.eventLoop(ReplayWorkflowExecutor.java:74)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler$EntityManagerListenerImpl.eventLoop(ReplayWorkflowRunTaskHandler.java:329)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.eventLoop(WorkflowStateMachines.java:400)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.access$500(WorkflowStateMachines.java:71)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines$WorkflowTaskCommandsListener.workflowTaskStarted(WorkflowStateMachines.java:820)\r\n\tat io.temporal.internal.statemachines.WorkflowTaskStateMachine.handleCompleted(WorkflowTaskStateMachine.java:121)\r\n\tat io.temporal.internal.statemachines.WorkflowTaskStateMachine.handleStarted(WorkflowTaskStateMachine.java:113)\r\n\tat io.temporal.internal.statemachines.FixedTransitionAction.apply(FixedTransitionAction.java:45)\r\n\tat io.temporal.internal.statemachines.StateMachine.executeTransition(StateMachine.java:137)\r\n\t... 15 common frames omitted\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. kick-off 20-100 jobs of a custom workflow\r\n  2. Most of them would complete successfully while few (1-9) would be in forever running state with workflowTaskFailed Activity\r\n  \r\n\r\n## Specifications\r\n\r\n  - Version: Temporal Client SDK version 1.3.1\r\n  - Platform: IntelliJ\r\n","closedAt":"2021-09-23T16:50:13Z","comments":[{"id":"IC_kwDODN12PM43GL1s","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Hi @gosandhya \r\n\r\n> Failure handling event 302 of 'EVENT_TYPE_WORKFLOW_TASK_STARTED'\r\n\r\nIt looks like we at least have workflows with some pretty long histories here.\r\n\r\nAny chance you can provide some isolation or reproduction of the problem?\r\nIf you can't, maybe you can provide some additional details or characteristics about the type of workflows you run. ","createdAt":"2021-09-21T20:42:15Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/744#issuecomment-924368236","viewerDidAuthor":false},{"id":"IC_kwDODN12PM43HdnT","author":{"login":"gosandhya"},"authorAssociation":"NONE","body":"Hello @Spikhalskiy \r\n\r\nWe run a classification workflow that has multiple activities that perform fetching the data, disk operations, and finally interacting with various APIs to get back the results.\r\n\r\nMaxim pointed out there might be an edge case unhandled in temporal Java SDK particularly NonLocalReturnControl exception extending Throwable directly in Scala which is not ideal. So was hoping this issue could be fixed.\r\n\r\n```\r\nCaused by: java.lang.ClassCastException: class scala.runtime.NonLocalReturnControl cannot be cast to class java.lang.Exception (scala.runtime.NonLocalReturnControl is in unnamed module of loader 'app'; java.lang.Exception is in module java.base of loader 'bootstrap')\r\n\tat io.temporal.serviceclient.CheckedExceptionWrapper.wrap(CheckedExceptionWrapper.java:56)\r\n\tat io.temporal.internal.sync.WorkflowInternal.wrap(WorkflowInternal.java:412)\r\n```\r\n","createdAt":"2021-09-22T08:28:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/744#issuecomment-924703187","viewerDidAuthor":false},{"id":"IC_kwDODN12PM43KKUf","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Class cast exception will be fixed in 1.4.0 and the error message will be easier to read and will contain the original stacktrace, but the behavior itself (workflow \"stuck\" in Running) will not change.\r\n\r\nTemporal treats only subclasses of TemporalFailure as workflow execution failure, other throwables are treated like workflow bugs, and Temporal continues to retry them.\r\nIn your case, workflows are not stuck, Temporal actually keeps retrying them and they will succeed if you fix the exception and redeploy the workers.\r\nIf you want the `scala.runtime.NonLocalReturnControl` Throwable be treated as a workflow execution failure, wrap it into TemporalFailure class or use WorkflowImplementationOptions#setFailWorkflowExceptionTypes https://github.com/temporalio/sdk-java/blob/657a392333e6d623fda91b1d7a0ea1f152f2eb9b/temporal-sdk/src/main/java/io/temporal/worker/WorkflowImplementationOptions.java#L68 to specify `scala.runtime.NonLocalReturnControl ` as a type that causes Workflow fail.","createdAt":"2021-09-22T23:55:36Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/744#issuecomment-925410591","viewerDidAuthor":false},{"id":"IC_kwDODN12PM43Rj2j","author":{"login":"gosandhya"},"authorAssociation":"NONE","body":"Hi, thank you for responding to this promptly! Appreciate it.\r\n\r\nDo you have any time estimate for when will version 1.4.0 be released?","createdAt":"2021-09-26T18:34:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/744#issuecomment-927350179","viewerDidAuthor":false},{"id":"IC_kwDODN12PM43Ruqz","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"We are currently targeting October 5, but it's normal for Temporal to delay releases if we are unsure about safety.","createdAt":"2021-09-26T23:38:50Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/744#issuecomment-927394483","viewerDidAuthor":false}],"createdAt":"2021-09-21T08:20:54Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":4,"title":"1.4.0","description":"","dueOn":"2021-10-06T00:00:00Z"},"number":744,"reactionGroups":[],"state":"CLOSED","title":"Some jobs are forever in 'Running' State with WorkflowTaskFailed Error ","updatedAt":"2021-09-26T23:39:21Z","url":"https://github.com/temporalio/sdk-java/issues/744"}
