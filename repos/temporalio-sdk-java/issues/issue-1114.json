{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjQ3ODI0Njg4","is_bot":false,"login":"dorg-wlam","name":""},"body":"I am checking out the Worker suspendPolling() and resumePolling() feature, that seems to work initially, but with repeated test workflows can get stuck, and never starts.\r\nLooking at `temporal-matching` logs, I see errors as captured below, not sure if they're directly related.\r\n\r\nMy code is here https://github.com/dorg-wlam/temporal-example/blob/master/src/main/java/example/runner/ExampleRunner.java\r\nto reproduce it, just run 'submit', 'suspend', 'submit', 'resume', repeatedly.\r\n\r\nThe other not so high priority issue is that 'suspend' does not take effect immediately, there is no fixed delay or triggering that I can tell when it will go into effect. 'resume' is quick though.\r\n\r\n```json\r\n{\"level\":\"error\",\"ts\":\"2022-03-31T21:09:47.044Z\",\"msg\":\"matching client encountered error\",\"service\":\"matching\",\"error\":\"remote sync match failed\",\"service-error-type\":\"serviceerror.Canceled\",\"logging-call-at\":\"metricClient.go:259\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/temporal/common/log/zap_logger.go:142\\ngo.temporal.io/server/common/log.(*throttledLogger).Error.func1\\n\\t/temporal/common/log/throttle_logger.go:79\\ngo.temporal.io/server/common/log.(*throttledLogger).rateLimit\\n\\t/temporal/common/log/throttle_logger.go:100\\ngo.temporal.io/server/common/log.(*throttledLogger).Error\\n\\t/temporal/common/log/throttle_logger.go:78\\ngo.temporal.io/server/client/matching.(*metricClient).finishMetricsRecording\\n\\t/temporal/client/matching/metricClient.go:259\\ngo.temporal.io/server/client/matching.(*metricClient).AddWorkflowTask.func1\\n\\t/temporal/client/matching/metricClient.go:92\\ngo.temporal.io/server/client/matching.(*metricClient).AddWorkflowTask\\n\\t/temporal/client/matching/metricClient.go:101\\ngo.temporal.io/server/service/matching.(*Forwarder).ForwardTask\\n\\t/temporal/service/matching/forwarder.go:147\\ngo.temporal.io/server/service/matching.(*TaskMatcher).Offer\\n\\t/temporal/service/matching/matcher.go:150\\ngo.temporal.io/server/service/matching.(*taskQueueManagerImpl).trySyncMatch\\n\\t/temporal/service/matching/taskQueueManager.go:523\\ngo.temporal.io/server/service/matching.(*taskQueueManagerImpl).AddTask.func1\\n\\t/temporal/service/matching/taskQueueManager.go:291\\ngo.temporal.io/server/common/backoff.Retry.func1\\n\\t/temporal/common/backoff/retry.go:104\\ngo.temporal.io/server/common/backoff.RetryContext\\n\\t/temporal/common/backoff/retry.go:125\\ngo.temporal.io/server/common/backoff.Retry\\n\\t/temporal/common/backoff/retry.go:105\\ngo.temporal.io/server/service/matching.executeWithRetry\\n\\t/temporal/service/matching/taskQueueManager.go:501\\ngo.temporal.io/server/service/matching.(*taskQueueManagerImpl).AddTask\\n\\t/temporal/service/matching/taskQueueManager.go:281\\ngo.temporal.io/server/service/matching.(*matchingEngineImpl).AddWorkflowTask\\n\\t/temporal/service/matching/matchingEngine.go:280\\ngo.temporal.io/server/service/matching.(*Handler).AddWorkflowTask\\n\\t/temporal/service/matching/handler.go:198\\ngo.temporal.io/server/api/matchingservice/v1._MatchingService_AddWorkflowTask_Handler.func1\\n\\t/temporal/api/matchingservice/v1/service.pb.go:339\\ngo.temporal.io/server/common/rpc/interceptor.(*RateLimitInterceptor).Intercept\\n\\t/temporal/common/rpc/interceptor/rate_limit.go:84\\ngoogle.golang.org/grpc.chainUnaryInterceptors.func1.1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.44.0/server.go:1116\\ngo.temporal.io/server/common/rpc/interceptor.(*TelemetryInterceptor).Intercept\\n\\t/temporal/common/rpc/interceptor/telemetry.go:108\\ngoogle.golang.org/grpc.chainUnaryInterceptors.func1.1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.44.0/server.go:1119\\ngo.temporal.io/server/common/metrics.NewServerMetricsTrailerPropagatorInterceptor.func1\\n\\t/temporal/common/metrics/grpc.go:113\\ngoogle.golang.org/grpc.chainUnaryInterceptors.func1.1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.44.0/server.go:1119\\ngo.temporal.io/server/common/metrics.NewServerMetricsContextInjectorInterceptor.func1\\n\\t/temporal/common/metrics/grpc.go:66\\ngoogle.golang.org/grpc.chainUnaryInterceptors.func1.1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.44.0/server.go:1119\\ngo.temporal.io/server/common/rpc.ServiceErrorInterceptor\\n\\t/temporal/common/rpc/grpc.go:131\\ngoogle.golang.org/grpc.chainUnaryInterceptors.func1.1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.44.0/server.go:1119\\ngoogle.golang.org/grpc.chainUnaryInterceptors.func1\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.44.0/server.go:1121\\ngo.temporal.io/server/api/matchingservice/v1._MatchingService_AddWorkflowTask_Handler\\n\\t/temporal/api/matchingservice/v1/service.pb.go:341\\ngoogle.golang.org/grpc.(*Server).processUnaryRPC\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.44.0/server.go:1282\\ngoogle.golang.org/grpc.(*Server).handleStream\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.44.0/server.go:1616\\ngoogle.golang.org/grpc.(*Server).serveStreams.func1.2\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.44.0/server.go:921\"}\r\n```\r\n```json\r\n{\"level\":\"error\",\"ts\":\"2022-03-31T21:10:29.277Z\",\"msg\":\"matching client encountered error\",\"service\":\"matching\",\"error\":\"remote sync match failed\",\"service-error-type\":\"serviceerror.Canceled\",\"logging-call-at\":\"metricClient.go:259\",\"stacktrace\":\"go.temporal.io/server/common/log.(*zapLogger).Error\\n\\t/temporal/common/log/zap_logger.go:142\\ngo.temporal.io/server/common/log.(*throttledLogger).Error.func1\\n\\t/temporal/common/log/throttle_logger.go:79\\ngo.temporal.io/server/common/log.(*throttledLogger).rateLimit\\n\\t/temporal/common/log/throttle_logger.go:100\\ngo.temporal.io/server/common/log.(*throttledLogger).Error\\n\\t/temporal/common/log/throttle_logger.go:78\\ngo.temporal.io/server/client/matching.(*metricClient).finishMetricsRecording\\n\\t/temporal/client/matching/metricClient.go:259\\ngo.temporal.io/server/client/matching.(*metricClient).AddWorkflowTask.func1\\n\\t/temporal/client/matching/metricClient.go:92\\ngo.temporal.io/server/client/matching.(*metricClient).AddWorkflowTask\\n\\t/temporal/client/matching/metricClient.go:101\\ngo.temporal.io/server/service/matching.(*Forwarder).ForwardTask\\n\\t/temporal/service/matching/forwarder.go:147\\ngo.temporal.io/server/service/matching.(*TaskMatcher).MustOffer\\n\\t/temporal/service/matching/matcher.go:249\\ngo.temporal.io/server/service/matching.(*taskQueueManagerImpl).DispatchTask\\n\\t/temporal/service/matching/taskQueueManager.go:382\\ngo.temporal.io/server/service/matching.(*taskReader).dispatchBufferedTasks\\n\\t/temporal/service/matching/taskReader.go:114\\ngo.temporal.io/server/internal/goro.(*Group).Go.func1\\n\\t/temporal/internal/goro/group.go:57\"}\r\n```","closedAt":"2022-04-19T18:33:51Z","comments":[{"id":"IC_kwDODN12PM5BvOUZ","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"The problem is in `Worker#isSuspended` not returning the right value sometimes and your code trust this value and doesn't call `#resume` if it's already suspended. Will be fixed in 1.10","createdAt":"2022-04-19T17:19:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1114#issuecomment-1102898457","viewerDidAuthor":false}],"createdAt":"2022-03-31T21:43:12Z","labels":[],"milestone":{"number":11,"title":"1.10.0","description":"","dueOn":"2022-05-03T00:00:00Z"},"number":1114,"reactionGroups":[],"state":"CLOSED","title":"Suspend and resume Worker can cause Workflow stuck","updatedAt":"2022-04-19T18:33:51Z","url":"https://github.com/temporalio/sdk-java/issues/1114"}
