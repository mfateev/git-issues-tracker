{"assignees":[],"author":{"id":"MDQ6VXNlcjEwMTE0ODYw","is_bot":false,"login":"gauravojha","name":"Gaurav Ojha"},"body":"Details attached on the temporal forum support request - https://community.temporal.io/t/workflowreplayer-replayworkflowexecution-throwing-nondeterministicexception-when-reading-workflow-id-from-workflow/12040/6\r\n\r\nCopied from the post above\r\n\r\n========\r\n\r\nHere is a sample repo which replicates the error. The repo also has replay tests and sample workflow history if required under the src/test folder\r\nhttps://github.com/gauravojha/learningTemporal/tree/master\r\n\r\nSo what we are trying to do is\r\n\r\n(Also mentioned here, hope this helps - [learningTemporal/src/main/java/dev/ojha/learningtemporal/workflows/HelloWorldWorkflowImpl.java at master · gauravojha/learningTemporal · GitHub](https://github.com/gauravojha/learningTemporal/blob/master/src/main/java/dev/ojha/learningtemporal/workflows/HelloWorldWorkflowImpl.java#L35-L40))\r\n\r\n* Have a parent workflow trigger a child workflow\r\n* What we are trying to do is, reusing the parent workflows ID (this we get by using the provided Temporal utility method - `Workflow.getInfo().getWorkflowId()`, and then using this is a prefix and just append \"-child\" to it. So for instance if the parent workflow ID is \"helloWorld\", we are assigning our child workflow ID as \"helloWorld-child\", as this simplifies some usecases of tracing and audit for our usecases\r\n  * When we do this, and replay the payload through the replay tests, we get an undeterministic error, I have attached the trace for this specific case at the end\r\n  * `Failure handling event 5 of type 'EVENT_TYPE_START_CHILD_WORKFLOW_EXECUTION_INITIATED' during replay. [TMPRL1100] Command COMMAND_TYPE_START_CHILD_WORKFLOW_EXECUTION doesn't match event EVENT_TYPE_START_CHILD_WORKFLOW_EXECUTION_INITIATED with EventId=5 on check workflowId with an expected value 'workflow_id_in_replay-child' and an actual value 'HelloWorldWorkflow-child'`\r\n* However, if we don't reuse the parent's workflow ID, and let temporal use a random ID as the workflow ID of the child, then the replay tests pass.","closedAt":"2025-06-10T22:22:36Z","comments":[{"id":"IC_kwDODN12PM59RHt6","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"How are you replaying history? If you are using `WorkflowReplayer.replayWorkflowExecution`  then when you [construct ](https://github.com/temporalio/sdk-java/blob/a41c64ece3876f584ebde70903668b817c5455d8/temporal-sdk/src/main/java/io/temporal/internal/common/WorkflowExecutionHistory.java#L60C10-L60C34)`WorkflowExecutionHistory` you need to specify the workflow ID ","createdAt":"2024-05-08T23:06:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2057#issuecomment-2101640058","viewerDidAuthor":false},{"id":"IC_kwDODN12PM59S6T1","author":{"login":"gauravojha"},"authorAssociation":"NONE","body":"> How are you replaying history? If you are using `WorkflowReplayer.replayWorkflowExecution` then when you [construct ](https://github.com/temporalio/sdk-java/blob/a41c64ece3876f584ebde70903668b817c5455d8/temporal-sdk/src/main/java/io/temporal/internal/common/WorkflowExecutionHistory.java#L60C10-L60C34)`WorkflowExecutionHistory` you need to specify the workflow ID\r\n\r\n@Quinn-With-Two-Ns sorry, i am not sure i understand.. I am not doing anything complicated in my code if you see it. my workflow implementation is pretty simple, it only triggers a child workflow. I am not doing any special replaying in there. Any replay is being done in the replay test which is written using instructions at https://docs.temporal.io/dev-guide/java/durable-execution#add-replay-test . I don't see any specific instructions on providing a workflow ID here if i am providing a history extracted from temporal\r\n\r\nThis is the workflow implementation - https://github.com/gauravojha/learningTemporal/blob/652d2ba76e80b7d1a96946fae42b3d1dec0b3b3f/src/main/java/dev/ojha/learningtemporal/workflows/HelloWorldWorkflowImpl.java#L35-L40\r\n\r\nThis is the only place where any replay happens (in the WorkflowReplayer in a unit test) -  https://github.com/gauravojha/learningTemporal/blob/652d2ba76e80b7d1a96946fae42b3d1dec0b3b3f/src/test/java/dev/ojha/learningtemporal/TemporalTesting.java#L45\r\n\r\nFrom [the forum question](https://community.temporal.io/t/workflowreplayer-replayworkflowexecution-throwing-nondeterministicexception-when-reading-workflow-id-from-workflow/12040/6) where this is originally posted, it seems to be a bug in the SDK? The repository I have attached is a very small repository which can be used to reproduce the error. The entire history is downloaded from temporal UI after a sample workflow got over from the above repro repo, so I think I am not constructing the history, it is a history which temporal gives me if I am not mistaken?\r\n","createdAt":"2024-05-09T07:27:07Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2057#issuecomment-2102109429","viewerDidAuthor":false},{"id":"IC_kwDODN12PM59cZMG","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Where you are calling the replayer you are not specifying the workflow ID. You need to specificy a workflow ID when using the replayer since it is not always in history.\r\n\r\n```\r\n        assertDoesNotThrow(() -> WorkflowReplayer.replayWorkflowExecution(eventHistoryFile,\r\n                HelloWorldWorkflowImpl.class));\r\n```\r\n\r\nneeds to be something like\r\n\r\n```\r\n        assertDoesNotThrow(() -> WorkflowReplayer.replayWorkflowExecution(WorkflowExecutionHistory.WorkflowExecutionHistory(WorkflowHistoryLoader.readHistory(eventHistoryFile), \"YOUR WORKFLOW ID\"),\r\n                HelloWorldWorkflowImpl.class));\r\n```","createdAt":"2024-05-10T13:17:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/2057#issuecomment-2104595206","viewerDidAuthor":false},{"id":"IC_kwDODN12PM59dj7j","author":{"login":"gauravojha"},"authorAssociation":"NONE","body":"Got it.. Let me try @Quinn-With-Two-Ns, and thank you for pointing in the right direction, that worked on the sample repo I shared above :)  .. i couldnt find this recommendation in the starting replay test documentation. If this is a critical statement, I feel this should be mentioned in the intial stages in the document, since as a new user I may end up only looking at the first recommendation from the doc? \r\n\r\nJust adding some more color to this. So we wrote tests for 10 different workflows, and only one of them failed. Rest 9 passed, and we didn't have to pass in a workflow ID to 9 which passed, as we didn't get to the point that we may have to specify the workflow ID. If the following recommendation by you would have been mentioned in the initial stags of the replay test document, it would have helped us keep an eye out for it. Hope this helps?\r\n\r\n> You need to specificy a workflow ID when using the replayer since it is not always in history","createdAt":"2024-05-10T16:32:12Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2057#issuecomment-2104901347","viewerDidAuthor":false},{"id":"IC_kwDODN12PM59ykV2","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Yes I agree we should improve the documentation here. Passing the workflow ID is only important if the workflow uses the workflow ID as part of its logic which most don't.","createdAt":"2024-05-14T14:33:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2057#issuecomment-2110408054","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6ufkIy","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Workflow ID is now in the [WorkflowExecutionStartedEventAttributes](https://github.com/temporalio/api/blob/52b8544d8f7e27883c0e93a23275098b1c99b992/temporal/api/history/v1/message.proto#L83) so the SDK can automatically extract it if it was written","createdAt":"2025-06-01T16:40:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/2057#issuecomment-2927510066","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6vDe4a","author":{"login":"dmytrodanilenkov"},"authorAssociation":"CONTRIBUTOR","body":"@Quinn-With-Two-Ns can you look to my PR?","createdAt":"2025-06-03T19:45:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2057#issuecomment-2936925722","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6vEEm1","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"@dmytrodanilenkov Yes I looked and approved CI to run yesterday and today.","createdAt":"2025-06-03T20:25:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2057#issuecomment-2937080245","viewerDidAuthor":false}],"createdAt":"2024-05-08T20:19:31Z","labels":[],"milestone":null,"number":2057,"reactionGroups":[],"state":"CLOSED","title":"Java SDK seems to not play well with Replay tests. Setting child workflow ID using Temporal library seems to be throwing a non-deterministic error","updatedAt":"2025-06-10T22:22:36Z","url":"https://github.com/temporalio/sdk-java/issues/2057"}
