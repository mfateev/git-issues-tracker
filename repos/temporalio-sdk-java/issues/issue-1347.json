{"assignees":[],"author":{"id":"MDQ6VXNlcjI2OTQxNTk=","is_bot":false,"login":"neshield","name":"Nathan Shields"},"body":"## Expected Behavior\r\nI am connecting to two different Temporalite clusters. If I turn a cluster off, `getClusterInfo` fails. When I turn the cluster back on, `getClusterInfo` should succeed on the first attempt.\r\n\r\n## Actual Behavior\r\nWhen I turn the cluster back on, `getClusterInfo` fails the first time it is called, and then succeeds after. It does not seem to matter how long this first call is after turning the cluster back on, it still fails. I did not see this same issue on a single cluster setup.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nTest code + comments:\r\n```java\r\n        WorkflowFacade primary = supplier.getHealthyFacade().orElseThrow();\r\n        // Turn off primary cluster\r\n        WorkflowFacade fallback = supplier.getHealthyFacade().orElseThrow();\r\n        assertNotEquals(primary, fallback);\r\n        // Turn the primary cluster on again\r\n        // another == fallback, where it should be primary, because the health check on primary failed.\r\n        WorkflowFacade another = supplier.getHealthyFacade().orElseThrow();\r\n        // This assertion fails\r\n        assertEquals(primary, another);\r\n```\r\n\r\nHealth Check code:\r\n```java\r\nreturn ListenableFuturesExtra.toCompletableFuture(getService().futureStub()\r\n                    .getClusterInfo(GetClusterInfoRequest.newBuilder().build()))\r\n                    .thenApplyAsync(GetClusterInfoResponse::isInitialized)\r\n                    .orTimeout(2000, TimeUnit.MILLISECONDS);\r\n```\r\n\r\n1. Set up an environment with two+ Temporal clusters, henceforth referred to as \"primary\" and \"fallback\"\r\n1. Turn on both clusters and getClusterInfo the primary, which will succeed. ✅ \r\n1. Turn off the primary cluster and getClusterInfo the primary, which will fail. ✅ \r\n1. Turn **on** the primary cluster and getClusterInfo the primary, which will **fail**. We expect success here. I have waited over 2 minutes with the same result. ❌ \r\n1. getClusterInfo the primary, which will succeed, as expected. ✅ \r\n\r\nStack traces:\r\nStep 3, after turning off primary:\r\n```\r\n2022-08-03 17:42:52.862  WARN [,,] 41628 --- [ce=\"default\": 1] io.temporal.internal.worker.Poller       : Failure in poller thread Workflow Poller taskQueue=\"MY_QUEUE\", namespace=\"default\": 1\r\n\r\nio.grpc.StatusRuntimeException: UNKNOWN: channel closed\r\n\tat io.grpc.stub.ClientCalls.toStatusRuntimeException(ClientCalls.java:271) ~[grpc-stub-1.46.0.jar:1.46.0]\r\n\tat io.grpc.stub.ClientCalls.getUnchecked(ClientCalls.java:252) ~[grpc-stub-1.46.0.jar:1.46.0]\r\n\tat io.grpc.stub.ClientCalls.blockingUnaryCall(ClientCalls.java:165) ~[grpc-stub-1.46.0.jar:1.46.0]\r\n\tat io.temporal.api.workflowservice.v1.WorkflowServiceGrpc$WorkflowServiceBlockingStub.pollWorkflowTaskQueue(WorkflowServiceGrpc.java:2803) ~[temporal-serviceclient-1.11.0.jar:na]\r\n\tat io.temporal.internal.worker.WorkflowPollTask.poll(WorkflowPollTask.java:80) ~[temporal-sdk-1.11.0.jar:na]\r\n\tat io.temporal.internal.worker.WorkflowPollTask.poll(WorkflowPollTask.java:37) ~[temporal-sdk-1.11.0.jar:na]\r\n\tat io.temporal.internal.worker.Poller$PollExecutionTask.run(Poller.java:266) ~[temporal-sdk-1.11.0.jar:na]\r\n\tat io.temporal.internal.worker.Poller$PollLoopTask.run(Poller.java:231) ~[temporal-sdk-1.11.0.jar:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[na:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[na:na]\r\n\tat java.base/java.lang.Thread.run(Thread.java:829) ~[na:na]\r\nCaused by: java.nio.channels.ClosedChannelException: null\r\n\tat io.grpc.netty.shaded.io.grpc.netty.Utils.statusFromThrowable(Utils.java:271) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler.onConnectionError(NettyClientHandler.java:500) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.handler.codec.http2.Http2ConnectionHandler.onError(Http2ConnectionHandler.java:641) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.handler.codec.http2.DefaultHttp2ConnectionEncoder.writeHeaders0(DefaultHttp2ConnectionEncoder.java:251) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.handler.codec.http2.DefaultHttp2ConnectionEncoder.writeHeaders(DefaultHttp2ConnectionEncoder.java:167) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.handler.codec.http2.DecoratingHttp2FrameWriter.writeHeaders(DecoratingHttp2FrameWriter.java:53) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.handler.codec.http2.StreamBufferingEncoder.writeHeaders(StreamBufferingEncoder.java:170) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.handler.codec.http2.StreamBufferingEncoder.writeHeaders(StreamBufferingEncoder.java:158) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler.createStreamTraced(NettyClientHandler.java:609) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler.createStream(NettyClientHandler.java:592) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler.write(NettyClientHandler.java:326) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.AbstractChannelHandlerContext.invokeWrite0(AbstractChannelHandlerContext.java:717) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.AbstractChannelHandlerContext.invokeWrite(AbstractChannelHandlerContext.java:709) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.AbstractChannelHandlerContext.write(AbstractChannelHandlerContext.java:792) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.AbstractChannelHandlerContext.write(AbstractChannelHandlerContext.java:702) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.DefaultChannelPipeline.write(DefaultChannelPipeline.java:1015) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.AbstractChannel.write(AbstractChannel.java:301) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.WriteQueue$AbstractQueuedCommand.run(WriteQueue.java:213) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.WriteQueue.flush(WriteQueue.java:128) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.WriteQueue.access$000(WriteQueue.java:34) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.WriteQueue$1.run(WriteQueue.java:46) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:164) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:469) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:500) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\t... 1 common frames omitted\r\nCaused by: io.grpc.netty.shaded.io.netty.channel.StacklessClosedChannelException: null\r\n\tat io.grpc.netty.shaded.io.netty.channel.AbstractChannel$AbstractUnsafe.write(Object, ChannelPromise)(Unknown Source) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n```\r\n\r\nStep 3 from calling the health check:\r\n```\r\n2022-08-03 17:42:52.885 ERROR [,,] 41628 --- [    Test worker] c.me.temp.TemporalWorkflowFacade  : WorkflowFacade reported the cluster as unhealthy:\r\n\r\njava.util.concurrent.ExecutionException: io.grpc.StatusRuntimeException: UNKNOWN: channel closed\r\n\tat java.base/java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:395) ~[na:na]\r\n\tat java.base/java.util.concurrent.CompletableFuture.get(CompletableFuture.java:2022) ~[na:na]\r\n\tat com.me.temp.TemporalWorkflowFacade.isHealthy(TemporalWorkflowFacade.java:249) \r\n\tat com.me.temp.multicluster.MultiClusterSpringBootAppIntegrationTest.testSupplierReturnsFallbackWhenPrimaryIsUnhealthy(MultiClusterSpringBootAppIntegrationTest.java:75) ~[integrationTest/:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:na]\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566) ~[na:na]\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:59) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:56) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.springframework.test.context.junit4.statements.RunBeforeTestExecutionCallbacks.evaluate(RunBeforeTestExecutionCallbacks.java:74) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.springframework.test.context.junit4.statements.RunAfterTestExecutionCallbacks.evaluate(RunAfterTestExecutionCallbacks.java:84) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.springframework.test.context.junit4.statements.RunBeforeTestMethodCallbacks.evaluate(RunBeforeTestMethodCallbacks.java:75) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.springframework.test.context.junit4.statements.RunAfterTestMethodCallbacks.evaluate(RunAfterTestMethodCallbacks.java:86) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.springframework.test.context.junit4.statements.SpringRepeat.evaluate(SpringRepeat.java:84) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:366) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:251) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:97) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.junit.runners.ParentRunner$4.run(ParentRunner.java:331) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:79) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.runners.ParentRunner.runChildren(ParentRunner.java:329) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.runners.ParentRunner.access$100(ParentRunner.java:66) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:293) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:54) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:54) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.rules.RunRules.evaluate(RunRules.java:20) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.runners.ParentRunner.run(ParentRunner.java:413) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:190) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.runTestClass(JUnitTestClassExecutor.java:110) ~[na:na]\r\n\tat org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.execute(JUnitTestClassExecutor.java:58) ~[na:na]\r\n\tat org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.execute(JUnitTestClassExecutor.java:38) ~[na:na]\r\n\tat org.gradle.api.internal.tasks.testing.junit.AbstractJUnitTestClassProcessor.processTestClass(AbstractJUnitTestClassProcessor.java:62) ~[na:na]\r\n\tat org.gradle.api.internal.tasks.testing.SuiteTestClassProcessor.processTestClass(SuiteTestClassProcessor.java:51) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:na]\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566) ~[na:na]\r\n\tat org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:36) ~[na:na]\r\n\tat org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:24) ~[na:na]\r\n\tat org.gradle.internal.dispatch.ContextClassLoaderDispatch.dispatch(ContextClassLoaderDispatch.java:33) ~[na:na]\r\n\tat org.gradle.internal.dispatch.ProxyDispatchAdapter$DispatchingInvocationHandler.invoke(ProxyDispatchAdapter.java:94) ~[na:na]\r\n\tat com.sun.proxy.$Proxy2.processTestClass(Unknown Source) ~[na:na]\r\n\tat org.gradle.api.internal.tasks.testing.worker.TestWorker.processTestClass(TestWorker.java:119) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:na]\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566) ~[na:na]\r\n\tat org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:36) ~[na:na]\r\n\tat org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:24) ~[na:na]\r\n\tat org.gradle.internal.remote.internal.hub.MessageHubBackedObjectConnection$DispatchWrapper.dispatch(MessageHubBackedObjectConnection.java:182) ~[na:na]\r\n\tat org.gradle.internal.remote.internal.hub.MessageHubBackedObjectConnection$DispatchWrapper.dispatch(MessageHubBackedObjectConnection.java:164) ~[na:na]\r\n\tat org.gradle.internal.remote.internal.hub.MessageHub$Handler.run(MessageHub.java:414) ~[na:na]\r\n\tat org.gradle.internal.concurrent.ExecutorPolicy$CatchAndRecordFailures.onExecute(ExecutorPolicy.java:64) ~[na:na]\r\n\tat org.gradle.internal.concurrent.ManagedExecutorImpl$1.run(ManagedExecutorImpl.java:48) ~[na:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[na:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[na:na]\r\n\tat org.gradle.internal.concurrent.ThreadFactoryImpl$ManagedThreadRunnable.run(ThreadFactoryImpl.java:56) ~[na:na]\r\n\tat java.base/java.lang.Thread.run(Thread.java:829) ~[na:na]\r\nCaused by: io.grpc.StatusRuntimeException: UNKNOWN: channel closed\r\n\tat io.grpc.Status.asRuntimeException(Status.java:535) ~[grpc-api-1.46.0.jar:1.46.0]\r\n\tat io.grpc.stub.ClientCalls$UnaryStreamToFuture.onClose(ClientCalls.java:542) ~[grpc-stub-1.46.0.jar:1.46.0]\r\n\tat io.grpc.PartialForwardingClientCallListener.onClose(PartialForwardingClientCallListener.java:39) ~[grpc-api-1.46.0.jar:1.46.0]\r\n\tat io.grpc.ForwardingClientCallListener.onClose(ForwardingClientCallListener.java:23) ~[grpc-api-1.46.0.jar:1.46.0]\r\n\tat io.grpc.ForwardingClientCallListener$SimpleForwardingClientCallListener.onClose(ForwardingClientCallListener.java:40) ~[grpc-api-1.46.0.jar:1.46.0]\r\n\tat io.temporal.serviceclient.GrpcMetricsInterceptor$MetricsClientCall$1.onClose(GrpcMetricsInterceptor.java:123) ~[temporal-serviceclient-1.11.0.jar:na]\r\n\tat io.grpc.internal.ClientCallImpl.closeObserver(ClientCallImpl.java:562) ~[grpc-core-1.46.0.jar:1.46.0]\r\n\tat io.grpc.internal.ClientCallImpl.access$300(ClientCallImpl.java:70) ~[grpc-core-1.46.0.jar:1.46.0]\r\n\tat io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInternal(ClientCallImpl.java:743) ~[grpc-core-1.46.0.jar:1.46.0]\r\n\tat io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInContext(ClientCallImpl.java:722) ~[grpc-core-1.46.0.jar:1.46.0]\r\n\tat io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37) ~[grpc-core-1.46.0.jar:1.46.0]\r\n\tat io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:133) ~[grpc-core-1.46.0.jar:1.46.0]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[na:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[na:na]\r\n\t... 1 common frames omitted\r\nCaused by: java.nio.channels.ClosedChannelException: null\r\n\tat io.grpc.netty.shaded.io.grpc.netty.Utils.statusFromThrowable(Utils.java:271) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler.onConnectionError(NettyClientHandler.java:500) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.handler.codec.http2.Http2ConnectionHandler.onError(Http2ConnectionHandler.java:641) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.handler.codec.http2.DefaultHttp2ConnectionEncoder.writeHeaders0(DefaultHttp2ConnectionEncoder.java:251) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.handler.codec.http2.DefaultHttp2ConnectionEncoder.writeHeaders(DefaultHttp2ConnectionEncoder.java:167) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.handler.codec.http2.DecoratingHttp2FrameWriter.writeHeaders(DecoratingHttp2FrameWriter.java:53) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.handler.codec.http2.StreamBufferingEncoder.writeHeaders(StreamBufferingEncoder.java:170) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.handler.codec.http2.StreamBufferingEncoder.writeHeaders(StreamBufferingEncoder.java:158) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler.createStreamTraced(NettyClientHandler.java:609) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler.createStream(NettyClientHandler.java:592) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler.write(NettyClientHandler.java:326) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.AbstractChannelHandlerContext.invokeWrite0(AbstractChannelHandlerContext.java:717) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.AbstractChannelHandlerContext.invokeWrite(AbstractChannelHandlerContext.java:709) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.AbstractChannelHandlerContext.write(AbstractChannelHandlerContext.java:792) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.AbstractChannelHandlerContext.write(AbstractChannelHandlerContext.java:702) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.DefaultChannelPipeline.write(DefaultChannelPipeline.java:1015) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.AbstractChannel.write(AbstractChannel.java:301) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.WriteQueue$AbstractQueuedCommand.run(WriteQueue.java:213) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.WriteQueue.flush(WriteQueue.java:128) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.WriteQueue.access$000(WriteQueue.java:34) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.grpc.netty.WriteQueue$1.run(WriteQueue.java:46) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java:164) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:469) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:500) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\t... 1 common frames omitted\r\nCaused by: io.grpc.netty.shaded.io.netty.channel.StacklessClosedChannelException: null\r\n\tat io.grpc.netty.shaded.io.netty.channel.AbstractChannel$AbstractUnsafe.write(Object, ChannelPromise)(Unknown Source) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n```\r\n\r\nStep 4 after turning primary on:\r\n```\r\n2022-08-03 17:43:11.243  WARN [,,] 41628 --- [ce=\"default\": 4] io.temporal.internal.worker.Poller       : Failure in poller thread Activity Poller taskQueue=\"MY_QUEUE\", namespace=\"default\": 4\r\n\r\nio.grpc.StatusRuntimeException: UNAVAILABLE: io exception\r\n\tat io.grpc.stub.ClientCalls.toStatusRuntimeException(ClientCalls.java:271) ~[grpc-stub-1.46.0.jar:1.46.0]\r\n\tat io.grpc.stub.ClientCalls.getUnchecked(ClientCalls.java:252) ~[grpc-stub-1.46.0.jar:1.46.0]\r\n\tat io.grpc.stub.ClientCalls.blockingUnaryCall(ClientCalls.java:165) ~[grpc-stub-1.46.0.jar:1.46.0]\r\n\tat io.temporal.api.workflowservice.v1.WorkflowServiceGrpc$WorkflowServiceBlockingStub.pollActivityTaskQueue(WorkflowServiceGrpc.java:2852) ~[temporal-serviceclient-1.11.0.jar:na]\r\n\tat io.temporal.internal.worker.ActivityPollTask.poll(ActivityPollTask.java:99) ~[temporal-sdk-1.11.0.jar:na]\r\n\tat io.temporal.internal.worker.ActivityPollTask.poll(ActivityPollTask.java:39) ~[temporal-sdk-1.11.0.jar:na]\r\n\tat io.temporal.internal.worker.Poller$PollExecutionTask.run(Poller.java:266) ~[temporal-sdk-1.11.0.jar:na]\r\n\tat io.temporal.internal.worker.Poller$PollLoopTask.run(Poller.java:231) ~[temporal-sdk-1.11.0.jar:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[na:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[na:na]\r\n\tat java.base/java.lang.Thread.run(Thread.java:829) ~[na:na]\r\nCaused by: io.grpc.netty.shaded.io.netty.channel.AbstractChannel$AnnotatedConnectException: Connection refused: /127.0.0.1:7233\r\nCaused by: java.net.ConnectException: Connection refused\r\n\tat java.base/sun.nio.ch.SocketChannelImpl.checkConnect(Native Method) ~[na:na]\r\n\tat java.base/sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:777) ~[na:na]\r\n\tat io.grpc.netty.shaded.io.netty.channel.socket.nio.NioSocketChannel.doFinishConnect(NioSocketChannel.java:330) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.finishConnect(AbstractNioChannel.java:334) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:710) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:658) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:584) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:496) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat java.base/java.lang.Thread.run(Thread.java:829) ~[na:na]\r\n```\r\n\r\nStep 4 calling health check:\r\n```\r\n2022-08-03 17:43:11.310 ERROR [,,] 41628 --- [    Test worker] c.me.temp.TemporalWorkflowFacade  : WorkflowFacade reported the cluster as unhealthy:\r\n\r\njava.util.concurrent.ExecutionException: io.grpc.StatusRuntimeException: UNAVAILABLE: io exception\r\n\tat java.base/java.util.concurrent.CompletableFuture.reportGet(CompletableFuture.java:395) ~[na:na]\r\n\tat java.base/java.util.concurrent.CompletableFuture.get(CompletableFuture.java:2022) ~[na:na]\r\n\tat com.me.temp.TemporalWorkflowFacade.isHealthy(TemporalWorkflowFacade.java:249) \r\n\tat com.me.temp.multicluster.MultiClusterSpringBootAppIntegrationTest.testSupplierReturnsFallbackWhenPrimaryIsUnhealthy(MultiClusterSpringBootAppIntegrationTest.java:78) ~[integrationTest/:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:na]\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566) ~[na:na]\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:59) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:56) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.springframework.test.context.junit4.statements.RunBeforeTestExecutionCallbacks.evaluate(RunBeforeTestExecutionCallbacks.java:74) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.springframework.test.context.junit4.statements.RunAfterTestExecutionCallbacks.evaluate(RunAfterTestExecutionCallbacks.java:84) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.springframework.test.context.junit4.statements.RunBeforeTestMethodCallbacks.evaluate(RunBeforeTestMethodCallbacks.java:75) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.springframework.test.context.junit4.statements.RunAfterTestMethodCallbacks.evaluate(RunAfterTestMethodCallbacks.java:86) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.springframework.test.context.junit4.statements.SpringRepeat.evaluate(SpringRepeat.java:84) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:366) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:251) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.springframework.test.context.junit4.SpringJUnit4ClassRunner.runChild(SpringJUnit4ClassRunner.java:97) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.junit.runners.ParentRunner$4.run(ParentRunner.java:331) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:79) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.runners.ParentRunner.runChildren(ParentRunner.java:329) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.runners.ParentRunner.access$100(ParentRunner.java:66) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:293) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.springframework.test.context.junit4.statements.RunBeforeTestClassCallbacks.evaluate(RunBeforeTestClassCallbacks.java:61) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.springframework.test.context.junit4.statements.RunAfterTestClassCallbacks.evaluate(RunAfterTestClassCallbacks.java:70) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:54) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.rules.ExternalResource$1.evaluate(ExternalResource.java:54) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.rules.RunRules.evaluate(RunRules.java:20) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.junit.runners.ParentRunner.run(ParentRunner.java:413) ~[junit-4.13.2.jar:4.13.2]\r\n\tat org.springframework.test.context.junit4.SpringJUnit4ClassRunner.run(SpringJUnit4ClassRunner.java:190) ~[spring-test-5.3.18.jar:5.3.18]\r\n\tat org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.runTestClass(JUnitTestClassExecutor.java:110) ~[na:na]\r\n\tat org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.execute(JUnitTestClassExecutor.java:58) ~[na:na]\r\n\tat org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.execute(JUnitTestClassExecutor.java:38) ~[na:na]\r\n\tat org.gradle.api.internal.tasks.testing.junit.AbstractJUnitTestClassProcessor.processTestClass(AbstractJUnitTestClassProcessor.java:62) ~[na:na]\r\n\tat org.gradle.api.internal.tasks.testing.SuiteTestClassProcessor.processTestClass(SuiteTestClassProcessor.java:51) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:na]\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566) ~[na:na]\r\n\tat org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:36) ~[na:na]\r\n\tat org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:24) ~[na:na]\r\n\tat org.gradle.internal.dispatch.ContextClassLoaderDispatch.dispatch(ContextClassLoaderDispatch.java:33) ~[na:na]\r\n\tat org.gradle.internal.dispatch.ProxyDispatchAdapter$DispatchingInvocationHandler.invoke(ProxyDispatchAdapter.java:94) ~[na:na]\r\n\tat com.sun.proxy.$Proxy2.processTestClass(Unknown Source) ~[na:na]\r\n\tat org.gradle.api.internal.tasks.testing.worker.TestWorker.processTestClass(TestWorker.java:119) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:na]\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566) ~[na:na]\r\n\tat org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:36) ~[na:na]\r\n\tat org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:24) ~[na:na]\r\n\tat org.gradle.internal.remote.internal.hub.MessageHubBackedObjectConnection$DispatchWrapper.dispatch(MessageHubBackedObjectConnection.java:182) ~[na:na]\r\n\tat org.gradle.internal.remote.internal.hub.MessageHubBackedObjectConnection$DispatchWrapper.dispatch(MessageHubBackedObjectConnection.java:164) ~[na:na]\r\n\tat org.gradle.internal.remote.internal.hub.MessageHub$Handler.run(MessageHub.java:414) ~[na:na]\r\n\tat org.gradle.internal.concurrent.ExecutorPolicy$CatchAndRecordFailures.onExecute(ExecutorPolicy.java:64) ~[na:na]\r\n\tat org.gradle.internal.concurrent.ManagedExecutorImpl$1.run(ManagedExecutorImpl.java:48) ~[na:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[na:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[na:na]\r\n\tat org.gradle.internal.concurrent.ThreadFactoryImpl$ManagedThreadRunnable.run(ThreadFactoryImpl.java:56) ~[na:na]\r\n\tat java.base/java.lang.Thread.run(Thread.java:829) ~[na:na]\r\nCaused by: io.grpc.StatusRuntimeException: UNAVAILABLE: io exception\r\n\tat io.grpc.Status.asRuntimeException(Status.java:535) ~[grpc-api-1.46.0.jar:1.46.0]\r\n\tat io.grpc.stub.ClientCalls$UnaryStreamToFuture.onClose(ClientCalls.java:542) ~[grpc-stub-1.46.0.jar:1.46.0]\r\n\tat io.grpc.PartialForwardingClientCallListener.onClose(PartialForwardingClientCallListener.java:39) ~[grpc-api-1.46.0.jar:1.46.0]\r\n\tat io.grpc.ForwardingClientCallListener.onClose(ForwardingClientCallListener.java:23) ~[grpc-api-1.46.0.jar:1.46.0]\r\n\tat io.grpc.ForwardingClientCallListener$SimpleForwardingClientCallListener.onClose(ForwardingClientCallListener.java:40) ~[grpc-api-1.46.0.jar:1.46.0]\r\n\tat io.temporal.serviceclient.GrpcMetricsInterceptor$MetricsClientCall$1.onClose(GrpcMetricsInterceptor.java:123) ~[temporal-serviceclient-1.11.0.jar:na]\r\n\tat io.grpc.internal.ClientCallImpl.closeObserver(ClientCallImpl.java:562) ~[grpc-core-1.46.0.jar:1.46.0]\r\n\tat io.grpc.internal.ClientCallImpl.access$300(ClientCallImpl.java:70) ~[grpc-core-1.46.0.jar:1.46.0]\r\n\tat io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInternal(ClientCallImpl.java:743) ~[grpc-core-1.46.0.jar:1.46.0]\r\n\tat io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInContext(ClientCallImpl.java:722) ~[grpc-core-1.46.0.jar:1.46.0]\r\n\tat io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37) ~[grpc-core-1.46.0.jar:1.46.0]\r\n\tat io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:133) ~[grpc-core-1.46.0.jar:1.46.0]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[na:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[na:na]\r\n\t... 1 common frames omitted\r\nCaused by: io.grpc.netty.shaded.io.netty.channel.AbstractChannel$AnnotatedConnectException: Connection refused: /127.0.0.1:7233\r\nCaused by: java.net.ConnectException: Connection refused\r\n\tat java.base/sun.nio.ch.SocketChannelImpl.checkConnect(Native Method) ~[na:na]\r\n\tat java.base/sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:777) ~[na:na]\r\n\tat io.grpc.netty.shaded.io.netty.channel.socket.nio.NioSocketChannel.doFinishConnect(NioSocketChannel.java:330) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.nio.AbstractNioChannel$AbstractNioUnsafe.finishConnect(AbstractNioChannel.java:334) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:710) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:658) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:584) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:496) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:986) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat io.grpc.netty.shaded.io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) ~[grpc-netty-shaded-1.46.0.jar:1.46.0]\r\n\tat java.base/java.lang.Thread.run(Thread.java:829) ~[na:na]\r\n```\r\n\r\n## Specifications\r\nTemporalite was installed using `go install github.com/temporalio/temporalite/cmd/temporalite@latest`\r\n- Version:\r\n```\r\n go/bin » ./temporalite -v\r\ntemporal version 1.17.1\r\n```\r\n- Platform: Apple M1 Max, macOS 12.4\r\n","closedAt":"2025-06-03T14:51:49Z","comments":[{"id":"IC_kwDODN12PM5H6-KQ","author":{"login":"jlegrone"},"authorAssociation":"NONE","body":"> 1. Set up an environment with two+ Temporal clusters, henceforth referred to as \"primary\" and \"fallback\"\r\n\r\nHow are you configuring your temporalite instances? Eg. does `temporalite start --ephemeral -p 7233` and `temporalite start --ephemeral -p 7234` work to reproduce?\r\n\r\n> 4. Turn on the primary cluster and getClusterInfo the primary, which will fail. We expect success here. I have waited over 2 minutes with the same result.\r\n\r\nAre you able to reproduce this step via the `tctl cluster health` command? I _think_ this may call the same API as `getClusterInfo` in the Java SDK. Also, are you running this program in a new process each time?","createdAt":"2022-08-04T17:48:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1347#issuecomment-1206641296","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5H6-KW","author":{"login":"neshield"},"authorAssociation":"NONE","body":"\r\n> How are you configuring your temporalite instances? Eg. does `temporalite start --ephemeral -p 7233` and `temporalite start --ephemeral -p 7234` work to reproduce?\r\n\r\nThat command works to reproduce. I had been doing essentially the same thing: `./temporalite start --ephemeral --namespace default` and `./temporalite start --ephemeral --port 7234 --namespace default`\r\n\r\n\r\n\r\n\r\n\r\n> > 4\\. Turn on the primary cluster and getClusterInfo the primary, which will fail. We expect success here. I have waited over 2 minutes with the same result.\r\n> \r\n> Are you able to reproduce this step via the `tctl cluster health` command?\r\n\r\nIf I call `tctl cluster health` after turning the primary cluster back on, it succeeds:\r\n```\r\ntctl cluster health                                                       \r\ntemporal.api.workflowservice.v1.WorkflowService: SERVING\r\n```\r\nHowever, the test still shows the same result. The first `getClusterInfo` fails with `Connection refused: /127.0.0.1:7233`.\r\n\r\n> are you running this program in a new process each time?\r\n\r\nYes, it's a JUnit test. ","createdAt":"2022-08-04T22:25:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/1347#issuecomment-1206641302","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5H6-XA","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"This does not seem related to Temporalite specifically, but rather the Java SDK. To clarify @neshield, are you saying that your same client isn't able to successful call after server starts back up? Also, you say you have a \"fallback\" but all yours steps refer to \"primary\",...so \"fallback\" is not needed in the description to describe your issue? Or is the fallback used in some way?","createdAt":"2022-08-05T16:36:01Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1347#issuecomment-1206642112","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5H7F9O","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"@neshield From what I see from Step 4 logs, gRPC actually tries to establish a new connection (as it should) and it fails, which causes the request to fail:\r\n\r\n```\r\nCaused by: io.grpc.netty.shaded.io.netty.channel.AbstractChannel$AnnotatedConnectException: Connection refused: /127.0.0.1:7233\r\nCaused by: java.net.ConnectException: Connection refused\r\n```\r\n\r\nIt looks like the server was up according to your description, but for some reason, the connection attempt was refused.\r\nDo we have any proxies in the middle here? Envoy maybe? Or it's a fully local setup and the SDK connects to Temporal Servers directly?","createdAt":"2022-08-05T17:14:14Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1347#issuecomment-1206673230","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5H7u9X","author":{"login":"neshield"},"authorAssociation":"NONE","body":"@cretz \r\n> Also, you say you have a \"fallback\" but all yours steps refer to \"primary\",...so \"fallback\" is not needed in the description to describe your issue? Or is the fallback used in some way?\r\n\r\nI thought I could only reproduce this in a two+ cluster environment, even though the \"fallback\" was never used. However, it seems like the second cluster isn't actually necessary.`WorkflowFacade` is a wrapper and a Spring Bean which gets created on startup. So, to narrow things down I managed to reproduce the error without the wrapper and without Spring. \r\n\r\n```java\r\npublic class SimpleTest {\r\n    private static final WorkflowServiceStubs service = WorkflowServiceStubs.newServiceStubs(\r\n            WorkflowServiceStubsOptions.newBuilder()\r\n                    .setTarget(\"127.0.0.1:7233\")\r\n                    .setRpcTimeout(Duration.ofMillis(100000))\r\n                    .build());\r\n    @Test public void testDoNotUseFacade() throws InterruptedException {\r\n        // 1. turn on\r\n        assertTrue(isHealthy(service));\r\n        // 2. turn off\r\n        assertFalse(isHealthy(service));\r\n        int counter = 0;\r\n        boolean isHealthy = false;\r\n        // 3. turn on, doesn't seem to matter how long you wait before starting the loop\r\n        while (!isHealthy) {\r\n            isHealthy = isHealthy(service);\r\n            counter++;\r\n            Thread.sleep(500);\r\n        }\r\n        // This seems to always print 2, even if the sleep is for 500 millis or 2000.\r\n        System.out.println(\"Cluster returned healthy after numAttempts: \" + counter);\r\n    }\r\n\r\n    public boolean isHealthy(WorkflowServiceStubs service) {\r\n        try {\r\n            return ListenableFuturesExtra.toCompletableFuture(service.futureStub()\r\n                            .getClusterInfo(GetClusterInfoRequest.newBuilder().build()))\r\n                    .thenApplyAsync(GetClusterInfoResponse::isInitialized)\r\n                    .orTimeout(20, TimeUnit.SECONDS).get();\r\n        } catch (Exception e) {\r\n            System.out.println(\"Threw exception :\" + e.getMessage());\r\n            return false;\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nHere are the full logs for a test run:\r\n\r\n```\r\n16:27:00.705 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.logging.InternalLoggerFactory - Using SLF4J as the default logging framework\r\n16:27:00.711 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent0 - -Dio.netty.noUnsafe: false\r\n16:27:00.711 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent0 - Java version: 11\r\n16:27:00.713 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent0 - sun.misc.Unsafe.theUnsafe: available\r\n16:27:00.715 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent0 - sun.misc.Unsafe.copyMemory: available\r\n16:27:00.716 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent0 - java.nio.Buffer.address: available\r\n16:27:00.716 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent0 - direct buffer constructor: unavailable: Reflective setAccessible(true) disabled\r\n16:27:00.717 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent0 - java.nio.Bits.unaligned: available, true\r\n16:27:00.717 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent0 - jdk.internal.misc.Unsafe.allocateUninitializedArray(int): unavailable: class io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent0$6 cannot access class jdk.internal.misc.Unsafe (in module java.base) because module java.base does not export jdk.internal.misc to unnamed module @4274d07b\r\n16:27:00.718 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent0 - java.nio.DirectByteBuffer.<init>(long, int): unavailable\r\n16:27:00.718 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent - sun.misc.Unsafe: available\r\n16:27:00.739 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent - maxDirectMemory: 536870912 bytes (maybe)\r\n16:27:00.739 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent - -Dio.netty.tmpdir: /var/folders/ks/0wppmjz10dx67djf4r910hs40000gn/T (java.io.tmpdir)\r\n16:27:00.739 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent - -Dio.netty.bitMode: 64 (sun.arch.data.model)\r\n16:27:00.740 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent - Platform: MacOS\r\n16:27:00.741 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent - -Dio.netty.maxDirectMemory: -1 bytes\r\n16:27:00.741 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent - -Dio.netty.uninitializedArrayAllocationThreshold: -1\r\n16:27:00.742 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.CleanerJava9 - java.nio.ByteBuffer.cleaner(): available\r\n16:27:00.742 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent - -Dio.netty.noPreferDirect: false\r\n16:27:00.807 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.channel.MultithreadEventLoopGroup - -Dio.netty.eventLoopThreads: 20\r\n16:27:00.819 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.InternalThreadLocalMap - -Dio.netty.threadLocalMap.stringBuilder.initialSize: 1024\r\n16:27:00.819 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.InternalThreadLocalMap - -Dio.netty.threadLocalMap.stringBuilder.maxSize: 4096\r\n16:27:00.823 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoop - -Dio.netty.noKeySetOptimization: false\r\n16:27:00.823 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoop - -Dio.netty.selectorAutoRebuildThreshold: 512\r\n16:27:00.828 [Test worker] DEBUG io.grpc.netty.shaded.io.netty.util.internal.PlatformDependent - org.jctools-core.MpscChunkedArrayQueue: available\r\n16:27:01.014 [Test worker] INFO io.temporal.serviceclient.WorkflowServiceStubsImpl - Created WorkflowServiceStubs for channel: ManagedChannelOrphanWrapper{delegate=ManagedChannelImpl{logId=1, target=127.0.0.1:7233}}\r\n16:27:01.160 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.util.ResourceLeakDetector - -Dio.grpc.netty.shaded.io.netty.leakDetection.level: simple\r\n16:27:01.161 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.util.ResourceLeakDetector - -Dio.grpc.netty.shaded.io.netty.leakDetection.targetRecords: 4\r\n16:27:01.168 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.AbstractByteBuf - -Dio.grpc.netty.shaded.io.netty.buffer.checkAccessible: true\r\n16:27:01.168 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.AbstractByteBuf - -Dio.grpc.netty.shaded.io.netty.buffer.checkBounds: true\r\n16:27:01.169 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.util.ResourceLeakDetectorFactory - Loaded default ResourceLeakDetector: io.grpc.netty.shaded.io.netty.util.ResourceLeakDetector@6d5fe24\r\n16:27:01.210 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.numHeapArenas: 5\r\n16:27:01.210 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.numDirectArenas: 5\r\n16:27:01.210 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.pageSize: 8192\r\n16:27:01.210 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.maxOrder: 11\r\n16:27:01.210 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.chunkSize: 16777216\r\n16:27:01.210 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.smallCacheSize: 256\r\n16:27:01.210 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.normalCacheSize: 64\r\n16:27:01.210 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.maxCachedBufferCapacity: 32768\r\n16:27:01.210 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.cacheTrimInterval: 8192\r\n16:27:01.211 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.cacheTrimIntervalMillis: 0\r\n16:27:01.212 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.useCacheForAllThreads: true\r\n16:27:01.212 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.PooledByteBufAllocator - -Dio.netty.allocator.maxCachedByteBuffersPerChunk: 1023\r\n16:27:01.268 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.channel.DefaultChannelId - -Dio.netty.processId: 30039 (auto-detected)\r\n16:27:01.270 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.util.NetUtil - -Djava.net.preferIPv4Stack: false\r\n16:27:01.270 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.util.NetUtil - -Djava.net.preferIPv6Addresses: false\r\n16:27:01.276 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.util.NetUtilInitializations - Loopback interface: lo0 (lo0, 0:0:0:0:0:0:0:1%lo0)\r\n16:27:01.277 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.util.NetUtil - Failed to get SOMAXCONN from sysctl and file /proc/sys/net/core/somaxconn. Default: 128\r\n16:27:01.279 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.channel.DefaultChannelId - -Dio.netty.machineId: f4:d4:88:ff:fe:61:1a:a9 (auto-detected)\r\n16:27:01.293 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.ByteBufUtil - -Dio.netty.allocator.type: pooled\r\n16:27:01.293 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.ByteBufUtil - -Dio.netty.threadLocalDirectBufferSize: 0\r\n16:27:01.293 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.buffer.ByteBufUtil - -Dio.netty.maxThreadLocalCharBufferSize: 16384\r\n16:27:01.314 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.util.Recycler - -Dio.netty.recycler.maxCapacityPerThread: 4096\r\n16:27:01.314 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.util.Recycler - -Dio.netty.recycler.ratio: 8\r\n16:27:01.314 [grpc-default-executor-0] DEBUG io.grpc.netty.shaded.io.netty.util.Recycler - -Dio.netty.recycler.chunkSize: 32\r\n16:27:01.333 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] OUTBOUND SETTINGS: ack=false settings={ENABLE_PUSH=0, MAX_CONCURRENT_STREAMS=0, INITIAL_WINDOW_SIZE=1048576, MAX_HEADER_LIST_SIZE=8192}\r\n16:27:01.341 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] OUTBOUND WINDOW_UPDATE: streamId=0 windowSizeIncrement=983041\r\n16:27:01.348 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] INBOUND SETTINGS: ack=false settings={MAX_FRAME_SIZE=16384}\r\n16:27:01.349 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] OUTBOUND SETTINGS: ack=true\r\n16:27:01.361 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] INBOUND SETTINGS: ack=true\r\n16:27:01.374 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] OUTBOUND HEADERS: streamId=3 headers=GrpcHttp2OutboundHeaders[:authority: 127.0.0.1:7233, :path: /temporal.api.workflowservice.v1.WorkflowService/GetClusterInfo, :method: POST, :scheme: http, content-type: application/grpc, te: trailers, user-agent: grpc-java-netty/1.46.0, client-version: 1.11.0, supported-server-versions: >=0.31.0 <2.0.0, client-name: temporal-java, grpc-accept-encoding: gzip, grpc-timeout: 99710624u] streamDependency=0 weight=16 exclusive=false padding=0 endStream=false\r\n16:27:01.382 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] OUTBOUND DATA: streamId=3 padding=0 endStream=true length=5 bytes=0000000000\r\n16:27:01.385 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] INBOUND WINDOW_UPDATE: streamId=0 windowSizeIncrement=5\r\n16:27:01.386 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] INBOUND PING: ack=false bytes=145258749040133895\r\n16:27:01.386 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] OUTBOUND PING: ack=true bytes=145258749040133895\r\n16:27:01.390 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] INBOUND HEADERS: streamId=3 headers=GrpcHttp2ResponseHeaders[:status: 200, content-type: application/grpc] padding=0 endStream=false\r\n16:27:01.398 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] INBOUND DATA: streamId=3 padding=0 endStream=false length=254 bytes=00000000f90a150a0b74656d706f72616c2d676f12063c322e302e300a150a0b74656d706f72616c2d756912063c332e302e300a190a0f74656d706f72616c2d...\r\n16:27:01.398 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] OUTBOUND PING: ack=false bytes=1234\r\n16:27:01.402 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] INBOUND HEADERS: streamId=3 headers=GrpcHttp2ResponseHeaders[grpc-status: 0, grpc-message: ] padding=0 endStream=true\r\n16:27:01.404 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 - R:/127.0.0.1:7233] INBOUND PING: ack=true bytes=1234\r\n16:27:04.731 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 ! R:/127.0.0.1:7233] OUTBOUND HEADERS: streamId=5 headers=GrpcHttp2OutboundHeaders[:authority: 127.0.0.1:7233, :path: /temporal.api.workflowservice.v1.WorkflowService/GetClusterInfo, :method: POST, :scheme: http, content-type: application/grpc, te: trailers, user-agent: grpc-java-netty/1.46.0, client-version: 1.11.0, supported-server-versions: >=0.31.0 <2.0.0, client-name: temporal-java, grpc-accept-encoding: gzip, grpc-timeout: 99999618u] streamDependency=0 weight=16 exclusive=false padding=0 endStream=false\r\n16:27:04.735 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 ! R:/127.0.0.1:7233] OUTBOUND GO_AWAY: lastStreamId=2147483647 errorCode=2 length=0 bytes=\r\n16:27:04.739 [grpc-nio-worker-ELG-1-3] DEBUG io.grpc.netty.shaded.io.netty.handler.codec.http2.Http2ConnectionHandler - [id: 0x5af84be4, L:/127.0.0.1:56236 ! R:/127.0.0.1:7233] Sending GOAWAY failed: lastStreamId '2147483647', errorCode '2', debugData ''. Forcing shutdown of the connection.\r\nio.grpc.netty.shaded.io.netty.channel.StacklessClosedChannelException: null\r\n\tat io.grpc.netty.shaded.io.netty.channel.AbstractChannel$AbstractUnsafe.write(Object, ChannelPromise)(Unknown Source)\r\nThrew exception :io.grpc.StatusRuntimeException: UNKNOWN: channel closed\r\nThrew exception :io.grpc.StatusRuntimeException: UNAVAILABLE: io exception\r\n16:27:10.112 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] OUTBOUND SETTINGS: ack=false settings={ENABLE_PUSH=0, MAX_CONCURRENT_STREAMS=0, INITIAL_WINDOW_SIZE=1048576, MAX_HEADER_LIST_SIZE=8192}\r\n16:27:10.116 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] OUTBOUND WINDOW_UPDATE: streamId=0 windowSizeIncrement=983041\r\n16:27:10.118 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] INBOUND SETTINGS: ack=false settings={MAX_FRAME_SIZE=16384}\r\n16:27:10.118 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] OUTBOUND SETTINGS: ack=true\r\n16:27:10.119 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] INBOUND SETTINGS: ack=true\r\n16:27:10.619 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] OUTBOUND HEADERS: streamId=3 headers=GrpcHttp2OutboundHeaders[:authority: 127.0.0.1:7233, :path: /temporal.api.workflowservice.v1.WorkflowService/GetClusterInfo, :method: POST, :scheme: http, content-type: application/grpc, te: trailers, user-agent: grpc-java-netty/1.46.0, client-version: 1.11.0, supported-server-versions: >=0.31.0 <2.0.0, client-name: temporal-java, grpc-accept-encoding: gzip, grpc-timeout: 99999533u] streamDependency=0 weight=16 exclusive=false padding=0 endStream=false\r\n16:27:10.621 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] OUTBOUND DATA: streamId=3 padding=0 endStream=true length=5 bytes=0000000000\r\n16:27:10.623 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] INBOUND WINDOW_UPDATE: streamId=0 windowSizeIncrement=5\r\n16:27:10.624 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] INBOUND PING: ack=false bytes=145258749040133895\r\n16:27:10.625 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] OUTBOUND PING: ack=true bytes=145258749040133895\r\n16:27:10.626 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] INBOUND HEADERS: streamId=3 headers=GrpcHttp2ResponseHeaders[:status: 200, content-type: application/grpc] padding=0 endStream=false\r\n16:27:10.627 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] INBOUND DATA: streamId=3 padding=0 endStream=false length=254 bytes=00000000f90a150a0b74656d706f72616c2d756912063c332e302e300a190a0f74656d706f72616c2d73657276657212063c322e302e300a160a0c74656d706f...\r\n16:27:10.627 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] OUTBOUND PING: ack=false bytes=1234\r\n16:27:10.629 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] INBOUND HEADERS: streamId=3 headers=GrpcHttp2ResponseHeaders[grpc-status: 0, grpc-message: ] padding=0 endStream=true\r\n16:27:10.631 [grpc-nio-worker-ELG-1-7] DEBUG io.grpc.netty.shaded.io.grpc.netty.NettyClientHandler - [id: 0x5463f454, L:/127.0.0.1:56261 - R:/127.0.0.1:7233] INBOUND PING: ack=true bytes=1234\r\n16:27:10.895 [grpc-connection-manager-thread-0] DEBUG io.temporal.serviceclient.ChannelManager - Resetting gRPC connection backoff on the gRPC channel ManagedChannelOrphanWrapper{delegate=ManagedChannelImpl{logId=1, target=127.0.0.1:7233}}\r\nCluster returned healthy after numAttempts: 2\r\n```\r\n\r\n>  To clarify @neshield, are you saying that your same client isn't able to successful call after server starts back up?\r\n\r\nThat is correct. The first call always fails, and the second one succeeds.\r\n\r\n@Spikhalskiy \r\n> It looks like the server was up according to your description, but for some reason, the connection attempt was refused.\r\nDo we have any proxies in the middle here? Envoy maybe? Or it's a fully local setup and the SDK connects to Temporal Servers directly?\r\n\r\nThis is a fully local environment. I'm running Java and temporalite on the same machine. I turned off my VPN just to make sure, and there was no difference in the result.\r\n\r\n----\r\nGiven that this doesn't actually require a multi cluster environment, should the issue be renamed?","createdAt":"2022-08-05T20:30:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1347#issuecomment-1206841175","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6u-6yP","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Closing due to inactivity, for user support we prefer our slack or forum.","createdAt":"2025-06-03T14:51:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1347#issuecomment-2935729295","viewerDidAuthor":false}],"createdAt":"2022-08-03T22:12:32Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1347,"reactionGroups":[],"state":"CLOSED","title":"The first getClusterInfo fails after restarting a temporalite cluster in a multi cluster environment","updatedAt":"2025-06-03T14:51:50Z","url":"https://github.com/temporalio/sdk-java/issues/1347"}
