{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjEyMTE3OTIz","is_bot":false,"login":"rubyhfu","name":""},"body":"## Expected Behavior\r\nworkflowStub.getResult should be waiting for workflow to complete synchronously and shouldn't skip timer without using testEnv.sleep()\r\n\r\n## Actual Behavior\r\nSkips timer and returns result immediately\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. WorkflowInterface\r\n\r\n```\r\nimport io.temporal.workflow.SignalMethod;\r\nimport io.temporal.workflow.WorkflowInterface;\r\nimport io.temporal.workflow.WorkflowMethod;\r\n\r\n@WorkflowInterface\r\npublic interface ExampleWorkflow {\r\n\r\n    @WorkflowMethod\r\n    public String execute(String s);\r\n\r\n    @SignalMethod\r\n    public void signal(boolean s);\r\n}\r\n\r\n```\r\n  2. WorkflowImpl1\r\n \r\n```\r\nimport java.time.Duration;\r\nimport io.temporal.workflow.Workflow;\r\n\r\npublic class ExampleWorkflowImpl implements ExampleWorkflow{\r\n    private boolean signal = false;\r\n\r\n    @Override\r\n    public String execute(String s) {\r\n        Workflow.await(Duration.ofMinutes(5L), () -> signal);\r\n        Workflow.sleep(Duration.ofMinutes(10L));\r\n        return s;\r\n    }\r\n\r\n    @Override\r\n    public void signal(boolean signal) {\r\n        this.signal = signal;\r\n    }\r\n}\r\n```\r\n  3. Run third test in test class\r\n \r\n```\r\npublic class ExampleWorkflowImplTest {\r\n    private TestWorkflowEnvironment testEnv;\r\n    private Worker worker1, worker2;\r\n    private WorkflowClient client;\r\n\r\n    @BeforeEach\r\n    public void setUp() {\r\n        testEnv = TestWorkflowEnvironment.newInstance();\r\n        worker1 = testEnv.newWorker(\"TEST_QUEUE1\");\r\n        worker2 = testEnv.newWorker(\"TEST_QUEUE2\");\r\n        worker1.registerWorkflowImplementationTypes(ExampleWorkflowImpl.class);\r\n        worker2.registerWorkflowImplementationTypes(ExampleWorkflow2Impl.class);\r\n        client = testEnv.getWorkflowClient();\r\n        testEnv.start();\r\n    }\r\n\r\n    @Test\r\n    public void testTerminateWorkflowSignalError() {\r\n        ExampleWorkflow workflow1 = client.newWorkflowStub(\r\n                ExampleWorkflow.class,\r\n                WorkflowOptions.newBuilder()\r\n                        .setWorkflowId(\"abc123\")\r\n                        .setTaskQueue(\"TEST_QUEUE1\")\r\n                        .build());\r\n\r\n        ExampleWorkflow workflow2 = client.newWorkflowStub(\r\n                ExampleWorkflow.class,\r\n                WorkflowOptions.newBuilder()\r\n                        .setTaskQueue(\"TEST_QUEUE2\")\r\n                        .build());\r\n\r\n        WorkflowExecution workflow1Execution = WorkflowClient.start(workflow1::execute, \"test\");\r\n\r\n        testEnv.sleep(Duration.ofMinutes(6L));\r\n\r\n        WorkflowExecution workflow2Execution = WorkflowClient.start(workflow2::execute, \"test\");\r\n        WorkflowStub workflowStub1 = WorkflowStub.fromTyped(workflow1);\r\n        workflowStub1.terminate(\"Mock terminating workflow\");\r\n\r\n        WorkflowStub workflowStub2 = WorkflowStub.fromTyped(workflow2);\r\n        workflowStub2.getResult(String.class);\r\n    }\r\n\r\n    @Test\r\n    public void testSetWorkflowExecutionTimeoutHangs() {\r\n        ExampleWorkflow workflow = client.newWorkflowStub(\r\n                ExampleWorkflow.class,\r\n                WorkflowOptions.newBuilder()\r\n                        // setting this makes the test hang... this normally works outside of TestWorkflowEnv\r\n                        .setWorkflowExecutionTimeout(Duration.ofSeconds(10))\r\n                        .setTaskQueue(\"TEST_QUEUE1\")\r\n                        .build());\r\n\r\n        WorkflowExecution workflowExecution = WorkflowClient.start(workflow::execute, \"test\");\r\n\r\n        // workflow execution timeout seems to clash with testEnv.sleep\r\n        testEnv.sleep(Duration.ofMinutes(5L));\r\n\r\n        WorkflowStub workflowStub = WorkflowStub.fromTyped(workflow);\r\n        String result = workflowStub.getResult(String.class);\r\n    }\r\n\r\n    @Test\r\n    public void testTestEnvSecondTimerSkipped() {\r\n        ExampleWorkflow workflow = client.newWorkflowStub(\r\n                ExampleWorkflow.class,\r\n                WorkflowOptions.newBuilder()\r\n                        .setTaskQueue(\"TEST_QUEUE1\")\r\n                        .build());\r\n\r\n        WorkflowExecution workflowExecution = WorkflowClient.start(workflow::execute, \"test\");\r\n\r\n        testEnv.sleep(Duration.ofMinutes(5L));\r\n\r\n        WorkflowStub workflowStub = WorkflowStub.fromTyped(workflow);\r\n        String result = workflowStub.getResult(String.class);\r\n        // why is this able to get past 2nd 10min-timer immediately without moving testEnv time further?\r\n        System.out.println(result);\r\n    }\r\n}\r\n\r\n```\r\n## Specifications\r\n\r\n  - Version: sdk 1.0.0, junit 5\r\n  - Platform: MacOS BigSur\r\n","closedAt":"2021-07-19T04:49:27Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg3NTkxNjczOQ==","author":{"login":"vkoby"},"authorAssociation":"CONTRIBUTOR","body":"Hi @rubyhfu ,\r\nFor clarity, you're probably using sdk 1.1.0, not 1.0.0 right?","createdAt":"2021-07-07T20:39:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/578#issuecomment-875916739","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg3NTk1OTIyMw==","author":{"login":"rubyhfu"},"authorAssociation":"NONE","body":"@vkoby we are stuck using 1.0.0 due to some dependencies issue right now.... let me know if you don't see these reported issues in newer version. thanks!","createdAt":"2021-07-07T21:52:25Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/578#issuecomment-875959223","viewerDidAuthor":false},{"id":"IC_kwDODN12PM40lc6X","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"This is actually not a bug, but a feature. It's implemented in `TimeLockingInterceptor` that is used by default in the test environment: https://github.com/temporalio/sdk-java/blob/a25cafa5d363342e77af9cb4719ad7dce4dbfe43/temporal-testing/src/main/java/io/temporal/testing/TestWorkflowEnvironmentInternal.java#L304\r\nWe trigger unlimited time skipping after `getResult` is called and disable it after the workflow result is ready to be returned.\r\nThis is done to remove frustration from unit tests writers. When a unit test triggers `#getResult`, we think that the test authors are not interested in waiting for the time to pass at a regular pace.\r\nI close this issue right now because it's not a bug. But I assume that there could be some type of tests we didn't think of that this feature makes trickier to implement than it should be. Please reopen this issue if you see a reason why this behavior should be made optional. Also, feel free to ping me on Slack to discuss.","createdAt":"2021-07-19T04:45:57Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/578#issuecomment-882232983","viewerDidAuthor":false}],"createdAt":"2021-07-07T03:55:31Z","labels":[{"id":"MDU6TGFiZWwzMTgwNzE1ODU0","name":"invalid","description":"This doesn't seem right","color":"e4e669"}],"milestone":null,"number":578,"reactionGroups":[],"state":"CLOSED","title":"TestEnv: WorkflowStub.getResult seems to skip timer ","updatedAt":"2021-07-19T04:49:27Z","url":"https://github.com/temporalio/sdk-java/issues/578"}
