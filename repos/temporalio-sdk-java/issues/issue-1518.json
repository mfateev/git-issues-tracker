{"assignees":[],"author":{"id":"MDQ6VXNlcjM2MTY3ODE1","is_bot":false,"login":"idkomarov","name":"Mikhail Komarov"},"body":"## Description\r\nI am trying to test my Temporal Workflow using temporal java-sdk, temporal-testing, JUnit and Mockito. This workflow has single workflow method including single activity method execution. As activity method uses external service, in unit test I use its mock. I've written multiple tests which check multiple workflow behaviors. Each test passes when launches separately, but if I run whole test class only first test passes and all next tests fail: **my mocking declarations in** `when` **construction don't work in failed tests, workflows fall because they couldn't connect to external service**. Tried to launch tests using different constructions and different Temporal sdk version but have the same behavior.\r\n\r\n## Expected Behavior\r\nAll tests pass when they launch together.\r\n\r\n## Actual Behavior\r\nOnly first test passes and all other fail when they launch together.\r\n\r\n## Steps to Reproduce the Problem\r\n1. Write Workflow & Activity according to description above\r\n2. Run test like this (`ActivityInterface` - `ExternalServiceHelper`, `WorflowInterface` - `SomeFeatureDeactivator`)\r\n```\r\n@SpringBootTest\r\n@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\r\nclass SomeFeatureDeactivatorImplTest {\r\n\r\n    private TestWorkflowEnvironment testEnv;\r\n    private Worker worker;\r\n    private WorkflowClient client;\r\n\r\n    private static final String ID = \"123\";\r\n\r\n    @MockBean\r\n    ExternalServiceHelperImpl externalServiceHelper;\r\n\r\n    @BeforeEach\r\n    public void setUp() {\r\n        testEnv = TestWorkflowEnvironment.newInstance();\r\n        worker = testEnv.newWorker(QUEUE);\r\n        worker.registerWorkflowImplementationTypes(SomeFeatureDeactivatorImpl.class);\r\n        worker.registerActivitiesImplementations(externalServiceHelper);\r\n        client = testEnv.getWorkflowClient();\r\n        testEnv.start();\r\n    }\r\n\r\n    @AfterEach\r\n    public void tearDown() {\r\n        testEnv.close();\r\n    }\r\n\r\n    @Test\r\n    @Timeout(10)\r\n    @Order(0)\r\n    void processEntityWithIdTest_givenIdIsNull() {\r\n        // given, when\r\n        WorkflowOptions workflowOptions = WorkflowOptions.newBuilder()\r\n                .setTaskQueue(QUEUE)\r\n                .build();\r\n        SomeFeatureDeactivator someFeatureDeactivator =\r\n                client.newWorkflowStub(SomeFeatureDeactivator.class, workflowOptions);\r\n\r\n        someFeatureDeactivator.processEntityWithId(null);\r\n\r\n        // then\r\n        verify(externalServiceHelper, never()).sendMessageToDeactivateFeature(null);\r\n    }\r\n\r\n    @Test\r\n    @Timeout(10)\r\n    @Order(1)\r\n    void processEntityWithIdTest() {\r\n        // given\r\n        doNothing().when(externalServiceHelper).sendMessageToDeactivateFeature(anyString());\r\n\r\n        // when\r\n        WorkflowOptions workflowOptions = WorkflowOptions.newBuilder()\r\n                .setTaskQueue(QUEUE)\r\n                .build();\r\n        SomeFeatureDeactivator someFeatureDeactivator =\r\n                client.newWorkflowStub(SomeFeatureDeactivator.class, workflowOptions);\r\n\r\n        someFeatureDeactivator.processEntityWithId(ID);\r\n\r\n        // then\r\n        verify(externalServiceHelper, only()).sendMessageToDeactivateFeature(ID);\r\n    }\r\n\r\n    @Test\r\n    @Timeout(10)\r\n    @Order(2)\r\n    void processEntityWithIdTest_retrySendToMessageToExternalService() {\r\n        // given\r\n        doThrow(new RuntimeException())\r\n                .doThrow(new RuntimeException())\r\n                .doThrow(new RuntimeException())\r\n                .doNothing()\r\n                .when(externalServiceHelper).sendMessageToDeactivateFeature(anyString());\r\n\r\n        // when\r\n        WorkflowOptions workflowOptions = WorkflowOptions.newBuilder()\r\n                .setTaskQueue(QUEUE)\r\n                .build();\r\n        SomeFeatureDeactivator someFeatureDeactivator =\r\n                client.newWorkflowStub(SomeFeatureDeactivator.class, workflowOptions);\r\n\r\n        someFeatureDeactivator.processEntityWithId(ID);\r\n\r\n        // then\r\n        verify(externalServiceHelper, times(4)).sendMessageToDeactivateFeature(ID);\r\n    }\r\n}\r\n\r\n```\r\n3. Get tests with order numbers 1 and 2 failed because `%test_name% timed out after 10 seconds`\r\n\r\nGot his log on failed `processEntityWithIdTest`\r\n```\r\n2022-11-16 15:28:18.165  INFO 11416 --- [    Test worker] io.temporal.internal.worker.Poller       : start: Poller{name=Workflow Poller taskQueue=\"UPDATE_DP_ATTRS_QUEUE;\", namespace=\"default\", identity=MY-PC-NAME}\r\n2022-11-16 15:28:18.165  INFO 11416 --- [    Test worker] io.temporal.internal.worker.Poller       : start: Poller{name=Local Activity Poller taskQueue=\"UPDATE_DP_ATTRS_QUEUE;\", namespace=\"default\", identity=MY-PC-NAME}\r\n2022-11-16 15:28:18.166  INFO 11416 --- [    Test worker] io.temporal.internal.worker.Poller       : start: Poller{name=Activity Poller taskQueue=\"UPDATE_DP_ATTRS_QUEUE;\", namespace=\"default\", identity=MY-PC-NAME}\r\n2022-11-16 15:28:18.169  INFO 11416 --- [    Test worker] io.temporal.internal.worker.Poller       : start: Poller{name=Sticky Workflow Poller taskQueue=\"MY-PC-NAME:91c759e5-3a72-41da-b740-6a1208cdc07b\", namespace=\"default\", identity=MY-PC-NAME}\r\n2022-11-16 15:28:18.239  WARN 11416 --- [ce=\"default\": 1] i.t.i.replay.ReplayWorkflowTaskHandler   : Workflow task processing failure. startedEventId=3, WorkflowId=160396d9-ad8d-4cab-9f69-c770278e6a7a, RunId=92e9b27d-72d4-470b-b74c-fdc4c4d87991. If seen continuously the workflow might be stuck.\r\n\r\nio.temporal.internal.statemachines.InternalWorkflowTaskException: Failure handling event 3 of type 'EVENT_TYPE_WORKFLOW_TASK_STARTED' during execution. {PreviousStartedEventId=0, WorkflowTaskStartedEventId=3, CurrentStartedEventId=3}\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.createEventProcessingException(WorkflowStateMachines.java:263) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEventsBatch(WorkflowStateMachines.java:242) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:216) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:190) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:137) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithQuery(ReplayWorkflowTaskHandler.java:129) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:98) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handleTask(WorkflowWorker.java:293) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:237) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:178) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:93) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[na:na]\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[na:na]\r\n\tat java.base/java.lang.Thread.run(Thread.java:829) ~[na:na]\r\nCaused by: java.lang.RuntimeException: WorkflowTask: failure executing SCHEDULED->WORKFLOW_TASK_STARTED, transition history is [CREATED->WORKFLOW_TASK_SCHEDULED]\r\n\tat io.temporal.internal.statemachines.StateMachine.executeTransition(StateMachine.java:152) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.statemachines.StateMachine.handleHistoryEvent(StateMachine.java:102) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.statemachines.EntityStateMachineBase.handleEvent(EntityStateMachineBase.java:68) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleSingleEvent(WorkflowStateMachines.java:276) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEventsBatch(WorkflowStateMachines.java:240) ~[temporal-sdk-1.14.0.jar:na]\r\n\t... 12 common frames omitted\r\nCaused by: java.lang.IllegalStateException: Operation allowed only while eventLoop is running\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.checkEventLoopExecuting(WorkflowStateMachines.java:1061) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.randomUUID(WorkflowStateMachines.java:717) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.replay.ReplayWorkflowContextImpl.scheduleActivityTask(ReplayWorkflowContextImpl.java:212) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.sync.SyncWorkflowContext.executeActivityOnce(SyncWorkflowContext.java:251) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.sync.SyncWorkflowContext.executeActivity(SyncWorkflowContext.java:236) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.sync.ActivityStubImpl.executeAsync(ActivityStubImpl.java:50) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.sync.ActivityStubBase.execute(ActivityStubBase.java:39) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.sync.ActivityInvocationHandler.lambda$getActivityFunc$0(ActivityInvocationHandler.java:78) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.sync.ActivityInvocationHandlerBase.invoke(ActivityInvocationHandlerBase.java:71) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat com.sun.proxy.$Proxy173.sendMessageToDeactivateFeature(Unknown Source) ~[na:na]\r\n\tat my.service.SomeFeatureDeactivatorImpl.processEntityWithId(SomeFeatureDeactivatorImpl.java:26) ~[main/:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[na:na]\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[na:na]\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566) ~[na:na]\r\n\tat io.temporal.internal.sync.POJOWorkflowImplementationFactory$POJOWorkflowImplementation$RootWorkflowInboundCallsInterceptor.execute(POJOWorkflowImplementationFactory.java:310) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.sync.POJOWorkflowImplementationFactory$POJOWorkflowImplementation.execute(POJOWorkflowImplementationFactory.java:285) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.sync.WorkflowExecuteRunnable.run(WorkflowExecuteRunnable.java:68) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.sync.SyncWorkflow.lambda$start$0(SyncWorkflow.java:135) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.sync.CancellationScopeImpl.run(CancellationScopeImpl.java:102) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.internal.sync.WorkflowThreadImpl$RunnableWrapper.run(WorkflowThreadImpl.java:107) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat io.temporal.worker.WorkerFactory.lambda$newWorkflowThreadExecutor$7(WorkerFactory.java:392) ~[temporal-sdk-1.14.0.jar:na]\r\n\tat java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515) ~[na:na]\r\n\tat java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264) ~[na:na]\r\n\t... 3 common frames omitted\r\n```\r\n\r\n## Additional attempts\r\nI tried to launch tests in various ways: using tutorials from documentation & java-samples\r\nThis variant\r\n```\r\n@SpringBootTest\r\n@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\r\nclass SomeFeatureDeactivatorImplTest {\r\n\r\n    @MockBean\r\n    ExternalServiceHelperImpl externalServiceHelper;\r\n\r\n    @RegisterExtension\r\n    public static final TestWorkflowExtension testWorkflowExtension =\r\n        TestWorkflowExtension.newBuilder()\r\n                .setWorkflowTypes(SomeFeatureDeactivatorImpl.class)\r\n                .setDoNotStart(true)\r\n                .build();\r\n\r\n    @Test\r\n    @Timeout(10)\r\n    @Order(0)\r\n    void processEntityWithIdTest_givenIdIsNull(TestWorkflowEnvironment testEnv, Worker worker, SomeFeatureDeactivator someFeatureDeactivator) {\r\n        worker.registerActivitiesImplementations(externalServiceHelper);\r\n        testEnv.start();\r\n\r\n        // given, when\r\n        someFeatureDeactivator.processEntityWithId(null);\r\n\r\n        // then\r\n        verify(externalServiceHelper, never()).sendMessageToDeactivateFeature(null);\r\n    }\r\n    ... // same way for other tests\r\n```\r\nand this\r\n```\r\n@TestMethodOrder(MethodOrderer.OrderAnnotation.class)\r\nclass SomeFeatureDeactivatorImplTest {\r\n\r\n    @BeforeEach\r\n    public void setUp() {\r\n        testEnv = TestWorkflowEnvironment.newInstance();\r\n        worker = testEnv.newWorker(QUEUE);\r\n        worker.registerWorkflowImplementationTypes(SomeFeatureDeactivatorImpl.class);\r\n        client = testEnv.getWorkflowClient();\r\n    }\r\n\r\n    @AfterEach\r\n    public void tearDown() {\r\n        testEnv.close();\r\n    }\r\n\r\n    @Test\r\n    @Timeout(10)\r\n    @Order(0)\r\n    void processEntityWithIdTest_givenIdIsNull() {\r\n        // given, when\r\n        ExternalServiceHelper externalServiceHelper = mock(ExternalServiceHelper.class, withSettings().withoutAnnotations());\r\n        worker.registerActivitiesImplementations(externalServiceHelper);\r\n        testEnv.start();\r\n\r\n        WorkflowOptions workflowOptions = WorkflowOptions.newBuilder()\r\n                .setTaskQueue(QUEUE)\r\n                .build();\r\n        SomeFeatureDeactivator someFeatureDeactivator =\r\n                client.newWorkflowStub(SomeFeatureDeactivator.class, workflowOptions);\r\n\r\n        someFeatureDeactivator.processEntityWithId(null);\r\n\r\n        // then\r\n        verify(externalServiceHelper, never()).sendMessageToDeactivateFeature(null);\r\n    }\r\n    ... // same way for other tests\r\n```\r\ndon't work too\r\n## Specifications\r\n\r\n  - Version: 1.14 or 1.17\r\n  - Platform: Java\r\n","closedAt":"2022-11-18T16:08:30Z","comments":[{"id":"IC_kwDODN12PM5OgTwI","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Please provide a full reproduction that can be launched locally.\r\n\r\n> Write Workflow & Activity according to description above\r\n\r\nNot enough information without looking at actual implementations.\r\n\r\nBut I'm pretty sure that what is going on here is ActivityStubs are shared between workflow instances, which is not allowed.\r\n\r\n","createdAt":"2022-11-16T14:16:44Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1518#issuecomment-1317092360","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5OsRIN","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Please feel free to reopen with a reproduction","createdAt":"2022-11-18T16:08:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1518#issuecomment-1320227341","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5PTZSP","author":{"login":"idkomarov"},"authorAssociation":"NONE","body":"> Please provide a full reproduction that can be launched locally.\r\n\r\nHello again. I'm back with a reproduction that can be run locally along with tests above. All classes stored as separate files as `public` modificator hints :)\r\n```\r\n@ActivityInterface\r\npublic interface ExternalServiceHelper {\r\n    void sendMessageToDeactivateFeature(String id);\r\n}\r\n\r\n@Component\r\npublic class ExternalServiceHelperImpl implements ExternalServiceHelper {\r\n    private final Random random = new Random();\r\n\r\n    @Override\r\n    public void sendMessageToDeactivateFeature(String id) {\r\n        // this is actually a kafka producer invokation\r\n        if (random.nextDouble() <= 0.5D) {\r\n            throw new RuntimeException();\r\n        }\r\n    }\r\n}\r\n\r\n@WorkflowInterface\r\npublic interface SomeFeatureDeactivator {\r\n    @WorkflowMethod\r\n    void processEntityWithId(String id);\r\n}\r\n\r\npublic class SomeFeatureDeactivatorImpl implements SomeFeatureDeactivator {\r\n    public static final RetryOptions DEFAULT_RETRY_OPTIONS = RetryOptions.newBuilder()\r\n            .setInitialInterval(Duration.ofSeconds(1))\r\n            .setMaximumInterval(Duration.ofSeconds(10))\r\n            .setBackoffCoefficient(2)\r\n            .setMaximumAttempts(100)\r\n            .build();\r\n\r\n    public static final ActivityOptions DEFAULT_ACTIVITY_OPTIONS = ActivityOptions.newBuilder()\r\n            .setStartToCloseTimeout(Duration.ofSeconds(5))\r\n            .setRetryOptions(DEFAULT_RETRY_OPTIONS)\r\n            .build();\r\n\r\n    private static final ExternalServiceHelper externalServiceHelper =\r\n            Workflow.newActivityStub(ExternalServiceHelper.class, DEFAULT_ACTIVITY_OPTIONS);\r\n\r\n    @Override\r\n    public void processEntityWithId(String id) {\r\n        if (Objects.isNull(id)) {\r\n            return;\r\n        }\r\n\r\n        // this is actually some preparations\r\n\r\n        externalServiceHelper.sendMessageToDeactivateFeature(id);\r\n    }\r\n}\r\n```","createdAt":"2022-11-29T11:29:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1518#issuecomment-1330484367","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5PU0wt","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"@idkomarov \r\n```\r\n    private static final ExternalServiceHelper externalServiceHelper =\r\n            Workflow.newActivityStub(ExternalServiceHelper.class, DEFAULT_ACTIVITY_OPTIONS);\r\n```\r\n\r\nAs I pointed out earlier, stubs can't be shared between workflow instances. They need to be created during workflow instance initialization in a workflow code. Either removing `static` or moving the creation of the stub inside the workflow code will solve your problem.\r\nRelated issue: https://github.com/temporalio/sdk-java/issues/746","createdAt":"2022-11-29T15:50:39Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/1518#issuecomment-1330859053","viewerDidAuthor":false}],"createdAt":"2022-11-16T13:23:48Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQ4","name":"question","description":"Further information is requested","color":"BFD4F2"}],"milestone":null,"number":1518,"reactionGroups":[],"state":"CLOSED","title":"Multiple tests launched from test class with mocked activity method fail, but each when launch separately passes","updatedAt":"2022-11-29T15:51:52Z","url":"https://github.com/temporalio/sdk-java/issues/1518"}
