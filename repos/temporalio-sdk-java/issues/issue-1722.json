{"assignees":[],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"\"last workflow task of the workflow\" in this ticket means the WFT that will complete workflow method execution and will lead to `CompleteWorkflowExecution` command. \r\n\r\n## Expected Behavior\r\n\r\nIf the workflow receives a signal in the last workflow task, this signal should be successfully processed first and the workflow should complete after that.\r\n\r\n## Actual Behavior\r\n\r\nIf workflow receives a signal with the last workflow task and this signal starts a local activity and the workflow method is not explicitly waiting for the signal completion, it leads to \r\n\r\n```\r\nio.grpc.StatusRuntimeException: INVALID_ARGUMENT: invalid command sequence: [CompleteWorkflowExecution, RecordMarker], command CompleteWorkflowExecution must be the last command.\r\n```\r\n\r\nSee https://github.com/Spikhalskiy/java-sdk/commit/c0a397ec4e5e0101b70f417ff4d244df7c291c26 for a test reproducing the problem.\r\n\r\n## Proposed solutions\r\n\r\nOne of:\r\n\r\n1. Completion of the workflow method shouldn't lead to an immediate `CompleteWorkflowExecution` command. Instead, `CompleteWorkflowExecution` should be issued at the end of that workflow task.\r\n2. Completion of the workflow method shouldn't lead to an immediate `CompleteWorkflowExecution` command. Instead, `CompleteWorkflowExecution` should be issued at the end of all workflow threads (including Async and Signal)\r\n3. If the first two are hard to implement and maintain backward compatibility, CompleteWorkflowExecution` should be the last command written. All commands after it should be discarded. This is the least graceful way of handling this situation.","closedAt":"2023-10-25T17:05:57Z","comments":[{"id":"IC_kwDODN12PM5ZFgog","author":{"login":"longquanzheng"},"authorAssociation":"NONE","body":"Hey @Spikhalskiy , probably just ciruous, is that only an issue with local activity? What about other commands like activity scheduled or childWF or upsert search attributes?","createdAt":"2023-04-03T16:18:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1722#issuecomment-1494616608","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5ZFp2M","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"It's true for any command happening in a signal after a yield if the workflow method doesn't wait for the signal method completion.","createdAt":"2023-04-03T16:46:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1722#issuecomment-1494654348","viewerDidAuthor":false}],"createdAt":"2023-03-28T02:18:11Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1722,"reactionGroups":[],"state":"CLOSED","title":"Signal with a local activity in the last Workflow Task hangs the workflow execution","updatedAt":"2023-10-25T17:05:57Z","url":"https://github.com/temporalio/sdk-java/issues/1722"}
