{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNTA0MDQ5","is_bot":false,"login":"Quinn-With-Two-Ns","name":"Quinn Klassen"},"body":"The following test case should pass\r\n\r\n```\r\npublic class LocalActivityAfterCancelTest {\r\n  private final TestActivitiesImpl activitiesImpl = new TestActivitiesImpl();\r\n\r\n  @Rule\r\n  public SDKTestWorkflowRule testWorkflowRule =\r\n      SDKTestWorkflowRule.newBuilder()\r\n          .setUseExternalService(true)\r\n          .setWorkflowTypes(TestLocalActivityRetry.class, BlockingWorkflow.class)\r\n          .setActivityImplementations(activitiesImpl)\r\n          .build();\r\n\r\n  @Test\r\n  public void localActivityAfterChildWorkflowCanceled() {\r\n    TestWorkflow1 workflowStub =\r\n        testWorkflowRule.newWorkflowStubTimeoutOptions(TestWorkflow1.class);\r\n    WorkflowClient.execute(workflowStub::execute, \"input\");\r\n    WorkflowStub.fromTyped(workflowStub).cancel();\r\n    WorkflowFailedException exception =\r\n        Assert.assertThrows(WorkflowFailedException.class, () -> workflowStub.execute(\"input\"));\r\n    Assert.assertEquals(\r\n        EventType.EVENT_TYPE_WORKFLOW_EXECUTION_CANCELED, exception.getWorkflowCloseEventType());\r\n  }\r\n\r\n  @Test\r\n  public void testLocalActivityAfterChildWorkflowCanceledReplay() {\r\n    assertThrows(\r\n        RuntimeException.class,\r\n        () ->\r\n            WorkflowReplayer.replayWorkflowExecutionFromResource(\r\n                \"testLocalActivityAfterCancelTest.json\",\r\n                LocalActivityAfterCancelTest.TestLocalActivityRetry.class));\r\n  }\r\n\r\n  @WorkflowInterface\r\n  public static class BlockingWorkflow implements TestWorkflows.TestWorkflowReturnString {\r\n    @Override\r\n    public String execute() {\r\n      Workflow.await(() -> false);\r\n      return \"\";\r\n    }\r\n  }\r\n\r\n  public static class TestLocalActivityRetry implements TestWorkflow1 {\r\n\r\n    @Override\r\n    public String execute(String taskQueue) {\r\n      try {\r\n        ChildWorkflowOptions childOptions =\r\n            ChildWorkflowOptions.newBuilder()\r\n                .setWorkflowId(Workflow.getInfo().getWorkflowId() + \"-child1\")\r\n                .setCancellationType(ChildWorkflowCancellationType.WAIT_CANCELLATION_REQUESTED)\r\n                .setParentClosePolicy(ParentClosePolicy.PARENT_CLOSE_POLICY_REQUEST_CANCEL)\r\n                .validateAndBuildWithDefaults();\r\n        TestWorkflows.TestWorkflowReturnString child =\r\n            Workflow.newChildWorkflowStub(\r\n                TestWorkflows.TestWorkflowReturnString.class, childOptions);\r\n        child.execute();\r\n      } catch (TemporalFailure e) {\r\n        if (CancellationScope.current().isCancelRequested()) {\r\n          Workflow.newDetachedCancellationScope(\r\n                  () -> {\r\n                    VariousTestActivities act =\r\n                        Workflow.newLocalActivityStub(\r\n                            VariousTestActivities.class,\r\n                            LocalActivityOptions.newBuilder()\r\n                                .setStartToCloseTimeout(Duration.ofSeconds(5))\r\n                                .validateAndBuildWithDefaults());\r\n                    act.activity1(10);\r\n                  })\r\n              .run();\r\n          throw e;\r\n        }\r\n      }\r\n      return \"ignored\";\r\n    }\r\n  }\r\n}\r\n\r\n```\r\nIt fails with an error like\r\n```\r\n\tLocalActivity: invalid REQUEST_PREPARED->NON_REPLAY_WORKFLOW_TASK_STARTED, transition history is [CREATED->CHECK_EXECUTION_STATE, EXECUTING->SCHEDULE]\r\n\r\n```\r\n\r\nSee also: https://community.temporal.io/t/workflowtask-failure-because-of-an-invalid-state-transition-in-localactivity-state-machine/12895/3\r\n","closedAt":"2024-07-30T18:32:37Z","comments":[],"createdAt":"2024-07-27T01:58:39Z","labels":[],"milestone":null,"number":2155,"reactionGroups":[],"state":"CLOSED","title":"WorkflowTask failure because of an invalid state transition in LocalActivity state machine","updatedAt":"2024-07-30T18:32:37Z","url":"https://github.com/temporalio/sdk-java/issues/2155"}
