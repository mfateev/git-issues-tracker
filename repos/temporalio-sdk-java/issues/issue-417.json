{"assignees":[{"id":"MDQ6VXNlcjIwNTI3OTk5","login":"vkoby","name":"Vera","databaseId":0}],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"## Expected Behavior\r\n```\r\n@Rule\r\npublic TestWorkflowRule workflowRule =\r\n       TestWorkflowRule.newBuilder()\r\n            .setWorkerFactoryOptions(WorkerFactoryOptions.newBuilder().setWorkerInterceptors(workerInterceptor).build())\r\n            //...\r\n            .build();\r\n```\r\nYou would expect that `workerInterceptor` will be respected and used. \r\n\r\n## Actual Behavior\r\nTestWorkflowRule inside will create WorkerFactoryOptions without interceptors:\r\n```\r\n    workerFactoryOptions =\r\n        (builder.workerFactoryOptions == null)\r\n            ? WorkerFactoryOptions.newBuilder().setWorkerInterceptors(interceptors).build()\r\n            : builder.workerFactoryOptions.toBuilder().setWorkerInterceptors(interceptors).build(); // here workerInterceptor will be thrown away\r\n```\r\nThe reason is an incorrect refactoring when TestWorkflowRule first got `setWorkerInterceptors()` method and after that `setWorkerFactoryOptions` with forced rewriting of `WorkerFactoryOptions#workerInterceptors` with collection provided (or nor provided) in the separate `setWorkerInterceptors()`.\r\n\r\n`TestWorkflowRule` also has a mess inside with naming. `Builder#workerInterceptors` is copied into `#interceptors`, etc. Name \"interceptors\" shouldn't be used at all for a class field, because there are at least client and worker interceptors (which inside consist of more subtypes). So, we should use more specific names that encode which kind of interceptors we are working with here. `workerInterceptors` is a much better idea.\r\n\r\n## Proposed solution\r\n\r\nRemove this separate new `setWorkflowInterceptors` method from `TestWorkflowRule` and Builder completely and supply workerInterceptors inside `WorkerFactoryOptions`. It's much cleaner, consistent with actual internals and options structure, and with the way how client interceptors now are supplied inside `WorkflowClientOptions`.","closedAt":"2021-04-02T22:48:43Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDgxMTY0ODEwNA==","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"@vkoby this bug is introduced by the recent refactorings.","createdAt":"2021-04-01T05:23:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/417#issuecomment-811648104","viewerDidAuthor":false}],"createdAt":"2021-04-01T05:22:44Z","labels":[],"milestone":null,"number":417,"reactionGroups":[],"state":"CLOSED","title":"TestWorkflowRule get workerInterceptors from two different sources and merges them incorrectly","updatedAt":"2021-07-16T01:04:37Z","url":"https://github.com/temporalio/sdk-java/issues/417"}
