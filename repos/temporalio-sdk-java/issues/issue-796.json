{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjE5MjcyODY=","is_bot":false,"login":"jrpedrianes","name":"Jorge Rodr√≠guez Pedrianes"},"body":"## Expected Behavior\r\nWhen starting a workflow, context propagated configured at workflow client level must be used.\r\n\r\n## Actual Behavior\r\nIs not invoked and must be defined using `WorkflowOptions`\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nIn the following link, I created an example class in which we can see that the \"serializeContext\" method is not invoked before the workflow is started.\r\n\r\nhttps://gist.github.com/jrpedrianes/2759391fa22311edf214932eeb3fd4b3\r\n\r\n## Specifications\r\n\r\n  - Version: sdk-java 1.3.1\r\n","closedAt":"2021-10-06T17:09:27Z","comments":[{"id":"IC_kwDODN12PM43s-dh","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Hi Jorge, \r\n\r\nIt's like that by design.\r\n\r\nSome clues why it's done this way:\r\n1. Imagine your client and worker are not the same app and have different classes in their classpath. A context propagator that is registered on the client side could even not exist in a classpath of the worker. _There is theoretically a way to get over it by sending a bytecode, but this solution is full of drawbacks and limitations and not worth doing taking into account that it's not the only limitation._\r\n2. Imagine we don't have the first problem and they do exist. ContextPropagator could have a non-default constructor, have external instances injected into it, etc. We don't require ContextPropagators to be serializable and this would impose serious limitations on them. So, it's not like we can safely serialize ContextPropagator and send it to the worker.\r\n3. Think about a client that is implemented in Go and worker code is in java, how do we propagate Go context propagator implementation to JVM worker?\r\n\r\nTemporal may one day consider adding functionality that a worker should not apply a worker propagator if the same type of propagator is not registered on the client. But we definitely can't just set up propagators on a client-side including our multi-lang nature and loose restrictions on ContextPropagators.","createdAt":"2021-10-05T15:54:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/796#issuecomment-934537057","viewerDidAuthor":false},{"id":"IC_kwDODN12PM43tW6T","author":{"login":"jrpedrianes"},"authorAssociation":"NONE","body":"Yes, I understand that we need to register the \"same\" ContextPropagators in all workers that are required, and must be implemented using different languages (Java, Go...)\r\n\r\nBut maybe my confusion was thinking that when I register a context propagator in a WorkflowClient instance, ie: \r\n\r\n```\r\n        WorkflowClient client = WorkflowClient\r\n            .newInstance(service, WorkflowClientOptions.newBuilder()\r\n                .setContextPropagators(List.of(new DummyContextPropagator()))\r\n                .validateAndBuildWithDefaults());\r\n```\r\n\r\nThe context propagators register there, will be used in all the resources using that client, ie:\r\n```\r\nWorkerFactory factory = WorkerFactory.newInstance(client);\r\n```\r\nand:\r\n```\r\n        GreetingWorkflow workflow =\r\n            client.newWorkflowStub(\r\n                GreetingWorkflow.class,\r\n                WorkflowOptions.newBuilder()\r\n                    .setWorkflowId(WORKFLOW_ID)\r\n                    .setTaskQueue(TASK_QUEUE)\r\n                    .validateBuildWithDefaults());\r\n```\r\n\r\nMaybe it is useful to add a Javadoc documentation that the context propagator will not be applied when we are creating a client stub.\r\n","createdAt":"2021-10-05T17:58:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/796#issuecomment-934637203","viewerDidAuthor":false},{"id":"IC_kwDODN12PM43tYIH","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"If in the snippets above context propagators are not promoted to the stubs created this way, it's a bug. Thank you for the clarification!","createdAt":"2021-10-05T18:04:47Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/796#issuecomment-934642183","viewerDidAuthor":false},{"id":"IC_kwDODN12PM43ta9L","author":{"login":"jrpedrianes"},"authorAssociation":"NONE","body":"I was debugging a workflow invocation and I could not see where the context propagation, defined using  WorkflowClientOptions, could be used.\r\n\r\nSeems that should be used in: \r\n\r\n- [WorkflowStubImpl.java](https://github.com/temporalio/sdk-java/blob/master/temporal-sdk/src/main/java/io/temporal/internal/sync/WorkflowStubImpl.java)\r\n- [RootWorkflowClientInvoker.java](https://github.com/temporalio/sdk-java/blob/master/temporal-sdk/src/main/java/io/temporal/internal/client/RootWorkflowClientInvoker.java)\r\n- [RootWorkflowClientHelper.java](https://github.com/temporalio/sdk-java/blob/0fedb5438bac22445e0c3f660af3cd717b22665a/temporal-sdk/src/main/java/io/temporal/internal/client/RootWorkflowClientHelper.java)\r\n\r\nBut I could not see any reference to `clientOptions.getContextPropagators()`","createdAt":"2021-10-05T18:19:49Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/796#issuecomment-934653771","viewerDidAuthor":false},{"id":"IC_kwDODN12PM43tbRP","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"For now, as a workaround, set the propagators on the WorkflowOptions. It should be fixed in 1.4.0 or 1.5.0.\r\nI believe the options are propagated to the worker through: https://github.com/temporalio/sdk-java/blob/1eededde098e213471e2ba60cd9b119c66b04c34/temporal-sdk/src/main/java/io/temporal/worker/WorkerFactory.java#L181\r\n","createdAt":"2021-10-05T18:21:35Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/796#issuecomment-934655055","viewerDidAuthor":false},{"id":"IC_kwDODN12PM43teQO","author":{"login":"jrpedrianes"},"authorAssociation":"NONE","body":"Now, we are using an interceptor to add it to all the client stubs, so we only need to touch one class. \r\n\r\nThank a lot!! ","createdAt":"2021-10-05T18:37:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/796#issuecomment-934667278","viewerDidAuthor":false}],"createdAt":"2021-10-05T12:56:10Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":4,"title":"1.4.0","description":"","dueOn":"2021-10-06T00:00:00Z"},"number":796,"reactionGroups":[],"state":"CLOSED","title":"Context propagation is not invoked when a workflow start and is configured using WorkflowClientOptions","updatedAt":"2021-10-06T17:12:41Z","url":"https://github.com/temporalio/sdk-java/issues/796"}
