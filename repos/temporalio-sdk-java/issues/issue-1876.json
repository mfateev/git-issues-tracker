{"assignees":[],"author":{"id":"MDQ6VXNlcjM4ODA3","is_bot":false,"login":"dano","name":"Dan O'Reilly"},"body":"## Expected Behavior\r\nIf I create a `WorkflowLocal` via `WorkflowLocal.withInitial() -> new MyClass())`, I get a unique instance of `MyClass` the first time I call `workflowLocal.get()` in a given Workflow.\r\n\r\n## Actual Behavior\r\nI get the same instance of `MyClass` returned in every Workflow.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nThis test demonstrates the issue:\r\n\r\n``` java\r\n    @Test\r\n    void test(TestWorkflowEnvironment env, WorkflowClient client, Worker worker) {\r\n        worker.registerWorkflowImplementationFactory(ChildWf.class, () -> () -> {\r\n            var r = ref.get();\r\n            System.out.println(r.get());\r\n        });\r\n        worker.registerWorkflowImplementationFactory(ParentWf.class, () -> () -> {\r\n            var r = ref.get();\r\n            r.set(\"hi\");\r\n            Workflow.newChildWorkflowStub(ChildWf.class).executeChild();\r\n        });\r\n        env.start();\r\n        client.newWorkflowStub(ParentWf.class, WorkflowOptions.newBuilder()\r\n                        .setTaskQueue(worker.getTaskQueue())\r\n                .validateBuildWithDefaults()).execute();\r\n    }\r\n\r\n    private static final WorkflowLocal<AtomicReference<String>> ref = WorkflowLocal.withInitial(() -> new AtomicReference<>(\"bye\"));\r\n\r\n    @WorkflowInterface\r\n    public interface ParentWf {\r\n        @WorkflowMethod\r\n        void execute();\r\n    }\r\n\r\n    @WorkflowInterface\r\n    public interface ChildWf {\r\n        @WorkflowMethod\r\n        void executeChild();\r\n    }\r\n```\r\nThis should print \"bye\" (which is the 1.19.1 behavior), but instead it prints \"hi\".\r\n\r\n## Specifications\r\n  - Version: 1.21.1\r\n","closedAt":"2023-10-02T23:52:55Z","comments":[{"id":"IC_kwDODN12PM5ntL99","author":{"login":"dano"},"authorAssociation":"CONTRIBUTOR","body":"I took a crack at implementing a fix for this here: https://github.com/temporalio/sdk-java/compare/master...dano:sdk-java:fix-wflocal-caching?expand=1\r\n\r\nIt doesn't break any existing tests, and fixes the issue I'm seeing. If it seems like the right approach, I can clean up the tests a bit, add some additional comments, and open a PR.","createdAt":"2023-09-28T19:37:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1876#issuecomment-1739898749","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5n6CM9","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"@dano Thanks for implementing a fix, thinking about it a bit more I think caching the result of `withInitial` even if implemented correctly is a breaking change to `WorkflowLocal`. Therefore I think we should just remove the caching logic all together.","createdAt":"2023-10-02T15:46:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1876#issuecomment-1743266621","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5n6Ooh","author":{"login":"dano"},"authorAssociation":"CONTRIBUTOR","body":"@Quinn-With-Two-Ns do you mean that this test should pass?\r\n``` java\r\nWorkflowLocal<AtomicInteger> wf = WorkflowLocal.withInitial(() -> new AtomicInteger(0));\r\nassertNotSame(wf.get(), wf.get());\r\n```\r\nMeaning that repeatedly calling `wf.get()` without ever calling `set` always results in the `withInitial` callback being re-executed?\r\n\r\nIt's true that this matches the previous behavior of `WorkflowLocal`, but I think that behavior was surprising and arguably a bug.  `ThreadLocal`, which this API seems to be emulating, only calls `withInitial` once for a given thread. Not caching also makes it tricky to use this API correctly. If you're storing a mutable value, you essentially always have use to the API like this to be safe, which is a bit tedious and error-prone:\r\n```\r\nvar myValue = wf.get();\r\n// use myValue here\r\nwf.set(myValue); // Ensure it gets cached.\r\n```\r\nOtherwise, you risk that the `get()` call you made returns a value from the `withInitial` callback that is going to just get thrown away. I actually can't think of a situation where the non-caching behavior is desirable.\r\n\r\nThat said, it is true that adding caching behavior is a backwards compatibility break. If we must avoid that, even if we agree caching is better behavior, could we add a new factory that implements caching? Something like `withInitialCached`, or just a new `withInitial` overload that takes a `useCaching` boolean?","createdAt":"2023-10-02T16:17:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1876#issuecomment-1743317537","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5n6Syl","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":">do you mean that this test should pass?\r\n\r\ncorrect\r\n\r\nI agree with your points, but backwards compatibility it one of the most important parts of the SDK and we prioritize it above almost everything else. Adding an overload for caching or a different function is a backwards compatible change and that would be OK.","createdAt":"2023-10-02T16:26:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1876#issuecomment-1743334565","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5n6VNC","author":{"login":"dano"},"authorAssociation":"CONTRIBUTOR","body":"Understood. I will update my branch to add a new API that uses the caching behavior and open a PR\r\n\r\nWould you consider deprecating the non-caching `withInitial` API, in favor of the new caching version? If so I'll add that to the branch as well.","createdAt":"2023-10-02T16:33:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1876#issuecomment-1743344450","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5n6e5B","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Yes I'd be open to deprecating the non-caching API. \r\n\r\nNote: we will probably never actually remove the API","createdAt":"2023-10-02T16:51:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1876#issuecomment-1743384129","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5n6wOl","author":{"login":"dano"},"authorAssociation":"CONTRIBUTOR","body":"Thanks, @Quinn-With-Two-Ns. I've opened https://github.com/temporalio/sdk-java/pull/1878.","createdAt":"2023-10-02T17:32:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1876#issuecomment-1743455141","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5oCgrh","author":{"login":"dano"},"authorAssociation":"CONTRIBUTOR","body":"Thanks for merging the fix, @Quinn-With-Two-Ns. Do you have a rough idea of when a release that includes this fix will be made?","createdAt":"2023-10-03T18:16:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1876#issuecomment-1745488609","viewerDidAuthor":false}],"createdAt":"2023-09-28T17:48:59Z","labels":[],"milestone":null,"number":1876,"reactionGroups":[],"state":"CLOSED","title":"WorkflowLocal shares initial value between all Workflows","updatedAt":"2023-10-03T18:16:41Z","url":"https://github.com/temporalio/sdk-java/issues/1876"}
