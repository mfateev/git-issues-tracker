{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjExOTQyMg==","is_bot":false,"login":"tsurdilo","name":"Tihomir Surdilovic"},"body":"When catching ActivityFailure with cause io.temporal.failure.CanceledFailure it seems ReplayAwareLogger thinks workflow is in replay mode, looks like issue with setting WorkflowUnsafe.isReplaying() in this case. \r\n\r\nFull repro (could run in within java samples) [here](https://gist.github.com/tsurdilo/4eb48c5f87fe8797b4a7a4399375ee85). \r\nRelevant lines where issue happens (only system outs get printed) [here](https://gist.github.com/tsurdilo/4eb48c5f87fe8797b4a7a4399375ee85#file-gistfile1-txt-L77-L82). ","closedAt":"2023-03-16T04:01:29Z","comments":[{"id":"IC_kwDODN12PM5Wj0vX","author":{"login":"dano"},"authorAssociation":"CONTRIBUTOR","body":"I want to add that this issue actually does more than just screw up `ReplayAwareLogger`. If you try to use a `mutableSideEffect` in a detached `CancellationScope` when the Workflow mistakenly thinks it is replaying, when it is actually just cancelled, the `mutableSideEffect` call will fail with this error:\r\n```\r\n023-03-02 12:10:23.856 [WARN ] [io.temporal.internal.worker.WorkflowWorker|Workflow Executor taskQueue=\"myQueue\", namespace=\"default\": 2] Failure while reporting workflow progress to the server. If seen continuously the workflow might be stuck. WorkflowId=799e5987-65a9-4c1d-bd4e-bc96301ae825, RunId=839fbc5c-9c5c-4a7d-be4d-085b296bc883, startedEventId=19\r\nio.grpc.StatusRuntimeException: INVALID_ARGUMENT: BadRecordMarkerAttributes: MarkerName is not set on command.\r\n\tat io.grpc.stub.ClientCalls.toStatusRuntimeException(ClientCalls.java:271) ~[grpc-stub-1.48.1.jar:1.48.1]\r\n\tat io.grpc.stub.ClientCalls.getUnchecked(ClientCalls.java:252) ~[grpc-stub-1.48.1.jar:1.48.1]\r\n```\r\n\r\nYou can reproduce it by taking @tsurdilo's original gist, and replacing the call inside the `CancellationScope` on line 71 with a `Workflow.mutableSideEffect` call. It looks like the `MutableSideEffectStateMachine` ends up sending a \"fake\" `RecordMarkerCommandAttrivutes` instance to the server because it thinks it's replaying.\r\n\r\nIt's possible that other behavior will be broken by this as well.\r\n","createdAt":"2023-03-02T17:16:36Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1558#issuecomment-1452231639","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5WkcEQ","author":{"login":"dano"},"authorAssociation":"CONTRIBUTOR","body":"It seems like something about the `ActivityTaskCanceled` event screws up the logic `WorkflowStateMachines` uses to determine if we're replaying. We end up making progress executing the Workflow while it still thinks it should be replaying the event history.","createdAt":"2023-03-02T18:54:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1558#issuecomment-1452392720","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5W2uC1","author":{"login":"dano"},"authorAssociation":"CONTRIBUTOR","body":"Ok, I've figured out the root cause for the bad behavior. It's because of this logic in `WorkflowStateMachines.scheduleActivityTask`:\r\n\r\n``` java\r\n              callback.apply(p, f);\r\n              if (f != null && f.hasCause() && f.getCause().hasCanceledFailureInfo()) {\r\n                eventLoop();\r\n              }\r\n```\r\nWhen that `if` statement evaluates to true (meaning the activity has thrown a `CanceledFailure`), and the event loop is allowed to run, it causes the Workflow to make progress while it is still in the replaying state, which causes all the bad behavior reported in this issue. With any non-cancellation failure, the event loop doesn't run until all events in the event history get processed (specifically the `WorkflowTaskScheduled` and `WorkflowTaskStarted` events that are waiting behind the `ActivityTaskFailed`/`ActivityTaskCanceled` event, which sets replaying back to `false` inside `WorkflowStateMachines.handleSingleEvent`).\r\n\r\nIt looks like this code has been there for several years, though, so I imagine it is there for a reason. I will experiment with code changes tomorrow to see if I can find one that fixes the issue I'm seeing, without breaking any tests, but probably I will need @Spikhalskiy to weigh in here.","createdAt":"2023-03-06T23:06:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1558#issuecomment-1457184949","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5W32qU","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"@dano Thanks for your thoughts. I see what you are saying, but I don't have immediate thoughts right now how it should be fixed. State machines are not trivial to reason about without some digging. If you can provide a unit test reproducing your specific problem, it will be helpful.","createdAt":"2023-03-07T03:57:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1558#issuecomment-1457482388","viewerDidAuthor":false}],"createdAt":"2022-12-05T22:12:20Z","labels":[],"milestone":{"number":21,"title":"1.19.0","description":"","dueOn":"2023-03-16T00:00:00Z"},"number":1558,"reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"state":"CLOSED","title":"Issue with ReplayAwareLogger and CanceledFailure","updatedAt":"2023-03-16T04:01:29Z","url":"https://github.com/temporalio/sdk-java/issues/1558"}
