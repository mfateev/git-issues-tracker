{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"User [hits](https://github.com/temporalio/sdk-java/pull/1267#issuecomment-1216933564) the check located [here](https://github.com/temporalio/sdk-java/blob/da51b4852a74899a713b53d1400338c74c47b828/temporal-sdk/src/main/java/io/temporal/internal/statemachines/WorkflowStateMachines.java#L182) during a direct query, which fails the query.\r\nJavaSDK probably should handle the query with a full replay when this happens instead of failing a workflow task.\r\n\r\nAdditional context:\r\n1. We should try to reproduce this situation when it's possible. This check was added as a guard that should never happen if Server never loses progress after responding OK to completion of a workflow task. One theory is that query may be issued and sent DURING workflow task processing by the worker, in that case, it will arrive with outdated eventIds.\r\n2. If users actually hit this line, we should cover this behavior with unit tests.  \r\n\r\n\r\nAnother manifestation of this problem:\r\nDue to the way how we currently define \"isReplaying\" state inside state machines, if a workflow task (even not a real one, but a direct query one) carries an outdated `previousStartedWorkflowTaskId` that doesn't match an actual state of the server history, during replay we will go through \"EXECUTE\" route instead of \"REPLAY\" path of state machines, while we are actually replaying and immediately applying events from the server history. It leads to internal state machine exceptions. ","closedAt":"2022-08-23T20:49:26Z","comments":[{"id":"IC_kwDODN12PM5I0Rvh","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Another manifestation of this problem:\r\nDue to the way how we currently define \"isReplaying\" state inside state machines, if a workflow task (even not a real one, but a direct query one) carries an outdated previousStartedWorkflowTaskId that doesn't match an actual state of the server history, during replay we will go through \"EXECUTE\" route instead of \"REPLAY\" path of state machines, while we are actually replaying and immediately applying events from the server history. It leads to [internal state machine exceptions](https://github.com/temporalio/sdk-java/files/9390368/java-sdk-public_build_1612_java-jdk18-unit-test-with-in-memory-test-service.log.zip).\r\n","createdAt":"2022-08-22T00:47:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1371#issuecomment-1221663713","viewerDidAuthor":false}],"createdAt":"2022-08-16T18:59:29Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":18,"title":"1.16.0","description":"","dueOn":"2022-08-24T00:00:00Z"},"number":1371,"reactionGroups":[],"state":"CLOSED","title":"Eviction of workflow due to too advanced state fails query","updatedAt":"2022-08-23T20:49:26Z","url":"https://github.com/temporalio/sdk-java/issues/1371"}
