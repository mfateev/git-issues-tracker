{"assignees":[],"author":{"id":"MDQ6VXNlcjc2OTc0ODQ=","is_bot":false,"login":"taonic","name":"Tao Guo"},"body":"## Expected Behavior\nHaving `Workflow.sideEffect` following a `Workflow.getVersion` should not cause a NDE when the getVersion is removed.\n\n## Actual Behavior\nRemoving `getVersion` leads to NDE when there is a succeeding `Workflow.sideEffect`.\n\n## Steps to Reproduce the Problem\n```java\npublic class GetVersionRemovalTest {\n  private static boolean hasReplayed;\n\n  @Rule\n  public SDKTestWorkflowRule testWorkflowRule =\n      SDKTestWorkflowRule.newBuilder()\n          .setWorkflowTypes(TestGetVersionRemovalWorkflowImpl.class)\n          .setActivityImplementations(new TestActivitiesImpl())\n          // Forcing a replay. Full history arrived from a normal queue causing a replay.\n          .setWorkerOptions(\n              WorkerOptions.newBuilder()\n                  .setStickyQueueScheduleToStartTimeout(Duration.ZERO)\n                  .build())\n          .build();\n\n  @Test\n  public void testGetVersionMultithreadingRemoval() {\n    TestWorkflow1 workflowStub =\n        testWorkflowRule.newWorkflowStubTimeoutOptions(TestWorkflow1.class);\n    String result = workflowStub.execute(testWorkflowRule.getTaskQueue());\n    assertTrue(hasReplayed);\n    assertEquals(\"activity1\", result);\n  }\n\n  public static class TestGetVersionRemovalWorkflowImpl implements TestWorkflow1 {\n    @Override\n    public String execute(String taskQueue) {\n      VariousTestActivities testActivities =\n          Workflow.newActivityStub(\n              VariousTestActivities.class,\n              SDKTestOptions.newActivityOptionsForTaskQueue(taskQueue));\n\n      // Test removing a version check in replaying code with an additional thread running.\n      if (!WorkflowUnsafe.isReplaying()) {\n        int version = Workflow.getVersion(\"changeId\", 1, 2);\n        assertEquals(version, 2);\n      } else {\n        hasReplayed = true;\n      }\n\n      // This sideEffect following a getVersion causes NDE after the getVersion is removed\n      Workflow.sideEffect(String.class, () -> System.getenv(\"USER\"));\n\n      String result =\n          \"activity\" + testActivities.activity1(1); // This is executed in non-replay mode.\n      return result;\n    }\n  }\n}\n```\n\nOutput:\n```\n...\nCaused by: java.lang.IllegalStateException: Expected SideEffect, received: marker_name: \"Version\"\ndetails {\n  key: \"changeId\"\n  value {\n    payloads {\n      metadata {\n        key: \"encoding\"\n        value: \"json/plain\"\n      }\n      data: \"\\\"changeId\\\"\"\n    }\n  }\n}\ndetails {\n  key: \"version\"\n  value {\n    payloads {\n      metadata {\n        key: \"encoding\"\n        value: \"json/plain\"\n      }\n      data: \"2\"\n    }\n  }\n}\nworkflow_task_completed_event_id: 3\n\n\tat io.temporal.internal.statemachines.SideEffectStateMachine.markerResultFromEvent(SideEffectStateMachine.java:155)\n\tat io.temporal.internal.statemachines.FixedTransitionAction.apply(FixedTransitionAction.java:46)\n\tat io.temporal.internal.statemachines.StateMachine.executeTransition(StateMachine.java:159)\n```\n\n## Specifications\n\n  - Version: tested in 1.27.0\n","closedAt":"2025-01-16T23:28:14Z","comments":[],"createdAt":"2025-01-15T07:58:02Z","labels":[],"milestone":null,"number":2367,"reactionGroups":[],"state":"CLOSED","title":"Removing a `Workflow.getVersion` with a succeeding `Workflow.sideEffect` causes NDE","updatedAt":"2025-01-16T23:28:14Z","url":"https://github.com/temporalio/sdk-java/issues/2367"}
