{"assignees":[],"author":{"id":"MDQ6VXNlcjUyMzA0","is_bot":false,"login":"bergundy","name":"Roey Berman"},"body":"## Expected Behavior\r\n\r\nW2 7 day timer should be unblocked immediately.\r\n\r\n## Actual Behavior\r\n\r\nTimer is not unblocked.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n(I have not run this myself and verified, this is pseudo code I got from a user on [slack](https://temporalio.slack.com/archives/C01DKSMU94L/p1670625163595479))\r\n\r\n```ts\r\nasync function W1() {\r\n    await A1();\r\n    ...\r\n}\r\n\r\nasync function A1() {\r\n  const ids = runDBQuery();\r\n\r\n  const { workflowClient } = getContext();\r\n\r\n  await Promise.all(\r\n    ids.map((id) =>\r\n      workflowClient.signalWithStart(W2, {\r\n        taskQueue: \"default\",\r\n        workflowId: `W2-${id}`,\r\n        args: [\r\n          {\r\n            ...\r\n          },\r\n        ],\r\n        signal: S1,\r\n        signalArgs: [{ ... }],\r\n      })\r\n    ),\r\n  );\r\n}\r\n\r\nasync function W2() {\r\n    await sleep(\"7 days\");\r\n    await A2();\r\n    ...\r\n}\r\n\r\nasync function A2() {\r\n    // produce side effect\r\n}\r\n\r\ndescribe(\"test T1\", () => {\r\n    it(\"alls A2\", async () => {\r\n        const testActivities = {\r\n          ...activities,\r\n          A2: jest.fn(),\r\n        };\r\n\r\n\r\n        const testEnv = await TestWorkflowEnvironment.createTimeSkipping();\r\n        const worker = await Worker.create({\r\n          connection: testEnv.nativeConnection,\r\n          workflowsPath: require.resolve(\"./allWorkflows\"),\r\n          interceptors: appendDefaultInterceptors(\r\n            {\r\n              activityInbound: [\r\n                (ctx) =>\r\n                  new CustomActivityInboundInterceptor(ctx, {\r\n                    workflowClient: testEnv.client.workflow,\r\n                  }),\r\n              ],\r\n            },\r\n            console\r\n          ),\r\n          activities: testActivities,\r\n          taskQueue: \"default\",\r\n        });\r\n\r\n        await worker.runUntil(() => \r\n          testEnv.client.workflow.execute(\r\n            W1,\r\n            {\r\n              workflowId: randomUUID(),\r\n              taskQueue: \"default\",\r\n              args: [\r\n                {\r\n                  ...\r\n                },\r\n              ],\r\n            }\r\n          )\r\n        )\r\n\r\n        const handle = testEnv.client.workflow.getHandle(`W2-id1`);\r\n        await handle.result();\r\n\r\n        expect(testActivities.A2).toHaveBeenCalled();\r\n    })\r\n})\r\n```","closedAt":"2022-12-10T03:37:23Z","comments":[{"id":"IC_kwDODN12PM5QKh3q","author":{"login":"maxgurewitz"},"authorAssociation":"NONE","body":"Thank you!","createdAt":"2022-12-10T00:23:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1565#issuecomment-1344937450","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5QKlBV","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Workflow Time Skipping is getting disabled for the period of activity execution. You don't want the Server timestamp to become Long.MAX_LONG while the worker executes the activity for a second or two. Instead, you want it to reflect the actual time of the activity execution.","createdAt":"2022-12-10T00:46:50Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1565#issuecomment-1344950357","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5QKlRf","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"The WorkflowClient that is used in the activity A2 may be reconfigured to use the time-skipping workflow client, the `testEnv.client` one to address this change. This doesn't require a Test Server change.","createdAt":"2022-12-10T00:50:09Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1565#issuecomment-1344951391","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5QKmG5","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"What does A1 wait for in this code sample? Does it wait for workflow start or completion? ","createdAt":"2022-12-10T00:59:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1565#issuecomment-1344954809","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5QKpp3","author":{"login":"maxgurewitz"},"authorAssociation":"NONE","body":"> Does it wait for workflow start or completion?\r\n\r\nA1 just waits until the `workflowClient.signalWithStart` calls finish, which as I understand it will just wait until W2 starts, not completes.","createdAt":"2022-12-10T01:38:27Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1565#issuecomment-1344969335","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5QKp0E","author":{"login":"maxgurewitz"},"authorAssociation":"NONE","body":"If this is not a bug, is there some recommended fix for the above pseudocode?","createdAt":"2022-12-10T01:41:09Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1565#issuecomment-1344969988","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5QKqeA","author":{"login":"maxgurewitz"},"authorAssociation":"NONE","body":"> The WorkflowClient that is used in the activity A2 may be reconfigured to use the time-skipping workflow client, the testEnv.client one to address this change. This doesn't require a Test Server change.\r\n\r\nIf I'm understanding you, I believe I'm doing that by injecting the time-skipping workflow client with an interceptor.","createdAt":"2022-12-10T01:49:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1565#issuecomment-1344972672","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5QKqeQ","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"@maxgurewitz Thanks for the clarification, it makes more sense if they wait only for a start. I will try to repro it and get back to you, I don't expect it to be a Test Server bug, but it may be a TS SDK bug. \r\nHow many workflows does A1 start in your test? One or several?","createdAt":"2022-12-10T01:49:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/1565#issuecomment-1344972688","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5QKqie","author":{"login":"maxgurewitz"},"authorAssociation":"NONE","body":"> How many workflows does A1 start in your test? One or several?\r\n\r\nIt can start several, but I can repro this issue where it only starts 1 (`ids` has 1 item).","createdAt":"2022-12-10T01:50:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1565#issuecomment-1344972958","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5QKuX1","author":{"login":"maxgurewitz"},"authorAssociation":"NONE","body":"I've added a repo for a simple working reproduction of this issue, with setup instructions. Thanks!\r\n\r\nhttps://github.com/ideamarketinc/temporal-repro/tree/activity-waiting","createdAt":"2022-12-10T02:44:59Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1565#issuecomment-1344988661","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5QK4bl","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Looks like the worker in this example is shut down before the second workflow gets a chance to complete.","createdAt":"2022-12-10T03:37:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1565#issuecomment-1345029861","viewerDidAuthor":false}],"createdAt":"2022-12-10T00:15:45Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQ4","name":"question","description":"Further information is requested","color":"BFD4F2"}],"milestone":null,"number":1565,"reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"state":"CLOSED","title":"Test server seems to not enable time skipping in this specific scenario","updatedAt":"2022-12-10T03:37:23Z","url":"https://github.com/temporalio/sdk-java/issues/1565"}
