{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjExOTQyMg==","is_bot":false,"login":"tsurdilo","name":"Tihomir Surdilovic"},"body":"To reproduce:\r\nActivityOptionsTest: https://github.com/temporalio/sdk-java/blob/master/temporal-sdk/src/test/java/io/temporal/activity/ActivityOptionsTest.java\r\n\r\nAdd \"testEnv.close()\" at the end of each test method. The test env should be recreated in the \"@Before\" method but instead\r\nthis throws:\r\n\r\n                java.util.concurrent.RejectedExecutionException: Task java.util.concurrent.FutureTask@590c73d3 rejected from java.util.concurrent.ThreadPoolExecutor@6b9ce1bf[Terminated, pool size = 0, active threads = 0, queued tasks = 0, completed tasks = 0]\r\n      io.temporal.internal.sync.WorkflowRejectedExecutionError: java.util.concurrent.RejectedExecutionException: Task java.util.concurrent.FutureTask@590c73d3 rejected from java.util.concurrent.ThreadPoolExecutor@6b9ce1bf[Terminated, pool size = 0, active threads = 0, queued tasks = 0, completed tasks = 0]\r\n\t      at io.temporal.internal.sync.WorkflowThreadImpl.start(WorkflowThreadImpl.java:266)\r\n\t      at io.temporal.internal.sync.DeterministicRunnerImpl.runUntilAllBlocked(DeterministicRunnerImpl.java:160)\r\n\t      at io.temporal.internal.sync.DeterministicRunnerWrapper.invoke(DeterministicRunnerWrapper.java:53)\r\n\t      at com.sun.proxy.$Proxy13.activity1(Unknown Source)\r\n\t      at io.temporal.activity.ActivityOptionsTest.testActivityOptionsDefaultInstance(ActivityOptionsTest.java:95)\r\n\t      at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\t      at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\t      at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\t      at java.lang.reflect.Method.invoke(Method.java:498)\r\n\t      at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:59)\r\n\t      at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\t      at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:56)\r\n\t      at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\r\n\t      at org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:26)\r\n\t      at org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)\r\n\t      at org.junit.runners.BlockJUnit4ClassRunner$1.evaluate(BlockJUnit4ClassRunner.java:100)\r\n\t      at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:366)\r\n\t      at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:103)\r\n\t      at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:63)\r\n\t      at org.junit.runners.ParentRunner$4.run(ParentRunner.java:331)\r\n\t      at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:79)\r\n\t      at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:329)\r\n\t      at org.junit.runners.ParentRunner.access$100(ParentRunner.java:66)\r\n\t      at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:293)\r\n\t      at org.junit.runners.ParentRunner$3.evaluate(ParentRunner.java:306)\r\n\t      at org.junit.runners.ParentRunner.run(ParentRunner.java:413)\r\n\t      at org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.runTestClass(JUnitTestClassExecutor.java:110)\r\n\t      at org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.execute(JUnitTestClassExecutor.java:58)\r\n\t      at org.gradle.api.internal.tasks.testing.junit.JUnitTestClassExecutor.execute(JUnitTestClassExecutor.java:38)\r\n\t      at org.gradle.api.internal.tasks.testing.junit.AbstractJUnitTestClassProcessor.processTestClass(AbstractJUnitTestClassProcessor.java:62)\r\n\t      at org.gradle.api.internal.tasks.testing.SuiteTestClassProcessor.processTestClass(SuiteTestClassProcessor.java:51)\r\n\t      at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\t      at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\t      at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\t      at java.lang.reflect.Method.invoke(Method.java:498)\r\n\t      at org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:36)\r\n\t      at org.gradle.internal.dispatch.ReflectionDispatch.dispatch(ReflectionDispatch.java:24)\r\n\t      at org.gradle.internal.dispatch.ContextClassLoaderDispatch.dispatch(ContextClassLoaderDispatch.java:33)\r\n\t      at org.gradle.internal.dispatch.ProxyDispatchAdapter$DispatchingInvocationHandler.invoke(ProxyDispatchAdapter.java:94)\r\n\t      at com.sun.proxy.$Proxy2.processTestClass(Unknown Source)\r\n\t      at org.gradle.api.internal.tasks.testing.worker.TestWorker$2.run(TestWorker.java:176)\r\n\t      at org.gradle.api.internal.tasks.testing.worker.TestWorker.executeAndMaintainThreadName(TestWorker.java:129)\r\n\t      at org.gradle.api.internal.tasks.testing.worker.TestWorker.execute(TestWorker.java:100)\r\n\t      at org.gradle.api.internal.tasks.testing.worker.TestWorker.execute(TestWorker.java:60)\r\n\t      at org.gradle.process.internal.worker.child.ActionExecutionWorker.execute(ActionExecutionWorker.java:56)\r\n\t      at org.gradle.process.internal.worker.child.SystemApplicationClassLoaderWorker.call(SystemApplicationClassLoaderWorker.java:133)\r\n\t      at org.gradle.process.internal.worker.child.SystemApplicationClassLoaderWorker.call(SystemApplicationClassLoaderWorker.java:71)\r\n\t      at worker.org.gradle.process.internal.worker.GradleWorkerMain.run(GradleWorkerMain.java:69)\r\n\t      at worker.org.gradle.process.internal.worker.GradleWorkerMain.main(GradleWorkerMain.java:74)\r\n      Caused by: java.util.concurrent.RejectedExecutionException: Task java.util.concurrent.FutureTask@590c73d3 rejected from java.util.concurrent.ThreadPoolExecutor@6b9ce1bf[Terminated, pool size = 0, active threads = 0, queued tasks = 0, completed tasks = 0]\r\n\t      at java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2063)\r\n\t      at java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:830)\r\n\t      at java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1379)\r\n\t      at java.util.concurrent.AbstractExecutorService.submit(AbstractExecutorService.java:112)\r\n\t      at io.temporal.internal.sync.WorkflowThreadImpl.start(WorkflowThreadImpl.java:250)\r\n\t      ... 48 more\r\n","closedAt":"2022-08-04T20:46:42Z","comments":[{"id":"IC_kwDODN12PM5Bejhb","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Likely related: https://github.com/temporalio/sdk-java/issues/928","createdAt":"2022-04-13T22:03:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1133#issuecomment-1098528859","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5HTW57","author":{"login":"Bennett-Lynch"},"authorAssociation":"NONE","body":"Any update?","createdAt":"2022-07-27T04:36:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1133#issuecomment-1196256891","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5HTXCl","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"The issue will be closed if the problem is resolved.","createdAt":"2022-07-27T04:37:49Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"CONFUSED","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/1133#issuecomment-1196257445","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5HWiBG","author":{"login":"Bennett-Lynch"},"authorAssociation":"NONE","body":"The root cause appears to be a static `ExecutorService activityWorkerExecutor` that is used for all `TestActivityEnvironmentInternal` instances, where a new `TestActivityEnvironmentInternal` instance is created for each test method, and the static executor is closed as part of each test method as well:\r\n\r\n## beforeEach\r\n\r\nhttps://github.com/temporalio/sdk-java/blob/ae5fb81293a62f2d9c83f53d57fb1ab683713da1/temporal-testing/src/main/java/io/temporal/testing/TestActivityExtension.java#L145-L148\r\n\r\nhttps://github.com/temporalio/sdk-java/blob/ae5fb81293a62f2d9c83f53d57fb1ab683713da1/temporal-testing/src/main/java/io/temporal/testing/TestActivityEnvironment.java#L66-L68\r\n\r\nhttps://github.com/temporalio/sdk-java/blob/ae5fb81293a62f2d9c83f53d57fb1ab683713da1/temporal-testing/src/main/java/io/temporal/testing/TestActivityEnvironmentInternal.java#L79-L80\r\n\r\n## during\r\n\r\nhttps://github.com/temporalio/sdk-java/blob/ae5fb81293a62f2d9c83f53d57fb1ab683713da1/temporal-testing/src/main/java/io/temporal/testing/TestActivityEnvironmentInternal.java#L322-L325\r\n\r\n## afterEach\r\n\r\nhttps://github.com/temporalio/sdk-java/blob/ae5fb81293a62f2d9c83f53d57fb1ab683713da1/temporal-testing/src/main/java/io/temporal/testing/TestActivityExtension.java#L154-L158\r\n\r\nhttps://github.com/temporalio/sdk-java/blob/ae5fb81293a62f2d9c83f53d57fb1ab683713da1/temporal-testing/src/main/java/io/temporal/testing/TestActivityEnvironmentInternal.java#L239-L242\r\n\r\nThe same appears to be true for `heartbeatExecutor` and `deterministicRunnerExecutor` as well.\r\n\r\n## Possible fixes:\r\n1. Make these fields not static (creating a new thread pool per test may be sub-optimal for performance but is probably acceptable for most testing use cases)\r\n2. Do not close these static fields as part of `AfterAllCallback`/`TestActivityEnvironment#close` and instead use something like `TestExecutionListener#testPlanExecutionFinished` or a shutdown hook","createdAt":"2022-07-27T17:38:00Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1133#issuecomment-1197088838","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5HWmcP","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Thank you for giving the detailed root cause analysis, much appreciated! Confirm that your findings look right.\r\n\r\n> Make these fields not static (creating a new thread pool per test may be sub-optimal for performance but is probably acceptable for most testing use cases)\r\n\r\nIs the cleanest approach. #close of an instance shouldn't be closing static member as the instance creation or initialization didn't cause their creation in the first place (Class loading did). Let's make everything that is needed by TestActivityEnvironmentInternal and that needs a lifecycle management non-static: `heartbeatExecutor`, `activityWorkerExecutor`, `deterministicRunnerExecutor`.\r\n\r\nWill you be interested in making a PR?\r\n","createdAt":"2022-07-27T17:56:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1133#issuecomment-1197106959","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5H3kqN","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Closed by #1329","createdAt":"2022-08-04T20:46:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1133#issuecomment-1205750413","viewerDidAuthor":false}],"createdAt":"2022-04-11T14:19:12Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":17,"title":"1.15.0","description":"","dueOn":"2022-07-19T00:00:00Z"},"number":1133,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"TestActivityEnvironment: calling \"close\" in test method fails tests","updatedAt":"2022-08-04T20:46:42Z","url":"https://github.com/temporalio/sdk-java/issues/1133"}
