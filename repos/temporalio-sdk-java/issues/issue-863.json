{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjU4MTc4NTk=","is_bot":false,"login":"smax48","name":"Maxim Chuvilyaev"},"body":"## Expected Behavior\r\nA single instance of WorkflowServiceStubs is created once per application and used for communication with Temporal frontend API.\r\n\r\n## Actual Behavior\r\nAfter long period of inactivity (~40min) at some point of time we see an internal exception when trying to start a new workflow: `io.grpc.StatusRuntimeException: INTERNAL: Panic! This is a bug!` and channel becomes unusable after that (i.e. all attempts to use it result in the same error.)\r\n\r\nI cannot prove, but it might be related to some race condition between idleTimer in the netty channel (which has 30 min default timeout and is not configured by Temporal SDK) and Temporal own mechanism to reset gRPC connections via setGrpcReconnectFrequency() (that also calls to enterIdle() on the channel). I am not sure why the existing idleTimer is not used for this purpose in the first place, but maybe there are some specific considerations.\r\n\r\nFull stack trace:\r\n```\r\nio.temporal.client.WorkflowServiceException: workflowId='XXX123', runId='', workflowType='SomeWorkflowType'}\\\r\nat io.temporal.internal.sync.WorkflowStubImpl.wrapStartException(WorkflowStubImpl.java:184)\\\r\nat io.temporal.internal.sync.WorkflowStubImpl.startWithOptions(WorkflowStubImpl.java:120)\\\r\nat io.temporal.internal.sync.WorkflowStubImpl.start(WorkflowStubImpl.java:138)\\\r\nat io.temporal.internal.sync.WorkflowInvocationHandler.startWorkflow(WorkflowInvocationHandler.java:192)\\\r\nat io.temporal.internal.sync.WorkflowInvocationHandler.access$300(WorkflowInvocationHandler.java:48)\\\r\nat io.temporal.internal.sync.WorkflowInvocationHandler$ExecuteWorkflowInvocationHandler.invoke(WorkflowInvocationHandler.java:339)\\\r\nat io.temporal.internal.sync.WorkflowInvocationHandler.invoke(WorkflowInvocationHandler.java:178)\\\r\n<app-specific call stack omitted>\r\n............\r\nat java.base/java.lang.Thread.run(Unknown Source)\\\r\nCaused by: io.grpc.StatusRuntimeException: INTERNAL: Panic! This is a bug!\\\r\nat io.grpc.stub.ClientCalls.toStatusRuntimeException(ClientCalls.java:262)\\\r\nat io.grpc.stub.ClientCalls.getUnchecked(ClientCalls.java:243)\\\r\nat io.grpc.stub.ClientCalls.blockingUnaryCall(ClientCalls.java:156)\\\r\nat io.temporal.api.workflowservice.v1.WorkflowServiceGrpc$WorkflowServiceBlockingStub.startWorkflowExecution(WorkflowServiceGrpc.java:2615)\\\r\nat io.temporal.internal.external.GenericWorkflowClientExternalImpl.lambda$start$0(GenericWorkflowClientExternalImpl.java:88)\\\r\nat io.temporal.internal.retryer.GrpcSyncRetryer.retry(GrpcSyncRetryer.java:61)\\\r\nat io.temporal.internal.retryer.GrpcRetryer.retryWithResult(GrpcRetryer.java:51)\\\r\nat io.temporal.internal.external.GenericWorkflowClientExternalImpl.start(GenericWorkflowClientExternalImpl.java:81)\\\r\nat io.temporal.internal.client.RootWorkflowClientInvoker.start(RootWorkflowClientInvoker.java:55)\\\r\nat io.temporal.common.interceptors.WorkflowClientCallsInterceptorBase.start(WorkflowClientCallsInterceptorBase.java:35)\\\r\nat io.temporal.opentracing.internal.OpenTracingWorkflowClientCallsInterceptor.start(OpenTracingWorkflowClientCallsInterceptor.java:50)\\\r\nat io.temporal.internal.sync.WorkflowStubImpl.startWithOptions(WorkflowStubImpl.java:113)\\\r\n... 25 common frames omitted\\\r\nCaused by: java.lang.IllegalStateException: nameResolver is not started\\\r\nat com.google.common.base.Preconditions.checkState(Preconditions.java:502)\\\r\nat io.grpc.internal.ManagedChannelImpl.shutdownNameResolverAndLoadBalancer(ManagedChannelImpl.java:360)\\\r\nat io.grpc.internal.ManagedChannelImpl.enterIdleMode(ManagedChannelImpl.java:422)\\\r\nat io.grpc.internal.ManagedChannelImpl.access$900(ManagedChannelImpl.java:118)\\\r\nat io.grpc.internal.ManagedChannelImpl$IdleModeTimer.run(ManagedChannelImpl.java:352)\\\r\nat io.grpc.internal.Rescheduler$ChannelFutureRunnable.run(Rescheduler.java:103)\\\r\nat io.grpc.SynchronizationContext.drain(SynchronizationContext.java:95)\\\r\nat io.grpc.SynchronizationContext.execute(SynchronizationContext.java:127)\\\r\nat io.grpc.internal.Rescheduler$FutureRunnable.run(Rescheduler.java:80)\\\r\nat io.grpc.netty.shaded.io.netty.util.concurrent.PromiseTask.runTask(PromiseTask.java:98)\\\r\nat io.grpc.netty.shaded.io.netty.util.concurrent.ScheduledFutureTask.run(ScheduledFutureTask.java:170)\\\r\n.............\r\n```\r\n\r\n\r\n## Specifications\r\n\r\n  - Version: Java SDK 1.4.0\r\n","closedAt":"2021-11-23T02:03:46Z","comments":[{"id":"IC_kwDODN12PM46CpoG","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"I was able to reproduce the bug within grpc-java source code without any Temporal code and submitted https://github.com/grpc/grpc-java/issues/8714","createdAt":"2021-11-19T05:47:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/863#issuecomment-973773318","viewerDidAuthor":false},{"id":"IC_kwDODN12PM46Lhv_","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"A temporary workaround is implemented waiting for the related gRPC issue to be fixed.\r\nThis workaround will stay around for a while to allow the users to upgrade to the gRPC versions including the fix.\r\nThis whole manual calling of `enterIdle` to achieve load balancing should potentially go away as a part of #888","createdAt":"2021-11-23T02:03:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/863#issuecomment-976100351","viewerDidAuthor":false}],"createdAt":"2021-11-09T01:59:18Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":7,"title":"1.6.0","description":"","dueOn":"2021-12-07T00:00:00Z"},"number":863,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"Internal error in gRPC channel of WorkflowServiceStubs","updatedAt":"2021-11-23T02:03:57Z","url":"https://github.com/temporalio/sdk-java/issues/863"}
