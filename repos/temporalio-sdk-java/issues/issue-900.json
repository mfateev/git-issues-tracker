{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"## Actual Behavior\r\n\r\nA worker already logs when Workflow Task Processing fails with an unexpected exception.\r\nBut if reporting of the workflow task result to the server fails, the worker log is silent.\r\nAt the same time, both situations reach `UncaughtExceptionHandler` in the same manner.\r\n\r\n## Expected Behavior\r\n\r\nIf a worker logs a problem during workflow task processing, the worker should log a problem during reporting the workflow task processing result to the server. Especially because it potentially can be related to misformed commands.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nCreate an invalid Command (for example, schedule an activity with invalid retry parameters).\r\n`WorkflowWorker.TaskHandlerImpl#handle` gets an `INVALID_ARGUMENT` exception from the server inside `sendReply`.\r\nWorker log is clean and doesn't show the issue anyhow.\r\n\r\n## Notes\r\n\r\nThere is also a related problem that because `WorkflowWorker.TaskHandlerImpl#handle/sendReply` happens outside of WorkflowTaskHandler, exception there doesn't lead to a workflow thread destroy and cache invalidation, while it should. This points out that a larger refactoring here may be needed to keep things clean and easy to maintain.","closedAt":"2021-11-29T22:17:45Z","comments":[{"id":"IC_kwDODN12PM46UQZS","author":{"login":"akdoan1"},"authorAssociation":"NONE","body":"I'm assuming that the worker's reporting of the task processing result a blocking/synchronous call to the server. I don't think there are any metrics around interaction between the worker and the server based on the list in [workflow metrics](https://github.com/temporalio/sdk-java/blob/3deccf2c50b1bdb9f41cd2b385ee4dce402acf82/temporal-sdk/src/main/java/io/temporal/internal/metrics/MetricsType.java#L48). \r\n\r\nCan we add metrics to indicate success/failure and latency of this reporting call? \r\n\r\nEdit: I guess that's already covered with `WORKFLOW_TASK_EXECUTION_FAILURE_COUNTER` actually? ","createdAt":"2021-11-24T22:48:04Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/900#issuecomment-978388562","viewerDidAuthor":false},{"id":"IC_kwDODN12PM46UT6Q","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"@akdoan1 There is `failed_workflow_tasks` metric on the Temporal server to monitor the volume of failed workflow tasks. There is also `service_errors_invalid_argument` for example.\r\n\r\nI don't think we are going to implement SDK metrics for pure server return codes, we already have them on server side. Our SDK metrics are formulated around concepts that make sense from \"business logic\" level. Workflows, Workflow tasks, Activities and their executions. \r\n\r\nIf you really want that, we expose WorkflowServiceStubsOptions#grpcClientInterceptors.","createdAt":"2021-11-24T22:56:52Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/900#issuecomment-978402960","viewerDidAuthor":false}],"createdAt":"2021-11-24T21:47:16Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":7,"title":"1.6.0","description":"","dueOn":"2021-12-07T00:00:00Z"},"number":900,"reactionGroups":[],"state":"CLOSED","title":"Worker doesn't log failure during sending workflow task completion request","updatedAt":"2021-12-06T06:02:13Z","url":"https://github.com/temporalio/sdk-java/issues/900"}
