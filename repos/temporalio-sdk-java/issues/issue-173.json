{"assignees":[],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"## Test to reproduce\r\n\r\n```\r\npublic class LocalActivityLongTest {\r\n  ....\r\n  @WorkflowInterface\r\n  public interface TestWorkflow {\r\n    @WorkflowMethod\r\n    String workflow(String input);\r\n  }\r\n\r\n  public static class ActivityWorkflow implements TestWorkflow {\r\n    private final TestActivity activity = Workflow.newLocalActivityStub(TestActivity.class, LocalActivityOptions.newBuilder().build());\r\n    @Override\r\n    public String workflow(String input) {return activity.activity(input + \"3\");}\r\n  }\r\n\r\n  @ActivityInterface\r\n  public interface TestActivity {\r\n    String activity(String input);\r\n  }\r\n\r\n  private static class ActivityImpl implements TestActivity {\r\n    @Override\r\n    public String activity(String input) {return \"1\";}\r\n  }\r\n\r\n  @Test\r\n  public void trivialTest() {\r\n    Worker worker = testEnvironment.newWorker(TASK_QUEUE);\r\n    worker.registerWorkflowImplementationTypes(ActivityWorkflow.class);\r\n    worker.registerActivitiesImplementations(new ActivityImpl());\r\n\r\n    testEnvironment.start();\r\n    WorkflowClient client = testEnvironment.getWorkflowClient();\r\n    WorkflowOptions options =\r\n        WorkflowOptions.newBuilder()\r\n            // uncomment this to fix the test\r\n            // .setWorkflowExecutionTimeout(Duration.ofHours(1))\r\n            .setTaskQueue(TASK_QUEUE)\r\n            .build();\r\n\r\n    for (int reqCount = 1; reqCount < 1000; reqCount++) {\r\n      log.info(\"Request {}\", reqCount);\r\n      TestWorkflow workflow = client.newWorkflowStub(TestWorkflow.class, options);\r\n      String result = workflow.workflow(UUID.randomUUID().toString());\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n## Expected Behavior\r\n\r\nEither to:\r\n1. fail with a meaningful message on the configuration stage \r\n2. or fail with a meaningful message on the first request\r\n3. or successfully execute all 1000 requests.\r\n\r\n## Actual Behavior\r\n\r\nExecutes the first ~30 requests successfully.\r\nHangs and fails after that with:\r\n```\r\n23:49:49.698 [Workflow Executor taskQueue=\"test-workflow\", namespace=\"default\": 1] ERROR i.t.internal.worker.PollerOptions - uncaught exception\r\njava.lang.RuntimeException: Failure processing workflow task. WorkflowId=304a033c-e0e6-49ec-9c2d-024c01d533a7, RunId=c63116f5-330a-4e35-9f04-6cdd344acea8\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.wrapFailure(WorkflowWorker.java:324)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.wrapFailure(WorkflowWorker.java:273)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:79)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n\tat java.lang.Thread.run(Thread.java:748)\r\nCaused by: java.lang.ArithmeticException: Duration of this magnitude not supported\r\n\tat com.uber.m3.util.Duration.checkMultiplicationLongOverflow(Duration.java:340)\r\n\tat com.uber.m3.util.Duration.ofMillis(Duration.java:109)\r\n\tat io.temporal.internal.common.ProtobufTimeUtils.ToM3Duration(ProtobufTimeUtils.java:49)\r\n\tat io.temporal.internal.replay.ReplayWorkflowExecutor.completeWorkflow(ReplayWorkflowExecutor.java:329)\r\n\tat io.temporal.internal.replay.ReplayWorkflowExecutor.mayBeCompleteWorkflow(ReplayWorkflowExecutor.java:302)\r\n\tat io.temporal.internal.replay.ReplayWorkflowExecutor.handleWorkflowTaskImpl(ReplayWorkflowExecutor.java:468)\r\n\tat io.temporal.internal.replay.ReplayWorkflowExecutor.handleWorkflowTask(ReplayWorkflowExecutor.java:403)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithEmbeddedQuery(ReplayWorkflowTaskHandler.java:168)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowTaskHandler.java:145)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:104)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:301)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:273)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:73)\r\n```\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nPlease find the full unit test here: https://github.com/Spikhalskiy/java-sdk/commit/821f735afa696d9abc350cc9fb1b12eef1e16ae7. Which hangs after about 30-35 requests with the exception in logs.\r\nAlso, note that uncommenting https://github.com/Spikhalskiy/java-sdk/commit/821f735afa696d9abc350cc9fb1b12eef1e16ae7#diff-1661ff603d3c1aaff5d01537e8f938b7R79 fixes the unit test.\r\n\r\n\r\n## Specifications\r\n\r\n  - Version: at least 0.28 and current master [https://github.com/temporalio/java-sdk/commit/35abfd425c13e86f16b81e26c85c07b17ee3448f] is affected\r\n","closedAt":"2023-04-18T17:48:04Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDY3ODQ2NDQ2Mw==","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"The root cause is the unit test time skipping logic together with a large workflow timeout. The time skipping automatically moves time to the next task in a timer queue. The problem is that it does it for the workflow timeout after workflow completion. When running 1k workflows it jumps 10 years ahead after every execution. And apparently M3 metrics are not ready to deal with 10k year durations.\r\n\r\nI'm looking into the fix. Probably we should ignore time skipping for tasks that belong to completed workflows.","createdAt":"2020-08-21T19:53:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/173#issuecomment-678464463","viewerDidAuthor":true},{"id":"IC_kwDODN12PM49y2JA","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"There is a report that the similar exception appears in java-sdk 1.8.0 using test-server.\r\n\r\n```\r\njava.lang.ArithmeticException: Duration of this magnitude not supported\r\n\tat com.uber.m3.util.Duration.checkMultiplicationLongOverflow(Duration.java:340)\r\n\tat com.uber.m3.util.Duration.ofMillis(Duration.java:109)\r\n\tat io.temporal.internal.common.ProtobufTimeUtils.toM3Duration(ProtobufTimeUtils.java:49)\r\n\tat io.temporal.internal.replay.ReplayWorkflowExecutor.completeWorkflow(ReplayWorkflowExecutor.java:109)\r\n\tat io.temporal.internal.replay.ReplayWorkflowExecutor.eventLoop(ReplayWorkflowExecutor.java:84)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler$StatesMachinesCallbackImpl.eventLoop(ReplayWorkflowRunTaskHandler.java:321)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.eventLoop(WorkflowStateMachines.java:463)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.lambda$scheduleLocalActivityTask$8d414bd$1(WorkflowStateMachines.java:790)\r\n\tat io.temporal.internal.statemachines.LocalActivityStateMachine.notifyResultFromResponse(LocalActivityStateMachine.java:326)\r\n\tat io.temporal.internal.statemachines.FixedTransitionAction.apply(FixedTransitionAction.java:45)\r\n\tat io.temporal.internal.statemachines.StateMachine.executeTransition(StateMachine.java:147)\r\n\t... 17 common frames omitted\r\nWrapped by: java.lang.RuntimeException: LocalActivity: failure executing MARKER_COMMAND_CREATED->RECORD_MARKER, transition history is [CREATED->CHECK_EXECUTION_STATE, EXECUTING->SCHEDULE, REQUEST_PREPARED->MARK_AS_SENT, REQUEST_SENT->HANDLE_RESULT]\r\n\tat io.temporal.internal.statemachines.StateMachine.executeTransition(StateMachine.java:151)\r\n\tat io.temporal.internal.statemachines.StateMachine.handleCommand(StateMachine.java:111)\r\n\tat io.temporal.internal.statemachines.EntityStateMachineBase.handleCommand(EntityStateMachineBase.java:55)\r\n\tat io.temporal.internal.statemachines.CancellableCommand.handleCommand(CancellableCommand.java:63)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.prepareImpl(WorkflowStateMachines.java:413)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.prepareCommands(WorkflowStateMachines.java:396)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleLocalActivityCompletion(WorkflowStateMachines.java:768)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.waitAndProcessLocalActivityCompletion(ReplayWorkflowRunTaskHandler.java:307)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.processLocalActivityRequests(ReplayWorkflowRunTaskHandler.java:282)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:146)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithQuery(ReplayWorkflowTaskHandler.java:122)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:97)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:241)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:199)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:93)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n\tat java.base/java.lang.Thread.run(Thread.java:829)\r\n```","createdAt":"2022-02-11T23:12:46Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/173#issuecomment-1036739136","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5aN0g2","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"No known reproduction of this issue for more than a year. Reopen if there is a new report.","createdAt":"2023-04-18T17:48:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/173#issuecomment-1513572406","viewerDidAuthor":false}],"createdAt":"2020-08-08T03:55:58Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":173,"reactionGroups":[],"state":"CLOSED","title":"ArithmeticException in ReplayWorkflowExecutor after some amount of requests","updatedAt":"2023-04-18T17:48:05Z","url":"https://github.com/temporalio/sdk-java/issues/173"}
