{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjE0NjM2MjI=","is_bot":false,"login":"mfateev","name":"Maxim Fateev"},"body":"## Expected Behavior\r\nThe query works for terminated workflows.\r\n\r\n## Actual Behavior\r\n```\r\nException in thread \"main\" io.temporal.client.WorkflowQueryException: workflowId='7fc3ceac-eeb3-4468-983d-28716b21e858', runId='ea297429-0663-4c07-96db-e89cad466a09', workflowType='GreetingWorkflow'}\r\n\tat io.temporal.internal.sync.WorkflowStubImpl.query(WorkflowStubImpl.java:475)\r\n\tat io.temporal.internal.sync.WorkflowInvocationHandler$SyncWorkflowInvocationHandler.queryWorkflow(WorkflowInvocationHandler.java:309)\r\n\tat io.temporal.internal.sync.WorkflowInvocationHandler$SyncWorkflowInvocationHandler.invoke(WorkflowInvocationHandler.java:272)\r\n\tat io.temporal.internal.sync.WorkflowInvocationHandler.invoke(WorkflowInvocationHandler.java:178)\r\n\tat com.sun.proxy.$Proxy4.queryGreeting(Unknown Source)\r\n\tat io.temporal.samples.hello.HelloQuery.main(HelloQuery.java:95)\r\nCaused by: io.grpc.StatusRuntimeException: INVALID_ARGUMENT: io.temporal.internal.replay.InternalWorkflowTaskException: Failure handling event 6 of 'EVENT_TYPE_WORKFLOW_EXECUTION_TERMINATED' type. IsReplaying=false, PreviousStartedEventId=3, workflowTaskStartedEventId=0, Currently Processing StartedEventId=3\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:193)\r\nCaused by: io.grpc.StatusRuntimeException: INVALID_ARGUMENT: io.temporal.internal.replay.InternalWorkflowTaskException: Failure handling event 6 of 'EVENT_TYPE_WORKFLOW_EXECUTION_TERMINATED' type. IsReplaying=false, PreviousStartedEventId=3, workflowTaskStartedEventId=0, Currently Processing StartedEventId=3\r\n\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleEvent(ReplayWorkflowRunTaskHandler.java:140)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:180)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleQueryWorkflowTask(ReplayWorkflowRunTaskHandler.java:254)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleQueryOnlyWorkflowTask(ReplayWorkflowTaskHandler.java:257)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:112)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:314)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:280)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:73)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n\tat java.lang.Thread.run(Thread.java:748)\r\nCaused by: java.lang.IllegalArgumentException: Unexpected event:event_id: 6\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\nTerminate a workflow and run a query against it.\r\n\r\n","closedAt":"2022-04-23T04:38:28Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg1NjU2NzgyNw==","author":{"login":"bfugas"},"authorAssociation":"CONTRIBUTOR","body":"I encountered the issue, reproduced it and posted a fix proposal.\r\nI'm not sure if all the cases have been covered here. But I didn't want to make a big change to ignore all unknown events (go-sdk does it this way).","createdAt":"2021-06-08T08:25:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/391#issuecomment-856567827","viewerDidAuthor":false},{"id":"IC_kwDODN12PM42kSgG","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"This flake report actually shows that the issue wasn't fixed or was fixed partially: https://github.com/temporalio/sdk-java/issues/630","createdAt":"2021-09-08T18:45:45Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/391#issuecomment-915482630","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5CAPef","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"This issue is fixed. The flake https://github.com/temporalio/sdk-java/issues/630 has a different nature. The result depends on if workflow run times out before WFT heartbeat (local activity is used in that test) is received or after. ","createdAt":"2022-04-23T04:38:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/391#issuecomment-1107359647","viewerDidAuthor":false}],"createdAt":"2021-03-18T17:30:29Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":391,"reactionGroups":[],"state":"CLOSED","title":"Query failure on terminated workflow","updatedAt":"2022-04-23T04:38:28Z","url":"https://github.com/temporalio/sdk-java/issues/391"}
