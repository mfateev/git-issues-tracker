{"assignees":[],"author":{"id":"U_kgDOB-xAkA","is_bot":false,"login":"sfc-gh-pjagielski","name":"Piotr Jagielski"},"body":"## Expected Behavior\r\n`Workflow.upsertTypedSearchAttributes` calls are successful in tests\r\n\r\n## Actual Behavior\r\n```\r\n    Caused by: java.util.ConcurrentModificationException: null\r\n    \tat java.base/java.util.HashMap.compute(HashMap.java:1317)\r\n    \tat io.temporal.internal.testservice.TestVisibilityStoreImpl.upsertSearchAttributesForExecution(TestVisibilityStoreImpl.java:97)\r\n    \tat io.temporal.internal.testservice.TestWorkflowMutableStateImpl.processUpsertWorkflowSearchAttributes(TestWorkflowMutableStateImpl.java:1542)\r\n    \tat io.temporal.internal.testservice.TestWorkflowMutableStateImpl.processCommand(TestWorkflowMutableStateImpl.java:686)\r\n    \tat io.temporal.internal.testservice.TestWorkflowMutableStateImpl.lambda$completeWorkflowTask$4(TestWorkflowMutableStateImpl.java:488)\r\n    \tat io.temporal.internal.testservice.TestWorkflowMutableStateImpl.update(TestWorkflowMutableStateImpl.java:317)\r\n    \t... 12 common frames omitted\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nSee https://github.com/sfc-gh-pjagielski/temporal-playground/blob/main/src/main/kotlin/com/snowflake/HelloWorkflow.kt#L37\r\nFailing build: https://github.com/sfc-gh-pjagielski/temporal-playground/actions/runs/5412424059/jobs/9836504936#step:5:837\r\n\r\n## Specifications\r\n\r\n  - Version: 1.20\r\n","closedAt":"2023-10-23T14:24:54Z","comments":[{"id":"IC_kwDODN12PM5gJ-pG","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks for the report. Note, the time-skipping test server (and therefore TestWorkflowExtension using default built-in test server) is not built to run multiple top-level workflows concurrently. Time skipping is applied globally. So if one workflow is waiting on an activity (which disables time-skipping so it runs in real time) but another workflow is expected to time-skip until a timer, the latter won't happen immediately like it would if it were tested on its own.\r\n\r\n@Quinn-With-Two-Ns and/or @mjameswh - while our test service isn't really built for concurrent top-level workflows, the map at https://github.com/temporalio/sdk-java/blob/57cb086f7df02c54e6952f46855eb9118c4b77ca/temporal-test-server/src/main/java/io/temporal/internal/testservice/TestVisibilityStoreImpl.java#L58 should be concurrent map because technically child workflows can run concurrently too. I guess this was just missed in #1067. It seems other non-thread-safe constructs are used in `TestWorkflowMutableStateImpl` but that is per workflow execution so none of that code will run concurrently, and `TestWorkflowStoreImpl` locks things it uses, so it's just this field in `TestVisibilityStoreImpl` we need to fix.","createdAt":"2023-06-29T13:55:59Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1802#issuecomment-1613228614","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5gNyB4","author":{"login":"sfc-gh-pjagielski"},"authorAssociation":"NONE","body":"@cretz thanks for the analysis! \r\nCurrently we have some tests with concurrent workflows and this is the only issue that we're facing. Commenting out the code with `upsertSearchAttributes` helps, so I guess the change to `ConcurrentHashMap` should resolve the issue for us","createdAt":"2023-06-30T07:07:41Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1802#issuecomment-1614225528","viewerDidAuthor":false}],"createdAt":"2023-06-29T13:26:29Z","labels":[],"milestone":null,"number":1802,"reactionGroups":[],"state":"CLOSED","title":"[Test server] ConcurrentModificationException on Workflow.upsertSearchAttributes in tests","updatedAt":"2023-10-23T14:24:54Z","url":"https://github.com/temporalio/sdk-java/issues/1802"}
