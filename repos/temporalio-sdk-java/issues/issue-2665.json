{"assignees":[],"author":{"id":"U_kgDOCda2EQ","is_bot":false,"login":"martin-ncs","name":"Martin Scotta"},"body":"\nWe have recently start using temporal in our mature and 100% Koltin stack.\n\nWe are seeing some serialization issues and we would like to request guidance.\n\n\n**Problem**:\n\nThe existing `PayloadConverter` interface provides a method `Optional<Payload> toData(Object value)`, which fits well with libraries like Jackson/Gson.\n\nHowever `kotlinx.serialization` works with compile-time information to resolve the correct strategy to encode values. In particular it uses `encodeToString(SerializationStrategy<T>, value: T): String` to encode.\n\nThis technical difference means that Kotlin relies on a-priori information, which the current `PayloadConverter` interface method does not provides, so there's a big impedance mismatch between these two worlds making it impossible to write a custom adapter between them.\n\n\n**Impact**:\n\nThere are two problems when creating workflow/activities:\n\n1. **very commonly serializable objects cannot be serialized**. This is simply kotlin unable to proceed due to missing information, like for instance trying to encode `List<Int>` but receiving an `ArrayList`. While these are problematic, developers can work around these by swapping these values for plain blob strings, and then manually deserializing from the other side.\n\n\n2. **object are silently incorrectly serialized**. We believe this is because the `DataConverter` falls back into default Jackson behavior. This category is quite problematic as the workflows/activities have been already been created with invalid input data, the exception will happen during the deserialization phase, which temporal will attempt to retry only to face the same error again.\n\n\n---\n\nWe'd like to hear if others have faced similar experiences, in particular those working with Kotlin stacks.\n\nAny insights or workaround would be greatly appreciated. Thanks!","closedAt":"2025-10-07T22:30:54Z","comments":[{"id":"IC_kwDODN12PM7GPWSU","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":">However kotlinx.serialization works with compile-time information to resolve the correct strategy to encode values. In particular it uses encodeToString(SerializationStrategy<T>, value: T): String to encode.\n\nI don't think `kotlinx.serialization` isn't using any compile time information. You can pass a custom [SerializationStrategy](https://kotlinlang.org/api/kotlinx.serialization/kotlinx-serialization-core/kotlinx.serialization/-serialization-strategy/) which you can do in your data converter or you could call the overload that doesn't take a `SerializationStrategy` https://kotlinlang.org/api/kotlinx.serialization/kotlinx-serialization-json/kotlinx.serialization.json/-json/encode-to-string.html\n\n>Like for instance trying to encode List<Int> but receiving an ArrayList\n\nThat seems like an issue with your custom `DataConverter`. More complex type can absolutely be support. The default data converter for example : https://github.com/temporalio/sdk-java/blob/5629f0c1603c561d552e5df6fd59218c329a342a/temporal-kotlin/src/test/kotlin/io/temporal/client/WorkflowClientExtTest.kt#L62 supports them fine so there is no reason in principle your custom data converter can't as well.","createdAt":"2025-09-23T23:47:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2665#issuecomment-3325912212","viewerDidAuthor":false},{"id":"IC_kwDODN12PM7GR_rh","author":{"login":"martin-ncs"},"authorAssociation":"NONE","body":"HI @Quinn-With-Two-Ns thanks for your reply.\n\nIt's true that kotlin uses `SerializationStrategy` interface, although that works under the hood.\n\nThe common approach is to use one of these two:\n\n- `inline fun <reified T> encodeToString(value: T): String`: most commonly used, simply transforms a value into string\n\n- `inline fun <reified T> serializer(): KSerializer<T>`: used in low-level scenarios, to get the strategy to serialize with\n\nBoth of these are using reified types, which are only available during compile-time; at runtime these values are never accessible.\n\nMoreso, here's another key difference: in kotlin the serialized payload is not a function of the runtime object, instead it's **a function of the compile-time information**.\n\nConsider the following example:\n\n```kotlin\n\n@Serializable\nsealed interface Sealed {\n\n    @Serializable\n    data class Foo(\n        val foo: String,\n    ) : Sealed\n}\n\nval json = kotlinx.serialization.json.Json {\n    classDiscriminator = \"type\"\n}\n\nval foo = Sealed.Foo(\"123\")\n\n// 1. encoding the object as [Sealed.Foo]\njson.encodeToString<Sealed.Foo>(foo).also(::println) // prints {\"foo\":\"123\"}\n\n// 2. encoding the same instance but now as a [Sealed]\njson.encodeToString<Sealed>(foo).also(::println) // prints {\"type\":\"Sealed.Foo\",\"foo\":\"123\"}\n```\n\nThe same object will result in different payloads as kotlin relies on the type information available to encode/decode.\n\nThis is essentially what makes writing the adapter quite challenging. \n\nJust for reference here's one draft (read naive) implementation of how this adapter might look like:\n\n```kotlin\ninternal class KotlinDataConverter(\n    private val json: Json,\n) : DataConverter {\n\n    override fun <T> toPayload(value: T?): Optional<Payload> {\n\n        if (value == null) return Optional.empty()\n\n        val serializer = json.serializersModule.serializer(value::class.java) // <-- here's where we hit the wall\n\n        val data = json.encodeToString(serializer, value)\n            .toByteArray()\n            .let(ByteString::copyFrom)\n\n        return Payload.newBuilder()\n            .setData(data)\n            .build()\n            .let(Optional<Payload>::of)\n    }\n```\n\n\n**Is the type `T` known on both ends of the wire?** One possible solution might be to expose `valueType` and `valueGenericType` during serialization, similar to what `fromPayloads` does.","createdAt":"2025-09-24T05:32:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2665#issuecomment-3326606049","viewerDidAuthor":false},{"id":"IC_kwDODN12PM7JVyHI","author":{"login":"martin-ncs"},"authorAssociation":"NONE","body":"hello @Quinn-With-Two-Ns -- any update?","createdAt":"2025-10-07T17:42:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2665#issuecomment-3377930696","viewerDidAuthor":false},{"id":"IC_kwDODN12PM7JZjff","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Sorry I didn't realize you were waiting for an update. Not sure what update I can provide. My recommendation is still the same as above. The Temporal Java SDK is a Java library and cannot use Kotlin specific features like reified generics so obviously we don't have type information during serialization because of type erasure. If we ever build a Kotlin SDK then we would of course support them.","createdAt":"2025-10-07T22:24:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2665#issuecomment-3378919391","viewerDidAuthor":false},{"id":"IC_kwDODN12PM7JZmOD","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"I am going to close this issue since we don't like to use github issue for community discussion, in the future please use our [forum](https://community.temporal.io/) or [community slack ](https://temporal.io/community) Thanks!","createdAt":"2025-10-07T22:30:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2665#issuecomment-3378930563","viewerDidAuthor":false},{"id":"IC_kwDODN12PM7JZ1VG","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"We prefer to keep Github issues for bug reports and/or feature requests thanks for your understanding.","createdAt":"2025-10-07T23:07:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/2665#issuecomment-3378992454","viewerDidAuthor":false}],"createdAt":"2025-09-23T01:20:19Z","labels":[],"milestone":null,"number":2665,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":6}}],"state":"CLOSED","title":"Serialization with `kotlinx.serialization`","updatedAt":"2025-10-07T23:07:05Z","url":"https://github.com/temporalio/sdk-java/issues/2665"}
