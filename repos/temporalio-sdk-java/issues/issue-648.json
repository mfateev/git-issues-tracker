{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"## Expected Behavior\r\n\r\nTest https://github.com/Spikhalskiy/java-sdk/commit/81e25cd16e651f1b3150d9a35874a0a9d48f87c7#diff-a0367d38077edb107a1ef33f815c2f2122cdb2fe9f3d4572cd4a2aacd0cf4545R35 passes without any error\r\n\r\n## Actual Behavior\r\n\r\nThe unit test fails with \r\n\r\n```\r\nCaused by: io.temporal.internal.replay.InternalWorkflowTaskException: Failure handling event 7 of 'EVENT_TYPE_TIMER_STARTED' type. IsReplaying=true, PreviousStartedEventId=3, workflowTaskStartedEventId=20, Currently Processing StartedEventId=3\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:188)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleEvent(ReplayWorkflowRunTaskHandler.java:140)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:180)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:150)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithEmbeddedQuery(ReplayWorkflowTaskHandler.java:201)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:114)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:319)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:279)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:73)\r\n\t... 4 common frames omitted\r\nCaused by: java.lang.IllegalArgumentException: Timer: invalid CANCEL_TIMER_COMMAND_SENT->TIMER_STARTED, transition history is [CREATED->SCHEDULE, START_COMMAND_CREATED->START_TIMER, START_COMMAND_CREATED->TIMER_STARTED, START_COMMAND_RECORDED->CANCEL, CANCEL_TIMER_COMMAND_CREATED->CANCEL_TIMER]\r\n\tat io.temporal.internal.statemachines.StateMachine.executeTransition(StateMachine.java:130)\r\n\tat io.temporal.internal.statemachines.StateMachine.handleHistoryEvent(StateMachine.java:91)\r\n\tat io.temporal.internal.statemachines.EntityStateMachineBase.handleEvent(EntityStateMachineBase.java:63)\r\n\tat io.temporal.internal.statemachines.CancellableCommand.handleEvent(CancellableCommand.java:72)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleCommandEvent(WorkflowStateMachines.java:250)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEventImpl(WorkflowStateMachines.java:194)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:173)\r\n\t... 12 common frames omitted\r\n```\r\n\r\n## Root cause analysis\r\n\r\n`Workflow.getVersion` call during replays causes the end of workflow task every single time. We wait till the end of the workflow task (the return from the event lopp) to perform a match with events from history and return the result. Without that the callback publishing the result to the workflow thread is not getting called and workflow code blocks on getVersion. This causes a difference in the structure of workflow tasks in the original run and its replays.\r\n\r\nLet's see an example of how it can lead to problems when mixed with cancelations.\r\n\r\n### Original execution\r\n\r\nA sequence of operations in the original execution:\r\n```\r\nSTART-OF-WORKFLOW-TASK\r\ncreate_timer_1\r\ngetVersion\r\ncancel_timer_1\r\ncreate_timer_2\r\nEND-OF-WORKFLOW-TASK\r\n```\r\n\r\ncommands:\r\n```\r\nCOMMAND_TYPE_RECORD_MARKER              //for getVersion\r\nCOMMAND_TYPE_START_TIMER                     //for timer_2\r\n```\r\n\r\nevents on the server created for the commands:\r\n```\r\nEVENT_TYPE_MARKER_RECORDED\r\nEVENT_TYPE_TIMER_STARTED\r\n```\r\n\r\n_Note how the cancellation of timer_1 inside the workflow task prevents sending a scheduling command for this timer_\r\n\r\n### Now we are performing a replay:\r\n\r\nSTART-OF-WORKFLOW-TASK-1\r\ncreate_timer_1\r\ngetVersion\r\nEND-OF-WORKFLOW-TASK-1\r\nSTART-OF-WORKFLOW-TASK-2\r\ncancel_timer_1\r\ncreate_timer_2\r\nEND-OF-WORKFLOW-TASK-2\r\n\r\ncommands generated during WORKFLOW-TASK-1:\r\n```\r\nCOMMAND_TYPE_START_TIMER                      //for timer_1\r\nCOMMAND_TYPE_RECORD_MARKER              //for getVersion\r\n```\r\ncommands generated during WORKFLOW-TASK-2:\r\n```\r\nCOMMAND_TYPE_CANCEL_TIMER                   //for timer_1\r\nCOMMAND_TYPE_START_TIMER                      //for timer_2\r\n```\r\n\r\nNow let's see how does this sequence of commands will play with our event history:\r\n```\r\nEVENT_TYPE_MARKER_RECORDED\r\nEVENT_TYPE_TIMER_STARTED\r\n```\r\n\r\nStep 1. We handle EVENT_TYPE_MARKER_RECORDED. We try to match it with the command COMMAND_TYPE_START_TIMER for timer_1, we can't match them, we handle the event as a non-matched history event (that can be for deleted getVersion call for example)\r\n\r\nStep 2. We handle EVENT_TYPE_TIMER_STARTED. And we match it with COMMAND_TYPE_START_TIMER for timer_1.\r\nBut this history event is for timer_2. timer_1 has no events at all because it was canceled originally inside the same workflow task. This way change in workflow task structure causes events history to be matched incorrectly with the replaying commands. \r\n\r\nStep 3. COMMAND_TYPE_CANCEL_TIMER from the second workflow task doesn't find the matching event from the server at all and the replay fails.\r\n","closedAt":"2021-10-27T19:13:51Z","comments":[],"createdAt":"2021-08-18T23:18:20Z","labels":[],"milestone":{"number":6,"title":"1.5.0","description":"","dueOn":"2021-11-02T00:00:00Z"},"number":648,"reactionGroups":[],"state":"CLOSED","title":"Version StateMachine causes different in workflow task structure in replays breaking cancelations and leading to incorrect command-event matches","updatedAt":"2021-10-27T19:13:51Z","url":"https://github.com/temporalio/sdk-java/issues/648"}
