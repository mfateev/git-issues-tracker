{
  "assignees": [],
  "author": {
    "id": "MDQ6VXNlcjExOTQyMg==",
    "is_bot": false,
    "login": "tsurdilo",
    "name": "Tihomir Surdilovic"
  },
  "body": "[processCancelTimer](https://github.com/temporalio/sdk-java/blob/master/temporal-test-server/src/main/java/io/temporal/internal/testservice/TestWorkflowMutableStateImpl.java#L979-L983) throws invalid_argument exception here if timer is null\nthis timer however would have been already removed if this same workflow task receives a TIMER_FIRED event for this same timer:\n\nhttps://github.com/temporalio/sdk-java/blob/master/temporal-test-server/src/main/java/io/temporal/internal/testservice/TestWorkflowMutableStateImpl.java#L1437\n\nI think on cancel command, we should only throw if we check first that if timer is null if it was actually removed in same workflow task.\n\nIssue does not allow workflow in test to complete / make progress.\n\nFull error can look like:\n\n[Workflow Executor taskQueue=\"flakyservice\", namespace=\"default\": 1] WARN io.temporal.internal.worker.WorkflowWorker - Failure while reporting workflow progress to the server. If seen continuously the workflow might be stuck. WorkflowId=flaky, RunId=6d9e3f8a-7a73-4aaf-8cdd-02a3cee750f1, startedEventId=22\nio.grpc.StatusRuntimeException: INVALID_ARGUMENT: invalid history builder state for action\n\tat io.grpc.stub.ClientCalls.toStatusRuntimeException(ClientCalls.java:268)\n\tat io.grpc.stub.ClientCalls.getUnchecked(ClientCalls.java:249)\n\tat io.grpc.stub.ClientCalls.blockingUnaryCall(ClientCalls.java:167)\n\tat io.temporal.api.workflowservice.v1.WorkflowServiceGrpc$WorkflowServiceBlockingStub.respondWorkflowTaskCompleted(WorkflowServiceGrpc.java:6079)\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.lambda$sendTaskCompleted$0(WorkflowWorker.java:557)\n\tat io.temporal.internal.retryer.GrpcSyncRetryer.retry(GrpcSyncRetryer.java:49)\n\tat io.temporal.internal.retryer.GrpcRetryer.retryWithResult(GrpcRetryer.java:40)\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.sendTaskCompleted(WorkflowWorker.java:552)\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:409)\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:336)\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$1(PollTaskExecutor.java:76)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)\n\tat java.base/java.lang.Thread.run(Thread.java:1583)\n\n\nStill working on a reliable test for this. @Quinn-With-Two-Ns ping me and can point you to slack there where there is a reproduce that you may need to run a number of times to run into this.",
  "closedAt": null,
  "comments": [],
  "createdAt": "2025-07-27T17:32:27Z",
  "labels": [
    {
      "id": "LA_kwDODN12PM8AAAABzzHCJQ",
      "name": "test server",
      "description": "Related to the test server",
      "color": "A71076"
    }
  ],
  "milestone": null,
  "number": 2606,
  "reactionGroups": [],
  "state": "OPEN",
  "title": "TestWorkflowMutableStateImpl - race condition between TimerFired event and CancelTimer command",
  "updatedAt": "2025-09-26T06:39:54Z",
  "url": "https://github.com/temporalio/sdk-java/issues/2606"
}
