{"assignees":[],"author":{"id":"MDQ6VXNlcjE2MTcxNzI2","is_bot":false,"login":"darewreck54","name":"Derek"},"body":"I have a case where I'm not able to cancel the workflow.  The workflow itself experience a workflowTaskFail but keeps running infinitely since no timeout was specified which the UI marks as runnings.  When I try to send a request to cancel the workflow, the request return a 204 but the workflow is never canceled and is still running.  However, if i start a new workflow, the same request will actually cancel the workflow.\r\n\r\nBelow is a screen shot of the workflow history where you can see the results.\r\n\r\n![image](https://user-images.githubusercontent.com/16171726/109483919-a4ff1280-7a34-11eb-8ddb-7ac88928f108.png)\r\n\r\n## Expected Behavior\r\nI expect that the workflow would cancel if it returns a 204\r\n\r\n## Actual Behavior\r\nRequest returns a 204 but never cancels.\r\n\r\n## Steps to Reproduce the Problem\r\n1) Have a workflowTask fail\r\n2) Try to cancel the workflow\r\n \r\n## Specifications\r\n\r\n  - Version:\r\n  - Platform:\r\n","closedAt":"2021-03-15T09:00:27Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDc4ODEwNTIyMg==","author":{"login":"samarabbas"},"authorAssociation":"MEMBER","body":"Can you share the complete `failure` message in screen shot above.  Also please also share the entire workflow execution history for this run.\r\nLooks like the workflow task is failing most likely due to either workflow implementation logic or might be due to some java sdk issue.  Once the workflow execution goes into this state then workflow cancellation will not work as it requires the workflow task to be successfully processed.  In this situation if you want to stop the workflow execution then your only option is to `Terminate` it.","createdAt":"2021-03-01T16:56:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/371#issuecomment-788105222","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4ODIxODAyMw==","author":{"login":"darewreck54"},"authorAssociation":"NONE","body":"```\r\nio.temporal.internal.replay.InternalWorkflowTaskException: Failure handling event 10 of 'EVENT_TYPE_WORKFLOW_TASK_STARTED' type. IsReplaying=false, PreviousStartedEventId=10, workflowTaskStartedEventId=10, Currently Processing StartedEventId=10 \r\nio.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:193)\r\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleEvent(ReplayWorkflowRunTaskHandler.java:140)\r\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:180)\r\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:150)\r\nio.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithEmbeddedQuery(ReplayWorkflowTaskHandler.java:201)\r\nio.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:114)\r\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:314)\r\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:280)\r\nio.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:73)\r\njava.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\njava.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\njava.lang.Thread.run(Thread.java:748)\r\n\r\nCaused By: java.lang.RuntimeException: WorkflowTask: failure executing SCHEDULED->WORKFLOW_TASK_STARTED, transition history is [CREATED->WORKFLOW_TASK_SCHEDULED] \r\nio.temporal.internal.statemachines.StateMachine.executeTransition(StateMachine.java:140)\r\nio.temporal.internal.statemachines.StateMachine.handleHistoryEvent(StateMachine.java:91)\r\nio.temporal.internal.statemachines.EntityStateMachineBase.handleEvent(EntityStateMachineBase.java:63)\r\nio.temporal.internal.statemachines.WorkflowStateMachines.handleEventImpl(WorkflowStateMachines.java:210)\r\nio.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:178)\r\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleEvent(ReplayWorkflowRunTaskHandler.java:140)\r\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:180)\r\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:150)\r\nio.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithEmbeddedQuery(ReplayWorkflowTaskHandler.java:201)\r\nio.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:114)\r\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:314)\r\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:280)\r\nio.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:73)\r\njava.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\njava.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\njava.lang.Thread.run(Thread.java:748)\r\n\r\nCaused By: java.lang.NullPointerException: type is marked non-null but is null \r\n....\r\n```\r\n\r\nWhat is the proper way to deal with exceptions thrown  in your workflow entry point?  It looks like i need to throw a specific type of exception so that temporal knows how to put it in a state taht can be canceled?","createdAt":"2021-03-01T19:41:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/371#issuecomment-788218023","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4ODMwODgzMg==","author":{"login":"vitarb"},"authorAssociation":"CONTRIBUTOR","body":"What is the stack trace for the last NullPointerException? Is it happening in your workflow code?","createdAt":"2021-03-01T21:30:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/371#issuecomment-788308832","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4ODQzMDY4OQ==","author":{"login":"darewreck54"},"authorAssociation":"NONE","body":"@vitarb the stack trace is specific to my workflow code where a value was null when it shouldn't be.  I'm wondering how I'm suppose to properly handle it, so that the workflow will fail automatically without forcing me to send at terminate command","createdAt":"2021-03-02T00:26:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/371#issuecomment-788430689","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4ODQzOTAxNg==","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"By default NPE (as well as any unknown exception) will cause the workflow to get stuck. This is to give you chance to find the bug and fix it through a new deployment. If you want your workflow to fail on all exceptions specify it through  WorkflowImplementationOptions.failWorkflowExceptionTypes:\r\n```java\r\n    worker.registerWorkflowImplementationTypes(\r\n        WorkflowImplementationOptions.newBuilder()\r\n            .setFailWorkflowExceptionTypes(Throwable.class)\r\n            .build(),\r\n        <YourWorkflowClass>.class);\r\n```","createdAt":"2021-03-02T00:30:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/371#issuecomment-788439016","viewerDidAuthor":true},{"id":"MDEyOklzc3VlQ29tbWVudDc4ODQ2MDc3MQ==","author":{"login":"darewreck54"},"authorAssociation":"NONE","body":"thanks! @mfateev ","createdAt":"2021-03-02T00:52:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/371#issuecomment-788460771","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4ODQ3MTAwOQ==","author":{"login":"darewreck54"},"authorAssociation":"NONE","body":"Just thinking out loud here.  In the case a user wants to trouble shoot, after a new deployment would you `replay` which would start from where it left off?  However, if there is something wrong with the inputs into the workflow then the only solution would to start the workflow with the correct input?  Does that sound correct?","createdAt":"2021-03-02T01:03:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/371#issuecomment-788471009","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4ODUxNjU0Mw==","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"Yes, you cannot change inputs after the workflow has started.","createdAt":"2021-03-02T02:00:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/371#issuecomment-788516543","viewerDidAuthor":true}],"createdAt":"2021-03-01T10:23:38Z","labels":[],"milestone":null,"number":371,"reactionGroups":[],"state":"CLOSED","title":"When a workflow task fails and the workflow is still running, cancel request doesn't seem to work","updatedAt":"2021-03-15T09:00:27Z","url":"https://github.com/temporalio/sdk-java/issues/371"}
