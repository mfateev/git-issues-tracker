{"assignees":[],"author":{"id":"MDQ6VXNlcjExODExNDQ4","is_bot":false,"login":"Bennett-Lynch","name":"Bennett Lynch"},"body":"I need to register [jackson-module-kotlin](https://mvnrepository.com/artifact/com.fasterxml.jackson.module/jackson-module-kotlin) with the Temporal SDK in order to support Kotlin data classes. As far as Jackson goes, this is accomplished with a fairly trivial modification to the `ObjectMapper`. However, the Temporal SDK currently makes it very cumbersome to get a hook onto that reference.\r\n\r\nWhile it's possible to declare your entirely own `DataConverter`, it requires replicating a large portion of the default Temporal configuration. E.g., here is the code I would need to write if I just wanted to make one simple Jackson modification:\r\n\r\n```\r\n// Replicate the default Jackson configuration\r\nval mapper = ObjectMapper()\r\nmapper.configure(DeserializationFeature.ADJUST_DATES_TO_CONTEXT_TIME_ZONE, false)\r\nmapper.configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, false)\r\nmapper.registerModule(JavaTimeModule())\r\nmapper.registerModule(Jdk8Module())\r\nmapper.setVisibility(PropertyAccessor.FIELD, JsonAutoDetect.Visibility.ANY)\r\n\r\n// Enable my Jackson customization\r\nmapper.registerKotlinModule()\r\n\r\n// Replicate the default payload converters (in order) while overriding JacksonJsonPayloadConverter\r\nval dataConverter = DefaultDataConverter(\r\n    NullPayloadConverter(),\r\n    ByteArrayPayloadConverter(),\r\n    ProtobufJsonPayloadConverter(),\r\n    ProtobufPayloadConverter(),\r\n    JacksonJsonPayloadConverter(mapper)\r\n)\r\n\r\n// Register the global default\r\nGlobalDataConverter.register(dataConverter)\r\n```\r\n\r\nThis is a lot of boilerplate and prone to falling out of sync with the defaults that we're copy/pasting.\r\n\r\nAlternatively, I can use reflection to modify the `ObjectMapper` that is already registered globally. E.g.,\r\n\r\n```\r\nval jacksonConverter = DefaultDataConverter.STANDARD_PAYLOAD_CONVERTERS.first { it is JacksonJsonPayloadConverter }\r\nval mapperField = JacksonJsonPayloadConverter::class.java.getDeclaredField(\"mapper\")\r\nmapperField.isAccessible = true\r\nval mapper = mapperField.get(jacksonConverter) as ObjectMapper\r\nmapper.registerKotlinModule()\r\n```\r\n\r\nThis is of course hacky, but I actually prefer it since I know my settings won't drift out of sync from Temporal's default configuration, and I'll get an explicit failure if something breaks with the reflection.\r\n\r\nIt would be nice if it was simpler and easier to be able to customize the Jackson-level configuration. Some potential solutions:\r\n\r\n1. Similar to exposing a global `DataConverter`, expose a global `ObjectMapper`\r\n2. Expose properties for `List<PayloadConverter>` and `ObjectMapper` that would allow a user to drill down into the current mapper to modify it (this still feels a little hacky, since I would rather treat the current mapper as immutable)\r\n3. Expose something like a `UnaryOperator<ObjectMapper>` that allows a user to customize the mapper alongside Temporal's existing default configuration\r\n4. Expose an environment variable that will trigger Temporal to call `mapper.registerKotlinModule()`\r\n5. Expose an environment variable that will trigger Temporal to call `mapper.findAndRegisterModules()`\r\n\r\nRelated:\r\n1. https://community.temporal.io/t/hi-deserialization-problem/474/4\r\n6. https://github.com/temporalio/sdk-java/issues/139\r\n\r\nVersion: `1.16.0`\r\n","closedAt":"2022-08-27T02:23:50Z","comments":[{"id":"IC_kwDODN12PM5JQp7M","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"You don't need any of these complicated ways. \r\nCreate a new `DataConverter` using `DefaultDataConverter#newDefaultInstance()`. Create new `JacksonJsonPayloadConverter` with a `ObjectMapper` configured the way you need. Register your custom `JacksonJsonPayloadConverter` on the created `DefaultDataConverter` using `DefaultDataConverter#withPayloadConverterOverrides`.\r\nRegister the resulted `DataConverter` wherever you need (WorkflowClientOptions or GlobalDataConverter)\r\n\r\nA similar thing is done in this sample: https://github.com/temporalio/samples-java/blob/708324ffd1599df4d593b411e9516424be096033/src/main/java/io/temporal/samples/payloadconverter/crypto/Starter.java#L49\r\n\r\nit’s not the most obvious interface and not the best names, I agree. But it does the job and we will not change it already for the sake of maintaining compatibility.\r\n\r\nExposing a global ObjectMapper is not a congruent option to our approach to payload converters, because some projects may not be using Jackson at all. User configured ObjectMapper is not an essential piece for a Temporal app or framework. ","createdAt":"2022-08-27T02:23:50Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1387#issuecomment-1229102796","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5JQugr","author":{"login":"Bennett-Lynch"},"authorAssociation":"NONE","body":"Ah, I missed the `withPayloadConverterOverrides` method. That simplifies things a little bit, thanks. But it seems like I still need to replicate the following code:\r\n\r\nhttps://github.com/temporalio/sdk-java/blob/d2edb5489d9d8e1185e9fcca70208dafc540c82f/temporal-sdk/src/main/java/io/temporal/common/converter/JacksonJsonPayloadConverter.java#L43-L51","createdAt":"2022-08-27T04:36:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1387#issuecomment-1229121579","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5JQu4u","author":{"login":"Bennett-Lynch"},"authorAssociation":"NONE","body":"For anyone else who stumbles upon this, I ended up with a solution like this:\r\n\r\n```\r\nval mapper = ObjectMapper().apply {\r\n    configure(DeserializationFeature.ADJUST_DATES_TO_CONTEXT_TIME_ZONE, false)\r\n    configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, false)\r\n    findAndRegisterModules()\r\n    setVisibility(PropertyAccessor.FIELD, Visibility.ANY)\r\n}\r\nval dataConverter = DefaultDataConverter.newDefaultInstance()\r\n    .withPayloadConverterOverrides(JacksonJsonPayloadConverter(mapper))\r\nGlobalDataConverter.register(dataConverter)\r\n```\r\n\r\n*\\<edit\\>* Now this:\r\n\r\n```\r\nval mapper = KotlinObjectMapperFactory.new()\r\nval jacksonConverter = JacksonJsonPayloadConverter(mapper)\r\nval dataConverter = DefaultDataConverter.newDefaultInstance()\r\n    .withPayloadConverterOverrides(jacksonConverter)\r\nGlobalDataConverter.register(dataConverter)\r\n```","createdAt":"2022-08-27T04:50:50Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/1387#issuecomment-1229123118","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5JQvFH","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"@Bennett-Lynch You may also want to check out this class from our kotlin module: https://github.com/temporalio/sdk-java/blob/master/temporal-kotlin/src/main/kotlin/io/temporal/common/converter/KotlinObjectMapperFactory.kt","createdAt":"2022-08-27T04:58:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/1387#issuecomment-1229123911","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5JQvJC","author":{"login":"Bennett-Lynch"},"authorAssociation":"NONE","body":"> @Bennett-Lynch You may also want to check out this class from our kotlin module: https://github.com/temporalio/sdk-java/blob/master/temporal-kotlin/src/main/kotlin/io/temporal/common/converter/KotlinObjectMapperFactory.kt\r\n\r\nOh, awesome. Is there anyway the default configuration could pick this one up automatically? Either by using SPI or class path detection. Right now I'm having to manually set the global in my startup configuration and with a JUnit extension for tests.\r\n\r\nAlso it looks like the above class is missing the following:\r\n```\r\nconfigure(DeserializationFeature.ADJUST_DATES_TO_CONTEXT_TIME_ZONE, false)\r\n```\r\n\r\nPerhaps both should stem from a common default?","createdAt":"2022-08-27T05:00:39Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1387#issuecomment-1229124162","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5JQvq2","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"We are not gonna play with SPI as a part of the configuration of the core sdk. The consequences may be too severe if somebody has a magically picked up converter that they don’t expect to have. The benefits are not worth the risks.\r\nAlso, we do fully expect every project to customize their own Jackson (or another serializer) settings and these classes that we provide are just a starting point for users. For example, this configuration is not enough to handle some polymorphic class structures. So we are not saying that this configuration makes sense to every project and there likely will never be such a thing, so we will not automatically load or pick it up from the classpath. ","createdAt":"2022-08-27T05:19:22Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1387#issuecomment-1229126326","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5JQwcz","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"> Perhaps both should stem from a common default?\r\n\r\nYeah, it looks like I made a fix only in java config some time ago.\r\nhttps://github.com/temporalio/sdk-java/pull/1388","createdAt":"2022-08-27T05:47:15Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1387#issuecomment-1229129523","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5JQw-8","author":{"login":"Bennett-Lynch"},"authorAssociation":"NONE","body":"Offering automatic configuration via class-path module detection is a very convenient utility. Without it, I'll now be littering any project using Temporal and Kotlin with manual overrides in both prod/test configuration (which are somewhat cumbersome to insert, due to their global nature). In my case, I'm perfectly happy with the default serialization configuration otherwise. If including such detection in `temporal-kotlin` is too risky, I personally would love to have a separate and dedicated module option, like `temporal-kotlin-jackson`. Just my 2 cents, but I respect your opinion as the maintainer.","createdAt":"2022-08-27T06:05:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1387#issuecomment-1229131708","viewerDidAuthor":false}],"createdAt":"2022-08-27T02:09:52Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQ4","name":"question","description":"Further information is requested","color":"BFD4F2"},{"id":"LA_kwDODN12PM7NRayD","name":"wontfix","description":"This will not be worked on","color":"BFD4F2"}],"milestone":null,"number":1387,"reactionGroups":[],"state":"CLOSED","title":"Jackson configuration is cumbersome","updatedAt":"2022-08-27T06:05:39Z","url":"https://github.com/temporalio/sdk-java/issues/1387"}
