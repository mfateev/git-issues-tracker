{"assignees":[],"author":{"id":"MDQ6VXNlcjYzMTE4NzY0","is_bot":false,"login":"jeffschoner-stripe","name":""},"body":"## Expected Behavior\n\nCalling describe on the workflow should return a valid result.\n\n## Actual Behavior\n\nCalling describe on the workflow sometimes results in a GRPC exception being thrown.\n\n```\nio.grpc.StatusRuntimeException: UNKNOWN\n\tat io.grpc.stub.ClientCalls.toStatusRuntimeException(ClientCalls.java:271)\n\tat io.grpc.stub.ClientCalls.getUnchecked(ClientCalls.java:252)\n\tat io.grpc.stub.ClientCalls.blockingUnaryCall(ClientCalls.java:165)\n\tat io.temporal.api.workflowservice.v1.WorkflowServiceGrpc$WorkflowServiceBlockingStub.describeWorkflowExecution(WorkflowServiceGrpc.java:5523)\n```\n\n## Steps to Reproduce the Problem\n\nThere are not reliable repro steps. The issue is intermittent.\n\nIn a JUnit test, \n  1. Set up a `TestWorkflowEnvironment`. This is being done in a `@BeforeClass` method in a base class for the unit test class. All instances are stored in class variables for the life of the test. It's not clear to me if the static/class methods/variables are playing a role here or not.\n  2. In a `@Before` method on the class with the unit tests,\n    - Start a workflow. This is done indirectly in that our test is calling a GRPC endpoint that is also running inside the test which starts a workflow. However, the starting of the workflow is done synchronously back to the caller. It's not clear to me that the indirection here matters.\n    - Call DescribeWorkflowExecution using the workflow ID that was used in the previous step\n\n## Specifications\n\n  - Version: 1.27.1\n  - Platform: Linux\n","closedAt":"2025-09-26T17:12:23Z","comments":[{"id":"IC_kwDODN12PM7CzKab","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Thanks for the report we will investigate ","createdAt":"2025-09-08T22:11:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2652#issuecomment-3268191899","viewerDidAuthor":false},{"id":"IC_kwDODN12PM7ESl2e","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"So likely this error means some exception (that is not a `StatusRuntimeException`) was thrown while running [describeWorkflowExecution](https://github.com/temporalio/sdk-java/blob/bf0b196ce00143edcc39de80cb2fc0ad93ce80ea/temporal-test-server/src/main/java/io/temporal/internal/testservice/TestWorkflowMutableStateImpl.java#L3153). Since that is the most common way the client would receive an `UNKNOWN ` status. I was also able to manually confirm by adding a `throw new IllegalArgumentException(\"test\")` to the top of the above function. The SDK would log the exception so can you share any logs from these failed tests? The exception would look like this based on my test I described above.\n\n```\nSep 15, 2025 10:19:50 A.M. io.grpc.internal.SerializingExecutor run\nSEVERE: Exception while executing runnable io.grpc.internal.ServerImpl$JumpToApplicationThreadServerStreamListener$1HalfClosed@72a7e903\njava.lang.IllegalArgumentException: test\n\tat io.temporal.internal.testservice.TestWorkflowMutableStateImpl.describeWorkflowExecution(TestWorkflowMutableStateImpl.java:3154)\n\tat io.temporal.internal.testservice.TestWorkflowService.describeWorkflowExecution(TestWorkflowService.java:1691)\n\tat io.temporal.api.workflowservice.v1.WorkflowServiceGrpc$MethodHandlers.invoke(WorkflowServiceGrpc.java:8975)\n\tat io.grpc.stub.ServerCalls$UnaryServerCallHandler$UnaryServerCallListener.onHalfClose(ServerCalls.java:182)\n\tat io.grpc.PartialForwardingServerCallListener.onHalfClose(PartialForwardingServerCallListener.java:35)\n\tat io.grpc.ForwardingServerCallListener.onHalfClose(ForwardingServerCallListener.java:23)\n\tat io.grpc.internal.ServerCallImpl$ServerStreamListenerImpl.halfClosed(ServerCallImpl.java:351)\n\tat io.grpc.internal.ServerImpl$JumpToApplicationThreadServerStreamListener$1HalfClosed.runInContext(ServerImpl.java:860)\n\tat io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37)\n\tat io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:133)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144)\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642)\n\tat java.base/java.lang.Thread.run(Thread.java:1583)\n```","createdAt":"2025-09-15T17:27:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2652#issuecomment-3293207966","viewerDidAuthor":false},{"id":"IC_kwDODN12PM7EWkXk","author":{"login":"jeffschoner-stripe"},"authorAssociation":"CONTRIBUTOR","body":"@Quinn-With-Two-Ns Thanks for the pointer on what to look for. Here's the stack trace of one of the failures. Looks like it may be some sort race condition with child workflows\n\n```\n00:12:24.820\tSEVERE: Exception while executing runnable io.grpc.internal.ServerImpl$JumpToApplicationThreadServerStreamListener$1HalfClosed@77c3bde9\n00:12:24.820\tjava.lang.NullPointerException: Cannot invoke \"io.temporal.api.common.v1.WorkflowExecution.getWorkflowId()\" because \"data.execution\" is null\n00:12:24.820\t\tat io.temporal.internal.testservice.TestWorkflowMutableStateImpl.constructPendingChildExecutionInfo(TestWorkflowMutableStateImpl.java:3115)\n00:12:24.820\t\tat java.base/java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:197)\n00:12:24.820\t\tat java.base/java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:179)\n00:12:24.820\t\tat java.base/java.util.HashMap$ValueSpliterator.forEachRemaining(HashMap.java:1779)\n00:12:24.820\t\tat java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509)\n00:12:24.820\t\tat java.base/java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:499)\n00:12:24.820\t\tat java.base/java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:921)\n00:12:24.820\t\tat java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234)\n00:12:24.820\t\tat java.base/java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:682)\n00:12:24.820\t\tat io.temporal.internal.testservice.TestWorkflowMutableStateImpl.describeWorkflowExecutionInsideLock(TestWorkflowMutableStateImpl.java:3099)\n00:12:24.820\t\tat io.temporal.internal.testservice.TestWorkflowMutableStateImpl.describeWorkflowExecution(TestWorkflowMutableStateImpl.java:3030)\n00:12:24.820\t\tat io.temporal.internal.testservice.TestWorkflowService.describeWorkflowExecution(TestWorkflowService.java:1584)\n00:12:24.820\t\tat io.temporal.api.workflowservice.v1.WorkflowServiceGrpc$MethodHandlers.invoke(WorkflowServiceGrpc.java:7312)\n00:12:24.820\t\tat io.grpc.stub.ServerCalls$UnaryServerCallHandler$UnaryServerCallListener.onHalfClose(ServerCalls.java:182)\n00:12:24.820\t\tat io.grpc.internal.ServerCallImpl$ServerStreamListenerImpl.halfClosed(ServerCallImpl.java:354)\n00:12:24.820\t\tat io.grpc.internal.ServerImpl$JumpToApplicationThreadServerStreamListener$1HalfClosed.runInContext(ServerImpl.java:866)\n00:12:24.820\t\tat io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37)\n00:12:24.820\t\tat io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:133)\n00:12:24.820\t\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\n00:12:24.820\t\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\n00:12:24.820\t\tat java.base/java.lang.Thread.run(Thread.java:840)\n```\n\nIn the older version of the code we're running, it's in this function in `TestWorkflowMutableStateImpl.java`:\n```\n  private static PendingChildExecutionInfo constructPendingChildExecutionInfo(\n      StateMachine<ChildWorkflowData> sm) {\n    ChildWorkflowData data = sm.getData();\n    return PendingChildExecutionInfo.newBuilder()\n        .setWorkflowId(data.execution.getWorkflowId())\n        .setRunId(data.execution.getRunId())\n        .setWorkflowTypeName(data.initiatedEvent.getWorkflowType().getName())\n        .setInitiatedId(data.initiatedEventId)\n        .setParentClosePolicy(data.initiatedEvent.getParentClosePolicy())\n        .build();\n  }\n```","createdAt":"2025-09-15T22:56:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2652#issuecomment-3294250468","viewerDidAuthor":false}],"createdAt":"2025-09-05T20:01:05Z","labels":[{"id":"LA_kwDODN12PM8AAAABzzHCJQ","name":"test server","description":"Related to the test server","color":"A71076"}],"milestone":null,"number":2652,"reactionGroups":[],"state":"CLOSED","title":"UNKNOWN GRPC error on describe in TestWorkflowEnvironment","updatedAt":"2025-09-26T17:12:23Z","url":"https://github.com/temporalio/sdk-java/issues/2652"}
