{"assignees":[{"id":"MDQ6VXNlcjE0NjM2MjI=","login":"mfateev","name":"Maxim Fateev","databaseId":0}],"author":{"id":"MDQ6VXNlcjEyMTE3OTIz","is_bot":false,"login":"rubyhfu","name":""},"body":"## Expected Behavior\r\ntestEnv.sleep() should skip workflow's internal timer without actually sleeping.\r\n\r\n## Actual Behavior\r\nIt seems that the timer is actually sleeping or just hangs. All tests that use testEnv.sleep in a similar fashion as below have similar behavior, however, sometimes when ran as a class, it'll pass. \r\n\r\n## Steps to Reproduce the Problem\r\n\r\nWorkflow Interface:\r\n```\r\nimport io.temporal.workflow.QueryMethod;\r\nimport io.temporal.workflow.SignalMethod;\r\nimport io.temporal.workflow.WorkflowInterface;\r\nimport io.temporal.workflow.WorkflowMethod;\r\n\r\n@WorkflowInterface\r\npublic interface ExampleWorkflow {\r\n    @WorkflowMethod\r\n    String execute();\r\n\r\n    @SignalMethod\r\n    void updateState(String state);\r\n\r\n    @QueryMethod\r\n    String queryState();\r\n}\r\n\r\n```\r\n\r\nWorkflow Implementation:\r\n```\r\nimport java.time.Duration;\r\nimport io.temporal.workflow.Workflow;\r\nimport org.slf4j.Logger;\r\n\r\npublic class ExampleWorkflowImpl implements ExampleWorkflow {\r\n    Logger logger =  Workflow.getLogger(ExampleWorkflowImpl.class);\r\n    private String state;\r\n    private boolean completed;\r\n    private boolean terminated;\r\n    private boolean error;\r\n\r\n    public ExampleWorkflowImpl() {\r\n        this.state = \"INITIALIZED\";\r\n        this.completed = false;\r\n        this.terminated = false;\r\n        this.error = false;\r\n    }\r\n\r\n    @Override\r\n    public String execute() {\r\n        state = \"WAITING_FOR_SIGNAL\";\r\n        while (state.equals(\"WAITING_FOR_SIGNAL\")) {\r\n            Workflow.await(Duration.ofMinutes(20L), () -> (completed || terminated || error));\r\n            if (terminated) {\r\n                state = \"TERMINATED\";\r\n                return state;\r\n            } else if (error) {\r\n                state = \"ERROR\";\r\n                return state;\r\n            } else if (completed) {\r\n                state = \"PRELIM_COMPLETED\";\r\n            }\r\n        }\r\n        state = \"WAITING_FOR_MORE_SIGNAL_OR_TIMER_TO_END\";\r\n        Workflow.await(Duration.ofMinutes(20L), () -> (error));\r\n        if (error) {\r\n            state = \"ERROR\";\r\n            return state;\r\n        } else {\r\n            state = \"COMPLETED\";\r\n        }\r\n        return state;\r\n    }\r\n\r\n    @Override\r\n    public void updateState(String newState) {\r\n        switch(newState) {\r\n            case \"PRELIM_COMPLETED\":\r\n                completed = true;\r\n                break;\r\n            case \"TERMINATED\":\r\n                terminated = true;\r\n                break;\r\n            case \"ERROR\":\r\n                error = true;\r\n                break;\r\n            default:\r\n                logger.error(\"Unknown state: {}\", newState);\r\n                break;\r\n        }\r\n    }\r\n\r\n    @Override\r\n    public String queryState() {\r\n        return state;\r\n    }\r\n}\r\n```\r\n\r\nUnit Tests:\r\n```\r\nimport static org.junit.jupiter.api.Assertions.assertEquals;\r\n\r\nimport java.time.Duration;\r\nimport static java.util.concurrent.TimeUnit.SECONDS;\r\n\r\nimport io.temporal.client.WorkflowClient;\r\nimport io.temporal.client.WorkflowOptions;\r\nimport io.temporal.testing.TestWorkflowEnvironment;\r\nimport io.temporal.worker.Worker;\r\nimport org.junit.Rule;\r\nimport org.junit.jupiter.api.AfterEach;\r\nimport org.junit.jupiter.api.BeforeEach;\r\nimport org.junit.jupiter.api.Test;\r\nimport org.junit.jupiter.api.Timeout;\r\nimport org.junit.rules.TestWatcher;\r\nimport org.junit.runner.Description;\r\n\r\npublic class ExampleWorkflowImplTest {\r\n\r\n    /**\r\n     * Prints a history of the workflow under test in case of a test failure.\r\n     */\r\n    @Rule\r\n    public TestWatcher watchman =\r\n            new TestWatcher() {\r\n                @Override\r\n                protected void failed(Throwable e, Description description) {\r\n                    if (testEnv != null) {\r\n                        System.err.println(testEnv.getDiagnostics());\r\n                        testEnv.close();\r\n                    }\r\n                }\r\n            };\r\n\r\n    private TestWorkflowEnvironment testEnv;\r\n    private Worker worker;\r\n    private WorkflowClient client;\r\n    private ExampleWorkflow workflow;\r\n    private static final String WORKFLOW_TASK_QUEUE = \"EXAMPLE\";\r\n\r\n    @BeforeEach\r\n    public void setUp() {\r\n        testEnv = TestWorkflowEnvironment.newInstance();\r\n        worker = testEnv.newWorker(WORKFLOW_TASK_QUEUE);\r\n        client = testEnv.getWorkflowClient();\r\n        worker.registerWorkflowImplementationTypes(ExampleWorkflowImpl.class);\r\n        workflow = client.newWorkflowStub(\r\n                ExampleWorkflow.class,\r\n                WorkflowOptions.newBuilder()\r\n                        .setWorkflowExecutionTimeout(Duration.ofDays(2))\r\n                        .setTaskQueue(WORKFLOW_TASK_QUEUE)\r\n                        .build());\r\n        testEnv.start();\r\n    }\r\n\r\n    @Test\r\n    public void testTerminatedUpdateStatus() {\r\n        WorkflowClient.start(workflow::execute);\r\n        workflow.updateState(\"TERMINATED\");\r\n        assertEquals(\"TERMINATED\", workflow.queryState());\r\n    }\r\n\r\n    @Test\r\n    @Timeout(value = 10, unit = SECONDS)\r\n    public void testCompletedThenTimerCompletes() throws InterruptedException {\r\n        WorkflowClient.start(workflow::execute);\r\n        workflow.updateState(\"PRELIM_COMPLETED\");\r\n        while (!workflow.queryState().equals(\"WAITING_FOR_MORE_SIGNAL_OR_TIMER_TO_END\")) {\r\n            Thread.sleep(2000);\r\n        }\r\n        // this line hangs without the @Timeout rule\r\n        testEnv.sleep(Duration.ofMinutes(20L));\r\n        assertEquals(\"COMPLETED\", workflow.queryState());\r\n    }\r\n\r\n    @AfterEach\r\n    public void tearDown() {\r\n        testEnv.close();\r\n    }\r\n}\r\n\r\n```\r\n\r\n\r\n## Specifications\r\n\r\n  - Version: JUnit5, Mockito 1.10.19, Temporal SDK 1.0.0\r\n  - Platform: macOS Big Sur\r\n","closedAt":"2021-05-03T17:56:15Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDgzMDQ5MjIzMw==","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"I really appreciate the reproduction! I was looking around for exactly this when saw the issue. I'll update you when the fix is ready.","createdAt":"2021-05-01T02:22:04Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/459#issuecomment-830492233","viewerDidAuthor":true},{"id":"MDEyOklzc3VlQ29tbWVudDgzMDY4NzAzMw==","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"Found the bug. The fix is in PR. Thanks a lot for your help!","createdAt":"2021-05-01T20:06:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/459#issuecomment-830687033","viewerDidAuthor":true},{"id":"MDEyOklzc3VlQ29tbWVudDgzMDY4OTMwMw==","author":{"login":"rubyhfu"},"authorAssociation":"NONE","body":"Wonderful. Thank you! ","createdAt":"2021-05-01T20:22:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/459#issuecomment-830689303","viewerDidAuthor":false}],"createdAt":"2021-04-29T17:42:46Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":459,"reactionGroups":[],"state":"CLOSED","title":"testEnv.sleep doesn't work as expected and hangs","updatedAt":"2021-05-03T17:56:15Z","url":"https://github.com/temporalio/sdk-java/issues/459"}
