{"assignees":[],"author":{"id":"MDQ6VXNlcjM2NzEzMg==","is_bot":false,"login":"ghaskins","name":"Gregory Haskins"},"body":"## Expected Behavior\r\n\r\nTemporal workflows and activities should generate related spans when the Temporal client is properly configured with OpenTracing interceptors.\r\n\r\n## Actual Behavior\r\n\r\nSome spans end up severed from the parent.  This seems to be isolated to spans that are generated with a promise chain using .thenCompose.  Other spans seem to work as expected.\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Enable trace interceptors\r\n  1. Write a workflow that has at least two activities that are composed serially via .executeAsync -> .thenCompose\r\n  1. Observe that the workflow and first activity end up in one span, and the second activity ends up orphaned within its own span.\r\n\r\n## Specifications\r\n\r\n  - Version: Temporal Java SDK 1.22.3\r\n\r\n","closedAt":"2025-01-16T21:07:22Z","comments":[{"id":"IC_kwDODN12PM5wLCG2","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Looking at how `thenCompose` is implemented\r\n\r\n```\r\n  @Override\r\n  public <U> Promise<U> thenCompose(Functions.Func1<? super V, ? extends Promise<U>> fn) {\r\n    return then(\r\n        (result) -> {\r\n          if (failure != null) {\r\n            result.completeExceptionally(failure);\r\n            return;\r\n          }\r\n          try {\r\n            Promise<U> r = fn.apply(value);\r\n            result.completeFrom(r);\r\n          } catch (RuntimeException e) {\r\n            result.completeExceptionally(e);\r\n          }\r\n        });\r\n  }\r\n...\r\n\r\n  private <U> Promise<U> then(Functions.Proc1<CompletablePromise<U>> proc) {\r\n    CompletablePromise<U> resultPromise = new CompletablePromiseImpl<>();\r\n    if (completed) {\r\n      proc.apply(resultPromise);\r\n      unregisterWithRunner();\r\n    } else {\r\n      handlers.add(() -> proc.apply(resultPromise));\r\n    }\r\n    return resultPromise;\r\n  }\r\n\r\n```\r\n\r\nDifferent code paths can be taken if the future is already complete or not by the time it is called. If the future is already complete then `fn` is run in the calling thread so the trace context should be setup, but if the future is not ready it will be run in a callback thread without the context set. ","createdAt":"2024-01-08T22:45:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1962#issuecomment-1881940406","viewerDidAuthor":false},{"id":"IC_kwDODN12PM54enDY","author":{"login":"ghaskins"},"authorAssociation":"CONTRIBUTOR","body":"Just curious if there is any movement on this?","createdAt":"2024-03-26T19:22:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1962#issuecomment-2021290200","viewerDidAuthor":false},{"id":"IC_kwDODN12PM54es0_","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"No update at this time ","createdAt":"2024-03-26T19:35:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1962#issuecomment-2021313855","viewerDidAuthor":false},{"id":"IC_kwDODN12PM56mkal","author":{"login":"ghaskins"},"authorAssociation":"CONTRIBUTOR","body":"Would you consider a PR if I submitted one?","createdAt":"2024-04-15T13:58:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1962#issuecomment-2056930981","viewerDidAuthor":false},{"id":"IC_kwDODN12PM56nTRi","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Yes, PRs are always welcome!","createdAt":"2024-04-15T15:22:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/1962#issuecomment-2057122914","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6ZplEy","author":{"login":"ghaskins"},"authorAssociation":"CONTRIBUTOR","body":"Hi @Quinn-With-Two-Ns, I'm just looking at this now and trying to devise a fix.  I may have questions.","createdAt":"2025-01-08T14:30:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1962#issuecomment-2577813810","viewerDidAuthor":false}],"createdAt":"2023-12-31T21:51:42Z","labels":[],"milestone":null,"number":1962,"reactionGroups":[],"state":"CLOSED","title":"Tracing context does not propagate into .thenCompose","updatedAt":"2025-01-16T21:07:22Z","url":"https://github.com/temporalio/sdk-java/issues/1962"}
