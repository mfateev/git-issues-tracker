{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"## Expected Behavior\r\n\r\nIf WorkflowHistoryIterator throws StatusRuntimeException with DEADLINE_EXCEEDED code during reading from the remote Service, the Worker should be failing Workflow Task, not a Workflow Execution. This will allow the workers to retry the task and recover.\r\n\r\n## Actual Behavior\r\n\r\nOne user reports a Workflow failure:\r\n\r\n```\r\n\"workflowExecutionFailedEventAttributes\": {\r\n  \"failure\": {\r\n    \"message\": \"io.grpc.StatusRuntimeException: DEADLINE_EXCEEDED: deadline exceeded after 9.999730494s. [closed=[], open=[[remote_addr=temporal-server.prod-grpc.uni.club/10.10.106.219:80]]]\",\r\n    \"source\": \"JavaSDK\",\r\n    \"stackTrace\": \"io.temporal.internal.replay.WorkflowHistoryIterator.queryWorkflowExecutionHistory(WorkflowHistoryIterator.java:130)\\nio.temporal.internal.replay.WorkflowHistoryIterator.hasNext(WorkflowHistoryIterator.java:84)\\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:190)\\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:137)\\nio.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithQuery(ReplayWorkflowTaskHandler.java:129)\\nio.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:98)\\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handleTask(WorkflowWorker.java:293)\\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:237)\\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:178)\\nio.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:93)\\nco.elastic.apm.agent.concurrent.JavaConcurrent$RunnableLambdaWrapper.run(JavaConcurrent.java:237)\\njava.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\\njava.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\\njava.base/java.lang.Thread.run(Thread.java:834)\\n\",\r\n    \"cause\": {\r\n      \"message\": \"DEADLINE_EXCEEDED: deadline exceeded after 9.999730494s. [closed=[], open=[[remote_addr=temporal-server.prod-grpc.uni.club/10.10.106.219:80]]]\",\r\n      \"source\": \"JavaSDK\",\r\n      \"stackTrace\": \"io.grpc.stub.ClientCalls.toStatusRuntimeException(ClientCalls.java:271)\\nio.grpc.stub.ClientCalls.getUnchecked(ClientCalls.java:252)\\nio.grpc.stub.ClientCalls.blockingUnaryCall(ClientCalls.java:165)\\nio.temporal.api.workflowservice.v1.WorkflowServiceGrpc$WorkflowServiceBlockingStub.getWorkflowExecutionHistory(WorkflowServiceGrpc.java:3222)\\nio.temporal.internal.replay.WorkflowHistoryIterator.lambda$queryWorkflowExecutionHistory$0(WorkflowHistoryIterator.java:127)\\nio.temporal.internal.retryer.GrpcSyncRetryer.retry(GrpcSyncRetryer.java:60)\\nio.temporal.internal.retryer.GrpcRetryer.retryWithResult(GrpcRetryer.java:66)\\nio.temporal.internal.retryer.GrpcRetryer.retryWithResult(GrpcRetryer.java:60)\\nio.temporal.internal.replay.WorkflowHistoryIterator.queryWorkflowExecutionHistory(WorkflowHistoryIterator.java:122)\\nio.temporal.internal.replay.WorkflowHistoryIterator.hasNext(WorkflowHistoryIterator.java:84)\\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:190)\\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:137)\\nio.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithQuery(ReplayWorkflowTaskHandler.java:129)\\nio.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:98)\\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handleTask(WorkflowWorker.java:293)\\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:237)\\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:178)\\nio.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:93)\\nco.elastic.apm.agent.concurrent.JavaConcurrent$RunnableLambdaWrapper.run(JavaConcurrent.java:237)\\njava.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\\njava.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\\njava.base/java.lang.Thread.run(Thread.java:834)\\n\",\r\n      \"cause\": null,\r\n      \"applicationFailureInfo\": {\r\n        \"type\": \"io.grpc.StatusRuntimeException\",\r\n        \"nonRetryable\": false,\r\n        \"details\": null\r\n      }\r\n    },\r\n    \"applicationFailureInfo\": {\r\n      \"type\": \"java.lang.Error\",\r\n      \"nonRetryable\": false,\r\n      \"details\": null\r\n    }\r\n  },\r\n  \"retryState\": \"RetryPolicyNotSet\",\r\n  \"workflowTaskCompletedEventId\": \"2748\",\r\n  \"newExecutionRunId\": \"\"\r\n}\r\n```\r\n\r\nThe user claims that `WorkflowImplementationOptions.setFailWorkflowExceptionTypes` is not set.\r\n\r\n## Specifications\r\n\r\nJava SDK Version: 1.14.0\r\n\r\n## Additional context\r\n\r\nInvestigation and fix of this bug should be paired together with https://github.com/temporalio/sdk-java/issues/1242\r\n","closedAt":"2022-08-30T15:55:49Z","comments":[{"id":"IC_kwDODN12PM5JbJi9","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"I donâ€™t confirm it is a problem with JavaSDK. \r\nHow I was trying to reproduce it: I mocked the iterator to return an Error in different scenarios trying to reproduce it.\r\n\r\nthe only way to get this behavior (failure of Workflow Execution on this failure) is to have `failWorkflowExceptionTypes` set with Throwable or Error.\r\nIf this is the case, [the Error](https://github.com/temporalio/sdk-java/blob/37a0e463fae2312882b5c946f423a0dbf85f9666/temporal-sdk/src/main/java/io/temporal/internal/replay/WorkflowHistoryIterator.java#L130)\r\nis [getting checked](https://github.com/temporalio/sdk-java/blob/9e78e8a278005d8e0c85d788af8040b058c0622d/temporal-sdk/src/main/java/io/temporal/internal/replay/ReplayWorkflowRunTaskHandler.java#L201) against `failWorkflowExceptionTypes` and if it matches and is wrapped into `WorkflowExecutionException`, the workflow execution is [getting failed](https://github.com/temporalio/sdk-java/blob/5079086e065adc64aa3d17e505482785f0f51dfe/temporal-sdk/src/main/java/io/temporal/internal/replay/ReplayWorkflowTaskHandler.java#L244).\r\n\r\nThere is no code path that may lead to workflow execution failure on this Error if `failWorkflowExceptionTypes` is not set.\r\n","createdAt":"2022-08-30T15:50:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1395#issuecomment-1231853757","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5JbLMl","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Feel free to reopen if there is a reproduction.","createdAt":"2022-08-30T15:55:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1395#issuecomment-1231860517","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5J5ZOu","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"An actual reason for this problem: https://github.com/temporalio/sdk-java/issues/1408\r\nAlso a relevant change: https://github.com/temporalio/sdk-java/pull/1404","createdAt":"2022-09-07T19:20:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1395#issuecomment-1239782318","viewerDidAuthor":false}],"createdAt":"2022-08-30T02:03:22Z","labels":[],"milestone":null,"number":1395,"reactionGroups":[],"state":"CLOSED","title":"Workflow failed by Worker after DEADLINE_EXCEEDED is thrown by WorkflowHistoryIterator","updatedAt":"2022-09-07T19:20:29Z","url":"https://github.com/temporalio/sdk-java/issues/1395"}
