{"assignees":[],"author":{"id":"MDQ6VXNlcjQyODIwMjI=","is_bot":false,"login":"jlacefie","name":"Jonathan Lacefield"},"body":"## Expected Behavior\r\nWorkflow Failed Cloud Metrics and Java SDK Metrics should \"closely\" match each other\r\n\r\n## Actual Behavior\r\nWorkflow Failed metrics differ between Temporal Cloud and SDK metrics. \r\n\r\n## Steps to Reproduce the Problem\r\n- NDE should typically get retried through WFT, I'm not sure what exactly happened to there WFs, but I'm aware we can force the Workflow exec failure by setting WorkflowImplementationOptions with .setFailWorkflowExceptionTypes(NonDeterministicException.class)\r\n- This allowed me to reproduce the metric discrepancy between SDK's [workflow_failed](https://docs.temporal.io/references/sdk-metrics#workflow_failed) vs server/cloud's temporal_cloud_v0_workflow_failed_count, which seems to be the main concern.\r\n- it appears Java SDK is not reporting workflow_failures from the code path via the FailWorkflowExceptionTypes\r\n- The only place that SDK reports workflow_failures is from: https://github.com/temporalio/sdk-java/blob/v1.23.2/temporal-sdk/src/main/java/io/temporal/internal/replay/ReplayWorkflowExecutor.java#L97, which is not reachable when a workflow fails with WorkflowExecutionException from here: [https://github.com/temporalio/sdk-java/blob/v1.23.2/temporal-sdk/src/main/java/io/temporal/internal/replay/ReplayWorkflowRunTaskHandler.java#L2[â€¦]60](https://github.com/temporalio/sdk-java/blob/v1.23.2/temporal-sdk/src/main/java/io/temporal/internal/replay/ReplayWorkflowRunTaskHandler.java#L256-L260)\r\n## Specifications\r\n\r\n  - Version:\r\n  - Platform:\r\nTemporal Cloud","closedAt":"2024-07-09T19:21:24Z","comments":[{"id":"IC_kwDODN12PM6Ap4Dn","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Related to https://github.com/temporalio/sdk-java/issues/1590","createdAt":"2024-06-10T14:01:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2103#issuecomment-2158461159","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6EDe_4","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Investigating this more the Java SDK does report `workflow_failures` correctly if the exception is throw in the user workflow code. The miss is when the exception is thrown by the SDK itself, which is often where `NonDeterministicException` are thrown. ","createdAt":"2024-07-08T23:16:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2103#issuecomment-2215505912","viewerDidAuthor":false}],"createdAt":"2024-06-10T13:45:45Z","labels":[],"milestone":null,"number":2103,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"Java SDK is not reporting workflow_failures from the code path via the FailWorkflowExceptionTypes","updatedAt":"2024-07-09T19:21:24Z","url":"https://github.com/temporalio/sdk-java/issues/2103"}
