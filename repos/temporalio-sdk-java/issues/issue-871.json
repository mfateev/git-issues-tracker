{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"## Expected Behavior\r\n\r\nWorkflow method (https://github.com/Spikhalskiy/java-sdk/commit/1d6d8584c78df238ab06ff9d48d73b1ec4ad5bff#diff-8e1bd2b4d9c5c5fc5f71b84c7cccbfb73a8396d355e81421b4c2a66d491aa2c8R42):\r\n\r\n```java\r\n    @Override\r\n    public String execute() {\r\n      TestActivities.VariousTestActivities activities = ...\r\n      CancellationScope cancellationScope =\r\n          Workflow.newCancellationScope(() -> Async.procedure(activities::activity1, 1));\r\n      cancellationScope.run();\r\n      try {\r\n        // Forcing an end of WFT\r\n        Workflow.sleep(1000);\r\n        throw ApplicationFailure.newNonRetryableFailure(\"messsage\", \"type\");\r\n      } finally {\r\n        cancellationScope.cancel();\r\n      }\r\n    }\r\n```\r\n\r\nShould be able to fail the workflow execution. \r\n\r\n## Actual Behavior\r\n\r\nDeadlock with an activity state machine triggering an event loop on cancel:\r\n\r\n\r\n```\r\nNov 14, 2021 8:31:17 PM com.google.common.cache.LocalCache processPendingNotifications\r\nWARNING: Exception thrown by removal listener\r\nio.temporal.internal.sync.PotentialDeadlockException: Potential deadlock detected: workflow thread \"workflow-method-cdfe6e1a-c034-4f15-b422-f22073c9d5b-e05bc9c6-b9cb-42b1-9661-0a861ee383b1\" didn't yield control for over a second. Other workflow threads:\r\n\r\nnull\r\n\r\n\tat java.base@11.0.13/jdk.internal.misc.Unsafe.park(Native Method)\r\n\tat java.base@11.0.13/java.util.concurrent.locks.LockSupport.parkNanos(LockSupport.java:234)\r\n\tat java.base@11.0.13/java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2211)\r\n\tat app//io.temporal.internal.sync.WorkflowThreadContext.runUntilBlocked(WorkflowThreadContext.java:243)\r\n\tat app//io.temporal.internal.sync.WorkflowThreadImpl.runUntilBlocked(WorkflowThreadImpl.java:317)\r\n\tat app//io.temporal.internal.sync.DeterministicRunnerImpl.runUntilAllBlocked(DeterministicRunnerImpl.java:195)\r\n\tat app//io.temporal.internal.sync.SyncWorkflow.eventLoop(SyncWorkflow.java:156)\r\n\tat app//io.temporal.internal.replay.ReplayWorkflowExecutor.eventLoop(ReplayWorkflowExecutor.java:73)\r\n\tat app//io.temporal.internal.replay.ReplayWorkflowRunTaskHandler$StatesMachinesCallbackImpl.eventLoop(ReplayWorkflowRunTaskHandler.java:328)\r\n\tat app//io.temporal.internal.statemachines.WorkflowStateMachines.eventLoop(WorkflowStateMachines.java:455)\r\n\tat app//io.temporal.internal.statemachines.WorkflowStateMachines.lambda$scheduleActivityTask$ff6e4b43$1(WorkflowStateMachines.java:515)\r\n\tat app//io.temporal.internal.statemachines.WorkflowStateMachines$$Lambda$181/0x0000000800374840.apply(Unknown Source)\r\n\tat app//io.temporal.internal.statemachines.ActivityStateMachine.notifyCanceled(ActivityStateMachine.java:318)\r\n\tat app//io.temporal.internal.statemachines.ActivityStateMachine.cancelCommandNotifyCanceled(ActivityStateMachine.java:288)\r\n\tat app//io.temporal.internal.statemachines.ActivityStateMachine$$Lambda$185/0x0000000800373840.apply(Unknown Source)\r\n\tat app//io.temporal.internal.statemachines.FixedTransitionAction.apply(FixedTransitionAction.java:45)\r\n\tat app//io.temporal.internal.statemachines.StateMachine.executeTransition(StateMachine.java:147)\r\n\tat app//io.temporal.internal.statemachines.StateMachine.handleExplicitEvent(StateMachine.java:91)\r\n\tat app//io.temporal.internal.statemachines.EntityStateMachineBase.explicitEvent(EntityStateMachineBase.java:78)\r\n\tat app//io.temporal.internal.statemachines.ActivityStateMachine.cancel(ActivityStateMachine.java:277)\r\n\tat app//io.temporal.internal.statemachines.WorkflowStateMachines$$Lambda$201/0x0000000800389040.apply(Unknown Source)\r\n\tat app//io.temporal.internal.replay.ReplayWorkflowContextImpl.lambda$scheduleActivityTask$ef6c118$1(ReplayWorkflowContextImpl.java:213)\r\n\tat app//io.temporal.internal.replay.ReplayWorkflowContextImpl$$Lambda$202/0x0000000800389440.apply(Unknown Source)\r\n\tat app//io.temporal.internal.sync.SyncWorkflowContext.lambda$executeActivityOnce$d79fb25e$1(SyncWorkflowContext.java:225)\r\n\tat app//io.temporal.internal.sync.SyncWorkflowContext$$Lambda$203/0x0000000800389840.apply(Unknown Source)\r\n\tat app//io.temporal.internal.sync.CompletablePromiseImpl.lambda$thenApply$2df5ef44$1(CompletablePromiseImpl.java:210)\r\n\tat app//io.temporal.internal.sync.CompletablePromiseImpl$$Lambda$204/0x0000000800389c40.apply(Unknown Source)\r\n\tat app//io.temporal.internal.sync.CompletablePromiseImpl.lambda$handle$6a2a7e3d$1(CompletablePromiseImpl.java:219)\r\n\tat app//io.temporal.internal.sync.CompletablePromiseImpl$$Lambda$205/0x000000080038a040.apply(Unknown Source)\r\n\tat app//io.temporal.internal.sync.CompletablePromiseImpl.lambda$then$16b0e4cc$1(CompletablePromiseImpl.java:268)\r\n\tat app//io.temporal.internal.sync.CompletablePromiseImpl$$Lambda$206/0x000000080038a440.apply(Unknown Source)\r\n\tat app//io.temporal.internal.sync.CompletablePromiseImpl.invokeHandlers(CompletablePromiseImpl.java:276)\r\n\tat app//io.temporal.internal.sync.CompletablePromiseImpl.complete(CompletablePromiseImpl.java:167)\r\n\tat app//io.temporal.internal.sync.CancellationScopeImpl.cancel(CancellationScopeImpl.java:120)\r\n\tat app//io.temporal.workflow.determinism.CancelActivityDeadlockTest$ScheduleCancelActivityWorkflow.execute(CancelActivityDeadlockTest.java:63)\r\n\tat java.base@11.0.13/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base@11.0.13/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat java.base@11.0.13/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base@11.0.13/java.lang.reflect.Method.invoke(Method.java:566)\r\n\tat app//io.temporal.internal.sync.POJOWorkflowImplementationFactory$POJOWorkflowImplementation$RootWorkflowInboundCallsInterceptor.execute(POJOWorkflowImplementationFactory.java:317)\r\n\tat app//io.temporal.common.interceptors.WorkflowInboundCallsInterceptorBase.execute(WorkflowInboundCallsInterceptorBase.java:37)\r\n\tat app//io.temporal.internal.sync.POJOWorkflowImplementationFactory$POJOWorkflowImplementation.execute(POJOWorkflowImplementationFactory.java:292)\r\n\tat app//io.temporal.internal.sync.WorkflowExecuteRunnable.run(WorkflowExecuteRunnable.java:72)\r\n\tat app//io.temporal.internal.sync.SyncWorkflow.lambda$start$0(SyncWorkflow.java:137)\r\n\tat app//io.temporal.internal.sync.SyncWorkflow$$Lambda$172/0x0000000800377840.run(Unknown Source)\r\n\tat app//io.temporal.internal.sync.CancellationScopeImpl.run(CancellationScopeImpl.java:101)\r\n\tat app//io.temporal.internal.sync.WorkflowThreadImpl$RunnableWrapper.run(WorkflowThreadImpl.java:111)\r\n\tat java.base@11.0.13/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:515)\r\n\tat java.base@11.0.13/java.util.concurrent.FutureTask.run(FutureTask.java:264)\r\n\tat java.base@11.0.13/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n\tat java.base@11.0.13/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n\tat java.base@11.0.13/java.lang.Thread.run(Thread.java:829)\r\n```\r\n\r\n## Root cause analysis\r\n\r\nIt probably happens when an activity state machine takes a `SCHEDULE_COMMAND_CREATED --> CANCELED: CANCEL` route with triggering back an event loop on a workflow thread that it's already done. It's just a guess for now.","closedAt":"2023-03-07T14:28:00Z","comments":[],"createdAt":"2021-11-15T01:36:07Z","labels":[],"milestone":{"number":21,"title":"1.19.0","description":"","dueOn":"2023-03-16T00:00:00Z"},"number":871,"reactionGroups":[],"state":"CLOSED","title":"Deadlock during activity state machine cancelation","updatedAt":"2023-03-07T14:28:01Z","url":"https://github.com/temporalio/sdk-java/issues/871"}
