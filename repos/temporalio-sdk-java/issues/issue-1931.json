{"assignees":[],"author":{"id":"MDQ6VXNlcjMxNTMxOQ==","is_bot":false,"login":"karneyli","name":"Karney Li"},"body":"It used to be possible to issue a `testEnv.sleep(Duration)` in a test and subsequently query the execution in v1.22.2 but this seems to have been broken in v1.22.3, this may be related to the changes in https://github.com/temporalio/sdk-java/pull/1916\r\n\r\nHere's an example workflow:\r\n\r\n```\r\n@WorkflowInterface\r\ninterface HelloWorkflow {\r\n    @WorkflowMethod(name = \"HelloWorkflow\")\r\n    fun execute(name: String): String\r\n\r\n    @QueryMethod(name = \"GetName\")\r\n    fun getName(): String?\r\n}\r\n\r\n@WorkflowImpl(taskQueues = [\"default\"])\r\n@Component\r\nclass HelloWorkflowImpl : HelloWorkflow {\r\n    private var name: String? = null\r\n    override fun execute(name: String): String {\r\n        this.name = name\r\n        Workflow.await { name == \"Joel\" }\r\n        return \"Hello $name!\"\r\n    }\r\n\r\n    override fun getName() = name\r\n}\r\n```\r\n\r\n\r\nThen in my test\r\n\r\n```\r\n@ActiveProfiles(profiles = [\"test\"])\r\n@SpringBootTest\r\n@ComponentScan(\r\n    basePackages = [\r\n        \"io.temporal\",\r\n        \"com.wealthsimple.workflows\"\r\n    ],\r\n    basePackageClasses = [\r\n        HelloWorkflow::class,\r\n    ],\r\n)\r\nclass HelloWorkflowImplTest(\r\n    @Autowired val applicationContext: ConfigurableApplicationContext,\r\n    @Autowired val testEnv: TestWorkflowEnvironment,\r\n    @Autowired val workflowClient: WorkflowClient,\r\n) {\r\n\r\n    @BeforeEach\r\n    fun setUp() {\r\n        applicationContext.start()\r\n    }\r\n\r\n    @Test\r\n    fun `execute workflow`() {\r\n        val workflowStub = workflowClient.newUntypedWorkflowStub(\r\n            \"HelloWorkflow\",\r\n            WorkflowOptions { setTaskQueue(\"default\") },\r\n        )\r\n        workflowStub.start(\"Bob\")\r\n        testEnv.sleep(Duration.ofHours(1)) // <--- this should be allowed...\r\n        workflowStub.query(\"GetName\", String::class.java) shouldBe \"Bob\"\r\n    }\r\n}\r\n```\r\n\r\nI've verified that without the `testEnv.sleep` call, I'm able to query but with it I get the following stack trace.  \r\n\r\n```\r\n\r\nio.temporal.client.WorkflowQueryException: workflowId='f37b5007-44f3-43f0-bc80-1d242a349209', runId='', workflowType='HelloWorkflow'}\r\n\r\n\tat io.temporal.client.WorkflowStubImpl.throwAsWorkflowFailureExceptionForQuery(WorkflowStubImpl.java:477)\r\n\tat io.temporal.client.WorkflowStubImpl.query(WorkflowStubImpl.java:280)\r\n\tat io.temporal.client.WorkflowStubImpl.query(WorkflowStubImpl.java:266)\r\n\tat io.temporal.testing.TimeLockingInterceptor$TimeLockingWorkflowStub.query(TimeLockingInterceptor.java:165)\r\n\tat com.wealthsimple.workflows.HelloWorkflowImplTest.execute workflow(HelloWorkflowImplTest.kt:46)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:568)\r\n\tat org.junit.platform.commons.util.ReflectionUtils.invokeMethod(ReflectionUtils.java:727)\r\n\tat org.junit.jupiter.engine.execution.MethodInvocation.proceed(MethodInvocation.java:60)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain$ValidatingInvocation.proceed(InvocationInterceptorChain.java:131)\r\n\tat org.junit.jupiter.engine.extension.TimeoutExtension.intercept(TimeoutExtension.java:156)\r\n\tat org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestableMethod(TimeoutExtension.java:147)\r\n\tat org.junit.jupiter.engine.extension.TimeoutExtension.interceptTestMethod(TimeoutExtension.java:86)\r\n\tat org.junit.jupiter.engine.execution.InterceptingExecutableInvoker$ReflectiveInterceptorCall.lambda$ofVoidMethod$0(InterceptingExecutableInvoker.java:103)\r\n\tat org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.lambda$invoke$0(InterceptingExecutableInvoker.java:93)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain$InterceptedInvocation.proceed(InvocationInterceptorChain.java:106)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain.proceed(InvocationInterceptorChain.java:64)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain.chainAndInvoke(InvocationInterceptorChain.java:45)\r\n\tat org.junit.jupiter.engine.execution.InvocationInterceptorChain.invoke(InvocationInterceptorChain.java:37)\r\n\tat org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:92)\r\n\tat org.junit.jupiter.engine.execution.InterceptingExecutableInvoker.invoke(InterceptingExecutableInvoker.java:86)\r\n\tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.lambda$invokeTestMethod$7(TestMethodTestDescriptor.java:217)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.invokeTestMethod(TestMethodTestDescriptor.java:213)\r\n\tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:138)\r\n\tat org.junit.jupiter.engine.descriptor.TestMethodTestDescriptor.execute(TestMethodTestDescriptor.java:68)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:151)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)\r\n\tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n\tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)\r\n\tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)\r\n\tat java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\r\n\tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.invokeAll(SameThreadHierarchicalTestExecutorService.java:41)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$6(NodeTestTask.java:155)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$8(NodeTestTask.java:141)\r\n\tat org.junit.platform.engine.support.hierarchical.Node.around(Node.java:137)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.lambda$executeRecursively$9(NodeTestTask.java:139)\r\n\tat org.junit.platform.engine.support.hierarchical.ThrowableCollector.execute(ThrowableCollector.java:73)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.executeRecursively(NodeTestTask.java:138)\r\n\tat org.junit.platform.engine.support.hierarchical.NodeTestTask.execute(NodeTestTask.java:95)\r\n\tat org.junit.platform.engine.support.hierarchical.SameThreadHierarchicalTestExecutorService.submit(SameThreadHierarchicalTestExecutorService.java:35)\r\n\tat org.junit.platform.engine.support.hierarchical.HierarchicalTestExecutor.execute(HierarchicalTestExecutor.java:57)\r\n\tat org.junit.platform.engine.support.hierarchical.HierarchicalTestEngine.execute(HierarchicalTestEngine.java:54)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:147)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:127)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:90)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.lambda$execute$0(EngineExecutionOrchestrator.java:55)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.withInterceptedStreams(EngineExecutionOrchestrator.java:102)\r\n\tat org.junit.platform.launcher.core.EngineExecutionOrchestrator.execute(EngineExecutionOrchestrator.java:54)\r\n\tat org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:114)\r\n\tat org.junit.platform.launcher.core.DefaultLauncher.execute(DefaultLauncher.java:86)\r\n\tat org.junit.platform.launcher.core.DefaultLauncherSession$DelegatingLauncher.execute(DefaultLauncherSession.java:86)\r\n\tat org.junit.platform.launcher.core.SessionPerRequestLauncher.execute(SessionPerRequestLauncher.java:53)\r\n\tat com.intellij.junit5.JUnit5IdeaTestRunner.startRunnerWithArgs(JUnit5IdeaTestRunner.java:57)\r\n\tat com.intellij.rt.junit.IdeaTestRunner$Repeater$1.execute(IdeaTestRunner.java:38)\r\n\tat com.intellij.rt.execution.junit.TestsRepeater.repeat(TestsRepeater.java:11)\r\n\tat com.intellij.rt.junit.IdeaTestRunner$Repeater.startRunnerWithArgs(IdeaTestRunner.java:35)\r\n\tat com.intellij.rt.junit.JUnitStarter.prepareStreamsAndStart(JUnitStarter.java:232)\r\n\tat com.intellij.rt.junit.JUnitStarter.main(JUnitStarter.java:55)\r\nCaused by: io.grpc.StatusRuntimeException: INVALID_ARGUMENT: java.lang.IllegalStateException: Premature end of stream, expectedLastEventID=3 but no more events after eventID=0\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.verifyAllEventsProcessed(ReplayWorkflowRunTaskHandler.java:284)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.applyServerHistory(ReplayWorkflowRunTaskHandler.java:269)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:231)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleDirectQueryWorkflowTask(ReplayWorkflowRunTaskHandler.java:204)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithQuery(ReplayWorkflowTaskHandler.java:127)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:98)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handleTask(WorkflowWorker.java:413)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:320)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:261)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:105)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\r\n\tat java.base/java.lang.Thread.run(Thread.java:833)\r\n```\r\n\r\nOf course, downgrading to 1.22.2 fixes the issue as well.  ","closedAt":"2023-11-09T16:47:22Z","comments":[{"id":"IC_kwDODN12PM5rh80t","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Hm I am not able to reproduce your issue. I translated your reproduction into something I can run locally, but my test ran fine on `1.22.3`.\r\n\r\n```\r\npublic class WaitingWorkflowQueryTest {\r\n  @Rule\r\n  public SDKTestWorkflowRule testWorkflowRule =\r\n      SDKTestWorkflowRule.newBuilder()\r\n          .setWorkflowTypes(TestLocalActivityAndQueryWorkflow.class)\r\n          .build();\r\n\r\n  @Test\r\n  public void query() throws ExecutionException, InterruptedException {\r\n    WorkflowOptions options =\r\n        WorkflowOptions.newBuilder().setTaskQueue(testWorkflowRule.getTaskQueue()).build();\r\n    TestWorkflows.TestWorkflowWithQuery workflowStub =\r\n        testWorkflowRule\r\n            .getWorkflowClient()\r\n            .newWorkflowStub(TestWorkflows.TestWorkflowWithQuery.class, options);\r\n    WorkflowClient.start(workflowStub::execute);\r\n\r\n    testWorkflowRule.sleep(Duration.ofHours(1));\r\n    assertEquals(\"started\", workflowStub.query());\r\n  }\r\n\r\n  public static final class TestLocalActivityAndQueryWorkflow\r\n      implements TestWorkflows.TestWorkflowWithQuery {\r\n\r\n    private String queryResult = \"\";\r\n\r\n    @Override\r\n    public String execute() {\r\n      queryResult = \"started\";\r\n      Workflow.await(() -> false);\r\n      return \"done\";\r\n    }\r\n\r\n    @Override\r\n    public String query() {\r\n      return queryResult;\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe only way I could replicate your behaviour was to also use an old version of the `temporal-test-server`, which is not supported. Can you confirm your all your temporal dependencies are up to date?","createdAt":"2023-11-09T15:36:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1931#issuecomment-1804061997","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5riBG1","author":{"login":"karneyli"},"authorAssociation":"NONE","body":"Try using an untypedWorkflowStub, when I use newWorkflowStub it works.  \r\n\r\nIf you can't reproduce, I can create a small app.  Yes my dependencies are upto date. ","createdAt":"2023-11-09T15:45:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1931#issuecomment-1804079541","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5riHmV","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Using `untypedWorkflowStub` makes no difference, the test still runs fine ","createdAt":"2023-11-09T16:00:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1931#issuecomment-1804106133","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5ribpN","author":{"login":"karneyli"},"authorAssociation":"NONE","body":"Apologies. It looks like this is indeed due to an old version of the `temporal-test-server`, it was picking up `1.22.2`, forcing it to resolve to `1.22.3` resolves the issue.  ","createdAt":"2023-11-09T16:47:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/1931#issuecomment-1804188237","viewerDidAuthor":false}],"createdAt":"2023-11-09T14:13:29Z","labels":[],"milestone":null,"number":1931,"reactionGroups":[],"state":"CLOSED","title":"sdk-java 1.22.3 breaks queries after testEnv.sleep","updatedAt":"2023-11-09T16:47:22Z","url":"https://github.com/temporalio/sdk-java/issues/1931"}
