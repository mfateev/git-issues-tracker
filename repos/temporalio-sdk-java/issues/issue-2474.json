{"assignees":[],"author":{"id":"MDQ6VXNlcjY4NDQ0Mzc2","is_bot":false,"login":"bruto1","name":""},"body":"## Expected Behavior\nAll Meter binders, filters, customizers present in Spring context applied timely and correctly\n\n## Actual Behavior\nAfter updating Temporal libs from 1.22.3 to 1.28.4 NonRootBeanPostProcessor, via Scope in MetricsScopeAutoConfiguration, caused MeterRegistry to be instantiated before MeterRegistryPostProcessor is added to bean factory's postprocessors and thus a lot of code relying on meter binders (like JvmMetricsAutoConfiguration) or Micrometer's globalRegistry containing all meter registries (which are added to it by said MeterRegistryPostProcessor) is unable to create Meters.\n\nThis happens because NonRootBeanPostProcessor is instantiated in the same loop as MeterRegistryPostProcessor and they're only added to bean factory later\n\nSpring detects such situations and writes the following log message to make the user aware of them:\n```\nWARN 27112 --- [           main] trationDelegate$BeanPostProcessorChecker : Bean 'prometheusMeterRegistry' of type [io.micrometer.prometheusmetrics.PrometheusMeterRegistry] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying). Is this bean getting eagerly injected/applied to a currently created BeanPostProcessor [nonRootBeanPostProcessor]? Check the corresponding BeanPostProcessor declaration and its dependencies/advisors. If this bean does not have to be post-processed, declare it with ROLE_INFRASTRUCTURE.  \n```\n\nSo one or both dependencies (NonRootBeanPostProcessor on scope and scope on MeterRegistry) need to be made lazy\n\n## Steps to Reproduce the Problem\nYou can take the repro case from here: https://github.com/spring-projects/spring-boot/issues/22926#issuecomment-673530300 - it's the same problem that occurred with a different set of libraries\n\n## Specifications\n\n  - Version: 1.28.4\n  - Platform: all\n","closedAt":"2025-06-17T16:32:43Z","comments":[{"id":"IC_kwDODN12PM6mg10g","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Hi, can you please included a self contained minimal reproduction with the Temporal SDK. The linked issue does not use the Temporal SDK, thank you.","createdAt":"2025-04-10T14:18:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2474#issuecomment-2793626912","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6nUFCE","author":{"login":"ajgassner"},"authorAssociation":"NONE","body":"Could be caused by https://github.com/spring-projects/spring-boot/pull/45202","createdAt":"2025-04-15T18:05:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2474#issuecomment-2807058564","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6q3H9X","author":{"login":"kurtinaitis"},"authorAssociation":"NONE","body":"Working correctly with version 1.24.2","createdAt":"2025-05-09T13:35:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2474#issuecomment-2866577239","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6rKxTs","author":{"login":"bruto1"},"authorAssociation":"NONE","body":"@kurtinaitis that's because the class causing this problem was added in 1.28.0: https://github.com/temporalio/sdk-java/releases/tag/v1.28.0\nhttps://github.com/temporalio/sdk-java/commit/c6375d676ca1a494bb693b21f3fb268b72a142c9#diff-9114a5eefb4b2ce6e22451e2650bbf67168630cdf3bc2bf0689fbccda393fed6\n","createdAt":"2025-05-12T09:19:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2474#issuecomment-2871727340","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6sx0uo","author":{"login":"ragutsky"},"authorAssociation":"NONE","body":"Metrics exposed by Micrometer disappeared when I updated to 1.28.0 version.\n\nI got the following message during bootstrap:\n\n```\nBean 'io.temporal.spring.boot.autoconfigure.NonRootNamespaceAutoConfiguration' of type [io.temporal.spring.boot.autoconfigure.NonRootNamespaceAutoConfiguration$$SpringCGLIB$$0] is not eligible for getting processed by all BeanPostProcessors (for example: not eligible for auto-proxying). The currently created BeanPostProcessor [nonRootBeanPostProcessor] is declared through a non-static factory method on that class; consider declaring it as static instead.\n```\n\nSpring expects BeanPostProcessor beans to be registered very early in the context lifecycle. Defining one via a non-static method forces early instantiation of the configuration class, which can cause:\n- The configuration class itself and its beans to miss being proxied\n- Other post-processors to be applied too late\n\nTemporary workaround worked:\n1. Added \n```yaml\nspring:\n  autoconfigure:\n    exclude: io.temporal.spring.boot.autoconfigure.NonRootNamespaceAutoConfiguration\n```\n2. Copy pasted `NonRootNamespaceAutoConfiguration` and defined `NonRootBeanPostProcessor` via a static method:\n```java\n@Bean\npublic static NonRootBeanPostProcessor nonRootBeanPostProcessor(...) {\n  ...\n}\n```","createdAt":"2025-05-21T17:38:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/2474#issuecomment-2898742184","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6tQ-Sm","author":{"login":"seanb4t"},"authorAssociation":"NONE","body":"Definitely buggy - needs to be resolved.","createdAt":"2025-05-24T16:08:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2474#issuecomment-2906907814","viewerDidAuthor":false}],"createdAt":"2025-04-09T08:44:30Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQ4","name":"question","description":"Further information is requested","color":"BFD4F2"}],"milestone":null,"number":2474,"reactionGroups":[],"state":"CLOSED","title":"NonRootBeanPostProcessor eagerly depends on MeterRegistry which can have undesirable side effects","updatedAt":"2025-06-17T16:32:43Z","url":"https://github.com/temporalio/sdk-java/issues/2474"}
