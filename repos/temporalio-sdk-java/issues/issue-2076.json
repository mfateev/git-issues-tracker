{"assignees":[],"author":{"id":"MDQ6VXNlcjI0NjUzMDAy","is_bot":false,"login":"rorueda","name":""},"body":"## Expected Behavior\r\nQuerying a workflow doesn't generate additional logs.\r\n\r\n## Actual Behavior\r\nQuerying a workflow generates additional logs.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nI added an additional test to `DirectQueryReplaysDontSpamLogWithWorkflowExecutionExceptionsTest.java` to reproduce the issue. \r\n\r\n```java\r\n@Rule\r\npublic SDKTestWorkflowRule testWorkflowRule =\r\n    SDKTestWorkflowRule.newBuilder()\r\n        .setWorkflowTypes(TestWorkflowNonRetryableFlag.class, LogAndKeepRunningWorkflow.class)\r\n        .setActivityImplementations(new TestActivities.TestActivitiesImpl())\r\n        .build();\r\n\r\n@Test\r\npublic void queriedWorkflowFailureDoesntProduceAdditionalLogsWhenWorkflowIsNotCompleted()\r\n    throws InterruptedException {\r\n  TestWorkflows.QueryableWorkflow workflow =\r\n      testWorkflowRule.newWorkflowStub(TestWorkflows.QueryableWorkflow.class);\r\n\r\n  WorkflowExecution execution = WorkflowClient.start(workflow::execute);\r\n  Thread.sleep(500);\r\n  assertEquals(\r\n      \"Workflow execution exception should be logged\",\r\n      1,\r\n      workflowExecuteRunnableLoggerAppender.list.size());\r\n\r\n  TestWorkflows.QueryableWorkflow queryStub =\r\n      testWorkflowRule\r\n          .getWorkflowClient()\r\n          .newWorkflowStub(TestWorkflows.QueryableWorkflow.class, execution.getWorkflowId());\r\n  assertEquals(\"my-state\", queryStub.getState());\r\n  assertEquals(\"There was only one execution.\", 1, workflowCodeExecutionCount.get());\r\n  assertEquals(\r\n      \"Only the original exception should be logged.\",\r\n      1,\r\n      workflowExecuteRunnableLoggerAppender.list.size());\r\n\r\n  testWorkflowRule.invalidateWorkflowCache();\r\n  assertEquals(\"my-state\", queryStub.getState());\r\n  assertEquals(\r\n      \"There was two executions - one original and one full replay for query.\",\r\n      2,\r\n      workflowCodeExecutionCount.get());\r\n  assertEquals(\r\n      \"Only the original exception should be logged.\",\r\n      1,\r\n      workflowExecuteRunnableLoggerAppender.list.size());\r\n\r\n  queryStub.mySignal(\"exit\");\r\n  assertEquals(\"my-state\", queryStub.getState());\r\n  assertEquals(\r\n      \"There was three executions - one original and two full replays for query.\",\r\n      3,\r\n      workflowCodeExecutionCount.get());\r\n  assertEquals(\r\n      \"Only the original exception should be logged.\",\r\n      1,\r\n      workflowExecuteRunnableLoggerAppender.list.size());\r\n}\r\n\r\npublic static class LogAndKeepRunningWorkflow implements TestWorkflows.QueryableWorkflow {\r\n  private final org.slf4j.Logger logger;\r\n  private final TestActivities.VariousTestActivities activities;\r\n  private boolean exit;\r\n\r\n  public LogAndKeepRunningWorkflow() {\r\n    activities =\r\n        Workflow.newActivityStub(\r\n            TestActivities.VariousTestActivities.class,\r\n            ActivityOptions.newBuilder()\r\n                .setStartToCloseTimeout(Duration.ofSeconds(10))\r\n                .setRetryOptions(RetryOptions.newBuilder().setMaximumAttempts(1).build())\r\n                .build());\r\n    logger = Workflow.getLogger(\"io.temporal.internal.sync.WorkflowExecutionHandler\");\r\n  }\r\n\r\n  @Override\r\n  public String execute() {\r\n    workflowCodeExecutionCount.incrementAndGet();\r\n    while (true) {\r\n      try {\r\n        activities.throwIO();\r\n      } catch (ActivityFailure e) {\r\n        logger.error(\"Unexpected error on activity\", e);\r\n        Workflow.await(() -> exit);\r\n        if (exit) {\r\n          return \"exit\";\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  @Override\r\n  public String getState() {\r\n    return \"my-state\";\r\n  }\r\n\r\n  @Override\r\n  public void mySignal(String value) {\r\n    exit = true;\r\n  }\r\n}\r\n```\r\n\r\nI found that the logs are generated because replaying is being set to false here:\r\nhttps://github.com/temporalio/sdk-java/blob/5e5cf0bf2db695cba46d1855959e02b4cdfa3cff/temporal-sdk/src/main/java/io/temporal/internal/statemachines/WorkflowStateMachines.java#L456-L462\r\n\r\nI saw that there were changes to those lines recently, but I've tested with 1.23.1, 1.23.2 and master and the issue is present in all of them. I first noticed the issue in production when upgrading from 1.19.1 to 1.23.1.\r\n\r\n\r\n## Specifications\r\n\r\n  - Version: 1.23.1 / 1.23.2 / master\r\n  - Platform: Ubuntu 22\r\n","closedAt":"2024-05-31T17:01:11Z","comments":[{"id":"IC_kwDODN12PM5-8gdX","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"This  is already fixed by https://github.com/temporalio/sdk-java/commit/a41c64ece3876f584ebde70903668b817c5455d8 and will be included in the next SDK release","createdAt":"2024-05-24T15:13:22Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2076#issuecomment-2129790807","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5-9gi6","author":{"login":"rorueda"},"authorAssociation":"NONE","body":"I can't rule out my test being wrong, but I have just tested on top of the current last commit https://github.com/temporalio/sdk-java/commit/5e5cf0bf2db695cba46d1855959e02b4cdfa3cff and it still fails. Any idea why?","createdAt":"2024-05-24T17:31:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2076#issuecomment-2130053306","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5-_LBK","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"hm let me try to get your test running on my machine","createdAt":"2024-05-24T22:59:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2076#issuecomment-2130489418","viewerDidAuthor":false}],"createdAt":"2024-05-24T14:17:08Z","labels":[],"milestone":null,"number":2076,"reactionGroups":[],"state":"CLOSED","title":"Querying a running workflow makes it spam previously logged messages","updatedAt":"2024-05-31T17:01:11Z","url":"https://github.com/temporalio/sdk-java/issues/2076"}
