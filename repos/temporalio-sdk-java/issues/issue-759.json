{"assignees":[],"author":{"id":"MDQ6VXNlcjEzODg1MjE=","is_bot":false,"login":"HaakonRav","name":"Haakon Wilhelm Ravik"},"body":"My impression is that this metric should reflect the number of workflows completed for a specific combination of `namespace`, `task_queue` and `workflow_type` tags. If this assumption is incorrect, please describe what this metric reflects and disregard this report.\r\n\r\n## Expected Behavior\r\nQuerying a completed workflow should not affect the `temporal_workflow_completed_total` metric counter for a `workflow_type`.\r\n\r\n## Actual Behavior\r\nQuerying a completed workflow increments the `temporal_workflow_completed_total` for the relevant `workflow_type` by 1 per Query request.\r\n\r\n## Steps to Reproduce the Problem\r\nWorker setup:\r\n```java\r\nMicrometerClientStatsReporter reporter = new MicrometerClientStatsReporter(\r\n        new PrometheusMeterRegistry(\r\n                PrometheusConfig.DEFAULT,\r\n                CollectorRegistry.defaultRegistry,\r\n                Clock.SYSTEM\r\n        )\r\n);\r\n\r\nScope metricScope = new RootScopeBuilder()\r\n        .reporter(reporter)\r\n        .reportEvery(Duration.ofSeconds(10));\r\n\r\nHTTPServer metricsServer = new HTTPServer(9090);\r\n\r\nWorkflowServiceStubs service = WorkflowServiceStubs.newInstance(\r\n        WorkflowServiceStubsOptions.newBuilder()\r\n                .setMetricsScope(metricScope)\r\n                .build()\r\n);\r\n```\r\n1. Start a workflow, let it complete.\r\n2. Verify that the `temporal_workflow_completed_total` metric counter for that workflow is now 1.\r\n3. Perform one or more queries for the completed workflow (via tctl / sdk).\r\n4. The `temporal_workflow_completed_total` metric should now have increased beyond 1, without any new workflows completed.\r\n\r\n## Specifications\r\n\r\n  - micrometer-registry-prometheus version: 1.6.4\r\n  - Prometheus simpleclient version: 0.12.0\r\n  - SDK Version: 1.3.1\r\n  - Platform: macOS / Java 15\r\n","closedAt":"2021-10-05T05:16:59Z","comments":[],"createdAt":"2021-09-23T13:49:37Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":4,"title":"1.4.0","description":"","dueOn":"2021-10-06T00:00:00Z"},"number":759,"reactionGroups":[],"state":"CLOSED","title":"Querying a completed workflow increments \"temporal_workflow_completed_total\" metrics counter","updatedAt":"2021-10-05T05:17:19Z","url":"https://github.com/temporalio/sdk-java/issues/759"}
