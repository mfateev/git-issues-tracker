{"assignees":[],"author":{"id":"U_kgDOCOrFcg","is_bot":false,"login":"brunomascijp","name":""},"body":"## Expected Behavior\r\n**Workflow executions should make progress, retrying, failing or successfully completing steps.**\r\n\r\n## Actual Behavior\r\n**I have some executions that got stuck for hours after the following exception, and the state was _Running_ on all of them.\r\nWe restarted all the workers and the orchestrator seemed to be working good.**\r\n\r\n\r\n`[Workflow Executor taskQueue=\"prod\", namespace=\"ns\": 77] [] i.temporal.internal.worker.PollerOptions: uncaught exception\r\njava.lang.RuntimeException: Failure processing workflow task. WorkflowId=5b38, RunId=5c9cbad8-8a64-4a84-81bd-64d02474a560, Attempt=473\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.wrapFailure(WorkflowWorker.java:327)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.wrapFailure(WorkflowWorker.java:188)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:98)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\r\n\tat java.base/java.lang.Thread.run(Thread.java:833)\r\nCaused by: io.temporal.internal.statemachines.InternalWorkflowTaskException: Failure handling event 28 of type 'EVENT_TYPE_WORKFLOW_TASK_STARTED' during execution. {WorkflowTaskStartedEventId=28, CurrentStartedEventId=28}\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.createEventProcessingException(WorkflowStateMachines.java:257)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEventsBatch(WorkflowStateMachines.java:236)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:208)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.applyServerHistory(ReplayWorkflowRunTaskHandler.java:208)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:192)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:147)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithQuery(ReplayWorkflowTaskHandler.java:132)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:97)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handleTask(WorkflowWorker.java:336)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:246)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:188)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:93)\r\n\t... 3 common frames omitted\r\nCaused by: java.lang.RuntimeException: WorkflowTask: failure executing SCHEDULED->WORKFLOW_TASK_STARTED, transition history is [CREATED->WORKFLOW_TASK_SCHEDULED]\r\n\tat io.temporal.internal.statemachines.StateMachine.executeTransition(StateMachine.java:152)\r\n\tat io.temporal.internal.statemachines.StateMachine.handleHistoryEvent(StateMachine.java:102)\r\n\tat io.temporal.internal.statemachines.EntityStateMachineBase.handleEvent(EntityStateMachineBase.java:68)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleSingleEvent(WorkflowStateMachines.java:277)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEventsBatch(WorkflowStateMachines.java:234)\r\n\t... 13 common frames omitted\r\nCaused by: java.lang.NullPointerException: stackTrace[15]\r\n\tat java.base/java.lang.Throwable.setStackTrace(Throwable.java:879)\r\n\tat io.temporal.failure.FailureConverter.failureToException(FailureConverter.java:85)\r\n\tat io.temporal.failure.FailureConverter.failureToExceptionImpl(FailureConverter.java:93)\r\n\tat io.temporal.failure.FailureConverter.failureToException(FailureConverter.java:79)\r\n\tat io.temporal.failure.FailureConverter.failureToExceptionImpl(FailureConverter.java:93)\r\n\tat io.temporal.failure.FailureConverter.failureToException(FailureConverter.java:79)\r\n\tat io.temporal.failure.FailureConverter.failureToExceptionImpl(FailureConverter.java:93)\r\n\tat io.temporal.failure.FailureConverter.failureToException(FailureConverter.java:79)\r\n\tat io.temporal.failure.FailureConverter.failureToExceptionImpl(FailureConverter.java:93)\r\n\tat io.temporal.failure.FailureConverter.failureToException(FailureConverter.java:79)\r\n\tat io.temporal.internal.sync.SyncWorkflowContext$ActivityCallback.lambda$invoke$0(SyncWorkflowContext.java:292)\r\n\tat io.temporal.internal.sync.CancellationScopeImpl.run(CancellationScopeImpl.java:102)\r\n\tat io.temporal.internal.sync.WorkflowThreadImpl$RunnableWrapper.run(WorkflowThreadImpl.java:106)\r\n\tat io.temporal.worker.ActiveThreadReportingExecutor.lambda$submit$0(ActiveThreadReportingExecutor.java:53)\r\n\tat java.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:539)\r\n\tat java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)\r\n\t... 3 common frames omitted `\r\n\r\n\r\n\r\n**Particularly, all stuck executions are on _WorkflowTaskFailed_ state and, after a few hours waiting, we decided to terminate them:**\r\n\r\n\r\n`{\r\n  \"message\": \"Failure handling event 25 of type 'EVENT_TYPE_WORKFLOW_TASK_STARTED' during execution. {WorkflowTaskStartedEventId=25, CurrentStartedEventId=25}\",\r\n  \"source\": \"JavaSDK\",\r\n  \"stackTrace\": \"io.temporal.internal.statemachines.WorkflowStateMachines.createEventProcessingException(WorkflowStateMachines.java:257)\\nio.temporal.internal.statemachines.WorkflowStateMachines.handleEventsBatch(WorkflowStateMachines.java:236)\\nio.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:208)\\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.applyServerHistory(ReplayWorkflowRunTaskHandler.java:208)\\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:192)\\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:147)\\nio.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithQuery(ReplayWorkflowTaskHandler.java:132)\\nio.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:97)\\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handleTask(WorkflowWorker.java:336)\\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:246)\\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:188)\\nio.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:93)\\njava.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\\njava.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\\njava.base/java.lang.Thread.run(Thread.java:833)\\n\",\r\n  \"cause\": {\r\n    \"message\": \"WorkflowTask: failure executing SCHEDULED->WORKFLOW_TASK_STARTED, transition history is [CREATED->WORKFLOW_TASK_SCHEDULED]\",\r\n    \"source\": \"JavaSDK\",\r\n    \"stackTrace\": \"io.temporal.internal.statemachines.StateMachine.executeTransition(StateMachine.java:152)\\nio.temporal.internal.statemachines.StateMachine.handleHistoryEvent(StateMachine.java:102)\\nio.temporal.internal.statemachines.EntityStateMachineBase.handleEvent(EntityStateMachineBase.java:68)\\nio.temporal.internal.statemachines.WorkflowStateMachines.handleSingleEvent(WorkflowStateMachines.java:277)\\nio.temporal.internal.statemachines.WorkflowStateMachines.handleEventsBatch(WorkflowStateMachines.java:234)\\nio.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:208)\\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.applyServerHistory(ReplayWorkflowRunTaskHandler.java:208)\\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:192)\\nio.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:147)\\nio.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithQuery(ReplayWorkflowTaskHandler.java:132)\\nio.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:97)\\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handleTask(WorkflowWorker.java:336)\\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:246)\\nio.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:188)\\nio.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:93)\\njava.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\\njava.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\\njava.base/java.lang.Thread.run(Thread.java:833)\\n\",\r\n    \"cause\": {\r\n      \"message\": \"stackTrace[15]\",\r\n      \"source\": \"JavaSDK\",\r\n      \"stackTrace\": \"java.base/java.lang.Throwable.setStackTrace(Throwable.java:879)\\nio.temporal.failure.FailureConverter.failureToException(FailureConverter.java:85)\\nio.temporal.failure.FailureConverter.failureToExceptionImpl(FailureConverter.java:93)\\nio.temporal.failure.FailureConverter.failureToException(FailureConverter.java:79)\\nio.temporal.failure.FailureConverter.failureToExceptionImpl(FailureConverter.java:93)\\nio.temporal.failure.FailureConverter.failureToException(FailureConverter.java:79)\\nio.temporal.failure.FailureConverter.failureToExceptionImpl(FailureConverter.java:93)\\nio.temporal.failure.FailureConverter.failureToException(FailureConverter.java:79)\\nio.temporal.failure.FailureConverter.failureToExceptionImpl(FailureConverter.java:93)\\nio.temporal.failure.FailureConverter.failureToException(FailureConverter.java:79)\\nio.temporal.internal.sync.SyncWorkflowContext$ActivityCallback.lambda$invoke$0(SyncWorkflowContext.java:292)\\nio.temporal.internal.sync.CancellationScopeImpl.run(CancellationScopeImpl.java:102)\\nio.temporal.internal.sync.WorkflowThreadImpl$RunnableWrapper.run(WorkflowThreadImpl.java:106)\\nio.temporal.worker.ActiveThreadReportingExecutor.lambda$submit$0(ActiveThreadReportingExecutor.java:53)\\njava.base/java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:539)\\njava.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)\\njava.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\\njava.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\\njava.base/java.lang.Thread.run(Thread.java:833)\\n\",\r\n      \"cause\": null,\r\n      \"applicationFailureInfo\": {\r\n        \"type\": \"java.lang.NullPointerException\",\r\n        \"nonRetryable\": false,\r\n        \"details\": null\r\n      }\r\n    },\r\n    \"applicationFailureInfo\": {\r\n      \"type\": \"java.lang.RuntimeException\",\r\n      \"nonRetryable\": false,\r\n      \"details\": null\r\n    }\r\n  },\r\n  \"applicationFailureInfo\": {\r\n    \"type\": \"io.temporal.internal.statemachines.InternalWorkflowTaskException\",\r\n    \"nonRetryable\": false,\r\n    \"details\": null\r\n  }\r\n}`\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nNot enough information\r\n\r\n## Specifications\r\n\r\n  - SDK Version: 1.17.0\r\n  - Temporal Server Version: 1.22.0\r\n  - Platform: k8s\r\n","closedAt":"2023-11-29T14:56:46Z","comments":[{"id":"IC_kwDODN12PM5qppm-","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"You're running on an older SDK version. I believe this issue was fixed in this PR https://github.com/temporalio/sdk-java/pull/1795. Can you please upgrade to the latest Java SDK release `v1.22.0`","createdAt":"2023-11-01T16:49:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1921#issuecomment-1789303230","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5qpsVb","author":{"login":"brunomascijp"},"authorAssociation":"NONE","body":"Will try, thanks!","createdAt":"2023-11-01T16:57:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1921#issuecomment-1789314395","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5tMvBX","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Closing since this is not an SDK issue, feel free to ask general questions on our [forum](https://community.temporal.io/) or [community slack ](https://app.slack.com/client/TNWA8QCGZ/CNWA8QH09)","createdAt":"2023-11-29T14:56:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/1921#issuecomment-1832054871","viewerDidAuthor":false}],"createdAt":"2023-11-01T15:57:25Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQ4","name":"question","description":"Further information is requested","color":"BFD4F2"}],"milestone":null,"number":1921,"reactionGroups":[],"state":"CLOSED","title":"Workflow executions frozen after Temporal exception","updatedAt":"2023-11-29T14:56:47Z","url":"https://github.com/temporalio/sdk-java/issues/1921"}
