{"assignees":[],"author":{"id":"U_kgDOCi0gkg","is_bot":false,"login":"mikita-charnukhin","name":""},"body":"## Issue description\r\nI am trying to configure a retry policy for a scheduled workflow. By scheduled workflow I mean this feature: [Features - Java SDK feature guide | Temporal Documentation 1](https://docs.temporal.io/dev-guide/java/features#schedule-a-workflow) . Unfortunately it seems not working for me. I am expecting that when I add a `RetryOptions` object to the `Schedule` ‚Üí `ScheduleActionStartWorkflow` ‚Üí `WorkflowOptions` then retries will be working according to the provided configuration. I haven‚Äôt seen any notes about additional actions which might be required to enable retries for scheduled workflow executions. But maybe I am missing something..\r\n\r\n## Notes\r\n\r\n1. I am using Temporal v1.23.1.\r\n2. Activity retries are working as expected for scheduled workflows.\r\n3. When I fail the activity by throwing a `RuntimeException` then after activity retries exhausted the scheduled workflow execution fails without expected retries (following any configured retry policy).\r\n4. I noticed that a retry policy which I set for a scheduled workflow is not visible for a workflow in the Temporal UI as usual (in Workflows ‚Üí choose Workflow ‚Üí Event History ‚Üí WorkflowExecutionStarted event ‚Üí Retry Policy).\r\n5. The same `RetryOptions` works as expected if I use them to trigger a single workflow execution (without a schedule).\r\nExample of a single workflow execution which I meant:\r\n`workflowClient.newWorkflowStub(SomeWorkflow.class, workflowOptions).runSomeWorkflow(someInput);`\r\n6. If I throw a RuntimeException not on the activity level but in the workflow implementation code then a scheduled workflow retries with a some weird retry policy (not following the rules which I set). For example: backoffCoefficient = 1.9; initialInterval = 5m; maxAttempts = 0; maxInterval = 3h. So I am expecting the following retry sequence: 5m ‚Üí 9.5m ‚Üí 18.05m ‚Üí 34.295m ‚Üí 65.1605 ‚Üí ‚Ä¶ ‚Üí 180m . But the actual retry sequence is: 0.037s ‚Üí 0.058s ‚Üí 10s ‚Üí 10s ‚Üí 14s ‚Üí 20s ‚Üí 27s ‚Üí 47s ‚Üí 78s.\r\n\r\n## Code example\r\n```\r\n    final var retryOptions = RetryOptions.newBuilder()\r\n        .setMaximumAttempts(0)\r\n        .setInitialInterval(Duration.ofMinutes(5))\r\n        .setBackoffCoefficient(1.9)\r\n        .setMaximumInterval(Duration.ofHours(3))\r\n        .build();\r\n    final var workflowOptions = WorkflowOptions.newBuilder()\r\n        .setRetryOptions(retryOptions)\r\n        .setWorkflowId(workflowIdGenerator.getScheduledWorkflowId(scheduleId))\r\n        .setTaskQueue(TASK_QUEUE_NAME)\r\n        .build();\r\n    final var scheduleAction = ScheduleActionStartWorkflow.newBuilder()\r\n            .setWorkflowType(SomeWorkflow.class)\r\n            .setArguments(input)\r\n            .setOptions(workflowOptions)\r\n            .build();\r\n    final var schedulePolicy = SchedulePolicy.newBuilder().build();\r\n    final var scheduleSpec = ScheduleSpec.newBuilder()\r\n        .setTimeZoneName(timezone)\r\n        .setCronExpressions(cronSchedule)\r\n        .build();\r\n    final var schedule = Schedule.newBuilder()\r\n        .setAction(scheduleAction)\r\n        .setPolicy(schedulePolicy)\r\n        .setSpec(scheduleSpec)\r\n        .build();\r\n    final var scheduleOptions = ScheduleOptions.newBuilder().build();\r\n    scheduleClient.createSchedule(scheduleId, schedule, scheduleOptions);\r\n```\r\n\r\nIs there any issue with scheduled workflows which breaks the retry mechanism?\r\nOr maybe you can see an obvious mistake in my configuration..\r\n\r\nThank you in advance!","closedAt":"2024-06-26T16:46:11Z","comments":[{"id":"IC_kwDODN12PM6AddNz","author":{"login":"glebremniov"},"authorAssociation":"NONE","body":"Yeah, upvoting this üëçüèª ","createdAt":"2024-05-24T14:12:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2100#issuecomment-2155205491","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6AddN5","author":{"login":"aminmansour"},"authorAssociation":"NONE","body":"Seems like a basic enough feature to have for schedules","createdAt":"2024-05-24T14:24:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2100#issuecomment-2155205497","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6AddN9","author":{"login":"alexpetroaica"},"authorAssociation":"NONE","body":"Also facing this, even the most basic example seems to completely ignore the retryOptions set on a workflow when it is part of a schedule","createdAt":"2024-05-24T15:21:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2100#issuecomment-2155205501","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6AddN_","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"I tried reproducing this with a schedule client in the Go SDK and retries worked correctly. There might be an issue with Java SDK.","createdAt":"2024-06-07T16:55:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2100#issuecomment-2155205503","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6B2W6A","author":{"login":"mikita-charnukhin"},"authorAssociation":"NONE","body":"Hi @dnr \r\nYes, as I mentioned in the issue description above the retries issue exists in Java SDK.\r\nIf you go to ScheduleClientImpl.createSchedule(...) -> ScheduleClientCallsInterceptor.createSchedule(...) -> RootScheduleClientInvoker.createSchedule(...) -> ScheduleProtoUtil.scheduleToProto(...) -> ScheduleProtoUtil.actionToProto(...) then you‚Äôll see that RetryOptions object is ignored when doing mapping of ScheduleAction object from the ‚Äútemporal-sdk-java‚Äù module to the ScheduleAction object from the ‚Äútemporal-serviceclient‚Äù module.\r\nDuring that mapping ScheduleAction.action_.retryPolicy_ stays null (action_ is of type NewWorkflowExecutionInfo).\r\nRetryOptions object which we pass to the Temporal client is being ignored. ","createdAt":"2024-06-19T11:55:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2100#issuecomment-2178510464","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6Cqh_S","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Resolved with https://github.com/temporalio/sdk-java/pull/2082 which is included in Java SDK `v1.24.0`","createdAt":"2024-06-26T16:46:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/2100#issuecomment-2192187346","viewerDidAuthor":false}],"createdAt":"2024-05-24T14:00:13Z","labels":[],"milestone":null,"number":2100,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":8}},{"content":"HEART","users":{"totalCount":1}},{"content":"ROCKET","users":{"totalCount":5}}],"state":"CLOSED","title":"Scheduled workflow retries do not work","updatedAt":"2024-06-26T16:46:12Z","url":"https://github.com/temporalio/sdk-java/issues/2100"}
