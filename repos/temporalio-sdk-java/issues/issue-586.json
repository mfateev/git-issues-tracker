{"assignees":[],"author":{"id":"MDQ6VXNlcjM1MTU0NTA5","is_bot":false,"login":"adriil","name":"Adrien LESUR"},"body":"## Expected Behavior\r\n\r\nFrom a working Spring Boot application that successfully registers Activities implementation with `io.temporal.worker.Worker.registerActivitiesImplementations`, when I add an `@Aspect` component to advise my Activities method, application should still start successfully.\r\n\r\n## Actual Behavior\r\n\r\nApplication startup fails with the following log : `Class doesn't implement any non empty interface annotated with @ActivityInterface: com.example.test.InitialActivityImpl$$EnhancerBySpringCGLIB$$10ca071e`\r\n```\r\n{\r\n\t\"@timestamp\": \"2021-07-12T18:54:43.736671+02:00\",\r\n\t\"application\": \"Test as a Service\",\r\n\t\"class\": \"org.springframework.beans.factory.support.ConstructorResolver\",\r\n\t\"correlation_id\": \"e6888554-0c11-485c-842b-7c010a0709bb\",\r\n\t\"data_version\": 2,\r\n\t\"description\": \"Application run failed\",\r\n\t\"environment\": \"dev\",\r\n\t\"exception_obj\": {\r\n\t\t\"cause\": \"Failed to instantiate [com.example.mos.configuration.SourceWorkerConfiguration$$EnhancerBySpringCGLIB$$bdd1899]: Constructor threw exception; nested exception is java.lang.IllegalArgumentException: Class doesn't implement any non empty interface annotated with @ActivityInterface: com.example.test.InitialActivityImpl$$EnhancerBySpringCGLIB$$10ca071e\",\r\n\t\t\"message\": \"Error creating bean with name 'com.example.mos.configuration.SourceWorkerConfiguration': Bean instantiation via constructor failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [com.example.mos.configuration.SourceWorkerConfiguration$$EnhancerBySpringCGLIB$$bdd1899]: Constructor threw exception; nested exception is java.lang.IllegalArgumentException: Class doesn't implement any non empty interface annotated with @ActivityInterface: com.example.test.InitialActivityImpl$$EnhancerBySpringCGLIB$$10ca071e\",\r\n\t\t\"stacktrace\": \"org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'com.example.mos.configuration.SourceWorkerConfiguration': Bean instantiation via constructor failed; nested exception is org.springframework.beans.BeanInstantiationException: Failed to instantiate [com.example.mos.configuration.SourceWorkerConfiguration$$EnhancerBySpringCGLIB$$bdd1899]: Constructor threw exception; nested exception is java.lang.IllegalArgumentException: Class doesn't implement any non empty interface annotated with @ActivityInterface: com.example.test.InitialActivityImpl$$EnhancerBySpringCGLIB$$10ca071e\r\n\tat org.springframework.beans.factory.support.ConstructorResolver.instantiate(ConstructorResolver.java:313)\r\n\tat org.springframework.beans.factory.support.ConstructorResolver.autowireConstructor(ConstructorResolver.java:294)\r\n\tat org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.autowireConstructor(AbstractAutowireCapableBeanFactory.java:1356)\r\n\tat org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBeanInstance(AbstractAutowireCapableBeanFactory.java:1203)\r\n\tat org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:556)\r\n\tat org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:516)\r\n\tat org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:324)\r\n\tat org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:234)\r\n\tat org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:322)\r\n\tat org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:202)\r\n\tat org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:897)\r\n\tat org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:879)\r\n\tat org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:551)\r\n\tat org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext.refresh(ServletWebServerApplicationContext.java:141)\r\n\tat org.springframework.boot.SpringApplication.refresh(SpringApplication.java:744)\r\n\tat org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:391)\r\n\tat org.springframework.boot.SpringApplication.run(SpringApplication.java:312)\r\n\tat org.springframework.boot.SpringApplication.run(SpringApplication.java:1215)\r\n\tat org.springframework.boot.SpringApplication.run(SpringApplication.java:1204)\r\n\tat com.example.app.Application.main(Application.java:44)\r\nCaused by: org.springframework.beans.BeanInstantiationException: Failed to instantiate [com.example.mos.configuration.SourceWorkerConfiguration$$EnhancerBySpringCGLIB$$bdd1899]: Constructor threw exception; nested exception is java.lang.IllegalArgumentException: Class doesn't implement any non empty interface annotated with @ActivityInterface: com.example.test.InitialActivityImpl$$EnhancerBySpringCGLIB$$10ca071e\r\n\tat org.springframework.beans.BeanUtils.instantiateClass(BeanUtils.java:217)\r\n\tat org.springframework.beans.factory.support.SimpleInstantiationStrategy.instantiate(SimpleInstantiationStrategy.java:117)\r\n\tat org.springframework.beans.factory.support.ConstructorResolver.instantiate(ConstructorResolver.java:309)\r\n\t... 19 more\r\nCaused by: java.lang.IllegalArgumentException: Class doesn't implement any non empty interface annotated with @ActivityInterface: com.example.test.InitialActivityImpl$$EnhancerBySpringCGLIB$$10ca071e\r\n\tat io.temporal.common.metadata.POJOActivityImplMetadata.<init>(POJOActivityImplMetadata.java:109)\r\n\tat io.temporal.common.metadata.POJOActivityImplMetadata.newInstance(POJOActivityImplMetadata.java:53)\r\n\tat io.temporal.internal.sync.POJOActivityTaskHandler.registerActivityImplementation(POJOActivityTaskHandler.java:110)\r\n\tat io.temporal.internal.sync.POJOActivityTaskHandler.registerActivityImplementations(POJOActivityTaskHandler.java:179)\r\n\tat io.temporal.internal.sync.SyncActivityWorker.registerActivityImplementations(SyncActivityWorker.java:55)\r\n\tat io.temporal.worker.Worker.registerActivitiesImplementations(Worker.java:326)\r\n\tat com.example.mos.configuration.SourceWorkerConfiguration.<init>(SourceWorkerConfiguration.java:93)\r\n\tat com.example.mos.configuration.SourceWorkerConfiguration$$EnhancerBySpringCGLIB$$bdd1899.<init>(<generated>)\r\n\tat java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)\r\n\tat java.base/jdk.internal.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\r\n\tat java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:490)\r\n\tat org.springframework.beans.BeanUtils.instantiateClass(BeanUtils.java:204)\r\n\t... 21 more\r\n\",\r\n\t\t\"type\": \"org.springframework.beans.factory.BeanCreationException\"\r\n\t},\r\n\t\"level\": \"ERROR\",\r\n\t\"line\": 313,\r\n\t\"method\": \"instantiate\",\r\n\t\"number_of_events\": 1,\r\n\t\"request_id\": \"e6888554-0c11-485c-842b-7c010a0709bb\",\r\n\t\"roletype\": \"dev\",\r\n\t\"thread\": \"main\",\r\n\t\"type\": \"log\"\r\n}\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Considering an application that registers the following Activity implementation\r\n  ```java\r\n  @ActivityInterface(namePrefix = \"myactivity\")\r\n  public interface MyActivity {\r\n      void run(Object param);\r\n      void rollback(Object param);\r\n  }\r\n\r\n  @Slf4j\r\n  @Component\r\n  public class MyActivityImpl implements MyActivity {\r\n\r\n      @Override\r\n      public void run(Object param) {\r\n          log.info(\"Initiate Activity - Running the default run method\");\r\n      }\r\n\r\n      @Override\r\n      public void rollback(Object param) {\r\n        log.info(\"Initiate Activity - Running the default rollback method\");\r\n      }\r\n  }\r\n  ```\r\n  2. The implementation is registered like the following\r\n  ```java\r\n  worker.registerActivitiesImplementations(myActivityImpl);\r\n  ```\r\n  3. Add an `@Aspect` component to advise your Activity implementation methods\r\n  ```java\r\n@Slf4j\r\n@Aspect\r\n@Component\r\npublic class MyLoggerAspect {\r\n\r\n    /**\r\n     * Matches activities run/rollback methods.\r\n     *\r\n     * @param method Activity's run/rollback method\r\n     * @throws Throwable any exception Activity method might throw\r\n     */\r\n    @Around(\"execution(* com.example.test.*.*(java.lang.Object))\")\r\n    public void aroundActivityMethod(ProceedingJoinPoint method) throws Throwable {\r\n        log.info(\"Starting the Activity\");\r\n\r\n        // Run the activity method\r\n        method.proceed();\r\n       \r\n        log.info(\"Activity completed\")\r\n    }\r\n  ```\r\n  4. Start the application -> it fails\r\n  5. Comment the line with the `@Around` or put a different path that doesn't match the Activity implementation path and try again -> application startup successful\r\n\r\n## Specifications\r\n\r\n  - Version: \r\n    - SDK `1.0.4`,  `1.0.7` and `1.1.0`\r\n    - Sprint Boot `2.1.9`\r\n  - Platform: macOS Big Sur, OpenJDK 11\r\n","closedAt":"2021-07-15T11:12:13Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg4MDYwOTEzMg==","author":{"login":"adriil"},"authorAssociation":"NONE","body":"After some research I've found out that this is because of Spring AOP proxying the advised classes using CGLIB by default.\r\n\r\nBecause of this, the advised Activity implementation that `worker` receives is actually a proxy to the implementation but not the implementation itself (debug view below).\r\n```\r\n1 = {InitialActivityImpl$$EnhancerBySpringCGLIB$$cbcf576b@14778} \"com.[...].InitialActivityImpl@3ea9b180\"\r\n CGLIB$BOUND = false\r\n CGLIB$CALLBACK_0 = {CglibAopProxy$DynamicAdvisedInterceptor@14792} \r\n CGLIB$CALLBACK_1 = {CglibAopProxy$StaticUnadvisedInterceptor@14793} \r\n CGLIB$CALLBACK_2 = {CglibAopProxy$SerializableNoOp@14794} \r\n CGLIB$CALLBACK_3 = {CglibAopProxy$StaticDispatcher@14795} \r\n CGLIB$CALLBACK_4 = {CglibAopProxy$AdvisedDispatcher@14796} \r\n CGLIB$CALLBACK_5 = {CglibAopProxy$EqualsInterceptor@14797} \r\n CGLIB$CALLBACK_6 = {CglibAopProxy$HashCodeInterceptor@14798} \r\n migrationService = null\r\n```\r\n\r\nSo I needed to add the non-empty `@ActivityInterface` interface inside of the proxy, which could be achieved with the code below : \r\n* a custom `AnnotationAwareAspectJAutoProxyCreator` that adds the interface to the ProxyFactory\r\n```java\r\npublic class CompanyMigrationAspectProxyCreator extends AnnotationAwareAspectJAutoProxyCreator {\r\n\r\n    /**\r\n     * Map that gives the correct non-empty @ActivityInterface for each Activities.\r\n     */\r\n    private final Map<Class, Class> activityImplAndInterface;\r\n\r\n    @Autowired\r\n    public CompanyMigrationAspectProxyCreator(final InitiateActivity initiateActivityImpl) {\r\n        activityImplAndInterface = Map.of(initiateActivityImpl.getClass(), InitiateActivity.class);\r\n    }\r\n\r\n    /**\r\n     * Customizes AOP proxies of our Activities to add non-empty @ActivityInterface required by Temporal SDK.\r\n     *\r\n     * @param proxyFactory the proxy factory\r\n     */\r\n    @Override\r\n    protected void customizeProxyFactory(ProxyFactory proxyFactory) {\r\n        Class<?> activityInterface = activityImplAndInterface.get(proxyFactory.getTargetClass());\r\n\r\n        if (activityInterface != null) {\r\n            proxyFactory.addInterface(activityInterface);\r\n        }\r\n    }\r\n\r\n}\r\n```\r\n* a little hack taken from [there](https://github.com/spring-projects/spring-boot/issues/25367#issuecomment-781999430) that allows to inject my custom AnnotationAwareAspectJAutoProxyCreator instead of the regular one, when applicable\r\n```java\r\n    /**\r\n     * Injects our own AnnotationAwareAspectJAutoProxyCreator ({@link CompanyMigrationAspectProxyCreator})\r\n     * to answer Temporal requirements to have Activities proxies to proxy non-empty @ActivityInterface.\r\n     *\r\n     * @return bean factory post processor\r\n     */\r\n    @Bean\r\n    static BeanFactoryPostProcessor replaceDefaultAspectAutoProxyCreator() {\r\n        return (beanFactory) -> {\r\n            BeanDefinition definition = beanFactory.getBeanDefinition(AopConfigUtils.AUTO_PROXY_CREATOR_BEAN_NAME);\r\n            if (AnnotationAwareAspectJAutoProxyCreator.class.getName().equals(definition.getBeanClassName())) {\r\n                definition.setBeanClassName(CompanyMigrationAspectProxyCreator.class.getName());\r\n            }\r\n        };\r\n    }\r\n```","createdAt":"2021-07-15T11:12:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/586#issuecomment-880609132","viewerDidAuthor":false}],"createdAt":"2021-07-12T18:41:28Z","labels":[],"milestone":null,"number":586,"reactionGroups":[],"state":"CLOSED","title":"Activities advised with AspectJ are not recognised as implementation of @ActivityInterface anymore","updatedAt":"2021-07-15T11:12:13Z","url":"https://github.com/temporalio/sdk-java/issues/586"}
