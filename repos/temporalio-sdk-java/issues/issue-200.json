{"assignees":[],"author":{"id":"MDQ6VXNlcjU1NTIzODE=","is_bot":false,"login":"mastermanu","name":""},"body":"## Expected Behavior\r\nPrometheusMeterRegistry + MicrometerClientStatsReporter should successfully emit metrics to Prometheus.\r\n\r\n## Actual Behavior\r\nMetric Registration fails:\r\n```\r\njava.lang.IllegalArgumentException: Prometheus requires that all meters with the same name have the same set of tag keys. There is already an existing meter named 'temporal_request_latency_seconds' containing tag keys [Operation]. The meter you are attempting to register has keys [Namespace, Operation, TaskQueue, WorkflowType].\r\n\tat io.micrometer.prometheus.PrometheusMeterRegistry.lambda$applyToCollector$16(PrometheusMeterRegistry.java:419)\r\n\tat java.base/java.util.concurrent.ConcurrentHashMap.compute(ConcurrentHashMap.java:1932)\r\n\tat io.micrometer.prometheus.PrometheusMeterRegistry.applyToCollector(PrometheusMeterRegistry.java:403)\r\n\tat io.micrometer.prometheus.PrometheusMeterRegistry.newTimer(PrometheusMeterRegistry.java:197)\r\n\tat io.micrometer.core.instrument.MeterRegistry.lambda$timer$2(MeterRegistry.java:308)\r\n\tat io.micrometer.core.instrument.MeterRegistry.getOrCreateMeter(MeterRegistry.java:612)\r\n\tat io.micrometer.core.instrument.MeterRegistry.registerMeterIfNecessary(MeterRegistry.java:566)\r\n\tat io.micrometer.core.instrument.MeterRegistry.timer(MeterRegistry.java:306)\r\n\tat io.micrometer.core.instrument.Timer$Builder.register(Timer.java:539)\r\n\tat io.micrometer.core.instrument.MeterRegistry.timer(MeterRegistry.java:433)\r\n\tat io.temporal.common.reporter.MicrometerClientStatsReporter.reportTimer(MicrometerClientStatsReporter.java:69)\r\n\tat com.uber.m3.tally.TimerImpl.record(TimerImpl.java:55)\r\n\tat com.uber.m3.tally.TimerImpl.recordStopwatch(TimerImpl.java:69)\r\n\tat com.uber.m3.tally.Stopwatch.stop(Stopwatch.java:48)\r\n\tat io.temporal.internal.grpc.GrpcMetricsInterceptor$MetricsClientCall$1.onClose(GrpcMetricsInterceptor.java:126)\r\n\tat io.grpc.internal.ClientCallImpl.closeObserver(ClientCallImpl.java:434)\r\n\tat io.grpc.internal.ClientCallImpl.access$500(ClientCallImpl.java:66)\r\n\tat io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInternal(ClientCallImpl.java:763)\r\n\tat io.grpc.internal.ClientCallImpl$ClientStreamListenerImpl$1StreamClosed.runInContext(ClientCallImpl.java:742)\r\n\tat io.grpc.internal.ContextRunnable.run(ContextRunnable.java:37)\r\n\tat io.grpc.internal.SerializingExecutor.run(SerializingExecutor.java:123)\r\n\tat io.grpc.stub.ClientCalls$ThreadlessExecutor.waitAndDrain(ClientCalls.java:740)\r\n\tat io.grpc.stub.ClientCalls.blockingUnaryCall(ClientCalls.java:149)\r\n\tat io.temporal.api.workflowservice.v1.WorkflowServiceGrpc$WorkflowServiceBlockingStub.respondWorkflowTaskCompleted(WorkflowServiceGrpc.java:2673)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.lambda$sendReply$0(WorkflowWorker.java:369)\r\n\tat io.temporal.internal.common.GrpcRetryer.lambda$retry$0(GrpcRetryer.java:109)\r\n\tat io.temporal.internal.common.GrpcRetryer.retryWithResult(GrpcRetryer.java:127)\r\n\tat io.temporal.internal.common.GrpcRetryer.retry(GrpcRetryer.java:106)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.sendReply(WorkflowWorker.java:362)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:313)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:275)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:73)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n\tat java.base/java.lang.Thread.run(Thread.java:835)\r\n```\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n ```\r\n PrometheusMeterRegistry registry = new PrometheusMeterRegistry(prometheusConfig);\r\n StatsReporter reporter = new MicrometerClientStatsReporter(registry);\r\n      Scope scope =\r\n          new RootScopeBuilder()\r\n              .reporter(reporter)\r\n              .reportEvery(com.uber.m3.util.Duration.ofSeconds(10));\r\n      service =\r\n          WorkflowServiceStubs.newInstance(\r\n              WorkflowServiceStubsOptions.newBuilder()\r\n                  .setTarget(target)\r\n                  .setMetricsScope(scope)\r\n                  .build());\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: 0.29 SDK\r\n","closedAt":"2020-11-25T01:53:34Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDY4MTQ3MTE5OA==","author":{"login":"kkcmadhu"},"authorAssociation":"NONE","body":"thanks Manu, i was actually able to publish the metrics to another prometheus server which did not have any temporal related metrics reported already.\r\napart from the issue  that there is inconsistency in what tags are getting added by various components, i also see that the custom  tags are completely missing. more info here\r\nhttps://community.temporal.io/t/attaching-custom-tags-workflow-metrics/526","createdAt":"2020-08-27T05:00:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/200#issuecomment-681471198","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY5NjUzNzg1Mw==","author":{"login":"vitarb"},"authorAssociation":"CONTRIBUTOR","body":"@kkcmadhu\r\n\r\nPrometheus requires each unique metric key to be always reported with the same set of tags.\r\n\r\nUnfortunately our SDK does not respect this constraint and tries to maximize amount of useful data that it publishes. The price of this is that there are code paths that may lead to partially filled tags for some operations, which results in errors during metric publishing like the one that you see in the description.\r\n\r\nWhile we don't have a proper fix yet, I can suggest a client-side work-around that may unblock you for now.\r\nYou could try adding default dummy values for common parameters in the root metric scope.\r\n\r\nFor example:\r\n```\r\nScope scope = new RootScopeBuilder()\r\n\t\t.reporter(reporter)\r\n\t\t.tags(new HashMap<>() {\r\n\t\t\t\t{\r\n\t\t\t\t\tput(MetricsTag.NAMESPACE, environment.getNamespace());\r\n\t\t\t\t\tput(MetricsTag.ACTIVITY_TYPE, NONE);\r\n\t\t\t\t\tput(MetricsTag.OPERATION_NAME, NONE);\r\n\t\t\t\t\tput(MetricsTag.SIGNAL_NAME, NONE);\r\n\t\t\t\t\tput(MetricsTag.QUERY_TYPE, NONE);\r\n\t\t\t\t\tput(MetricsTag.TASK_QUEUE, NONE);\r\n\t\t\t\t\tput(MetricsTag.STATUS_CODE, NONE);\r\n\t\t\t\t\tput(MetricsTag.EXCEPTION, NONE);\r\n\t\t\t\t\tput(MetricsTag.WORKFLOW_TYPE, NONE);\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t.reportEvery(com.uber.m3.util.Duration.ofSeconds(10));\r\n}\r\n```\r\nThis should result in something like this being published instead of the error mentioned above:\r\n```\r\n# TYPE temporal_request_latency_seconds_max gauge\r\ntemporal_request_latency_seconds_max{ActivityType=\"ExecuteRemoteTestStep\",Namespace=\"java-bench\",Operation=\"RespondActivityTaskCompleted\",TaskQueue=\"temporal-bench\",WorkflowType=\"config-driven-workflow\",} 0.067643565\r\ntemporal_request_latency_seconds_max{ActivityType=\"RunDriver\",Namespace=\"java-bench\",Operation=\"RespondActivityTaskCompleted\",TaskQueue=\"temporal-bench\",WorkflowType=\"bench-driver\",} 0.004640764\r\ntemporal_request_latency_seconds_max{ActivityType=\"None\",Namespace=\"java-bench\",Operation=\"ResetStickyTaskQueue\",TaskQueue=\"None\",WorkflowType=\"None\",} 0.062871658\r\ntemporal_request_latency_seconds_max{ActivityType=\"None\",Namespace=\"java-bench\",Operation=\"StartWorkflowExecution\",TaskQueue=\"temporal-bench\",WorkflowType=\"config-driven-workflow\",} 0.006228311\r\ntemporal_request_latency_seconds_max{ActivityType=\"None\",Namespace=\"java-bench\",Operation=\"RespondWorkflowTaskCompleted\",TaskQueue=\"temporal-bench\",WorkflowType=\"bench-driver\",} 0.005130324\r\ntemporal_request_latency_seconds_max{ActivityType=\"RunDriver\",Namespace=\"java-bench\",Operation=\"RecordActivityTaskHeartbeat\",TaskQueue=\"temporal-bench\",WorkflowType=\"bench-driver\",} 0.003844159\r\ntemporal_request_latency_seconds_max{ActivityType=\"RunMonitor\",Namespace=\"java-bench\",Operation=\"RecordActivityTaskHeartbeat\",TaskQueue=\"temporal-bench\",WorkflowType=\"bench-driver\",} 0.003414754\r\ntemporal_request_latency_seconds_max{ActivityType=\"ExecuteRemoteTestStep\",Namespace=\"java-bench\",Operation=\"RecordActivityTaskHeartbeat\",TaskQueue=\"temporal-bench\",WorkflowType=\"config-driven-workflow\",} 0.049534959\r\ntemporal_request_latency_seconds_max{ActivityType=\"None\",Namespace=\"java-bench\",Operation=\"RespondWorkflowTaskCompleted\",TaskQueue=\"temporal-bench\",WorkflowType=\"config-driven-workflow\",} 0.073708412\r\ntemporal_request_latency_seconds_max{ActivityType=\"RunCleaner\",Namespace=\"java-bench\",Operation=\"RespondActivityTaskCompleted\",TaskQueue=\"temporal-bench\",WorkflowType=\"bench-driver\",} 0.002968035\r\ntemporal_request_latency_seconds_max{ActivityType=\"RunMonitor\",Namespace=\"java-bench\",Operation=\"RespondActivityTaskCompleted\",TaskQueue=\"temporal-bench\",WorkflowType=\"bench-driver\",} 0.003083715\r\ntemporal_request_latency_seconds_max{ActivityType=\"None\",Namespace=\"java-bench\",Operation=\"DescribeWorkflowExecution\",TaskQueue=\"None\",WorkflowType=\"None\",} 0.010100332\r\ntemporal_request_latency_seconds_max{ActivityType=\"None\",Namespace=\"java-bench\",Operation=\"GetWorkflowExecutionHistory\",TaskQueue=\"None\",WorkflowType=\"None\",} 0.011132755\r\n```\r\n\r\nHope this helps you, meanwhile we'll be looking at our options for a better solution on the SDK side.\r\n","createdAt":"2020-09-22T06:40:11Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/200#issuecomment-696537853","viewerDidAuthor":false}],"createdAt":"2020-08-26T15:00:46Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":200,"reactionGroups":[],"state":"CLOSED","title":"Java SDK metrics don't work correctly with PrometheusRegistry","updatedAt":"2020-11-25T01:53:34Z","url":"https://github.com/temporalio/sdk-java/issues/200"}
