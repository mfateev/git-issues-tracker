{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjI0MTQ4NjY=","is_bot":false,"login":"sergtitov","name":"Sergey Titov"},"body":"## Expected Behavior\r\n\r\nWhen testing a long running workflow using in-memory Temporal, no exception is thrown and the tests succeeds.\r\n\r\n## Actual Behavior\r\n\r\nWe are getting “DEADLINE_EXCEEDED: deadline exceeded after ~70s” error when testing a long-running workflow using in-memory Temporal (TestWorkflowExtension).\r\n\r\nThis happens if there is long running activity or if a workflow is executing several short activities but as long as total workflow running time exceeds 70 seconds, this exception gets thrown.\r\n\r\nThe issue does NOT happen with a locally running Temporal (tests configured via setUseExternalService(true) and .setTarget(“127.0.0.1:7233”)). It only happens with in-memory Temporal instance.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Create a long running workflow (that makes API calls or long running logic)\r\n  1. Write a test using in-memory Temporal (TestWorkflowExtension)\r\n  1. Run the test and wait for 70 seconds, DEADLINE_EXCEEDED exception is thrown\r\n\r\nBelow is stack trace and code of the repro (the actual code does not use sleeps, of course, it makes API calls, data transformation, etc.)\r\n\r\n### Stack trace:\r\n\r\n```\r\nio.grpc.StatusRuntimeException: DEADLINE_EXCEEDED: deadline exceeded after 69.999644732s. []\r\n\tat io.grpc.stub.ClientCalls.toStatusRuntimeException(ClientCalls.java:262)\r\n\tat io.grpc.stub.ClientCalls.getUnchecked(ClientCalls.java:243)\r\n\tat io.grpc.stub.ClientCalls.blockingUnaryCall(ClientCalls.java:156)\r\n\tat io.temporal.api.workflowservice.v1.WorkflowServiceGrpc$WorkflowServiceBlockingStub.getWorkflowExecutionHistory(WorkflowServiceGrpc.java:2625)\r\n\tat io.temporal.internal.common.WorkflowExecutionUtils.lambda$getInstanceCloseEvent$1(WorkflowExecutionUtils.java:257)\r\n\tat io.temporal.internal.common.GrpcRetryer.retryWithResult(GrpcRetryer.java:97)\r\n\tat io.temporal.internal.common.WorkflowExecutionUtils.getInstanceCloseEvent(WorkflowExecutionUtils.java:245)\r\n\tat io.temporal.internal.common.WorkflowExecutionUtils.getWorkflowExecutionResult(WorkflowExecutionUtils.java:133)\r\n\tat io.temporal.internal.client.RootWorkflowClientInvoker.getResult(RootWorkflowClientInvoker.java:94)\r\n\tat io.temporal.internal.sync.WorkflowStubImpl.getResult(WorkflowStubImpl.java:243)\r\n\tat io.temporal.internal.sync.WorkflowStubImpl.getResult(WorkflowStubImpl.java:225)\r\n\tat io.temporal.testing.TestWorkflowEnvironmentInternal$TimeLockingInterceptor$TimeLockingWorkflowStub.getResult(TestWorkflowEnvironmentInternal.java:295)\r\n\tat io.temporal.internal.sync.WorkflowInvocationHandler$SyncWorkflowInvocationHandler.startWorkflow(WorkflowInvocationHandler.java:315)\r\n\tat io.temporal.internal.sync.WorkflowInvocationHandler$SyncWorkflowInvocationHandler.invoke(WorkflowInvocationHandler.java:270)\r\n\tat io.temporal.internal.sync.WorkflowInvocationHandler.invoke(WorkflowInvocationHandler.java:178)\r\n\tat jdk.proxy3/jdk.proxy3.$Proxy202.run(Unknown Source)\r\n```\r\n\r\n### Code repro:\r\n\r\n```\r\n@WorkflowInterface\r\n public interface LongRunningWorkflow {\r\n      @WorkflowMethod\r\n     void run();\r\n }\r\n\r\npublic class LongRunningWorkflowImpl implements LongRunningWorkflow {\r\n     private final ActivityOptions activityOptions = ActivityOptions.newBuilder()\r\n             .setScheduleToCloseTimeout(Duration.ofHours(1))\r\n             .build();\r\n\r\n      private final SleepActivities activities = Workflow.newActivityStub(SleepActivities.class, activityOptions);\r\n\r\n      @Override\r\n     public void run() {\r\n         activities.sleep(Duration.ofSeconds(30));\r\n         activities.sleep(Duration.ofSeconds(30));\r\n         activities.sleep(Duration.ofSeconds(30));\r\n         activities.sleep(Duration.ofSeconds(30));\r\n     }\r\n }\r\n\r\n@ActivityInterface\r\n public interface SleepActivities {\r\n     @ActivityMethod\r\n     boolean sleep(Duration duration);\r\n }\r\n\r\npublic class SleepActivitiesImpl implements SleepActivities {\r\n     private static final Logger logger = LoggerFactory.getLogger(SleepActivitiesImpl.class);\r\n\r\n     @Override\r\n     public boolean sleep(Duration duration) {\r\n         try {\r\n             logger.info(\"Sleeping for {} sec\", duration.toSeconds());\r\n             Thread.sleep(duration.toMillis());\r\n         } catch (InterruptedException e) {\r\n             e.printStackTrace();\r\n         }\r\n         return true;\r\n     }\r\n }\r\n\r\n@ExtendWith(MockitoExtension.class)\r\n class LongRunningWorkflowImplTest {\r\n      private static final SleepActivitiesImpl sleepActivities = new SleepActivitiesImpl();\r\n\r\n     @RegisterExtension\r\n     public static final TestWorkflowExtension testWorkflowExtension =\r\n             TestWorkflowExtension.newBuilder()\r\n                     .setWorkflowClientOptions(TemporalConfiguration.getWorkflowClientOptions(\"default\"))\r\n                     .setWorkflowTypes(LongRunningWorkflowImpl.class)\r\n                     .setActivityImplementations(sleepActivities)\r\n                     .build();\r\n\r\n     @Test\r\n     void test_run(LongRunningWorkflow workflow) {\r\n         workflow.run();\r\n     }\r\n }\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: 1.3.0\r\n  - Platform: JDK 16\r\n","closedAt":"2021-09-13T17:20:10Z","comments":[{"id":"IC_kwDODN12PM42qrbb","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Some initial investigation here:\r\n\r\nThe deadline that applies here is `WorkflowServiceStubsOptions#rpcLongPollTimeout` which by default is 70s\r\n\r\n@sergtitov please set up `rpcLongPollTimeout` to an actual value that makes sense for you.\r\n\r\nBut. This deadline is for some reason is not enforced with an external docker service - I was able to confirm it. This is an actual problem we should be looking at.\r\n\r\nAlso, there is another problem with a strange logic here. We apply the same `rpcLongPollTimeout` for pollWorkflowTaskQueueMethod, pollActivityTaskQueueMethod and getWorkflowExecutionHistoryMethod (see GrpcDeadlineInterceptor and LongPollUtil#isLongPoll). Which doesn't make much sense. \"client-side\" long polls and \"worker-side\" long polls are very different. Probably worker long poll timeout shouldn't be exposed at all in configuration and should be setup into something reasonable. Or it should be exposed as a separate option.\r\n\r\nHere is the reproduction: https://github.com/Spikhalskiy/java-sdk/commit/9470a71728e818b20de3da83b10a9139e6fd1983\r\n\r\n","createdAt":"2021-09-10T19:29:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/707#issuecomment-917157595","viewerDidAuthor":false},{"id":"IC_kwDODN12PM42qsPF","author":{"login":"sergtitov"},"authorAssociation":"NONE","body":"@Spikhalskiy Dima, can you please elaborate why we need to set `rpcLongPollTimeout`? It is not documented anywhere and seems to be an internal thing and it actually looks like a red herring. Internal method `getWorkflowExecutionHistoryMethod` should not take 70 seconds even if workflow takes minutes/hours. Maybe there is a deadlock somewhere?","createdAt":"2021-09-10T19:35:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/707#issuecomment-917160901","viewerDidAuthor":false},{"id":"IC_kwDODN12PM42qtLD","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"@sergtitov getWorkflowExecutionHistoryMethod is this case is a long poll method that returns only when workflow is completed. It's not really a get, it's a wait. So, it gets rpcLongPollTimeout applied.\r\nInformation about getWorkflowExecutionHistoryMethod is internal. You should care about rpcLongPollTimeout and this option is documented on WorkflowServiceStubsOptions#rpcLongPollTimeout","createdAt":"2021-09-10T19:42:28Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/707#issuecomment-917164739","viewerDidAuthor":false},{"id":"IC_kwDODN12PM42qun5","author":{"login":"sergtitov"},"authorAssociation":"NONE","body":"I am confused. Based on documentation, Temporal workflows could be running for days/months and should be able to survive worker re-starts and even code updates. Nowhere in the docs it is mentioned that `rpcLongPollTimeout` should be changed. Should it be set in production as well not just in tests? What value should it be set to?\r\n\r\n// CC @mfateev ","createdAt":"2021-09-10T19:53:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/707#issuecomment-917170681","viewerDidAuthor":false},{"id":"IC_kwDODN12PM42q3IJ","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"> Based on documentation, Temporal workflows could be running for days/months and should be able to survive worker re-starts and even code updates.\r\n\r\nIt's, this timeout affects only client-side wait, the processing of the workflow continues.\r\n\r\n@sergtitov disregard my earlier comments for now, it's a half-truth. You shouldn't worry about rpcLongPollTimeout much. I will compose the whole picture first and get back.","createdAt":"2021-09-10T20:55:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-java/issues/707#issuecomment-917205513","viewerDidAuthor":false},{"id":"IC_kwDODN12PM42vQTl","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"This is going to be addressed by #709 and #713","createdAt":"2021-09-13T16:19:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/707#issuecomment-918357221","viewerDidAuthor":false}],"createdAt":"2021-09-10T18:30:44Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":5,"title":"v.1.3.1","description":"Hotfix release that contains fixes for gRPC:Status:DEADLINE_EXCEEDED related regressions introduced by 1.3.0","dueOn":"2021-09-13T00:00:00Z"},"number":707,"reactionGroups":[],"state":"CLOSED","title":"DEADLINE_EXCEEDED: deadline exceeded after 69.999644732s","updatedAt":"2021-09-13T20:07:04Z","url":"https://github.com/temporalio/sdk-java/issues/707"}
