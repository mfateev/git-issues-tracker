{"assignees":[{"id":"MDQ6VXNlcjUzMjEwOA==","login":"Spikhalskiy","name":"Dmitry Spikhalsky","databaseId":0}],"author":{"id":"MDQ6VXNlcjUxNzY4Mw==","is_bot":false,"login":"Sushisource","name":"Spencer Judge"},"body":"The Java benches have consistently been having issues with the `reactor_stress` test, resulting in worker logs that look like the below. Eventually this causes the test to time out. I would not discount the possibility that the bencher itself is actually the problem here and not something in the SDK\r\n\r\n```\r\n16:54:23.234 [Workflow Executor taskQueue=\"temporal-bench\", namespace=\"java-bench\": 13767] ERROR i.t.i.r.ReplayWorkflowTaskHandler - Workflow task failure. startedEventId=73, WorkflowId=config-driven-throughputstress-re │\r\n│ actor_stress_i9wr-0-585, RunId=fc0f95b5-58c6-48d4-b069-cf088d2be395. If see continuously the workflow might be stuck.                                                                                                       │\r\n│ io.temporal.internal.replay.InternalWorkflowTaskException: Failure handling event 67 of 'EVENT_TYPE_WORKFLOW_TASK_COMPLETED' type. IsReplaying=true, PreviousStartedEventId=66, workflowTaskStartedEventId=73, Currently Pr │\r\n│ ocessing StartedEventId=66                                                                                                                                                                                                  │\r\n│     at io.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:193)                                                                                                                 │\r\n│     at io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleEvent(ReplayWorkflowRunTaskHandler.java:140)                                                                                                          │\r\n│     at io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:180)                                                                                               │\r\n│     at io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTask(ReplayWorkflowRunTaskHandler.java:150)                                                                                                   │\r\n│     at io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithEmbeddedQuery(ReplayWorkflowTaskHandler.java:201)                                                                                        │\r\n│     at io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:114)                                                                                                         │\r\n│     at io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:319)                                                                                                                           │\r\n│     at io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:279)                                                                                                                           │\r\n│     at io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:73)                                                                                                                              │\r\n│     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)                                                                                                                                      │\r\n│     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)                                                                                                                                      │\r\n│     at java.lang.Thread.run(Thread.java:748)                                                                                                                                                                                │\r\n│ Caused by: java.lang.IllegalArgumentException: Unexpected event:event_id: 67                                                                                                                                                │\r\n│ event_time {                                                                                                                                                                                                                │\r\n│   seconds: 1629219263                                                                                                                                                                                                       │\r\n│   nanos: 10300937                                                                                                                                                                                                           │\r\n│ }                                                                                                                                                                                                                           │\r\n│ event_type: EVENT_TYPE_WORKFLOW_TASK_COMPLETED                                                                                                                                                                              │\r\n│ task_id: 2107374                                                                                                                                                                                                            │\r\n│ workflow_task_completed_event_attributes {                                                                                                                                                                                  │\r\n│   scheduled_event_id: 65                                                                                                                                                                                                    │\r\n│   started_event_id: 66                                                                                                                                                                                                      │\r\n│   identity: \"1@java-bench-temporal-bench-6f6f76fccf-hpxgm\"                                                                                                                                                                  │\r\n│ }                                                                                                                                                                                                                           │\r\n│     at io.temporal.internal.statemachines.WorkflowStateMachines.handleNonStatefulEvent(WorkflowStateMachines.java:419)                                                                                                      │\r\n│     at io.temporal.internal.statemachines.WorkflowStateMachines.handleEventImpl(WorkflowStateMachines.java:215)                                                                                                             │\r\n│     at io.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:178)                                                                                                                 │\r\n│     ... 11 common frames omitted \r\n```","closedAt":"2022-04-12T17:25:01Z","comments":[{"id":"IC_kwDODN12PM41rBVp","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"History for the above WF: \r\n[config driven throughputstress reactor_stress_i9wr 0 585 - fc0f95b5-58c6-48d4-b069-cf088d2be395.json.zip](https://github.com/temporalio/sdk-java/files/7001736/config.driven.throughputstress.reactor_stress_i9wr.0.585.-.fc0f95b5-58c6-48d4-b069-cf088d2be395.json.zip)\r\n","createdAt":"2021-08-17T17:02:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/643#issuecomment-900470121","viewerDidAuthor":false},{"id":"IC_kwDODN12PM41xbra","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Occurred during running unit tests towards Temporal docker, so looks like a bug.\r\nhttps://buildkite.com/temporal/java-sdk/builds/1931#36436399-a39d-499e-94ca-4acf598e6a9a\r\n[java-sdk_build_1931_java-unit-test-with-docker-service.log](https://github.com/temporalio/sdk-java/files/7017060/java-sdk_build_1931_java-unit-test-with-docker-service.log)\r\n","createdAt":"2021-08-19T18:40:21Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/643#issuecomment-902150874","viewerDidAuthor":false},{"id":"IC_kwDODN12PM41xn4Z","author":{"login":"vkoby"},"authorAssociation":"CONTRIBUTOR","body":"This test: [workflowsCanBeQueriedAfterEviction](https://github.com/temporalio/sdk-java/blob/25da5d2064a6c024148e236e060c34d286283b56/temporal-sdk/src/test/java/io/temporal/worker/StickyWorkerTest.java#L441)","createdAt":"2021-08-19T19:58:16Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/643#issuecomment-902200857","viewerDidAuthor":false},{"id":"IC_kwDODN12PM43J-2A","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"Just a note: happens in `workflowsCanBeQueriedAfterEviction` in a stable manner, every run, it's not a flake. ","createdAt":"2021-09-22T22:05:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/643#issuecomment-925363584","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5BVBqX","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"normal WFT\r\nHandle 1 event EVENT_TYPE_WORKFLOW_EXECUTION_STARTED\r\nHandle 2 event EVENT_TYPE_WORKFLOW_TASK_SCHEDULED\r\nHandle 3 event EVENT_TYPE_WORKFLOW_TASK_STARTED\r\n\r\n// Eviction from the workflow cache\r\n\r\nlegacyQuery WFT\r\nHandle 1 event EVENT_TYPE_WORKFLOW_EXECUTION_STARTED\r\nHandle 2 event EVENT_TYPE_WORKFLOW_TASK_SCHEDULED\r\nHandle 3 event EVENT_TYPE_WORKFLOW_TASK_STARTED\r\nHandle 4 event EVENT_TYPE_WORKFLOW_TASK_COMPLETED\r\n\r\nnormal WFT\r\nHandle 4 event EVENT_TYPE_WORKFLOW_TASK_COMPLETED\r\n^ exception because the state machines of the cached workflow already handled it","createdAt":"2022-04-12T04:54:06Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/643#issuecomment-1096030871","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5BVEJv","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"There are two problems here:\r\n1. State machines should allow partial histories sent with Workflow Tasks to contain events that were already handled\r\n2. We should reset sticky queue on cache invalidation or eviction. We have a task for it: https://github.com/temporalio/sdk-java/issues/883","createdAt":"2022-04-12T04:59:12Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/643#issuecomment-1096041071","viewerDidAuthor":false},{"id":"IC_kwDODN12PM5BVQ8O","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"User report about a similar problem: https://community.temporal.io/t/getting-error-in-workflow-when-waiting-for-2-hours-and-querying-at-the-same-time/4398","createdAt":"2022-04-12T05:39:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/643#issuecomment-1096093454","viewerDidAuthor":false}],"createdAt":"2021-08-17T16:59:57Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":10,"title":"1.9.0","description":"","dueOn":"2022-04-12T00:00:00Z"},"number":643,"reactionGroups":[],"state":"CLOSED","title":"Unexpected WFT Completed events in java bench runs","updatedAt":"2022-04-12T17:25:01Z","url":"https://github.com/temporalio/sdk-java/issues/643"}
