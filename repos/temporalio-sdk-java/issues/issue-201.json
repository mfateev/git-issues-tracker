{"assignees":[],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"## Actual Behavior\r\n\r\n`WorkflowThreadImpl#start` in case of full thread pool triggers `getWorkflowContext().getMetricsScope().counter(MetricsType.STICKY_CACHE_THREAD_FORCED_EVICTION).inc(1)` directly, after that it calls `cache.evictAnyNotInProcessing` which triggers the metrics increment one more time inside:\r\n`metricsScope.counter(MetricsType.STICKY_CACHE_THREAD_FORCED_EVICTION).inc(1)`\r\n\r\nAs the result one eviction will be reported twice. \r\n\r\n## Proposed solution\r\n\r\nRemove unconditional increment from `WorkflowThreadImpl#start` and leave more correct and checked increment inside `cache.evictAnyNotInProcessing`","closedAt":"2021-10-05T19:58:59Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDY4MTE3NjQzOA==","author":{"login":"Spikhalskiy"},"authorAssociation":"CONTRIBUTOR","body":"I also have some questions about `WorkflowThreadImpl` logic, because it looks strange.\r\n\r\n```\r\nwhile (true) {\r\n      try {\r\n        taskFuture = threadPool.submit(task);\r\n        return;\r\n      } catch (RejectedExecutionException e) {\r\n        ...\r\n        if (cache != null) {\r\n          boolean evicted =\r\n              cache.evictAnyNotInProcessing(\r\n                  context.getWorkflowExecution(), workflowContext.getMetricsScope());\r\n          if (!evicted) {\r\n            throw new WorkflowRejectedExecutionError(e);\r\n          }\r\n        } else {\r\n          throw new WorkflowRejectedExecutionError(e);\r\n        }\r\n      }\r\n    }\r\n```\r\n\r\nWhy in case we successfully evicted from the cache we do try to resubmit the task into the pool, while if we failed to evict - we don't try to resubmit the task? Successful eviction from the cache doesn't influence an amount of available threads in the thread pool anyhow or an available space in the thread pool queue, so this logic looks off.\r\nAlso, looks like if the thread pool is full - we will continue to eviction from the cache one by one till we clean everything \"not in progress\" from it. Why not to make it in one visit and one iteration through the cache, what's the benefit to do it one by one?","createdAt":"2020-08-26T23:32:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/201#issuecomment-681176438","viewerDidAuthor":false}],"createdAt":"2020-08-26T23:25:04Z","labels":[],"milestone":null,"number":201,"reactionGroups":[],"state":"CLOSED","title":"STICKY_CACHE_THREAD_FORCED_EVICTION double reporting","updatedAt":"2021-10-05T19:58:59Z","url":"https://github.com/temporalio/sdk-java/issues/201"}
