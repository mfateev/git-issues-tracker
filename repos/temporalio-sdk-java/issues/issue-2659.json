{"assignees":[],"author":{"id":"MDQ6VXNlcjE1ODE3MjQy","is_bot":false,"login":"ivanasen","name":"Ivan-Asen Chakarov"},"body":"## Expected Behavior\n\nAssume we have a `WorkflowClientInterceptor` that sets a header when a signal is sent. In a real (or dev server) Temporal environment, the header will be present in the corresponding `WorkflowInboundCallsInterceptor.handleSignal`. However, if we use temporal-testing there will be no header. The `temporal-testing` library should be as close as possible to a real environment, and the header should be propagated.\n\n## Actual Behavior\nThere is no header in the inbound interceptor's handler for signals.\n\n## Steps to Reproduce the Problem\nHere is a minimal example that reproduces the bug:\n- [intercept.zip](https://github.com/user-attachments/files/22321086/intercept.zip) - The entire Maven project\n- [ClientApp.java](https://github.com/user-attachments/files/22320971/ClientApp.java) - The client application.\n- [WorkerApp.java](https://github.com/user-attachments/files/22320973/WorkerApp.java) - The worker application.\n- [InterceptingSignalsBug.java](https://github.com/user-attachments/files/22320974/InterceptingSignalsBug.java) - Here are the workflows and interceptors.\n- [InterceptingSignalsBugTest.java](https://github.com/user-attachments/files/22320984/InterceptingSignalsBugTest.java) - Here is a test.\n\nHere are also snippets of the interceptors for better visibility:\n```java\n    public static final String HEADER = \"my-header\";\n    public static final Payload PAYLOAD = GlobalDataConverter.get().toPayload(\"my-value\").get();\n\n    public static class Client extends WorkflowClientInterceptorBase {\n        @Override\n        public WorkflowClientCallsInterceptor workflowClientCallsInterceptor(WorkflowClientCallsInterceptor next) {\n            return new WorkflowClientCallsInterceptorBase(next) {\n                // ...\n\n                @Override\n                public WorkflowSignalOutput signal(WorkflowSignalInput input) {\n                    log.info(\"CLIENT signal: Setting headers\");\n                    input.getHeader().getValues().put(HEADER, PAYLOAD);\n                    return super.signal(input);\n                }\n            };\n        }\n    }\n\n    static class Worker extends WorkerInterceptorBase {\n        @Override\n        public WorkflowInboundCallsInterceptor interceptWorkflow(WorkflowInboundCallsInterceptor next) {\n            return new WorkflowInboundCallsInterceptorBase(next) {\n                // ...\n\n                @Override\n                public void handleSignal(SignalInput input) {\n                    log.info(\"INBOUND signal: Received header: {}\", input.getHeader().getValues().get(HEADER));\n                    super.handleSignal(input);\n                }\n            };\n        }\n    }\n```\n\nIf we run a Temporal server, and also the `ClientApp` and `WorkerApp`, then the logs of the worker app will contain:\n```\n[signal signal] INFO com.example.InterceptingSignalsBug - INBOUND signal: Received header: metadata {\n  key: \"encoding\"\n  value: \"json/plain\"\n}\ndata: \"\\\"my-value\\\"\"\n```\nand on the other hand, if the test `InterceptingSignalsBugTest` is run, then the log will be:\n```\n[signal signal] INFO com.example.InterceptingSignalsBug - INBOUND signal: Received header: null\n```\n\nFrom my testing, it seems that all other inbound interceptor methods receive the headers correctly. Only the `signal` is problematic.\n\n## Specifications\n\n- Version:\n```\n$ temporal --version\ntemporal version 1.4.1 (Server 1.28.0, UI 2.39.0)\n\n$ java --version\nopenjdk 22.0.2 2024-07-16\nOpenJDK Runtime Environment (build 22.0.2+9-70)\nOpenJDK 64-Bit Server VM (build 22.0.2+9-70, mixed mode, sharing)\n```\n- `temporal-sdk` and `temporal-testing` version used: **1.31.0**\n- Platform: Ran on Macbook M1 Pro","closedAt":"2025-09-15T03:33:31Z","comments":[],"createdAt":"2025-09-14T14:58:01Z","labels":[],"milestone":null,"number":2659,"reactionGroups":[],"state":"CLOSED","title":"temporal-testing for Java does not propagate headers for signals in interceptors","updatedAt":"2025-09-15T03:33:31Z","url":"https://github.com/temporalio/sdk-java/issues/2659"}
