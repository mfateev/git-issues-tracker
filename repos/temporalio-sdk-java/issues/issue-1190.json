{"assignees":[],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"## Actual Behavior\r\n```\r\nio.temporal.client.WorkflowQueryException: workflowId='f2454b12-fcb1-4b3e-9b29-2f02e33a6543', runId='c5e13f9c-0e3c-454f-adb7-e7dd5fea844d', workflowType='TestWorkflowWithQuery'}\r\n\r\n\tat io.temporal.internal.sync.WorkflowStubImpl.query(WorkflowStubImpl.java:331)\r\n\tat io.temporal.testing.TimeLockingInterceptor$TimeLockingWorkflowStub.query(TimeLockingInterceptor.java:172)\r\n\tat io.temporal.internal.sync.WorkflowInvocationHandler$SyncWorkflowInvocationHandler.queryWorkflow(WorkflowInvocationHandler.java:309)\r\n\tat io.temporal.internal.sync.WorkflowInvocationHandler$SyncWorkflowInvocationHandler.invoke(WorkflowInvocationHandler.java:272)\r\n\tat io.temporal.internal.sync.WorkflowInvocationHandler.invoke(WorkflowInvocationHandler.java:178)\r\n\tat com.sun.proxy.$Proxy18.query(Unknown Source)\r\n\tat io.temporal.workflow.queryTests.LocalActivityAndQueryInvestigationTest.testLocalActivityAndQuery(LocalActivityAndQueryInvestigationTest.java:68)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.base/java.lang.reflect.Method.invoke(Method.java:566)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:59)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:56)\r\n\tat org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\r\n\tat org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:299)\r\n\tat org.junit.internal.runners.statements.FailOnTimeout$CallableStatement.call(FailOnTimeout.java:293)\r\n\tat java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)\r\n\tat java.base/java.lang.Thread.run(Thread.java:829)\r\nCaused by: io.grpc.StatusRuntimeException: INVALID_ARGUMENT: io.temporal.internal.replay.InternalWorkflowTaskException: Failure handling event 5 of type 'EVENT_TYPE_MARKER_RECORDED' during execution. {PreviousStartedEventId=3, workflowTaskStartedEventId=3, Currently Processing StartedEventId=3}\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.createEventProcessingException(WorkflowStateMachines.java:244)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEventsBatch(WorkflowStateMachines.java:223)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEvent(WorkflowStateMachines.java:197)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleWorkflowTaskImpl(ReplayWorkflowRunTaskHandler.java:180)\r\n\tat io.temporal.internal.replay.ReplayWorkflowRunTaskHandler.handleQueryWorkflowTask(ReplayWorkflowRunTaskHandler.java:247)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTaskWithQuery(ReplayWorkflowTaskHandler.java:118)\r\n\tat io.temporal.internal.replay.ReplayWorkflowTaskHandler.handleWorkflowTask(ReplayWorkflowTaskHandler.java:97)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handleTask(WorkflowWorker.java:277)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:231)\r\n\tat io.temporal.internal.worker.WorkflowWorker$TaskHandlerImpl.handle(WorkflowWorker.java:173)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:93)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n\tat java.base/java.lang.Thread.run(Thread.java:829)\r\nCaused by: java.lang.IllegalArgumentException: LocalActivity: invalid REQUEST_PREPARED->MARKER_RECORDED, transition history is [CREATED->CHECK_EXECUTION_STATE, EXECUTING->SCHEDULE]\r\n\tat io.temporal.internal.statemachines.StateMachine.executeTransition(StateMachine.java:140)\r\n\tat io.temporal.internal.statemachines.StateMachine.handleHistoryEvent(StateMachine.java:101)\r\n\tat io.temporal.internal.statemachines.EntityStateMachineBase.handleEvent(EntityStateMachineBase.java:67)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleLocalActivityMarker(WorkflowStateMachines.java:482)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleCommandEvent(WorkflowStateMachines.java:292)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleSingleEvent(WorkflowStateMachines.java:250)\r\n\tat io.temporal.internal.statemachines.WorkflowStateMachines.handleEventsBatch(WorkflowStateMachines.java:221)\r\n\t... 12 more\r\n\r\n\tat io.grpc.stub.ClientCalls.toStatusRuntimeException(ClientCalls.java:271)\r\n\tat io.grpc.stub.ClientCalls.getUnchecked(ClientCalls.java:252)\r\n\tat io.grpc.stub.ClientCalls.blockingUnaryCall(ClientCalls.java:165)\r\n\tat io.temporal.api.workflowservice.v1.WorkflowServiceGrpc$WorkflowServiceBlockingStub.queryWorkflow(WorkflowServiceGrpc.java:3135)\r\n\tat io.temporal.internal.client.external.GenericWorkflowClientExternalImpl.lambda$query$5(GenericWorkflowClientExternalImpl.java:220)\r\n\tat io.temporal.internal.retryer.GrpcSyncRetryer.retry(GrpcSyncRetryer.java:61)\r\n\tat io.temporal.internal.retryer.GrpcRetryer.retryWithResult(GrpcRetryer.java:51)\r\n\tat io.temporal.internal.client.external.GenericWorkflowClientExternalImpl.query(GenericWorkflowClientExternalImpl.java:213)\r\n\tat io.temporal.internal.client.RootWorkflowClientInvoker.query(RootWorkflowClientInvoker.java:141)\r\n\tat io.temporal.internal.sync.WorkflowStubImpl.query(WorkflowStubImpl.java:324)\r\n\t... 18 more\r\n```\r\n\r\n## Root cause\r\n\r\nThe way Test Server forms a `PollWorkflowTaskResponse` for a legacy query during replay makes SDK state machines think that the last workflow task is actually getting executed for the first time instead of being replayed (`previousStartedEventId` and `startedEventId` have the same values as the last executed workflow task) causing a failure when SDK tries to actually match already existing events with commands. This issue appears specifically with the LocalActivity state machine.","closedAt":"2022-05-09T18:42:46Z","comments":[],"createdAt":"2022-05-06T20:31:13Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzE5ODQx","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":14,"title":"1.12.0","description":"","dueOn":"2022-05-19T00:00:00Z"},"number":1190,"reactionGroups":[],"state":"CLOSED","title":"Test Server Query for non-cached execution causes SDK state machines problem","updatedAt":"2022-05-09T18:42:46Z","url":"https://github.com/temporalio/sdk-java/issues/1190"}
