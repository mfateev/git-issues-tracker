{"assignees":[],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"## Test\r\n\r\n```\r\n@WorkflowInterface\r\npublic interface TestWorkflow {\r\n    @WorkflowMethod\r\n    String workflow(String input);\r\n}\r\n\r\npublic static class ActivityWorkflow implements TestWorkflow {\r\n    private final TestActivity1 activity1 =\r\n        Workflow.newLocalActivityStub(\r\n            TestActivity1.class,\r\n            LocalActivityOptions.newBuilder()\r\n                ...\r\n                .build());\r\n\r\n    @Override\r\n    public String workflow(String input) {return activity1.activity1(input);}\r\n}\r\n\r\n@ActivityInterface\r\npublic interface TestActivity1 {\r\n    String activity1(String input);\r\n}\r\n\r\nprivate static class Activity1Impl implements TestActivity1 {\r\n    @Override\r\n    public String activity1(String input) {return Workflow.randomUUID().toString();}\r\n}\r\n\r\n@Test\r\npublic void trivialTest() {\r\n    Worker worker = testEnvironment.newWorker(TASK_QUEUE);\r\n    worker.registerWorkflowImplementationTypes(ActivityWorkflow.class);\r\n    worker.registerActivitiesImplementations(new Activity1Impl());\r\n\r\n    testEnvironment.start();\r\n    WorkflowClient client = testEnvironment.getWorkflowClient();\r\n    WorkflowOptions options =\r\n        WorkflowOptions.newBuilder()\r\n            ...\r\n            .build();\r\n\r\n    TestWorkflow workflow = client.newWorkflowStub(TestWorkflow.class, options);\r\n    workflow.workflow(UUID.randomUUID().toString());\r\n  }\r\n```\r\n\r\n## Expected Behavior\r\n\r\nMeaningful original exception from calling Workflow method from Activity (java.lang.Error: Called from non workflow or workflow callback thread)\r\n\r\n## Actual Behavior\r\n\r\nThe root cause is completely lost and overridden by incorrect handling inside `POJOActivityInboundCallsInterceptor#execute`. The actual exception:\r\n```\r\nCaused by: io.temporal.failure.ApplicationFailure: message='java.lang.Error cannot be cast to java.lang.Exception', type='java.lang.ClassCastException', nonRetryable=false\r\n\tat io.temporal.internal.sync.POJOActivityTaskHandler$POJOActivityInboundCallsInterceptor.execute(POJOActivityTaskHandler.java:263)\r\n\tat io.temporal.internal.sync.POJOActivityTaskHandler$POJOLocalActivityImplementation.execute(POJOActivityTaskHandler.java:298)\r\n\tat io.temporal.internal.sync.POJOActivityTaskHandler.handle(POJOActivityTaskHandler.java:185)\r\n\tat io.temporal.internal.worker.LocalActivityWorker$TaskHandlerImpl.handleLocalActivity(LocalActivityWorker.java:248)\r\n\tat io.temporal.internal.worker.LocalActivityWorker$TaskHandlerImpl.handleLocalActivity(LocalActivityWorker.java:289)\r\n\tat io.temporal.internal.worker.LocalActivityWorker$TaskHandlerImpl.handleLocalActivity(LocalActivityWorker.java:289)\r\n\tat io.temporal.internal.worker.LocalActivityWorker$TaskHandlerImpl.handle(LocalActivityWorker.java:202)\r\n\tat io.temporal.internal.worker.LocalActivityWorker$TaskHandlerImpl.handle(LocalActivityWorker.java:191)\r\n\tat io.temporal.internal.worker.PollTaskExecutor.lambda$process$0(PollTaskExecutor.java:73)\r\n\t... 3 common frames omitted\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nFind the full test here:\r\nhttps://github.com/Spikhalskiy/java-sdk/commit/d43873e985b68521e3da2ebdb2e54f3dcda9b222\r\n\r\n## Specifications\r\n\r\n  - Version: 0.28.0 and current master (https://github.com/temporalio/java-sdk/tree/35abfd425c13e86f16b81e26c85c07b17ee3448f)\r\n\r\n## Proposed improvement\r\n\r\nTemporal code and error handling can greatly benefit from creation of an Error subclass for Temporal Exceptions that need to be propagated thru exception handling. It will also make it possible to handle the temporal errors in such exception handling blocks. Right now all Errors have to be intercepted in the `POJOActivityInboundCallsInterceptor#execute` to fix this issue and this is not a right way.","closedAt":"2020-08-21T22:44:28Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDY3ODU0NTc3NA==","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"Thanks a lot for the report and the repro. Resolving as it is fixed in #190 ","createdAt":"2020-08-21T22:44:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/185#issuecomment-678545774","viewerDidAuthor":true}],"createdAt":"2020-08-18T03:57:29Z","labels":[],"milestone":null,"number":185,"reactionGroups":[],"state":"CLOSED","title":"Incorrect Temporal Error handling in POJOActivityInboundCallsInterceptor","updatedAt":"2020-08-21T22:44:28Z","url":"https://github.com/temporalio/sdk-java/issues/185"}
