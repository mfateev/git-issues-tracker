{"assignees":[],"author":{"id":"MDQ6VXNlcjc2OTk2Nzky","is_bot":false,"login":"hedonihilist","name":""},"body":"## Expected Behavior\r\n\r\nWhen `workers-auto-discovery` is configured and `@Profile` annotation is used on top of `@WorkflowImpl`, if the profile condition doesn't match, the workflow should not be used.\r\n\r\n## Actual Behavior\r\n\r\nRegardless of the condition in `@Profile` all classes annotated with `@WorkflowImpl` will be used.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Create a workflow and its implementation SomeWorkflowImpl\r\n  1. Annotate SomeWorkflowImpl with `@WorkflowImpl` and `@Profile(\"!local\")`\r\n  1. Run the application with `local` spring profile. The SomeWorkflowImpl can still be discovered and workers will be created.\r\n\r\n## Specifications\r\n\r\n  - Version: temporal-spring-boot-autoconfigure-alpha-1.18.2.jar\r\n  - Platform: mac\r\n\r\n## Some investigations\r\n\r\nClassPathScanningCandidateComponentProvider is used to scan the package to find workflows.\r\n\r\n```\r\n  private Collection<Class<?>> autoDiscoverWorkflowImplementations() {\r\n    ClassPathScanningCandidateComponentProvider scanner =\r\n        new ClassPathScanningCandidateComponentProvider(false);\r\n    scanner.addIncludeFilter(new AnnotationTypeFilter(WorkflowImpl.class));\r\n    Set<Class<?>> implementations = new HashSet<>();\r\n    for (String pckg : properties.getWorkersAutoDiscovery().getPackages()) {\r\n      Set<BeanDefinition> candidateComponents = scanner.findCandidateComponents(pckg);\r\n      for (BeanDefinition beanDefinition : candidateComponents) {\r\n        try {\r\n          implementations.add(Class.forName(beanDefinition.getBeanClassName()));\r\n        } catch (ClassNotFoundException e) {\r\n          throw new BeanDefinitionValidationException(\r\n              \"Fail loading class for bean definition \" + beanDefinition, e);\r\n        }\r\n      }\r\n    }\r\n    return implementations;\r\n  }\r\n```\r\n\r\nBut it seems the Environment is not passed in. According to [spring doc](https://docs.spring.io/spring-framework/docs/4.0.0.M1_to_4.2.0.M2/Spring%20Framework%204.2.0.M2/org/springframework/context/annotation/ClassPathScanningCandidateComponentProvider.html)\r\nThe Environment is need to evaluate `@Conditional` annotations.\r\n<img width=\"733\" alt=\"image\" src=\"https://github.com/temporalio/sdk-java/assets/76996792/4ad180c3-7df9-4cda-87b6-b61cbbda3790\">\r\n","closedAt":"2025-05-05T16:08:02Z","comments":[{"id":"IC_kwDODN12PM6ChBMQ","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"`Profile` effects what `beans` are included, technically workflow classes are not `beans` by intention, but I think it would be resonable here to respect `Profile`. Are you aware of any other spring boot projects that apply `Profile` to non beans?","createdAt":"2024-06-25T18:30:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2121#issuecomment-2189693712","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6Cx8fA","author":{"login":"hedonihilist"},"authorAssociation":"NONE","body":"> Are you aware of any other spring boot projects that apply Profile to non beans?\r\n\r\nNo I haven't know whether there're such projects. I am not saying we should do that but there seems to be missing some Spring-aware configurations to dynamically disable some task queue/workers. Maybe This can be achieved by some configuration beans before starting the workers?\r\n\r\nWhat I am doing now is set the auto start worker to false, and manually register the conditional workers to worker factory. Maybe this kind of operations can be configured by some beans?","createdAt":"2024-06-27T08:46:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2121#issuecomment-2194130880","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6CyQWB","author":{"login":"hedonihilist"},"authorAssociation":"NONE","body":"Or could you give me some advice here on what's the recommend way to conditionally enable/disable workflows?","createdAt":"2024-06-27T09:27:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2121#issuecomment-2194212225","viewerDidAuthor":false},{"id":"IC_kwDODN12PM6DVSlj","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Your options currently are to use [explicit configuration](https://github.com/temporalio/sdk-java/tree/master/temporal-spring-boot-autoconfigure#explicit-configuration) or put them in separate packages","createdAt":"2024-07-02T14:38:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-java/issues/2121#issuecomment-2203396451","viewerDidAuthor":false}],"createdAt":"2024-06-21T09:04:43Z","labels":[],"milestone":null,"number":2121,"reactionGroups":[],"state":"CLOSED","title":"@Profile annotation is not working on @WorkflowImpl with `workers-auto-discovery`","updatedAt":"2025-05-05T16:08:02Z","url":"https://github.com/temporalio/sdk-java/issues/2121"}
