{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNTA0MDQ5","is_bot":false,"login":"Quinn-With-Two-Ns","name":"Quinn Klassen"},"body":"## Expected Behavior\r\nTest server treats internal errors from nexus operations as retryable\r\n\r\n## Actual Behavior\r\nTest server treats internal errors from nexus operations as non-retryable\r\n\r\n## Steps to Reproduce the Problem\r\n```\r\npackage io.temporal.workflow.nexus;\r\n\r\nimport static org.junit.Assume.assumeTrue;\r\n\r\nimport io.nexusrpc.handler.OperationHandler;\r\nimport io.nexusrpc.handler.OperationImpl;\r\nimport io.nexusrpc.handler.ServiceImpl;\r\nimport io.temporal.client.WorkflowFailedException;\r\nimport io.temporal.failure.NexusOperationFailure;\r\nimport io.temporal.failure.TimeoutFailure;\r\nimport io.temporal.testing.internal.SDKTestWorkflowRule;\r\nimport io.temporal.workflow.*;\r\nimport io.temporal.workflow.shared.TestNexusServices;\r\nimport io.temporal.workflow.shared.TestWorkflows;\r\nimport java.time.Duration;\r\nimport org.junit.Assert;\r\nimport org.junit.Before;\r\nimport org.junit.Rule;\r\nimport org.junit.Test;\r\n\r\npublic class SyncOperationTimeoutTest extends BaseNexusTest {\r\n  @Rule\r\n  public SDKTestWorkflowRule testWorkflowRule =\r\n      SDKTestWorkflowRule.newBuilder()\r\n          .setWorkflowTypes(TestNexus.class)\r\n          .setNexusServiceImplementation(new TestNexusServiceImpl())\r\n          .build();\r\n\r\n  @Override\r\n  protected SDKTestWorkflowRule getTestWorkflowRule() {\r\n    return testWorkflowRule;\r\n  }\r\n\r\n  @Test\r\n  public void typedOperationTimeout() {\r\n    TestWorkflows.TestWorkflow1 workflowStub =\r\n        testWorkflowRule.newWorkflowStubTimeoutOptions(TestWorkflows.TestWorkflow1.class);\r\n    WorkflowFailedException exception =\r\n        Assert.assertThrows(WorkflowFailedException.class, () -> workflowStub.execute(\"\"));\r\n    Assert.assertTrue(exception.getCause() instanceof NexusOperationFailure);\r\n    NexusOperationFailure nexusFailure = (NexusOperationFailure) exception.getCause();\r\n    Assert.assertTrue(nexusFailure.getCause() instanceof TimeoutFailure);\r\n    TimeoutFailure timeoutFailure = (TimeoutFailure) nexusFailure.getCause();\r\n    Assert.assertEquals(\"operation timed out\", timeoutFailure.getOriginalMessage());\r\n  }\r\n\r\n  public static class TestNexus implements TestWorkflows.TestWorkflow1 {\r\n    @Override\r\n    public String execute(String input) {\r\n      NexusOperationOptions options =\r\n          NexusOperationOptions.newBuilder()\r\n              .setScheduleToCloseTimeout(Duration.ofSeconds(1))\r\n              .build();\r\n      NexusServiceOptions serviceOptions =\r\n          NexusServiceOptions.newBuilder()\r\n              .setEndpoint(getEndpointName())\r\n              .setOperationOptions(options)\r\n              .build();\r\n      // Try to call a synchronous operation in a blocking way\r\n      TestNexusServices.TestNexusService1 serviceStub =\r\n          Workflow.newNexusServiceStub(TestNexusServices.TestNexusService1.class, serviceOptions);\r\n      return serviceStub.operation(\"test timeout\");\r\n    }\r\n  }\r\n\r\n  @ServiceImpl(service = TestNexusServices.TestNexusService1.class)\r\n  public class TestNexusServiceImpl {\r\n    @OperationImpl\r\n    public OperationHandler<String, String> operation() {\r\n      // Implemented inline\r\n      return OperationHandler.sync(\r\n          (ctx, details, name) -> {\r\n            throw new RuntimeException(\"failed to call operation\");\r\n          });\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n","closedAt":"2024-09-17T16:20:18Z","comments":[],"createdAt":"2024-09-14T04:55:56Z","labels":[],"milestone":null,"number":2215,"reactionGroups":[],"state":"CLOSED","title":"Test Server does not treat internal errors as retryable from Nexus operations ","updatedAt":"2024-09-17T16:20:18Z","url":"https://github.com/temporalio/sdk-java/issues/2215"}
