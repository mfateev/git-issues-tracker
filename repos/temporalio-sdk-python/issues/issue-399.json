{"assignees":[],"author":{"id":"MDQ6VXNlcjg2NjM0Mjky","is_bot":false,"login":"devery59","name":"Kris"},"body":"### What are you really trying to do?\r\nI'm Using Temporal on EKS Cluster and I try to connect temporal in other application and run workflow. When I use custom @dataclass as return value of activity, \"Failed decoding arguments\" error has occured. \r\n<!-- \r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\n-->\r\n\r\n### Describe the bug\r\n\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n\r\n```\r\n{\r\n  \"message\": \"Failed decoding arguments\",\r\n  \"source\": \"\",\r\n  \"stackTrace\": \"  File \\\"/usr/local/lib/python3.9/site-packages/temporalio/worker/_workflow_instance.py\\\", line 301, in activate\\n    self._apply(job)\\n\\n  File \\\"/usr/local/lib/python3.9/site-packages/temporalio/worker/_workflow_instance.py\\\", line 373, in _apply\\n    self._apply_resolve_activity(job.resolve_activity)\\n\\n  File \\\"/usr/local/lib/python3.9/site-packages/temporalio/worker/_workflow_instance.py\\\", line 490, in _apply_resolve_activity\\n    ret_vals = self._convert_payloads(\\n\\n  File \\\"/usr/local/lib/python3.9/site-packages/temporalio/worker/_workflow_instance.py\\\", line 1232, in _convert_payloads\\n    raise RuntimeError(\\\"Failed decoding arguments\\\") from err\\n\",\r\n  \"encodedAttributes\": null,\r\n  \"cause\": {\r\n    \"message\": \"<Custom dataclass path>\",\r\n    \"source\": \"\",\r\n    \"stackTrace\": \"  File \\\"/usr/local/lib/python3.9/site-packages/temporalio/worker/_workflow_instance.py\\\", line 1224, in _convert_payloads\\n    return self._payload_converter.from_payloads(\\n\\n  File \\\"/usr/local/lib/python3.9/site-packages/temporalio/converter.py\\\", line 307, in from_payloads\\n    values.append(converter.from_payload(payload, type_hint))\\n\\n  File \\\"/usr/local/lib/python3.9/site-packages/temporalio/converter.py\\\", line 569, in from_payload\\n    obj = value_to_type(type_hint, obj, self._custom_type_converters)\\n\\n  File \\\"/usr/local/lib/python3.9/site-packages/temporalio/converter.py\\\", line 1361, in value_to_type\\n    field_hints = get_type_hints(hint)\\n\\n  File \\\"/usr/local/lib/python3.9/typing.py\\\", line 1450, in get_type_hints\\n    base_globals = sys.modules[base.__module__].__dict__\\n\\n  File \\\"/usr/local/lib/python3.9/site-packages/temporalio/worker/workflow_sandbox/_importer.py\\\", line 393, in __getitem__\\n    return self.current[key]\\n\",\r\n    \"encodedAttributes\": null,\r\n    \"cause\": null,\r\n    \"applicationFailureInfo\": {\r\n      \"type\": \"KeyError\",\r\n      \"nonRetryable\": false,\r\n      \"details\": null\r\n    }\r\n  },\r\n  \"applicationFailureInfo\": {\r\n    \"type\": \"RuntimeError\",\r\n    \"nonRetryable\": false,\r\n    \"details\": null\r\n  }\r\n}\r\n``` \r\n\r\n### Minimal Reproduction\r\n\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\nThis is my execution code.\r\n```\r\nasync with Worker(\r\n        client,\r\n        task_queue=TASK_QUEUE_NAME,\r\n        workflows=[test_workflow],\r\n        activities=[get_request_s3_dir],\r\n    ):\r\n\r\n        await client.execute_workflow(\r\n            test_workflow.run,\r\n            request,\r\n            id=REQUEST_ID,\r\n            task_queue=TASK_QUEUE_NAME,\r\n            retry_policy=RetryPolicy(maximum_interval=timedelta(seconds=2), maximum_attempts=3),\r\n        )\r\n``` \r\n\r\nThis is my workflow code.\r\n```\r\n@workflow.defn\r\nclass test_workflow:\r\n \r\n    @workflow.run\r\n    async def run(self, request: requestDataClass):\r\n        request_s3_dir = await workflow.execute_activity(\r\n            get_request_s3_dir,\r\n            args = [BUCKET_NAME, request.request_id],\r\n            start_to_close_timeout=timedelta(seconds=15),\r\n        )\r\n``` \r\nThis is my activity code.\r\n```\r\n@activity.defn\r\nasync def get_request_s3_dir(bucket_name: str, request_id: str) -> customDataClass:\r\n    uri = f\"s3://{bucket_name}/{request_id}\"\r\n    return customDataClass.from_uri(uri) \r\n``` \r\nThis is my custom dataclass code.\r\n```\r\n@dataclass\r\nclass customDataClass:\r\n    uri: str\r\n    bucket_name: str\r\n    object_key: str\r\n\r\n    @classmethod\r\n    def from_uri(cls, uri: str):\r\n        ...\r\n        return cls(uri, bucket_name, object_key)\r\n``` \r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: Make Docker image and run pod in EKS\r\n- Temporal Version: 2.16.2(on my web) & temporalio == 1.3.0\r\n- base Image of Docker : python:3.9-slim-buster \r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n\r\n1. I'm using python 3.9 version to test on EKS. But when i use python 3.11 version as my Base Image or python setting there is no issue. Is there any difference between python 3.9 version's temporal env and 3.11 version's temporal env? ( I checked pip list versions. requirements version is same)\r\n2. I know if i use in my workflow like below...\r\n```\r\nin python 3.9 verison ( above problem is solved)\r\nwith workflow.unsafe.imports_passed_through():\r\n    from file import customDataClass\r\n``` \r\n```\r\nin python 3.11 verison\r\n < no need to import >\r\n``` \r\n\r\n3. Let me know what is stable python version when i use temporal cluster and is there any best way to use pattern like this?\r\n\r\n\r\nThanks for your all effort.","closedAt":null,"comments":[{"id":"IC_kwDOGusT1c5o3-9K","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> \\<Custom dataclass path>\r\n\r\nIs the full error message just a path to the data class? Can I get the _exact_ error message?\r\n\r\n> Is there any difference between python 3.9 version's temporal env and 3.11 version's temporal env?\r\n\r\nNone in our code, but Python may have changed how imports work between the two\r\n\r\n> I know if i use in my workflow like below...\r\n\r\nSo it appears in newer Python versions the sandbox importer can import your dataclass but in older Python versions you have to import it yourself\r\n\r\n> Minimal Reproduction\r\n\r\nIt may be easier with a full replication instead of just snippets, but I may have the idea here.\r\n\r\nRegardless, I will see if I can investigate this. In the meantime, import the custom data class yourself as you have shown. Or upgrade to your Python version.\r\n\r\n\r\n","createdAt":"2023-10-12T12:24:58Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/399#issuecomment-1759506250","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5o8kkk","author":{"login":"devery59"},"authorAssociation":"NONE","body":"@cretz \r\nThanks for reply! \r\n\r\n> Is the full error message just a path to the data class? Can I get the exact error message?\r\n\r\nYes error message just a path to the data class\r\n\r\n> Regardless, I will see if I can investigate this. In the meantime, import the custom data class yourself as you have shown. Or upgrade to your Python version.\r\n\r\nThanks for your comment! I expect specific reason of above issue. Let me know if there is another thought.\r\n","createdAt":"2023-10-13T03:32:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/399#issuecomment-1760708900","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5pqMEd","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Is it possible to provide a standalone replication? Maybe alter https://github.com/temporalio/samples-python/blob/main/hello/hello_activity.py until you can replicate the failure? (feel free to separate out to multiple files)","createdAt":"2023-10-20T12:38:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/399#issuecomment-1772667165","viewerDidAuthor":false}],"createdAt":"2023-10-12T01:56:27Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":399,"reactionGroups":[{"content":"ROCKET","users":{"totalCount":1}}],"state":"OPEN","title":"[Bug] Older Python versions cannot auto-import activity return class in sandbox","updatedAt":"2023-10-20T12:38:56Z","url":"https://github.com/temporalio/sdk-python/issues/399"}
