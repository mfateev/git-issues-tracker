{"assignees":[],"author":{"id":"MDQ6VXNlcjExNzgzNzA=","is_bot":false,"login":"jmdacruz","name":"Marcelo Da Cruz Pinto"},"body":"### What are you really trying to do?\r\n\r\nI'm trying to use structured logging with the Python SDK, using the `extra` attributes to provide more context to log entries. The Python SDK seems to honor existing attributes when adding the activity/workflow contextual info: https://github.com/temporalio/sdk-python/blob/1fa36c2437eaa35c0d81a0339caf4960b37f1bb6/temporalio/activity.py#L374-L376\r\n\r\n### Describe the bug\r\n\r\nWhen enabling basic logging for one of the Python samples, using a format string that references an `extra` attribute that is provided in all log entries (on workflow, activity, and main entry point for the app), the logging calls inside the workflow and activities raises a `KeyError` exception because it can't find the attribute. The same logging call on the `main()` entry point works just fine\r\n\r\n### Minimal Reproduction\r\n\r\nOn the https://github.com/temporalio/samples-python repo, apply the following diff (to file `hello/hello_activity.py`):\r\n\r\n```patch\r\ndiff --git a/hello/hello_activity.py b/hello/hello_activity.py\r\nindex 6615b55..e7716ef 100644\r\n--- a/hello/hello_activity.py\r\n+++ b/hello/hello_activity.py\r\n@@ -20,7 +20,8 @@ class ComposeGreetingInput:\r\n # Basic activity that logs and does string concatenation\r\n @activity.defn\r\n async def compose_greeting(input: ComposeGreetingInput) -> str:\r\n-    activity.logger.info(\"Running activity with parameter %s\" % input)\r\n+    # Logging a record with extra attribute \"foo\" here causes a \"KeyError\" exception\r\n+    activity.logger.info(\"Running activity with parameter %s\" % input, extra={\"foo\": \"in activity\"})\r\n     return f\"{input.greeting}, {input.name}!\"\r\n \r\n \r\n@@ -29,7 +30,8 @@ async def compose_greeting(input: ComposeGreetingInput) -> str:\r\n class GreetingWorkflow:\r\n     @workflow.run\r\n     async def run(self, name: str) -> str:\r\n-        workflow.logger.info(\"Running workflow with parameter %s\" % name)\r\n+        # Logging a record with extra attribute \"foo\" here causes a \"KeyError\" exception\r\n+        workflow.logger.info(\"Running workflow with parameter %s\" % name, extra={\"foo\": \"in workflow\"})\r\n         return await workflow.execute_activity(\r\n             compose_greeting,\r\n             ComposeGreetingInput(\"Hello\", name),\r\n@@ -39,7 +41,12 @@ class GreetingWorkflow:\r\n \r\n async def main():\r\n     # Uncomment the line below to see logging\r\n-    # logging.basicConfig(level=logging.INFO)\r\n+    # Including attribute \"foo\" on the log format\r\n+    logging.basicConfig(level=logging.INFO, format=\"--- %(message)s --- %(foo)s\")\r\n+\r\n+    # Logging a record with extra attribute \"foo\" here works fine\r\n+    logger = logging.getLogger(\"root\")\r\n+    logger.info(\"logging in main\", extra={\"foo\": \"in main\"})\r\n \r\n     # Start client\r\n     client = await Client.connect(\"localhost:7233\")\r\n```\r\n\r\nRun the example against temporalite, started like:\r\n```shell\r\ntemporalite start --ephemeral --namespace=default\r\n```\r\n\r\nThe expected result is that all 3 log entries are printed, with the `foo` attribute. The actual result is that only the entry generated by the `main()` function is printed, and the two entries on the workflow and activity fail with a `KeyError` exception when trying to index the `foo` attribute.\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: Intel Mac, Monterey\r\n- Temporal Version: temporalite version (devel) (server 1.19.1), Python SDK with latest commit https://github.com/temporalio/samples-python/commit/a4f0a05b64c2171332c88f3b595bed03b1623ab6\r\n- Are you using Docker or Kubernetes or building Temporal from source?: No, running directly with Python 3.10 and 3.11, using temporalite\r\n\r\n","closedAt":"2023-02-17T01:02:35Z","comments":[{"id":"IC_kwDOGusT1c5VQjby","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Confirmed, this is caused by us calling calling `super.process()` in our logging adapter which does override `extra`: https://github.com/python/cpython/blob/aad5f6a89125ad4529ab6ed5add693064351df1a/Lib/logging/__init__.py#L1825. Will fix.","createdAt":"2023-02-14T21:29:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/276#issuecomment-1430402802","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5VU8U8","author":{"login":"jmdacruz"},"authorAssociation":"CONTRIBUTOR","body":"@cretz I can create a PR removing those calls on all the LoggerAdapters.","createdAt":"2023-02-15T15:30:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/276#issuecomment-1431553340","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5VVJfx","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@jmdacruz - Sure, would be much appreciated! Otherwise I was gonna get to it probably early next week","createdAt":"2023-02-15T16:04:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/276#issuecomment-1431607281","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5VWA30","author":{"login":"jmdacruz"},"authorAssociation":"CONTRIBUTOR","body":"@cretz I'm taking a stab at this by adding a common `LoggerAdapter` that changes the default behavior of the `process(...)` method by adding the `self.extra` attributes to the `kwargs[\"extra\"]` (if this is there, else reverts to the current behavior). This is overkill now, because the singleton instance of the adapter is created with `extra=None`, but it could prove useful in the future if you decide to add extra attributes on the singleton.\r\n\r\nDo you think this makes sense, or should I just remove the calls to `super.process(...)`?","createdAt":"2023-02-15T18:37:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/276#issuecomment-1431834100","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5VWazK","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Just remove the super call","createdAt":"2023-02-15T19:54:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/276#issuecomment-1431940298","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5VW2P_","author":{"login":"jmdacruz"},"authorAssociation":"CONTRIBUTOR","body":"Done, creating PR now","createdAt":"2023-02-15T21:23:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/276#issuecomment-1432052735","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6v1BAZ","author":{"login":"danmarinescu"},"authorAssociation":"NONE","body":"While https://github.com/temporalio/sdk-python/pull/280 did fix the issue above it causes another problem. Say I create a logger like this\n```\nlogger = workflow.LoggerAdapter(logging.getLogger(__name__), extra={'some_key':'some_val'})\n```\nthen when the current implementation of `process` is called the extra dict set on the LoggerAdapter will not be included. See for reference the [implementation](https://github.com/python/cpython/blob/3.13/Lib/logging/__init__.py#L1890-L1904) in the `LoggerAdapter` superclass:\n```\nif self.merge_extra and \"extra\" in kwargs:\n    kwargs[\"extra\"] = {**self.extra, **kwargs[\"extra\"]}\nelse:\n    kwargs[\"extra\"] = self.extra\nreturn msg, kwargs\n```\n\nYou can see that since we're no longer calling `super.process()` we are also using `self.extra`. \n\nImo the right fix here would be to:\n- change the `LoggerAdapter` initializer implementation in Temporal to accept a `merge_extra` param like the superclass\n- revert the above fix, i.e. call `super.process()` at the start of the `process` method","createdAt":"2025-06-06T17:11:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/276#issuecomment-2949910553","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6v4GmB","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks! When this issue was solved there was no `merge_extra`.\n\n> Imo the right fix here would be to:\n> * change the LoggerAdapter initializer implementation in Temporal to accept a merge_extra param like the superclass\n> * revert the above fix, i.e. call super.process() at the start of the process method\n\nWe can't really call super and have this problem solved because `merge_extra` was only added in Python 3.13 and we support more versions than that. Arguably we should have never accepted `extra` in the constructor and instead told users that if they wanted extra data, they needed to subclass and override `process` instead of instantiating.\n\nIt sounds like we may need to support our own form of `merge_extra` and default it to `False` which will continue to do the same behavior as today. Or maybe we should only support merge_extra in newer Python versions. I have opened #892.\n\nIn the meantime, I would recommend subclassing and overriding `process` to get the extra data needed. \n","createdAt":"2025-06-06T20:26:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/276#issuecomment-2950719873","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6wZJvH","author":{"login":"danmarinescu"},"authorAssociation":"NONE","body":"Thanks @cretz, that makes sense. Indeed subclassing and overriding `process` is what I did to work around the issue.","createdAt":"2025-06-10T14:02:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/276#issuecomment-2959383495","viewerDidAuthor":false}],"createdAt":"2023-02-14T19:22:21Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":276,"reactionGroups":[],"state":"CLOSED","title":"[Bug] logging adapter does not include extra attributes?","updatedAt":"2025-06-10T14:02:05Z","url":"https://github.com/temporalio/sdk-python/issues/276"}
