{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"### Describe the bug\r\n\r\nSometimes on Python 3.8, there is this test failure:\r\n\r\n```\r\ntests/worker/test_replayer.py::test_replayer_workflow_incomplete - RuntimeError: Failed validating workflow SayHelloWorkflow\r\n```\r\n\r\nHere is the full logged exception:\r\n\r\n```\r\n______________________ test_replayer_workflow_incomplete _______________________\r\n\r\n>   import asyncio\r\n\r\ntests/worker/test_replayer.py:1: \r\n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \r\ntemporalio/worker/workflow_sandbox/_importer.py:441: in __call__\r\n    return self.current(*args, **kwargs)\r\ntemporalio/worker/workflow_sandbox/_importer.py:234: in _import\r\n    mod = importlib.__import__(name, globals, locals, fromlist, level)\r\n<frozen importlib._bootstrap>:1093: in __import__\r\n    ???\r\n<frozen importlib._bootstrap>:1014: in _gcd_import\r\n    ???\r\n<frozen importlib._bootstrap>:991: in _find_and_load\r\n    ???\r\n<frozen importlib._bootstrap>:961: in _find_and_load_unlocked\r\n    ???\r\n<frozen importlib._bootstrap>:219: in _call_with_frames_removed\r\n    ???\r\n<frozen importlib._bootstrap>:1014: in _gcd_import\r\n    ???\r\n<frozen importlib._bootstrap>:991: in _find_and_load\r\n    ???\r\n<frozen importlib._bootstrap>:975: in _find_and_load_unlocked\r\n    ???\r\n<frozen importlib._bootstrap>:671: in _load_unlocked\r\n    ???\r\n<frozen importlib._bootstrap_external>:843: in exec_module\r\n    ???\r\n<frozen importlib._bootstrap>:219: in _call_with_frames_removed\r\n    ???\r\n../../../.cache/pypoetry/virtualenvs/temporalio-s8Ez09FR-py3.8/lib/python3.8/site-packages/_pytest/assertion/__init__.py:9: in <module>\r\n    from _pytest.assertion import rewrite\r\ntemporalio/worker/workflow_sandbox/_importer.py:441: in __call__\r\n    return self.current(*args, **kwargs)\r\ntemporalio/worker/workflow_sandbox/_importer.py:234: in _import\r\n    mod = importlib.__import__(name, globals, locals, fromlist, level)\r\n<frozen importlib._bootstrap>:1113: in __import__\r\n    ???\r\n<frozen importlib._bootstrap>:1042: in _handle_fromlist\r\n    ???\r\n<frozen importlib._bootstrap>:219: in _call_with_frames_removed\r\n    ???\r\n<frozen importlib._bootstrap>:1014: in _gcd_import\r\n    ???\r\n<frozen importlib._bootstrap>:991: in _find_and_load\r\n    ???\r\n<frozen importlib._bootstrap>:975: in _find_and_load_unlocked\r\n    ???\r\n<frozen importlib._bootstrap>:671: in _load_unlocked\r\n    ???\r\n<frozen importlib._bootstrap_external>:843: in exec_module\r\n    ???\r\n<frozen importlib._bootstrap>:219: in _call_with_frames_removed\r\n    ???\r\n../../../.cache/pypoetry/virtualenvs/temporalio-s8Ez09FR-py3.8/lib/python3.8/site-packages/_pytest/assertion/rewrite.py:32: in <module>\r\n    from _pytest._io.saferepr import DEFAULT_REPR_MAX_SIZE\r\n        self._on_eviction_hook = on_eviction_hook\r\n        self._disable_safe_eviction = disable_safe_eviction\r\n        self._throw_after_activation: Optional[Exception] = None\r\n    \r\n        # If there's a debug mode or a truthy TEMPORAL_DEBUG env var, disable\r\n        # deadlock detection, otherwise set to 2 seconds\r\n        self._deadlock_timeout_seconds = (\r\n            None if debug_mode or os.environ.get(\"TEMPORAL_DEBUG\") else 2\r\n        )\r\n    \r\n        # Keep track of workflows that could not be evicted\r\n        self._could_not_evict_count = 0\r\n    \r\n        # Set the worker-level failure exception types into the runner\r\n        workflow_runner.set_worker_level_failure_exception_types(\r\n            workflow_failure_exception_types\r\n        )\r\n    \r\n        # Validate and build workflow dict\r\n        self._workflows: Dict[str, temporalio.workflow._Definition] = {}\r\n        self._dynamic_workflow: Optional[temporalio.workflow._Definition] = None\r\n        for workflow in workflows:\r\n            defn = temporalio.workflow._Definition.must_from_class(workflow)\r\n            # Confirm name unique\r\n            if defn.name in self._workflows:\r\n                raise ValueError(f\"More than one workflow named {defn.name}\")\r\n            # Prepare the workflow with the runner (this will error in the\r\n            # sandbox if an import fails somehow)\r\n            try:\r\n                if defn.sandboxed:\r\n                    workflow_runner.prepare_workflow(defn)\r\n                else:\r\n                    unsandboxed_workflow_runner.prepare_workflow(defn)\r\n            except Exception as err:\r\n>               raise RuntimeError(f\"Failed validating workflow {defn.name}\") from err\r\nE               RuntimeError: Failed validating workflow SayHelloWorkflow\r\n\r\ntemporalio/worker/_workflow.py:130: RuntimeError\r\n```\r\n\r\nI suspect this is the previously-known issue in older Python with reimporting (https://github.com/python/cpython/issues/91351). Just opening issue for tracking.","closedAt":null,"comments":[],"createdAt":"2024-07-17T17:40:48Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":585,"reactionGroups":[],"state":"OPEN","title":"[Bug] Test flake, may be sandbox import issue","updatedAt":"2024-07-17T17:40:48Z","url":"https://github.com/temporalio/sdk-python/issues/585"}
