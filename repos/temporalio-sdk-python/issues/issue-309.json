{"assignees":[],"author":{"id":"MDQ6VXNlcjIxOTU2NDY3","is_bot":false,"login":"kaustav1996","name":"Kaustav Banerjee"},"body":"### What are you really trying to do?\r\n\r\nWhile running CI in our GitLab CI Pipeline we are unable to install temporalio because it is unable to find protoc-wheel-0\r\n\r\n### Describe the bug\r\n\r\nHere is our Job :\r\n```yaml\r\nmerge-request-static-analyzer:\r\n  image: sonarsource/sonar-scanner-cli:4.6\r\n  stage: sonar_analysis\r\n  before_script:\r\n    - echo \"Source -> ${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME} Target -> ${CI_MERGE_REQUEST_TARGET_BRANCH_NAME} MR -> ${CI_MERGE_REQUEST_IID}\"\r\n  script:\r\n    - ls -lah\r\n    - apk add --update --no-cache python3 postgresql-libs postgresql-dev gcc python3-dev musl-dev groff alpine-sdk bash jq curl libffi-dev openssl-dev util-linux go postgresql-client curl-dev python3-dev libressl-dev\r\n    - python3 -m ensurepip\r\n    - pip3 install --ignore-installed --no-cache --upgrade pip setuptools virtualenv bump2version==1.0.1\r\n    - rm -rf venv && virtualenv venv\r\n    - source venv/bin/activate\r\n    - pip3 install --find-links=protoc_wheel_0-21.10-py2.py3-none-any.whl protoc-wheel-0\r\n    - pip3 freeze\r\n    - pip3 install -r requirements.txt\r\n    - source ./test/environments/.prod.env\r\n    - make test.coverage\r\n    - coverage xml --fail-under 95\r\n    - sonar-scanner\r\n      -Dsonar.projectKey=zion\r\n      -Dsonar.sources=.\r\n      -Dsonar.qualitygate.wait=true\r\n      -Dsonar.exclusions=\"./deployment/**, ./test/**, ./venv/**\"\r\n      -Dsonar.login=${SONAR_LOGIN}\r\n      -Dsonar.host.url=${SONAR_HOST}\r\n      -Dsonar.pullrequest.key=${CI_MERGE_REQUEST_IID}\r\n      -Dsonar.pullrequest.branch=${CI_MERGE_REQUEST_SOURCE_BRANCH_NAME}\r\n      -Dsonar.pullrequest.base=${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}\r\n    - echo \"Done\"\r\n  artifacts:\r\n    when: always\r\n    reports:\r\n      junit: coverage.xml\r\n  only:\r\n    - merge_requests\r\n```\r\n\r\nSince we were first unable to install protoc-wheel-0 on this architecture we built the whl file and exported it using a separate docker :\r\n```Dockerfile\r\nFROM alpine:3.17\r\nRUN apk update\r\nRUN apk add --no-cache --virtual build-dependencies wget unzip gnupg libffi-dev gcc libc-dev linux-headers\r\nRUN apk add --no-cache git python3-dev py-pip bash shellcheck 'nodejs>12' openjdk11-jre curl musl-locales musl-locales-lang;\r\nRUN git clone https://gitlab.com/dfritzsche/create-protoc-wheel.git  protoc\r\nWORKDIR /protoc\r\nRUN pip install -r requirements.txt\r\nRUN python create_protoc_wheel.py 21.10\r\n\r\n```\r\n\r\nI am then going inside the container building the wheel and exporting it. Hence the line is there in the CI job to install it within the sonar container :\r\n```yaml\r\n- pip3 install --find-links=protoc_wheel_0-21.10-py2.py3-none-any.whl protoc-wheel-0\r\n```\r\n\r\nOutput when the Job runs :\r\n```bash\r\n$ source venv/bin/activate\r\n$ pip3 install --find-links=protoc_wheel_0-21.10-py2.py3-none-any.whl protoc-wheel-0\r\nLooking in links: protoc_wheel_0-21.10-py2.py3-none-any.whl\r\nProcessing ./protoc_wheel_0-21.10-py2.py3-none-any.whl\r\nInstalling collected packages: protoc-wheel-0\r\nSuccessfully installed protoc-wheel-0-21.10\r\n$ pip3 freeze\r\nprotoc-wheel-0==21.10\r\n$ pip3 install -r requirements.txt\r\n.\r\n.\r\n.\r\nCollecting temporalio==1.1.0\r\n  Downloading temporalio-1.1.0.tar.gz (851 kB)\r\n     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 851.4/851.4 kB 41.5 MB/s eta 0:00:00\r\n  Installing build dependencies: started\r\n  Installing build dependencies: finished with status 'error'\r\n  error: subprocess-exited-with-error\r\n  \r\n  × pip subprocess to install build dependencies did not run successfully.\r\n  │ exit code: 1\r\n  ╰─> [11 lines of output]\r\n      Collecting poetry-core>=1.0.0\r\n        Downloading poetry_core-1.5.2-py3-none-any.whl (465 kB)\r\n           ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 465.2/465.2 kB 8.1 MB/s eta 0:00:00\r\n      Collecting setuptools\r\n        Using cached setuptools-67.6.1-py3-none-any.whl (1.1 MB)\r\n      Collecting wheel\r\n        Using cached wheel-0.40.0-py3-none-any.whl (64 kB)\r\n      Collecting setuptools-rust\r\n        Downloading setuptools_rust-1.5.2-py3-none-any.whl (23 kB)\r\n      ERROR: Could not find a version that satisfies the requirement protoc-wheel-0 (from versions: none)\r\n      ERROR: No matching distribution found for protoc-wheel-0\r\n      [end of output]\r\n  \r\n  note: This error originates from a subprocess, and is likely not a problem with pip.\r\nerror: subprocess-exited-with-error\r\n× pip subprocess to install build dependencies did not run successfully.\r\n│ exit code: 1\r\n╰─> See above for output.\r\nnote: This error originates from a subprocess, and is likely not a problem with pip.\r\n```\r\n\r\nWhat I cannot understand is why it is not able to detect the already installed `protoc-wheel-0` even though it is mentioned in `pyproject.toml` that `^21.1` is required. :\r\n\r\n```toml\r\n[tool.poetry.dev-dependencies]\r\nprotoc-wheel-0 = \"^21.1\"\r\n```\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: `Linux runner-j2nyww-s-project-26698668-concurrent-0 5.4.109+ #1 SMP Wed Jun 16 20:00:10 PDT 2021 x86_64 Linux`\r\n- Temporal Version: `1.1.0`\r\n- Are you using Docker or Kubernetes or building Temporal from source? : `No`","closedAt":"2023-04-05T06:42:11Z","comments":[{"id":"IC_kwDOGusT1c5ZDh8N","author":{"login":"kaustav1996"},"authorAssociation":"NONE","body":"I just saw in the last line of `pyproject.toml` it says :\r\n```toml\r\nrequires = [\"poetry-core>=1.0.0\", \"setuptools\", \"wheel\", \"setuptools-rust\", \"protoc-wheel-0\"]\r\n```\r\ndoes it mean it will always try to download it and not use the one that is installed in the env?","createdAt":"2023-04-03T10:50:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/309#issuecomment-1494097677","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5ZD-zP","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"What is happening is `pip` is trying to install `temporalio` from source instead of using a prebuilt one because you are using Alpine. This uses musl instead of glibc which we don't provide pre-built package for. Then, when it tries to build it is installing dev dependencies which includes `protoc-wheel-0` which _also_ does not seem to provide a musl-based package for Alpine.\r\n\r\nWe have a couple of options here. You can stop using Alpine. If this is not an option, maybe we can make `protoc-wheel-0` an optional dev dependency. But you'll have to make `protoc` available on the `PATH` somehow because this will need to build via Rust and one of our crates requires `protoc`. Also the build will take a while. It is suggested to just use a different distro (just about any non-alpine should work) so that you don't have to build the SDK.","createdAt":"2023-04-03T12:16:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/309#issuecomment-1494215887","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5ZOlB5","author":{"login":"kaustav1996"},"authorAssociation":"NONE","body":"@cretz Thanks for the response. We found a way to use an alternate Distro and were able to install temporalio there. ","createdAt":"2023-04-05T06:41:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/309#issuecomment-1496993913","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5btRgP","author":{"login":"tynianovddi"},"authorAssociation":"NONE","body":"What should I do if i can not use any other distro apart from alpine?","createdAt":"2023-05-08T15:36:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/309#issuecomment-1538594831","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5btWWJ","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"You can attempt to build the SDK yourself with MUSL for the Rust part and it will likely work fine. We just don't distribute one. You'll have to use an alternative `protoc` approach, but that should also not be hard (we only depend on it as a dev dependency so devs don't have to manually download when building).","createdAt":"2023-05-08T15:45:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/309#issuecomment-1538614665","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5bt0h0","author":{"login":"tynianovddi"},"authorAssociation":"NONE","body":"@cretz thanks, are there any guides how to do that or some mentions how to address this issue?","createdAt":"2023-05-08T17:08:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/309#issuecomment-1538738292","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5buG2y","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"At the bottom of the README is the build guide. You'll have to research and adapt it for MUSL and to disable `protoc` Python dependency (to use your own on the `PATH`) as this is a setup we don't support by default.","createdAt":"2023-05-08T18:06:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/309#issuecomment-1538813362","viewerDidAuthor":false}],"createdAt":"2023-04-03T10:19:29Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":309,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Unable to install temporalio within [image: sonarsource/sonar-scanner-cli:4.6] container","updatedAt":"2023-05-08T18:06:37Z","url":"https://github.com/temporalio/sdk-python/issues/309"}
