{"assignees":[],"author":{"id":"MDQ6VXNlcjE0NjQ1MTk=","is_bot":false,"login":"wilsoniya","name":"Michael Wilson"},"body":"### What are you really trying to do?\r\n\r\nI'm trying use the multiprocessing/other activity execution scheme to run synchronous activities and be able to recover from undesirable but inevitable operational problems (e.g., segfault, oomkill) which result in the termination of worker child processes.\r\n\r\n### Describe the bug\r\n\r\nWhen using a [multiprocessing/other](https://github.com/temporalio/samples-python/blob/e8e8ee60900791348a2eca160824d3173395310f/hello/hello_activity_multiprocess.py)-type activity executor, termination of worker processes comprising the `ProcessPoolExecutor` apparently renders the worker unable to service further activity or workflow execution. Stack traces indicate a `BrokenProcessPool`, e.g.: \r\n\r\n```\r\nCompleting activity as failed ({'activity_id': '1', 'activity_type': 'compose_greeting', 'attempt': 1, 'namespace': 'default', 'task_queue': 'hello-activity-multiprocess-task-queue', 'workflow_id': 'hello-activity-multiprocess-workflow-id', 'workflow_run_id': 'a0d0cf4e-3cb4-4b9d-98a8-98d4ee67ccbf', 'workflow_type': 'GreetingWorkflow'})\r\nTraceback (most recent call last):\r\n  File \"/home/wilsoniya/ia/devel/github.com/temporalio/samples-python/venv/lib/python3.8/site-packages/temporalio/worker/_activity.py\", line 402, in _run_activity\r\n    result = await impl.execute_activity(input)\r\n  File \"/home/wilsoniya/ia/devel/github.com/temporalio/samples-python/venv/lib/python3.8/site-packages/temporalio/worker/_activity.py\", line 638, in execute_activity\r\n    return await loop.run_in_executor(\r\nconcurrent.futures.process.BrokenProcessPool: A process in the process pool was terminated abruptly while the future was running or pending.\r\nCompleting activity as failed ({'activity_id': '1', 'activity_type': 'compose_greeting', 'attempt': 2, 'namespace': 'default', 'task_queue': 'hello-activity-multiprocess-task-queue', 'workflow_id': 'hello-activity-multiprocess-workflow-id', 'workflow_run_id': 'a0d0cf4e-3cb4-4b9d-98a8-98d4ee67ccbf', 'workflow_type': 'GreetingWorkflow'})\r\nTraceback (most recent call last):\r\n  File \"/home/wilsoniya/ia/devel/github.com/temporalio/samples-python/venv/lib/python3.8/site-packages/temporalio/worker/_activity.py\", line 402, in _run_activity\r\n    result = await impl.execute_activity(input)\r\n  File \"/home/wilsoniya/ia/devel/github.com/temporalio/samples-python/venv/lib/python3.8/site-packages/temporalio/worker/_activity.py\", line 638, in execute_activity\r\n    return await loop.run_in_executor(\r\n  File \"/home/wilsoniya/ia/devel/github.com/temporalio/samples-python/venv/lib/python3.8/site-packages/temporalio/worker/_activity.py\", line 638, in execute_activity\r\n    return await loop.run_in_executor(\r\n...\r\n```\r\n\r\nAt the minimum, the top-level worker process should be terminated to allow for the service/pod to be restarted (e.g., by systemd or k8s), though ideally the temporal `Worker` could cope with a `ProcessPoolExecutor` that has entered a bad state.\r\n\r\n### Minimal Reproduction\r\n\r\n\r\n1. clone samples-python\r\n2. increase the number of iterations in `compose_greeting` to allow time to kill a worker process\r\n```\r\ndiff --git a/hello/hello_activity_multiprocess.py b/hello/hello_activity_multiprocess.py\r\nindex 49395c3..ee0e7b7 100644\r\n--- a/hello/hello_activity_multiprocess.py\r\n+++ b/hello/hello_activity_multiprocess.py\r\n@@ -24,7 +24,7 @@ class ComposeGreetingInput:\r\n def compose_greeting(input: ComposeGreetingInput) -> str:\r\n     # We'll wait for 3 seconds, heartbeating in between (like all long-running\r\n     # activities should do), then return the greeting\r\n-    for _ in range(0, 3):\r\n+    for _ in range(0, 10000):\r\n         print(f\"Heartbeating activity on PID {os.getpid()}\")\r\n         activity.heartbeat()\r\n         time.sleep(1)\r\n```\r\n3. `poetry run python hello/hello_activity_multiprocess.py`\r\n4. discover pid of running worker process (it's helpful to use a nested view e.g., as provided by htop, so as to select a process at the deepest level of nesting under the top `hello_activity_multiprocess.py` python process)\r\n5. kill worker process\r\n6. \r\n```\r\ntemporalio/samples-python ‹main*› » poetry run python hello/hello_activity_multiprocess.py                                                                                                       \r\nHeartbeating activity on PID 1652969\r\nHeartbeating activity on PID 1652969\r\nHeartbeating activity on PID 1652969\r\nHeartbeating activity on PID 1652969\r\nHeartbeating activity on PID 1652969\r\nHeartbeating activity on PID 1652969\r\nHeartbeating activity on PID 1652969\r\nHeartbeating activity on PID 1652969\r\nHeartbeating activity on PID 1652969\r\nHeartbeating activity on PID 1652969\r\nHeartbeating activity on PID 1652969\r\nHeartbeating activity on PID 1652971\r\nHeartbeating activity on PID 1652969\r\nHeartbeating activity on PID 1652971\r\nHeartbeating activity on PID 1652969\r\nCompleting activity as failed ({'activity_id': '1', 'activity_type': 'compose_greeting', 'attempt': 1, 'namespace': 'default', 'task_queue': 'hello-activity-multiprocess-task-queue', 'workflow_id': 'hello-activity-multiprocess-workflow-id', 'workflow_run_id': 'a0d0cf4e-3cb4-4b9d-98a8-98d4ee67ccbf', 'workflow_type': 'GreetingWorkflow'})\r\nTraceback (most recent call last):\r\n  File \"/home/wilsoniya/ia/devel/github.com/temporalio/samples-python/venv/lib/python3.8/site-packages/temporalio/worker/_activity.py\", line 402, in _run_activity\r\n    result = await impl.execute_activity(input)\r\n  File \"/home/wilsoniya/ia/devel/github.com/temporalio/samples-python/venv/lib/python3.8/site-packages/temporalio/worker/_activity.py\", line 638, in execute_activity\r\n    return await loop.run_in_executor(\r\nconcurrent.futures.process.BrokenProcessPool: A process in the process pool was terminated abruptly while the future was running or pending.\r\nCompleting activity as failed ({'activity_id': '1', 'activity_type': 'compose_greeting', 'attempt': 2, 'namespace': 'default', 'task_queue': 'hello-activity-multiprocess-task-queue', 'workflow_id': 'hello-activity-multiprocess-workflow-id', 'workflow_run_id': 'a0d0cf4e-3cb4-4b9d-98a8-98d4ee67ccbf', 'workflow_type': 'GreetingWorkflow'})\r\nTraceback (most recent call last):\r\n  File \"/home/wilsoniya/ia/devel/github.com/temporalio/samples-python/venv/lib/python3.8/site-packages/temporalio/worker/_activity.py\", line 402, in _run_activity\r\n    result = await impl.execute_activity(input)\r\n  File \"/home/wilsoniya/ia/devel/github.com/temporalio/samples-python/venv/lib/python3.8/site-packages/temporalio/worker/_activity.py\", line 638, in execute_activity\r\n    return await loop.run_in_executor(\r\n  File \"/home/wilsoniya/ia/devel/github.com/temporalio/samples-python/venv/lib/python3.8/site-packages/temporalio/worker/_activity.py\", line 638, in execute_activity\r\n    return await loop.run_in_executor(\r\nconcurrent.futures.process.BrokenProcessPool: A process in the process pool was terminated abruptly while the future was running or pending.\r\n\r\n# ... apparently forever\r\n```\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor:\r\n```\r\nuname -a                                                                                                                                                                                                                                                                                                                                                                           \r\nLinux 6.1.1-arch1-1 #1 SMP PREEMPT_DYNAMIC Wed, 21 Dec 2022 22:27:55 +0000 x86_64 GNU/Linux\r\n\r\nlscpu\r\n...\r\n  Model name:            AMD Ryzen 7 3700X 8-Core Processor\r\n```\r\n- sdk-python version\r\n```\r\npython --version                                                                                                                                                                                                                                                                                                                                                                   \r\nPython 3.8.12\r\n\r\npip freeze | grep temporalio\r\ntemporalio==1.0.0\r\n-e git+ssh://git@github.com/temporalio/samples-python.git@af94df067f2d0afc5fd4f2433e83ed0ad85467f5#egg=temporalio_samples\r\n# and also\r\npip freeze | grep temporalio                                                                                                                                                                                                                                                                                                                                                                                       \r\ntemporalio==0.1b3\r\n```\r\n\r\n- Are you using Docker or Kubernetes or building Temporal from source?\r\nI'm using a docker distribution for local development but I don't think that should affect the reproduction of this bug.\r\n\r\n### Additional context\r\n\r\nThanks for the help and congrats on reaching 1.0.0 on sdk-python :tada: !\r\n","closedAt":"2023-01-13T18:28:26Z","comments":[{"id":"IC_kwDOGusT1c5SBCD2","author":{"login":"wilsoniya"},"authorAssociation":"NONE","body":"~Looks like this `ProcessPoolExecutor` implementation might be a workaround: https://github.com/joblib/loky~\r\n\r\nEDIT: I tested this out and it can't cope with killed worker procs.","createdAt":"2023-01-09T17:36:25Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/245#issuecomment-1376002294","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5SBLub","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Did some research. I think it's pretty clear we should fatally error the worker if we get any `concurrent.futures.BrokenExecutor` from `run_in_executor`. Thanks for the report!","createdAt":"2023-01-09T18:08:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/245#issuecomment-1376041883","viewerDidAuthor":false}],"createdAt":"2023-01-06T18:50:57Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":245,"reactionGroups":[],"state":"CLOSED","title":"[Bug] BrokenProcessPool completely disables ProcessPoolExecutor ","updatedAt":"2023-01-13T18:28:26Z","url":"https://github.com/temporalio/sdk-python/issues/245"}
