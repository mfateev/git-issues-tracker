{"assignees":[],"author":{"id":"MDQ6VXNlcjg1NjU1MjA2","is_bot":false,"login":"michael-cybrid","name":""},"body":"### What are you really trying to do?\r\n\r\nI want to be able to pass in Pydantic models with `datetime` fields.\r\n\r\nTo encode `datetime`fields, I am using the `pydantic.json.pydantic_encoder` but can hit this behaviour without any data conversion occurring.\r\n\r\n### Describe the bug\r\n\r\nThe `SandboxWorkflowRunner` restrictions are resulting in Pydantic models being created with incorrect field types. \r\n\r\nSpecifically, I am seeing models derived from Pydantic's `BaseModel` class (let's say `MyDatetimeWrapper`) that contain a `datetime` field being instantiated with a `date` object instead when a `MyDatetimeWrapper` object is created within a workflow.\r\n\r\n### Minimal Reproduction\r\n\r\nI've created a code sample to illustrate the issue:\r\n```python\r\nimport asyncio\r\nimport dataclasses\r\nfrom datetime import datetime\r\nfrom uuid import uuid4\r\n\r\nfrom pydantic import BaseModel\r\nfrom temporalio import workflow\r\nfrom temporalio.client import Client\r\nfrom temporalio.worker import Worker\r\nfrom temporalio.worker.workflow_sandbox import SandboxRestrictions, SandboxedWorkflowRunner\r\n\r\nclass Message(BaseModel):\r\n    content: datetime\r\n\r\n\r\n@workflow.defn\r\nclass Workflow:\r\n\r\n    @workflow.run\r\n    async def run(self, context: str) -> None:\r\n        message = Message(content=workflow.now())\r\n        print(f\"Message in workflow with {context}: {message} (`content` type is{type(message.content)})\\n\")\r\n\r\n\r\ndef default_worker(client: Client, task_queue: str) -> Worker:\r\n    return Worker(client, workflows=[Workflow], activities=[], task_queue=task_queue)\r\n\r\n\r\ndef relaxed_worker(client: Client, task_queue: str) -> Worker:\r\n    restrictions = dataclasses.replace(\r\n        SandboxRestrictions.default,\r\n        invalid_module_members=dataclasses.replace(\r\n            SandboxRestrictions.invalid_module_members_default,\r\n            children={\r\n                k: v for k, v in SandboxRestrictions.invalid_module_members_default.children.items() if k != \"datetime\"\r\n            }\r\n        )\r\n    )\r\n    runner = SandboxedWorkflowRunner(restrictions=restrictions)\r\n    return Worker(client, workflows=[Workflow], activities=[], task_queue=task_queue, workflow_runner=runner)\r\n\r\n\r\nasync def main():\r\n    task_queue = str(uuid4())\r\n    client = await Client.connect(\"temporal:7233\", namespace=\"default-namespace\")\r\n\r\n    async with default_worker(client, task_queue):\r\n        context = \"default sandbox\"\r\n        message = Message(content=datetime.utcnow())\r\n        print(f\"Message in main with {context}: {message} (`content` type is{type(message.content)})\\n\")\r\n        handle = await client.start_workflow(Workflow.run, context, id=str(uuid4()), task_queue=task_queue)\r\n        await handle.result()\r\n\r\n\r\n    async with relaxed_worker(client, task_queue):\r\n        context = \"relaxed sandbox\"\r\n        message = Message(content=datetime.utcnow())\r\n        print(f\"Message in main with {context}: {message} (`content` type is{type(message.content)})\\n\")\r\n        handle = await client.start_workflow(Workflow.run, context, id=str(uuid4()), task_queue=task_queue)\r\n        await handle.result()\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    asyncio.run(main())\r\n```\r\n\r\nThe output from this snippet it:\r\n```\r\nMessage in main with default sandbox: content=datetime.datetime(2022, 11, 18, 14, 13, 25, 326269) (`content` type is<class 'datetime.datetime'>)\r\n\r\nMessage in workflow with default sandbox: content=datetime.date(2022, 11, 18) (`content` type is<class 'datetime.date'>)\r\n\r\nMessage in main with relaxed sandbox: content=datetime.datetime(2022, 11, 18, 14, 13, 25, 360676) (`content` type is<class 'datetime.datetime'>)\r\n\r\nMessage in workflow with relaxed sandbox: content=datetime.datetime(2022, 11, 18, 14, 13, 25, 369645, tzinfo=datetime.timezone.utc) (`content` type is<class 'datetime.datetime'>)\r\n```\r\n\r\n**As you can see, the default sandbox runner is resulting in `content` being converted to just a `date` despite being instantiated with a `datetime`.**\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: M1 Pro Mac\r\n- Temporal Version: 1.8.4 and SDK version 0.1b3 (Pydantic 1.10.2)\r\n- Using Docker to run Temporal server\r\n- Python Version: Python 3.10.7\r\n","closedAt":"2024-01-29T13:46:23Z","comments":[{"id":"IC_kwDOGusT1c5OrqAu","author":{"login":"michael-cybrid"},"authorAssociation":"NONE","body":"Sorry, some additional context I forgot to mention.\r\n\r\nIf you install Pydantic with source only (i.e. without Cython binary), you get an error on startup:\r\n```\r\nTraceback (most recent call last):\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/_workflow.py\", line 113, in __init__\r\n    workflow_runner.prepare_workflow(defn)\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_runner.py\", line 53, in prepare_workflow\r\n    self.create_instance(\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_runner.py\", line 87, in create_instance\r\n    return _Instance(det, self._runner_class, self._restrictions)\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_runner.py\", line 107, in __init__\r\n    self._create_instance()\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_runner.py\", line 118, in _create_instance\r\n    self._run_code(\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_runner.py\", line 160, in _run_code\r\n    exec(code, self.globals_and_locals, self.globals_and_locals)\r\n  File \"<string>\", line 2, in <module>\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_importer.py\", line 398, in __call__\r\n    return self.current(*args, **kwargs)\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_importer.py\", line 199, in _import\r\n    new_spec.loader.exec_module(new_mod)\r\n  File \"<frozen importlib._bootstrap_external>\", line 883, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\r\n  File \"/Users/user/Development/temporal/worker-hang/main.py\", line 6, in <module>\r\n    from pydantic import BaseModel\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_importer.py\", line 398, in __call__\r\n    return self.current(*args, **kwargs)\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_importer.py\", line 201, in _import\r\n    mod = importlib.__import__(name, globals, locals, fromlist, level)\r\n  File \"<frozen importlib._bootstrap>\", line 1129, in __import__\r\n  File \"<frozen importlib._bootstrap>\", line 1050, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 1027, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 1006, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 688, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 883, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/pydantic/__init__.py\", line 2, in <module>\r\n    from . import dataclasses\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_importer.py\", line 398, in __call__\r\n    return self.current(*args, **kwargs)\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_importer.py\", line 201, in _import\r\n    mod = importlib.__import__(name, globals, locals, fromlist, level)\r\n  File \"<frozen importlib._bootstrap>\", line 1149, in __import__\r\n  File \"<frozen importlib._bootstrap>\", line 1078, in _handle_fromlist\r\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\r\n  File \"<frozen importlib._bootstrap>\", line 1050, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 1027, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 1006, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 688, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 883, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/pydantic/dataclasses.py\", line 56, in <module>\r\n    from .error_wrappers import ValidationError\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_importer.py\", line 398, in __call__\r\n    return self.current(*args, **kwargs)\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_importer.py\", line 201, in _import\r\n    mod = importlib.__import__(name, globals, locals, fromlist, level)\r\n  File \"<frozen importlib._bootstrap>\", line 1133, in __import__\r\n  File \"<frozen importlib._bootstrap>\", line 1050, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 1027, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 1006, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 688, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 883, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/pydantic/error_wrappers.py\", line 4, in <module>\r\n    from .json import pydantic_encoder\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_importer.py\", line 398, in __call__\r\n    return self.current(*args, **kwargs)\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_importer.py\", line 201, in _import\r\n    mod = importlib.__import__(name, globals, locals, fromlist, level)\r\n  File \"<frozen importlib._bootstrap>\", line 1133, in __import__\r\n  File \"<frozen importlib._bootstrap>\", line 1050, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 1027, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 1006, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 688, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 883, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/pydantic/json.py\", line 14, in <module>\r\n    from .types import SecretBytes, SecretStr\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_importer.py\", line 398, in __call__\r\n    return self.current(*args, **kwargs)\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_importer.py\", line 201, in _import\r\n    mod = importlib.__import__(name, globals, locals, fromlist, level)\r\n  File \"<frozen importlib._bootstrap>\", line 1133, in __import__\r\n  File \"<frozen importlib._bootstrap>\", line 1050, in _gcd_import\r\n  File \"<frozen importlib._bootstrap>\", line 1027, in _find_and_load\r\n  File \"<frozen importlib._bootstrap>\", line 1006, in _find_and_load_unlocked\r\n  File \"<frozen importlib._bootstrap>\", line 688, in _load_unlocked\r\n  File \"<frozen importlib._bootstrap_external>\", line 883, in exec_module\r\n  File \"<frozen importlib._bootstrap>\", line 241, in _call_with_frames_removed\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/pydantic/types.py\", line 764, in <module>\r\n    class FilePath(Path):\r\nTypeError: _RestrictedProxy.__init__() missing 1 required positional argument: 'matcher'\r\n\r\nThe above exception was the direct cause of the following exception:\r\n\r\nTraceback (most recent call last):\r\n  File \"/Users/user/Development/temporal/worker-hang/main.py\", line 64, in <module>\r\n    asyncio.run(main())\r\n  File \"/opt/homebrew/Cellar/python@3.10/3.10.7/Frameworks/Python.framework/Versions/3.10/lib/python3.10/asyncio/runners.py\", line 44, in run\r\n    return loop.run_until_complete(main)\r\n  File \"/opt/homebrew/Cellar/python@3.10/3.10.7/Frameworks/Python.framework/Versions/3.10/lib/python3.10/asyncio/base_events.py\", line 646, in run_until_complete\r\n    return future.result()\r\n  File \"/Users/user/Development/temporal/worker-hang/main.py\", line 47, in main\r\n    async with default_worker(client, task_queue):\r\n  File \"/Users/user/Development/temporal/worker-hang/main.py\", line 26, in default_worker\r\n    return Worker(client, workflows=[Workflow], activities=[], task_queue=task_queue)\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/_worker.py\", line 261, in __init__\r\n    self._workflow_worker = _WorkflowWorker(\r\n  File \"/Users/user/.local/share/virtualenvs/worker-hang-grTap8Tq/lib/python3.10/site-packages/temporalio/worker/_workflow.py\", line 117, in __init__\r\n    raise RuntimeError(f\"Failed validating workflow {defn.name}\") from err\r\nRuntimeError: Failed validating workflow Workflow\r\n```","createdAt":"2022-11-18T14:27:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/207#issuecomment-1320067118","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5Ortcb","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":">  I am using the pydantic.json.pydantic_encoder\r\n\r\nI do not see where this is used in the reproduction you provided. I don't see any custom data conversion.  Can you update the sample code? I will also test it to see why it's choosing one type and not the other. There is a fix we just made in #202 that may have affected type hints on either side of the sandbox.\r\n\r\nBy default we use Pydantic's `dict()` which doesn't always return a JSONable dict. Date time is not supported by our JSON encoder natively. We have to cross languages and date time is not a supported type in our other SDKs.\r\n\r\nThere is discussion of this at #143. But basically Pydantic doesn't provide a way to get a JSON-able dict but they've been actively talking about it lately. It provides a way to get JSON string (which we'd have to convert back at a perf loss) and a way to get a dict Pydantic can convert to JSON (but is not cross-language compatible for Temporal benefit).\r\n\r\nI am planning on writing a sample at https://github.com/temporalio/samples-python/issues/25 that will show how to use full Pydantic JSON conversion.\r\n\r\n> If you install Pydantic with source only (i.e. without Cython binary), you get an error on startup:\r\n\r\nThis is a known issue at https://github.com/temporalio/sdk-python#extending-restricted-classes and something we hope to fix. In the meantime you can mark `pydantic` as a pass-through module (we plan on making this easier too).\r\n\r\nAlso, feel free to join us in `#python-sdk` at https://temporal.io/slack or https://community.temporal.io too.","createdAt":"2022-11-18T14:38:25Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/207#issuecomment-1320081179","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5Orv7I","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I have replicated with your code and am looking in detail","createdAt":"2022-11-18T14:46:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/207#issuecomment-1320091336","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5Orx5Y","author":{"login":"michael-cybrid"},"authorAssociation":"NONE","body":"Thanks for the speedy reply! I was in the middle of typing out a response but see you are looking in detail. Thanks very much.\r\n\r\nFor context, I was hesitant to mention `I am using the pydantic.json.pydantic_encoder` because it is just context for how I came across this issue but you can see in the sample code, this behaviour is hit **without** any conversion. I am happy to show how I've got that bit working separately.\r\n\r\nI just tried  adding `pydantic` to the `passthrough_modules` modules list but it still results in the same erroneous behaviour.\r\n\r\nUpdate sample here:\r\n\r\n```python\r\nimport asyncio\r\nimport dataclasses\r\nfrom datetime import datetime\r\nfrom uuid import uuid4\r\n\r\nfrom pydantic import BaseModel\r\nfrom temporalio import workflow\r\nfrom temporalio.client import Client\r\nfrom temporalio.worker import Worker\r\nfrom temporalio.worker.workflow_sandbox import SandboxRestrictions, SandboxedWorkflowRunner, SandboxMatcher\r\n\r\nclass Message(BaseModel):\r\n    content: datetime\r\n\r\n\r\n@workflow.defn\r\nclass Workflow:\r\n\r\n    @workflow.run\r\n    async def run(self, context: str) -> None:\r\n        message = Message(content=workflow.now())\r\n        print(f\"Message in workflow with {context}: {message} (`content` type is{type(message.content)})\\n\")\r\n\r\n\r\ndef default_worker(client: Client, task_queue: str) -> Worker:\r\n    return Worker(client, workflows=[Workflow], activities=[], task_queue=task_queue)\r\n\r\n\r\ndef relaxed_worker(client: Client, task_queue: str) -> Worker:\r\n    restrictions = dataclasses.replace(\r\n        SandboxRestrictions.default,\r\n        invalid_module_members=dataclasses.replace(\r\n            SandboxRestrictions.invalid_module_members_default,\r\n            children={\r\n                k: v for k, v in SandboxRestrictions.invalid_module_members_default.children.items() if k != \"datetime\"\r\n            }\r\n        )\r\n    )\r\n    runner = SandboxedWorkflowRunner(restrictions=restrictions)\r\n    return Worker(client, workflows=[Workflow], activities=[], task_queue=task_queue, workflow_runner=runner)\r\n\r\n\r\ndef passthrough_worker(client: Client, task_queue: str) -> Worker:\r\n    restrictions = dataclasses.replace(\r\n        SandboxRestrictions.default,\r\n        passthrough_modules=SandboxRestrictions.passthrough_modules_default | SandboxMatcher(access={\"pydantic\"}),\r\n    )\r\n    runner = SandboxedWorkflowRunner(restrictions=restrictions)\r\n    return Worker(client, workflows=[Workflow], activities=[], task_queue=task_queue, workflow_runner=runner)\r\n\r\n\r\nasync def run_the_bug(client: Client, task_queue: str, context: str) -> None:\r\n    message = Message(content=datetime.utcnow())\r\n    print(f\"Message in main with {context}: {message} (`content` type is{type(message.content)})\\n\")\r\n    handle = await client.start_workflow(Workflow.run, context, id=str(uuid4()), task_queue=task_queue)\r\n    await handle.result()\r\n\r\n\r\nasync def main():\r\n    task_queue = str(uuid4())\r\n    client = await Client.connect(\"temporal:7233\", namespace=\"default-namespace\")\r\n\r\n    async with default_worker(client, task_queue):\r\n        await run_the_bug(client, task_queue, \"default sandbox\")\r\n\r\n    async with relaxed_worker(client, task_queue):\r\n        await run_the_bug(client, task_queue, \"relaxed sandbox\")\r\n\r\n    async with passthrough_worker(client, task_queue):\r\n        await run_the_bug(client, task_queue, \"passthrough sandbox\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    asyncio.run(main())\r\n\r\n```\r\n","createdAt":"2022-11-18T14:49:24Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/207#issuecomment-1320099416","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5Or8aJ","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Here's my small reproduction:\r\n\r\n```python\r\nimport asyncio\r\nfrom datetime import datetime\r\nfrom uuid import uuid4\r\n\r\nfrom pydantic import BaseModel\r\nfrom temporalio import workflow\r\nfrom temporalio.exceptions import ApplicationError\r\nfrom temporalio.testing import WorkflowEnvironment\r\nfrom temporalio.worker import Worker\r\n\r\n\r\nclass Message(BaseModel):\r\n    content: datetime\r\n\r\n\r\n@workflow.defn\r\nclass Workflow:\r\n    @workflow.run\r\n    async def run(self) -> None:\r\n        message = Message(content=workflow.now())\r\n        if not isinstance(message.content, datetime):\r\n            raise ApplicationError(f\"was type {type(message.content)}\")\r\n\r\n\r\nasync def main():\r\n    async with await WorkflowEnvironment.start_local() as env:\r\n        task_queue = str(uuid4())\r\n        async with Worker(env.client, workflows=[Workflow], task_queue=task_queue):\r\n            await env.client.execute_workflow(\r\n                Workflow.run, id=str(uuid4()), task_queue=task_queue\r\n            )\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    asyncio.run(main())\r\n```\r\n\r\nDebugging now...","createdAt":"2022-11-18T15:03:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/207#issuecomment-1320142473","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5Os-sb","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I have hunted this issue down. This is caused by https://github.com/temporalio/sdk-python#is_subclass-of-abc-based-restricted-classes:\r\n\r\n> Due to https://bugs.python.org/issue44847, classes that are wrapped and then checked to see if they are subclasses of another via is_subclass may fail (see also https://github.com/GrahamDumpleton/wrapt/issues/130).\r\n\r\nAlso see https://github.com/python/cpython/issues/89010\r\n\r\nBasically at https://github.com/pydantic/pydantic/blob/bc74342b39e2b1d0115364cf2aa90d8f874cb9b5/pydantic/validators.py#L751, `pydantic` is checking `is_subclass` to determine whether it's `datetime` before falling through to `date`. This call fails for proxied objects. I'll look into workarounds, but in the meantime you'd have to remove `datetime` from being a restricted.\r\n\r\nIt might look something like (untested):\r\n```python\r\nmy_restrictions = dataclasses.replace(\r\n    SandboxRestrictions.default,\r\n    invalid_module_members=SandboxMatcher(\r\n        children={k: v for SandboxRestrictions.invalid_module_members_default.children.items() if k != \"datetime\"}\r\n    ),\r\n)\r\nmy_worker = Worker(..., workflow_runner=SandboxedWorkflowRunner(restrictions=my_restrictions))\r\n```\r\n\r\nBut this removes our protections against calling something like `datetime.now()` which is forbidden in workflows, so be careful.","createdAt":"2022-11-18T18:58:27Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/207#issuecomment-1320413979","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5Ozize","author":{"login":"michael-cybrid"},"authorAssociation":"NONE","body":"Thanks, @cretz, for chasing this down.","createdAt":"2022-11-21T14:19:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/207#issuecomment-1322134750","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5Pmvs2","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"While a fix such as patching `issubclass` would fix this for non-binary Pydantic, installing the binary form bypasses any stdlib patches (and no I cannot use `__subclasscheck__` on my proxy type, because it is `datetime.__subclasscheck__` that is being called).\r\n\r\nI still can't figure out how best to solve this. Researching...","createdAt":"2022-12-02T17:16:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/207#issuecomment-1335556918","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5Pm3F4","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"For now, I have just marked this a known issue in the README in #219. If this becomes enough of an issue, we'll have to consider patching `datetime.__subclasscheck__`.","createdAt":"2022-12-02T17:47:22Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/207#issuecomment-1335587192","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5yBUKJ","author":{"login":"iAnanich"},"authorAssociation":"NONE","body":"Copilot brought me here...\r\n\r\nMy error looks slightly different:\r\n`RuntimeError: Restriction state not present. Using subclasses of proxied objects is unsupported.`\r\nis a cause of \r\n`RuntimeError: Failed validating workflow VerifyFaceWorkflowV1`\r\n\r\n... and then discovered that python-samples contains data converter for Pydantic - that solved the issue for me.\r\n\r\nPerhaps this issue could be closed?..","createdAt":"2024-01-27T03:32:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/207#issuecomment-1912947337","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5yIG4l","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":":+1: Will close.\r\n\r\nFor others arriving here, this is documented in the README and the supported way to use Pydantic is via a custom payload converter as shown in samples.","createdAt":"2024-01-29T13:46:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/207#issuecomment-1914727973","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c54238j","author":{"login":"jackklika"},"authorAssociation":"NONE","body":"For future people investigating problems related to this: We ran into an error related to this and disabling sandboxing on the worker or passing through the datetime and pydantic (v1) imports here ultimately fixed it.\r\n\r\nDisabling sandboxing on one workflow via the `sandboxed=False` did not work and we are unclear if this was because of  a sandboxed import occurring before importing into that non-sandboxed workflow, a top-level import on the file overriding something imported locally in the activity function, or something else. We need to look more into this ourselves.\r\n\r\nEither way, the [guidance on the Readme added as a result of this issue](https://github.com/temporalio/sdk-python/pull/219/files#diff-b335630551682c19a781afebcf4d07bf978fb1f8ac04c6bf87428ed5106870f5R857) is accurate. \r\n\r\nBelow is the error we got on importing a BaseModel in an activity. The error was specifically around a pydantic `Field` with a `default_factory` which instantiated a datetime.now(). I'm reposting it to aid anyone googling in the future and direct them to this issue.\r\n```\r\n  File \"/usr/local/lib/python3.12/site-packages/temporalio/worker/_activity.py\", line 438, in _run_activity\r\n    result = await impl.execute_activity(input)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\r\n  File \"/usr/local/lib/python3.12/site-packages/temporalio/worker/_activity.py\", line 704, in execute_activity\r\n    return await input.fn(*input.args)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\r\n   [...]\r\n\r\n  # This call is when we import the pydantic BaseModel which is ultimately calling ModelMetaclass.__new__ here\r\n  File \"/usr/local/lib/python3.12/site-packages/pydantic/main.py\", line 138, in __new__\r\n    fields.update(smart_deepcopy(base.__fields__))\r\n                  ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\r\n  File \"/usr/local/lib/python3.12/site-packages/pydantic/utils.py\", line 693, in smart_deepcopy\r\n    return deepcopy(obj)  # slowest way when we actually might need a deepcopy\r\n           ^^^^^^^^^^^^^\r\n\r\n  File \"/usr/local/lib/python3.12/copy.py\", line 136, in deepcopy\r\n    y = copier(x, memo)\r\n        ^^^^^^^^^^^^^^^\r\n\r\n  File \"/usr/local/lib/python3.12/copy.py\", line 221, in _deepcopy_dict\r\n    y[deepcopy(key, memo)] = deepcopy(value, memo)\r\n                             ^^^^^^^^^^^^^^^^^^^^^\r\n\r\n  File \"/usr/local/lib/python3.12/copy.py\", line 162, in deepcopy\r\n    y = _reconstruct(x, memo, *rv)\r\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n\r\n  File \"/usr/local/lib/python3.12/copy.py\", line 259, in _reconstruct\r\n    state = deepcopy(state, memo)\r\n            ^^^^^^^^^^^^^^^^^^^^^\r\n\r\n  File \"/usr/local/lib/python3.12/copy.py\", line 136, in deepcopy\r\n    y = copier(x, memo)\r\n        ^^^^^^^^^^^^^^^\r\n\r\n  File \"/usr/local/lib/python3.12/copy.py\", line 201, in _deepcopy_tuple\r\n    y = [deepcopy(a, memo) for a in x]\r\n         ^^^^^^^^^^^^^^^^^\r\n\r\n  File \"/usr/local/lib/python3.12/copy.py\", line 136, in deepcopy\r\n    y = copier(x, memo)\r\n        ^^^^^^^^^^^^^^^\r\n\r\n  File \"/usr/local/lib/python3.12/copy.py\", line 221, in _deepcopy_dict\r\n    y[deepcopy(key, memo)] = deepcopy(value, memo)\r\n                             ^^^^^^^^^^^^^^^^^^^^^\r\n\r\n  File \"/usr/local/lib/python3.12/copy.py\", line 151, in deepcopy\r\n    rv = reductor(4)\r\n         ^^^^^^^^^^^\r\n```","createdAt":"2024-03-29T19:22:04Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/207#issuecomment-2027650851","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6WvmRK","author":{"login":"spacether"},"authorAssociation":"NONE","body":"Could this be fixed by moving the issubclass for datetime check before the issubclass date check? What is the actual offending line that is causing this to happen?","createdAt":"2024-12-09T18:39:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/207#issuecomment-2529059914","viewerDidAuthor":false}],"createdAt":"2022-11-18T14:22:40Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":207,"reactionGroups":[],"state":"CLOSED","title":"[Bug] SandboxWorkflowRunner doesn't use correct Pydantic field types in some cases","updatedAt":"2024-12-09T18:39:13Z","url":"https://github.com/temporalio/sdk-python/issues/207"}
