{"assignees":[],"author":{"id":"MDQ6VXNlcjY2MTUw","is_bot":false,"login":"togakangaroo","name":"George Mauer"},"body":"### What are you really trying to do?\n\nI am trying to use the pdb debugger from inside unit tests literally with the `breakpoint()` function.\n\n### Describe the bug\n\nIt is pretty straightforward really, change the workflow to use sandboxing and set a `breakpoint()`. When you do you get an endless scroll with\n```\ntemporalio.worker.workflow_sandbox._restrictions.RestrictedWorkflowAccessError: Cannot access __builtins__.breakpoint from inside a workflow. If this is code from a module not used in a workflow or known to only be used deterministically from a workflow, mark the import as pass through.\n08:48:32 [ WARNING] Failed activation on workflow GreetingWorkflow with ID 68cd5a5e-2ada-40ff-aa67-63eae9ab3055 and run ID 01994355-86ca-7dd3-9335-69a9e5be86ff (_workflow_instance.py:452)\nTraceback (most recent call last):\n  File \"/Users/georgemauer/code/temporal-samples/.venv/lib/python3.13/site-packages/temporalio/worker/_workflow_instance.py\", line 412, in activate\n    self._run_once(check_conditions=index == 1 or index == 2)\n    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/georgemauer/code/temporal-samples/.venv/lib/python3.13/site-packages/temporalio/worker/_workflow_instance.py\", line 2130, in _run_once\n    raise self._current_activation_error\n  File \"/Users/georgemauer/code/temporal-samples/.venv/lib/python3.13/site-packages/temporalio/worker/_workflow_instance.py\", line 2148, in _run_top_level_workflow_function\n    await coro\n  File \"/Users/georgemauer/code/temporal-samples/.venv/lib/python3.13/site-packages/temporalio/worker/_workflow_instance.py\", line 974, in run_workflow\n    result = await self._inbound.execute_workflow(input)\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/georgemauer/code/temporal-samples/.venv/lib/python3.13/site-packages/temporalio/testing/_workflow.py\", line 518, in execute_workflow\n    return await super().execute_workflow(input)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/georgemauer/code/temporal-samples/.venv/lib/python3.13/site-packages/temporalio/worker/_interceptor.py\", line 385, in execute_workflow\n    return await self.next.execute_workflow(input)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/georgemauer/code/temporal-samples/.venv/lib/python3.13/site-packages/temporalio/worker/_workflow_instance.py\", line 2529, in execute_workflow\n    return await input.run_fn(*args)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/georgemauer/code/temporal-samples/hello/hello_activity.py\", line 32, in run\n    breakpoint()\n    ~~~~~~~~~~^^\n  File \"/Users/georgemauer/code/temporal-samples/.venv/lib/python3.13/site-packages/temporalio/worker/workflow_sandbox/_importer.py\", line 497, in __call__\n    return self.current(*args, **kwargs)\n           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^\n  File \"/Users/georgemauer/code/temporal-samples/.venv/lib/python3.13/site-packages/temporalio/worker/workflow_sandbox/_importer.py\", line 94, in restrict_built_in\n    raise RestrictedWorkflowAccessError(f\"__builtins__.{name}\")\n```\n### Minimal Reproduction\n\nI have [recreated this in temporal samples here](https://github.com/temporalio/samples-python/compare/main...togakangaroo:temporal-samples-python:demonstrate-debug-mode-not-working?expand=1)\n\n### Environment/Versions\n\n<!-- Please complete the following information where relevant. -->\n\n- Apple M4 Pro\n- Temporal Version: 1.15.0\n- Literally just running the samples\n \n### Additional context\n\n I am debugging as part of trying to figure out why passing `RetryPolicy(max_attempts=1)` on `client.execute_workflow` in my unit tests doesn't seem to turn off retries of activities. \n\nWhat I ultimately want is to be able to tell my unit tests to only retry once or twice - essentially to set a retry policy specifically for my tests. The documentation implies that doing this by passing `retry_policy=RetryPolicy(max_attempts=2)` to `client.execute_workflow()` should work yet it doesn't for me. The only way to get it working is by passing a retry policy to `workflow.execute_activity()` but that would mean changing my code specifically for simple automation tests which I want to avoid.\n\nSo I started trying to inspect the code. Because there are base classes involved I want to inspect things at run time, however setting a breakpoint in my workflow fails. According to the documentation, `debug_mode=True` should make it possible to use breakpoints but that seems to *only* be the case when you don't have `sandbox=True` on your workflows which means I'd have to modify my code specifically for testing.\n","closedAt":null,"comments":[{"id":"IC_kwDOGusT1c7EF6tH","author":{"login":"togakangaroo"},"authorAssociation":"NONE","body":"This seems to be happening with `@workflow.defn(sandboxed=False)` and `workflow_runner=UnsandboxedWorkflowRunner()` as well.\n\nI have to emphasize how utterly painful it is to have to develop things without the ability to place a breakpoint. Even when you can test activties in isolation, what we care about is the workflow as whole and that testability is really key. In my real-world case, the activities are basically just doing db loading and projection, not much to test - its the logic in the workflows and ensuring how it works across retries thats important.","createdAt":"2025-09-14T20:49:23Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1104#issuecomment-3289885511","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7ESmcl","author":{"login":"togakangaroo"},"authorAssociation":"NONE","body":"Another example of where I'm struggling without `breakpoint` - I'm troubleshooting a situation in my tests where a mock is not set the way I intend it to. I want to inspect what is going on and I simply cannot.\n\nFor what its worth, I have tried\n```\n    with workflow.unsafe.sandbox_unrestricted():\n        breakpoint()\n```\nwhich *does* hit the breakpoint, but the breakpoint is not in my code. I have to navigate up the call stack and then *do* see my code there and can inspect it, but boy is it a big workaround.","createdAt":"2025-09-15T17:28:19Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1104#issuecomment-3293210405","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7EqMu4","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"> The documentation implies that doing this by passing retry_policy=RetryPolicy(max_attempts=2) to client.execute_workflow() should work yet it doesn't for me\n\nCan you point to documentation that says this? The retry policy in `execute_workflow` is the policy for workflow retries, not activities. If the documentation says otherwise or is unclear, it should be fixed. \n\nAs to the larger question of breakpoints, they should work with the unsandboxed runner, so that is something we would have to look into. The recommended way to debug would be to debug a replay of the workflow run, as that will avoid any interaction with server timeouts, but that is more of a problem when you have hit and are staying at the breakpoint, not in hitting it in the first place.","createdAt":"2025-09-16T15:55:16Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1104#issuecomment-3299396536","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7E8H5R","author":{"login":"togakangaroo"},"authorAssociation":"NONE","body":"@tconley1428 I guess I don't really understand the distinction between workflow and activity retries. If I have a workflow with activities A then B, if activity B fails, then it will retry again later and when it does it will rerun the entire workflow while skipping activity A because it's already completed successfully in the event history. It does not, sticky cache aside, save the entire workflow memory state in between the two runs, the workflow runs from the beginning.\n\nSo if the entire workflow reruns again...then what's the distinction? Is it that failed workflows themselves would be retried?\n\nIf so, I think that bit is very confusing since the entire workflow *does* rerun on activity retries. Additionally, [the documentation does mention a default RetryPolicy](https://docs.temporal.io/develop/python/failure-detection#activity-timeouts:~:text=Activity%20Executions%20are%20automatically%20associated%20with%20a%20default%20Retry%20Policy) but clicking that link simply takes you to the encyclopedia page on retries in general.\n\nGiven the above and, because both use the same `RetryPolicy` class, it seems a reasonable inference that setting it at the workflow level is what controls the default. I think the docs need to make a very clear distinction on it as well as explaining how to set the default (which is needed since you would want a different policy to be used in unit tests).\n\nI'll write another reply about breakpoints...","createdAt":"2025-09-17T18:19:55Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1104#issuecomment-3304095313","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7E8UBJ","author":{"login":"togakangaroo"},"authorAssociation":"NONE","body":"Regarding breakpoints. If I take exactly what is in that branch I have in the demo and run the unit test, it actually *is* hitting the breakpoint now (which is odd, I could have sworn it threw an error earlier, but maybe that was when I was trying in different configurations).\n\n```\nuv run pytest --pdb '/Users/georgemauer/code/temporal-samples/tests/hello/hello_activity_test.py::test_mock_activity'\n```\n\n<img width=\"1617\" height=\"291\" alt=\"showing test run in the terminal with a pause at the breakpoint but no ability to interact with the pdb debugger\" src=\"https://github.com/user-attachments/assets/113e4f65-f349-4c93-b3a0-1c92f767a528\" />\n\nHowever, notice in that screenshot that while it *does* break, it is not in the pdb repl and I cannot interact with the debugger in any way. I cannot inspect a variable, I cannot step, I cannot continue, I can't even seem to quit out of it without having to kil the underlying process in another terminal. This is despite me having `debug-mode=True` *and* the workflow being marked as not sandboxed.\n\nInterestingly, in the samples this is happening even *if* I do `workflow_runner=UnsandboxedWorkflowRunner()` *and* the `        with workflow.unsafe.sandbox_unrestricted()` stuff I figured out above. That worked in my real project, but in this samples branch it just hangs.","createdAt":"2025-09-17T18:37:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1104#issuecomment-3304144969","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7E8WTy","author":{"login":"togakangaroo"},"authorAssociation":"NONE","body":"I want to comment on this as well @tconley1428 \n\n> The recommended way to debug would be to debug a replay of the workflow run\n\nThat precludes test-driven-development as workflow does it not? Since you'd need something deployed somewhere so that you could get something to replay?","createdAt":"2025-09-17T18:40:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1104#issuecomment-3304154354","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7F26hC","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"> That precludes test-driven-development as workflow does it not? Since you'd need something deployed somewhere so that you could get something to replay?\n\nTake a look at the `Replayer`: https://github.com/temporalio/sdk-python/blob/main/temporalio/worker/_replayer.py#L33. You can run a workflow in tests, get its history, then either store it (we do this to test replays across sdk version changes) or run it through the replayer to replay immediately.\n\n> If so, I think that bit is very confusing since the entire workflow does rerun on activity retries\n\nOnly kinda. The workflow _might_ replay to retry an activity, but doesn't necessarily. And that's different from rerunning the workflow, which would redo any completed activities, being a fresh start of the workflow. That said, it isn't very common and not recommended to rely on workflow retries. \n\nI take your point about the documentation of a default retry policy though. The \"default\" retry policy is not a mutable one. If you'd like, you can make an additional issue requesting a means of overriding the default activity retry policy at a higher level, and we'll consider it. \n\nOn breakpoints, we might need to find some time to reproduce your behavior. With sandboxing off, it shouldn't really be different from a standard python program, but I haven't debugged in that way before.","createdAt":"2025-09-22T14:46:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1104#issuecomment-3319507010","viewerDidAuthor":false}],"createdAt":"2025-09-13T14:20:02Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1104,"reactionGroups":[],"state":"OPEN","title":"Setting debug_mode in a Worker still doesn't allow the user of breakpoints","updatedAt":"2025-09-22T14:46:05Z","url":"https://github.com/temporalio/sdk-python/issues/1104"}
