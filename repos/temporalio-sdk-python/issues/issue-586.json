{"assignees":[],"author":{"id":"MDQ6VXNlcjQxMDY2MDU=","is_bot":false,"login":"cpg1111","name":"Christian Grabowski"},"body":"### What are you really trying to do?\r\n\r\nHi there, I am writing tests for a workflow in which it spawns N child workflows using `workflow.start_child_workflow()`, places them in a list, and resolves the result later, like the following example:\r\n```python\r\nclass Child:\r\n    async def run(self) -> bool:\r\n        return True\r\n\r\nclass Parent:\r\n    async def run(self, n: int):\r\n        children = []\r\n\r\n        for _ in range(n):\r\n            child = await workflow.start_child_workflow(Child, ...)\r\n            children.append(child)\r\n\r\n        ...\r\n        for child in children:\r\n            result = await child.result()\r\n            # do something with result \r\n```\r\n\r\nand test code like the following:\r\n```python\r\nasync def test_parent():\r\n    # setup test env worker with both workflows\r\n    wf = await env.client.start_workflow(\"parent\", ...)\r\n    await env.sleep(duration=timedelta(seconds=5))\r\n    await wf.result()\r\n```\r\n\r\n### Describe the bug\r\n\r\nEven when I have that exact child workflow, I get an `InvalidStateError` saying `Result is not set`. If I do not put the handler in a list and immediately call `await child.result()` it blocks indefinitely. However if I use `workflow.execute_child_workflow()` everything works fine. It's also worth noting these workflows work fine in an actual execution, this issue only exists using the `testing.WorkflowEnvironment`.\r\n\r\n\r\n### Minimal Reproduction\r\n\r\nWrite a workflow that calls multiple child workflows using `workflow.start_child_workflow()`, write a test with a single sleep before awaiting the parent's result.\r\n\r\n### Environment/Versions\r\n\r\n- Ubuntu 22.04 AMD EPYC 7352\r\n- Temporal 1.22.5 and Python SDK 1.3.0\r\n- from source\r\n\r\n### Additional context\r\n\r\nN/A\r\n","closedAt":null,"comments":[{"id":"IC_kwDOGusT1c6FTtVo","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> await child.result()\r\n\r\nThis is not valid API and a type checker should catch this. Starting a child workflow returns a `ChildWorkflowHandle` which is an `asyncio.Task` that is already waiting on result and should be awaited itself to get the result (e.g. just `await child`). This is unlike starting a workflow from a client which uses a workflow handle that can be fetched in other ways and therefore is not always a task and therefore does have a separate `.result()` to start the awaiting process.","createdAt":"2024-07-18T13:33:11Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/586#issuecomment-2236536168","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6FTxeY","author":{"login":"cpg1111"},"authorAssociation":"NONE","body":"Ah ok, yes that fixed it. I didn't see anything around this in the docs regarding `ChildWorkflowHandle`, just that it inherits from `asycnio.Task`, I'd be happy to submit a PR including this, assuming the docs are autogenerated?","createdAt":"2024-07-18T13:40:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/586#issuecomment-2236553112","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6FTygS","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Unsure which docs you are referring to (there is https://github.com/temporalio/sdk-python/blob/main/README.md, https://python.temporal.io, and https://docs.temporal.io/develop/python/) but yes, we happily accept contributions on them all.","createdAt":"2024-07-18T13:42:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/586#issuecomment-2236557330","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6FTz5A","author":{"login":"cpg1111"},"authorAssociation":"NONE","body":"I was referring to the second link, but I can submit PRs to the others where it makes sense.","createdAt":"2024-07-18T13:45:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/586#issuecomment-2236563008","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6FT1ZL","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"API docs make sense. That is auto generated from docstrings yes. PRs to this repo welcome to update those API docs.","createdAt":"2024-07-18T13:46:59Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/586#issuecomment-2236569163","viewerDidAuthor":false}],"createdAt":"2024-07-18T00:23:24Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":586,"reactionGroups":[],"state":"OPEN","title":"[Bug] workflow.start_child_workflow() behaving differently than workflow.execute_child_workflow() in tests","updatedAt":"2024-07-18T13:47:14Z","url":"https://github.com/temporalio/sdk-python/issues/586"}
