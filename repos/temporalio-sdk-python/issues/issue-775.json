{"assignees":[],"author":{"id":"MDQ6VXNlcjUxNDkzMg==","is_bot":false,"login":"antmendoza","name":"Antonio Mendoza PÃ©rez"},"body":"### What are you really trying to do?\nAdd custom tags to SDK metrics \n\n\n<!-- \nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \n-->\n\n### Describe the bug\n\nsdk metrics no longer include tags added with telemetry.global_tags , which appear to be the expected behavior https://python.temporal.io/temporalio.runtime.TelemetryConfig.html#global_tags\n\n\n<img width=\"788\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/1a05b6f8-7bda-4640-8738-28612cafd8e1\" />\n\nrunning the same with version 1.3 works as expected \n\n<img width=\"1456\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/c3c37aa1-671a-491b-ae42-3f38238c5c69\" />\n\n\n### Minimal Reproduction\n\n<!-- \nModify our hello world templates to demonstrate:\n\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\n- Go: https://github.com/temporalio/money-transfer-project-template-go\n- Java: https://github.com/temporalio/money-transfer-project-template-java\n- PHP: https://github.com/temporalio/samples-php#samples\n-->\n\n### Environment/Versions\n\n<!-- Please complete the following information where relevant. -->\n\n- OS and processor: [e.g. M1 Mac, x86 Windows, Linux]\n- Temporal Version: [e.g. 1.14.0?] and/or SDK version\n- Are you using Docker or Kubernetes or building Temporal from source?\n\n### Additional context\n\n<!-- Add any other context about the problem here. -->\n","closedAt":"2025-11-25T17:39:38Z","comments":[{"id":"IC_kwDOGusT1c6f7RwB","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"To clarify, issue #380 inadvertently didn't set `global_tags` on Rust side. We need to make sure it is set and add a test or alter `test_different_runtimes` to confirm this setting (and maybe any others we want coverage for).","createdAt":"2025-02-25T19:46:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/775#issuecomment-2683116545","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6gSSY-","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"The issue here is that we use OTel's Prometheus exporting which takes the approach at https://prometheus.io/docs/guides/opentelemetry/#including-resource-attributes-at-query-time. Namely the `global_tags` are on `target_info` which you can combine with the rest at query time. I have opened https://github.com/temporalio/sdk-core/issues/882 to have us put the labels on every metric by default (with an option to restore to today's behavior).","createdAt":"2025-02-27T21:27:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/775#issuecomment-2689148478","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6j_UPC","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Note, just for linking, this is caused by an upstream OTel Rust issue (our Rust core relies on this): https://github.com/open-telemetry/opentelemetry-rust/issues/2858","createdAt":"2025-03-25T13:34:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/775#issuecomment-2751284162","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c646Hj9","author":{"login":"gregbrowndev"},"authorAssociation":"NONE","body":"> I have opened https://github.com/temporalio/sdk-core/issues/882 to have us put the labels on every metric by default (with an option to restore to today's behaviour).\n\n@cretz, what was the original intended behaviour of `global_tags` supposed to be? It could be a bit dangerous to change the default behaviour to updating metric labels now, as it could catch people off guard if they now rely on the current behaviour.\n\nFor a long time on my project, I've been using `global_tags` to set labels like `service_name`, `service_namespace`, etc. But I had a downstream Alloy collector that added these labels to all metrics (not just Temporal SDKs) from the OTEL resource by default, if they weren't already set. So I never noticed the regression in behaviour, since `global_tags` changed to update the OTEL resource / Prometheus `target_info` in the SDK, they were set as metric labels by the collector instead...\n\nSince then, I've added an ECS resource detector to the app, so I can set OTEL resource attributes like `aws.ecs.task.id`, `aws.ecs.cluster.arn`, etc. to all telemetry, and I've been using `global_tags` to do this for the SDK metrics, assuming this was always the way it was intended to work (since there isn't any other option to set an OTEL resource).\n\nSo I'd suggest, if possible, rather than have an option that toggles the behaviour of `global_tags`. It would be better to have two options, one to set resource attributes (maybe directly in `OpenTelemetryConfig`) and one to set global metric labels. There may be cases where people want to have both options simultaneously.\n\nCheers ðŸ™ðŸ» \n\n\n","createdAt":"2025-07-22T11:03:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/775#issuecomment-3102243069","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c65qwzH","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"The original intended behavior is that the tags would apply to all emitted metrics. I agree with you that the two separate options for OTel makes good sense, we can add an item to track adding those options.","createdAt":"2025-07-24T21:18:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/775#issuecomment-3114994887","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6-mmZ4","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@gregbrowndev - with `global_tags` now applying to all metrics (something we didn't intend to undo), is that acceptable? Or are you asking for a new setting for, say, `target_info_tags`?","createdAt":"2025-08-18T17:20:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/775#issuecomment-3197789816","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7ASUZ9","author":{"login":"gregbrowndev"},"authorAssociation":"NONE","body":"@cretz sorry if I was unclear. For me, if we only had one option, it would make more sense to be able to configure the OTEL resource attributes / Prometheus `target_info` via the `TelemetryConfig`, rather than adding common attributes to every metric. If we had both options, then that would be better ofc.\n\n(This is probably quite bias from having an OTEL/Alloy collector set up, but...)\n\nThe latter is a convenience. Its quite easy to add metric labels (datapoint attributes in OTEL) anywhere outside of the application by reading them from the resource attributes ([example](https://grafana.com/docs/alloy/latest/reference/components/otelcol/otelcol.exporter.prometheus/#create-prometheus-labels-from-otlp-resource-attributes)). However, it'd be pretty horrible to configure the right Resource attributes if there wasn't a direct way to do it in the SDK. You'd basically have to intercept the metrics after they've been emitted by the Rust SDK with another collector sidecar, so you could use a [resource detector](https://grafana.com/docs/alloy/latest/reference/components/otelcol/otelcol.processor.resourcedetection/) to fix them before sending them along.\n\nHowever, maybe the opposite is true for Prometheus scraping job users. The difference is OTEL is primarily push-based, so its better to set the resource attributes at the source (I'm using the same `Resource` object from an ECS detector library within the Python app to configure metrics, logs, traces, and profiles, for example. The metrics are sent to Prometheus as well...). But Prometheus scraping is pull-based, and you'd typically need service discovery anyway to do it at scale. In k8s, you get the resource metadata built-in with that (I think).\n\nI might be wrong, but I think you can relabel metrics in Prometheus scrape config using `target_info` in the same way that Alloy example does it. And for me it would be nicer to have a single `Resource` object in Python that can configure all the telemetry the same way, not just Prometheus metrics.\n\nHope that helps ","createdAt":"2025-08-26T23:15:01Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/775#issuecomment-3226027645","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7AaEul","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> For me, if we only had one option, it would make more sense to be able to configure the OTEL resource attributes / Prometheus target_info via the TelemetryConfig, rather than adding common attributes to every metric.\n\nUnfortunately many others saw the one option, `global_tags`, as meaning global and applying on every metric, and that is how we had it at one point and regressed, but we fixed the regression.\n\nCan you be a bit more concrete on the specific ask here? Knowing that we cannot alter the `global_tags` behavior that people currently rely on, what other option might you need and what should its behavior be?","createdAt":"2025-08-27T12:43:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/775#issuecomment-3228060581","viewerDidAuthor":false}],"createdAt":"2025-02-25T19:43:48Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":775,"reactionGroups":[],"state":"CLOSED","title":"[Bug] sdk metrics do not include tags added with \"telemetry.global_tags\"","updatedAt":"2025-11-25T17:39:38Z","url":"https://github.com/temporalio/sdk-python/issues/775"}
