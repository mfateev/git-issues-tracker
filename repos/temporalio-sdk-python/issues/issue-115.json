{"assignees":[],"author":{"id":"MDQ6VXNlcjE4NjQ5MjY=","is_bot":false,"login":"adrianbeloqui","name":"Adrian Beloqui"},"body":"### What are you really trying to do?\r\n\r\nI am writing some example workflows and activities to test the capabilities of this library. As I was doing so, while trying to execute a child flow with the memo argument set I get an exception that based on my very short Google search it is due to the way the value of the memo is being set on the internal object.\r\n\r\n### Describe the bug\r\n\r\nSetting a value for the memo parameter on `workflow.execute_child_worflow` function throws the exception `ValueError: Direct assignment of submessage not allowed`\r\n\r\nHere is the stacktrace:\r\n\r\n```bash\r\n2022-08-29 20:48:27,646 - WARNING - Failed activation on workflow EventAutomation with ID event-automation and run ID 9dca34d6-af85-4992-8abc-dd18d5a7b6da\r\nTraceback (most recent call last):\r\n  File \"/home/vscode/.cache/pypoetry/virtualenvs/temporal-python--nLrvWXT-py3.10/lib/python3.10/site-packages/temporalio/worker/workflow_instance.py\", line 266, in activate\r\n    self._run_once()\r\n  File \"/home/vscode/.cache/pypoetry/virtualenvs/temporal-python--nLrvWXT-py3.10/lib/python3.10/site-packages/temporalio/worker/workflow_instance.py\", line 1153, in _run_once\r\n    raise self._current_activation_error\r\n  File \"/home/vscode/.cache/pypoetry/virtualenvs/temporal-python--nLrvWXT-py3.10/lib/python3.10/site-packages/temporalio/worker/workflow_instance.py\", line 1170, in _run_top_level_workflow_function\r\n    await coro\r\n  File \"/home/vscode/.cache/pypoetry/virtualenvs/temporal-python--nLrvWXT-py3.10/lib/python3.10/site-packages/temporalio/worker/workflow_instance.py\", line 601, in run_workflow\r\n    result = await self._inbound.execute_workflow(input)\r\n  File \"/home/vscode/.cache/pypoetry/virtualenvs/temporal-python--nLrvWXT-py3.10/lib/python3.10/site-packages/temporalio/worker/workflow_instance.py\", line 1405, in execute_workflow\r\n    return await input.run_fn(*args)\r\n  File \"/workspaces/saul-sample-temporal-python/temporal_python/workflows/event_automation.py\", line 84, in run\r\n    incident = await self.create_incident(params)\r\n  File \"/workspaces/saul-sample-temporal-python/temporal_python/workflows/event_automation.py\", line 35, in create_incident\r\n    incident = await workflow.execute_child_workflow(\r\n  File \"/home/vscode/.cache/pypoetry/virtualenvs/temporal-python--nLrvWXT-py3.10/lib/python3.10/site-packages/temporalio/workflow.py\", line 3095, in execute_child_workflow\r\n    handle = await _Runtime.current().workflow_start_child_workflow(\r\n  File \"/home/vscode/.cache/pypoetry/virtualenvs/temporal-python--nLrvWXT-py3.10/lib/python3.10/site-packages/temporalio/worker/workflow_instance.py\", line 846, in workflow_start_child_workflow\r\n    return await self._outbound.start_child_workflow(\r\n  File \"/home/vscode/.cache/pypoetry/virtualenvs/temporal-python--nLrvWXT-py3.10/lib/python3.10/site-packages/temporalio/worker/workflow_instance.py\", line 1475, in start_child_workflow\r\n    return await self._instance._outbound_start_child_workflow(input)\r\n  File \"/home/vscode/.cache/pypoetry/virtualenvs/temporal-python--nLrvWXT-py3.10/lib/python3.10/site-packages/temporalio/worker/workflow_instance.py\", line 1052, in _outbound_start_child_workflow\r\n    handle._apply_start_command(self._add_command())\r\n  File \"/home/vscode/.cache/pypoetry/virtualenvs/temporal-python--nLrvWXT-py3.10/lib/python3.10/site-packages/temporalio/worker/workflow_instance.py\", line 1739, in _apply_start_command\r\n    v.memo[k] = self._instance._payload_converter.to_payloads([val])[0]\r\nValueError: Direct assignment of submessage not allowed\r\n```\r\n\r\n### Minimal Reproduction\r\n\r\n```python\r\nawait workflow.execute_child_workflow(\r\n            \"ChildWorkflow\",\r\n            {\"key1\": 1, \"key2\": 2},\r\n            id=\"child-workflow-1\",\r\n            task_timeout=timedelta(seconds=120),\r\n            memo={\"my_memo_key\": \"my memo value\"},\r\n            retry_policy=RetryPolicy(\r\n                backoff_coefficient=2.0,\r\n                maximum_interval=timedelta(seconds=120),\r\n                maximum_attempts=5,\r\n                non_retryable_error_types=[\"MyCustomNonRetriableException\"],\r\n            ),\r\n            search_attributes={\"search_attribute1\": [\"\"], \"search_attribute2\": [\"\"]}\r\n)\r\n```\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: Mac running Colima\r\n- Temporal Version: `temporalio = \"^0.1b1\"`\r\n- Are you using Docker or Kubernetes or building Temporal from source? Using Temporal's docker-compose provided environment. Executing workflow from a VSCode Dev Container using Python 3.10.6\r\n\r\n### Additional context\r\n\r\nNothing to add at this point\r\n","closedAt":"2022-09-07T22:29:17Z","comments":[{"id":"IC_kwDOGusT1c5JXZRo","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks! This is definitely a bug where I am not using the proto library properly at https://github.com/temporalio/sdk-python/blob/4db14cc7cdc01b83be656b9086ecf77aeacfac8b/temporalio/worker/workflow_instance.py#L1739 and I did not properly cover this in tests. To give background, with the Python proto SDK, you can't set messages directly on maps/lists. See https://developers.google.com/protocol-buffers/docs/reference/python-generated#map-fields in this case. You have to lazily set scalar fields only via lazy message field access. I will fix this, thanks!","createdAt":"2022-08-29T21:15:25Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/115#issuecomment-1230869608","viewerDidAuthor":false}],"createdAt":"2022-08-29T21:03:22Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":115,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Setting memo on executing child flow","updatedAt":"2022-09-07T22:29:17Z","url":"https://github.com/temporalio/sdk-python/issues/115"}
