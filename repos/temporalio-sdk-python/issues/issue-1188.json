{"assignees":[],"author":{"id":"U_kgDOBX136w","is_bot":false,"login":"BrunodsLilly","name":"Bruno"},"body":"### What are you really trying to do?\n\nI am running a workflow that passes data containing a dictionary. The dictionary's type hint uses typing.Literal for its keys. The workflow fails during data conversion when attempting to convert this dictionary.\n\n### Describe the bug\n\nWhen temporalio.converter.value_to_type attempts to convert a dictionary that has a typing.Literal as its key_type, it incorrectly uses isinstance(key, key_type) for validation.\n\nIn Python 3.13, using isinstance() with subscripted generics like typing.Literal is no longer allowed and raises a **TypeError: Subscripted generics cannot be used with class and instance checks.**\n\nThe value_to_type function catches this TypeError and re-raises its own TypeError (e.g., \"Failed converting key 'AA' to type...\"), which hides the root cause.\n\nThis bug appears to be in temporalio/converter.py around line 1601 (in v1.18.1) inside the \"mapping\" logic of converter.py::value_to_type:\n\n```python\nis_newtype = getattr(key_type, \"__supertype__\", None)\n                      if is_newtype or not isinstance(key, key_type): # <--- THIS IS THE BUG\n                          key = value_to_type(key_type, key, custom_converters)\n```\n\nStacktrace:\n```\nFailing workflow task run_id=019a2143-d61f-76f5-95c8-c4b9e79ecd51 failure=Failure { failure: Some(Failure { message: \"Failed decoding arguments\", source: \"\", stack_trace: \"  File \\\"<my_repo>/.venv/lib/python3.13/site-packages/temporalio/worker/_workflow_instance.py\\\", line 413, in activate\\n    self._apply(job)\\n    ~~~~~~~~~~~^^^^^\\n\\n  File \\\"<my_repo>/.venv/lib/python3.13/site-packages/temporalio/worker/_workflow_instance.py\\\", line 512, in _apply\\n    self._apply_resolve_activity(job.resolve_activity)\\n    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^\\n\\n  File \\\"<my_repo>/.venv/lib/python3.13/site-packages/temporalio/worker/_workflow_instance.py\\\", line 761, in _apply_resolve_activity\\n    ret_vals = self._convert_payloads(\\n        [job.result.completed.result],\\n        ret_types,\\n    )\\n\\n  File \\\"<my_repo>/.venv/lib/python3.13/site-packages/temporalio/worker/_workflow_instance.py\\\", line 2000, in _convert_payloads\\n    raise RuntimeError(\\\"Failed decoding arguments\\\") from err\\n\", encoded_attributes: None, cause: Some(Failure { message: \"Failed converting field stats on dataclass <class 'core.app.domain.models.experiments.RunSummary'>\", source: \"\", stack_trace: \"  File \\\"<my_repo>/.venv/lib/python3.13/site-packages/temporalio/worker/_workflow_instance.py\\\", line 1990, in _convert_payloads\\n    return self._payload_converter.from_payloads(\\n           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^\\n        payloads,\\n        ^^^^^^^^^\\n        type_hints=types,\\n        ^^^^^^^^^^^^^^^^^\\n    )\\n    ^\\n\\n  File \\\"<my_repo>/.venv/lib/python3.13/site-packages/temporalio/converter.py\\\", line 311, in from_payloads\\n    values.append(converter.from_payload(payload, type_hint))\\n                  ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^\\n\\n  File \\\"<my_repo>/.venv/lib/python3.13/site-packages/temporalio/converter.py\\\", line 594, in from_payload\\n    obj = value_to_type(type_hint, obj, self._custom_type_converters)\\n\\n  File \\\"<my_repo>/.venv/lib/python3.13/site-packages/temporalio/converter.py\\\", line 1645, in value_to_type\\n    raise TypeError(\\n        f\\\"Failed converting field {field.name} on dataclass {hint}\\\"\\n    ) from err\\n\", encoded_attributes: None, cause: Some(Failure { message: \"Failed converting key 'AA' to type typing.Literal['Clone', 'Chain', 'Plate', 'Well', 'DNA', 'AA', 'Clonaltype Count'] in mapping dict[typing.Literal['Clone', 'Chain', 'Plate', 'Well', 'DNA', 'AA', 'Clonaltype Count'], dict[typing.Literal['Mean', 'Median', 'Range', 'Count of Missing Values', 'Count of Unique Values', 'Data Type', 'Total Records'], str | int | float | None]]\", source: \"\", stack_trace: \"  File \\\"<my_repo>/.venv/lib/python3.13/site-packages/temporalio/converter.py\\\", line 1641, in value_to_type\\n    field_values[field.name] = value_to_type(\\n                               ~~~~~~~~~~~~~^\\n        field_hints[field.name], field_value, custom_converters\\n        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n    )\\n    ^\\n\\n  File \\\"<my_repo>/.venv/lib/python3.13/site-packages/temporalio/converter.py\\\", line 1604, in value_to_type\\n    raise TypeError(\\n        f\\\"Failed converting key {repr(key)} to type {key_type} in mapping {hint}\\\"\\n    ) from err\\n\", encoded_attributes: None, cause: Some(Failure { message: \"**Subscripted generics cannot be used with class and instance checks**\", source: \"\", stack_trace: \"  File \\\"<my_repo>/.venv/lib/python3.13/site-packages/temporalio/converter.py\\\", line 1601, in value_to_type\\n    if is_newtype or not isinstance(key, key_type):\\n                         ~~~~~~~~~~^^^^^^^^^^^^^^^\\n\\n  File \\\"<my_repo>/.venv/lib/python3.13/site-packages/temporalio/worker/workflow_sandbox/_importer.py\\\", line 497, in __call__\\n    return self.current(*args, **kwargs)\\n           ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^\\n\\n  File \\\"<my_repo>/.venv/lib/python3.13/site-packages/temporalio/worker/workflow_sandbox/_importer.py\\\", line 120, in unwrap_second_param\\n    return orig(a, b)\\n\\n  File \\\"/opt/homebrew/Cellar/python@3.13/3.13.2/Frameworks/Python.framework/Versions/3.13/lib/python3.13/typing.py\\\", line 1375, in __instancecheck__\\n    return self.__subclasscheck__(type(obj))\\n           ~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\\n\\n  File \\\"/opt/homebrew/Cellar/python@3.13/3.13.2/Frameworks/Python.framework/Versions/3.13/lib/python3.13/typing.py\\\", line 1378, in __subclasscheck__\\n    raise TypeError(\\\"**Subscripted generics cannot be used with\\\"\\n                    \\\" class and instance checks**\\\")\\n\", encoded_attributes: None, cause: None, failure_info: Some(ApplicationFailureInfo(ApplicationFailureInfo { r#type: \"TypeError\", non_retryable: false, details: None, next_retry_delay: None, category: Unspecified })) }), failure_info: Some(ApplicationFailureInfo(ApplicationFailureInfo { r#type: \"TypeError\", non_retryable: false, details: None, next_retry_delay: None, category: Unspecified })) }), failure_info: Some(ApplicationFailureInfo(ApplicationFailureInfo { r#type: \"TypeError\", non_retryable: false, details: None, next_retry_delay: None, category: Unspecified })) }), failure_info: Some(ApplicationFailureInfo(ApplicationFailureInfo { r#type: \"RuntimeError\", non_retryable: false, details: None, next_retry_delay: None, category: Unspecified })) }), force_cause: Unspecified }\n```\n\n\n### Minimal Reproduction\n\nThe following pytest unit test reliably reproduces the bug by isolating the value_to_type function. This test expects the \"Failed converting key\" TypeError, confirming the bug's presence.\n\n```python\nimport pytest\nimport typing\nfrom temporalio.converter import value_to_type\n\ndef test_value_to_type_literal_key_bug():\n    \"\"\"\n    Reproduces the bug where value_to_type fails on a dict \n    with a typing.Literal key on Python 3.13+.\n    \"\"\"\n    \n    # 1. Define the types\n    KeyHint = typing.Literal[\"Key1\", \"Key2\"]\n    InnerKeyHint = typing.Literal[\"Inner1\", \"Inner2\"]\n    InnerValueHint = str | int | float | None\n    ValueHint = dict[InnerKeyHint, InnerValueHint]\n\n    # 2. Define the hint and value that cause the crash\n    hint_with_bug = dict[KeyHint, ValueHint]\n    value_to_convert = {\"Key1\": {\"Inner1\": 123.45, \"Inner2\": 10}}\n    custom_converters = []\n\n    # 3. Assert that the function raises the specific TypeError\n    # This test PASSES if the bug is present.\n    # It will FAIL if the bug is fixed (as the error won't be raised).\n    with pytest.raises(TypeError, match=\"Failed converting key 'Key1' to type\"):\n        value_to_type(hint_with_bug, value_to_convert, custom_converters)\n```\n\n\n### Environment/Versions\n\n- OS and processor: macOS (Apple Silicon, based on /opt/homebrew/)\n- Python Version: 3.13.2\n- Temporal Version: 1.18.1\n- Using Docker, K8s, and building from source\n\n### Additional context\n\nThe fix is to add a check to see if key_type is a \"real\" class (like int or str) before calling isinstance(), as isinstance(typing.Literal[...], type) returns False.\n\nProposed Fix:\n\nChange this line:\n\n```\nif is_newtype or not isinstance(key, key_type):\n```\n\nTo this:\n\n```python\nif (\n    is_newtype\n    or not isinstance(key_type, type)  # Check if key_type is a class\n    or not isinstance(key, key_type)\n):\n```\n\nThis short-circuits the logic and avoids calling isinstance(key, key_type) when key_type is a generic, correctly falling through to the value_to_type call which handles Literal properly.\n","closedAt":"2025-10-30T20:33:18Z","comments":[],"createdAt":"2025-10-26T16:15:16Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1188,"reactionGroups":[],"state":"CLOSED","title":"[Bug] converter.py: TypeError on Python 3.13 when using isinstance with typing.Literal","updatedAt":"2025-10-30T20:33:18Z","url":"https://github.com/temporalio/sdk-python/issues/1188"}
