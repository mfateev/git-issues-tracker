{"assignees":[],"author":{"id":"MDQ6VXNlcjc5NDIzNjQz","is_bot":false,"login":"alemar99","name":"Alessandro Marcolini"},"body":"### What are you really trying to do?\n\nI have a parent workflow which spawns multiple child workflows. I want to write a test to make sure that cancelling one child workflow doesn't affect the execution of others. Also, I have an activity to be executed on child workflow failures excluding Cancelled errors that I want to test as well.\n\n### Describe the bug\n\nWhen trying to cancel a workflow I keep getting a warning from temporal_sdk_core about an invalid transition of state:\n```\n2026-01-16T16:29:02.805388Z  WARN temporal_sdk_core::worker::workflow::managed_run: Error while updating workflow error=Fatal(\"ActivityMachine in state ScheduledActivityCancelCommandCreated says the transition is invalid during event EventInfo { \nevent_id: 10, event_type: ActivityTaskStarted }\")\n2026-01-16T16:29:02.805454Z  WARN temporal_sdk_core::worker::workflow: Failing workflow task run_id=61d7166e-1f0f-4f45-8646-2ef967ee51c0 failure=Failure { failure: Some(Failure { message: \"Fatal error in workflow machines: ActivityMachine in stat\ne ScheduledActivityCancelCommandCreated says the transition is invalid during event EventInfo { event_id: 10, event_type: ActivityTaskStarted }\", source: \"\", stack_trace: \"\", encoded_attributes: None, cause: None, failure_info: Some(ApplicationFa\nilureInfo(ApplicationFailureInfo { r#type: \"\", non_retryable: false, details: None, next_retry_delay: None })) }), force_cause: Unspecified }\n```\n\nAs a result, the workflow is not cancelled and the `await handle.cancel()` call doesn't raise any exception.\n\n### Minimal Reproduction\nI wrote the following reproducer based on your samples. It should fail on every run, but it's possible to be a little bit flaky.\n```py\nimport asyncio\nimport logging\nimport pytest\nimport uuid\nfrom dataclasses import dataclass\nfrom datetime import timedelta\n\nfrom temporalio import activity, workflow\nfrom temporalio.client import WorkflowExecutionStatus\nfrom temporalio.exceptions import (\n    ChildWorkflowError,\n    is_cancelled_exception,\n)\nfrom temporalio.service import RPCError\nfrom temporalio.testing import WorkflowEnvironment\nfrom temporalio.worker import Worker\n\n\n@activity.defn\nasync def get_string() -> str:\n    return \"blah\"\n\n\n@dataclass\nclass ComposeGreetingInput:\n    greeting: str\n    name: str\n\n\n@workflow.defn\nclass ComposeGreetingWorkflow1:\n    @workflow.run\n    async def run(self, input: ComposeGreetingInput) -> str:\n        logging.info(f\"start child: {input.greeting}\")\n        r = await workflow.execute_activity(\n            get_string,\n            start_to_close_timeout=timedelta(seconds=10),\n        )\n        logging.info(f\"{input.greeting}: {r}\")\n        return f\"{input.greeting}, {input.name}!\"\n\n\n@dataclass\nclass ErrorInput:\n    errors: list\n\n\n@activity.defn\nasync def return_errors(input: ErrorInput):\n    activity.logger.info(\"Running activity with parameter %s\" % input)\n    logging.info(f\"Errors: {input.errors}\")\n\n\n@workflow.defn\nclass GreetingWorkflow:\n    @workflow.run\n    async def run(self, name: str) -> None:\n        logging.info(\"start parent wf\")\n        results = []\n        errors = []\n        greetings = (\"hello\", \"ciao\", \"hola\")\n        wfs = [\n            workflow.execute_child_workflow(\n                ComposeGreetingWorkflow1.run,\n                arg=ComposeGreetingInput(greeting, name),\n                id=f\"{greeting}-wf-id\",\n                parent_close_policy=workflow.ParentClosePolicy.REQUEST_CANCEL,\n            )\n            for greeting in greetings\n        ]\n\n        for wf_execution in workflow.as_completed(wfs):\n            try:\n                result = await wf_execution\n                results.append(result)\n            except ChildWorkflowError as ex:\n                logging.info(ex)\n                if not is_cancelled_exception(ex):\n                    errors.append(ex)\n\n        if errors:\n            await workflow.execute_activity(\n                return_errors,\n                arg=ErrorInput(errors),\n                start_to_close_timeout=timedelta(seconds=10),\n            )\n\n        logging.info(f\"Results: {results}\")\n\n\n@pytest.mark.asyncio\nclass TestChildWorkflowCancellation:\n    async def test_wf_cancellation(self):\n        async with await WorkflowEnvironment.start_time_skipping() as env:\n            async with Worker(\n                env.client,\n                task_queue=\"main\",\n                workflows=[\n                    GreetingWorkflow,\n                    ComposeGreetingWorkflow1,\n                ],\n                activities=[get_string, return_errors],\n            ):\n                handle = await env.client.start_workflow(\n                    GreetingWorkflow.run,\n                    \"World\",\n                    id=str(uuid.uuid4()),\n                    task_queue=\"main\",\n                )\n                hello_wf_handle = env.client.get_workflow_handle(\"hello-wf-id\")\n                hola_wf_handle = env.client.get_workflow_handle(\"hola-wf-id\")\n                ciao_wf_handle = env.client.get_workflow_handle(\"ciao-wf-id\")\n\n                await asyncio.wait_for(\n                    cancel_workflow_immediately(ciao_wf_handle), timeout=5\n                )\n\n                await handle.result()\n\n                assert (\n                    await get_workflow_status(hello_wf_handle)\n                ) == WorkflowExecutionStatus.COMPLETED\n                assert (\n                    await get_workflow_status(hola_wf_handle)\n                ) == WorkflowExecutionStatus.COMPLETED\n\n\nasync def cancel_workflow_immediately(handle):\n    \"\"\"Calls `await handle.cancel()` until it succeeds.\n\n    Use this with `asyncio.wait_for(cancel_workflow_immediately(h), timeout=X)`\n    to specify a timeout and avoid to potentially run it forever.\n\n    The function will then assert that the status of the workflow is canceled.\n    \"\"\"\n    while (\n        status := await get_workflow_status(handle)\n    ) != WorkflowExecutionStatus.RUNNING:\n        continue\n\n    while True:\n        try:\n            await handle.cancel()\n            break\n        except RPCError:\n            continue\n\n    # Iterate until the workflow is not running anymore: the cancellation is not\n    # an immediate action and might take a bit of time.\n    while (\n        status := await get_workflow_status(handle)\n    ) == WorkflowExecutionStatus.RUNNING:\n        continue\n\n    assert status == WorkflowExecutionStatus.CANCELED, (\n        f\"Workflow not in Canceled status. Status: {status}\"\n    )\n\n\nasync def get_workflow_status(handle) -> WorkflowExecutionStatus:\n    while True:\n        try:\n            return (await handle.describe()).status\n        except RPCError:\n            continue\n```\n\n### Environment/Versions\n\n- OS and processor: Linux\n- Python SDK version: 1.8.0\n- Are you using Docker or Kubernetes or building Temporal from source? No\n\n\nI don't know if it belongs here or rather in the https://github.com/temporalio/sdk-core repository.","closedAt":null,"comments":[{"id":"IC_kwDOGusT1c7gK3lB","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"Is the SDK version you report accurate? It is quite dated. If so, could you see if the behavior differs on the latest version? ","createdAt":"2026-01-16T16:55:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1280#issuecomment-3760945473","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7gLRKQ","author":{"login":"alemar99"},"authorAssociation":"NONE","body":"Yes, unfortunately that version is accurate. If I test with newer versions I see the following:\n- 1.9.0 to 1.13.0: still fails. I don't see the warning anymore but the child workflow seems to be started again and completes without being cancelled:\n```\nINFO     root:test_workflow.py:58 start parent wf\nINFO     root:test_workflow.py:34 start child: hello\nINFO     root:test_workflow.py:34 start child: hola\nINFO     root:test_workflow.py:34 start child: ciao\nINFO     root:test_workflow.py:39 hello: blah\nINFO     root:test_workflow.py:39 hola: blah\nINFO     root:test_workflow.py:34 start child: ciao\nINFO     root:test_workflow.py:39 ciao: blah\nINFO     root:test_workflow.py:88 Results: ['hello, World!', 'hola, World!', 'ciao, World!']\nFAILED test_workflow.py::TestChildWorkflowCancellation::test_wf_cancellation - AssertionError: Workflow not in Canceled status. Status: 2\n```\n- 1.14.0: test pass\n- 1.15.0: test pass\n- 1.16.0: I had a test with another different behavior:\n```\ntest_workflow.py::TestChildWorkflowCancellation::test_wf_cancellation \n------------------------------------------------------------------------------------------------------------------- live log call --------------------------------------------------------------------------------------------------------------------\nINFO     root:test_workflow.py:58 start parent wf\nINFO     root:test_workflow.py:34 start child: hello\nINFO     root:test_workflow.py:34 start child: ciao\nINFO     root:test_workflow.py:34 start child: hola\nINFO     root:test_workflow.py:39 hello: blah\n2026-01-16T17:09:25.894923Z  WARN temporal_sdk_core::worker::workflow::managed_run: Error while updating workflow error=Fatal(\"ActivityMachine in state ScheduledActivityCancelCommandCreated says the transition is invalid during event EventInfo { \nevent_id: 10, event_type: ActivityTaskStarted }\")\nINFO     root:test_workflow.py:39 hola: blah\n2026-01-16T17:09:25.895158Z  WARN temporal_sdk_core::worker::workflow: Failing workflow task run_id=d2b258b6-f307-435d-bb94-503e92c0ac73 failure=Failure { failure: Some(Failure { message: \"Fatal error in workflow machines: ActivityMachine in stat\ne ScheduledActivityCancelCommandCreated says the transition is invalid during event EventInfo { event_id: 10, event_type: ActivityTaskStarted }\", source: \"\", stack_trace: \"\", encoded_attributes: None, cause: None, failure_info: Some(ApplicationFa\nilureInfo(ApplicationFailureInfo { r#type: \"\", non_retryable: false, details: None, next_retry_delay: None, category: Unspecified })) }), force_cause: Unspecified }\nINFO     root:test_workflow.py:34 start child: ciao\nINFO     root:test_workflow.py:77 Child Workflow execution cancelled\nINFO     root:test_workflow.py:88 Results: ['hello, World!', 'hola, World!']\nINFO     temporalio.worker._worker:_worker.py:758 Beginning worker shutdown, will wait 0:00:00 before cancelling activities\nPASSED\n```\nGot the warning, workflow was started one more time but at the end it was cancelled.\n\n- 1.17.0: test pass\n- 1.18.0: test pass\n- 1.19.0: test pass\n- 1.20.0: test pass\n- 1.21.0: same as 1.16.0\n\nI'd say that from 1.14.0 to 1.21.0 the error might still come up, but it's rather difficult (maybe I was just lucky, while switching versions I was executing the test 10-20 times) and at the end it cancels the workflow (even if it's strangely starting another one).\n\nSo I'd say from 1.8.0 to 1.13.0 -> fully reproducible; from 1.14.0 to latest -> flaky","createdAt":"2026-01-16T17:22:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1280#issuecomment-3761050256","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7g9n0z","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"I ran your repro a bunch of times on `1.21.0` without seeing any invalid state warning. For the old versions where it is reproducible, we would simply recommend upgrading. We don't currently maintain bug fixes to old versions of the SDK.","createdAt":"2026-01-20T18:05:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1280#issuecomment-3774250291","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7hIQsl","author":{"login":"alemar99"},"authorAssociation":"NONE","body":"I can reproduce it with `1.21.1` but it has a very very low occurrence rate.\n\nAnyway, is this the right way of testing this behavior? Or is there a better method?","createdAt":"2026-01-21T09:23:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1280#issuecomment-3777039141","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7hSbTx","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"I'm not entirely clear what you are trying to validate. It's true that cancellation of the child shouldn't cause a non-cancellation failure in the parent, but it is not true that the cancellation will _necessarily_ occur. Cancelling a workflow is a request, it can either decide to continue (which you are not doing here), or the workflow may have already completed. It seems to me this has a race condition:\n```\n    while (\n        status := await get_workflow_status(handle)\n    ) != WorkflowExecutionStatus.RUNNING:\n        continue\n\n---> Here\n\n    while True:\n        try:\n            await handle.cancel()\n            break\n        except RPCError:\n            continue\n\n    # Iterate until the workflow is not running anymore: the cancellation is not\n    # an immediate action and might take a bit of time.\n    while (\n        status := await get_workflow_status(handle)\n    ) == WorkflowExecutionStatus.RUNNING:\n        continue\n\n    assert status == WorkflowExecutionStatus.CANCELED, (\n        f\"Workflow not in Canceled status. Status: {status}\"\n    )\n```\n\nIf the workflow completes where I noted, then the cancel won't occur and the assert would fail. But that doesn't sound like the case you are reporting, which is a pass with a warning in the logs.","createdAt":"2026-01-21T17:00:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1280#issuecomment-3779704049","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7hjpbk","author":{"login":"alemar99"},"authorAssociation":"NONE","body":"I'd like to test the two following things:\n- the other workflows complete without being cancelled (this test basically)\n- the activity `return_errors` is not executed because only a cancelled error occurred (not present here, I tried to keep the reproducer as small as possible)\n\nWhat do you think?\n\nYou have a good point with the race condition. In fact, if I remove the status check (before the `---> Here` mark on your comment) the occurrence rate of failures is significantly lower: only one fail in a bunch of test runs.\n\nMaybe in the newer versions of the sdk the warning is harder to be seen because of improvements made in the activity state machine(?). Should that transition of state be defined in [here](https://github.com/temporalio/sdk-core/blob/master/crates/sdk-core/src/worker/workflow/machines/activity_state_machine.rs#L35)? (most probably not I think)\n\nAnyway, I think the problem is, as you said, a race condition and that the warning can be ignored since we can see tests passing with it in the latest version.","createdAt":"2026-01-22T12:46:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1280#issuecomment-3784218340","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7hq3Tu","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"I think you may be able to get consistency by ensuring that the child to be cancelled does not complete. If it were to run forever, you know it won't finish before being cancelled.","createdAt":"2026-01-22T18:48:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1280#issuecomment-3786110190","viewerDidAuthor":false}],"createdAt":"2026-01-16T16:33:43Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1280,"reactionGroups":[],"state":"OPEN","title":"[Bug] Unable to test child workflow cancellation: Invalid transition in activity","updatedAt":"2026-01-22T18:48:56Z","url":"https://github.com/temporalio/sdk-python/issues/1280"}
