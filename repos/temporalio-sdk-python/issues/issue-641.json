{"assignees":[],"author":{"id":"MDQ6VXNlcjUxNDkzMg==","is_bot":false,"login":"antmendoza","name":"Antonio Mendoza PÃ©rez"},"body":"### What are you really trying to do?\r\n\r\nList workflow queries using the UI (Queries tab) \r\n\r\n<img width=\"1132\" alt=\"image\" src=\"https://github.com/user-attachments/assets/5f644d8a-2ab1-4492-8e78-892e002ef0c8\">\r\n\r\n<!-- \r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\n-->\r\n\r\n### Describe the bug\r\nThe UI shows \"Encoded failure\" but this is an error thrown by the worker when the UI tries to get the list of queries the workflow exposes with `queryType: \"@@temporal-internal__list`\r\n\r\nI get the same error when I use the client to send a query that is not registered in the workflow, and the client configuration has the `data_converter` which `failure_converter_class` has  `encode_common_attributes=True`\r\n\r\n\r\n### Minimal Reproduction\r\n\r\n> Full reproduction is here https://github.com/antmendoza/my-temporal-pocs/tree/main/python/_8156\r\n\r\n\r\nclone https://github.com/temporalio/samples-python/tree/main/encryption \r\n\r\nAdd the following modifications:\r\n- Create a new DefaultFailureConverter with encode_common_attributes=True\r\n\r\n```\r\nclass FailureConverterWithDecodedAttributes(temporalio.DefaultFailureConverter):\r\n    def __init__(self) -> None:\r\n        super().__init__(encode_common_attributes=True)\r\n```\r\n\r\n\r\n- Add `failure_converter_class=FailureConverterWithDecodedAttributes` to the client.\r\n```\r\n    client = await Client.connect(\r\n        \"localhost:7233\",\r\n        # Use the default converter, but change the codec\r\n        data_converter=dataclasses.replace(\r\n            temporalio.converter.default(),\r\n            payload_codec=EncryptionCodec(),\r\n            failure_converter_class=FailureConverterWithDecodedAttributes,\r\n        ),\r\n    )\r\n```\r\n\r\n\r\nAfter running a workflow, try to send a query that does not exist for the workflow.\r\n```\r\n        await client.get_workflow_handle(\"encryption-workflow-id\").query(\"non-existing-query\")\r\n```\r\n\r\nThe query will fail with \"Encoded failure\"\r\n\r\n","closedAt":null,"comments":[{"id":"IC_kwDOGusT1c6LsKwu","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Hrmm, so this is a general Temporal Core SDK issue where query failures use the `Failure` structure but the server doesn't support that for query failures. I will confer with the team on this.","createdAt":"2024-09-11T13:01:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/641#issuecomment-2343611438","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6PaZPB","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I believe we have confirmed that this is due to the UI using query failures to populate the query list but encrypting these failures is incompatible with that. We have filed an issue with the UI team to support failure decryption.","createdAt":"2024-10-10T21:22:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/641#issuecomment-2406060993","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6WRFSa","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Note, there is a server side issue to fix query failure encoding: https://github.com/temporalio/temporal/issues/6845. If this becomes high enough priority, we can add SDK-side workarounds to keep query failures in plain text temporarily.","createdAt":"2024-12-05T17:54:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/641#issuecomment-2521060506","viewerDidAuthor":false}],"createdAt":"2024-09-11T09:14:14Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":641,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"OPEN","title":"[Bug] Sending a query that is not registered in the workflow results in an \"Encoded failure\" when encode_common_attributes=True","updatedAt":"2024-12-05T17:54:26Z","url":"https://github.com/temporalio/sdk-python/issues/641"}
