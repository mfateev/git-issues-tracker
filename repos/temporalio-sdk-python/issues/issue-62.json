{"assignees":[],"author":{"id":"MDQ6VXNlcjUyNjY1NzY=","is_bot":false,"login":"nathanielobrown","name":"Nathaniel Brown"},"body":"### What are you really trying to do?\r\n\r\nFrom withing an activity I want to get the attempt number\r\n\r\n### Describe the bug\r\n\r\nI pass in a `retry_policy` to `workflow.execute_activity` and expect to be able to get that policy from within the execute activity with `activity.iinfo().retry_policy` but I get `None` instead.\r\n\r\n### Minimal Reproduction\r\nNot entirely self contained example, but I hope you get the idea.\r\n\r\nI tried to make a failing test in this repo, but I'm still unable to run the development environment. I guess this is a separate issue, but running the tests fails with `ImportError: dlopen(/Users/nob/repos/sdk-python/temporalio/bridge/temporal_sdk_bridge.abi3.so, 0x0002): tried: '/Users/nob/repos/sdk-python/temporalio/bridge/temporal_sdk_bridge.abi3.so' (mach-o file, but is an incompatible architecture (have 'x86_64', need 'arm64e'))`. My guess is that rust is cross compiling for `x86_64` rather than the `arm64e` I need for my M1 Mac for some reason ðŸ¤·â€â™‚ï¸.\r\n\r\n```python\r\nfrom datetime import timedelta\r\nimport uuid\r\nfrom temporalio import activity, workflow\r\nfrom temporalio.client import Client\r\nfrom temporalio.common import RetryPolicy\r\nfrom bots_interface.temporal.server import temporal_worker_for_test\r\n\r\n\r\n@activity.defn\r\nasync def return_retry_policy() -> RetryPolicy:\r\n    activity_info = activity.info()\r\n    # This is None!!!\r\n    return activity_info.retry_policy\r\n\r\n\r\n@workflow.defn\r\nclass Workflow:\r\n    @workflow.run\r\n    async def run(self) -> RetryPolicy:\r\n        policy = await workflow.execute_activity(\r\n            return_retry_policy,\r\n            retry_policy=RetryPolicy(maximum_attempts=3),\r\n            schedule_to_close_timeout=timedelta(seconds=5),\r\n        )\r\n        return policy\r\n\r\n\r\nasync def test_activity_info_retry_policy(temporal_client: Client):\r\n    async with temporal_worker_for_test(\r\n        temporal_client, Workflow, activities=[return_retry_policy]\r\n    ) as worker:\r\n        result = await temporal_client.execute_workflow(\r\n            Workflow.run,\r\n            id=str(uuid.uuid4()),\r\n            task_queue=worker.task_queue,\r\n            execution_timeout=timedelta(seconds=10),\r\n            retry_policy=RetryPolicy(maximum_attempts=1),\r\n        )\r\n    assert result.maximum_attempts == 3  # This fails\r\n```\r\n\r\n### Environment/Versions\r\n\r\n\r\n- OS and processor: M1 Mac, MacOS 12.4\r\n- Temporal Version: `temporalio==0.1a2`\r\n- Are you using Docker or Kubernetes or building Temporal from source?: Using embedded golang temporal server as used in the repo. So compiling myself I guess\r\n","closedAt":"2022-07-12T20:28:53Z","comments":[{"id":"IC_kwDOGusT1c5GD3TE","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks! Will investigate why retry policy is not there. Looks like I didn't properly assert for it at https://github.com/temporalio/sdk-python/blob/0392468f21d9604c828d50d34daf8c9be03b31cd/tests/worker/test_activity.py#L78. There may be a bug or two with what the server is returning on activity execution.\r\n\r\nAs for the cross-compile issue, you'll need to check `rustup` and Rust in general is defaulted to the arm target and not the x64 one. Once confirmed your default compilation target is arm, you can `poe build-develop` to get the right shared lib.","createdAt":"2022-07-05T19:26:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/62#issuecomment-1175418052","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5GD9BB","author":{"login":"nathanielobrown"},"authorAssociation":"CONTRIBUTOR","body":"Ah, thank you. This explains it:\r\n```\r\nrustup show\r\nDefault host: x86_64-apple-darwin\r\nrustup home:  /Users/nob/.rustup\r\n\r\nstable-x86_64-apple-darwin (default)\r\n```\r\nI switched my default toolchain with `rustup default stable-aarch64-apple-darwin`, re-ran `poe build-develop` and now I can run the tests. Nice to learn a little something about rust.","createdAt":"2022-07-05T19:56:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/62#issuecomment-1175441473","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5GEMbM","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I have confirmed via https://github.com/temporalio/sdk-core/blob/15ea5d3ee580e2a226eefdcf0d8444b2ae30a997/protos/local/temporal/sdk/core/activity_task/activity_task.proto#L55-L58 that we should not even expose this (that is a different kind of retry policy). None of our SDKs provide the original retry policy via the activity info (ref https://pkg.go.dev/go.temporal.io/sdk/internal#ActivityInfo, https://typescript.temporal.io/api/interfaces/activity.Info, https://www.javadoc.io/static/io.temporal/temporal-sdk/1.14.0/io/temporal/activity/ActivityInfo.html, etc) and Python shouldn't either.","createdAt":"2022-07-05T21:14:07Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/62#issuecomment-1175504588","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5GEerR","author":{"login":"nathanielobrown"},"authorAssociation":"CONTRIBUTOR","body":"Hmm, OK is there a different way for an activity to understand what retry policy it's operating under?\r\n\r\nMy use case is that my existing tasks (run using Dramatiq) log a Sentry errors and HTTP request logs on the _last retry_, which reduces logged errors to those that were not solved by retry. At some point I would also like to ask your opinion on the best way to do a Sentry integration (my guess is an interceptor?) but I don't want to ask too many questions in one day ðŸ™‚.\r\n\r\nIf there's a different approach you think could solve this problem, I would love to hear that as well.","createdAt":"2022-07-05T22:52:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/62#issuecomment-1175579345","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5GG_pm","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Hmm, OK is there a different way for an activity to understand what retry policy it's operating under? [...] My use case is that my existing tasks (run using Dramatiq) log a Sentry errors and HTTP request logs on the last retry, which reduces logged errors to those that were not solved by retry.\r\n\r\nThe problem is that an activity may not even get called for its last attempt (what if it times out before execution?). However, if you still want to do something from the activity side on last attempt, you probably need to send that as a parameter to the activity, e.g.:\r\n\r\n```python\r\n@dataclass\r\nclass MyActivityParams:\r\n    some_other_param: str\r\n    send_error_after_attempt: int\r\n\r\n@activity.defn\r\nasync def my_activity(params: MyActivityParams):\r\n    try:\r\n        ...\r\n    except Exception as err:\r\n        if activity.info().attempt >= params.send_error_after_attempt:\r\n            send_error(err)\r\n        raise\r\n```\r\n\r\nThis is untested of course, I just typed it here in issues.\r\n\r\nBut it can often be clearer and more accurate to react to activity failures when you get them back from the workflow instead of in the activity (which yes may mean starting another activity to send off the failure).\r\n\r\n> At some point I would also like to ask your opinion on the best way to do a Sentry integration (my guess is an interceptor?) but I don't want to ask too many questions in one day ðŸ™‚.\r\n\r\nAsk away. Though I would recommend the forums at https://community.temporal.io/ or the `#python-sdk` Slack channel at https://temporal.io/slack for questions instead of GH issues.","createdAt":"2022-07-06T13:42:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/62#issuecomment-1176238694","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5GH7BT","author":{"login":"nathanielobrown"},"authorAssociation":"CONTRIBUTOR","body":"> The problem is that an activity may not even get called for its last attempt (what if it times out before execution?). However, if you still want to do something from the activity side on last attempt, you probably need to send that as a parameter to the activity, e.g.:\r\n\r\nIn practice, I do not find this to be an issue. For timeouts, all I really want to track is what percentage of the time a given task times out, I don't want Sentry errors because the details are not usually important and as a timeout can happen at any time you get a whole bunch of different error reports for one reason: the task is timing out.\r\n\r\nThe issue with logging activity failures from the workflow is I would lose all of the great context that Sentry collects, like local variables and breadcrumbs. For actually control flow due to the activity failures, I agree doing that in the workflow is best but I'm thinking more of observability of errors here.\r\n\r\nIt would be nice to have the retry policy because then you can have error handling contexts that can react to to the retry policy in a generic way without passing this for every activity. However, if it's not there it's not there and thank you for the example. At least I have the attempt number and I can make it work.\r\n\r\nI'll do some experiments with Sentry setups and ask away when I'm a bit more oriented.\r\n","createdAt":"2022-07-06T17:17:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/62#issuecomment-1176481875","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5GexSw","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Closing. Feel free to reopen as necessary.","createdAt":"2022-07-12T20:28:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/62#issuecomment-1182471344","viewerDidAuthor":false}],"createdAt":"2022-07-05T19:21:23Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":62,"reactionGroups":[],"state":"CLOSED","title":"[Bug] retry_policy not availably in activity info","updatedAt":"2022-07-12T20:28:53Z","url":"https://github.com/temporalio/sdk-python/issues/62"}
