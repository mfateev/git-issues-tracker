{"assignees":[],"author":{"id":"MDQ6VXNlcjUyMjA1","is_bot":false,"login":"dandavison","name":"Dan Davison"},"body":"The workflow below succeeds, but an exception occurs and is logged by the worker. In the example below this exception does not cause a workflow or workflow task failure, but we should nevertheless prevent it. What happens is:\n\n1. An `asyncio.Task` is created, which blocks on a timer.\n2. The task is cancelled, which throws `asyncio.CancelledError` into the coroutine, and cancels the `sleep` future.\n3. But SDK internals have set a callback that attempts to resolve the future. This callback still fires at the set timer time, despite the future having been cancelled in the interim, causing `asyncio.exceptions.InvalidStateError`. See\n\nhttps://github.com/temporalio/sdk-python/blob/49ca10e413ba67e1adfeed3b5577cb4f5b007e54/temporalio/worker/_workflow_instance.py#L1453-L1457\n\n\n```\nðŸ”´ caught asyncio.CancelledError when sleeping in task\nException in callback _WorkflowInstanceImpl.workflow_sleep.<locals>.<lambda>() at /Users/dan/src/temporalio/sdk-python/temporalio/worker/_workflow_instance.py:1456\nhandle: <_TimerHandle when=1741139892.760706 _WorkflowInstanceImpl.workflow_sleep.<locals>.<lambda>() at /Users/dan/src/temporalio/sdk-python/temporalio/worker/_workflow_instance.py:1456>\nTraceback (most recent call last):\n  File \"/Users/dan/.local/share/uv/python/cpython-3.13.1-macos-aarch64-none/lib/python3.13/asyncio/events.py\", line 89, in _run\n    self._context.run(self._callback, *self._args)\n    ~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/Users/dan/src/temporalio/sdk-python/temporalio/worker/_workflow_instance.py\", line 1456, in <lambda>\n    lambda: fut.set_result(None),\n            ~~~~~~~~~~~~~~^^^^^^\nasyncio.exceptions.InvalidStateError: invalid state\nResult: Hello, World!\n```\n\n\n```python\nimport asyncio\nimport uuid\n\nfrom temporalio import workflow\nfrom temporalio.client import Client\nfrom temporalio.worker import Worker\n\n\n@workflow.defn\nclass SayHello:\n    async def _my_task(self) -> None:\n        try:\n            await workflow.sleep(6, summary=\"my task\")\n        except asyncio.CancelledError:\n            print(\"ðŸ”´ caught asyncio.CancelledError when sleeping in task\")\n\n    @workflow.run\n    async def run(self) -> str:\n        task = asyncio.create_task(self._my_task())\n        await workflow.sleep(2, summary=\"let the loop start\")\n\n        try:\n            task.cancel()\n            await task\n        except BaseException:\n            assert False, \"unreachable\"\n\n        await workflow.sleep(15)\n        return \"Hello, World!\"\n\n\nasync def main():\n    client = await Client.connect(\"localhost:7233\")\n    task_queue = \"timer-callback-exception-task-queue\"\n    async with Worker(\n        client,\n        task_queue=task_queue,\n        workflows=[SayHello],\n    ):\n        result = await client.execute_workflow(\n            SayHello.run,\n            id=str(uuid.uuid4()),\n            task_queue=task_queue,\n        )\n        print(f\"Result: {result}\")\n\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n```","closedAt":null,"comments":[{"id":"IC_kwDOGusT1c6hUL89","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":":+1: Should just not call `set_result` on an already done future (and find where else we might be doing that). This is probably just us (me) not properly thinking about the fact that in Python's `asyncio.Future` set-result-if-already-done is not a no-op (as it is in other langs and as `concurrent.futures.Future` result setter was until 3.8).","createdAt":"2025-03-07T13:11:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/782#issuecomment-2706423613","viewerDidAuthor":false}],"createdAt":"2025-03-05T02:07:47Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":782,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"OPEN","title":"[Bug] cancelled timer callback causes asyncio.exceptions.InvalidStateError","updatedAt":"2025-03-07T13:11:34Z","url":"https://github.com/temporalio/sdk-python/issues/782"}
