{"assignees":[],"author":{"id":"MDQ6VXNlcjc1Njc5MTUz","is_bot":false,"login":"assafz-q","name":""},"body":"### What are you really trying to do?\r\n\r\nI am writing a temporal workflow and I want to handle the exceptions that happen during the execution, I want the workflow to catch any unexpected error and fail the entire workflow in a non-retriable way.\r\n\r\n### Describe the bug\r\n\r\nI am catching all the exceptions during workflow run and re-raise them as non-retriable ApplicationErrors and everything works as expected except for the case where the exception is thrown during the encoding of data to an activity.\r\n\r\nRunning a workflow that sends unserializable obj to an activity results in the following history (which doesn't contain any failure in it except for the timeout [2s]):\r\n![image](https://github.com/temporalio/sdk-python/assets/75679153/0e8bfaf6-d458-4ad5-bd93-f61e16f177c4)\r\n\r\nand the following warning in the logs:\r\n```python\r\nWARN temporal_sdk_core::worker::workflow: Error while completing workflow activation error=status: InvalidArgument, message: \"invalid TaskQueue on ScheduleActivityTaskCommand: missing task queue name. ActivityId=1 ActivityType=some_activity\", details: [], metadata: MetadataMap { headers: {\"content-type\": \"application/grpc\"} }\r\n```\r\n\r\nI would expect the workflow to fail because of the exception (and log it in the history) before the timeout occurs, in the same way it happens if exception is thrown in the middle of the workflow execution.\r\n\r\n\r\n### Minimal Reproduction\r\n```python\r\n​import asyncio\r\nimport datetime\r\nimport uuid\r\n\r\nimport temporalio.activity\r\nimport temporalio.client\r\nimport temporalio.common\r\nimport temporalio.exceptions\r\nimport temporalio.worker\r\nimport temporalio.workflow\r\n\r\n\r\n#### activities\r\nclass SomeObj:  # non serializable by default so senfding it to activities should fail\r\n    def __init__(self, value: str):\r\n        self.value = value\r\n\r\n\r\n@temporalio.activity.defn\r\nasync def some_activity(obj: SomeObj) -> str:\r\n    return obj.value\r\n\r\n\r\n#### workflow\r\n@temporalio.workflow.defn\r\nclass FailingWorkflowExceptionDuringActivitySend:\r\n    @temporalio.workflow.run\r\n    async def run(self) -> str:\r\n        try:\r\n            obj = SomeObj(\"value\")\r\n            value = await temporalio.workflow.execute_activity(\r\n                some_activity,\r\n                obj,\r\n                start_to_close_timeout=datetime.timedelta(seconds=10),\r\n            )\r\n            return value\r\n        except Exception as e:\r\n            raise temporalio.exceptions.ApplicationError(\r\n                \"Failed during activity send as expected\", non_retryable=True\r\n            ) from e\r\n\r\n\r\n####\r\n\r\n\r\nasync def _main():\r\n    client = await temporalio.client.Client.connect(\r\n        target_host=\"localhost:7233\",\r\n    )\r\n\r\n    task_queue = \"task-queue-name\"\r\n    workflow = FailingWorkflowExceptionDuringActivitySend\r\n\r\n    async with temporalio.worker.Worker(\r\n        client,\r\n        task_queue=task_queue,\r\n        workflows=[workflow],\r\n        activities=[some_activity],\r\n    ):\r\n        try:\r\n            handle = await client.start_workflow(\r\n                workflow.run,\r\n                id=f\"{workflow.__name__}-{uuid.uuid4().hex}\",\r\n                task_queue=task_queue,\r\n                run_timeout=datetime.timedelta(seconds=2),\r\n                execution_timeout=datetime.timedelta(seconds=2),\r\n                retry_policy=temporalio.common.RetryPolicy(\r\n                    maximum_attempts=1,\r\n                ),\r\n            )\r\n\r\n            result = await handle.result()\r\n            print(f\"Result: {result}\")\r\n        except Exception as e:\r\n            print(f\"Workflow: {workflow.__name__} failed:{e.__cause__}\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    asyncio.run(_main())\r\n```\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: Linux\r\n- Temporal Version: sdk version: temporalio==1.6.0, temporal cli (`temporal --version`) `temporal version 0.12.0 (server 1.23.0) (ui 2.26.2)`\r\n- Are you using Docker or Kubernetes or building Temporal from source? No\r\n","closedAt":"2024-08-09T18:19:45Z","comments":[{"id":"IC_kwDOGusT1c6AAA-x","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> I would expect the workflow to fail because of the exception (and log it in the history) before the timeout occurs, in the same way it happens if exception is thrown in the middle of the workflow execution.\r\n\r\nCommon exceptions do not fail the workflow by default, they \"suspend\" it. This is the same way as if an exception is thrown in the middle of workflow execution. See https://github.com/temporalio/sdk-python?tab=readme-ov-file#exceptions. You can customize this behavior and/or customize the converter to throw certain exceptions.","createdAt":"2024-06-04T13:04:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/540#issuecomment-2147487665","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6AAJuX","author":{"login":"assafz-q"},"authorAssociation":"NONE","body":"> > I would expect the workflow to fail because of the exception (and log it in the history) before the timeout occurs, in the same way it happens if exception is thrown in the middle of the workflow execution.\r\n> \r\n> Common exceptions do not fail the workflow by default, they \"suspend\" it. This is the same way as if an exception is thrown in the middle of workflow execution. See https://github.com/temporalio/sdk-python?tab=readme-ov-file#exceptions. You can customize this behavior and/or customize the converter to throw certain exceptions.\r\n\r\nI know, that is why I catch the exception and raise it again as non-retriable `ApplicationError`.","createdAt":"2024-06-04T13:21:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/540#issuecomment-2147523479","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6AAOvg","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Right, so the exception raised by the data converter is similar to raising the exception in the workflow, but it occurs on a different path (it occurs in the payload converter not the workflow code). It's a bit advanced, but you can customize the converter the same way you customize the workflow to catch and re-raise in a certain way. Alternatively to both, you can just put `failure_exception_types=[Exception]` or similar in the `@workflow.defn` and it should fail the workflow with any exception instead of failing the task (i.e. suspending pending code fix).","createdAt":"2024-06-04T13:30:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/540#issuecomment-2147544032","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6AA7if","author":{"login":"assafz-q"},"authorAssociation":"NONE","body":"> Right, so the exception raised by the data converter is similar to raising the exception in the workflow, but it occurs on a different path (it occurs in the payload converter not the workflow code). It's a bit advanced, but you can customize the converter the same way you customize the workflow to catch and re-raise in a certain way. Alternatively to both, you can just put `failure_exception_types=[Exception]` or similar in the `@workflow.defn` and it should fail the workflow with any exception instead of failing the task (i.e. suspending pending code fix).\r\n\r\nThanks!\r\nBut I am able to catch the exception in the try except of the workflow so I think everything is as I expected.\r\nI think the problem is related to the warning log I attached to the issue:\r\n```python\r\nWARN temporal_sdk_core::worker::workflow: Error while completing workflow activation error=status: InvalidArgument, message: \"invalid TaskQueue on ScheduleActivityTaskCommand: missing task queue name. ActivityId=1 ActivityType=some_activity\", details: [], metadata: MetadataMap { headers: {\"content-type\": \"application/grpc\"} }\r\n```\r\n\r\nI was able to (maybe) fix that locally if in (`temporalio.worker._workflow_instance._ActivityHandle._apply_schedule_command`)\r\nhttps://github.com/temporalio/sdk-python/blob/365ceadb0732f36b66bf1ae2970131fc7944b565/temporalio/worker/_workflow_instance.py#L2145-L2215\r\nI moved the part that handles the payloads:\r\nhttps://github.com/temporalio/sdk-python/blob/365ceadb0732f36b66bf1ae2970131fc7944b565/temporalio/worker/_workflow_instance.py#L2167-L2170\r\nto the end of the function (_apply_schedule_command)\r\n\r\nI am not too familiar with the code, but it seems like in that context the queue name is only initialized after the payload conversion, so if I had an exception during the payload conversion it could not be sent to the temporal server.","createdAt":"2024-06-04T14:46:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-python/issues/540#issuecomment-2147727519","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6C0P0H","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> I was able to (maybe) fix that locally if in (`temporalio.worker._workflow_instance._ActivityHandle._apply_schedule_command`) to the end of the function (`_apply_schedule_command`)\r\n\r\nI see the issue. The issue is that we create the command before we try to serialize the contents. So if this does not fail the workflow task, the command is sent off incomplete (because it threw an exception during building). I have opened https://github.com/temporalio/sdk-python/issues/564 to track (it is easier as a separate issue to state the problem clearly), but will keep this issue open.","createdAt":"2024-06-27T13:47:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-python/issues/540#issuecomment-2194734343","viewerDidAuthor":false}],"createdAt":"2024-06-04T13:01:37Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":540,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Exception in converter encoding doesn't propagate as expected","updatedAt":"2024-08-09T18:19:45Z","url":"https://github.com/temporalio/sdk-python/issues/540"}
