{"assignees":[],"author":{"id":"U_kgDOBdYaYg","is_bot":false,"login":"connected-bkiiskila","name":"Benjamin Kiiskila"},"body":"### What are you really trying to do?\n\nI'm attempting to enable tracing on my worker using the TracingInterceptor and the tracer provided by ddtrace.\n\n### Describe the bug\n\nA change upstream with the OpenTelemetry SDK seems to have caused an issue with Temporal's sandbox environment, causing an error stating os.environ.get isn't allowed in a workflow.\n\nThe relevant change on the OpenTelemetry side is [here](https://github.com/open-telemetry/opentelemetry-python/commit/52abb610dbdf1751cc745720055119ca1656ec16) - if I run with a version prior to 1.29 then I no longer get an error.\n\n### Minimal Reproduction\n\nA workflow implemented on a client with the TracingInterceptor attached and a valid OpenTelemetry SDK configured, in my case I'm using ddtrace with the DD_TRACE_OTEL_ENABLED environment variable set to true. From what I can tell though the call that isn't allowed in the sandbox is coming directly from the OpenTelemetry SDK and not the ddtrace patch.\n\n### Environment/Versions\n\n- OS and processor: macOS Apple Silicon\n- Temporal Version: SDK 1.9.0\n- Running in Docker arm64\n\n### Additional context\n\nYou can see the stacktrace and error that's displayed on the Temporal UI here: https://gist.github.com/connected-bkiiskila/d11592cb86271b5f343a4d387097d418\n","closedAt":null,"comments":[{"id":"IC_kwDOGusT1c6awO5j","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks! Hrmmm...\n\nLooking at your stack trace, it appears at https://github.com/DataDog/dd-trace-py/blob/eddd51464e8c32db019e239c106317228b65667c/ddtrace/internal/opentelemetry/context.py#L24-L26 `opentelemetry.baggage` is and others are unfortunately imported at _runtime_ which means you may be inadvertently re-importing things for every workflow run. You should be able to add `import opentelemetry.baggage` somewhere outside of your workflow (e.g. where you start the worker) to run the module initialization code that `ddtrace` is running lazily. This will also improve your performance. `ddtrace` (reasonably) assumes modules are cached and that `import`s are not rerun in other environments, but that's not the case with workflows.\n\nThough I am a bit surprised our `import opentelemetry.baggage.propagation` doesn't imply this. You may _also_ have to configure the sandbox restrictions to treat these OTel imports as pass through (https://github.com/temporalio/sdk-python?tab=readme-ov-file#passthrough-modules). It will require testing...","createdAt":"2025-01-16T17:40:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/733#issuecomment-2596335203","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6awPsV","author":{"login":"connected-bkiiskila"},"authorAssociation":"NONE","body":"I'll give that extra import a shot and see if that works and report back","createdAt":"2025-01-16T17:42:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/733#issuecomment-2596338453","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6awhOz","author":{"login":"connected-bkiiskila"},"authorAssociation":"NONE","body":"Hmmm, that doesn't seem to work either - only thing I'm having luck with is the downgrade to <1.29\n\nFor that passthrough documentation, would I just be flat out allowing os.environ.get or is there a way to allow specifically the call within the opentelemetry SDK? ","createdAt":"2025-01-16T18:22:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/733#issuecomment-2596410291","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6ayGmq","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> For that passthrough documentation, would I just be flat out allowing os.environ.get or is there a way to allow specifically the call within the opentelemetry SDK?\n\nThe passthrough would be for passing through the imports, unrelated to the restrictions happening on `os.environ.get`. What's happening now, from your stack trace, is that `from opentelemetry.baggage import get_all` is being run _at runtime_ in the workflow. We want that to have already been cached. You can probably just add this to the top of your _workflow file_:\n\n```\nwith workflow.unsafe.imports_passed_through():\n    import opentelemetry.baggage\n```\n\nBut this is untested. Even if we do allow `os.environ.get` through the sandbox, the bigger problem is that you are reimporting OTel libraries for _every workflow run_ which you don't want to do.","createdAt":"2025-01-16T20:25:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/733#issuecomment-2596825514","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6aym-1","author":{"login":"connected-bkiiskila"},"authorAssociation":"NONE","body":"Seems like that <1.29 fix was a fluke and works some of the time for whatever reason so I'm likely going to have to allow the import of os.environ.","createdAt":"2025-01-16T21:45:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/733#issuecomment-2596958133","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6ayqOy","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"We may also be able to look into it, though it seems to be `ddtrace` specific in that they are importing at runtime. I do think it is worth doing your best to prevent this import from being treated as a new import for every workflow run (since that means it runs all OTel bootstrap code every run and takes up extra memory).","createdAt":"2025-01-16T21:50:05Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/733#issuecomment-2596971442","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6ayq2c","author":{"login":"connected-bkiiskila"},"authorAssociation":"NONE","body":"Yeah I'd like to avoid it if possible, would you suggest creating a ticket on the ddtrace side and referencing this?","createdAt":"2025-01-16T21:51:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/733#issuecomment-2596973980","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6ayyCT","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"`ddtrace` is not really doing anything wrong as far as a normal Python library goes. https://github.com/DataDog/dd-trace-py/blob/eddd51464e8c32db019e239c106317228b65667c/ddtrace/internal/opentelemetry/context.py#L24-L26 is just a problem in Temporal workflows. But we need to get those imports preloaded and passed through. You may be able to do something like:\n\n```python\nimport opentelemetry.baggage\nimport opentelemetry.trace\n\nmy_worker = Worker(\n  ...,\n  workflow_runner=SandboxedWorkflowRunner(\n    restrictions=SandboxRestrictions.default.with_passthrough_modules(\"opentelemetry\", \"ddtrace\")\n  )\n)\n```\n\nwhen you create your worker.","createdAt":"2025-01-16T22:04:14Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/733#issuecomment-2597003411","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c66_3ru","author":{"login":"TheCodeWrangler"},"authorAssociation":"CONTRIBUTOR","body":"I have been seeing similar errors in a deployment I have where datadog sidecars were enabled.\n\nIs this something we would need to patch into all our application workers \n\n```\nwith workflow.unsafe.imports_passed_through():\n    ...\n```\n\nOR is there something that could/should be done at the `python-sdk` level to solve this for all users?\n\n>But we need to get those imports preloaded\n\n@cretz is this something you guys plan on implementing?  If you give some clear guidance on what needs done i could possibly draft a PR for it\n\n","createdAt":"2025-07-30T17:48:31Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/733#issuecomment-3137305326","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c670qKD","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I don't think we have plans to support `ddtrace` specifically at this time. I do think you need to pass through the import of `ddtrace` if it is used in workflow code, including in workflow interceptors which are just workflow code. There may be other sandbox avoidance things that need to happen depending on the details of what `ddtrace` tries to do.","createdAt":"2025-08-04T14:59:42Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/733#issuecomment-3151143555","viewerDidAuthor":false}],"createdAt":"2025-01-16T16:08:34Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":733,"reactionGroups":[],"state":"OPEN","title":"[Bug] Unable to run workflows with OpenTelemetry and ddtrace","updatedAt":"2025-08-04T15:32:24Z","url":"https://github.com/temporalio/sdk-python/issues/733"}
