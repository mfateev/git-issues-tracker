{"assignees":[],"author":{"id":"MDQ6VXNlcjUzMDgwMjQ=","is_bot":false,"login":"andmis","name":"Andrey Mishchenko"},"body":"### What are you really trying to do?\r\n\r\n<!-- \r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\n-->\r\n\r\nStart N local activities, wait for the first one to finish, cancel the others.\r\n\r\n### Describe the bug\r\n\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n\r\nIf I start N local activities, then use `workflow.wait(tasks, return_when=asyncio.FIRST_COMPLETED)`, the `workflow.wait` coro blocks until all of the activities actually finish, instead of returning when the first one finishes. If I use non-local activities, this bug does not happen.\r\n\r\n### Minimal Reproduction\r\n\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\nhttps://github.com/andmis/snippets/tree/temporal-python-sdk-local-activity-workflow-wait-bug\r\n\r\n```\r\n# Worker output after `python run_workflow.py`\r\n2024-12-09 19:02:30.750775+00:00 (Workflow) Starting, local=False\r\n2024-12-09 19:02:30.750775+00:00 (Workflow) Waiting for first completed activity\r\n2024-12-09 11:02:30.760073 (Activity 0) Running sandbox_activity\r\n2024-12-09 11:02:30.760565 (Activity 1) Running sandbox_activity\r\n2024-12-09 11:02:32.875597 (Activity 1) Exiting sandbox_activity\r\n2024-12-09 19:02:32.891753+00:00 (Workflow) Got first completed activity, cancelling others and exiting\r\n2024-12-09 19:02:32.891753+00:00 (Workflow) Exiting\r\n2024-12-09 11:02:35.328912 (Activity 0) Cancelling sandbox_activity\r\n\r\n# Worker output after `python run_workflow.py -l`\r\n2024-12-09 19:03:48.421271+00:00 (Workflow) Starting, local=True\r\n2024-12-09 19:03:48.421271+00:00 (Workflow) Waiting for first completed activity\r\n2024-12-09 11:03:48.425911 (Activity 0) Running sandbox_activity\r\n2024-12-09 11:03:48.426165 (Activity 1) Running sandbox_activity\r\n2024-12-09 11:03:49.817020 (Activity 1) Exiting sandbox_activity\r\n2024-12-09 11:03:56.397142 (Activity 0) Exiting sandbox_activity\r\n2024-12-09 19:03:56.394210+00:00 (Workflow) Got first completed activity, cancelling others and exiting\r\n2024-12-09 19:03:56.394210+00:00 (Workflow) Exiting\r\n# Note the timestamps\r\n```\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: macOS, M1\r\n- Temporal version: 1.1.2\r\n- Python SDK version: 1.8.0\r\n- Are you using Docker or Kubernetes or building Temporal from source? No\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n","closedAt":null,"comments":[{"id":"IC_kwDOGusT1c6Ww2z8","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks! We will investigate.","createdAt":"2024-12-09T20:34:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/699#issuecomment-2529389820","viewerDidAuthor":false}],"createdAt":"2024-12-09T19:04:53Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":699,"reactionGroups":[],"state":"OPEN","title":"[Bug] `workflow.wait` broken with `asyncio.FIRST_COMPLETED` and local activities","updatedAt":"2024-12-09T20:34:48Z","url":"https://github.com/temporalio/sdk-python/issues/699"}
