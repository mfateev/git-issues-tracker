{"assignees":[],"author":{"id":"MDQ6VXNlcjk2NDU5OTI=","is_bot":false,"login":"anhdle14","name":"Le Anh Duc"},"body":"### What are you really trying to do?\r\n\r\n<!-- \r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\n-->\r\n\r\nI am currently using OpenTelemetry and Temporal Interceptors to send traces to Grafana Tempo via Grafana Agent.\r\n\r\n### Describe the bug\r\n\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n\r\n```plaintext\r\nFailed to detach context\r\nTraceback (most recent call last):\r\n  File \"/app/.venv/lib/python3.10/site-packages/temporalio/contrib/opentelemetry.py\", line 419, in _top_level_workflow_context\r\n    yield None\r\n  File \"/app/.venv/lib/python3.10/site-packages/temporalio/contrib/opentelemetry.py\", line 332, in execute_workflow\r\n    return await super().execute_workflow(input)\r\nGeneratorExit\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/app/.venv/lib/python3.10/site-packages/opentelemetry/context/__init__.py\", line 157, in detach\r\n    _RUNTIME_CONTEXT.detach(token)  # type: ignore\r\n  File \"/app/.venv/lib/python3.10/site-packages/opentelemetry/context/contextvars_context.py\", line 50, in detach\r\n    self._current_context.reset(token)  # type: ignore\r\nValueError: <Token var=<ContextVar name='current_context' default={} at 0x7f33b28ea750> at 0x7f33244d7e40> was created in a different Context\r\n```\r\n\r\nIt just returns errors like this without any more detailed \r\n\r\n### Minimal Reproduction\r\n\r\n```py\r\n# worker.py\r\n\r\nresource = Resource(attributes={SERVICE_NAME: \"worker\"})\r\n\r\nprovider = TracerProvider(resource=resource)\r\nprovider.add_span_processor(BatchSpanProcessor(ConsoleSpanExporter()))\r\nprovider.add_span_processor(BatchSpanProcessor(OTLPSpanExporter(\r\n    endpoint=\"tempo-us-central1.grafana.net:443\",\r\n    headers=[\r\n        \"authorization=Basic <REDACTED>\"\r\n    ]\r\n)))\r\n\r\n# Sets the global default tracer provider\r\ntrace.set_tracer_provider(provider)\r\n\r\n# Creates a tracer from the global tracer provider\r\ntracer = trace.get_tracer(__name__)\r\n\r\n\r\nasync def worker():\r\n    client = await Client.connect(\r\n        target_host=\"127.0.0.1:7233\",\r\n        namespace=\"default\",\r\n        interceptors=[TracingInterceptor(tracer=tracer)],\r\n    )\r\n\r\n    worker = Worker(\r\n        client=client,\r\n        task_queue=\"hello-query-task-queue\",\r\n        workflows=[GreetingWorkflow],\r\n        activities=[compose_greeting],\r\n    )\r\n    \r\n    await worker.run()\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    asyncio.run(worker())\r\n```\r\n\r\n```py\r\n# activity.py\r\nresource = Resource(attributes={\r\n    SERVICE_NAME: \"python_temporal_opentelemetry_parallel\"\r\n})\r\n\r\nprovider = TracerProvider(resource=resource)\r\nprovider.add_span_processor(BatchSpanProcessor(ConsoleSpanExporter()))\r\nprovider.add_span_processor(BatchSpanProcessor(OTLPSpanExporter()))\r\n\r\n# Sets the global default tracer provider\r\ntrace.set_tracer_provider(provider)\r\n\r\n# Creates a tracer from the global tracer provider\r\ntracer = trace.get_tracer(__name__)\r\n\r\n\r\n@activity.defn\r\nasync def say_hello_activity(name: str) -> str:\r\n    return f\"Hello, {name}!\"\r\n\r\n\r\n@workflow.defn\r\nclass SayHelloWorkflow:\r\n    @workflow.run\r\n    async def run(self) -> None:\r\n        otel_workflow.completed_span(\"parallel_wf\")\r\n        # Run 5 activities at the same time\r\n\r\n        # ...\r\n\r\nasync def main():\r\n    # Start client\r\n    client = await Client.connect(\r\n        target_host=\"localhost:7233\",\r\n        interceptors=[TracingInterceptor(tracer)],\r\n    )\r\n\r\n\r\n    # While the worker is running, use the client to run the workflow and\r\n    # print out its result. Note, in many production setups, the client\r\n    # would be in a completely separate process from the worker.\r\n    handle = await client.start_workflow(\r\n        SayHelloWorkflow.run,\r\n        id=\"hello-parallel-activity-workflow-id\",\r\n        task_queue=\"hello-activity-task-queue\",\r\n    )\r\n        \r\n    await handle\r\n    # print(f\"Result: {result}\")\r\n\r\nif __name__ == \"__main__\":\r\n    asyncio.run(main())\r\n```\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: AWS | EKS | Docker | Ubuntu\r\n- Temporal version: `temporalio = \"^0.1b2\"`\r\n- OTel version:\r\n  ```\r\n  opentelemetry-api = \"=1.13.0\"\r\n  opentelemetry-sdk = \"=1.13.0\"\r\n  opentelemetry-exporter-otlp = \"=1.11.1\"\r\n  opentelemetry-instrumentation-pymongo = \"=0.34b0\"\r\n  opentelemetry-instrumentation-logging = \"=0.34b0\"\r\n  opentelemetry-instrumentation-redis = \"=0.34b0\"\r\n  opentelemetry-instrumentation-fastapi = \"=0.34b0\"\r\n  ```\r\n- Are you using Docker or Kubernetes or building Temporal from source?\r\n\r\n  Yes\r\n\r\n### Additional context\r\n\r\nN/A\r\n\r\n<!-- Add any other context about the problem here. -->\r\n","closedAt":null,"comments":[{"id":"IC_kwDOGusT1c5MjsrE","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks for the reproduction! That really helps. I will hopefully get to this soon.","createdAt":"2022-10-19T18:41:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/160#issuecomment-1284426436","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5NnYI0","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@anhdle14 - While it takes me some time to get around to this, there is https://github.com/temporalio/samples-python/tree/main/open_telemetry that does work fine. Can you confirm? Also note that OTLP package that uses an older version of protobuf may not work with ours at this time.","createdAt":"2022-11-03T14:07:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/160#issuecomment-1302168116","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5c1Yr5","author":{"login":"nathanielobrown"},"authorAssociation":"CONTRIBUTOR","body":"I'm seeing this as well in my tests with `temporalio==1.2.0, opentelemetry-api==1.17.0, `opentelemetry-sdk==`.17.0`","createdAt":"2023-05-22T16:06:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/160#issuecomment-1557498617","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5c1gQ5","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@nathanielobrown - Can you describe what you're trying to do exactly? Are you trying to use OpenTelemetry from a workflow or in your workflow file? Can you pass through the import?","createdAt":"2023-05-22T16:22:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/160#issuecomment-1557529657","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5c1j0F","author":{"login":"nathanielobrown"},"authorAssociation":"CONTRIBUTOR","body":"I'm importing `from temporalio.contrib.opentelemetry import TracingInterceptor` and then using this interceptor for all my clients and workers. For the client I do have another interceptor I created for Sentry:\r\n```python\r\ndef get_worker_interceptors() -> Sequence[Interceptor]:\r\n    return [SentryInterceptor(), TracingInterceptor()]\r\n\r\n\r\ndef get_client_interceptors() -> Sequence[ClientInterceptor]:\r\n    return [TracingInterceptor()]\r\n```\r\nI haven't got tracing working well yet, so I'm no expert/still a bit lost in the otel stuff, but I can say I see this log output in tests that run a workflow. Maybe for all tests that run workflows, not 100% sure:\r\n\r\n```\r\nERROR:opentelemetry.context:Failed to detach context\r\nTraceback (most recent call last):\r\n  File \"/Users/nob/Library/Caches/pypoetry/virtualenvs/dd-6mCrh732-py3.10/lib/python3.10/site-packages/temporalio/contrib/opentelemetry.py\", line 427, in _top_level_workflow_context\r\n    yield None\r\n  File \"/Users/nob/Library/Caches/pypoetry/virtualenvs/dd-6mCrh732-py3.10/lib/python3.10/site-packages/temporalio/contrib/opentelemetry.py\", line 340, in execute_workflow\r\n    return await super().execute_workflow(input)\r\nGeneratorExit\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/Users/nob/Library/Caches/pypoetry/virtualenvs/dd-6mCrh732-py3.10/lib/python3.10/site-packages/opentelemetry/context/__init__.py\", line 163, in detach\r\n    _RUNTIME_CONTEXT.detach(token)  # type: ignore\r\n  File \"/Users/nob/Library/Caches/pypoetry/virtualenvs/dd-6mCrh732-py3.10/lib/python3.10/site-packages/opentelemetry/context/contextvars_context.py\", line 50, in detach\r\n    self._current_context.reset(token)  # type: ignore\r\nValueError: <Token var=<ContextVar name='current_context' default={} at 0x1104908b0> at 0x168a7fc40> was created in a different Context\r\n```","createdAt":"2023-05-22T16:33:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/160#issuecomment-1557544197","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5c1l-t","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Is that in a workflow file? Have you made sure you pass through the import?","createdAt":"2023-05-22T16:40:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/160#issuecomment-1557553069","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5c1nSQ","author":{"login":"nathanielobrown"},"authorAssociation":"CONTRIBUTOR","body":"Not sure I totally follow, but I can say I've been using `UnsandboxedWorkflowRunner` so haven't been worrying about \"pass through\" imports. My definition of getting the interceptors and creating workers are in separate modules from my workflows. Does that answer the question?","createdAt":"2023-05-22T16:45:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/160#issuecomment-1557558416","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5c12oK","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Does that answer the question?\r\n\r\nYes, if you're not using the sandbox then it must be some other issue. We have unit tests for OTel at https://github.com/temporalio/sdk-python/blob/main/tests/contrib/test_opentelemetry.py, but the original users' sample recreates the tracer twice and yours using Sentry + OTel which shouldn't matter. I will try to create a small reproducible test case when I can get to this issue.","createdAt":"2023-05-22T17:30:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/160#issuecomment-1557621258","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5fSJab","author":{"login":"nathanielobrown"},"authorAssociation":"CONTRIBUTOR","body":"Just wanted to jot down that I think this might just be an issue _on worker exit_. This happens all over the place in my tests, but I'm creating+shutting down workers all over the place as well. In production I see a lot of these errors when a worker is killed.","createdAt":"2023-06-20T11:22:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/160#issuecomment-1598592667","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5fSjA6","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Yeah, there's an issue with detach context on generator exit (i.e. when event loop is GC'd). May be similar to https://github.com/open-telemetry/opentelemetry-python/issues/2606. I have to probably just swallow detachment failure.","createdAt":"2023-06-20T12:41:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/160#issuecomment-1598697530","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5fWffM","author":{"login":"anhdle14"},"authorAssociation":"NONE","body":"> but the original users' sample recreates the tracer twice and yours using Sentry + OTel which shouldn't matter. I will try to create a small reproducible test case when I can get to this issue.\r\n\r\nSorry, I don't follow this, should I not create the tracer twice?","createdAt":"2023-06-20T23:34:48Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/160#issuecomment-1599731660","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5gqffJ","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Sorry, I don't follow this, should I not create the tracer twice?\r\n\r\nCorrect. You are already setting it globally in `worker.py` that imports `activity.py`, you don't need to set it in `activity.py`. You are also including the workflow in with the activity and I would recommend that workflows be a separate file. You should not run global code in the workflow file (it is sandboxed and will run every workflow run). See README.","createdAt":"2023-07-05T13:23:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/160#issuecomment-1621751753","viewerDidAuthor":false}],"createdAt":"2022-10-19T18:14:32Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":160,"reactionGroups":[],"state":"OPEN","title":"[Bug] OpenTelemetry interceptors report errors","updatedAt":"2024-07-31T19:11:37Z","url":"https://github.com/temporalio/sdk-python/issues/160"}
