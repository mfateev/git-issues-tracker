{"assignees":[],"author":{"id":"MDQ6VXNlcjY4Mzg5ODI=","is_bot":false,"login":"Holi0317","name":"Hollis Wu"},"body":"### What are you really trying to do?\r\n\r\nI am trying to raise an exception inside workflow which should cause the workflow to fail.\r\n\r\n<!-- \r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\n-->\r\n\r\n### Describe the bug\r\n\r\nIn the official concept documentation, the expected default behavior of retry on workflow is:\r\n\r\n> Workflow Execution: When a Workflow Execution is spawned, it is not associated with a default Retry Policy and thus does not retry by default.\r\n>\r\n> https://docs.temporal.io/retry-policies#default-behavior\r\n\r\nI try to raise an `RuntimeError`, or actually just a `ValueError` will cause this problem where python sdk raise \"Failed activation on workflow\" and retries the workflow indefinitely.\r\n\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n\r\n### Minimal Reproduction\r\n\r\n<details>\r\n  <summary>Python</summary>\r\n  \r\n```python\r\nimport asyncio\r\nimport logging\r\n\r\nfrom temporalio import workflow\r\nfrom temporalio.client import Client, WorkflowFailureError\r\nfrom temporalio.worker import Worker\r\n\r\n\r\n@workflow.defn\r\nclass GreetingWorkflow:\r\n    @workflow.run\r\n    async def run(self, name: str) -> str:\r\n        raise RuntimeError(\"Goodbye world\")\r\n\r\n        return \"\"\r\n\r\n\r\nasync def main():\r\n    # Start client\r\n    client = await Client.connect(\"localhost:7233\")\r\n\r\n    # Run a worker for the workflow\r\n    async with Worker(\r\n        client,\r\n        task_queue=\"hello-exception-task-queue\",\r\n        workflows=[GreetingWorkflow],\r\n    ):\r\n        # While the worker is running, use the client to run the workflow and\r\n        # print out its result. Note, in many production setups, the client\r\n        # would be in a completely separate process from the worker.\r\n        #\r\n        # This will raise a WorkflowFailureError with cause ActivityError with\r\n        # cause ApplicationError with the error message and stack trace.\r\n        try:\r\n            await client.execute_workflow(\r\n                GreetingWorkflow.run,\r\n                \"World\",\r\n                id=\"hello-exception-workflow-id\",\r\n                task_queue=\"hello-exception-task-queue\",\r\n            )\r\n        except WorkflowFailureError:\r\n            # Log the exception\r\n            logging.exception(\"Got workflow failure\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    asyncio.run(main())\r\n```\r\n\r\n</details>\r\n\r\nIt fails with following stacktrace:\r\n\r\n```\r\nFailed activation on workflow GreetingWorkflow with ID hello-exception-workflow-id and run ID 0d6c8b96-0db1-4652-a19a-d11055526325\r\nTraceback (most recent call last):\r\n  File \"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\", line 315, in activate\r\n    self._run_once(check_conditions=index == 1 or index == 2)\r\n  File \"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\", line 1617, in _run_once\r\n    raise self._current_activation_error\r\n  File \"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\", line 1635, in _run_top_level_workflow_function\r\n    await coro\r\n  File \"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\", line 766, in run_workflow\r\n    result = await self._inbound.execute_workflow(input)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\", line 1888, in execute_workflow\r\n    return await input.run_fn(*args)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Volumes/Projects/example/main.py\", line 13, in run\r\n    raise RuntimeError(\"Goodbye world\")\r\nRuntimeError: Goodbye world\r\n2023-11-25T03:38:06.936582Z  WARN temporal_sdk_core::worker::workflow: Failing workflow task run_id=0d6c8b96-0db1-4652-a19a-d11055526325 failure=Failure { failure: Some(Failure { message: \"Goodbye world\", source: \"\", stack_trace: \"  File \\\"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\\\", line 315, in activate\\n    self._run_once(check_conditions=index == 1 or index == 2)\\n\\n  File \\\"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\\\", line 1617, in _run_once\\n    raise self._current_activation_error\\n\\n  File \\\"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\\\", line 1635, in _run_top_level_workflow_function\\n    await coro\\n\\n  File \\\"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\\\", line 766, in run_workflow\\n    result = await self._inbound.execute_workflow(input)\\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\\n\\n  File \\\"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\\\", line 1888, in execute_workflow\\n    return await input.run_fn(*args)\\n           ^^^^^^^^^^^^^^^^^^^^^^^^^\\n\\n  File \\\"/Volumes/Projects/example/main.py\\\", line 13, in run\\n    raise RuntimeError(\\\"Goodbye world\\\")\\n\", encoded_attributes: None, cause: None, failure_info: Some(ApplicationFailureInfo(ApplicationFailureInfo { r#type: \"RuntimeError\", non_retryable: false, details: None })) }), force_cause: Unspecified }\r\nFailed activation on workflow GreetingWorkflow with ID hello-exception-workflow-id and run ID 0d6c8b96-0db1-4652-a19a-d11055526325\r\nTraceback (most recent call last):\r\n  File \"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\", line 315, in activate\r\n    self._run_once(check_conditions=index == 1 or index == 2)\r\n  File \"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\", line 1617, in _run_once\r\n    raise self._current_activation_error\r\n  File \"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\", line 1635, in _run_top_level_workflow_function\r\n    await coro\r\n  File \"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\", line 766, in run_workflow\r\n    result = await self._inbound.execute_workflow(input)\r\n             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Users/holliswu/Library/Caches/pypoetry/virtualenvs/example-5pZqKdJX-py3.12/lib/python3.12/site-packages/temporalio/worker/_workflow_instance.py\", line 1888, in execute_workflow\r\n    return await input.run_fn(*args)\r\n           ^^^^^^^^^^^^^^^^^^^^^^^^^\r\n  File \"/Volumes/Projects/example/main.py\", line 13, in run\r\n    raise RuntimeError(\"Goodbye world\")\r\nRuntimeError: Goodbye world\r\n```\r\n\r\nAnd temporal UI showing the workflow is \"running\", not \"Failed\"\r\n\r\n> Ignore the \"No Workers Running\" warning. I took this screenshot in last minute, after killing the python worker.\r\n\r\n![image](https://github.com/temporalio/sdk-python/assets/6838982/71869551-473e-403b-b271-d3526373f276)\r\n\r\n\r\nI did try to replicate this issue with go and the temporal workflow stopped correctly there:\r\n\r\n<details>\r\n  <summary>Go implementation</summary>\r\n\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"fmt\"\r\n\t\"log\"\r\n\t\"time\"\r\n\r\n\t\"go.temporal.io/sdk/client\"\r\n\r\n\t\"go.temporal.io/sdk/worker\"\r\n\t\"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\n// Workflow is a Hello World workflow definition.\r\nfunc Workflow(ctx workflow.Context, name string) (string, error) {\r\n\tao := workflow.ActivityOptions{\r\n\t\tStartToCloseTimeout: 10 * time.Second,\r\n\t}\r\n\tctx = workflow.WithActivityOptions(ctx, ao)\r\n\r\n\tlogger := workflow.GetLogger(ctx)\r\n\tlogger.Info(\"HelloWorld workflow started\", \"name\", name)\r\n\r\n\treturn \"\", fmt.Errorf(\"Goodbye world\")\r\n}\r\n\r\nfunc workerMain() {\r\n\t// The client and worker are heavyweight objects that should be created once per process.\r\n\tc, err := client.Dial(client.Options{})\r\n\tif err != nil {\r\n\t\tlog.Fatalln(\"Unable to create client\", err)\r\n\t}\r\n\tdefer c.Close()\r\n\r\n\tw := worker.New(c, \"hello-world\", worker.Options{})\r\n\r\n\tw.RegisterWorkflow(Workflow)\r\n\r\n\terr = w.Run(worker.InterruptCh())\r\n\tif err != nil {\r\n\t\tlog.Fatalln(\"Unable to start worker\", err)\r\n\t}\r\n}\r\n\r\nfunc main() {\r\n\tgo workerMain()\r\n\r\n\t// The client is a heavyweight object that should be created once per process.\r\n\tc, err := client.Dial(client.Options{})\r\n\tif err != nil {\r\n\t\tlog.Fatalln(\"Unable to create client\", err)\r\n\t}\r\n\tdefer c.Close()\r\n\r\n\tworkflowOptions := client.StartWorkflowOptions{\r\n\t\tID:        \"hello_world_workflowID\",\r\n\t\tTaskQueue: \"hello-world\",\r\n\t}\r\n\r\n\twe, err := c.ExecuteWorkflow(context.Background(), workflowOptions, Workflow, \"Temporal\")\r\n\tif err != nil {\r\n\t\tlog.Fatalln(\"Unable to execute workflow\", err)\r\n\t}\r\n\r\n\tlog.Println(\"Started workflow\", \"WorkflowID\", we.GetID(), \"RunID\", we.GetRunID())\r\n\r\n\t// Synchronously wait for the workflow completion.\r\n\tvar result string\r\n\terr = we.Get(context.Background(), &result)\r\n\tif err != nil {\r\n\t\tlog.Fatalln(\"Unable get workflow result\", err)\r\n\t}\r\n\tlog.Println(\"Workflow result:\", result)\r\n}\r\n```\r\n\r\n</details>\r\n\r\nOutput of the go version is:\r\n\r\n```\r\n2023/11/24 22:45:19 INFO  No logger configured for temporal client. Created default one.\r\n2023/11/24 22:45:19 INFO  No logger configured for temporal client. Created default one.\r\n2023/11/24 22:45:19 Started workflow WorkflowID hello_world_workflowID RunID ae2b5d3e-ff8a-4183-a717-575efbb240e0\r\n2023/11/24 22:45:19 INFO  Started Worker Namespace default TaskQueue hello-world WorkerID 15651@Holliss-MacBook-Pro.local@\r\n2023/11/24 22:45:19 INFO  HelloWorld workflow started Namespace default TaskQueue hello-world WorkerID 15651@Holliss-MacBook-Pro.local@ WorkflowType Workflow WorkflowID hello_world_workflowID RunID ae2b5d3e-ff8a-4183-a717-575efbb240e0 Attempt 1 name Temporal\r\n2023/11/24 22:45:19 Unable get workflow result workflow execution error (type: Workflow, workflowID: hello_world_workflowID, runID: ae2b5d3e-ff8a-4183-a717-575efbb240e0): Goodbye world\r\nexit status 1\r\n```\r\n\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: M1 Mac\r\n- Temporal Version: temporal version 0.10.7 (server 1.22.2) (ui 2.21.3)\r\n  - Python SDK version: 1.4.0\r\n  - Go SDK version: 1.25.1\r\n- Are you using Docker or Kubernetes or building Temporal from source? No. It's `temporal` cli from brew\r\n\r\n### Additional context\r\n\r\nI did found https://github.com/temporalio/sdk-python/pull/329 which seems related to this issue.\r\n\r\n<!-- Add any other context about the problem here. -->\r\n","closedAt":"2023-11-27T14:23:57Z","comments":[{"id":"IC_kwDOGusT1c5s5Vqi","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"This is expected, in all exception based SDKs  (like python) only Temporal Errors fail a Workflow Execution by default, other exceptions will retry the Workflow Task.  You can use [ApplicationError ](https://python.temporal.io/temporalio.exceptions.ApplicationError.html) in  the Python SDK to fail the workflow.\r\n\r\nThis is also in our documentation\r\nhttps://docs.temporal.io/references/failures#throw-from-workflows","createdAt":"2023-11-27T00:50:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/432#issuecomment-1826970274","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5s9BAj","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":":+1: To what @Quinn-With-Two-Ns said. Closing, but feel free to continue conversation here or on `#python-sdk` Slack or in the forums.","createdAt":"2023-11-27T14:23:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/432#issuecomment-1827934243","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c60k-7B","author":{"login":"fabianoengler"},"authorAssociation":"NONE","body":"I find this behavior really weird an unexpected, I ended up here after a lot of googling and had a similar journey than the OP, but my motivation is a bit different: it's for testing.\n\nI understand all the idea behind the concept of \"workflows should never fail\".\n\nBut in case of writing tests for the workflows you'd expect that if the workflow fails the test would fail as well. But that's not what happens, if the workflow fails the workflow keeps being retried indefinitely and just hangs the test suit. An that's case is a really PITA to debug.\n\nSo I spent a lot of hours googling and fiddling with the SDK source code to try to disable this automatic workflow retry.\n\nI finally found how to disable this and that's the main reason of my comment here, if others find themselves on the same situation and end landing here, hopefully they will find this comment.\n\nFirst thing I tried was to set a retry policy on the workflow with `RetryPolicy(maximum_attempts=1)`, but that doesn't work. I also tried `RetryPolicy(non_retryable_error_types=['Exception'])` but that doesn't work either, which is very surprising to me.\n\nI finally made it work by adding `workflow_failure_exception_types=[Exception]` to the test worker:\n\n```py\nasync def test_MyWorkflow(temporal_client: 'Client'):\n    task_queue_name = str(uuid.uuid4())\n    async with Worker(\n        temporal_client,\n        task_queue=task_queue_name,\n        workflows=[\n            MyWorkflow,\n        ],\n        activities=[\n            my_activity1_mocked,\n            my_activity2_mocked,\n            my_activity3_mocked,\n        ],\n        workflow_failure_exception_types=[Exception],\n    ):\n        result = await temporal_client.execute_workflow(\n            MyWorkflow.run,\n            {},\n            id=str(uuid.uuid4()),\n            task_queue=task_queue_name,\n        )\n```","createdAt":"2025-07-02T23:04:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/432#issuecomment-3029593793","viewerDidAuthor":false}],"createdAt":"2023-11-25T03:52:50Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":432,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Exception raise from workflow causes indefinite retry","updatedAt":"2025-07-02T23:04:32Z","url":"https://github.com/temporalio/sdk-python/issues/432"}
