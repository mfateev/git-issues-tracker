{"assignees":[],"author":{"id":"MDQ6VXNlcjUyMjA1","is_bot":false,"login":"dandavison","name":"Dan Davison"},"body":"The workflow below crashes the SDK. The fix may be to take a copy of this set with `list(self._tasks)`, but I haven't investigated yet:\r\n\r\nhttps://github.com/temporalio/sdk-python/blob/f96679b803803f607eb2586a63905d921347bc75/temporalio/worker/_workflow_instance.py#L1774\r\n\r\n```\r\nwait_until_positive\r\nwait_until_negative\r\nwait_until_positive\r\nwait_until_negative\r\nwait_until_positive\r\nwait_until_negative\r\nFailed running eviction job, not evicting\r\nTraceback (most recent call last):\r\n  File \"/Users/dan/src/temporalio/samples-python/.venv/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_runner.py\", line 172, in _run_code\r\n    exec(code, self.globals_and_locals, self.globals_and_locals)\r\n  File \"<string>\", line 2, in <module>\r\n  File \"/Users/dan/src/temporalio/samples-python/.venv/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_in_sandbox.py\", line 81, in activate\r\n    return self.instance.activate(act)\r\n  File \"/Users/dan/src/temporalio/samples-python/.venv/lib/python3.10/site-packages/temporalio/worker/_workflow_instance.py\", line 361, in activate\r\n    + f\"Stack traces below:\\n\\n{self._stack_trace()}\"\r\n  File \"/Users/dan/src/temporalio/samples-python/.venv/lib/python3.10/site-packages/temporalio/worker/_workflow_instance.py\", line 1774, in _stack_trace\r\n    for task in self._tasks:\r\nRuntimeError: Set changed size during iteration\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/Users/dan/src/temporalio/samples-python/.venv/lib/python3.10/site-packages/temporalio/worker/_workflow.py\", line 249, in _handle_activation\r\n    completion = await asyncio.wait_for(\r\n  File \"/Users/dan/.pyenv/versions/3.10.13/lib/python3.10/asyncio/tasks.py\", line 445, in wait_for\r\n    return fut.result()\r\n  File \"/Users/dan/.pyenv/versions/3.10.13/lib/python3.10/concurrent/futures/thread.py\", line 58, in run\r\n    result = self.fn(*self.args, **self.kwargs)\r\n  File \"/Users/dan/src/temporalio/samples-python/.venv/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_runner.py\", line 157, in activate\r\n    self._run_code(\r\n  File \"/Users/dan/src/temporalio/samples-python/.venv/lib/python3.10/site-packages/temporalio/worker/workflow_sandbox/_runner.py\", line 176, in _run_code\r\n    del self.globals_and_locals[k]\r\nKeyError: '__temporal_importer'\r\n```\r\n\r\n\r\n```python\r\nimport asyncio\r\n\r\nfrom temporalio import common, workflow\r\nfrom temporalio.client import Client\r\nfrom temporalio.worker import Worker\r\n\r\n\r\n@workflow.defn\r\nclass StackTraceBugRepro:\r\n\r\n    def __init__(self) -> None:\r\n        self.val = 1\r\n\r\n    async def wait_until_positive(self):\r\n        while True:\r\n            print(\"wait_until_positive\")\r\n            await workflow.wait_condition(lambda: self.val > 0)\r\n            self.val = -self.val\r\n\r\n    async def wait_until_negative(self):\r\n        while True:\r\n            print(\"wait_until_negative\")\r\n            await workflow.wait_condition(lambda: self.val < 0)\r\n            self.val = -self.val\r\n\r\n    @workflow.run\r\n    async def run(self):\r\n        await asyncio.gather(self.wait_until_negative(), self.wait_until_positive())\r\n\r\n\r\nasync def main():\r\n    client = await Client.connect(\"localhost:7233\")\r\n    async with Worker(\r\n        client,\r\n        task_queue=\"tq\",\r\n        workflows=[StackTraceBugRepro],\r\n    ):\r\n        await client.execute_workflow(\r\n            StackTraceBugRepro.run,\r\n            id=\"wid\",\r\n            task_queue=\"tq\",\r\n            id_reuse_policy=common.WorkflowIDReusePolicy.TERMINATE_IF_RUNNING,\r\n        )\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    asyncio.run(main())\r\n```\r\n","closedAt":"2024-05-28T22:48:39Z","comments":[],"createdAt":"2024-05-14T16:26:29Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":527,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Can crash SDK with non-halting workflow","updatedAt":"2024-05-28T22:48:39Z","url":"https://github.com/temporalio/sdk-python/issues/527"}
