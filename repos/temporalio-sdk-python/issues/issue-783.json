{"assignees":[],"author":{"id":"MDQ6VXNlcjUyNDQ0MzU=","is_bot":false,"login":"gonced8","name":"Gon√ßalo Raposo"},"body":"### What are you really trying to do?\n\n<!-- \nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \n-->\n\nRestarting workers, even with graceful shutdown, causes Workflow Tasks to timeout due to sticky execution.\n\n### Describe the bug\n\n<!-- A clear and concise description of what the bug is. -->\n\nWhen a Workflow is executing and the Workflow Worker restarts, the next Workflow Task still gets scheduled to that worker, due to execution stickiness, and causes a \"Workflow Task Timed Out\". It would be expected for the Worker to inform Temporal server of its shutdown and disable the stickiness, scheduling the next Workflow Task to the original task queue.\n\nMoreover, as for informing the server, the Workflow Worker should inform as soon as the shutdown process starts, so that no new Workflow Tasks are assigned to this worker during its graceful shutdown, because the worker wouldn't be polling anymore and those Workflow Tasks would timeout because of that.\n\nBelow I attach a minimal example to reproduce this bug. The Workflow has a 10s sleep and then returns. The Workflow Worker starts, stays running for 5 seconds and shutdowns. The Workflow Task after the sleep should be assigned to the original task queue, since the Workflow Worker is no longer running.\n\nHere you can see a screenshot of the current behavior. There is a \"Workflow Task Timed Out\" because of sticky execution.\n<img width=\"1035\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/e3e5c171-4528-40ac-9188-4a94d7d11a8f\" />\n\nDisabling the sticky execution (`max_cached_workflows=0`), the Workflow Task doesn't timeout, as expected.\n<img width=\"930\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/9bbc813d-33f2-4afa-b297-b561502935bc\" />\n\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\n\n### Minimal Reproduction\n\n<!-- \nModify our hello world templates to demonstrate:\n\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\n- Go: https://github.com/temporalio/money-transfer-project-template-go\n- Java: https://github.com/temporalio/money-transfer-project-template-java\n- PHP: https://github.com/temporalio/samples-php#samples\n-->\n\n```python\nimport asyncio\nimport multiprocessing\nfrom datetime import timedelta\n\nfrom temporalio import workflow\nfrom temporalio.client import Client\nfrom temporalio.worker import Worker\n\n\n@workflow.defn\nclass SimpleWorkflow:\n    @workflow.run\n    async def run(self) -> None:\n        workflow.logger.info(\"Running SimpleWorkflow\")\n        workflow.logger.info(\"Sleeping for 10 seconds\")\n        await workflow.sleep(timedelta(seconds=10))\n        workflow.logger.info(\"Done sleeping\")\n        return\n\n\nasync def worker():\n    # Create client connected to server at the given address\n    client = await Client.connect(\"localhost:7233\")\n\n    # Run the worker\n    async with Worker(\n        client,\n        task_queue=\"my-task-queue\",\n        workflows=[SimpleWorkflow],\n        graceful_shutdown_timeout=timedelta(seconds=3),\n        # max_cached_workflows=0,\n    ) as worker:\n        print(\"Starting worker\")\n        # Run for 5 seconds\n        await asyncio.sleep(5)\n        print(\"Stopping worker\")\n\n    print(\"Stopping Temporal client\")\n\n\nasync def client():\n    # Create client connected to server at the given address\n    client = await Client.connect(\"localhost:7233\")\n\n    # Execute a workflow\n    print(\"Executing SimpleWorkflow\")\n    await client.execute_workflow(\n        SimpleWorkflow.run,\n        id=\"test-id\",\n        task_queue=\"my-task-queue\",\n        run_timeout=timedelta(seconds=25),\n    )\n    print(f\"Finished SimpleWorkflow\")\n\n\ndef start_client():\n    asyncio.run(client())\n\n\nif __name__ == \"__main__\":\n    # Start client in different process\n    multiprocessing.Process(target=start_client).start()\n\n    # Start worker\n    asyncio.run(worker())\n    print(\"Exited worker\")\n```\n\n### Environment/Versions\n\n<!-- Please complete the following information where relevant. -->\n\n- OS and processor: M2 Mac, but same error happening with AMD based image\n- Temporal Version: CLI 1.3.0 (Server 1.27.1, UI 2.36.0) and sdk-python 1.10.0\n- Are you using Docker or Kubernetes or building Temporal from source? Tried with Temporal CLI and also with Docker and Kubernetes.\n\n### Additional context\n\n<!-- Add any other context about the problem here. -->\nDiscussed this issue with @cretz during Replay conference (thank you!).\n","closedAt":"2025-04-04T14:40:43Z","comments":[{"id":"IC_kwDOGusT1c6hTdPz","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks for opening this! We will investigate. This penalty always existed in the past but we have a new-ish `ShutdownWorker` call and something may be amiss here.","createdAt":"2025-03-07T11:37:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/783#issuecomment-2706232307","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6kK-cJ","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Just a heads up that we are looking into this. One issue we have found is that `ShutdownWorker` may not be working properly on cloud and is in the process of being fixed. However, this issue seems to state that you can replicate with a local dev server. We have replicated this and believe it may be a server-side bug. We will update when we have more details.","createdAt":"2025-03-26T13:06:46Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/783#issuecomment-2754340617","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6lf-DF","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Ok, we have done investigation on this and this is expected behavior, but the cosmetics of the task timeout could be improved and we have opened an issue on that (https://github.com/temporalio/temporal/issues/7566).\n\nSo what's happening in your code snippet is you are shutting down the worker but not start a new one. If you had a new worker you would see no penalty or task timeout. The task is showing as scheduled on the sticky queue but it's actually not on that queue necessarily since it has been shutdown, and if a worker were available listening on the normal queue, that would be the one that picked it up. The task timeout is only to re-schedule the task back on the normal queue explicitly instead of implicitly, and that only happens because there is no worker around.\n\nSo to recap, there is no runtime sticky penalty and the task scheduled on the sticky queue is actually effectively scheduled on both, and the only reason you are getting a task timeout is because there is no worker running for the on-both-queues task so it reschedules on. But there is no runtime behavior difference here.\n\nDoes this make sense? Can you confirm that this issue is only cosmetic in that you see a task timeout in history and does not have any bearing on the runtime behavior? Can you also confirm if you have another worker running instead of no worker running even the task timeout in history doesn't occur?","createdAt":"2025-04-03T18:35:02Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/783#issuecomment-2776621253","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6loySN","author":{"login":"gonced8"},"authorAssociation":"NONE","body":"Yes, it makes sense and thank you for the explanation!\nI tested locally by adding a second worker and it worked exactly as expected.\nThank you for your time!","createdAt":"2025-04-04T14:40:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/783#issuecomment-2778932365","viewerDidAuthor":false}],"createdAt":"2025-03-05T15:46:10Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":783,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Sticky execution after Worker shutdown causes \"Workflow Task Timed Out\"","updatedAt":"2025-04-04T14:49:52Z","url":"https://github.com/temporalio/sdk-python/issues/783"}
