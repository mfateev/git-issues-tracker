{"assignees":[],"author":{"id":"MDQ6VXNlcjgyMzY1MDY=","is_bot":false,"login":"jayfjin","name":"Jay Jin"},"body":"### What are you really trying to do?\r\nWe have a long running activity and would like for it not to be retried upon a rolling restart of our worker fleet.\r\n\r\n\r\n### Describe the bug\r\n\r\nDespite setting graceful_shutdown_timeout=timedelta(minutes=20), we still see our activity fail once SIGTERM is issued.\r\n\r\n\r\n### Minimal Reproduction\r\n1. Set up a long running activity and a worker processing it\r\n2. Send SIGTERM to that worker\r\n\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: Linux\r\n- Temporal Version: 1.1.0\r\n- Building the sdk from source, then packaging our own docker container and running on k8s\r\n\r\n### Additional context\r\n\r\nBased upon my reading of the code, I suspect the graceful_shutdown_timeout option isn't actually doing anything: https://github.com/temporalio/sdk-python/blob/main/temporalio/worker/_worker.py#L436\r\n\r\nHowever, I didn't do a super deep dive on this so could definitely be wrong. \r\n\r\nIf there was a way to suspend polling in python at the worker level, that would be great too - and we could implement our own signal handler. worker.suspendpolling appears to be available for go/java temporal sdk.\r\n\r\n","closedAt":"2023-08-11T13:52:04Z","comments":[{"id":"IC_kwDOGusT1c5j0r5S","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> we still see our activity fail once SIGTERM is issued.\r\n\r\nAre you calling `shutdown()` on the worker? That's what stops polling and waits graceful time before cancelling activities.\r\n\r\n> If there was a way to suspend polling in python at the worker level, that would be great too\r\n\r\nThis is what `shutdown()` does. It stops polling, notifies all activities of worker shutdown (there are things on the activity module that can be checked), waits the graceful timeout, then forcefully cancels activities.\r\n\r\nSee https://github.com/temporalio/sdk-python#worker-shutdown.","createdAt":"2023-08-11T13:02:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/367#issuecomment-1674755666","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5j05mD","author":{"login":"jayfjin"},"authorAssociation":"NONE","body":"Interesting, yes that was also tried with a SIGTERM handler, but after reading the docs now I suspect our implementation of that was flawed - thanks.","createdAt":"2023-08-11T13:40:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/367#issuecomment-1674811779","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5j0-Nh","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"(feel free to reopen or join us on Slack if still not working for you)","createdAt":"2023-08-11T13:52:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/367#issuecomment-1674830689","viewerDidAuthor":false}],"createdAt":"2023-08-10T21:57:49Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":367,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Temporal graceful shutdown does not prevent activity failure","updatedAt":"2023-08-11T13:52:20Z","url":"https://github.com/temporalio/sdk-python/issues/367"}
