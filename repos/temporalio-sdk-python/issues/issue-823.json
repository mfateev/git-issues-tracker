{"assignees":[],"author":{"id":"MDQ6VXNlcjI3OTE4MzA1","is_bot":false,"login":"CtrlAltGiri","name":"Giridhar Balachandran"},"body":"Looking to get a workflow.disabledeadlockdetection context manager similar to other languages for data converters: \n\nhttps://github.com/temporalio/rules/blob/main/rules/TMPRL1101.md\n\n","closedAt":"2025-09-23T20:03:19Z","comments":[{"id":"IC_kwDOGusT1c6mdFHg","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"That feature is in Go and Java SDK because they don't support a clear separation of payload codecs and payload converters, but other SDKs do. Deadlock detection is already disabled for the payload codec part of the data converter (because it runs outside the sandbox), just not the payload converter part. This is by intention. You should not do any heavy/IO/async work inside a payload converter. Rather, do it in a payload codec. Sometimes a custom payload codec can be combined with a custom payload converter so the converter can set some info in payload metadata that the codec needs.\n\nDoes this help? If not, can you share your use case for why deadlock detection needs to be disabled for your payload converter instead?","createdAt":"2025-04-10T12:46:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/823#issuecomment-2792640992","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6n6knZ","author":{"login":"CtrlAltGiri"},"authorAssociation":"NONE","body":"Got it. \n\nThanks @cretz \n\nI've written a custom data converter which serializers generics and pydantic objects myself. This doesn't take more than 100-200ms at best, but for large payloads, I get this 2s deadlock error.\n\nI've given my worker pod 1 CPU core, so it's definitely not a scheduling issue. \n\nTrying to understand if something else is the issue here.","createdAt":"2025-04-20T12:31:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/823#issuecomment-2817149401","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6n_FoM","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> This doesn't take more than 100-200ms at best, but for large payloads, I get this 2s deadlock error.\n\nYes, there may be something else causing deadlock detection. Deadlock detection just means a workflow task is not processing within 2s. This could mean Python is not able to process code quick enough, or something like a spinning loop or accidental thread blocking in the workflow. It could just be a simple case of too many things on one core to process workflow tasks fast enough.","createdAt":"2025-04-21T12:39:13Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/823#issuecomment-2818333196","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6pCuSH","author":{"login":"CtrlAltGiri"},"authorAssociation":"NONE","body":"Thanks @cretz I'm moving my data converter code into the codec to ensure I have enough time to serialize.\n\nOne quick question before I close the issue: Can you point me to the logic that whitelists the codec from the sandbox? I tried digging in the sdk, but couldn't find anything specific.","createdAt":"2025-04-28T18:04:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/823#issuecomment-2836063367","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6pDwGg","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Can you point me to the logic that whitelists the codec from the sandbox?\n\nIt's not whitelisted per se, it just runs before/after the sandbox. So we decode at https://github.com/temporalio/sdk-python/blob/e3603989f081bb812d883189be5f5ac9aa127089/temporalio/worker/_workflow.py#L251-L254, then we let the workflow task be processed (which is subject to deadlock detection and does payload converter stuff within it), then we encode it on the way out at https://github.com/temporalio/sdk-python/blob/e3603989f081bb812d883189be5f5ac9aa127089/temporalio/worker/_workflow.py#L337-L341\n\nSo the logic for codecs is on the boundaries, not within the task processing. It is of course still subject to task timeouts (default 10s) so we recommend trying to make it as fast as possible (e.g. if using a KMS for encryption keys, try to cache keys locally where it makes sense instead of downloading every time).","createdAt":"2025-04-28T19:43:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/823#issuecomment-2836332960","viewerDidAuthor":false}],"createdAt":"2025-04-10T05:24:36Z","labels":[{"id":"LA_kwDOGusT1c7gQgHN","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":823,"reactionGroups":[],"state":"CLOSED","title":"[Feature Request] Disabling Deadlock detection in data converters","updatedAt":"2025-09-23T20:03:23Z","url":"https://github.com/temporalio/sdk-python/issues/823"}
