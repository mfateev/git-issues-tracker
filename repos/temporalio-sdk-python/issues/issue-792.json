{"assignees":[],"author":{"id":"MDQ6VXNlcjc5MDYwNzI=","is_bot":false,"login":"Vaelatern","name":"Toyam Cox"},"body":"### What are you really trying to do?\n\nHave a workflow that times out when it has not received a signal in X hours. [works]\n\nTest that workflow. [doesn't work]\n\n### Describe the bug\n\n```\n$ uv run pytest\n  warnings.warn(PytestDeprecationWarning(_DEFAULT_FIXTURE_LOOP_SCOPE_UNSET))\n============================================= test session starts ==============================================\nplatform linux -- Python 3.13.2, pytest-8.3.5, pluggy-1.5.0\nrootdir: $(pwd)\nconfigfile: pyproject.toml\nplugins: asyncio-0.25.3\nasyncio: mode=Mode.STRICT, asyncio_default_fixture_loop_scope=None\ncollected 2 items\n\ntest_main.py .                                                                                           [ 50%]\ntest_main_broken.py ^C\n\n!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!! KeyboardInterrupt !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n/usr/lib/python3.13/selectors.py:452: KeyboardInterrupt\n(to show a full traceback on KeyboardInterrupt use --full-trace)\n======================================== 1 passed in 437.27s (0:07:17) =========================================\n```\n\nhangs forever until killed. See above where test_main_broken was killed after 7 minutes despite containing a sleep for `timedelta(minutes=1)` (and that shouldn't matter because: timeskip.)\n\n\n### Minimal Reproduction\n\n[Branch here ready to clone with minimal code](https://github.com/Vaelatern/-minimum-reproduction/tree/temporal-py-792)\n\n### Environment/Versions\n\n<!-- Please complete the following information where relevant. -->\n\n- OS and processor: Linux, x86_64\n- Temporal Version: Testing\n- Straight python dependency as per the reproduction\n\n### Additional context\n\nIs there another way, using asyncio.sleep() instead, to have the same result?","closedAt":"2025-03-26T12:53:55Z","comments":[{"id":"IC_kwDOGusT1c6j-sks","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks for the replication! We are investigating...","createdAt":"2025-03-25T12:37:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/792#issuecomment-2751121708","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6kCTQt","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Ok, preliminary research has shown the issue here is that the `wait_condition` call is raising `TimeoutError` as expected. By default this exception does not fail the workflow but rather the workflow task (see https://github.com/temporalio/sdk-python?tab=readme-ov-file#exceptions) which effectively \"suspends\" the workflow until it is fixed. This type of workflow task failure is usually meant for code failures and not runtime ones like timeout. We chose to use `TimeoutError` here because this is just a wrapper around [asyncio.wait_for](https://docs.python.org/3/library/asyncio-task.html#asyncio.wait_for) which raises that error.\n\nI will confer with the team to see if we want to consider allowing all cases of `TimeoutError` to actually be workflow failures instead of workflow task failures. In the meantime, you can change `@workflow.defn` to `@workflow.defn(failure_exception_types=[TimeoutError])` on the workflow itself, or pass in `workflow_failure_exception_types=[TimeoutError]` to the worker when creating it.","createdAt":"2025-03-25T17:45:30Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/792#issuecomment-2752066605","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6kCq0R","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I have opened #798","createdAt":"2025-03-25T18:22:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/792#issuecomment-2752163089","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6kEHfc","author":{"login":"Vaelatern"},"authorAssociation":"NONE","body":"Thank you!\n\nWhen I catch the exception in my minimum reproduction it works... unless I add the following discrete test:\n\n```\nimport uuid\nimport pytest\nfrom temporalio import workflow\nfrom temporalio.testing import WorkflowEnvironment\nfrom temporalio.worker import Worker\nfrom dataclasses import dataclass\nfrom datetime import timedelta\n\n@dataclass\nclass SayHelloArgs:\n    name: str = \"\"\n\n@workflow.defn\nclass SayHello:\n    @workflow.run\n    async def run(self, args: SayHelloArgs) -> str:\n        self.signal_received = False\n        try:\n            await workflow.wait_condition(lambda: self.signal_received, timeout=timedelta(seconds=1))\n        except asyncio.TimeoutError as e:\n            pass\n        return \"Hello\"\n\n\n@pytest.mark.asyncio\nasync def test_empty_event_workflow():\n    task_queue_name = str(uuid.uuid4())\n    async with await WorkflowEnvironment.start_time_skipping() as env:\n\n        async with Worker(\n                env.client,\n                task_queue=task_queue_name,\n                workflows=[SayHello],\n                ):\n            handle = await env.client.start_workflow(\n                    SayHello,\n                    SayHelloArgs(),\n                    id=str(uuid.uuid4()),\n                    task_queue=task_queue_name,\n                    )\n\n            assert \"Hello\" == await handle.result()\n\n```","createdAt":"2025-03-25T21:03:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/792#issuecomment-2752542684","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6kEWzv","author":{"login":"Vaelatern"},"authorAssociation":"NONE","body":"Maybe what I'd really like is better introspection so I'd have a chance to look into why these tests are hanging myself","createdAt":"2025-03-25T21:35:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/792#issuecomment-2752605423","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6kEpXp","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> unless I add the following discrete test\n\nNot following what is meant here, are you saying this test does not pass?\n\n> Maybe what I'd really like is better introspection so I'd have a chance to look into why these tests are hanging myself\n\nYes by default workflow task failures cause workflow suspension and often you need the UI or need to ask for the history to see that a workflow is suspended pending task failure. Setting the worker init option `workflow_failure_exception_types=[Exception]` will make any exception fail the workflow instead of the task which will raise an exception when trying to get workflow result.","createdAt":"2025-03-25T22:22:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/792#issuecomment-2752681449","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6kEplW","author":{"login":"Vaelatern"},"authorAssociation":"NONE","body":"Yes, the test I shared locks up as well.","createdAt":"2025-03-25T22:23:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/792#issuecomment-2752682326","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6kErD3","author":{"login":"Vaelatern"},"authorAssociation":"NONE","body":"I have updated the minimum reproduction branch with 2 commits. One fixes the first workflow, the second adds this other broken test.","createdAt":"2025-03-25T22:27:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/792#issuecomment-2752688375","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6kErMg","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"This does not happen for me. Taking your exact sample from https://github.com/Vaelatern/-minimum-reproduction/tree/temporal-py-792 and applying\n\n```diff\ndiff --git a/main.py b/main.py\nindex 3e1619d..b4735c4 100644\n--- a/main.py\n+++ b/main.py\n@@ -14,7 +14,10 @@ class WaitAMinuteWorkflow:\n     @workflow.run\n     async def run(self) -> str:\n         self.is_poked = False\n-        await workflow.wait_condition(lambda: self.is_poked, timeout=timedelta(minutes=1))\n+        try:\n+            await workflow.wait_condition(lambda: self.is_poked, timeout=timedelta(minutes=1))\n+        except asyncio.TimeoutError as e:\n+            pass\n         return \"all done\"\n \n     @workflow.signal\n```\n\n`uv run pytest` passes as expected\n\nEDIT: I see your update, will test your latest commits","createdAt":"2025-03-25T22:28:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/792#issuecomment-2752688928","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6kEtG6","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"The error you are getting now is:\n\n```\n  File \"path/to/minimum-reproduction/test_main_broken2.py\", line 20, in run\n    except asyncio.TimeoutError as e:\n           ^^^^^^^\nNameError: name 'asyncio' is not defined. Did you forget to import 'asyncio'?\n```\n\nI'd recommend passing `-k --log-cli-level=WARNING` so you can see log output, e.g. `uv run pytest -s --log-cli-level=WARNING -k test_empty_event_workflow`. This is the case where it is a legitimate task failure suspended waiting for a code fix, but yes task failures do not fail the workflow by default. As alluded to above, if you set `workflow_failure_exception_types=[Exception]` worker option on that test, the workflow will fail for all exceptions (including `NameError`).","createdAt":"2025-03-25T22:34:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/792#issuecomment-2752696762","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6kG7aE","author":{"login":"Vaelatern"},"authorAssociation":"NONE","body":"That's the core issue! Finally worked out what was wrong in my original test (invoked activities that were not registered) by chasing down reasons like with this thread. \n\nThank you! ","createdAt":"2025-03-26T05:23:06Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/792#issuecomment-2753279620","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6kK116","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"No problem! We have opened #798 to allow timeouts to cause workflow failures properly, but will otherwise close this issue (feel free to keep commenting or join us in `#python-sdk` on [Slack](https://t.mp/slack) or the forums).","createdAt":"2025-03-26T12:53:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}},{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/792#issuecomment-2754305402","viewerDidAuthor":false}],"createdAt":"2025-03-24T16:43:28Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":792,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Wait_condition timeout makes tests impossible","updatedAt":"2025-03-26T12:53:56Z","url":"https://github.com/temporalio/sdk-python/issues/792"}
