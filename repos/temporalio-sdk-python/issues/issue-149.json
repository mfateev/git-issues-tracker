{"assignees":[],"author":{"id":"MDQ6VXNlcjY1Njg0","is_bot":false,"login":"imsut","name":"Ken Kawamoto"},"body":"### What are you really trying to do?\r\n\r\n<!-- \r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\n-->\r\nI'm running two `Worker`s in a single Python process to achieve task priority. (e.g. running two workers for a queue X and one for a queue Y if I want relative priorities being 2:1.)\r\n\r\nAs a start, I run just two workers for the same queue with an activity that randomly raises an Exception to emulate transient failures.\r\n\r\n### Describe the bug\r\n\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\nThe worker process shows an error message:\r\n```\r\n  2022-10-10T13:28:26.616940Z ERROR temporal_sdk_core::worker::workflow::managed_run: Error in run machines, error: RunUpdateErr { source: Fatal(\"History is out of order. Last processed event: 33, event id: 44\"), complete_resp_chan: None }\r\n\r\n  2022-10-10T13:28:26.617278Z  WARN temporal_sdk_core::worker::workflow::workflow_stream: Error while updating workflow, error: Fatal(\"History is out of order. Last processed event: 33, event id: 44\"), run_id: f31c2102-7b86-4fa1-8822-96c0b2c3b648\r\n```\r\n\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n\r\n### Minimal Reproduction\r\n\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\n\"worker.py\" (entry point)\r\n```\r\nimport asyncio\r\n\r\nfrom temporalio.worker import Worker\r\n\r\nfrom playground.workflow import GreetingWorkflow, compose_greeting\r\nfrom playground.client import create_client\r\n\r\n\r\nasync def run_worker():\r\n    client = await create_client()\r\n\r\n    worker1 = Worker(\r\n        client,\r\n        task_queue=\"my-task-queue\",\r\n        workflows=[GreetingWorkflow],\r\n        activities=[compose_greeting],\r\n    )\r\n\r\n    worker2 = Worker(\r\n        client,\r\n        task_queue=\"my-task-queue\",\r\n        workflows=[GreetingWorkflow],\r\n        activities=[compose_greeting],\r\n    )\r\n\r\n    await asyncio.gather(worker1.run(), worker2.run())\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    asyncio.run(run_worker())\r\n```\r\n\r\n\"client.py\"\r\n```\r\nimport os\r\nfrom temporalio.client import Client\r\nfrom temporalio.service import TLSConfig\r\n\r\n\r\nasync def create_client() -> Client:\r\n    with open(\"/opt/keys/temporal-poc/client-cert.pem\", \"rb\") as f:\r\n        client_cert = f.read()\r\n    with open(\"/opt/keys/temporal-poc/client-key.pem\", \"rb\") as f:\r\n        client_key = f.read()\r\n\r\n    # Start client\r\n    return await Client.connect(\r\n        os.getenv(\"TEMPORAL_HOST\"),\r\n        namespace=os.getenv(\"TEMPORAL_NS\"),\r\n        tls=TLSConfig(\r\n            client_cert=client_cert,\r\n            client_private_key=client_key,\r\n        ),\r\n    )\r\n```\r\n\r\n\"workflow.py\"\r\n```\r\nimport asyncio\r\nfrom dataclasses import dataclass\r\nfrom datetime import timedelta\r\nimport sys\r\n\r\nimport random\r\n\r\nfrom temporalio import activity, workflow\r\n\r\n\r\n@dataclass\r\nclass ComposeGreetingInput:\r\n    greeting: str\r\n    name: str\r\n\r\n\r\n@activity.defn\r\nasync def compose_greeting(input: ComposeGreetingInput) -> str:\r\n    activity.logger.info(\"Running activity with parameter %s\" % input)\r\n\r\n    r = random.randint(0, 4)\r\n    if r <= 1:\r\n        raise Exception(\"sorry!!\")\r\n\r\n    sys.stderr.write(\"processing...\\n\")\r\n    return f\"{input.greeting}, {input.name}!\"\r\n\r\n\r\n@workflow.defn\r\nclass GreetingWorkflow:\r\n    @workflow.run\r\n    async def run(self, name: str) -> str:\r\n        workflow.logger.info(\"Running workflow with parameter %s\" % name)\r\n\r\n        activities = [\r\n            workflow.execute_activity(\r\n                compose_greeting,\r\n                ComposeGreetingInput(\"Hello\", name),\r\n                start_to_close_timeout=timedelta(seconds=3),\r\n            )\r\n            for i in range(8)\r\n        ]\r\n\r\n        tpl = await asyncio.gather(*activities)\r\n        return \" and \".join(tpl)\r\n```\r\n\r\n\"invoker.py\" (a process that triggers a workflow execution.)\r\n```\r\nimport asyncio\r\nimport logging\r\n\r\nfrom temporalio import activity, workflow\r\n\r\nfrom playground.workflow import GreetingWorkflow\r\nfrom playground.client import create_client\r\n\r\n\r\nasync def main():\r\n    # Uncomment the line below to see logging\r\n    # logging.basicConfig(level=logging.INFO)\r\n\r\n    # Start client\r\n    client = await create_client()\r\n\r\n    result = await client.execute_workflow(\r\n        GreetingWorkflow.run,\r\n        \"World\",\r\n        id=\"hello-activity-workflow-id\",\r\n        task_queue=\"my-task-queue\",\r\n    )\r\n    print(f\"Result: {result}\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    asyncio.run(main())\r\n```\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: M1 Mac (with Temporal Cloud)\r\n- Temporal Version: temporalio 0.1b2 with Python 3.7.13\r\n- Are you using Docker or Kubernetes or building Temporal from source?: Temporal Cloud\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n","closedAt":"2022-11-10T18:47:54Z","comments":[{"id":"IC_kwDOGusT1c5NnwQ-","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"After some time, I have finally been able to replicate. I have opened https://github.com/temporalio/sdk-core/issues/428 to track this.\r\n\r\nIn the meantime, it is rarely ever necessary to run the multiple workers for the same task queue in the same process. There may be a misunderstanding about what workers do. Can you share your use case more? I recall our Slack discussion and would like to continue it there or here to understand what you are trying to do.\r\n\r\n","createdAt":"2022-11-03T15:16:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/149#issuecomment-1302266942","viewerDidAuthor":false}],"createdAt":"2022-10-10T13:59:02Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":149,"reactionGroups":[],"state":"CLOSED","title":"[Bug] \"History is out of order\" reported when running two workers for the same queue","updatedAt":"2022-11-10T18:47:54Z","url":"https://github.com/temporalio/sdk-python/issues/149"}
