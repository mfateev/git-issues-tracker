{"assignees":[],"author":{"id":"U_kgDODG3mDg","is_bot":false,"login":"maciejdudko","name":"Maciej Dudkowski"},"body":"### Describe the bug\n\nThe following test sometimes fails with `temporalio.exceptions.ApplicationError: Client should never see this error!`\n\n`tests/worker/test_workflow.py::test_workflow_return_is_honored_when_it_precedes_signal_completion_command`\n\n### Minimal Reproduction\n\nRunning the test 10,000 times reproduces it fairly reliably:\n```\nzsh\nset -e\nfor i in $(seq 10000); do; poe test tests/worker/test_workflow.py -k test_workflow_return_is_honored_when_it_precedes_signal_completion_command; done\n```\n\n<!-- \nModify our hello world templates to demonstrate:\n\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\n- Go: https://github.com/temporalio/money-transfer-project-template-go\n- Java: https://github.com/temporalio/money-transfer-project-template-java\n- PHP: https://github.com/temporalio/samples-php#samples\n-->\n\n### Environment/Versions\n\n<!-- Please complete the following information where relevant. -->\n\n- OS and processor: ARM Ubuntu (CI), x86 Mac (CI), M4 Mac (local) \n- Temporal Version: [SDK main @ 257f143](https://github.com/temporalio/sdk-python/commit/257f14380aff6a5bf8e11be19061617b4a446303)\n- Are you using Docker or Kubernetes or building Temporal from source? Both\n\n### Additional context\n\n<!-- Add any other context about the problem here. -->\n\nCI jobs with failure:\nhttps://github.com/temporalio/sdk-python/actions/runs/14937905636/job/41969535426\nhttps://github.com/temporalio/sdk-python/actions/runs/14980669571/job/42083795290\n\n<details>\n\n<summary>Terminal output:</summary>\n\n```\n=================================== FAILURES ===================================\n__ test_workflow_return_is_honored_when_it_precedes_signal_completion_command __\ntemporalio.exceptions.ApplicationError: Client should never see this error!\n\nThe above exception was the direct cause of the following exception:\n\nclient = <temporalio.client.Client object at 0xfff417c82210>\nmain_workflow_returns_before_signal_completions = True\n\n    async def _do_first_completion_command_is_honored_test(\n        client: Client, main_workflow_returns_before_signal_completions: bool\n    ):\n        workflow_cls: Union[\n            Type[FirstCompletionCommandIsHonoredPingPongWorkflow],\n            Type[FirstCompletionCommandIsHonoredWorkflow],\n        ] = (\n            FirstCompletionCommandIsHonoredPingPongWorkflow\n            if main_workflow_returns_before_signal_completions\n            else FirstCompletionCommandIsHonoredWorkflow\n        )\n        async with Worker(\n            client,\n            task_queue=\"tq\",\n            workflows=[workflow_cls],\n        ) as worker:\n            handle = await client.start_workflow(\n                workflow_cls.run,\n                id=f\"wf-{uuid.uuid4()}\",\n                task_queue=worker.task_queue,\n            )\n            await handle.signal(workflow_cls.this_signal_executes_second)\n            await handle.signal(workflow_cls.this_signal_executes_first)\n            try:\n>               result = await handle.result()\n\ntests/worker/test_workflow.py:6060: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nself = <temporalio.client.WorkflowHandle object at 0xfff40eb1cf80>\n\n    async def result(\n        self,\n        *,\n        follow_runs: bool = True,\n        rpc_metadata: Mapping[str, str] = {},\n        rpc_timeout: Optional[timedelta] = None,\n    ) -> ReturnType:\n        \"\"\"Wait for result of the workflow.\n    \n        This will use :py:attr:`result_run_id` if present to base the result on.\n        To use another run ID, a new handle must be created via\n        :py:meth:`Client.get_workflow_handle`.\n    \n        Args:\n            follow_runs: If true (default), workflow runs will be continually\n                fetched, until the most recent one is found. If false, the first\n                result is used.\n            rpc_metadata: Headers used on the RPC call. Keys here override\n                client-level RPC metadata keys.\n            rpc_timeout: Optional RPC deadline to set for each RPC call. Note,\n                this is the timeout for each history RPC call not this overall\n                function.\n    \n        Returns:\n            Result of the workflow after being converted by the data converter.\n    \n        Raises:\n            WorkflowFailureError: Workflow failed, was cancelled, was\n                terminated, or timed out. Use the\n                :py:attr:`WorkflowFailureError.cause` to see the underlying\n                reason.\n            Exception: Other possible failures during result fetching.\n        \"\"\"\n        # We have to maintain our own run ID because it can change if we follow\n        # executions\n        hist_run_id = self._result_run_id\n        while True:\n            async for event in self._fetch_history_events_for_run(\n                hist_run_id,\n                wait_new_event=True,\n                event_filter_type=WorkflowHistoryEventFilterType.CLOSE_EVENT,\n                skip_archival=True,\n                rpc_metadata=rpc_metadata,\n                rpc_timeout=rpc_timeout,\n            ):\n                if event.HasField(\"workflow_execution_completed_event_attributes\"):\n                    complete_attr = event.workflow_execution_completed_event_attributes\n                    # Follow execution\n                    if follow_runs and complete_attr.new_execution_run_id:\n                        hist_run_id = complete_attr.new_execution_run_id\n                        break\n                    # Ignoring anything after the first response like TypeScript\n                    type_hints = [self._result_type] if self._result_type else None\n                    results = await self._client.data_converter.decode_wrapper(\n                        complete_attr.result,\n                        type_hints,\n                    )\n                    if not results:\n                        return cast(ReturnType, None)\n                    elif len(results) > 1:\n                        warnings.warn(f\"Expected single result, got {len(results)}\")\n                    return cast(ReturnType, results[0])\n                elif event.HasField(\"workflow_execution_failed_event_attributes\"):\n                    fail_attr = event.workflow_execution_failed_event_attributes\n                    # Follow execution\n                    if follow_runs and fail_attr.new_execution_run_id:\n                        hist_run_id = fail_attr.new_execution_run_id\n                        break\n>                   raise WorkflowFailureError(\n                        cause=await self._client.data_converter.decode_failure(\n                            fail_attr.failure\n                        ),\nE                       temporalio.client.WorkflowFailureError: Workflow execution failed\n\ntemporalio/client.py:[163](https://github.com/temporalio/sdk-python/actions/runs/14937905636/job/41969535426#step:14:164)7: WorkflowFailureError\n\nDuring handling of the above exception, another exception occurred:\n\nclient = <temporalio.client.Client object at 0xfff417c82210>\n\n    async def test_workflow_return_is_honored_when_it_precedes_signal_completion_command(\n        client: Client,\n    ):\n>       await _do_first_completion_command_is_honored_test(\n            client, main_workflow_returns_before_signal_completions=True\n        )\n\ntests/worker/test_workflow.py:6031: \n_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ \n\nclient = <temporalio.client.Client object at 0xfff417c82210>\nmain_workflow_returns_before_signal_completions = True\n\n    async def _do_first_completion_command_is_honored_test(\n        client: Client, main_workflow_returns_before_signal_completions: bool\n    ):\n        workflow_cls: Union[\n            Type[FirstCompletionCommandIsHonoredPingPongWorkflow],\n            Type[FirstCompletionCommandIsHonoredWorkflow],\n        ] = (\n            FirstCompletionCommandIsHonoredPingPongWorkflow\n            if main_workflow_returns_before_signal_completions\n            else FirstCompletionCommandIsHonoredWorkflow\n        )\n        async with Worker(\n            client,\n            task_queue=\"tq\",\n            workflows=[workflow_cls],\n        ) as worker:\n            handle = await client.start_workflow(\n                workflow_cls.run,\n                id=f\"wf-{uuid.uuid4()}\",\n                task_queue=worker.task_queue,\n            )\n            await handle.signal(workflow_cls.this_signal_executes_second)\n            await handle.signal(workflow_cls.this_signal_executes_first)\n            try:\n                result = await handle.result()\n            except WorkflowFailureError as err:\n                if main_workflow_returns_before_signal_completions:\n>                   raise RuntimeError(\n                        \"Expected no error due to main workflow coroutine returning first\"\n                    )\nE                   RuntimeError: Expected no error due to main workflow coroutine returning first\n\ntests/worker/test_workflow.py:6063: RuntimeError\n------------------------------ Captured log call -------------------------------\n21:25:24 [   DEBUG] Workflow raised failure with run ID 0196b6f0-4e20-78dc-9011-350d605a0452 (_workflow_instance.py:2003)\nTraceback (most recent call last):\n  File \"/home/runner/work/sdk-python/sdk-python/temporalio/worker/_workflow_instance.py\", line 1982, in _run_top_level_workflow_function\n    await coro\n  File \"/home/runner/work/sdk-python/sdk-python/temporalio/testing/_workflow.py\", line 522, in handle_signal\n    return await super().handle_signal(input)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/runner/work/sdk-python/sdk-python/temporalio/worker/_interceptor.py\", line 337, in handle_signal\n    return await self.next.handle_signal(input)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/runner/work/sdk-python/sdk-python/temporalio/worker/_workflow_instance.py\", line 2372, in handle_signal\n    await handler(*input.args)\n  File \"/home/runner/work/sdk-python/sdk-python/temporalio/workflow.py\", line [177](https://github.com/temporalio/sdk-python/actions/runs/14937905636/job/41969535426#step:14:178)4, in with_object\n    return await fn(obj, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/runner/work/sdk-python/sdk-python/tests/worker/test_workflow.py\", line 6001, in this_signal_executes_second\n    raise ApplicationError(\"Client should never see this error!\")\ntemporalio.exceptions.ApplicationError: Client should never see this error!\n21:25:24 [   DEBUG] Workflow raised failure with run ID 0196b6f0-4e20-78dc-9011-350d605a0452 (_workflow_instance.py:2003)\nTraceback (most recent call last):\n  File \"/home/runner/work/sdk-python/sdk-python/temporalio/worker/_workflow_instance.py\", line 1982, in _run_top_level_workflow_function\n    await coro\n  File \"/home/runner/work/sdk-python/sdk-python/temporalio/testing/_workflow.py\", line 522, in handle_signal\n    return await super().handle_signal(input)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/runner/work/sdk-python/sdk-python/temporalio/worker/_interceptor.py\", line 337, in handle_signal\n    return await self.next.handle_signal(input)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/runner/work/sdk-python/sdk-python/temporalio/worker/_workflow_instance.py\", line 2372, in handle_signal\n    await handler(*input.args)\n  File \"/home/runner/work/sdk-python/sdk-python/temporalio/workflow.py\", line 1774, in with_object\n    return await fn(obj, *args, **kwargs)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"/home/runner/work/sdk-python/sdk-python/tests/worker/test_workflow.py\", line 5990, in this_signal_executes_first\n    raise ApplicationError(\n    ...<2 lines>...\n    )\ntemporalio.exceptions.ApplicationError: Client should see this error unless doing ping-pong (in which case main coroutine returns first)\n21:25:24 [   DEBUG] Evicting workflow with run ID 0[196](https://github.com/temporalio/sdk-python/actions/runs/14937905636/job/41969535426#step:14:197)b6f0-4e20-78dc-9011-350d605a0452, message: Workflow completed (_workflow.py:365)\n21:25:24 [    INFO] Beginning worker shutdown, will wait 0:00:00 before cancelling activities (_worker.py:640)\n=============================== warnings summary ===============================\ntests/worker/test_activity.py::test_sync_activity_process_non_picklable\ntests/worker/test_activity.py::test_sync_activity_process_failure\ntests/worker/test_activity.py::test_sync_activity_process_cancel\ntests/worker/test_activity.py::test_sync_activity_process_cancel_uncaught\ntests/worker/test_activity.py::test_sync_activity_process_heartbeat_details\ntests/worker/test_activity.py::test_sync_activity_process_non_picklable_heartbeat_details\ntests/worker/test_activity.py::test_sync_activity_dynamic_process\n  /home/runner/work/sdk-python/sdk-python/tests/worker/test_activity.py:1331: UserWarning: Worker max_concurrent_activities is 50 but activity_executor's max_workers is only 2\n    async with Worker(**worker_config):\n\ntests/worker/test_activity.py::test_sync_activity_process_worker_shutdown_graceful\n  /home/runner/work/sdk-python/sdk-python/tests/worker/test_activity.py:934: UserWarning: Worker max_concurrent_activities is 50 but activity_executor's max_workers is only 2\n    act_worker = Worker(\n\ntests/worker/test_activity.py::test_sync_activity_process_executor_crash\n  /home/runner/work/sdk-python/sdk-python/tests/worker/test_activity.py:991: UserWarning: Worker max_concurrent_activities is 50 but activity_executor's max_workers is only 2\n    act_worker = Worker(\n\ntests/worker/workflow_sandbox/test_runner.py::test_workflow_sandbox_global_state[sandboxed_passthrough_modules0]\n  /home/runner/work/sdk-python/sdk-python/temporalio/worker/workflow_sandbox/_importer.py:[234](https://github.com/temporalio/sdk-python/actions/runs/14937905636/job/41969535426#step:14:235): RuntimeWarning: coroutine '_WorkflowInstanceImpl._apply_initialize_workflow.<locals>.run_workflow' was never awaited\n    mod = importlib.__import__(name, globals, locals, fromlist, level)\n  Enable tracemalloc to get traceback where the object was allocated.\n  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.\n\n-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html\n- generated xml file: /home/runner/work/sdk-python/sdk-python/junit-xml/3.13--ubuntu-arm.xml -\n=========================== short test summary info ============================\nFAILED tests/worker/test_workflow.py::test_workflow_return_is_honored_when_it_precedes_signal_completion_command - RuntimeError: Expected no error due to main workflow coroutine returning first\n====== 1 failed, 386 passed, 8 skipped, 10 warnings in 271.45s (0:04:31) =======\nError: Process completed with exit code 1.\n```\n</details>","closedAt":"2025-09-30T17:20:00Z","comments":[],"createdAt":"2025-05-12T21:55:31Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":865,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Flaky test: `tests/worker/test_workflow.py::test_workflow_return_is_honored_when_it_precedes_signal_completion_command`","updatedAt":"2025-09-30T17:20:00Z","url":"https://github.com/temporalio/sdk-python/issues/865"}
