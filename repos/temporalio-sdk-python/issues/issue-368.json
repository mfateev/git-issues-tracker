{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"### Describe the bug\r\n\r\nThe activity completion, often a cancel failure as result of worker shutdown, may not get recorded before run/shutdown returns. This becomes evident if you `sys.exit()` immediately after shutdown returns.\r\n\r\n### Minimal Reproduction\r\n\r\n```python\r\nimport asyncio\r\nimport logging\r\nimport signal\r\nimport sys\r\nimport os\r\nfrom datetime import timedelta\r\nfrom uuid import uuid4\r\n\r\nfrom temporalio import activity, workflow\r\nfrom temporalio.client import Client\r\nfrom temporalio.common import RetryPolicy\r\nfrom temporalio.worker import Worker\r\n\r\n\r\nasync def handler_stop_signals():\r\n    shutdowns = []\r\n    shutdowns.append(worker.shutdown())\r\n    await asyncio.gather(*shutdowns) \r\n    sys.exit()\r\n\r\n@activity.defn\r\nasync def long_activity() -> None:\r\n    activity.logger.info(\r\n        f\"Activity waiting for cancel, attempt: {activity.info().attempt}\"\r\n    )\r\n    await asyncio.sleep(60)\r\n\r\n\r\n@workflow.defn\r\nclass MyWorkflow:\r\n    @workflow.run\r\n    async def run(self):\r\n        await workflow.execute_activity(\r\n            long_activity,\r\n            start_to_close_timeout=timedelta(hours=2),\r\n            retry_policy=RetryPolicy(maximum_attempts=1),\r\n        )\r\n\r\n\r\nasync def main():\r\n    logging.basicConfig(level=logging.INFO)\r\n\r\n    logging.info(\"Starting worker\")\r\n    client = await Client.connect(\"localhost:7233\")\r\n    task_queue = f\"tq-{uuid4()}\"\r\n    global worker\r\n    worker = Worker(\r\n        client,\r\n        task_queue=task_queue,\r\n        workflows=[MyWorkflow],\r\n        activities=[long_activity],\r\n        graceful_shutdown_timeout=timedelta(minutes=24),\r\n    )\r\n    loop = asyncio.get_event_loop()\r\n    run_task = asyncio.create_task(worker.run())\r\n\r\n    logging.info(\"Starting workflow\")\r\n    handle = await client.start_workflow(\r\n        MyWorkflow.run,\r\n        id=f\"wf-{uuid4()}\",\r\n        task_queue=task_queue,\r\n    )\r\n    logging.info(\"Started workflow with ID %s\" % handle.id)\r\n    logging.info(os.getpid())\r\n\r\n    logging.info(\"Waiting for SIGTERM\")\r\n    loop.add_signal_handler(signal.SIGTERM, lambda: asyncio.ensure_future(handler_stop_signals()))\r\n    await run_task\r\n\r\n    logging.info(\r\n        \"Worker shutdown, activity will fail, but workflow will remain until a worker is available to process failure\"\r\n    )\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    asyncio.run(main())\r\n```\r\n\r\nSometimes this doesn't record the activity failure sometimes it does. We need to properly finish running activities before closing activity worker (we thought we were but looking at code, running activity completion may not get recorded).","closedAt":"2023-08-24T15:41:21Z","comments":[],"createdAt":"2023-08-15T19:43:31Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":368,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"[Bug] Activity completions may be dropped on worker shutdown","updatedAt":"2023-08-24T15:41:21Z","url":"https://github.com/temporalio/sdk-python/issues/368"}
