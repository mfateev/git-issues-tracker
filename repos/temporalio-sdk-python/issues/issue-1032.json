{"assignees":[],"author":{"id":"U_kgDOBmcx_w","is_bot":false,"login":"avalatea","name":"Ava Li"},"body":"### What are you really trying to do?\n\nI'm trying to use Temporal's `value_to_type` function to convert JSON payloads to dataclasses that contain dictionary fields with custom string types as keys (either string subclasses or NewType string aliases). This is a common pattern when working with typed identifiers like MongoDB ObjectIds or UUIDs.\n\nNote: I am not calling the function directly; the bug is caused when triggering a workflow, which, under the hood will use `value_to_type` to convert types.\n\n### Describe the bug\n\nThe `value_to_type` function has two bugs when handling dictionary keys with custom string types:\n\n1. **String subclasses are converted to character lists**: When the key type is a string subclass (like `class CustomStr(str)`), the converter treats the string as an iterable and converts it to a list of characters, making it unhashable and unusable as a dictionary key.\n\n2. **NewType fails isinstance check**: When the key type is a NewType alias (like `MyNewTypeStr = NewType(\"MyNewTypeStr\", str)`), the converter fails with \"isinstance() arg 2 must be a type\" because NewType creates a callable, not a proper type for isinstance checks.\n\n### Minimal Reproduction\n\n```python\nimport traceback\nfrom dataclasses import dataclass\nfrom typing import NewType\n\nfrom temporalio.converter import value_to_type\n\n\nclass CustomStr(str):\n    pass\n\n\nMyNewTypeStr = NewType(\"MyNewTypeStr\", str)\n\n\n@dataclass\nclass SimpleMessage:\n    data: dict[CustomStr, str]\n\n\n@dataclass \nclass NewTypeMessage:\n    data: dict[MyNewTypeStr, str]\n\n\ndef test_key_conversion():\n    print(\"=\" * 50)\n    print(\"Testing direct key conversion with CustomStr...\")\n    print(\"=\" * 50)\n    key = \"key1\"\n\n    converted_key = value_to_type(CustomStr, key)\n    print(f\"Original key: {repr(key)} (type: {type(key)})\")\n    print(f\"Converted key: {repr(converted_key)} (type: {type(converted_key)})\")\n\n\ndef test_newtype_key_conversion():\n    print(\"=\" * 50)\n    print(\"Testing direct key conversion with NewType...\")\n    print(\"=\" * 50)\n    key = \"key1\"\n\n    converted_key = value_to_type(MyNewTypeStr, key)\n    print(f\"Original key: {repr(key)} (type: {type(key)})\")\n    print(f\"Converted key: {repr(converted_key)} (type: {type(converted_key)})\")\n\n\ndef test_full_conversion():\n    print(\"=\" * 50)\n    print(\"Testing full message conversion with CustomStr...\")\n    print(\"=\" * 50)\n    payload = {\"data\": {\"key1\": \"value1\"}}\n\n    try:\n        result = value_to_type(SimpleMessage, payload)\n        print(f\"Success: {result}\")\n    except Exception as e:\n        print(f\"Full conversion failed: {e}\")\n        traceback.print_exc()\n\n\ndef test_newtype_full_conversion():\n    print(\"=\" * 50)\n    print(\"Testing full message conversion with NewType...\")\n    print(\"=\" * 50)\n    payload = {\"data\": {\"key1\": \"value1\"}}\n\n    try:\n        result = value_to_type(NewTypeMessage, payload)\n        print(f\"Success: {result}\")\n    except Exception as e:\n        print(f\"Full conversion failed: {e}\")\n        traceback.print_exc()\n\n\nif __name__ == \"__main__\":\n    test_key_conversion()\n    test_newtype_key_conversion()\n    test_full_conversion()\n    test_newtype_full_conversion()\n```","closedAt":"2025-08-29T16:23:26Z","comments":[{"id":"IC_kwDOGusT1c6-0aUy","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"Thanks @avalatea. The default data converter is known not to be the most fully featured serialization library there is. We'll look into this particular issue, but I can't promise it will be very high priority. As an alternative, we recommend the pydantic data converter for a more fully featured serialization story.","createdAt":"2025-08-19T16:23:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1032#issuecomment-3201410354","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6-0jMH","author":{"login":"avalatea"},"authorAssociation":"NONE","body":"@tconley1428 Thanks for the response. We're exploring several options at the moment.\n\nWe did find that this behavior did not happen with temporal 1.10.0 vs 1.15.0. Do you happen to know at which version major changes happened with converter behavior? If not, that's fine. I am just curious what change made NewType suddenly no longer supported.","createdAt":"2025-08-19T16:35:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1032#issuecomment-3201446663","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6-4fO7","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"My guess based on the error message, though a stack would be make it more certain:\nhttps://github.com/temporalio/sdk-python/commit/4933dc5f72e38412b85fe453ee935352294dd06f\n\nSupporting non-string key types added this line:\n```\n                    if not isinstance(key, key_type):\n```\nPotentially that is failing on the newtype. The fact that it used to work will make it more likely that we will address it. I'll bring it up in triage.","createdAt":"2025-08-19T22:34:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}},{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/1032#issuecomment-3202479035","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7Abtlh","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"Created a PR here: https://github.com/temporalio/sdk-python/pull/1059. Am I right in understanding that the `CustomStr` method is not known to have worked in the past?","createdAt":"2025-08-27T14:41:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1032#issuecomment-3228490081","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7AcDXm","author":{"login":"avalatea"},"authorAssociation":"NONE","body":"I am unsure if the `CustomStr` ever worked in the past, but I was attempting a fix by using a `CustomStr` class, which did not work as well.\n\nI figured I would throw it in. It would make sense that a custom class be serializable, but perhaps I am mistaken? In any case, our systems currently only care about the NewType case as far as I can tell.","createdAt":"2025-08-27T15:03:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1032#issuecomment-3228579302","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7AeZqI","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"It does make sense, but we aren't prioritizing additional coverage in the default data converter. I don't think the implementation would be entirely straightforward either since we'd have to ensure that the custom class doesn't have additional data and is _just_ a string.","createdAt":"2025-08-27T17:58:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/1032#issuecomment-3229194888","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7A-Zgu","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"Completed the PR to fix newtype. I'm going to close the issue, if you think custom str subtypes is a feature you would like, please open a feature request issue.","createdAt":"2025-08-29T16:23:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/1032#issuecomment-3237582894","viewerDidAuthor":false}],"createdAt":"2025-08-18T17:14:50Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1032,"reactionGroups":[],"state":"CLOSED","title":"[Bug] value_to_type fails with custom string types as dictionary keys","updatedAt":"2025-08-29T16:23:26Z","url":"https://github.com/temporalio/sdk-python/issues/1032"}
