{"assignees":[],"author":{"id":"MDQ6VXNlcjMyNzQ1MDU=","is_bot":false,"login":"SF-300","name":"Vladimir Lebedev"},"body":"Hello,\n\n### What are you really trying to do?\n\nI want to see proper OTEL metadata (spans and traces) propagated from the client invocation site all the way through workflows and activities, so I can visualize the full path in something like Datalust Seq.\n\n### Describe the bug\nWhen a workflow starts an activity from its `__init__` method, the OpenTelemetry context is not propagated. As a result, the activity runs with a missing/empty span context, even though the client call is wrapped in a valid span.\n\n### Minimal Reproduction\n```python\n# /// script\n# requires-python = \">=3.13\"\n# dependencies = [\n#     \"temporalio[opentelemetry]>=1.16.0\",\n# ]\n# ///\nimport asyncio\nfrom datetime import timedelta\n\nfrom temporalio import activity, workflow\nfrom temporalio.worker import Worker\nfrom temporalio.contrib.opentelemetry import TracingInterceptor\nfrom temporalio.testing import WorkflowEnvironment\n\nfrom opentelemetry import trace\nfrom opentelemetry.sdk.trace import TracerProvider\nfrom opentelemetry.sdk.trace.export import ConsoleSpanExporter, SimpleSpanProcessor\n\n\n# ---------- OpenTelemetry setup ----------\nprovider = TracerProvider()\nprovider.add_span_processor(SimpleSpanProcessor(ConsoleSpanExporter()))\ntrace.set_tracer_provider(provider)\ntracer = trace.get_tracer(__name__)\n\n\n@activity.defn\nasync def get_trace_id() -> int:\n    return trace.get_current_span().get_span_context().trace_id\n\n\n# ---------- Workflow ----------\n@workflow.defn\nclass DemoWorkflow:\n    @workflow.init\n    def __init__(self) -> None:\n        self._result = workflow.start_activity(\n            get_trace_id,\n            start_to_close_timeout=timedelta(seconds=5),\n        )\n\n    @workflow.run\n    async def run(self) -> int:\n        return await self._result\n\n\n# ---------- Main ----------\nasync def main():\n    async with await WorkflowEnvironment.start_local(\n        interceptors=[TracingInterceptor()],\n    ) as env:\n        queue_name = \"some-queue\"\n        async with Worker(\n            env.client,\n            task_queue=queue_name,\n            workflows=[DemoWorkflow],\n            activities=[get_trace_id],\n        ):\n            with tracer.start_as_current_span(\"invocation-site-span\") as span:\n                invocation_trace_id = span.get_span_context().trace_id\n                activity_trace_id = await env.client.execute_workflow(\n                    DemoWorkflow.run,\n                    id=\"otel-update-workflow-id-2\",\n                    task_queue=queue_name,\n                )\n                assert activity_trace_id == invocation_trace_id\n\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n```\n\n### Additional context\n\nI think that [WorkflowOutboundInterceptor](https://github.com/temporalio/sdk-python/blob/a9c71aafd8c9905e64e8767f5dcfe917df1dc79a/temporalio/worker/_interceptor.py#L405) should have a hook to wrap an `__init__` of a workflow, but looking at how/where `_instantiate_workflow_object` [is called](https://github.com/temporalio/sdk-python/blob/a9c71aafd8c9905e64e8767f5dcfe917df1dc79a/temporalio/worker/_workflow_instance.py#L2125), I don't think that it was planned for. So fixing this might require a refactoring of unclear scale to me.\nIf this issue is considered worth fixing, I'm willing to try fixing this and would greatly appreciate any clues (e.g. whether or not introducing another hook is the way to go here... or any other advice, really :)","closedAt":"2025-09-03T18:11:22Z","comments":[{"id":"IC_kwDOGusT1c7BuxFA","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"In most SDKs we have specifically disallowed taking substantial action inside of the workflow constructors. I would recommend you refrain from setting up commands inside `__init__` and do so during `run` instead.","createdAt":"2025-09-03T18:11:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1054#issuecomment-3250262336","viewerDidAuthor":false}],"createdAt":"2025-08-26T12:36:04Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1054,"reactionGroups":[],"state":"CLOSED","title":"[Bug] OTEL metadata missing in `__init__` method of a workflow","updatedAt":"2025-09-03T18:11:22Z","url":"https://github.com/temporalio/sdk-python/issues/1054"}
