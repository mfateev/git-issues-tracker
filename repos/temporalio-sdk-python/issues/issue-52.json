{"assignees":[],"author":{"id":"MDQ6VXNlcjUxMDk5","is_bot":false,"login":"llchan","name":"Lawrence Chan"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\nCurrently the activity definition implementation [here](https://github.com/temporalio/sdk-python/blob/431ca1967d365556a9cf5aa9aac00243b71059f8/temporalio/activity.py#L375) requires `__code__` on a callable.  From what I can tell it seems like it's only using that to verify that there are no kwonly arguments.  \r\n\r\n### Describe the solution you'd like\r\n\r\nWe can instead use the `inspect` module to analyze the callable's signature, allowing a broader set of non-function callables to be used as activities.\r\n","closedAt":"2022-07-14T14:56:35Z","comments":[{"id":"IC_kwDOGusT1c5FEX1b","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Definitely can fix this. Can you give an example of which callable you are using and how so I can include it in the integration tests?","createdAt":"2022-06-17T11:21:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/52#issuecomment-1158774107","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5GEFTv","author":{"login":"nathanielobrown"},"authorAssociation":"CONTRIBUTOR","body":"So this isn't 100% related but I'm just dumping my thoughts here in case they're useful when changing the `@activity.defn` decorator.\r\n\r\nI think it is nice to have a thin wrapper around activities that allows the developer to more easily customize their activity functions. Dramatiq uses a [wrapper class](https://github.com/Bogdanp/dramatiq/blob/master/dramatiq/actor.py#L29) which is applied using a [decorator](https://github.com/Bogdanp/dramatiq/blob/master/dramatiq/actor.py#L157). I like this setup because:\r\n\r\n1. It makes it easy to mock out the underlying function without messing up the task related attributes and without creating an otherwise useless wrapper function. For Dramatiq you just mock `task.fn`\r\n   - As it stands in this SDK, if you directly mock the function things fail because it's missing `__temporal_activity_definition`. This isn't the end of the world because you can just pass a stubbed actor to the worker when you test, but it still might be nice to have easy mocking\r\n3. It makes the path to customization fairly clear and straightforward. Just subclass the Actor class\r\n4. It's easier not to interfere with the internals of the framework when you customize how the callable is called, because the callable is an attribute of the wrapper, rather than the wrapper attributes stuff on the callable.\r\n\r\nI'm still customizing how the current decorator is applied, it's just a little more complicated. Here's what I'm using in my project. It logs exceptions, injects a database access object and does some extra parsing of arguments that are Pydantic classes:\r\n\r\n```python\r\nimport functools\r\nimport inspect\r\nfrom time import time\r\nfrom typing import Any, Callable, no_type_check, Optional, TypeVar\r\n\r\nfrom loguru import logger\r\nfrom temporalio import activity\r\n\r\nfrom bots_interface.actors import _parse_type\r\nfrom dd.repositories import repo as repo_module\r\n\r\nActivityFunc = TypeVar(\"ActivityFunc\", bound=Callable[..., Any])\r\n\r\n\r\n@no_type_check\r\ndef define_activity(\r\n    fn: ActivityFunc = None, name: Optional[str] = None\r\n) -> ActivityFunc:\r\n    if name is not None and fn is None:\r\n        return functools.partial(define_activity, name=name)\r\n    assert fn is not None\r\n    defn = activity.defn(name=name or fn.__name__)(fn)\r\n    fn_annotations = fn.__annotations__\r\n\r\n    @functools.wraps(fn)\r\n    def wrapper(*args: Any, **kwargs: Any) -> Any:\r\n        if \"repo\" in fn_annotations:\r\n            assert fn_annotations[\"repo\"] is repo_module.Repository\r\n            assert \"repo\" not in kwargs\r\n            repo = repo_module.repo_factory()\r\n            kwargs[\"repo\"] = repo\r\n        parsed_kwargs = _parse_args(fn, args, kwargs)\r\n        if \"repo\" in fn_annotations:\r\n            with repo.commit_and_close():\r\n                return _run_func_log_exception(fn, parsed_kwargs)\r\n        else:\r\n            return _run_func_log_exception(fn, parsed_kwargs)\r\n\r\n    wrapper.__temporal_activity_definition = defn.__temporal_activity_definition\r\n    return wrapper\r\n\r\n\r\n@no_type_check\r\ndef _run_func_log_exception(fn: ActivityFunc, kwargs: dict) -> Any:\r\n    t_start = time()\r\n    try:\r\n        result = fn(**kwargs)\r\n    except Exception:\r\n        logger.exception(f\"Activity function {fn.__name__!r} failed\")\r\n        raise\r\n    duration = time() - t_start\r\n    logger.debug(f\"{fn.__name__} ran in {duration:.3f} seconds\")\r\n    return result\r\n\r\n\r\ndef _parse_args(fn: Callable, args: Any, kwargs: Any) -> dict:\r\n    \"\"\"Returns kwargs with args converted to kwargs and pydantic types parsed.\r\n    Pendulum Datetimes are parsed as well\"\"\"\r\n    call_args = inspect.getcallargs(fn, *args, **kwargs)\r\n    for arg_name, value in call_args.items():\r\n        annotation = fn.__annotations__.get(arg_name)\r\n        call_args[arg_name] = _parse_type(annotation, value)\r\n    return call_args\r\n```\r\n","createdAt":"2022-07-05T20:37:25Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/52#issuecomment-1175475439","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5GEIYQ","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"There is no customization beyond name. I just need a way to mark a callable as an activity and, at the time, an attribute seemed more reasonable than wrapping the function. This is what the `@no_type_check` decorator you're showing in your example does, see: https://github.com/python/cpython/blob/40d81fd63b46cf998880ce3bf3e5cb42bc3199c1/Lib/typing.py#L2476-L2509. This allows _other_ decorators that actually do need to proxy the invocation to do so without affecting our simple need to just set a small piece of metadata.\r\n\r\nI may introduce an alternative activity concept that can be used instead of the decorator, but again the only customization is name. And the only thing I need is simple metadata, I do not want to proxy the function. Is there a more Pythonic way to carry around metadata without proxying the invocation? (forgive my naivete on Python here)","createdAt":"2022-07-05T20:54:35Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/52#issuecomment-1175488016","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5GEhb0","author":{"login":"nathanielobrown"},"authorAssociation":"CONTRIBUTOR","body":"> I may introduce an alternative activity concept that can be used instead of the decorator, but again the only customization is name. And the only thing I need is simple metadata, I do not want to proxy the function. Is there a more Pythonic way to carry around metadata without proxying the invocation? (forgive my naivete on Python here)\r\n\r\nNothing more pythonic comes to mind. In fact, stuffing attributes on whatever object feels _very_ Python...\r\n\r\nI like what you're saying about keeping it simple, and I think if I want to have proxied/mockable/customizeable tasks I can still do that under this model with my own decorator. I realize now that my current decorator could be cleaned up so it doesn't care about what `activity.defn` does if I apply it at the end (`activity.defn(name=name or fn.__name__)(wrapper)`).","createdAt":"2022-07-05T23:12:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/52#issuecomment-1175590644","viewerDidAuthor":false}],"createdAt":"2022-06-17T06:21:36Z","labels":[{"id":"LA_kwDOGusT1c7gQgHN","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":52,"reactionGroups":[],"state":"CLOSED","title":"[Feature Request] Support non-function callables as activities","updatedAt":"2022-07-14T14:56:35Z","url":"https://github.com/temporalio/sdk-python/issues/52"}
