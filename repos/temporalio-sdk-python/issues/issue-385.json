{"assignees":[],"author":{"id":"MDQ6VXNlcjIzNTg0NTg1","is_bot":false,"login":"KundaPanda","name":"VojtÄ›ch Dohnal"},"body":"### What are you really trying to do?\r\n\r\nTo create a second client in a different process (i.e. in gunicorn).\r\n\r\n### Describe the bug\r\n\r\nThe client randomly hangs during `connect` of a client in a new process, after another client was created in the current process.\r\n\r\n### Minimal Reproduction\r\n\r\n<details><summary>Code from a modified sample</summary>\r\n\r\n```python\r\nimport asyncio\r\nimport logging\r\nfrom dataclasses import dataclass\r\nfrom datetime import timedelta\r\n\r\nfrom temporalio import activity, workflow\r\nfrom temporalio.client import Client\r\nfrom temporalio.runtime import Runtime, TelemetryConfig\r\nfrom temporalio.worker import Worker\r\n\r\n\r\n# While we could use multiple parameters in the activity, Temporal strongly\r\n# encourages using a single dataclass instead which can have fields added to it\r\n# in a backwards-compatible way.\r\n@dataclass\r\nclass ComposeGreetingInput:\r\n    greeting: str\r\n    name: str\r\n\r\n\r\n# Basic activity that logs and does string concatenation\r\n@activity.defn\r\nasync def compose_greeting(input: ComposeGreetingInput) -> str:\r\n    activity.logger.info(\"Running activity with parameter %s\" % input)\r\n    return f\"{input.greeting}, {input.name}!\"\r\n\r\n\r\n# Basic workflow that logs and invokes an activity\r\n@workflow.defn\r\nclass GreetingWorkflow:\r\n    @workflow.run\r\n    async def run(self, name: str) -> str:\r\n        workflow.logger.info(\"Running workflow with parameter %s\" % name)\r\n        return await workflow.execute_activity(\r\n            compose_greeting,\r\n            ComposeGreetingInput(\"Hello\", name),\r\n            start_to_close_timeout=timedelta(seconds=10),\r\n        )\r\n\r\n\r\nasync def run_workflow():\r\n    logging.debug(\"Creating a temporal client\")\r\n    client = await Client.connect(\"localhost:7233\", runtime=Runtime(telemetry=TelemetryConfig()))\r\n    res = await client.execute_workflow(\r\n        GreetingWorkflow.run,\r\n        \"World\",\r\n        id=\"hello-activity-workflow-id\",\r\n        task_queue=\"hello-activity-task-queue\",\r\n    )\r\n    logging.debug(f\"Result: {res}\")\r\n\r\n\r\nasync def worker():\r\n    client = await Client.connect(\"localhost:7233\")\r\n    worker = Worker(\r\n        client,\r\n        task_queue=\"hello-activity-task-queue\",\r\n        workflows=[GreetingWorkflow],\r\n        activities=[compose_greeting],\r\n        debug_mode=True,\r\n    )\r\n    await worker.run()\r\n\r\n\r\nasync def main():\r\n    from multiprocessing import Process\r\n\r\n    # Uncomment the line below to see logging\r\n    logging.basicConfig(level=logging.DEBUG)\r\n\r\n    worker_process = Process(target=lambda: asyncio.run(worker()))\r\n    worker_process.start()\r\n\r\n    # While the worker is running, use the client to run the workflow and\r\n    # print out its result. Note, in many production setups, the client\r\n    # would be in a completely separate process from the worker.\r\n    await run_workflow()\r\n    p = Process(target=lambda: asyncio.run(run_workflow()))\r\n    p.start()\r\n    p.join()\r\n    worker_process.terminate()\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    asyncio.run(main())\r\n\r\n````\r\n\r\n</details>\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: Fedora 38, Ryzen 7 PRO 6850U\r\n- Temporal Version: Python SDK 1.3.0, Temporal 1.22.0\r\n- Are you using Docker or Kubernetes or building Temporal from source? Yes, the *auto-setup* docker image\r\n\r\n### Additional context\r\n\r\nThe client usually hangs in `temporalio.bridge.client.py:78` at `temporalio.bridge.temporal_sdk_bridge.connect_client`.\r\n","closedAt":"2023-10-06T16:35:49Z","comments":[{"id":"IC_kwDOGusT1c5muZY1","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> To create a second client in a different process (i.e. in gunicorn).\r\n\r\nDoes this mean in a post-forked process? The SDK does not work with forking at this time (#11). It would be a challenge to share the Rust runtime across forks properly/safely.","createdAt":"2023-09-18T13:41:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/385#issuecomment-1723438645","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5m8U4Z","author":{"login":"KundaPanda"},"authorAssociation":"NONE","body":"Yes it does, I haven't found this limitation anywhere in the Temporal.io documentation and thought that it could be solved by passing a new Runtime instance to the Client.connect method. Is this not the case? What exactly does a Runtime object represent?","createdAt":"2023-09-20T07:03:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/385#issuecomment-1727090201","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5nMtAd","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> I haven't found this limitation anywhere in the Temporal.io documentation\r\n\r\n:+1: We will add documentation for this\r\n\r\n> thought that it could be solved by passing a new Runtime instance to the Client.connect method. Is this not the case? What exactly does a Runtime object represent?\r\n\r\nNo it cannot be solved that way. A runtime represents a Rust Tokio thread pool and runtime (see https://github.com/tokio-rs/tokio/issues/1541 and similar).","createdAt":"2023-09-22T13:05:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/385#issuecomment-1731383325","viewerDidAuthor":false}],"createdAt":"2023-09-14T10:58:00Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":385,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Client stuck connecting or starting a workflow","updatedAt":"2023-10-06T16:35:49Z","url":"https://github.com/temporalio/sdk-python/issues/385"}
