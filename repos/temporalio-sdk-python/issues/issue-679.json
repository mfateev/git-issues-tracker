{"assignees":[],"author":{"id":"MDQ6VXNlcjk0MzI3NTM=","is_bot":false,"login":"yitian-reevo","name":"Yitian Huang"},"body":"### What are you really trying to do?\r\n\r\nI'm testing the behavior of RetryPolicy for an activity, esp the `non retryable` case\r\n\r\n### Describe the bug\r\nThe code I used for testing as following: \r\n\r\nWorkflow:\r\n```\r\nfrom datetime import timedelta\r\n\r\nfrom temporalio import workflow\r\n\r\nwith workflow.unsafe.imports_passed_through():\r\n    from salestech_be.temporal.activities import (\r\n        say_hello,\r\n    )\r\n    from temporalio.common import RetryPolicy\r\n\r\n\r\n@workflow.defn\r\nclass SayHello:\r\n    @workflow.run\r\n    async def run(self, name: str) -> str:\r\n\r\n        return await workflow.execute_activity(\r\n            say_hello, name, start_to_close_timeout=timedelta(seconds=5),\r\n            retry_policy=RetryPolicy(\r\n                maximum_interval=timedelta(seconds=1),\r\n                non_retryable_error_types=[\"MY_CUSTOM_ERROR_TYPE\"],\r\n                maximum_attempts=2,\r\n            )\r\n        )\r\n```\r\nActivity\r\n```\r\nfrom temporalio import activity\r\nfrom temporalio.exceptions import ApplicationError\r\n\r\n\r\n@activity.defn\r\nasync def say_hello(name: str) -> str:\r\n    raise ApplicationError(\r\n            message=\"test\",\r\n            details={\"reason\": \"test\"},\r\n            type=\"MY_CUSTOM_ERROR_TYPE\",\r\n            non_retryable=True,\r\n        )\r\n    return f\"Hello, {name}!\"\r\n```\r\nI also tried different combinations of params when raise the error, none of them works.\r\n\r\nTest Script:\r\n```\r\nawait client.start_workflow(\r\n    SayHello.run,\r\n    \"test_say_hello\",\r\n    id=f\"test_say_hello_{uuid4()}\",\r\n    task_queue=DEFAULT_TASK_QUEUE,\r\n    id_reuse_policy=WorkflowIDReusePolicy.ALLOW_DUPLICATE_FAILED_ONLY,\r\n)\r\n```\r\nBased on the docs I read, what I expected is this activity should not be retried, and there will be a Activity Task Failed record in the Event history with something like non-retryable error content.\r\n\r\nbut in fact, the activity is still being retried and fail on a start_to_close timeout eventually, can I ask some help for understanding this? is it a bug, or I misunderstood something? much appreciate!\r\n\r\n### Minimal Reproduction\r\n\r\nsee above\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: m2 macbook pro 15.1\r\n- Temporal Version:  1.25.0 and SDK version 1.8.0\r\n- Are you using Docker or Kubernetes or building Temporal from source? using Docker\r\n\r\n### Additional context\r\n","closedAt":"2024-10-30T18:04:12Z","comments":[{"id":"IC_kwDOGusT1c6R2uee","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"When I run your code I get:\r\n\r\n```\r\nTypeError: ApplicationError.__init__() got an unexpected keyword argument 'details'\r\n```\r\n\r\nThis is because `details` is a vararg. Changing your code to remove `message=` and `details=`, the workflow properly fails bubbling out the activity failure.\r\n\r\n> the activity is still being retried and fail on a start_to_close timeout eventually\r\n\r\nHrmm, this is a bit confusing. A start to close timeout only fails if the activity body exceeds the timeout, but your code raises immediately. Schedule to close or schedule to start timeouts may make sense if you forgot to register your activity or if you don't have a worker running.","createdAt":"2024-10-30T12:50:39Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/679#issuecomment-2447042462","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6R2xyf","author":{"login":"yitian-reevo"},"authorAssociation":"NONE","body":"thanks, @cretz, yep I find the 'details' errors as well, but things don't change if i removed the `details` field. And I'm pretty sure I did register the activity and had a working running.\r\n\r\nAre you able to reproduce this your side? it should not be two complicated to reproduce, I've confirmed with one of my team and he claims he faces the same issue.\r\n\r\nWe both use MacOs with M2 chips, not sure if this matters. just fyi.","createdAt":"2024-10-30T12:55:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/679#issuecomment-2447056031","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6R227Y","author":{"login":"yitian-reevo"},"authorAssociation":"NONE","body":"oh sorry, i missed this line:\r\n> Changing your code to remove message= and details=, the workflow properly fails bubbling out the activity failure.\r\n\r\nlet me try again.","createdAt":"2024-10-30T13:03:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/679#issuecomment-2447077080","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6R6Osu","author":{"login":"yitian-reevo"},"authorAssociation":"NONE","body":"@cretz  After hours of debugging, I can confirm this retry not working issue is due to somehow a conflict of our custom logger built on loguru. But haven't have a clue on how to solve it. At least find the cause now. thanks!","createdAt":"2024-10-30T18:04:13Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/679#issuecomment-2447960878","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6YlAGt","author":{"login":"barbatus"},"authorAssociation":"NONE","body":"@yitian-reevo I am wondering did you solve the issue? we are having same issues and also using loguru and it's not clear at all form the first sight at least where does exactly the issue lie, so I'd really appreciate your insight üôè","createdAt":"2024-12-23T14:46:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/679#issuecomment-2559836589","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6YnO0y","author":{"login":"yitian-reevo"},"authorAssociation":"NONE","body":"@barbatus yup, the root cause for us is we had a custom patcher when init the loguru logger, and inside the patch there is deserialization bug. So this might not a common issue.\r\n \r\n\r\n","createdAt":"2024-12-23T23:20:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/679#issuecomment-2560421170","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6Yu129","author":{"login":"barbatus"},"authorAssociation":"NONE","body":"@yitian-reevo I assume an activity now cancels right away when you raise `ApplicationError(type=\"MY_CUSTOM_ERROR_TYPE\")` and it does not wait start_to_close_timeout?","createdAt":"2024-12-26T10:28:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/679#issuecomment-2562416061","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6YwMsN","author":{"login":"yitian-reevo"},"authorAssociation":"NONE","body":"@barbatus that's correct, exceptions listed in non_retryable_error param will terminate the acitivity immediately.\r\n\r\nI would suggest you setup a tempory pure Temporl env (e.g in a dokcer) to test how it behaves, then you can have a clear view on this feature.","createdAt":"2024-12-26T13:57:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/679#issuecomment-2562771725","viewerDidAuthor":false}],"createdAt":"2024-10-29T20:42:48Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":679,"reactionGroups":[],"state":"CLOSED","title":"[Bug/Question] non_retryable_error_types seems not working","updatedAt":"2024-12-26T13:57:26Z","url":"https://github.com/temporalio/sdk-python/issues/679"}
