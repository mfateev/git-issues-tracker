{"assignees":[],"author":{"id":"MDQ6VXNlcjE1OTIxNjM=","is_bot":false,"login":"nitishagar","name":"Nitish Agarwal"},"body":"### What are you really trying to do?\n\nWe're integrating the OpenAI Agents SDK with Temporal Python SDK to build AI-powered workflows that can execute activities through an agent interface. When using the OpenAI Agents SDK with Temporal Python SDK (`temporalio.contrib.openai_agents`), workflows fail with serialization errors when trying to deserialize complex generic type annotations that Temporal's default data converter cannot handle.\n\n### Describe the bug\n\nWhen attempting to execute a workflow that uses the OpenAI Agents SDK integration (temporalio.contrib.openai_agents), the workflow fails immediately during the first agent operation with a serialization error:\n\n```python\nTypeError: Unserializable type during conversion: typing_extensions.Required[typing.Union[str, list[typing.Union[openai.types.responses.easy_input_message_param.EasyInputMessageParam, openai.types.responses.response_input_item_param.Message, ...]]]]\n```\n\n### Minimal Reproduction\n\n\n```python\nfrom temporalio import workflow\nfrom temporalio.common import RetryPolicy\nfrom agents import Agent, Runner\nfrom temporalio.contrib import openai_agents\nfrom datetime import timedelta\n\n@workflow.defn\nclass MyWorkflow:\n    @workflow.run\n    async def run(self) -> None:\n        # Create a tool from an activity\n        my_tool = openai_agents.workflow.activity_as_tool(\n            my_activity,\n            start_to_close_timeout=timedelta(seconds=10),\n        )\n\n        # Create an agent\n        agent = Agent(\n            name=\"Test Agent\",\n            instructions=\"Do something\",\n            tools=[my_tool],\n        )\n\n        # Run the agent - THIS FAILS with serialization error\n        result = await Runner.run(agent, input=\"test prompt\")\n```\n\n\n### Environment/Versions\n- **Temporal Python SDK**: `1.8.0`\n- **OpenAI Agents SDK**: `0.0.5`\n- **OpenAI**: `1.59.4`\n- **Python**: `3.9`\n- **Operating System**: macOS (Darwin 24.6.0)\n\n### Additional context\n\n- The error occurs during activity deserialization in the worker\n- The `ActivityModelInput` is created internally by the OpenAI Agents Plugin\n- The issue is specific to the interaction between Temporal's type conversion system and OpenAI's complex type annotations\n- Similar issues may affect other third-party libraries that use complex generic type hints\n\n#### Workaround\n\nCreate a custom data converter that skips type validation for `ActivityModelInput`:\n\n```python\n\"\"\"Custom data converter for handling OpenAI Agents SDK types.\"\"\"\nimport pickle\nfrom typing import Any, List, Optional, Sequence, Type\nfrom temporalio.api.common.v1 import Payload\nfrom temporalio.converter import (\n    DataConverter,\n    DefaultPayloadConverter,\n    PayloadConverter,\n)\n\n\nclass PicklePayloadConverter(PayloadConverter):\n    \"\"\"Payload converter that handles OpenAI Agents SDK types.\"\"\"\n\n    def __init__(self):\n        self._default = DefaultPayloadConverter()\n\n    def to_payloads(self, values: Sequence[Any]) -> List[Payload]:\n        return [self._to_payload_single(value) for value in values]\n\n    def from_payloads(\n        self, payloads: Sequence[Payload], type_hints: Optional[List[Type]] = None\n    ) -> List[Any]:\n        results = []\n        for i, payload in enumerate(payloads):\n            type_hint = type_hints[i] if type_hints and i < len(type_hints) else None\n            results.append(self._from_payload_single(payload, type_hint))\n        return results\n\n    @property\n    def encoding(self) -> str:\n        return \"binary/pickle+json\"\n\n    def _to_payload_single(self, value: Any) -> Payload:\n        # Check if this is an OpenAI or Temporal OpenAI Agents type\n        if hasattr(value, '__module__'):\n            module_name = str(value.__module__)\n            if 'openai' in module_name or 'temporalio.contrib.openai_agents' in module_name:\n                return Payload(\n                    metadata={\"encoding\": b\"binary/pickle\"},\n                    data=pickle.dumps(value),\n                )\n\n        # Try default converter\n        try:\n            result = self._default.to_payloads([value])\n            if result and len(result) > 0:\n                return result[0]\n        except (TypeError, AttributeError):\n            pass\n\n        # Fallback to pickle\n        return Payload(\n            metadata={\"encoding\": b\"binary/pickle\"},\n            data=pickle.dumps(value),\n        )\n\n    def _from_payload_single(self, payload: Payload, type_hint: Optional[Type] = None) -> Any:\n        encoding = payload.metadata.get(\"encoding\", b\"\").decode()\n\n        if encoding == \"binary/pickle\":\n            return pickle.loads(payload.data)\n\n        # Skip problematic type hints for OpenAI Agents SDK types\n        skip_type_hint = False\n        if type_hint:\n            type_str = str(type_hint)\n            if ('temporalio.contrib.openai_agents' in type_str or\n                'ActivityModelInput' in type_str or\n                'typing_extensions.Required' in type_str):\n                skip_type_hint = True\n\n        # Try default converter\n        try:\n            if skip_type_hint:\n                result = self._default.from_payloads([payload], None)\n            else:\n                result = self._default.from_payloads([payload], [type_hint] if type_hint else None)\n\n            if result and len(result) > 0:\n                return result[0]\n        except Exception:\n            if payload.data:\n                try:\n                    return pickle.loads(payload.data)\n                except Exception:\n                    pass\n            raise\n\n\ndef create_openai_data_converter() -> DataConverter:\n    \"\"\"Create a data converter that can handle OpenAI Agents SDK types.\"\"\"\n    return DataConverter(\n        payload_converter_class=PicklePayloadConverter,\n    )\n```\n\n**Usage:**\n\n```python\nfrom temporalio.client import Client\nfrom temporalio.worker import Worker\nfrom my_converters import create_openai_data_converter\n\n# For worker\nasync def main():\n    data_converter = create_openai_data_converter()\n\n    client = await Client.connect(\n        \"localhost:7233\",\n        data_converter=data_converter,\n    )\n\n    worker = Worker(\n        client,\n        task_queue=\"my-queue\",\n        workflows=[MyWorkflow],\n        activities=[my_activity],\n        plugins=[openai_plugin],\n    )\n\n    await worker.run()\n\n# For client\nasync def run_workflow():\n    data_converter = create_openai_data_converter()\n\n    client = await Client.connect(\n        \"localhost:7233\",\n        data_converter=data_converter,\n    )\n\n    result = await client.execute_workflow(\n        MyWorkflow.run,\n        id=\"my-workflow-id\",\n        task_queue=\"my-queue\",\n    )\n```\n\n#### Limitations of Workaround\n\nThe workaround bypasses the serialization error, but introduces a new issue: when type hints are skipped, the deserialized data becomes plain Python dicts instead of proper typed objects. The OpenAI Agents SDK code expects objects with attribute access (e.g., `tool.name`) rather than dict key access (e.g., `tool[\"name\"]`), leading to `AttributeError: 'dict' object has no attribute 'name'`.\n\n","closedAt":"2025-10-23T13:17:36Z","comments":[{"id":"IC_kwDOGusT1c7M2y2M","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"This is because the `OpenAIAgentsPlugin` registers its own `DataConverter` which is a slight variation of the `pydantic_data_converter`. If you look at all the samples, for instance https://github.com/temporalio/samples-python/blob/main/openai_agents/basic/run_hello_world_workflow.py, the plugin is provided to the `Client`, not the `Worker`. It isn't actually super important in your `main` function (assuming `openai_plugin` is a `OpenAIAgentsPlugin`, but its definition is missing), because the client is only used inside a worker there. In `run_workflow` however, the plugin is simply not provided at all and therefore doesn't change the `DataConverter` as is required.","createdAt":"2025-10-23T13:17:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1180#issuecomment-3436916108","viewerDidAuthor":false}],"createdAt":"2025-10-23T06:10:31Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1180,"reactionGroups":[],"state":"CLOSED","title":"[Bug] OpenAI Agents SDK serialization fails with complex type annotations","updatedAt":"2025-10-23T13:17:36Z","url":"https://github.com/temporalio/sdk-python/issues/1180"}
