{"assignees":[],"author":{"id":"U_kgDOCMFNJQ","is_bot":false,"login":"slingshotsys","name":"Geoff"},"body":"### Describe the bug\n\nAs of `1.18.0`, launching a child workflow with search_attributes fails when using a custom payload_codec.\n\nOn `1.17.0` this completes succesfully, but on `1.18.0` we get the following error:\n\n<img width=\"1129\" height=\"235\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/f4f593a1-f649-4619-b3d9-5ce99df0f926\" />\n\n```\n2025-09-29T20:18:32.022484Z  WARN temporal_sdk_core::worker::workflow: Error while completing workflow activation error=status: InvalidArgument, message: \"invalid SearchAttributes on StartChildWorkflowCommand: invalid value for search attribute show_name of type Keyword: value from <metadata:{key:\\\"encoding\\\"  value:\\\"binary/encrypted\\\"}  metadata:{key:\\\"encryption-key-id\\\"  value:\\\"test-key-id\\\"}  data:\\\"\\\\xf9H\\\\x99+\\\\xb6\\\\xee\\\\xffo\\\\xd4}\\\\xde\\\\xe9\\\\x7fg\\\\xb4\\\\x89\\\\xa5\\\\xb4\\\\x10\\\\x0e\\\\xefT\\\\xd2a\\\\xf2\\\\xb9\\\\t\\\\xb2t\\\\xbd\\\\xa0\\\\xae\\\\x8d<\\\\xf7\\\\xd2?\\\\xe4\\\\xca6X\\\\xfb\\\\x83\\\\xf2\\\\xb0\\\\x1aՔ\\\\x0e\\\\xbbZ\\\\xe4\\\\x94ZU\\\\x81d\\\\xf3e\\\\xc4Zx\\\\x98\\\\xf0h\\\\xc2\\\\x10Ӑ\\\\x84\\\\xfdm\\\\x9b\\\\x15S¡8\\\\x8fI\\\\xf2R\\\">. WorkflowId=child-Temporal WorkflowType=ChildWorkflow Namespace=default\", details: [], metadata: MetadataMap { headers: {\"content-type\": \"application/grpc\"} }\n```\n\n### Minimal Reproduction\nBased off the sample https://github.com/temporalio/samples-python/tree/main/encryption\n\n```python\nimport asyncio\nimport dataclasses\n\nimport temporalio.converter\nfrom temporalio import workflow\nfrom temporalio.client import Client\nfrom temporalio.worker import Worker\n\nimport os\nfrom typing import Iterable, List\n\nfrom cryptography.hazmat.primitives.ciphers.aead import AESGCM\nfrom temporalio.api.common.v1 import Payload\nfrom temporalio.converter import PayloadCodec\nfrom temporalio.common import SearchAttributeKey, SearchAttributePair, TypedSearchAttributes\n\ndefault_key = b\"test-key-test-key-test-key-test!\"\ndefault_key_id = \"test-key-id\"\n\n\nclass EncryptionCodec(PayloadCodec):\n    def __init__(self, key_id: str = default_key_id, key: bytes = default_key) -> None:\n        super().__init__()\n        self.key_id = key_id\n        # We are using direct AESGCM to be compatible with samples from\n        # TypeScript and Go. Pure Python samples may prefer the higher-level,\n        # safer APIs.\n        self.encryptor = AESGCM(key)\n\n    async def encode(self, payloads: Iterable[Payload]) -> List[Payload]:\n        # We blindly encode all payloads with the key and set the metadata\n        # saying which key we used\n        return [\n            Payload(\n                metadata={\n                    \"encoding\": b\"binary/encrypted\",\n                    \"encryption-key-id\": self.key_id.encode(),\n                },\n                data=self.encrypt(p.SerializeToString()),\n            )\n            for p in payloads\n        ]\n\n    async def decode(self, payloads: Iterable[Payload]) -> List[Payload]:\n        ret: List[Payload] = []\n        for p in payloads:\n            # Ignore ones w/out our expected encoding\n            if p.metadata.get(\"encoding\", b\"\").decode() != \"binary/encrypted\":\n                ret.append(p)\n                continue\n            # Confirm our key ID is the same\n            key_id = p.metadata.get(\"encryption-key-id\", b\"\").decode()\n            if key_id != self.key_id:\n                raise ValueError(f\"Unrecognized key ID {key_id}. Current key ID is {self.key_id}.\")\n            # Decrypt and append\n            ret.append(Payload.FromString(self.decrypt(p.data)))\n        return ret\n\n    def encrypt(self, data: bytes) -> bytes:\n        nonce = os.urandom(12)\n        return nonce + self.encryptor.encrypt(nonce, data, None)\n\n    def decrypt(self, data: bytes) -> bytes:\n        return self.encryptor.decrypt(data[:12], data[12:], None)\n\n\n@workflow.defn(name=\"Workflow\")\nclass GreetingWorkflow:\n    @workflow.run\n    async def run(self, name: str) -> str:\n        print(\n            await workflow.execute_child_workflow(\n                workflow=ChildWorkflow.run,\n                arg=name,\n                id=f\"child-{name}\",\n                search_attributes=workflow.info().typed_search_attributes,\n            )\n        )\n        return f\"Hello, {name}\"\n\n\n@workflow.defn(name=\"ChildWorkflow\")\nclass ChildWorkflow:\n    @workflow.run\n    async def run(self, name: str) -> str:\n        return f\"Hello from child, {name}\"\n\n\nasync def main():\n    # Connect client\n    client = await Client.connect(\n        \"localhost:7233\",\n        # Use the default converter, but change the codec\n        data_converter=dataclasses.replace(temporalio.converter.default(), payload_codec=EncryptionCodec()),\n    )\n\n    # Run a worker for the workflow\n    async with Worker(\n        client,\n        task_queue=\"encryption-task-queue\",\n        workflows=[GreetingWorkflow, ChildWorkflow],\n    ):\n        # Run workflow\n        result = await client.execute_workflow(\n            GreetingWorkflow.run,\n            \"Temporal\",\n            id=f\"encryption-workflow-id\",\n            task_queue=\"encryption-task-queue\",\n            search_attributes=TypedSearchAttributes(\n                [SearchAttributePair(SearchAttributeKey.for_keyword(\"show_name\"), \"test_show\")]\n            ),\n        )\n    print(f\"Workflow result: {result}\")\n\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n```\n\n### Environment/Versions\n\n<!-- Please complete the following information where relevant. -->\n\n- OS and processor: Windows 11\n- Temporal Version: Python SDK 1.18.0\n- Occurs on both the local temporal CLI and temporal cloud.\n\n","closedAt":"2025-09-30T01:09:33Z","comments":[{"id":"IC_kwDOGusT1c7HnyLm","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"Definitely a regression. Thanks for the report! I will be releasing a fix as `1.18.1` today or tomorrow.","createdAt":"2025-09-29T21:19:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/1129#issuecomment-3349095142","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7JEFjJ","author":{"login":"slingshotsys"},"authorAssociation":"NONE","body":"Confirmed working in `1.18.1`, thanks for fixing so quickly!","createdAt":"2025-10-06T18:33:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1129#issuecomment-3373291721","viewerDidAuthor":false}],"createdAt":"2025-09-29T20:22:16Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1129,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Child workflow search attributes aren't decrypted in 1.18.0","updatedAt":"2025-10-06T18:33:30Z","url":"https://github.com/temporalio/sdk-python/issues/1129"}
