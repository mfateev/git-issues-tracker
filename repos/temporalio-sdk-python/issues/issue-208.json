{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"### Describe the bug\r\n\r\nSome relative imports are respected, but ones that call `__import__` with a level > 0 are not properly. This surfaced during a non-binary install of Pydantic for #207. We need to mimic https://github.com/python/cpython/blob/c8c6113398ee9a7867fe9b08bc539cceb61e2aaa/Lib/importlib/_bootstrap.py#L1255-L1258.","closedAt":"2022-12-02T21:13:04Z","comments":[{"id":"IC_kwDOGusT1c5OsftC","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Here is the helper needed to build the fully qualified name:\r\n\r\n```python\r\ndef _resolve_module_name(name: str, globals: Optional[Mapping[str, object]], level: int) -> str:\r\n    if level == 0:\r\n        return name\r\n    # Calc the package from globals\r\n    package = _calc___package__(globals or {})\r\n    # Logic taken from importlib._resolve_name\r\n    bits = package.rsplit(\".\", level - 1)\r\n    if len(bits) < level:\r\n        raise ImportError(\"Attempted relative import beyond top-level package\")\r\n    base = bits[0]\r\n    return f\"{base}.{name}\" if name else base\r\n\r\n# Copied from importlib._calc__package__\r\ndef _calc___package__(globals: Mapping[str, object]) -> str:\r\n    \"\"\"Calculate what __package__ should be.\r\n    __package__ is not guaranteed to be defined or could be set to None\r\n    to represent that its proper value is unknown.\r\n    \"\"\"\r\n    package = globals.get(\"__package__\")\r\n    spec = globals.get(\"__spec__\")\r\n    if package is not None:\r\n        if spec is not None and package != spec.parent:\r\n            warnings.warn(\"__package__ != __spec__.parent \"\r\n                           f\"({package!r} != {spec.parent!r})\",\r\n                           DeprecationWarning, stacklevel=3)\r\n        return package\r\n    elif spec is not None:\r\n        return spec.parent\r\n    else:\r\n        warnings.warn(\"can't resolve package from __spec__ or __package__, \"\r\n                       \"falling back on __name__ and __path__\",\r\n                       ImportWarning, stacklevel=3)\r\n        package = globals[\"__name__\"]\r\n        if \"__path__\" not in globals:\r\n            package = package.rpartition('.')[0]\r\n    return package\r\n```","createdAt":"2022-11-18T17:00:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/208#issuecomment-1320287042","viewerDidAuthor":false}],"createdAt":"2022-11-18T16:52:24Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":208,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Sandbox importer not respecting relative levels for pass through","updatedAt":"2022-12-02T21:13:04Z","url":"https://github.com/temporalio/sdk-python/issues/208"}
