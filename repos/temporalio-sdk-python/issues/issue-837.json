{"assignees":[],"author":{"id":"MDQ6VXNlcjE5NDIyNzk0","is_bot":false,"login":"RoggeOhta","name":"RoggeOhta"},"body":"### Problem\nTemporal's activity/workflow logger adapter uses a Dict for its \"extra\" field, violating the OpenTelemetry format that requires basic data types (bool, str, bytes, int, float).\n\n### Solution\n#838 \n","closedAt":null,"comments":[{"id":"IC_kwDOGusT1c6oJqW4","author":{"login":"RoggeOhta"},"authorAssociation":"NONE","body":"#838 I've write a draft solution for this problem","createdAt":"2025-04-22T12:01:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/837#issuecomment-2821105080","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6oKtJh","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks for the issue!\n\nWe cannot incompatibly change default logging for all users because of OpenTelemetry-only limitations. Also per https://opentelemetry.io/docs/languages/python/, OTel logging is still in development. Once it does stabilize, we can definitely look into opt-in options for either splatting the details as done in the PR, or adding something to `temporalio.contrib.opentelemetry` to help handle this nested \"extra\" data on log records.\n\nDigging through the OTel source, it seems attributes can have nested dicts. It links to https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/logs/data-model.md#field-attributes which says the attribute values can be `any` which supports nested dicts I think: https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/logs/data-model.md#type-any. I wonder what type of error you are seeing here?","createdAt":"2025-04-22T13:42:22Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/837#issuecomment-2821378657","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6oMPfL","author":{"login":"RoggeOhta"},"authorAssociation":"NONE","body":"> Thanks for the issue!\n> \n> We cannot incompatibly change default logging for all users because of OpenTelemetry-only limitations. Also per https://opentelemetry.io/docs/languages/python/, OTel logging is still in development. Once it does stabilize, we can definitely look into opt-in options for either splatting the details as done in the PR, or adding something to `temporalio.contrib.opentelemetry` to help handle this nested \"extra\" data on log records.\n> \n> Digging through the OTel source, it seems attributes can have nested dicts. It links to https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/logs/data-model.md#field-attributes which says the attribute values can be `any` which supports nested dicts I think: https://github.com/open-telemetry/opentelemetry-specification/blob/main/specification/logs/data-model.md#type-any. I wonder what type of error you are seeing here?\n\nThank you for the response. I wasn't aware of the opentelemetry-specification. The error is actually a warning generated by the `opentelemetry-sdk` Python library.\nhttps://github.com/open-telemetry/opentelemetry-python/blob/742171e50c70f4a4540a01d2c6c3cbcf4882d810/opentelemetry-api/src/opentelemetry/attributes/__init__.py#L111\n\nThe library verifies if an attribute type is among the `_VALID_ATTR_VALUE_TYPES`, but it has a broader category called `_VALID_ANY_VALUE_TYPES` that includes Mapping types, which was not utilized. When it finds attributes that are not of basic types, it removes them, complicating the ability to trace specific activities or workflows.\nhttps://github.com/open-telemetry/opentelemetry-python/blob/742171e50c70f4a4540a01d2c6c3cbcf4882d810/opentelemetry-api/src/opentelemetry/attributes/__init__.py#L25\n\nCould we potentially implement a workaround to address this, like adding an option to flatten the logger's extra field?","createdAt":"2025-04-22T15:57:09Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/837#issuecomment-2821781451","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6oPf7e","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Could we potentially implement a workaround to address this, like adding an option to flatten the logger's extra field?\n\nI am concerned about flattening Temporal-specific values just for OTel purposes. To do this right, we'd really need to prefix `temporal_activity.` and `temporal_workflow.` to all the extra value names when flattening. But it is technically something we can do, though we may want to wait until logging stabilizes in case there is a better handler-level approach we can devise instead of doing this at the logger level.\n\nI think a better approach may be to encourage custom adapters. You could set `temporalio.activity.logger` and `temporalio.workflow.logger` to your own class extensions of `temporalio.activity.LoggerAdapter` and `temporalio.workflow.LoggerAdapter` setting the `activity_info_on_extra` and `workflow_info_on_extra` to `False` on super init or post super init. Then you can override `process` to set whatever \"extra\" values from the activity/workflow context you'd like instead of using the preset default ones. This is the primary reason we exposed and documented those adapter classes is for this kind of advanced customization.","createdAt":"2025-04-22T22:46:09Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/837#issuecomment-2822635230","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6ogW8v","author":{"login":"RoggeOhta"},"authorAssociation":"NONE","body":"Okay, I found a workaround. Posting in case it helps others who encounter this issue.\n\nFirst, set global `activity` and `workflow` logger at your program init. Turn off the extra info.\n```python\nactivity.logger.activity_info_on_extra = False\nworkflow.logger.workflow_info_on_extra = False\n```\n\nThen, in every `activity/workflow`, add this info manually to your own logger.\n```\n# start of some activity\nmy_logger.extra = activity.info()._logger_details()\n\n# start of some workflow\nmy_logger.extra = workflow.info()._logger_details()\n```\n\nThis should bypass the python oTel library warning while retaining activity trace logs.","createdAt":"2025-04-24T10:04:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/837#issuecomment-2827054895","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6ojiiK","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":":+1:\n\n> Then, in every activity/workflow, add this info manually to your own logger\n\nAn alternative is to replace those loggers with your own extension of `activity.LoggerAdapter` and `workflow.LoggerAdapter` that overrides `process` to set these values.\n\nThe concern here for us adding this option as-is is that we need to qualify all keys with `temporal_activity.` and `temporal_workflow.` prefixes probably if we're not allowed nested maps. We may be able to add that option today or wait until OTel logging stabilizes.","createdAt":"2025-04-24T14:38:32Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-python/issues/837#issuecomment-2827888778","viewerDidAuthor":false}],"createdAt":"2025-04-22T11:48:20Z","labels":[{"id":"LA_kwDOGusT1c7gQgHN","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":837,"reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"state":"OPEN","title":"[Feature Request] Make Temporal logger adapter accomodate to OpenTelemetry","updatedAt":"2025-04-24T14:45:40Z","url":"https://github.com/temporalio/sdk-python/issues/837"}
