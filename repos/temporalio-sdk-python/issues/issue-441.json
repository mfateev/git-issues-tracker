{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"### Describe the bug\r\n\r\nReports of:\r\n\r\n```\r\nFailed to detach context\r\n\r\nTraceback (most recent call last):\r\n  File \"/path/to/temporalio/contrib/opentelemetry.py\", line 427, in _top_level_workflow_context\r\n    yield None\r\n  File \"/path/to/temporalio/contrib/opentelemetry.py\", line 340, in execute_workflow\r\n    return await super().execute_workflow(input)\r\nGeneratorExit\r\n\r\nDuring handling of the above exception, another exception occurred:\r\n\r\nTraceback (most recent call last):\r\n  File \"/path/to/opentelemetry/context/__init__.py\", line 157, in detach\r\n    _RUNTIME_CONTEXT.detach(token)  # type: ignore\r\n  File \"/path/to/opentelemetry/context/contextvars_context.py\", line 50, in detach\r\n    self._current_context.reset(token)  # type: ignore\r\nValueError: <Token var=<ContextVar name='current_context' default={} at 0x79340011d590> at 0x7933a4b4c9c0> was created in a different Context\"\r\n```\r\n\r\nThere are outstanding issues like https://github.com/open-telemetry/opentelemetry-python/issues/2606 that may be related.","closedAt":"2025-10-22T18:57:18Z","comments":[{"id":"IC_kwDOGusT1c57MkRA","author":{"login":"jpcarlino"},"authorAssociation":"NONE","body":"Is there any workaround for this? We have tons of these errors in our logs forcing us to disable tracing in our workers.","createdAt":"2024-04-19T16:16:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/441#issuecomment-2066891840","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c57Mmg0","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I am not aware of an obvious one (see linked upstream ticket). We may be able to make sure everywhere we `detach` we aren't doing so in a `GeneratorExit`.\r\n\r\nHowever, we have found that `GeneratorExit` has other problems, so we have made a fairly substantial change to workflow teardown in #499 that should prevent `GeneratorExit` from occurring within common workflow use cases (i.e. we try to force tasks to complete before letting garbage collector take over and raise this). This will come out in next release, but if you'd like you can build `main` now and test it. Your errors may go away.\r\n\r\nI wouldn't be surprised if this is some OpenTelemetry users' issue too - `GeneratorExit` can occur in a completely different thread than the async code was originally run within and may have lost all contextual information. It's a very dangerous thing Python does here (waking up tasks on GC in any thread).","createdAt":"2024-04-19T16:23:16Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-python/issues/441#issuecomment-2066901044","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c57RCCm","author":{"login":"benliddicott"},"authorAssociation":"NONE","body":"@cretz  As I commented on #2606 I was able to work around a similar issue. Feel free to contact me if you are interested in more details.\r\nhttps://github.com/open-telemetry/opentelemetry-python/issues/2606#issuecomment-1789515786\r\n\r\n\r\nI suspect that if the otel teardown_request hook \"opentelemetry-flask.activation_key\" could somehow know that it was not in the correct context (e.g. on the wrong thread, or different async context) and therefore decide to do nothing, this might resolve the issue.","createdAt":"2024-04-21T14:21:45Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/441#issuecomment-2068062374","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c57bps6","author":{"login":"matthewgrossman"},"authorAssociation":"NONE","body":"Hey @benliddicott I've been following this issue for python-otel, and put out a flask-specific fix awhile back: https://github.com/open-telemetry/opentelemetry-python-contrib/pull/1692. Since you're still recently having issues, I'm imagining that didn't resolve it for you (unless you're on an old version?)\r\n\r\nMaybe the changes / PR desc could be helpful debugging your issue?","createdAt":"2024-04-22T19:56:44Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/441#issuecomment-2070846266","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c57bxF2","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"For the Temporal SDK here in this GH issue, we don't even use Flask. The GC can wake up the coroutine in any thread, including the same one it may have started in but is currently being used for something else by the thread pool. There's not much you can do but avoid letting coroutines/generators get GC'd (i.e. cancel and wait for graceful completion).","createdAt":"2024-04-22T20:15:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/441#issuecomment-2070876534","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c57bzd8","author":{"login":"matthewgrossman"},"authorAssociation":"NONE","body":"Ya sorry about the flask noise, probably better to post what I did back in https://github.com/open-telemetry/opentelemetry-python/issues/2606\r\n\r\nI'm now on a new project where we're running into the same error, and it's moreso related to generators/coroutines that you are mentioning; that's why I'm also following this thread","createdAt":"2024-04-22T20:22:12Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/441#issuecomment-2070886268","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c57b0Ut","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"No prob, yeah I flat out could not find a good solution besides not ever reaching `GeneratorExit` (or coroutine GC). There's no way to disable this behavior, no way to intercept, and with threading (especially thread pools) no guarantee where it may wake up.\r\n\r\nSo that's how we solved this, just making sure all tasks complete (but leaving open until we release it)","createdAt":"2024-04-22T20:24:23Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/441#issuecomment-2070889773","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c57cHN7","author":{"login":"benliddicott"},"authorAssociation":"NONE","body":"@matthewgrossman I am not having issues, as I have a workaround, as described in https://github.com/open-telemetry/opentelemetry-python/issues/2606#issuecomment-1789515786 so there is no urgency from my side.\r\n\r\n@cretz  I haven't tried to find out if my workaround is still necessary in the latest release - all I can say is that the version we are using hasn't broken the workaround.","createdAt":"2024-04-22T21:16:46Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/441#issuecomment-2070967163","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c577aS8","author":{"login":"hellais"},"authorAssociation":"NONE","body":"@benliddicott would you be available to share the code you used as a solution to this? I am running into the same issue as well.","createdAt":"2024-04-26T11:05:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/441#issuecomment-2079171772","viewerDidAuthor":false}],"createdAt":"2023-12-07T13:00:54Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":441,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":4}}],"state":"CLOSED","title":"[Bug] GeneratorExit possibly causing issues on context detach in OTel finally","updatedAt":"2025-10-22T18:57:18Z","url":"https://github.com/temporalio/sdk-python/issues/441"}
