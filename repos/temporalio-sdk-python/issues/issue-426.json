{"assignees":[],"author":{"id":"MDQ6VXNlcjE4NzQwNjU5","is_bot":false,"login":"tomasfarias","name":"Tomás Farías Santana"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\nTrying to produce messages to Kafka using `aiokafka` from a Temporal Workflow fails [when trying to check if the current event loop is running](https://github.com/aio-libs/aiokafka/blob/master/aiokafka/util.py#L84). This is caused by the the Temporal event loop not fully implement the `AbstractEventLoop` interface, which includes `is_running`. Although more understandable when it comes to thread methods (`to_thread`, etc...), simpler methods like `is_running` should be easy to implement.\r\n\r\n<!-- A clear and concise description of what the problem is. Ex. I'm always frustrated when [...] -->\r\n\r\n### Describe the solution you'd like\r\n\r\nAdd an `is_running` method to `_WorkflowInstanceImpl` to better conform to the `AbstractEventLoop` interface, perhaps by checking `_deleting`:\r\n\r\n```python\r\ndef is_running(self) -> bool:\r\n    return not self._deleting\r\n```\r\n\r\nAlthough perhaps it should always be `True` as long as there is a Runtime defined?\r\n\r\n<!-- A clear and concise description of what you want to happen. SCREENSHOTS OR CODE SAMPLES ARE VERY HELPFUL -->\r\n\r\n### Additional context\r\n\r\nThe Python doc [states](https://docs.python.org/3.12/library/asyncio-eventloop.html?highlight=abstracteventloop#asyncio.AbstractEventLoop) that custom implementations of `AbstractEventLoop` should have all methods defined [here](https://docs.python.org/3.12/library/asyncio-eventloop.html?highlight=abstracteventloop#asyncio-event-loop-methods). Although they are not being strict about it (\"should have defined\"), the closer Temporal's event loop gets to the interface, the more it can interoperate with other Python packages, like `aiokafka`.\r\n\r\n<!-- Add any other context or screenshots about the feature request here. -->\r\n","closedAt":"2023-11-13T23:46:14Z","comments":[{"id":"IC_kwDOGusT1c5r1jWR","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"We can't implement all methods of the event loop, only deterministic ones. You should never call Kafka from inside a workflow, only from inside an activity. A workflow is meant to be deterministic code only. There is never a case where you should need `is_running` and we can't really give an accurate value for that or `is_closed` like a non-distributed event loop can. I guess _technically_ we could just always return `True` from `is_running` and always return `False` from `is_closed`, but it's not really accurate as it's never really running/closed in the background like a normal event loop.\r\n\r\nI'm actually kind of glad this raised a not-implemented so it catches illegal things happening to the workflow's event loop, such as code based on whether it's \"running\" or not as if it was a local event loop.","createdAt":"2023-11-13T21:58:41Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/426#issuecomment-1809200529","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c5r1-hn","author":{"login":"tomasfarias"},"authorAssociation":"NONE","body":"> You should never call Kafka from inside a workflow, only from inside an activity. A workflow is meant to be deterministic code only.\r\n\r\nA call to Kafka (or any other external service) can be made deterministic: It's a matter of handling possible errors in a deterministic fashion. In my case, I ignore them and move on.\r\n\r\n> I'm actually kind of glad this raised a not-implemented so it catches illegal things happening to the workflow's event loop, such as code based on whether it's \"running\" or not as if it was a local event loop.\r\n\r\nNot much else to say from my end as this is the direction you are glad to go with. We will deal with the issue from our side. Thank you for taking time to answer this request. I'll go ahead and close it.","createdAt":"2023-11-13T23:46:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/426#issuecomment-1809311847","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6SoZhe","author":{"login":"EdAyers"},"authorAssociation":"NONE","body":"Parts of python standard library assume that is_running and is_closed are implemented:\r\n\r\nEg consider this line in aiohttp https://github.com/aio-libs/aiohttp/blob/3f2f4a705f588d79a8649bfb17018cb30431df89/aiohttp/connector.py#L960\r\n```py\r\n        if sys.version_info >= (3, 12):\r\n            # Optimization for Python 3.12, try to send immediately\r\n            resolved_host_task = asyncio.Task(coro, loop=loop, eager_start=True)\r\n```\r\nAnd if we look in the stdlib asyncio code we can see this calls:\r\n\r\nhttps://github.com/python/cpython/blob/83827ad81972e8e6438a29274dbdcb923d7b1cc4/Lib/asyncio/tasks.py#L124\r\n```py\r\n        if eager_start and self._loop.is_running():\r\n            self.__eager_start()\r\n```\r\nBut is_running() raises a NotImplementedError because the method is abstract.\r\n\r\nhttps://github.com/temporalio/sdk-python/blob/0b327b04a95fc7954ed2c9e4e1a6c5de47c51ebd/temporalio/worker/_workflow_instance.py#L195\r\n\r\nIf you do not support parts of the standard AbstractEventLoop interface that the standard core python library assumes exists, you need to reimplement them and give an error message that makes it clear what is being done wrong. It's particularly hard to debug since the event loop is only this WorkflowInstance in certain circumstances.\r\n\r\nFrom the discussion above I think it's a mistake to try to make an aiohttp ClientSession outside of an activity. So that's how we fixed it, but more helpful errors explaining why the usage was wrong would be really appreciated here.","createdAt":"2024-11-06T15:26:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/426#issuecomment-2460063838","viewerDidAuthor":false}],"createdAt":"2023-11-13T19:32:33Z","labels":[{"id":"LA_kwDOGusT1c7gQgHN","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":426,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"[Feature Request] Implement `is_running` for `_WorkflowInstanceImpl`","updatedAt":"2024-11-06T15:38:12Z","url":"https://github.com/temporalio/sdk-python/issues/426"}
