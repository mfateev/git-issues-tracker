{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"### Describe the bug\r\n\r\nGiven workflow logic like:\r\n\r\n```python\r\nawait workflow.execute_activity(some_activity, ...)\r\nawait workflow.execute_child_workflow(SomeChildWorkflow.run, ...)\r\n```\r\n\r\nThere may be an issue where cancellation is sent after activity is marked complete but before the next task is processed. So an event history like:\r\n\r\n* `ActivityTaskCompleted`\r\n* `WorkflowExecutionCancelRequested`\r\n\r\nWhere both of those are in a single task. To replicate, the best way may be to:\r\n\r\n* Create separate workflow and activity workers\r\n* After activity starts, kill the workflow worker\r\n* Complete activity and confirm completion is in history\r\n* Send cancellation to workflow\r\n* Start back up the workflow worker and confirm it processes activity completion, then cancellation\r\n\r\nThis has not been tested, so it may not be a bug. If this is indeed a bug, this may be a gap in our asyncio implementation. One would expect that issuing a cancel on the workflow asyncio task would automatically propagate to next non-shielded await but maybe it does not do that automatically because it never expects to receive a cancel when not awaiting on something (i.e. it relies on GIL to know that asyncio does not yield to outside until waiting on coroutine). But [the docs](https://docs.python.org/3/library/asyncio-task.html#task-cancellation) do say:\r\n\r\n> When a task is cancelled, [asyncio.CancelledError](https://docs.python.org/3/library/asyncio-exceptions.html#asyncio.CancelledError) will be raised in the task at the next opportunity.\r\n\r\nNeed to investigate...","closedAt":null,"comments":[],"createdAt":"2023-07-18T18:08:21Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":352,"reactionGroups":[],"state":"OPEN","title":"[Bug] Cancel received in between awaitables not cancelling workflow","updatedAt":"2023-07-18T18:10:57Z","url":"https://github.com/temporalio/sdk-python/issues/352"}
