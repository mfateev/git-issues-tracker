{"assignees":[],"author":{"id":"MDQ6VXNlcjE4ODc0NjM=","is_bot":false,"login":"gbxl","name":"Lucas"},"body":"### Is your feature request related to a problem? Please describe.\n\nWhen using [the suggested polling style](https://github.com/temporalio/samples-python/blob/main/polling/test_service.py#L29) leveraging `raise ApplicationError(category=BENIGN)` and activity retries, Temporal seem to properly catch that it's not really an error and log it at a debug level. Unfortunately, OpenTelemetry still reports the exception as an error just as dire as any other one. This is an issue because then libraries like `logfire` that plug into OpenTelemetry will trigger alerts for \"expected behavior\"\n\n### Describe the solution you'd like\n\nIt'd be great to have a possible configuration or have an update to the OpenTelemetry contrib so that benign errors aren't treated as a real error in OpenTelemetry spans\n\n### Additional context\n\nI ended up adding a custom interceptor like this:\n```\nclass BenignAppErrorInterceptor(Interceptor):\n    \"\"\"Interceptor to handle benign application errors in activities.\"\"\"\n\n    def intercept_activity(\n        self,\n        next: ActivityInboundInterceptor,  # noqa: A002\n    ) -> ActivityInboundInterceptor:\n        \"\"\"Intercept activity execution to handle benign application errors.\"\"\"\n        return _BenignAppErrorActivityInboundInterceptor(next)\n\n\nclass _BenignAppErrorActivityInboundInterceptor(ActivityInboundInterceptor):\n    def __init__(self, next: ActivityInboundInterceptor) -> None:  # noqa: A002\n        super().__init__(next)\n\n    async def execute_activity(self, input, *args, **kwargs):  # noqa: A002, ANN002, ANN003, ANN001, ANN202\n        try:\n            return await super().execute_activity(input, *args, **kwargs)\n        except ApplicationError as e:\n            msg = str(e)\n            category = getattr(e, \"category\", None) or \"\"\n            if category == \"BENIGN\":\n                span = trace.get_current_span()\n                if span and span.is_recording():\n                    span.set_attribute(\"temporal.error.benign\", value=True)\n                    span.add_event(\n                        \"benign_application_error_filtered\",\n                        {\n                            \"exception.type\": \"ApplicationError\",\n                            \"exception.message\": msg,\n                            \"exception.category\": str(category),\n                        },\n                    )\n                    span.set_status(Status(StatusCode.OK))\n                raise\n```\nBut that seems really unideal to have to do that on the user side.","closedAt":"2025-09-10T15:11:48Z","comments":[{"id":"IC_kwDOGusT1c6_xtwI","author":{"login":"gregbrowndev"},"authorAssociation":"NONE","body":"Btw, this only suppresses the error status in the span because calling:\n\n```py\nspan = trace.get_current_span()\n...\nspan.set_status(Status(StatusCode.OK))\n``` \n\nprevents the status being set again on the same span. But you'll still get the exception event attached by the upstream `TracingInterceptor`. Would it be necessary to suppress that too, to align with the logging/metric behaviour?\n\nI'm sure you know, suppressing the fail with an OK status probably isn't ideal either, but it works as a hack since `set_status` explicitly ignores being called with `UNSET` ([reference](https://github.com/open-telemetry/opentelemetry-python/blob/1aaa2a25872c36aee208442ff654a67f5daa5736/opentelemetry-sdk/src/opentelemetry/sdk/trace/__init__.py#L964)). \n\nFor reference, from the [OTEL spec](https://opentelemetry.io/docs/specs/otel/trace/api/#set-status):\n\n> Generally, Instrumentation Libraries SHOULD NOT set the status code to Ok, unless explicitly configured to do so. Instrumentation Libraries SHOULD leave the status code as Unset unless there is an error, as described above.\n>\n> Application developers and Operators may set the status code to Ok.\n\nThe fix here probably does require changes to the `TracingInterceptor` to avoid these issues, setting `set_status_on_exception=False` in the TracingInterceptor and handling the exceptions explicitly like I suggested in https://github.com/temporalio/sdk-python/issues/1047.\n\n\nAlso to point out, @gbxl, even if you modify the interceptor to fix the parent span status for these \"BENIGN\" errors, any childspans you create further downstream will still be marked as failed unless you add the same logic to those spans too. Not sure if that causes a problem with the logfire integration, or if it only cares about the parent span?\n\nOne possible solution to solve that would be to make your own `BenignException` class that extends `BaseException`, which would be ignored by any childspans ([reference](https://github.com/open-telemetry/opentelemetry-python/blob/1aaa2a25872c36aee208442ff654a67f5daa5736/opentelemetry-api/src/opentelemetry/trace/__init__.py#L593-L596)). But then you may need to catch and convert that back into the Temporal kind at the start of your activity function or maybe in an interceptor, otherwise Temporal would convert it back into a default `ApplicationError`, I think.","createdAt":"2025-08-23T23:42:11Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/1041#issuecomment-3217480712","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6__gFD","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"We agree that this is a valuable change. We'll evaluate it in triage and see if we can prioritize it.","createdAt":"2025-08-25T17:16:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/1041#issuecomment-3221094723","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c7AAGnK","author":{"login":"gbxl"},"authorAssociation":"NONE","body":"> I'm sure you know, suppressing the fail with an OK status probably isn't ideal either, but it works as a hack since `set_status` explicitly ignores being called with `UNSET` ([reference](https://github.com/open-telemetry/opentelemetry-python/blob/1aaa2a25872c36aee208442ff654a67f5daa5736/opentelemetry-sdk/src/opentelemetry/sdk/trace/__init__.py#L964)).\n\n@gregbrowndev Yeah this is 100% a hack I was playing with and probably won't go to production (I'd rather have a rule in logfire to ignore ApplicationErrors with text match). \nLove the insights you added to your comment though <3 \n\n> even if you modify the interceptor to fix the parent span status for these \"BENIGN\" errors, any childspans you create further downstream will still be marked as failed unless you add the same logic to those spans too. Not sure if that causes a problem with the logfire integration, or if it only cares about the parent span?\n\nIn this case the span ends with the error since the span wraps the activity execution, but yeah it would likely be an issue with adding more children to it.\n\n","createdAt":"2025-08-25T18:08:48Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/1041#issuecomment-3221252554","viewerDidAuthor":false}],"createdAt":"2025-08-20T21:03:57Z","labels":[{"id":"LA_kwDOGusT1c7gQgHN","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1041,"reactionGroups":[{"content":"HEART","users":{"totalCount":2}}],"state":"CLOSED","title":"[Feature Request] Reclassify Benign Application errors in OpenTelemetry","updatedAt":"2025-09-10T15:11:48Z","url":"https://github.com/temporalio/sdk-python/issues/1041"}
