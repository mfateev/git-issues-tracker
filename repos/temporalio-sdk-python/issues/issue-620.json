{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"### Describe the bug\r\n\r\nIn Python if a cancellation is requested of a workflow with a short-lived activity, and that activity completes during cancellation (unsure if you have to set cancellation type as wait on the activity), the cancellation is effectively swallowed. This occurs for any Python asyncio where cancellation is used, if the awaiting thing swallows cancellation it's like it never happened.\r\n\r\nThis is probably just existing, unfortunate Python behavior we have to document. We need to at least confirm if it is only for wait-cancel cancellation types or try-cancel too.","closedAt":"2025-07-02T21:12:20Z","comments":[{"id":"IC_kwDOGusT1c6JulNA","author":{"login":"lambyqq"},"authorAssociation":"NONE","body":"Here's some test code that could reproduce this:\r\n```\r\n@activity.defn\r\nasync def short_activity_async():\r\n   delay = random.uniform(0.05, 0.15)  # 50~150ms delay\r\n   await asyncio.sleep(delay)\r\n\r\n\r\n@activity.defn\r\ndef short_activity_sync():\r\n   delay = random.uniform(0.05, 0.15)  # 50~150ms delay\r\n   sleep(delay)\r\n\r\n\r\n@workflow.defn\r\nclass ShortActivityWorkflow:\r\n   @workflow.run\r\n   async def run(self, total_seconds: float = 10.0):\r\n       end = workflow.now() + timedelta(seconds=total_seconds)\r\n       while True:\r\n           await workflow.execute_activity(\r\n               short_activity_async,\r\n               schedule_to_close_timeout=timedelta(seconds=10))\r\n           await workflow.execute_activity(\r\n               short_activity_sync,\r\n               schedule_to_close_timeout=timedelta(seconds=10))\r\n           if workflow.now() > end:\r\n               break\r\n\r\n\r\n@pytest.mark.asyncio\r\nasync def test_workflow_cancellation():\r\n   ...\r\n   client: Client = ...\r\n   async with Worker(\r\n           client,\r\n           task_queue='test-wf-cancellation-task-queue',\r\n           workflows=[ShortActivityWorkflow],\r\n           activities=[short_activity_async, short_activity_sync],\r\n           activity_executor=ThreadPoolExecutor(max_workers=1)\r\n   ):\r\n       for i in range(10):\r\n           wf_duration = random.uniform(5.0, 15.0)\r\n           wf_handle = await client.start_workflow(\r\n               ShortActivityWorkflow.run,\r\n               id=f'short_activity_wf_id-{i}',\r\n               args=[wf_duration],\r\n               task_queue=test_worker_task_queue,\r\n               execution_timeout=timedelta(minutes=1)\r\n           )\r\n\r\n           # Cancel wf\r\n           await asyncio.sleep(1.0)\r\n           await wf_handle.cancel()\r\n\r\n           with pytest.raises(WorkflowFailureError) as err_info:\r\n               await wf_handle.result()  # failed\r\n           cause = err_info.value.cause\r\n           assert isinstance(cause, CancelledError)\r\n           assert cause.message == 'Workflow cancelled'\r\n```","createdAt":"2024-08-26T17:17:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/620#issuecomment-2310689600","viewerDidAuthor":false}],"createdAt":"2024-08-26T11:55:11Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":620,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Workflow cancellation can be swallowed","updatedAt":"2025-07-02T21:12:20Z","url":"https://github.com/temporalio/sdk-python/issues/620"}
