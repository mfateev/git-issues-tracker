{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"### Describe the bug\r\n\r\nThere are two problems here:\r\n\r\n#### GeneratorExit is caught somewhere\r\n\r\nWhen a coroutine is closed, Python [throws a `GeneratorExit` from the coroutine](https://github.com/python/cpython/blob/a7a450f84a087421603170c2dad226bb881d4d9a/Lib/_collections_abc.py#L146-L154) and expects that to be bubbled out. But somewhere we are not bubbling that out so Python throws a runtime exception on this. So we're getting:\r\n\r\n> RuntimeError: coroutine ignored GeneratorExit\r\n> Exception ignored in: <coroutine object _WorkflowInstanceImpl._apply_start_workflow.<locals>.run_workflow at 0x000001F7B495E340>\r\n\r\nWith a stack trace.\r\n\r\n#### Core timer error\r\n\r\nWhen workflow is evicted, sometimes when it reruns from scratch it gets something like:\r\n\r\n> 2023-06-05T22:04:56.500788Z  WARN temporal_sdk_core::worker::workflow: Failing workflow task run_id=b4c01744-339b-4d39-98f8-10e0c7d3846c failure=Failure { failure: Some(Failure { message: \"Fatal(\\\"Timer fired event did not have expected timer id 8, it was 2!\\\")\", source: \"\", stack_trace: \"\", encoded_attributes: None, cause: None, failure_info: Some(ApplicationFailureInfo(ApplicationFailureInfo { r#type: \"\", non_retryable: false, details: None })) }), force_cause: Unspecified }\r\n\r\nUnsure if this is due to `GeneratorExit` above or if that failure just surfaced the problem.\r\n\r\n### Replication\r\n\r\n```python\r\nimport asyncio\r\nimport logging\r\nfrom uuid import uuid4\r\n\r\nfrom temporalio import workflow\r\nfrom temporalio.testing import WorkflowEnvironment\r\nfrom temporalio.worker import Worker\r\n\r\n\r\n@workflow.defn\r\nclass MyWorkflow:\r\n    @workflow.run\r\n    async def run(self) -> None:\r\n        try:\r\n            for _ in range(20):\r\n                await asyncio.sleep(0.5)\r\n        finally:\r\n            await asyncio.sleep(1)\r\n\r\n    @workflow.signal\r\n    async def my_signal(self) -> None:\r\n        pass\r\n\r\n\r\nasync def main():\r\n    logging.basicConfig(level=logging.INFO)\r\n\r\n    async with await WorkflowEnvironment.start_local() as env:\r\n        logging.info(\"Starting worker\")\r\n        task_queue = f\"tq-{uuid4()}\"\r\n        async with Worker(\r\n            env.client,\r\n            task_queue=task_queue,\r\n            workflows=[MyWorkflow],\r\n            max_cached_workflows=0,\r\n        ):\r\n\r\n            logging.info(\"Starting workflow\")\r\n            handle = await env.client.start_workflow(\r\n                MyWorkflow.run,\r\n                id=f\"wf-{uuid4()}\",\r\n                task_queue=task_queue,\r\n            )\r\n\r\n            logging.info(\"Signalling every 300ms\")\r\n            for _ in range(20):\r\n                await asyncio.sleep(0.3)\r\n                await handle.signal(MyWorkflow.my_signal)\r\n\r\n            logging.info(\"Waiting for workflow completion\")\r\n            await handle.result()\r\n            logging.info(\"Workflow done\")\r\n\r\n\r\nif __name__ == \"__main__\":\r\n    asyncio.run(main())\r\n```\r\n\r\nThis is based on a user repo. This disables cache and makes a bunch of timers. But this causes constant evictions for each timer and signal sent which is causing the `GeneratorExit` issue. But that `GeneratorExit` issue is _also_ causing this core error. I have not yet determined whether the `GeneratorExit` issue is surfacing a core bug or is just the bug itself w/ an eviction problem and core is somehow showing it.","closedAt":"2023-07-11T19:18:58Z","comments":[{"id":"IC_kwDOGusT1c5eJY9r","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Here's the issue for `GeneratorExit` as comments on the original workflow:\r\n\r\n```python\r\n@workflow.defn\r\nclass MyWorkflow:\r\n    @workflow.run\r\n    async def run(self) -> None:\r\n        try:\r\n            for _ in range(20):\r\n                # With cache disabled, this is evicted which when GC'd causes\r\n                # this to throw a GeneratorExit (which is usually ok)\r\n                await asyncio.sleep(0.5)\r\n        finally:\r\n            # This tries to run on GeneratorExit, but fails with a RuntimeError\r\n            # of \"no running event loop\". Since this finally was not written well\r\n            # it swallows the GeneratorExit error making Python mad it didn't\r\n            # receive the error\r\n            await asyncio.sleep(1)\r\n```\r\n\r\nSo, the `finally` block is causing an error which swallows the actual `GeneratorExit` making Python upset. No matter how many ways I've tried (e.g. trying to overwrite `close` on `coroutine` which are read only), I cannot prevent the `coroutine.close()` which does the `GeneratorExit` dance. From https://docs.python.org/3/reference/datamodel.html#coroutine.close:\r\n\r\n> Causes the coroutine to clean itself up and exit. If the coroutine is suspended, this method first delegates to the [close()](https://docs.python.org/3/reference/expressions.html#generator.close) method of the iterator that caused the coroutine to suspend, if it has such a method. Then it raises [GeneratorExit](https://docs.python.org/3/library/exceptions.html#GeneratorExit) at the suspension point, causing the coroutine to immediately clean itself up. Finally, the coroutine is marked as having finished executing, even if it was never started.\r\n>\r\n>   Coroutine objects are automatically closed using the above process when they are about to be destroyed.\r\n\r\nI am still investigating how I can try to tear down the event loop without it waking up. I am also still investigating how core timers can get out of sync here. My first thought was this is an old activation completing, but that doesn't seem accurate.","createdAt":"2023-06-06T22:09:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/325#issuecomment-1579519851","viewerDidAuthor":false}],"createdAt":"2023-06-05T21:55:08Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":325,"reactionGroups":[],"state":"CLOSED","title":"[Bug] GeneratorExit inadvertently caught, and also core timer mismatch ","updatedAt":"2023-07-11T19:18:58Z","url":"https://github.com/temporalio/sdk-python/issues/325"}
