{"assignees":[],"author":{"id":"U_kgDOCIUWPA","is_bot":false,"login":"adamh-oai","name":"Adam Hupp"},"body":"\r\nTo reproduce:\r\n  1. Checkout https://github.com/temporalio/samples-python\r\n  2. `poetry add ruamel.yaml`\r\n  3. Add `import ruamel.yaml` to the top of `hello/hello_activity.py`\r\n  4. `poetry run hello/hello_activity.py`\r\n\r\nThis produces the error here: https://gist.github.com/adamh-oai/dfdb9b07b89bf3cee10da34ba2582805\r\n\r\nImportant parts:\r\n\r\n```\r\n  File \"/Users/adamh/.virtualenvs/temporalio-samples-G-Ux_4V2-py3.11/lib/python3.11/site-packages/ruamel/yaml/representer.py\", line 1132, in <module>\r\n    RoundTripRepresenter.add_representer(TimeStamp, RoundTripRepresenter.represent_datetime)\r\n  File \"/Users/adamh/.virtualenvs/temporalio-samples-G-Ux_4V2-py3.11/lib/python3.11/site-packages/ruamel/yaml/representer.py\", line 135, in add_representer\r\n    cls.yaml_representers[data_type] = representer\r\n    ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^\r\nTypeError: unhashable type: '_RestrictedProxy'\r\n\r\nThe above exception was the direct cause of the following exception:\r\n...\r\n  File \"/Users/adamh/.virtualenvs/temporalio-samples-G-Ux_4V2-py3.11/lib/python3.11/site-packages/temporalio/worker/_workflow.py\", line 118, in __init__\r\n    raise RuntimeError(f\"Failed validating workflow {defn.name}\") from err\r\nRuntimeError: Failed validating workflow GreetingWorkflow\r\n```\r\n\r\nThis behavior is surprising to me because the workflow/activity is not actually using the `ruamel` package.  The error persists if I move the workflow/activity to a separate module and wrap in a `imports_passed_through` block.  Wrapping the `ruamel` import in this same block *does* resolve the error.  It seems like the `ruamel` import may have side effects on other modules.  So, I have a workaround, but (short of disabling sandboxing entirely) I'm concerned that in a large codebase with unpredictable 3rd party libraries this will be a recurring issue.","closedAt":null,"comments":[{"id":"IC_kwDOGusT1c6LXTGv","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"This is a sandbox issue. Despite those short \"hello\" samples being in the same file, we actually recommend workflows be in their own file. Can you replicate if the workflows are in a separate file and import the activities via \"passthrough\" similar to what's shown in the quickstart of the README: https://github.com/temporalio/sdk-python?tab=readme-ov-file#implementing-a-workflow?","createdAt":"2024-09-09T13:32:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/638#issuecomment-2338140591","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6LZZRP","author":{"login":"adamh-oai"},"authorAssociation":"NONE","body":"Yes, it happens if the workflows are in their own module and imported via an unsafe block:\r\n\r\n> The error persists if I move the workflow/activity to a separate module and wrap in a imports_passed_through block. Wrapping the ruamel import in this same block does resolve the error. It seems like the ruamel import may have side effects on other modules. So, I have a workaround, but (short of disabling sandboxing entirely) I'm concerned that in a large codebase with unpredictable 3rd party libraries this will be a recurring issue.","createdAt":"2024-09-09T17:36:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/638#issuecomment-2338690127","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6LZaom","author":{"login":"adamh-oai"},"authorAssociation":"NONE","body":" A related issue: https://github.com/temporalio/sdk-python/issues/301","createdAt":"2024-09-09T17:37:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/638#issuecomment-2338695718","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6LZgV4","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Yes, it happens if the workflows are in their own module and imported via an unsafe block:\r\n\r\nAh, I see the bug already opened for making the proxy item hashable. I wonder then if this is a duplicate of that. In this case our wrapping of datetime causes this issue.\r\n\r\n>  Wrapping the ruamel import in this same block does resolve the error. It seems like the ruamel import may have side effects on other modules.\r\n\r\nTo confirm, are you using this library _inside_ the workflow and want the import reloaded every time the workflow is run? We recommend passing through all imports you know you'll use deterministically and/or you don't want completely reloaded every time. It's going to be a performance issue to reload third party libraries for every workflow run, but I understand the safety benefit.\r\n\r\n> I'm concerned that in a large codebase with unpredictable 3rd party libraries this will be a recurring issue.\r\n\r\nYes, most do not use many third party libraries _inside_ their workflows, mostly only in activities and other code. But yes, our goal is to try our best to make third party libraries usable inside workflows but these hiccups happen here and there and we need to fix the linked bug.","createdAt":"2024-09-09T17:47:01Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/638#issuecomment-2338719096","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6LZuPd","author":{"login":"adamh-oai"},"authorAssociation":"NONE","body":"> To confirm, are you using this library inside the workflow and want the import reloaded every time the workflow is run? \r\n\r\nThis import is not used inside the workflow; in the real case where I hit this I was using it to load a yaml file for configuring the temporal client, but the workflows themselves don't import it or use it.","createdAt":"2024-09-09T18:09:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/638#issuecomment-2338776029","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6LZ8wu","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> but the workflows themselves don't import it or use it.\r\n\r\nThis error only occurs in workflow code when loading it in a sandbox, so somehow this yaml code is getting executed/loaded in a workflow. Maybe the activity imports weren't being passed through when you split the workflow file off onto its own?","createdAt":"2024-09-09T18:43:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/638#issuecomment-2338835502","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6P9nMk","author":{"login":"creatorrr"},"authorAssociation":"NONE","body":"Same issue. I ended up removing `ruamel` entirely but I found that adding the following to the _very first_ `__init__.py` file seems to help:\r\n\r\n```python\r\nfrom temporalio import workflow\r\n\r\nwith workflow.unsafe.imports_passed_through():\r\n    import ruamel.yaml\r\n\r\n    # also- msgpack if installed\r\n    import msgpack\r\n```","createdAt":"2024-10-15T22:41:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/638#issuecomment-2415293220","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6P9nbI","author":{"login":"creatorrr"},"authorAssociation":"NONE","body":"@cretz it would be really helpful to add this suggestion / explanation to the error though. It took up hours to track this down and fix :(","createdAt":"2024-10-15T22:42:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-python/issues/638#issuecomment-2415294152","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6P9ntc","author":{"login":"creatorrr"},"authorAssociation":"NONE","body":"or maybe a whitelist of common libraries in the temporal python sdk itself? that's probably not super wise but would save so much confusion","createdAt":"2024-10-15T22:43:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/638#issuecomment-2415295324","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6QE_3Y","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"We don't really control the error here unfortunately. We do have docs at https://github.com/temporalio/sdk-python?tab=readme-ov-file#workflow-sandbox that say in bold:\r\n\r\n> **For performance and behavior reasons, users are encouraged to pass through all third party modules whose calls will be deterministic**","createdAt":"2024-10-16T15:47:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/638#issuecomment-2417229272","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6QGd7T","author":{"login":"adamh-oai"},"authorAssociation":"NONE","body":"> This error only occurs in workflow code when loading it in a sandbox, so somehow this yaml code is getting executed/loaded in a workflow. \r\n\r\nThe way I interpreted it is that because ruamel patches datetime, it's implicitly used in the the workflow even though it's not imported.  FWIW, I can't repro this right now but it was weirdly inconsistent earlier as well so not sure what's going on; since someone else ran into it I assume this is a real issue.  Ideally ruamel would just Not Do That, but I'm also not sure why it does or what other options there are.  \r\n\r\nThe main issue is that an innocuous change in another part of the codebase that doesn't touch anything temporal related can cause temporal sandbox failures.  ","createdAt":"2024-10-16T18:35:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/638#issuecomment-2417614547","viewerDidAuthor":false},{"id":"IC_kwDOGusT1c6QHqbS","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> because ruamel patches datetime\r\n\r\nAh, I was not aware of this (unfamiliar with the library). So we proxy datetime to avoid people doing things like calling `now()`. But that proxying can be disabled. We have to do this for Pydantic because of an issue in Python subclass checking. So you can create a new sandbox runner without datetime proxied like https://github.com/temporalio/samples-python/blob/171b5e5b205167fdff4231978857c4efe1cd6225/pydantic_converter/worker.py#L45-L65 and pass that runner to the worker and `datetime` will not be affected usually.\r\n\r\nHowever, you may have to use `with temporalio.workflow.unsafe.sandbox_unrestricted():` for any ruamel-using code (even if it uses it indirectly, like with datetime) to avoid our other checks.\r\n\r\n> The main issue is that an innocuous change in another part of the codebase that doesn't touch anything temporal related can cause temporal sandbox failures.\r\n\r\nI am not sure any Python library can help this if patching is occurring. If you patch Python stdlib and some unrelated code expects it to work the stdlib way, it may fail. But between passing through imports, unrestricting sandbox for certain code, and disabling proxying for the `datetime` module, you should be able to remove all Temporal checks and wrappings.","createdAt":"2024-10-16T20:45:07Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/638#issuecomment-2417927890","viewerDidAuthor":false}],"createdAt":"2024-09-08T07:44:18Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":638,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"OPEN","title":"Importing 3rd party package `ruamel.yaml` anywhere causes failure to validate workflow","updatedAt":"2024-10-16T20:56:09Z","url":"https://github.com/temporalio/sdk-python/issues/638"}
