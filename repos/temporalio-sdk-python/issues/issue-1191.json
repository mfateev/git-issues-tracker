{"assignees":[],"author":{"id":"MDQ6VXNlcjEwNzg2NzQ=","is_bot":false,"login":"romank0","name":"Roman Konoval"},"body":"### What are you really trying to do?\n\nI use a custom codec to encrypt payload data.\n\n### Describe the bug\n\nIf the activity raises an exception with details failure is properly encoded and stored. But in the worker when the workflow is activated the following error happens and workflow cannot proceed and eventually time outs:\n```\nFailed activation on workflow MyWorkflow with ID 9c556743-9ebf-4c3b-9800-3c56f02248a7 and run ID 3aeb4af6-97b6-43df-9c3e-a8b0f4326cd6\nTraceback (most recent call last):\n  File \"..venv/lib/python3.11/site-packages/temporalio/worker/_workflow_instance.py\", line 413, in activate\n    self._apply(job)\n  File \"..venv/lib/python3.11/site-packages/temporalio/worker/_workflow_instance.py\", line 512, in _apply\n    self._apply_resolve_activity(job.resolve_activity)\n  File \"..venv/lib/python3.11/site-packages/temporalio/worker/_workflow_instance.py\", line 769, in _apply_resolve_activity\n    self._failure_converter.from_failure(\n  File \"..venv/lib/python3.11/site-packages/temporalio/converter.py\", line 1096, in from_failure\n    err.__cause__ = self.from_failure(failure.cause, payload_converter)\n                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"..venv/lib/python3.11/site-packages/temporalio/converter.py\", line 992, in from_failure\n    *payload_converter.from_payloads_wrapper(app_info.details),\n     ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"..venv/lib/python3.11/site-packages/temporalio/converter.py\", line 139, in from_payloads_wrapper\n    return self.from_payloads(payloads.payloads)\n           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n  File \"..venv/lib/python3.11/site-packages/temporalio/converter.py\", line 309, in from_payloads\n    raise KeyError(f\"Unknown payload encoding {encoding.decode()}\")\nKeyError: 'Unknown payload encoding binary/encrypted'\n```\n\n### Minimal Reproduction\n\nThis test when added to `tests/worker/tests_workflow.py` fails because of the timeout:\n```\n@activity.defn\nasync def activity_that_fails_with_details() -> str:\n    raise ApplicationError(\n        \"Activity failed intentionally\",\n        \"detail1\",\n        {\"error_code\": \"NOT_FOUND\", \"id\": \"test-123\"},\n        non_retryable=True,\n    )\n\n\n@workflow.defn\nclass WorkflowWithFailingActivityAndCodec:\n    @workflow.run\n    async def run(self) -> str:\n        try:\n            return await workflow.execute_activity(\n                activity_that_fails_with_details,\n                schedule_to_close_timeout=timedelta(seconds=3),\n                retry_policy=RetryPolicy(maximum_attempts=1),\n            )\n        except ActivityError as err:\n            return \"Handled encrypted failure successfully\"\n\n\nasync def test_activity_failure_with_encoded_payload_is_decoded_in_workflow(client: Client):\n    config = client.config()\n    config[\"data_converter\"] = dataclasses.replace(\n        temporalio.converter.default(), payload_codec=EncryptionCodec()\n    )\n    client = Client(**config)\n\n    async with new_worker(\n        client,\n        WorkflowWithFailingActivityAndCodec,\n        activities=[activity_that_fails_with_details],\n    ) as worker:\n        result = await client.execute_workflow(\n            WorkflowWithFailingActivityAndCodec.run,\n            id=f\"workflow-{uuid.uuid4()}\",\n            task_queue=worker.task_queue,\n            run_timeout=timedelta(seconds=5),\n        )\n        assert result == \"Handled encrypted failure successfully\"\n```\n\n### Environment/Versions\n\n- OS and processor: fails both on M1 Mac and Linux, docker and native.\n- Temporal Version: 2.31.2, python sdk 1.18.0, 1.18.1 and master\n\n### Additional context\n\nNo.","closedAt":"2025-10-27T17:22:20Z","comments":[],"createdAt":"2025-10-27T11:00:19Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1191,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Failures in activites are not decoded in workflow when custom codec is used","updatedAt":"2025-10-27T17:22:20Z","url":"https://github.com/temporalio/sdk-python/issues/1191"}
