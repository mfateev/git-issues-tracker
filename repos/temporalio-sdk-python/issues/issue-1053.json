{"assignees":[],"author":{"id":"MDQ6VXNlcjMyNzQ1MDU=","is_bot":false,"login":"SF-300","name":"Vladimir Lebedev"},"body":"Hello,\n\n### What are you really trying to do?\n\nI want to see proper OTEL metadata (spans and traces) propagated from the client invocation site all the way through workflows and activities, so I can visualize the full path in something like Datalust Seq.\n\n### Describe the bug\n\nPropagation works correctly for most workflow client operations, but fails for `execute_update_with_start_workflow` (and likely also for `start_update_with_start_workflow`).  \n\nFrom inspecting the SDK codebase, it looks like `start_update_with_start_workflow` was not included in\n[`_TracingClientOutboundInterceptor`](https://github.com/temporalio/sdk-python/blob/607641bf1e8250699b9c7ae0e87230d43b26c2ff/temporalio/contrib/opentelemetry.py#L219) after [this PR](https://github.com/temporalio/sdk-python/pull/702).  \nWhen I add it manually, propagation works as expected.\n\n**Expected:** OTEL trace and span context from the client are propagated through the workflow update handler and into an activity.  \n**Actual:** Trace and span context are missing inside the activity.\n\n### Minimal Reproduction\n```python\n# /// script\n# requires-python = \">=3.13\"\n# dependencies = [\n#     \"temporalio[opentelemetry]>=1.16.0\",\n# ]\n# ///\nimport asyncio\nfrom typing import Any\nfrom datetime import timedelta\n\nimport temporalio\nimport opentelemetry\nfrom temporalio import activity, workflow\nfrom temporalio.client import WithStartWorkflowOperation\nfrom temporalio.worker import Worker\nfrom temporalio.contrib.opentelemetry import TracingInterceptor, _TracingClientOutboundInterceptor\nfrom temporalio.common import WorkflowIDConflictPolicy\nfrom temporalio.testing import WorkflowEnvironment\n\nfrom opentelemetry import trace\nfrom opentelemetry.sdk.trace import TracerProvider\nfrom opentelemetry.sdk.trace.export import ConsoleSpanExporter, SimpleSpanProcessor\n\n\n# ---------- OpenTelemetry setup ----------\nprovider = TracerProvider()\nprovider.add_span_processor(SimpleSpanProcessor(ConsoleSpanExporter()))\ntrace.set_tracer_provider(provider)\ntracer = trace.get_tracer(__name__)\n\n\n@activity.defn\nasync def get_trace_id() -> int:\n    return trace.get_current_span().get_span_context().trace_id\n\n\n# ---------- Workflow ----------\n@workflow.defn\nclass DemoWorkflow:\n    @workflow.init\n    def __init__(self) -> None:\n        self._done = asyncio.Event()\n\n    @workflow.run\n    async def run(self) -> None:\n        await self._done.wait()\n\n    @workflow.update\n    async def read_trace_id_from_activity(self) -> int:\n        try:\n            return await workflow.execute_activity(\n                get_trace_id,\n                start_to_close_timeout=timedelta(seconds=5),\n            )\n        finally:\n            self._done.set()\n\n\nclass _PatchedTracingClientOutboundInterceptor(_TracingClientOutboundInterceptor):\n    async def start_update_with_start_workflow(\n        self, input: temporalio.client.StartWorkflowUpdateWithStartInput\n    ) -> temporalio.client.WorkflowUpdateHandle[Any]:\n        with self.root._start_as_current_span(\n            f\"StartUpdateWithStartWorkflow:{input.start_workflow_input.workflow}\",\n            attributes={\"temporalWorkflowID\": input.start_workflow_input.id},\n            input=input.start_workflow_input,\n            kind=opentelemetry.trace.SpanKind.CLIENT,\n        ):\n            return await super().start_update_with_start_workflow(input)\n\n\nclass _PatchedTracingInterceptor(TracingInterceptor):\n    def intercept_client(\n        self, next: temporalio.client.OutboundInterceptor\n    ) -> temporalio.client.OutboundInterceptor:\n        return _PatchedTracingClientOutboundInterceptor(next, self)\n\n\n# ---------- Main ----------\nasync def main():\n    async with await WorkflowEnvironment.start_local(\n        # !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n        interceptors=[_PatchedTracingInterceptor()],\n        # !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n        # interceptors=[TracingInterceptor()],\n        # !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!\n    ) as env:\n        queue_name = \"some-queue\"\n        async with Worker(\n            env.client,\n            task_queue=queue_name,\n            workflows=[DemoWorkflow],\n            activities=[get_trace_id],\n        ):\n            with tracer.start_as_current_span(\"invocation-site-span\") as span:\n                invocation_trace_id = span.get_span_context().trace_id\n                activity_trace_id = await env.client.execute_update_with_start_workflow(\n                    DemoWorkflow.read_trace_id_from_activity,\n                    start_workflow_operation=WithStartWorkflowOperation(\n                        DemoWorkflow.run,\n                        id=\"otel-update-workflow-id-2\",\n                        task_queue=queue_name,\n                        id_conflict_policy=WorkflowIDConflictPolicy.USE_EXISTING,\n                    ),\n                )\n                assert activity_trace_id == invocation_trace_id\n\n\nif __name__ == \"__main__\":\n    asyncio.run(main())\n```\n\n### Additional context\n\nI would kindly like someone more familiar with the codebase to sanity-check this assessment and my fix. If those are correct, I would gladly make a PR with the fix.","closedAt":"2025-10-16T19:41:38Z","comments":[{"id":"IC_kwDOGusT1c7Bu0F8","author":{"login":"tconley1428"},"authorAssociation":"MEMBER","body":"I agree, it wasn't updated to account for the new methods. We would be happy to accept a PR for this!","createdAt":"2025-09-03T18:15:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-python/issues/1053#issuecomment-3250274684","viewerDidAuthor":false}],"createdAt":"2025-08-26T11:28:28Z","labels":[{"id":"LA_kwDOGusT1c7gQgHK","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1053,"reactionGroups":[],"state":"CLOSED","title":"[Bug] OTEL metadata missing for execute_update_with_start_workflow ","updatedAt":"2025-10-16T19:41:38Z","url":"https://github.com/temporalio/sdk-python/issues/1053"}
