{"assignees":[],"author":{"id":"MDQ6VXNlcjEzMDMxNQ==","is_bot":false,"login":"laurynas","name":"Laurynas Butkus"},"body":"### What are you really trying to do?\n\nI have upgraded sdk-ruby from `v0.5.0` to `v0.6.0` and ran benchmark workflow locally in dev env. \n\n### Describe the bug\n\nBenchmark workflow consistently works fine with `v0.5.0`, but with `v0.6.0` it consistently gets stuck with error `[TMPRL1101] Potential deadlock detected: workflow didn't yield within 2.0 second(s).`.\n\n<img width=\"1241\" height=\"812\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/8b19570c-f45c-4694-bce6-1489cd4b4bb2\" />\n\n### Minimal Reproduction\n\n- Start worker\n- Start workflow\n- Wait\n- Get error\n\n### Environment/Versions\n\n- OS and processor: M3 MacBook\n- Temporal Version: 1.18\n- Temporal server running on Docker\n\n### Additional context\n\nWorkflow:\n\n```ruby\nclass Benchmarks::AsyncActivityTemporalioWorkflow < TemporalioWorkflow\n  def execute(iterations = 1000)\n    futures = iterations.times.map do |i|\n      Temporalio::Workflow::Future.new do\n        TemporalioExt::Activities.execute(HelloWorldActivityV2, \"Test #{i}\")\n      end\n    end\n\n    Temporalio::Workflow::Future.all_of(*futures).wait\n\n    true\n  end\nend\n```\n\nActivity:\n\n```ruby\nclass HelloWorldActivityV2 < TemporalioActivity\n  def execute(name)\n    \"Hello #{name}\"\n  end\nend\n```","closedAt":"2025-09-10T19:10:16Z","comments":[{"id":"IC_kwDOHI0NyM7A8LC0","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks for the replication! We will try to replicate and investigate.","createdAt":"2025-08-29T13:12:25Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-ruby/issues/330#issuecomment-3236999348","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM7A8wk6","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I am unable to replicate this on any version including 0.6.0. Here is a full standalone script:\n\n```ruby\n# frozen_string_literal: true\n\nrequire 'temporalio/activity'\nrequire 'temporalio/client'\nrequire 'temporalio/testing'\nrequire 'temporalio/worker'\nrequire 'temporalio/workflow'\n\nclass ManyActivitiesActivity < Temporalio::Activity::Definition\n  def execute(name)\n    \"Hello #{name}\"\n  end\nend\n\nclass ManyActivitiesWorkflow < Temporalio::Workflow::Definition\n  def execute(iterations = 1000)\n    futures = iterations.times.map do |i|\n      Temporalio::Workflow::Future.new do\n        Temporalio::Workflow.execute_activity(ManyActivitiesActivity, \"Test #{i}\", start_to_close_timeout: 30)\n      end\n    end\n\n    Temporalio::Workflow::Future.all_of(*futures).wait\n\n    'done'\n  end\nend\n\n# Run local, full Temporal server (same as `temporal server start-dev` from CLI)\nTemporalio::Testing::WorkflowEnvironment.start_local do |env|\n  # Run worker\n  Temporalio::Worker.new(\n    client: env.client,\n    task_queue: 'my-task-queue',\n    activities: [ManyActivitiesActivity],\n    workflows: [ManyActivitiesWorkflow]\n  ).run do\n    # Run workflow\n    result = env.client.execute_workflow(\n      ManyActivitiesWorkflow,\n      id: 'my-workflow',\n      task_queue: 'my-task-queue'\n    )\n    puts \"Workflow result: #{result}\"\n  end\nend\n```\n\nI wonder if your worker is otherwise overloaded or there is something else happening inside of `TemporalExt` not shown here. Is it possible to provide a fully-runnable standalone replication? Can alter the script I provided to demonstrate replication if needed.\n\nAlso, as a general note, you might consider batching activity work where you can. Calling 20 activities that each do 50 things is often more reasonable than 1000 activities doing 1 thing, though the latter may make sense if needing independent retryability (but note there are maximum activity limits per workflow).","createdAt":"2025-08-29T14:04:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-ruby/issues/330#issuecomment-3237153082","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM7A85a8","author":{"login":"laurynas"},"authorAssociation":"NONE","body":"Hey @cretz, thanks for the tips. It was just my experiment checking activity performance. It is strange that there is a difference between v0.5.0 and v0.6.0, maybe related with this change (I didn't check): \nhttps://github.com/temporalio/sdk-ruby/pull/309\n\nI'll try to experiment more, maybe with plain ruby, without any TemporalioExt helpers for clarity (though they just set some defaults to reduce boilerplate).\n\nI'll post the results once I have something.","createdAt":"2025-08-29T14:15:27Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-ruby/issues/330#issuecomment-3237189308","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM7A-qu0","author":{"login":"laurynas"},"authorAssociation":"NONE","body":"Hi again! I have created plain ruby example to run on docker:\nhttps://github.com/laurynas/temporalio-ruby-sdk-experiments\n\nWrote short instructions how to run it in the README file.\n\nWith this example I can reproduce the issue quite consistently on my MacBook M3 Pro.\n\nv0.5.0 works fine with the same workflow.","createdAt":"2025-08-29T16:52:54Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-ruby/issues/330#issuecomment-3237653428","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM7A_4aD","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks! I think I was able to replicate just by changing my script to use child workflows as you did in your repo there. We are investigating...","createdAt":"2025-08-29T19:15:37Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-ruby/issues/330#issuecomment-3237971587","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM7BA7hU","author":{"login":"laurynas"},"authorAssociation":"NONE","body":"I ran my docker experiment on much slower Dell Latitude 7290 with Ubuntu 24.04 and I couldn't reproduce the issue. The workflow runs slowly, but no deadlocks.","createdAt":"2025-08-29T20:51:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-ruby/issues/330#issuecomment-3238246484","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM7BeHGs","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"After investigation, this is a case where, with the illegal call tracer on, it actually does take over 2s to process things. There is also a bug preventing the disabling of the call tracer we will fix. The only current workaround for this is to set `debug_mode: true` when creating the worker that disables deadlock detector (and therefore allows CPU-bound work to take longer than 2s).\n\nWe are investigating more permanent fixes here including reducing the scope of the illegal call tracer. I will update when we have more info.","createdAt":"2025-09-02T15:48:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-ruby/issues/330#issuecomment-3245896108","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM7BhMJj","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Added a PR that will hopefully reduce the call tracing scope down enough to not cause issues here: #332. If you'd like to test it, can rebuild the SDK (see bottom of README) on that branch. EDIT: Though make sure it is in \"ready for review\". We may have to turn it to a draft while we debug some garbage collector issues.","createdAt":"2025-09-02T20:31:55Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-ruby/issues/330#issuecomment-3246703203","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM7DRtBR","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"This should be now solved with #332. Basically, we just run less validation things so as not to slow down enough to hit this deadlock detection.","createdAt":"2025-09-10T19:10:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-ruby/issues/330#issuecomment-3276197969","viewerDidAuthor":false}],"createdAt":"2025-08-29T08:30:35Z","labels":[{"id":"LA_kwDOHI0NyM7vFHIE","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":330,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"[Bug] Potential deadlock detected after upgrade to v0.6.0","updatedAt":"2025-09-10T19:10:16Z","url":"https://github.com/temporalio/sdk-ruby/issues/330"}
