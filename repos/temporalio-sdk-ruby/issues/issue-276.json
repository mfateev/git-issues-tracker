{"assignees":[],"author":{"id":"MDQ6VXNlcjYzNTEyMQ==","is_bot":false,"login":"dimroc","name":"Dimitri Roche"},"body":"### What are you really trying to do?\n\nI am trying to test a workflow that spins up one child workflow inside a future.\n\n### Describe the bug\n\n1. Without a child workflow, the following code returns a `result` one can assert against.\n2. With a child workflow, the following code has `result` nil, even if you try to wait for workflow handle. This happens often, but not all the time, implying a race condition?\n\nHowever, in both scenarios, it's very evident that all workflows, child workflows, and activities are running. \n\n```ruby\n      Temporalio::Testing::WorkflowEnvironment.start_time_skipping do |env|\n        worker = Temporalio::Worker.new(\n          client: env.client,\n          task_queue: \"tq-#{SecureRandom.uuid}\",\n          workflows: [\n            AnalyzerUploadWorkflow,\n            AnalyzerDocumentCreationWorkflow # Child workflow\n          ],\n          activities: [\n            AnalyzerUploadActivities::BestPdfSplit,\n            PdfImageActivities::Ingestion,\n            AnalyzerDocument::CreationActivity\n          ]\n        )\n\n        result = worker.run do\n          env.client.execute_workflow(\n            AnalyzerUploadWorkflow,\n            analyzer_upload.id,\n            id: workflow_id,\n            task_queue: worker.task_queue\n          )\n        end\n\n        expect(result).to be_present # <--- fails if AnalyzerUploadWorkflow is refactored to have child workflow\n      end\n\n```\n\n\n### Minimal Reproduction\n\nTBD\n\n### Environment/Versions\n\n<!-- Please complete the following information where relevant. -->\n\n- OS and processor: M3 MacBook\n- Temporal Version: Ruby SDK 0.4\n- Are you using Docker or Kubernetes or building Temporal from source? Temporal test suite\n","closedAt":"2025-06-02T16:28:51Z","comments":[{"id":"IC_kwDOHI0NyM6uEipO","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Can you provide a full standalone replication that includes the workflows? Feel free to make it as small as necessary to show that a workflow with a child workflow is not returning the value you expect. Also, can you confirm this same behavior exists with `start_local` instead of `start_time_skipping` (just to confirm this is not something specific to the time-skipping test server which could have an issue with child workflows in this case somehow)?","createdAt":"2025-05-29T19:53:15Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-ruby/issues/276#issuecomment-2920426062","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM6uux4U","author":{"login":"dimroc"},"authorAssociation":"NONE","body":"I'm unable to reproduce this with a minimal example so I'll close for now.","createdAt":"2025-06-02T16:28:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-ruby/issues/276#issuecomment-2931498516","viewerDidAuthor":false}],"createdAt":"2025-05-29T17:45:36Z","labels":[{"id":"LA_kwDOHI0NyM7vFHIE","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":276,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Test env does not return result of workflow with child workflow","updatedAt":"2025-06-02T16:28:52Z","url":"https://github.com/temporalio/sdk-ruby/issues/276"}
