{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"### Describe the bug\r\n\r\nCurrently fiber-based workers hang in Ruby 3.1/3.2 but work in Ruby 3.3+. Initial investigation is showing that pushing to a `Queue` from a separate thread may not be waking up a fiber. As a (temporary?) workaround, we are only allowing Fiber-based workers in Ruby 3.3+.","closedAt":null,"comments":[{"id":"IC_kwDOHI0NyM6PFCjP","author":{"login":"bdchauvette"},"authorAssociation":"NONE","body":"You might've already looked into this, but any chance this is related to the introduction of M:N scheduling in 3.3? ðŸ¤”\r\n\r\nhttps://bugs.ruby-lang.org/issues/19842","createdAt":"2024-10-08T17:42:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-ruby/issues/162#issuecomment-2400463055","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM6PFM3J","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I do suspect it is related to that. Basically what we are finding pre-3.3 is that in some cases when we have one Ruby thread that pushes to a queue, a fiber that is waiting on queue pop is not woken up. Due to how we need to use Rust, we need to be able to wake up fibers from another thread and queues were the logical way to do it. Note, this does not happen all the time. In many cases a queue push from another thread does resume a fiber waiting on queue pop.\r\n\r\nMaybe it's something we are just not doing right, or maybe there's some other way to wake up a fiber from another thread. We may end up reworking our callback logic to not use queue from other thread, but instead do a `captured_fiber_scheduler.fiber { queue.push }` hoping that will fix it.\r\n\r\nThis is causing our fiber-based tests to not work in < 3.3. We need to do a lot more investigating here, but for now so we could get the activity worker PR out, we created this separate issue.","createdAt":"2024-10-08T18:06:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-ruby/issues/162#issuecomment-2400505289","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM6PFQlz","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"The other obvious question becomes, how important is pre-3.3 fiber support? 3.1 will be EOL'd in the spring and 3.2 a year after that. And of course threads work across all versions. It just becomes a question of how much work to investigate/solve vs benefit.","createdAt":"2024-10-08T18:14:34Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-ruby/issues/162#issuecomment-2400520563","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM6PWPt5","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"> The other obvious question becomes, how important is pre-3.3 fiber support? ... It just becomes a question of how much work to investigate/solve vs benefit.\r\n\r\nAgree, that would be a reasonable compromise.\r\n\r\nOnly thing: are you sure this issue is purely a \"fiber on pre-3.3\" thing, and not hiding something bigger that could haunt us later? It might be worth investigating just a little bit more to confirm your initial suspicion before dismissing.","createdAt":"2024-10-10T12:36:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-ruby/issues/162#issuecomment-2404973433","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM6PYBD7","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> are you sure this issue is purely a \"fiber on pre-3.3\" thing, and not hiding something bigger that could haunt us later? It might be worth investigating just a little bit more to confirm your initial suspicion before dismissing.\r\n\r\nI am not sure because I don't know the exact cause. I agree would like to investigate (or delegate the investigation). I did basic investigation showing literally as I used `asdf` to switch Ruby versions, a test was not working in 3.1/3.2 and was in 3.3, and tracked it down to a `queue.pop` in a fiber not waking up to a `queue.push` from another thread (a Ruby thread, but from Rust code). But I could not replicate with a trivial thread.new + queue.push and fiber.schedule + queue.pop, hence the opening of this ticket for investigating more deeply.","createdAt":"2024-10-10T15:27:59Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-ruby/issues/162#issuecomment-2405437691","viewerDidAuthor":false}],"createdAt":"2024-10-07T14:08:31Z","labels":[{"id":"LA_kwDOHI0NyM7vFHIE","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":162,"reactionGroups":[],"state":"OPEN","title":"Investigate issue with Ruby 3.1/3.2 and worker fibers","updatedAt":"2024-10-10T15:30:09Z","url":"https://github.com/temporalio/sdk-ruby/issues/162"}
