{"assignees":[],"author":{"id":"MDQ6VXNlcjU3MDc1NQ==","is_bot":false,"login":"NielsKSchjoedt","name":"Niels Kristian Schjødt"},"body":"# Problem: Testing Temporal Workflows with Signals in Ruby SDK Time-Skipping Environment\n\n## Context\nI'm testing a workflow in the Temporalio Ruby SDK that uses `wait_condition` to wait for signals. The workflow works correctly in production, but I cannot test the signal-driven continuation in the time-skipping test environment (`Temporalio::Testing::WorkflowEnvironment.start_time_skipping`).\n\n## Workflow Pattern (Simplified)\n```ruby\nclass PipelineExecutionWorkflow < Temporalio::Workflow\n  workflow_signal\n  def customer_replied\n    @customer_replied = true\n  end\n\n  def execute(opportunity_id, pipeline_id)\n    # Step 1: Send initial email\n    send_email_activity(opportunity_id)\n    \n    # Step 2: Wait for customer reply signal\n    Temporalio::Workflow.timeout(48.hours) do\n      Temporalio::Workflow.wait_condition { @customer_replied }\n    end\n    \n    # Step 3: Process customer reply (extract data, send AI response)\n    if @customer_replied\n      extract_and_respond(opportunity_id)\n    end\n    \n    { \"success\" => true }\n  end\nend\n```\n\n## What I've Tried in Tests\n\n```ruby\nTemporalio::Testing::WorkflowEnvironment.start_time_skipping do |env|\n  worker = Temporalio::Worker.new(\n    client: env.client,\n    task_queue: \"test-queue\",\n    workflows: [PipelineExecutionWorkflow],\n    activities: [SendEmailActivity, ExtractActivity]\n  )\n  \n  worker.run do\n    # Start workflow (doesn't wait for completion)\n    workflow_handle = env.client.start_workflow(\n      PipelineExecutionWorkflow,\n      opportunity_id,\n      pipeline_id,\n      id: \"test-pipeline-#{opportunity_id}\",\n      task_queue: \"test-queue\"\n    )\n    \n    # Give time for initial email to be sent\n    sleep 0.5\n    \n    # Check workflow state - shows it's waiting\n    state = workflow_handle.query(\"get_state\")\n    # => {\"waiting_for_signal\" => true, \"customer_replied\" => false}\n    \n    # Send the signal\n    workflow_handle.signal(\"customer_replied\")\n    \n    # Check state again - signal was received!\n    state_after = workflow_handle.query(\"get_state\")\n    # => {\"waiting_for_signal\" => false, \"customer_replied\" => true}\n    \n    # But when I try to get the result, it times out or returns nil\n    result = workflow_handle.result  # ← TIMES OUT or returns nil\n    # The workflow doesn't continue executing after receiving the signal\n  end\nend\n```\n\n## Observed Behavior\n1. ✅ Workflow starts successfully\n2. ✅ Initial email activity executes\n3. ✅ Workflow enters wait state (`wait_condition`)\n4. ✅ Signal is received (verified via query - `@customer_replied` becomes `true`)\n5. ❌ **Workflow doesn't continue execution** after signal received\n6. ❌ `workflow_handle.result` times out or workflow appears \"stuck\"\n\n## Questions\n\n**With the Temporal Ruby SDK source code available:**\n\n1. **Is this a known limitation** of the time-skipping test environment with `wait_condition` and signals?\n\n2. **What is the correct way** to test workflows that use `wait_condition` with signals in the time-skipping environment?\n\n3. **Should I use a different testing approach** for signal-driven workflows? (e.g., real Temporal server, different test helper methods)\n\n4. **Is there a way to manually advance time** or \"wake up\" the workflow after sending a signal in the test environment?\n\n5. **Are there any special considerations** or setup required for testing signal-driven workflows that use `wait_condition`?\n\n## Additional Context\n- Ruby SDK version: 1.0.0 (from Gemfile)\n- The workflow works perfectly in production with real Temporal server\n- Synchronous workflows (without signals/wait) test fine in time-skipping environment\n- I've tried both `start_workflow` (non-blocking) and `execute_workflow` (blocking) - neither works for the signal continuation\n","closedAt":null,"comments":[{"id":"IC_kwDOHI0NyM7RWMyg","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Mentioned at https://github.com/temporalio/sdk-ruby?tab=readme-ov-file#workflow-testing (though maybe not clearly enough), the automatic time-skipping doesn't kick in until you wait for the workflow result. So the workflow does not progress automatically until you wait for the result (and no activities are running). But you can make it progress manually by calling `sleep` on the environment.\n\n> I've tried both start_workflow (non-blocking) and execute_workflow (blocking) - neither works for the signal continuation\n\nI'd be curious to see what this looks like as the latter should progress automatically assuming the activity runs as expected (i.e. one with its name is registered). Usually you'd have to run `execute_workflow` in a background thread and you wouldn't get the handle to even make those signal calls on (so if the activity is registered, a 48h timeout would occur immediately based on the code).\n\n(also feel free to join us on `#ruby-sdk` channel on [Slack](https://t.mp/slack) if easier to chat about time-skipping test environments and other Ruby things)","createdAt":"2025-11-10T15:06:19Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-ruby/issues/360#issuecomment-3512257696","viewerDidAuthor":false}],"createdAt":"2025-11-09T22:46:12Z","labels":[{"id":"LA_kwDOHI0NyM7vFHIK","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":360,"reactionGroups":[],"state":"OPEN","title":"Problem: Testing Temporal Workflows with Signals in Ruby SDK Time-Skipping Environment","updatedAt":"2025-11-10T15:08:13Z","url":"https://github.com/temporalio/sdk-ruby/issues/360"}
