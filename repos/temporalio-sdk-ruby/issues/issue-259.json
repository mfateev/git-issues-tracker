{"assignees":[],"author":{"id":"U_kgDOCYZQvA","is_bot":false,"login":"igillis-clara","name":"Ian Gillis"},"body":"### What are you really trying to do?\n\nI'm trying to write a test for this (simplified) workflow\n\n```\n  def execute(input)\n    @start_date = Date.parse(input.start_date_str)\n\n    execute_activity(...)\n\n    update_status :not_started\n\n    sleep_until next_week_at(\"wednesday\", \"8:00\")\n\n    update_status :complete\n  end\n\n  workflow_update\n  def edited\n    update_status :in_progress if @status == :not_started\n  end\n\n```\nSpecifically, I want to:\n- Disable auto time skipping to test that the `update` sets the status to `in_progress` correctly\n- Resume auto time skipping and verify that the workflow result is the expected value\n\n### Describe the bug\n\nI have a test like:\n\n```\n    Temporalio::Workflow.stub :now, Time.new(2025, 4, 16) do\n      Temporalio::Testing::WorkflowEnvironment.start_time_skipping(logger: Rails.logger) do |env|\n        with_worker(env) do |worker|\n          handle = env.client.start_workflow(...)\n          env.auto_time_skipping_disabled do\n            until (timesheet = Timesheet.find_by(placement:, starts_on:))\n              sleep(0.5)\n            end\n\n            assert_equal handle.query(:status), \"not_started\"\n\n            handle.update(:edited)\n\n            assert_equal handle.query(:status), \"in_progress\"\n          end\n          # Times out before reaching here\n          assert_equal handle.result, \"complete\"\n        end\n      end\n    end\n\n```\n\n### Minimal Reproduction\n\nCode samples above. Will write a test in the PR.\n\n### Environment/Versions\n\n- Ruby SDK version `0.4.0`\n- Apple M2 Max running Sequoia 15.4.1\n- Temporal cloud\n- Minitest\n\n### Additional context\n\nI believe the initialization of  `already_disabled` in `auto_time_skipping_disabled` is the problem. Just need to negate it.\n","closedAt":"2025-05-02T21:13:21Z","comments":[{"id":"IC_kwDOHI0NyM6pwp5D","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks for the PR! LGTM","createdAt":"2025-05-02T20:54:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-ruby/issues/259#issuecomment-2848104003","viewerDidAuthor":false}],"createdAt":"2025-05-02T19:19:01Z","labels":[{"id":"LA_kwDOHI0NyM7vFHIE","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":259,"reactionGroups":[],"state":"CLOSED","title":"[Bug] auto_time_skipping_disabled not resuming after block exit","updatedAt":"2025-05-02T21:13:21Z","url":"https://github.com/temporalio/sdk-ruby/issues/259"}
