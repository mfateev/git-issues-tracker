{"assignees":[],"author":{"id":"MDQ6VXNlcjI5MTI5","is_bot":false,"login":"schoblaska","name":"Joseph Schoblaska"},"body":"### What are you really trying to do?\n\nI'm running Temporal alongside a Rails application, starting the Temporal worker with a Rails runner script like in the [example](https://github.com/temporalio/samples-ruby/tree/main/rails_app).\n\n### Describe the bug\n\nWorkflows are failing on exceptions bubbling up from `ScopedLogger` on this line:\n\nhttps://github.com/temporalio/sdk-ruby/blob/21a3f312d23692bf1737556d113ccfb9df128b64/temporalio/lib/temporalio/scoped_logger.rb#L20\n\nWhen I inspect those values, `severity` is 2, `Logger::Unknown` is undefined (should be `Logger::UNKNOWN`?), and `level` is `:debug`.\n\n```\ncomparison of Integer with :debug failed\n\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/scoped_logger.rb:20:in 'Integer#<'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/scoped_logger.rb:20:in 'Temporalio::ScopedLogger#add'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/internal/worker/workflow_instance/replay_safe_logger.rb:31:in 'block in Temporalio::Internal::Worker::WorkflowInstance::ReplaySafeLogger#add'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/internal/worker/workflow_instance/illegal_call_tracer.rb:134:in 'block in Temporalio::Internal::Worker::WorkflowInstance::IllegalCallTracer#disable'\n<internal:trace_point>:297:in 'TracePoint#disable'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/internal/worker/workflow_instance/illegal_call_tracer.rb:133:in 'Temporalio::Internal::Worker::WorkflowInstance::IllegalCallTracer#disable'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/internal/worker/workflow_instance.rb:197:in 'Temporalio::Internal::Worker::WorkflowInstance#illegal_call_tracing_disabled'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/internal/worker/workflow_instance/replay_safe_logger.rb:31:in 'Temporalio::Internal::Worker::WorkflowInstance::ReplaySafeLogger#add'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/scoped_logger.rb:57:in 'Temporalio::ScopedLogger#warn'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/internal/worker/workflow_instance.rb:289:in 'block in Temporalio::Internal::Worker::WorkflowInstance#activate_internal'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/internal/worker/workflow_instance/replay_safe_logger.rb:20:in 'Temporalio::Internal::Worker::WorkflowInstance::ReplaySafeLogger#replay_safety_disabled'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/internal/worker/workflow_instance.rb:288:in 'Temporalio::Internal::Worker::WorkflowInstance#activate_internal'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/internal/worker/workflow_instance.rb:166:in 'block in Temporalio::Internal::Worker::WorkflowInstance#activate'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/internal/worker/workflow_instance/illegal_call_tracer.rb:125:in 'block in Temporalio::Internal::Worker::WorkflowInstance::IllegalCallTracer#enable'\n<internal:trace_point>:261:in 'TracePoint#enable'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/internal/worker/workflow_instance/illegal_call_tracer.rb:124:in 'Temporalio::Internal::Worker::WorkflowInstance::IllegalCallTracer#enable'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/internal/worker/workflow_instance.rb:236:in 'Temporalio::Internal::Worker::WorkflowInstance#run_in_scheduler'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/internal/worker/workflow_instance.rb:166:in 'Temporalio::Internal::Worker::WorkflowInstance#activate'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/worker/workflow_executor/thread_pool.rb:163:in 'block in Temporalio::Worker::WorkflowExecutor::ThreadPool::Worker#activate'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/timeout-0.4.3/lib/timeout.rb:185:in 'block in Timeout.timeout'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/timeout-0.4.3/lib/timeout.rb:192:in 'Timeout.timeout'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/worker/workflow_executor/thread_pool.rb:149:in 'Temporalio::Worker::WorkflowExecutor::ThreadPool::Worker#activate'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/worker/workflow_executor/thread_pool.rb:124:in 'block in Temporalio::Worker::WorkflowExecutor::ThreadPool::Worker#run'\n<internal:kernel>:168:in 'Kernel#loop'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/worker/workflow_executor/thread_pool.rb:115:in 'Temporalio::Worker::WorkflowExecutor::ThreadPool::Worker#run'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/worker/workflow_executor/thread_pool.rb:99:in 'block in Temporalio::Worker::WorkflowExecutor::ThreadPool::Worker#initialize'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/worker/thread_pool.rb:200:in 'block (3 levels) in Temporalio::Worker::ThreadPool::Worker#initialize'\n<internal:kernel>:168:in 'Kernel#loop'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/worker/thread_pool.rb:193:in 'block (2 levels) in Temporalio::Worker::ThreadPool::Worker#initialize'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/worker/thread_pool.rb:192:in 'Kernel#catch'\n/Users/joseph/.rvm/gems/ruby-3.4.2/gems/temporalio-0.5.0-arm64-darwin/lib/temporalio/worker/thread_pool.rb:192:in 'block in Temporalio::Worker::ThreadPool::Worker#initialize'\n```\n\n### Environment/Versions\n\n- OS and processor: M1 Mac\n- Using the `temporalio/auto-setup:latest` Docker image","closedAt":null,"comments":[{"id":"IC_kwDOHI0NyM6-D7-M","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Interesting. Per https://github.com/ruby/rbs/blob/607dc0573276048ba41f07fe160df102898fe717/stdlib/logger/0/logger.rbs#L609, `level` is supposed to be an integer not a symbol. Even Ruby itself does integer comparison operators against `level` e.g. https://github.com/ruby/logger/blob/9239e197f39df4cb11652808bdfd1624f824a3a3/lib/logger.rb#L482.\n\nSo I wonder if `Rails.logger.level` is a symbol. `Rails.logger` is an `ActiveSupport::Logger` which extends `::Logger` which means it should only have `level` returning an integer. So does `Rails.logger.level > 2` fail? Does `Rails.logger.debug?` fail? We will have to investigate (and/or feel free to do some deep diving here yourself).","createdAt":"2025-08-14T14:39:36Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-ruby/issues/315#issuecomment-3188703116","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM6-FTBr","author":{"login":"schoblaska"},"authorAssociation":"CONTRIBUTOR","body":"I did a little digging and realized that I'm using [rails_semantic_logger](https://github.com/reidmorrison/rails_semantic_logger) in this project, which uses symbols for log levels, which can result in [compatibility issues](https://github.com/rails/rails/commit/e01d1e25dd6e03233effff524a9e2bf03e3f4869).\n\n```\n3.4.2 :001 > Rails.logger\n => #<SemanticLogger::Logger:0x000000011611bf90 @filter=nil, @level=nil, @level_index=nil, @name=\"Rails\">\n\n3.4.2 :002 > Rails.logger.level\n => :debug\n```\n\nOn a Rails project using the default logger:\n\n```\n3.3.5 :001 > Rails.logger\n =>\n#<ActiveSupport::BroadcastLogger:0x00000001683e64f8\n @broadcasts=\n  [#<ActiveSupport::Logger:0x000000016ea37b30\n    @default_formatter=#<Logger::Formatter:0x00000001683ee108 @datetime_format=nil>,\n    @formatter=#<ActiveSupport::Logger::SimpleFormatter:0x00000001683e6d18 @datetime_format=nil>,\n    @level=0,\n    @level_override={},\n    @local_level_key=:logger_thread_safe_level_41180,\n    @logdev=\n     #<Logger::LogDevice:0x000000016f6db9b8\n      @binmode=false,\n      @dev=#<File:/Users/joseph/projects/web_app/log/development.log>,\n      @filename=\"/Users/joseph/projects/web_app/log/development.log\",\n      @mon_data=#<Monitor:0x00000001683ee040>,\n      @mon_data_owner_object_id=21640,\n      @reraise_write_errors=[],\n      @shift_age=1,\n      @shift_period_suffix=\"%Y%m%d\",\n      @shift_size=104857600,\n      @skip_header=false>,\n    @progname=nil>,\n   #<ActiveSupport::Logger:0x000000010f470d78\n    @default_formatter=#<Logger::Formatter:0x000000016e8571d0 @datetime_format=nil>,\n    @formatter=#<ActiveSupport::Logger::SimpleFormatter:0x000000016e856c58 @datetime_format=nil>,\n    @level=0,\n    @level_override={},\n    @logdev=#<Logger::LogDevice:0x000000031063b740 @binmode=false, @dev=#<IO:<STDERR>>, @filename=nil, @mon_data=#<Monitor:0x000000016e856d70>, @mon_data_owner_object_id=41160, @reraise_write_errors=[], @shift_age=nil, @shift_period_suffix=nil, @shift_size=nil, @skip_header=false>,\n    @progname=nil>],\n @formatter=#<ActiveSupport::Logger::SimpleFormatter:0x00000001683e6d18 @datetime_format=nil>,\n @progname=\"Broadcast\">\n\n3.3.5 :002 > Rails.logger.level\n => 0\n```\n\nPersonally, I don't need the semantic logger anymore (I believe I initially switched to it because of a telemetry library I was using) so I'll probably just switch back to the default.","createdAt":"2025-08-14T16:22:05Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-ruby/issues/315#issuecomment-3189059691","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM6-F6ST","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":":+1: FWIW, I personally disagree with the first sentence of https://github.com/rails/rails/pull/49563 that states\n\n> Numeric values for Logger#level is an implementation detail\n\nAnd https://github.com/reidmorrison/semantic_logger/issues/28 and others here. The integer is set [in RBS](https://github.com/ruby/rbs/blob/607dc0573276048ba41f07fe160df102898fe717/stdlib/logger/0/logger.rbs#L609), [in Sorbet](https://github.com/sorbet/sorbet/blob/a8d95f61dc809cd0eb26d712bc537cbf60ff21be/rbi/stdlib/logger.rbi#L304), and is clearly referred to as an integer in the base `Logger` class multiple times, which any extension/wrapper/delegator relies on.\n\nHowever, I'll update the title of this issue and if other users complain about semantic_logger issues here, we can try to adjust our wrapper to be semantic_logger friendly.","createdAt":"2025-08-14T17:08:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-ruby/issues/315#issuecomment-3189220499","viewerDidAuthor":false},{"id":"IC_kwDOHI0NyM6-GOTB","author":{"login":"schoblaska"},"authorAssociation":"CONTRIBUTOR","body":"Sounds good! Thanks for looking into this. I opened a PR for the `Logger::Unknown` issue: https://github.com/temporalio/sdk-ruby/pull/316","createdAt":"2025-08-14T17:30:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-ruby/issues/315#issuecomment-3189302465","viewerDidAuthor":false}],"createdAt":"2025-08-14T13:50:38Z","labels":[{"id":"LA_kwDOHI0NyM7vFHIE","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":315,"reactionGroups":[],"state":"OPEN","title":"[Bug] ScopedLogger fails attempting to compare symbol to integer for libraries like semantic_logger","updatedAt":"2025-08-14T17:30:54Z","url":"https://github.com/temporalio/sdk-ruby/issues/315"}
