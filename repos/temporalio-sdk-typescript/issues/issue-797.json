{"assignees":[],"author":{"id":"MDQ6VXNlcjE5MDA4NzY=","is_bot":false,"login":"jhecking","name":"Jan Hecking"},"body":"### What are you really trying to do?\r\n\r\nI'm trying to send a signal to a workflow that might, or might not yet, exist using the client's signalWithStart function. The workflow maintains a list of subscribers and the signal is intended to add a new subscriber to the list.\r\n\r\n### Describe the bug\r\n\r\nWhen the workflow does not yet exist, and gets started through the client's signalWithStart function, the workflow worker crashes with a fatal Node.js error:\r\n\r\n```\r\n$ ts-node test/broker\r\n2022-07-31T13:12:46.918Z [INFO] asset main.js 230 KiB [emitted] (name: main) 1 related asset\r\n2022-07-31T13:12:46.919Z [INFO] runtime modules 937 bytes 4 modules\r\n2022-07-31T13:12:46.919Z [INFO] modules by path ./node_modules/@temporalio/ 158 KiB\r\n2022-07-31T13:12:46.919Z [INFO]   modules by path ./node_modules/@temporalio/workflow/lib/*.js 93.1 KiB 11 modules\r\n2022-07-31T13:12:46.920Z [INFO]   modules by path ./node_modules/@temporalio/common/lib/ 48.1 KiB 10 modules\r\n2022-07-31T13:12:46.920Z [INFO]   modules by path ./node_modules/@temporalio/internal-workflow-common/lib/*.js 14.4 KiB\r\n2022-07-31T13:12:46.920Z [INFO]     ./node_modules/@temporalio/internal-workflow-common/lib/index.js 1.3 KiB [built] [code generated]\r\n2022-07-31T13:12:46.920Z [INFO]     + 9 modules\r\n2022-07-31T13:12:46.920Z [INFO]   ./node_modules/@temporalio/worker/lib/workflow-log-interceptor.js 2.25 KiB [built] [code generated]\r\n2022-07-31T13:12:46.920Z [INFO] modules by path ./src/broker/ 1.79 KiB\r\n2022-07-31T13:12:46.920Z [INFO]   ./src/broker/workflows-entrypoint-61e328ef909dd85f.js 561 bytes [built] [code generated]\r\n2022-07-31T13:12:46.920Z [INFO]   ./src/broker/workflows.ts 1.24 KiB [built] [code generated]\r\n2022-07-31T13:12:46.920Z [INFO] __temporal_custom_payload_converter (ignored) 15 bytes [built] [code generated]\r\n2022-07-31T13:12:46.920Z [INFO] ./node_modules/long/umd/index.js 43.1 KiB [built] [code generated]\r\n2022-07-31T13:12:46.920Z [INFO] ./node_modules/ms/index.js 2.95 KiB [built] [code generated]\r\n2022-07-31T13:12:46.920Z [INFO] webpack 5.74.0 compiled successfully in 684 ms\r\n2022-07-31T13:12:46.922Z [INFO] Workflow bundle created { size: '0.22MB' }\r\n2022-07-31T13:12:47.111Z [INFO] Worker state changed { state: 'RUNNING' }\r\n[topic(ps:hello)] Creating new topic ps:hello\r\n\r\n\r\n#\r\n# Fatal error in , line 0\r\n# Check failed: !holder_map.has_named_interceptor().\r\n#\r\n#\r\n#\r\n#FailureMessage Object: 0x70001207a690\r\n 1: 0x10cf1c312 node::NodePlatform::GetStackTracePrinter()::$_3::__invoke() [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n 2: 0x10def1722 V8_Fatal(char const*, ...) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n 3: 0x10d42ed14 v8::internal::ConcurrentLookupIterator::TryGetPropertyCell(v8::internal::Isolate*, v8::internal::LocalIsolate*, v8::internal::Handle<v8::internal::JSGlobalObject>, v8::internal::Handle<v8::internal::Name>) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n 4: 0x10dfe8967 v8::internal::compiler::(anonymous namespace)::GetPropertyCellFromHeap(v8::internal::compiler::JSHeapBroker*, v8::internal::Handle<v8::internal::Name>) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n 5: 0x10e00b0e2 v8::internal::compiler::JSGlobalObjectRef::GetPropertyCell(v8::internal::compiler::NameRef const&, v8::internal::compiler::SerializationPolicy) const [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n 6: 0x10e07d15e v8::internal::compiler::JSNativeContextSpecialization::ReduceNamedAccess(v8::internal::compiler::Node*, v8::internal::compiler::Node*, v8::internal::compiler::NamedAccessFeedback const&, v8::internal::compiler::AccessMode, v8::internal::compiler::Node*) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n 7: 0x10e079637 v8::internal::compiler::JSNativeContextSpecialization::ReduceJSLoadNamed(v8::internal::compiler::Node*) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n 8: 0x10dfd554a v8::internal::compiler::Reducer::Reduce(v8::internal::compiler::Node*, v8::internal::compiler::ObserveNodeManager*) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n 9: 0x10e1095cd v8::internal::compiler::(anonymous namespace)::SourcePositionWrapper::Reduce(v8::internal::compiler::Node*) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n10: 0x10dfd649d v8::internal::compiler::GraphReducer::Reduce(v8::internal::compiler::Node*) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n11: 0x10dfd5ee0 v8::internal::compiler::GraphReducer::ReduceTop() [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n12: 0x10dfd5b38 v8::internal::compiler::GraphReducer::ReduceNode(v8::internal::compiler::Node*) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n13: 0x10e109334 v8::internal::compiler::InliningPhase::Run(v8::internal::compiler::PipelineData*, v8::internal::Zone*) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n14: 0x10e0fc0ab void v8::internal::compiler::PipelineImpl::Run<v8::internal::compiler::InliningPhase>() [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n15: 0x10e0f89be v8::internal::compiler::PipelineImpl::CreateGraph() [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n16: 0x10e0f8323 v8::internal::compiler::PipelineCompilationJob::PrepareJobImpl(v8::internal::Isolate*) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n17: 0x10d0e24b6 v8::internal::OptimizedCompilationJob::PrepareJob(v8::internal::Isolate*) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n18: 0x10d0e79ca v8::internal::(anonymous namespace)::GetOptimizedCode(v8::internal::Isolate*, v8::internal::Handle<v8::internal::JSFunction>, v8::internal::ConcurrencyMode, v8::internal::CodeKind, v8::internal::BytecodeOffset, v8::internal::JavaScriptFrame*, v8::internal::(anonymous namespace)::GetOptimizedCodeResultHandling) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n19: 0x10d0e8cb6 v8::internal::Compiler::CompileOptimized(v8::internal::Isolate*, v8::internal::Handle<v8::internal::JSFunction>, v8::internal::ConcurrencyMode, v8::internal::CodeKind) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n20: 0x10d56b903 v8::internal::Runtime_CompileOptimized_Concurrent(int, unsigned long*, v8::internal::Isolate*) [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\n21: 0x10d913319 Builtins_CEntry_Return1_DontSaveFPRegs_ArgvOnStack_NoBuiltinExit [/Users/jhecking/.nvm/versions/node/v16.9.0/bin/node]\r\nerror Command failed with signal \"SIGTRAP\".\r\ninfo Visit https://yarnpkg.com/en/docs/cli/run for documentation about this command.\r\n```\r\n\r\n### Minimal Reproduction\r\n\r\nThe issue can be reproduced using the code at https://github.com/Securezapp/temporal-pubsub.\r\n\r\nThe relevant parts are in `src/broker/workflow.ts`:\r\n\r\n```typescript\r\nexport type SubscribeInput = [string]\r\nconst subscribeSignal = defineSignal<SubscribeInput>('subscribe')\r\n\r\nexport async function topic (): Promise<void> {\r\n  const topicName = workflowInfo().workflowId\r\n  const subscribers = new Set<string>()\r\n\r\n  console.log(`Creating new topic ${topicName}`)\r\n\r\n  setHandler(subscribeSignal, (taskQueue) => {\r\n    console.log(`Adding subsciber: \"${taskQueue}\"`)\r\n    subscribers.add(taskQueue)\r\n    return Promise.resolve(undefined)\r\n  })\r\n\r\n  while (true) {\r\n    sleep('1 year')\r\n  }\r\n}\r\n```\r\n\r\nAnd in `src/subscriber/index.ts`:\r\n\r\n```typescript\r\n    const client = new WorkflowClient({\r\n      ...options,\r\n      connection: options.brokerConnection\r\n    })\r\n    for (const topic in subscriptions) {\r\n      if (subscriptions.hasOwnProperty(topic)) {\r\n        console.log(`Subscribing to ${topic}`)\r\n        await client.signalWithStart<typeof TopicWorkflow, SubscribeInput>('topic', {\r\n          signal: 'subscribe',\r\n          signalArgs: [taskQueue],\r\n          taskQueue: options.brokerTaskQueue,\r\n          workflowId: workflowIdForTopic(topic)\r\n        })\r\n      }\r\n    }\r\n```\r\n\r\nTo run the code:\r\n1. Check out the repository above.\r\n2. Run `yarn` to install the dependencies.\r\n3. Run `yarn broker` to run the broker workflow worker.\r\n4. Run `yarn subscriber` to run the subscriber worker in a separate terminal.5. \r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: macOS on x86\r\n- Temporal Version: TypeScript SDK 1.0.1\r\n- Are you using Docker or Kubernetes or building Temporal from source? Using  `docker compose up`","closedAt":"2022-07-31T13:46:00Z","comments":[{"id":"IC_kwDOEujx185HjRZz","author":{"login":"jhecking"},"authorAssociation":"CONTRIBUTOR","body":"Turns out, the issue was just a missing `await` in the workflow's `while(true) { sleep('1 year') }` loop. ðŸ¤¦â€â™‚ï¸ \r\n\r\nBtw, is there a better way to make a workflow sleep indefinitely?","createdAt":"2022-07-31T13:46:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/797#issuecomment-1200428659","viewerDidAuthor":false},{"id":"IC_kwDOEujx185HjVCo","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Iâ€™m glad you worked it out.\r\nYou can add an eslint rule to verify that promises are awaited and save yourself some trouble.\r\nTo make the workflow block indefinitely, use:\r\n\r\n\r\n```ts\r\nawait CancellationScope.current().cancelRequested\r\n// or\r\nawait condition(() => false)\r\n```","createdAt":"2022-07-31T15:10:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/797#issuecomment-1200443560","viewerDidAuthor":false},{"id":"IC_kwDOEujx185HjV3T","author":{"login":"jhecking"},"authorAssociation":"CONTRIBUTOR","body":"> You can add an eslint rule to verify that promises are awaited and save yourself some trouble.\r\n\r\nThatâ€™s th worst part: I usually do. But this is (so far) a toy project, and I hadnâ€™t added our usually eslint rules yetâ€¦ ðŸ˜ž \r\n\r\n> await CancellationScope.current().cancelRequested\r\n\r\nThanks! This is exactly what I was looking for.","createdAt":"2022-07-31T15:30:31Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/797#issuecomment-1200446931","viewerDidAuthor":false}],"createdAt":"2022-07-31T13:21:52Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":797,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Node.js fatal error on signalWithStart","updatedAt":"2022-07-31T15:33:24Z","url":"https://github.com/temporalio/sdk-typescript/issues/797"}
