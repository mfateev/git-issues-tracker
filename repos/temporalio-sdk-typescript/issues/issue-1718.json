{"assignees":[],"author":{"id":"MDQ6VXNlcjg3MTUzNTI=","is_bot":false,"login":"arlyon","name":"Alexander Lyon"},"body":"Hi\n\nI would like to strip webpack from my bundle for container efficiency reasons but can't because webpack is loaded eagerly. By lazily loading `workflow/bundler` in [index](https://github.com/temporalio/sdk-typescript/blob/main/packages/worker/src/worker.ts) and in [worker](https://github.com/temporalio/sdk-typescript/blob/main/packages/worker/src/worker.ts) you can get away with deleting webpack and friends from the bundle (in my case the docker container)\n\nI have achieved it by applying this patch (on the build outputs) but I am sure doing a similar thing would be fairly easy on the typescript side. Note I have just removed the default interceptor warning altogether.\n\n```diff\ndiff --git a/lib/index.js b/lib/index.js\nindex ac5a7f9594321f75f52ac0641621d91c02c9ba8c..3aaa482c51d04627d9d7a2b96755f721ec2b5949 100644\n--- a/lib/index.js\n+++ b/lib/index.js\n@@ -52,8 +52,7 @@ Object.defineProperty(exports, \"defaultPayloadConverter\", { enumerable: true, ge\n Object.defineProperty(exports, \"Worker\", { enumerable: true, get: function () { return worker_1.Worker; } });\n var replay_1 = require(\"./replay\");\n Object.defineProperty(exports, \"ReplayError\", { enumerable: true, get: function () { return replay_1.ReplayError; } });\n-var bundler_1 = require(\"./workflow/bundler\");\n-Object.defineProperty(exports, \"bundleWorkflowCode\", { enumerable: true, get: function () { return bundler_1.bundleWorkflowCode; } });\n+Object.defineProperty(exports, \"bundleWorkflowCode\", { enumerable: true, get: function () { return require(\"./workflow/bundler\").bundleWorkflowCode; } });\n /* eslint-disable deprecation/deprecation */\n // Anything below this line is deprecated\n var activity_log_interceptor_1 = require(\"./activity-log-interceptor\");\ndiff --git a/lib/worker.js b/lib/worker.js\nindex e8cf98a86e9e1045af378319f6242f1ba66a3194..d4fc8999e3ef50d64c3d87338d930f3a0e0c28e8 100644\n--- a/lib/worker.js\n+++ b/lib/worker.js\n@@ -57,7 +57,6 @@ const rxutils_1 = require(\"./rxutils\");\n const utils_1 = require(\"./utils\");\n const worker_options_1 = require(\"./worker-options\");\n const workflow_codec_runner_1 = require(\"./workflow-codec-runner\");\n-const bundler_1 = require(\"./workflow/bundler\");\n const reusable_vm_1 = require(\"./workflow/reusable-vm\");\n const threaded_vm_1 = require(\"./workflow/threaded-vm\");\n const vm_1 = require(\"./workflow/vm\");\n@@ -317,12 +316,6 @@ class Worker {\n                 logger.warn('Ignoring WorkerOptions.bundlerOptions because WorkerOptions.workflowBundle is set');\n             }\n             const modules = new Set(compiledOptions.interceptors.workflowModules);\n-            // Warn if user tries to customize the default set of workflow interceptor modules\n-            if (modules &&\n-                new Set([...modules, ...bundler_1.defaultWorkflowInterceptorModules]).size !== bundler_1.defaultWorkflowInterceptorModules.length) {\n-                logger.warn('Ignoring WorkerOptions.interceptors.workflowModules because WorkerOptions.workflowBundle is set.\\n' +\n-                    'To use workflow interceptors with a workflowBundle, pass them in the call to bundleWorkflowCode.');\n-            }\n             if ((0, worker_options_1.isCodeBundleOption)(compiledOptions.workflowBundle)) {\n                 return parseWorkflowCode(compiledOptions.workflowBundle.code);\n             }\n@@ -335,6 +328,7 @@ class Worker {\n             }\n         }\n         else if (compiledOptions.workflowsPath) {\n+            const bundler_1 = require(\"./workflow/bundler\");\n             const bundler = new bundler_1.WorkflowCodeBundler({\n                 logger,\n                 workflowsPath: compiledOptions.workflowsPath,\n\n```","closedAt":null,"comments":[{"id":"IC_kwDOEujx186t4Yzl","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Yeah, making this dependency optional is definitely in my plans.\n\nThe approach you propose is a much lighter alternative to what was discussed in #933. I like it.\n\nI don't think that the modification you did in `index.js` can be done in pure TS (nor would it be compatible with ESM once we get there), as you technically can't `export` a property getter. It would however be possible to export a stub `bundleWorkflowCode` function that internally does a dynamic `import` to the actual `bundleWorkflowCode` implementation, which could then live in a different, _optional_ package.","createdAt":"2025-05-28T18:28:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1718#issuecomment-2917240037","viewerDidAuthor":false},{"id":"IC_kwDOEujx186t4mCt","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Regarding the user land workaround you described, you have not mentioned how you prevent the webpack package from being installed in the `node_modules` directory (or from your generated worker bundle, if applicable), to start with, which is required if your goal is to save disk space.\n\nI'm just curious how you did this. Are you using another bundling tool to bundle your _worker_ code? Or are you doing this by using some form of dependency tree modifiers specific to either NPM/PNPM/Yarn (e.g. `overrides`, `resolutions`, `readPackage`, etc)?","createdAt":"2025-05-28T18:47:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1718#issuecomment-2917294253","viewerDidAuthor":false},{"id":"IC_kwDOEujx186t_P0U","author":{"login":"arlyon"},"authorAssociation":"NONE","body":"Hey!\n\nYes, the onus is still up to the user to make sure it doesn't get shipped, but this change makes it possible at least even if nodejs lacks the nuance to make it automatic.\n\nWe ship docker containers so I went down the rabbit hole to optimise them for size / layers. The basic process is to figure out which are external dependencies (things that cannot be bundled) and copy _only_ those (and their transitive dependencies) from your node modules into the final container. A side effect is that you might end up with the same module in your bundle and in your node_modules since your externals might need it. You could probably get around it but it's not worth my time.\n\nhttps://gist.github.com/arlyon/c48c39b61c518e03da4e13b3086b37e5\n\nShort explainer:\n- use tsup\n- force webpack to be an external dependency\n- parse the tsup metafile to get the internal / external dependencies\n- parse `pnpm list` to traverse dependencies of external dependencies and get the transitive closure (since an external dependency can only look for its dependencies in node_modules, not your bundle)\n- filter out packages you know you don't need at runtime\n  - I looked at overriding those deps with an empty package in `package.json` but we'd have to apply that only to the builds inside the container (which felt a little black-magic-y) since they are still needed during dev runtime.\n\nI realise this is maybe overkill but you end up with very cacheable layers and very fast / light builds. We currently ship:\n\n- total container size: 335MB\n- OS: ~130MB\n  - node: 110MB \n- external deps layer: 145MB\n  - temporalio: 100MB\n  - otel: 27MB\n- code layer: 44MB\n  - worker bundle: 5MB\n  - worker source map: 24MB\n  - workflow bundle: 12MB (with sourcemaps embedded)","createdAt":"2025-05-29T10:52:49Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1718#issuecomment-2919038228","viewerDidAuthor":false},{"id":"IC_kwDOEujx186uIkXk","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Nice!\n\nYou should be able to strip an extra 60 MB very easily by removing native library files you don't need from the `node_modules/@temporalio/core-bridge/releases` directory. Just keep the one for your target platform.","createdAt":"2025-05-30T07:33:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1718#issuecomment-2921481700","viewerDidAuthor":false}],"createdAt":"2025-05-22T01:06:43Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1718,"reactionGroups":[],"state":"OPEN","title":"[Feature Request] Lazily load webpack","updatedAt":"2025-05-30T07:33:26Z","url":"https://github.com/temporalio/sdk-typescript/issues/1718"}
