{"assignees":[{"id":"MDQ6VXNlcjI1MTI4OA==","login":"lorensr","name":"Loren ☺️","databaseId":0}],"author":{"id":"MDQ6VXNlcjI1MTI4OA==","is_bot":false,"login":"lorensr","name":"Loren ☺️"},"body":"A heartbeat-then-immediately fail test that checks heartbeat details on activity retry","closedAt":"2022-04-21T21:58:35Z","comments":[{"id":"IC_kwDOEujx184_qv_m","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@lorensr - Here's the Python test:\r\n\r\n```python\r\nasync def test_activity_heartbeat_details(\r\n    client: temporalio.client.Client, worker: Worker\r\n):\r\n    async def some_activity() -> str:\r\n        info = temporalio.activity.info()\r\n        count = int(next(iter(info.heartbeat_details))) if info.heartbeat_details else 0\r\n        temporalio.activity.logger.debug(\r\n            \"Changing count from %s to %s\", count, count + 9\r\n        )\r\n        count += 9\r\n        temporalio.activity.heartbeat(count)\r\n        if count < 30:\r\n            raise RuntimeError(\"Try again!\")\r\n        return f\"final count: {count}\"\r\n\r\n    result = await _execute_workflow_with_activity(\r\n        client,\r\n        worker,\r\n        some_activity,\r\n        retry_max_attempts=4,\r\n    )\r\n    assert result.result == \"final count: 36\"\r\n```\r\n\r\nBasically, I just set the details and add 9 each time and have an expected count. I think the test is important to do this way for a couple of reasons: It specifically tests multiple retries and it makes sure that it does the _exact_ number of retries so a heartbeat isn't missed.\r\n\r\nThis test is, rarely, giving me errors right now in a racy way, so I am curious if it happens to yours too and if Core is the culprit. Obviously the numbers can be changed to whatever, but it's important to test exact number of retries and have each value build on the previous.\r\n\r\nYou'll also want to make sure that retry is fast (very low backoff), it's not shown in my code here.","createdAt":"2022-03-15T16:09:31Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/538#issuecomment-1068171238","viewerDidAuthor":false},{"id":"IC_kwDOEujx185B6TDg","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Addressed in #523 ","createdAt":"2022-04-21T21:58:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/538#issuecomment-1105801440","viewerDidAuthor":false}],"createdAt":"2022-03-14T22:28:55Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":538,"reactionGroups":[],"state":"CLOSED","title":"Test last heartbeat details shows up on Activity retry","updatedAt":"2022-04-21T21:58:36Z","url":"https://github.com/temporalio/sdk-typescript/issues/538"}
