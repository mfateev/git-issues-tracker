{"assignees":[],"author":{"id":"U_kgDOCtNmyA","is_bot":false,"login":"tshtark","name":""},"body":"### What are you really trying to do?\n\n We're running a production Temporal worker in Kubernetes that processes workflows with moderate-to-high concurrency (up to 100\n  concurrent workflow tasks). We want to monitor worker health and performance using Prometheus metrics exposed by the Temporal SDK's built-in\n  metrics exporter.\n\n### Describe the bug\n\n Workers crash repeatedly with Error: `async hook stack has become corrupted` when Prometheus metrics are enabled.\n\n  When we enable Prometheus metrics in RuntimeOptions.telemetryOptions, our production workers crash within minutes to hours with async hook\n  stack corruption. The error occurs in Node.js worker threads and causes continuous pod restarts, making the worker completely unstable.\n\n  Configuration that triggers the crash:\n\n```ts\n  const runtimeOptions: RuntimeOptions = {\n      logger: nestLoggerToTemporalLoggerAdapter(this.logger),\n      telemetryOptions: {\n          metrics: {\n              metricPrefix: `svc_${serviceName}_temporal__`,\n              prometheus: {\n                  bindAddress: '0.0.0.0:9292'\n              }\n          },\n          logging: {\n              filter: { core: 'INFO', other: 'INFO' }\n          }\n      }\n  }\n\n  // Worker configuration\n  {\n      tuner: {\n          activityTaskSlotOptions: {\n              minimumSlots: 5,\n              maximumSlots: 40,\n          },\n          workflowTaskSlotOptions: {\n              minimumSlots: 2,\n              maximumSlots: 100,\n          }\n      },\n      workflowThreadPoolSize: os.cpus().length,\n      reuseV8Context: true,\n  }\n```\n\n  Error output:\n\n```\n  Error: async hook stack has become corrupted (actual: 54451, expected: 4)\n  ----- Native stack trace -----\n\n   1: 0xee115d node::AsyncHooks::FailWithCorruptedAsyncStack(double) [node]\n   2: 0xee2698 node::AsyncHooks::pop_async_context(double) [node]\n   3: 0xe714aa node::InternalCallbackScope::Close() [node]\n   4: 0xe7193b node::InternalMakeCallback(...) [node]\n   5: 0xe8b2e2 node::AsyncWrap::MakeCallback(...) [node]\n   6: 0xfd515d node::worker::MessagePort::OnMessage(...) [node]\n   7: 0x1d2bc43  [node]\n   8: 0x1d40974  [node]\n   9: 0x1d2c967 uv_run [node]\n  10: 0xe726d6 node::SpinEventLoopInternal(node::Environment*) [node]\n  11: 0x10aa387 node::worker::Worker::Run() [node]\n```\n\n### Minimal Reproduction\n\n I don't have a minimal reproduction yet, but the issue can be reproduced with:\n\n  1. Start with the https://github.com/temporalio/samples-typescript/tree/main/hello-world\n  2. Add Prometheus metrics configuration to RuntimeOptions:\n  \n```\n  telemetryOptions: {\n      metrics: {\n          prometheus: { bindAddress: '0.0.0.0:9292' }\n      }\n  }\n```\n  3. Configure worker with high concurrency:\n```\n  workflowTaskSlotOptions: {\n      maximumSlots: 100\n  }\n```\n  4. Generate significant concurrent workflow load (run 50+ workflows simultaneously)\n  5. Worker should crash with async hook corruption after some time\n\n  Note: The issue is load-dependent and may require production-level traffic to reproduce consistently.\n\n### Environment/Versions\n\n<!-- Please complete the following information where relevant. -->\n\n- OS and processor: Linux x86_64 (Debian GNU/Linux 11 bullseye) in AWS EKS Kubernetes cluster\n  - Node.js Version: v22.11.0\n  - Temporal SDK Version: @temporalio/worker@1.13.1 (latest as of 2025-11-19)\n    - Also using: @temporalio/client@1.13.1, @temporalio/workflow@1.13.1, @temporalio/activity@1.13.1, @temporalio/common@1.13.1\n  - Deployment: Kubernetes (Docker containers in AWS EKS)\n  - Temporal Server: Temporal Cloud","closedAt":"2025-11-20T18:42:15Z","comments":[],"createdAt":"2025-11-19T15:21:13Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1832,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Worker crashes with \"async hook stack has become corrupted\" when Prometheus metrics enabled under high concurrency","updatedAt":"2025-11-20T18:42:15Z","url":"https://github.com/temporalio/sdk-typescript/issues/1832"}
