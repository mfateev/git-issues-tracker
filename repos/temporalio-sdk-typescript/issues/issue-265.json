{"assignees":[],"author":{"id":"MDQ6VXNlcjI1MTI4OA==","is_bot":false,"login":"lorensr","name":"Loren ☺️"},"body":"### Describe the bug\r\n\r\nWhen I run `node scripts/publish-to-verdaccio.js` locally, I get `ECONNREFUSED` and it edits `packages/*/package.json`.\r\n\r\nFirst run:\r\n\r\n```\r\n$ node scripts/publish-to-verdaccio.js --registry-dir /tmp/registry\r\nStarting local registry\r\nLocal registry ready\r\nNeed to install the following packages:\r\n  verdaccio\r\nOk to proceed? (y) ylerna notice cli v4.0.0\r\nlerna info versioning independent\r\nlerna WARN Unable to determine published version, assuming \"@temporalio/activity\" unpublished.\r\nlerna WARN Unable to determine published version, assuming \"@temporalio/client\" unpublished.\r\nlerna WARN Unable to determine published version, assuming \"@temporalio/common\" unpublished.\r\nlerna WARN Unable to determine published version, assuming \"@temporalio/core-bridge\" unpublished.\r\nlerna WARN Unable to determine published version, assuming \"@temporalio/create\" unpublished.\r\nlerna WARN Unable to determine published version, assuming \"@temporalio/interceptors-opentelemetry\" unpublished.\r\nlerna WARN Unable to determine published version, assuming \"temporalio\" unpublished.\r\nlerna WARN Unable to determine published version, assuming \"@temporalio/proto\" unpublished.\r\nlerna WARN Unable to determine published version, assuming \"@temporalio/worker\" unpublished.\r\nlerna WARN Unable to determine published version, assuming \"@temporalio/workflow\" unpublished.\r\n\r\nFound 10 packages to publish:\r\n - @temporalio/activity => 0.4.0\r\n - @temporalio/client => 0.7.0\r\n - @temporalio/common => 0.3.0\r\n - @temporalio/core-bridge => 0.4.0\r\n - @temporalio/create => 0.5.1\r\n - @temporalio/interceptors-opentelemetry => 0.2.0\r\n - temporalio => 0.4.2\r\n - @temporalio/proto => 0.3.2\r\n - @temporalio/worker => 0.9.0\r\n - @temporalio/workflow => 0.8.0\r\n\r\nlerna info auto-confirmed \r\nlerna info publish Publishing packages to npm...\r\nlerna notice Skipping all user and access validation due to third-party registry\r\nlerna notice Make sure you're authenticated properly ¯\\_(ツ)_/¯\r\nlerna WARN ECYCLE Dependency cycles detected, you should fix these!\r\nlerna WARN ECYCLE @temporalio/common -> @temporalio/proto -> @temporalio/core-bridge -> @temporalio/common\r\nlerna WARN ECYCLE Dependency cycles detected, you should fix these!\r\nlerna WARN ECYCLE @temporalio/common -> @temporalio/proto -> @temporalio/core-bridge -> @temporalio/common\r\nlerna ERR! ECONNREFUSED request to http://localhost:4873/@temporalio%2factivity failed, reason: connect ECONNREFUSED 127.0.0.1:4873\r\nlerna ERR! FetchError: request to http://localhost:4873/@temporalio%2factivity failed, reason: connect ECONNREFUSED 127.0.0.1:4873\r\nlerna ERR!     at ClientRequest.<anonymous> (/Users/me/gh/sdk-node/node_modules/minipass-fetch/lib/index.js:110:14)\r\nlerna ERR!     at ClientRequest.emit (node:events:394:28)\r\nlerna ERR!     at Socket.socketErrorListener (node:_http_client:447:9)\r\nlerna ERR!     at Socket.emit (node:events:406:35)\r\nlerna ERR!     at emitErrorNT (node:internal/streams/destroy:157:8)\r\nlerna ERR!     at emitErrorCloseNT (node:internal/streams/destroy:122:3)\r\nlerna ERR! lerna request to http://localhost:4873/@temporalio%2factivity failed, reason: connect ECONNREFUSED 127.0.0.1:4873\r\nError: Failed to publish to registry\r\n    at /Users/me/gh/sdk-node/scripts/publish-to-verdaccio.js:15:13\r\n    at withRegistry (/Users/me/gh/sdk-node/scripts/registry.js:79:18)\r\n    at processTicksAndRejections (node:internal/process/task_queues:96:5)\r\n    at async main (/Users/me/gh/sdk-node/scripts/publish-to-verdaccio.js:6:3)\r\n```\r\n\r\nSecond run fails due to uncommited changes:\r\n    \r\n```\r\nsdk-node git:(create-from-repo 1↑) 10M $ node scripts/publish-to-verdaccio.js --registry-dir /tmp/registry\r\nStarting local registry\r\nLocal registry ready\r\nNeed to install the following packages:\r\n  verdaccio\r\nOk to proceed? (y) lerna notice cli v4.0.0\r\nlerna info versioning independent\r\nlerna ERR! EUNCOMMIT Working tree has uncommitted changes, please commit or remove the following changes before continuing:\r\nlerna ERR! EUNCOMMIT  M packages/activity/package.json\r\nlerna ERR! EUNCOMMIT  M packages/client/package.json\r\nlerna ERR! EUNCOMMIT  M packages/common/package.json\r\nlerna ERR! EUNCOMMIT  M packages/core-bridge/package.json\r\nlerna ERR! EUNCOMMIT  M packages/create-project/package.json\r\nlerna ERR! EUNCOMMIT  M packages/interceptors-opentelemetry/package.json\r\nlerna ERR! EUNCOMMIT  M packages/meta/package.json\r\nlerna ERR! EUNCOMMIT  M packages/proto/package.json\r\nlerna ERR! EUNCOMMIT  M packages/worker/package.json\r\nlerna ERR! EUNCOMMIT  M packages/workflow/package.json\r\nError: Failed to publish to registry\r\n    at /Users/me/gh/sdk-node/scripts/publish-to-verdaccio.js:15:13\r\n    at withRegistry (/Users/me/gh/sdk-node/scripts/registry.js:79:18)\r\n    at processTicksAndRejections (node:internal/process/task_queues:96:5)\r\n    at async main (/Users/me/gh/sdk-node/scripts/publish-to-verdaccio.js:6:3)\r\n```\r\n\r\n### To Reproduce\r\n\r\n```\r\nrm /tmp/registry/storage\r\nnpm ci\r\nnpm run rebuild\r\nnode scripts/publish-to-verdaccio.js --registry-dir /tmp/registry\r\n```\r\n\r\n","closedAt":"2021-09-24T01:45:27Z","comments":[{"id":"IC_kwDOEujx1843NfIP","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Fixed by changing `rm /tmp/registry/storage` to `rm /tmp/registry`","createdAt":"2021-09-24T01:45:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/265#issuecomment-926282255","viewerDidAuthor":false}],"createdAt":"2021-09-24T00:59:11Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":265,"reactionGroups":[],"state":"CLOSED","title":"[Bug] publish-to-verdaccio fails","updatedAt":"2021-09-24T01:45:27Z","url":"https://github.com/temporalio/sdk-typescript/issues/265"}
