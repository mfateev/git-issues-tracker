{"assignees":[],"author":{"id":"MDQ6VXNlcjE2MTg0","is_bot":false,"login":"neelance","name":"Richard Musiol"},"body":"We just ran into the issue that v1.9.0 broke our workflow code. The issue is that we were using a global variable (global = at the top-level of the TypeScript file) to collect cleanup steps that were supposed to get executed at the end of the workflow. Prior to v1.9.0 this worked fine, because each workflow run had its own set of global variables.\r\n\r\nWith `reuseV8Context` however it caused the cleanup steps to leak into other workflow runs. If workflow run X added a cleanup step and went to sleep and then another workflow run Y got executed with the same V8 context, then Y would also invoke the cleanup steps of X.\r\n\r\nThis issue was hard to notice during testing. Fortunately we were able to recover with no long-lasting impact.\r\n\r\nIt seems like a footgun that it is so easy to break isolation now. One improvement would be to make [AsyncLocalStorage](https://nodejs.org/api/async_context.html) available to the workflow code. I wanted to use if back when I implemented the cleanup logic, but it was not available so I opted for the global variable instead.","closedAt":"2024-02-08T17:01:28Z","comments":[{"id":"IC_kwDOEujx185zTllj","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Thanks for reporting.\r\n\r\nCan you post a repro?\r\n\r\nYou can use workflow specific [`AsyncLocalStorage`](https://typescript.temporal.io/api/namespaces/workflow#asynclocalstorage).","createdAt":"2024-02-08T16:39:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1934514531","viewerDidAuthor":false},{"id":"IC_kwDOEujx185zTvaN","author":{"login":"neelance"},"authorAssociation":"NONE","body":"I did not know that you are exposing `AsyncLocalStorage` via `@temporalio/workflow`. This is perfect and the proper way to implement it. Thanks!","createdAt":"2024-02-08T17:01:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1934554765","viewerDidAuthor":false},{"id":"IC_kwDOEujx185zT-dE","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"@neelance I'm curious how `reuseV8Context` broke isolation for you.\r\nCould you please provide more details?","createdAt":"2024-02-08T17:31:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1934616388","viewerDidAuthor":false},{"id":"IC_kwDOEujx185zUHQS","author":{"login":"neelance"},"authorAssociation":"NONE","body":"Here is the concept:\r\n```\r\nconst someList: string[] = [];\r\n\r\nexport async function testWorkflow() {\r\n   someList.push(workflowInfo().workflowId);\r\n   sleep(10_000);\r\n   await activities.printList(someList);\r\n}\r\n```\r\n\r\nI think you should be able to observe entries from other workflows when you invoke it multiple times.","createdAt":"2024-02-08T17:51:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1934652434","viewerDidAuthor":false},{"id":"IC_kwDOEujx185zVFov","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I can't reproduce this:\r\n\r\nhttps://github.com/temporalio/sdk-typescript/pull/1356/files\r\n\r\n","createdAt":"2024-02-08T20:46:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1934907951","viewerDidAuthor":false},{"id":"IC_kwDOEujx185zVqoq","author":{"login":"neelance"},"authorAssociation":"NONE","body":"Strange. I just reproduced it like this:\r\n```ts\r\nlet value = 0;\r\nexport async function example(): Promise<number> {\r\n  value++;\r\n  return value;\r\n}\r\n```\r\n\r\nEvery time I run this workflow, I get the next number until I restart the worker. When I disable `reuseV8Context` I always get `1`. I wonder what's the difference between our setups...","createdAt":"2024-02-08T22:52:54Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1935059498","viewerDidAuthor":false},{"id":"IC_kwDOEujx185zVsvy","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"How are you creating your bundle (ignore if you don't know what I mean) and worker?","createdAt":"2024-02-08T23:02:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1935068146","viewerDidAuthor":false},{"id":"IC_kwDOEujx185zVuMN","author":{"login":"neelance"},"authorAssociation":"NONE","body":"Yes, that's exactly what I was just looking at and I think I found it: We're building the workflow bundle on our own and you seem to manipulate the `__webpack_module_cache__`, which does not seem to work with our bundle. We're still using Webpack, so I guess there should be some way to make it work...","createdAt":"2024-02-08T23:08:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1935074061","viewerDidAuthor":false},{"id":"IC_kwDOEujx185zVurJ","author":{"login":"neelance"},"authorAssociation":"NONE","body":"```ts\r\n    code = code.replace(\r\n      'var __webpack_module_cache__ = {}',\r\n      'var __webpack_module_cache__ = globalThis.__webpack_module_cache__'\r\n    );\r\n```\r\nðŸ™ˆ ","createdAt":"2024-02-08T23:10:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1935076041","viewerDidAuthor":false},{"id":"IC_kwDOEujx185zVvil","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I see, well we definitely don't support that. You're on your own there ðŸ˜¬ ","createdAt":"2024-02-08T23:14:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1935079589","viewerDidAuthor":false},{"id":"IC_kwDOEujx185zVy1x","author":{"login":"neelance"},"authorAssociation":"NONE","body":"Problem is that using your bundler comes with inconsistencies to how we bundle the rest of our codebase...\r\n\r\nAnd well, you're not really discouraging it either:\r\n![CleanShot 2024-02-09 at 00 27 33](https://github.com/temporalio/sdk-typescript/assets/16184/c507b564-3bac-4813-ac72-bbee4124ef80)\r\n![CleanShot 2024-02-09 at 00 28 05](https://github.com/temporalio/sdk-typescript/assets/16184/c48c945b-9071-4a9f-ad0a-d473a343fef8)\r\nhttps://docs.temporal.io/dev-guide/typescript/foundations","createdAt":"2024-02-08T23:30:05Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1935093105","viewerDidAuthor":false},{"id":"IC_kwDOEujx185zVz9C","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"`bundleWorkflowCode` is a utility that we maintain and support.\r\nIt's used internally by the worker if you give it a `workflowsPath` option.\r\n\r\nWhat are the inconsistencies I wonder.\r\nIs using the webpack hook we provide not enough?","createdAt":"2024-02-08T23:35:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1935097666","viewerDidAuthor":false},{"id":"IC_kwDOEujx185zV0Dz","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I'll have the docs fixed, don't know who put this advice there.","createdAt":"2024-02-08T23:36:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1935098099","viewerDidAuthor":false},{"id":"IC_kwDOEujx185zV4wS","author":{"login":"neelance"},"authorAssociation":"NONE","body":"> Is using the webpack hook we provide not enough?\r\n\r\nI just tried `bundleWorkflowCode` and got it to work. We simplified our Webpack setup in the last months, so that helped. Honestly, I'm still not that happy about having a second bundler. I'll think about it some more...","createdAt":"2024-02-09T00:01:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1935117330","viewerDidAuthor":false},{"id":"IC_kwDOEujx185zWBMI","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Thanks for the updates.\r\n\r\nLet me know if you have more thoughts on the subject.","createdAt":"2024-02-09T00:40:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1935151880","viewerDidAuthor":false},{"id":"IC_kwDOEujx185z1EDn","author":{"login":"neelance"},"authorAssociation":"NONE","body":"Here's an update:\r\n\r\nWe have switched to using `bundleWorkflowCode`. It was easy enough to integrate into our current build setup. Especially the Webpack hook helped.\r\n\r\nHowever, we've still found a slightly different workflow isolation bug, which still happens when using your bundler. We were also able to resolve it with `AsyncLocalStorage`, but you probably want to look into it. Unfortunately it is again difficult for me to come up with a reproduction, so I will describe what we saw and maybe you can already see the issue:\r\n\r\nWe saw some workflows getting stuck with a nondeterminism error. However, I was able to replay these workflows locally on the same code without any issue. I then guessed that they will probably resolve when restarting the workers. We then restarted all workers without any code change and the workflows completed fine as expected. This strongly suggests an isolation issue.\r\n\r\nThe difference to the case above is that this time it is not an execution of workflow A leaking into workflow B, but one execution of workflow A leaking into a replay (on the worker) of the same workflow A. In our case signals were involved: The signal handler was writing the data it received into a global variable which served as a map (the data is keyed). Some specific `condition` then waited for an entry in this map. The nondeterminism was due to code at the beginning of the workflow already reading data from the map that should not yet be available until some later signal in the history of the workflow.\r\n\r\nHave I explained it well enough? My best guess is that you are not discarding the Webpack module cache when replaying a workflow.","createdAt":"2024-02-14T08:33:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1943290087","viewerDidAuthor":false},{"id":"IC_kwDOEujx185z8xxS","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Thanks for the update and detailed report.\r\n\r\nI wonder what is going on there, I donâ€™t see a reason why this would happen.\r\n\r\nDoes disabling reuse v8 context also prevent workers getting into this state?","createdAt":"2024-02-15T03:35:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1355#issuecomment-1945312338","viewerDidAuthor":false}],"createdAt":"2024-02-08T16:32:24Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1355,"reactionGroups":[],"state":"CLOSED","title":"[Bug] `reuseV8Context` breaks workflow isolation","updatedAt":"2024-02-15T03:35:59Z","url":"https://github.com/temporalio/sdk-typescript/issues/1355"}
