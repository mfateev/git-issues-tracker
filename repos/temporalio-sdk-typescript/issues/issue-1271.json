{"assignees":[],"author":{"id":"MDQ6VXNlcjY0MTIxNjk=","is_bot":false,"login":"mjameswh","name":"James Watkins-Harvey"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\nSome TS SDK users have strong requirement of only using alpine-based Docker images. This is a problem, as the `alpine` distribution is based on the `musl` C library (rather than the GNU's `libc` found in most other distributions), which isn't supported at the moment by the `@temporalio/core-bridge` package. Is is therefore not possible to run a TS SDK Worker in an alpine-based container.\r\n\r\nThe team is hesitant about shipping a `musl`-based native library out of the box, as this would increase the download size for all of our users.\r\n\r\nIn theory, self-building the native library would be a reasonably simple solution, since `core-bridge` is designed to build the native lib if it can't find the binary file corresponding to the current target environment. However, the TS logic that identify the current target can't recognize the fact that it is running on a `musl`-based system (node itself provides no information on that regard).\r\n\r\n\r\n### Describe the solution you'd like\r\n\r\n- [ ] Modify `core-bridge`'s target environment detection logic to recognize that it is running in a `musl`-based system, and to consequently return the proper build target for those environments.\r\n\r\n  With this change, the `@temporalio/core-bridge` will correctly identify that it is running in a `musl` environment, and therefore try to load the `musl`-based native library. Assuming that this library can't be found (ie. because we don't ship the musl), and that the proper go toolchain is installed, then the package would automatically build the native library. This build operation would only happen the first time the application execute, and the built artifact could be copied over. It would therefore be reasonably easy to include this build step as part of a multi-stage Dockerfile.\r\n\r\n- [ ] Add some `musl`-based environment to the CI test matrix","closedAt":"2025-02-07T15:52:06Z","comments":[{"id":"IC_kwDOEujx186N2AHo","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Marking this issue as Good First Contribution â€” specifically the first part: \"adding detection logic to recognize `musl` environment\". That requires modifying [this file](https://github.com/temporalio/sdk-typescript/blob/main/packages/core-bridge/common.js). Can probably find hints of a `musl` build by looking into `process` or `os`, or maybe `process.report.getReport()` (IIRC, that last one provides the list of loaded libraries).\r\n\r\nAdding `musl` to the CI test matrix might be best left to official maintainers.","createdAt":"2024-09-27T17:24:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1271#issuecomment-2379743720","viewerDidAuthor":false},{"id":"IC_kwDOEujx186UQb3H","author":{"login":"korbin"},"authorAssociation":"NONE","body":"https://github.com/angellist/sdk-typescript/commit/c34ba641d05541647dfd0aa94bdd81be6f1a0593\r\n\r\nI don't have time to pull through the CI-related changes to make this work, but, this does seem to work without issue on an Alpine system with:\r\n\r\n``` \r\napk add --no-cache build-base cmake protoc protobuf-dev rustup\r\nrustup-init -y\r\n\r\nexport RUSTFLAGS=\"-C target-feature=-crt-static\"\r\nexport BUILD_CORE_RELEASE=\"true\"\r\n```\r\n\r\nI added `strip = true` to the release profile and the `musl` binary is only 6.9MB. This build takes long enough (6m on c8g.16xlarges) that it's probably worth including in the prebuilt binaries list.","createdAt":"2024-11-20T03:52:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1271#issuecomment-2487336391","viewerDidAuthor":false},{"id":"IC_kwDOEujx186djcFF","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Superseded by #1621.","createdAt":"2025-02-07T15:52:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1271#issuecomment-2643312965","viewerDidAuthor":false}],"createdAt":"2023-10-26T19:39:58Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwyNTQ1Mzg0MDE2","name":"good first issue","description":"Good for newcomers","color":"7057ff"}],"milestone":null,"number":1271,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":8}}],"state":"CLOSED","title":"[Feature Request] Add minimal support to link core-bridge against musl","updatedAt":"2025-02-07T15:52:07Z","url":"https://github.com/temporalio/sdk-typescript/issues/1271"}
