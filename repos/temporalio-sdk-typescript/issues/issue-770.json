{"assignees":[],"author":{"id":"MDQ6VXNlcjI1MTI4OA==","is_bot":false,"login":"lorensr","name":"Loren ☺️"},"body":"Report from user:\r\n\r\n### What are you really trying to do?\r\n\r\n<!-- \r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\n-->\r\n\r\nI’m creating a workflowBundle of all the workflows i’m replaying, passing the workflowBundle in to runReplayHistory, and adding the promise from runReplayHistory to an array of promises on which I use Promise.all() at the end.\r\n\r\n### Describe the bug\r\n\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n\r\nI’m seeing mostly successful replays, with all executing correctly except for the last one, where I get the error:\r\n\r\n```\r\nUnhandled rejection { runId: undefined } Error: Replay failed. Details: Workflow activation completion failed: Failure { failure: Some(Failure { message: \"Timed out waiting for task result\", source: \"TypeScriptSDK\", stack_trace: \"Error: Timed out waiting for task result\\n    at Object.waitForTaskComplete (webpack-internal:///./src/work_session_manager/atlas_work_task_complete_signal.ts:36:27)\", cause: None, failure_info: None }) }\r\n```\r\n\r\nIf I skip replaying the last workflow, everything succeeds and the function actually finishes/returns.","closedAt":"2022-07-29T18:06:06Z","comments":[{"id":"IC_kwDOEujx185HWRWU","author":{"login":"rupalivohra"},"authorAssociation":"NONE","body":"Hey @lorensr - any thoughts on when y'all will get to this? \r\nWe want to put workflow replays in our CI pipeline, but without bundling and without a bulk endpoint, it's very slow to start up a new worker for each workflow replay.","createdAt":"2022-07-27T16:48:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/770#issuecomment-1197020564","viewerDidAuthor":false},{"id":"IC_kwDOEujx185HWbeq","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Not sure, but adding the `next` label!","createdAt":"2022-07-27T17:13:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/770#issuecomment-1197062058","viewerDidAuthor":false},{"id":"IC_kwDOEujx185HXaUJ","author":{"login":"alex766"},"authorAssociation":"NONE","body":"Hi! Roey mentioned that you've seen this issue but haven't been able to reliably reproduce it, and I wanted to add that I have seen the error every time with bundling, but it often occurs in different places - I'm bundling about 10 workflows together and sometimes it fails on the 5th or last workflow's replay while sometimes it fails on the 2nd. I'm not sure if this is what you noticed, but thought I would add this information. ","createdAt":"2022-07-27T20:15:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/770#issuecomment-1197319433","viewerDidAuthor":false},{"id":"IC_kwDOEujx185HXc6M","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Thanks everyone for jumping in on this conversation.\r\n\r\n@alex766 this doesn't look like the same issue we're seeing in the SDK CI.\r\n\r\nI _think_ this issue is not related to the SDK, it might just be some failure in a sink or some other source.\r\n\r\n@rupalivohra can you please provide a reproduction?\r\nThe exception is thrown from your code, so we don't have a way to examine this further.","createdAt":"2022-07-27T20:26:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/770#issuecomment-1197330060","viewerDidAuthor":false},{"id":"IC_kwDOEujx185HXm7l","author":{"login":"alex766"},"authorAssociation":"NONE","body":"Hi, thanks for the quick response! The error I'm getting from the SDK is first \r\n`WARN temporal_sdk_core::worker: Failing workflow activation, run_id: \"e676ec84-1b0b-4ff3-9ddd-8ca235d5f403\", failure: Failure { failure: Some(Failure { message: \"WorkflowUpdateError { source: Fatal(\\\"Child workflow machine does not handle this event\\\"), run_id: \\\"e676ec84-1b0b-4ff3-9ddd-8ca235d5f403\\\" }\", source: \"\", stack_trace: \"\", cause: None, failure_info: Some(ApplicationFailureInfo(ApplicationFailureInfo { r#type: \"\", non_retryable: false, details: None })) }) }` \r\nand the following error that I mentioned earlier is (I think) the result from the sink. Does that match what you were seeing?\r\n\r\nAs for the code, the relevant snippets are below. I first create the bundle then use `listWorkflowExecutions` to get the 3 oldest running workflows for each workflow type, grab their history, and kick off the replay using the workflowBundle. I then await for the results of the replay. \r\n```\r\nconst workflowBundle = await bundleWorkflowCode({\r\n    workflowsPath: require.resolve('../scheduling/workflows/all_workflows'),\r\n  });\r\n```\r\n\r\n```\r\nconst resultIDs = await conn.service.listWorkflowExecutions({\r\n    namespace: replayNamespace,\r\n    pageSize: 3,\r\n    query: `WorkflowType = '${workflowName}' and ExecutionStatus = 'Running'\r\n       ORDER BY StartTime ASC`,\r\n  });\r\n\r\n  const queriedIDs = resultIDs.executions.map(({ execution }) => execution!.workflowId!);\r\n\r\n  for (const ID of queriedIDs) {\r\n    const { history } = await conn.service.getWorkflowExecutionHistory({\r\n      namespace: replayNamespace,\r\n      execution: {\r\n        workflowId: ID,\r\n      },\r\n    });\r\n\r\n    if (!history) {\r\n      throw new ReplayExecutionHistoryError(ID);\r\n    }\r\n\r\n    workflowReplays.push(\r\n      Worker.runReplayHistory(\r\n        {\r\n          workflowBundle,\r\n          replayName: `replayed-${ID}`,\r\n          interceptors,\r\n          sinks,\r\n        },\r\n        history,\r\n      ),\r\n    );\r\n}\r\n\r\ntry {\r\n  await Promise.all(workflowReplays);\r\n} catch (error) {\r\n  isDeterministic = false;\r\n}\r\n\r\n```","createdAt":"2022-07-27T21:09:37Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/770#issuecomment-1197371109","viewerDidAuthor":false},{"id":"IC_kwDOEujx185HYJqI","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"@alex766 this looks like non-determinism of workflow code, that would be the most likely option.\r\nIf this is the case, it likely means you modified the workflow code in a backwards incompatible manner and the replayer caught that.\r\n\r\nIf you think otherwise, please provide a reproduction with the workflow code so we can examine that more closely.","createdAt":"2022-07-28T00:21:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/770#issuecomment-1197513352","viewerDidAuthor":false},{"id":"IC_kwDOEujx185HblB-","author":{"login":"alex766"},"authorAssociation":"NONE","body":"@bergundy Hm, I recognize that the error is similar to a non-determinism error thrown, but I'm pretty certain that it is not coming from non-determinism because (1) I didn't change any of the workflow code when running the replay, and (2) when I run the replay serially without any bundling, no workflow non-determinism errors are raised and the replays all run to completion. \r\n\r\nDo you have any other ideas for what it could be?","createdAt":"2022-07-28T17:08:52Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/770#issuecomment-1198411902","viewerDidAuthor":false},{"id":"IC_kwDOEujx185HblvU","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"@alex766 it'd be hard for me to guess without seeing sample workflow code and corresponding history.","createdAt":"2022-07-28T17:10:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/770#issuecomment-1198414804","viewerDidAuthor":false},{"id":"IC_kwDOEujx185HbmU6","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I'm not sure how to reproduce this myself, I would need assistance from your to recreate the scenario.","createdAt":"2022-07-28T17:13:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/770#issuecomment-1198417210","viewerDidAuthor":false},{"id":"IC_kwDOEujx185HcYv-","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"@alex766 @rupalivohra can we resolve this issue based on our slack conversation?\r\n\r\nWe figured out that the cause was that the bundle wasn't created with the same interceptors that were passed in to the worker.","createdAt":"2022-07-28T20:56:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/770#issuecomment-1198623742","viewerDidAuthor":false},{"id":"IC_kwDOEujx185HgyJh","author":{"login":"alex766"},"authorAssociation":"NONE","body":"Yep, thank you for all the help!","createdAt":"2022-07-29T17:20:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/770#issuecomment-1199776353","viewerDidAuthor":false}],"createdAt":"2022-07-21T20:38:20Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":770,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"[Bug] Timeout on last runReplayHistory","updatedAt":"2022-07-29T18:06:06Z","url":"https://github.com/temporalio/sdk-typescript/issues/770"}
