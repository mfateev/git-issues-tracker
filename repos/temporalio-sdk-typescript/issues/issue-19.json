{"assignees":[],"author":{"id":"MDQ6VXNlcjUyMzA0","is_bot":false,"login":"bergundy","name":"Roey Berman"},"body":"Doesn't need to be this PR but you'll probably want to have some mechanism to drain any remaining activations from `poll_task` until it returns `CoreError::ShuttingDown`. Remaining activations may exist due to replaying a workflow to catch up to the end of history which was already fetched from the server\r\n\r\n_Originally posted by @Sushisource in https://github.com/temporalio/sdk-node/pull/18#discussion_r584953075_","closedAt":"2021-03-09T10:43:07Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDc4OTUzNjIyOA==","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"@Sushisource I tried to implement draining but never got `CoreError:ShuttingDown`, in fact the promise returned from `run` was never resolved or rejected.\r\nSee the worker code here: https://github.com/temporalio/sdk-node/blob/aff47fddc0f2de53f52677fc97084139ea268e06/packages/worker/src/worker.ts#L142\r\n\r\nExample worker to reproduce:\r\n```ts\r\nimport { Worker } from '@temporalio/worker';\r\nimport { sleep } from '@temporalio/worker/lib/utils';\r\n\r\nconst shutdownGraceTimeSecs = 5;\r\n\r\nasync function run() {\r\n  const worker = new Worker(__dirname);\r\n  process.on('SIGINT', async () => {\r\n    console.log('Shutting down worker');\r\n    worker.shutdown();\r\n    await sleep(shutdownGraceTimeSecs * 1000);\r\n    console.error('Timed out while waiting for worker to shutdown gracefully');\r\n    process.exit(0);\r\n  });\r\n  await worker.run('test');\r\n  console.log('Worker gracefully shutdown');\r\n}\r\n\r\nrun().then(\r\n  () => void process.exit(0),\r\n  (err) => {\r\n    console.error(err);\r\n    process.exit(1);\r\n  }\r\n);\r\n\r\n```","createdAt":"2021-03-03T08:30:34Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/19#issuecomment-789536228","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc4OTkyNjIxOQ==","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"@bergundy I'll fix this - it's immediately clear to me what the problem is... `poll_task` is stuck blocked on the long poll and never gets a chance to see that the shutdown flag is set. I need some way to interrupt the long poll when that happens. Should be easy.","createdAt":"2021-03-03T17:42:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/19#issuecomment-789926219","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc5MDEzMjYyMw==","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"Should be fixed by https://github.com/temporalio/sdk-core/pull/59","createdAt":"2021-03-03T22:58:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/19#issuecomment-790132623","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc5MDU5ODA3MA==","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"After the above is merged, we should update the submodule and create a PR for https://github.com/temporalio/sdk-node/tree/graceful-shutdown","createdAt":"2021-03-04T12:56:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/19#issuecomment-790598070","viewerDidAuthor":false}],"createdAt":"2021-03-01T19:06:18Z","labels":[],"milestone":null,"number":19,"reactionGroups":[],"state":"CLOSED","title":"Drain any remaining activations from `poll_task` until it returns `CoreError::ShuttingDown`","updatedAt":"2021-03-09T10:43:07Z","url":"https://github.com/temporalio/sdk-typescript/issues/19"}
