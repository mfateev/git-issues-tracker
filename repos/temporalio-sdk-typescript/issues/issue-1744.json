{"assignees":[],"author":{"id":"MDQ6VXNlcjUxNDkzMg==","is_bot":false,"login":"antmendoza","name":"Antonio Mendoza PÃ©rez"},"body":"### What are you really trying to do?\n\n<!-- \nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \n-->\n\n### Describe the bug\n\n\nThe following code throws an NDE during replay \n\n\n\n```\n\n\n    await Promise.all(\n        [1, 3].map(async (offset) => {\n            await Promise.all(\n                [\"a\", \"b\", \"c\", \"d\", \"e\"].map(async (c) => {\n\n                    console.log(`sleepRandomLocal start ${offset} ${c}`);\n\n\n                    printActivities();\n                    //schedule local activity\n                    await sleepRandomLocal(1, 100, `${offset} ${c}`);\n                    \n\n                    console.log(`sleepRandom start ${offset} ${c}`);\n                    printActivities();\n                    //schedule activity\n                    await sleepRandom(offset * 1000, offset * 1000, `${offset} ${c}`);\n                })\n            );\n\n            console.log(`greet start ${offset}`);\n            printActivities();\n            //schedule activity\n            await greet(offset.toString());\n        })\n    );\n\n\n    printActivities();\n\n    // Throw an error to force replay\n    throw new Error(\"Something went wrong\");\n\n```\n\n\n```\n2025-07-15T08:54:54.526968Z  WARN temporal_sdk_core::worker::workflow: Failing workflow task run_id=01980d4b-3cd8-7271-abfb-0c98f28d3e91 failure=Failure { failure: Some(Failure { message: \"[TMPRL1100] Nondeterminism error: No command scheduled for event HistoryEvent(id: 38, ActivityTaskScheduled)\", source: \"\", stack_trace: \"\", encoded_attributes: None, cause: None, failure_info: \nSome(ApplicationFailureInfo(ApplicationFailureInfo { r#type: \"\", non_retryable: false, details: None, next_retry_delay: None, category: Unspecified })) }), force_cause: NonDeterministicError }\n\n```\n\nI added a log to the interceptor and activities seems to be scheduled in the same order (considering only activity type) \n\n**Runtime**\n\n`sleepRandomLocal-1 a, sleepRandomLocal-1 b, sleepRandomLocal-1 c, sleepRandomLocal-1 d, sleepRandomLocal-1 e, sleepRandomLocal-3 a, sleepRandomLocal-3 b, sleepRandomLocal-3 c, sleepRandomLocal-3 d, sleepRandomLocal-3 e, sleepRandom-1 c, sleepRandom-1 a, sleepRandom-3 e, sleepRandom-3 d, sleepRandom-1 b, sleepRandom-3 a, sleepRandom-1 e, sleepRandom-3 c, sleepRandom-3 b, sleepRandom-1 d, greet-undefined, greet-undefined`\n\n**Replay**\n\n`sleepRandomLocal-1 a, sleepRandomLocal-1 b, sleepRandomLocal-1 c, sleepRandomLocal-1 d, sleepRandomLocal-1 e, sleepRandomLocal-3 a, sleepRandomLocal-3 b, sleepRandomLocal-3 c, sleepRandomLocal-3 d, sleepRandomLocal-3 e, sleepRandom-1 a, sleepRandom-1 b, sleepRandom-1 c, sleepRandom-1 d, sleepRandom-1 e, sleepRandom-3 a, sleepRandom-3 b, sleepRandom-3 c, sleepRandom-3 d`\n\n\n\n\n### Minimal Reproduction\n\nhere is the code shared by the customer to reproduce the issue: \n\n[Archive.zip](https://github.com/user-attachments/files/21229315/Archive.zip)\n\n\n### Environment/Versions\n\nversion 1.12.1\n","closedAt":null,"comments":[],"createdAt":"2025-07-15T09:51:57Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1744,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}},{"content":"HEART","users":{"totalCount":2}}],"state":"OPEN","title":"[Bug] NDE replaying nested promises","updatedAt":"2025-07-15T09:52:02Z","url":"https://github.com/temporalio/sdk-typescript/issues/1744"}
