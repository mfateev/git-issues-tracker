{"assignees":[],"author":{"id":"MDQ6VXNlcjE5MDA4NzY=","is_bot":false,"login":"jhecking","name":"Jan Hecking"},"body":"### What are you really trying to do?\n\nWe try to describe a workflow schedule to see if it exists already.\n\n### Describe the bug\n\nTrying to describe a workflow schedule causes the following error:\n\n```\nServiceError: Failed to describe schedule\n    at ScheduleClient.rethrowGrpcError (/var/workspace/node_modules/@temporalio/client/lib/schedule-client.js:347:19)\n    at ScheduleClient._describeSchedule (/var/workspace/node_modules/@temporalio/client/lib/schedule-client.js:137:18)\n    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)\n    at async Object.describe (/var/workspace/node_modules/@temporalio/client/lib/schedule-client.js:261:29)\n    at async ListConnectionStatus (/var/workspace/main.js:204227:26)\n    at async Authorization (/var/workspace/main.js:200642:12)\n    at async /var/workspace/main.js:201108:28\n    at async HandleServerErrors (/var/workspace/main.js:201020:16)\n    at async handle (/var/workspace/main.js:165050:22)\ncaused by: Error: 8 RESOURCE_EXHAUSTED: consistent query buffer is full, this may be caused by too many queries and workflow not able to process query fast enough\n    at callErrorFromStatus (/var/workspace/node_modules/@grpc/grpc-js/build/src/call.js:31:19)\n    at Object.onReceiveStatus (/var/workspace/node_modules/@grpc/grpc-js/build/src/client.js:193:76)\n    at /var/workspace/node_modules/@grpc/grpc-js/build/src/call-interface.js:78:35\n    at Object.onReceiveStatus (/var/workspace/node_modules/@temporalio/client/lib/grpc-retry.js:165:25)\n    at Object.onReceiveStatus (/var/workspace/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:360:141)\n    at Object.onReceiveStatus (/var/workspace/node_modules/@grpc/grpc-js/build/src/client-interceptors.js:323:181)\n    at /var/workspace/node_modules/@grpc/grpc-js/build/src/resolving-call.js:129:78\n    at process.processTicksAndRejections (node:internal/process/task_queues:85:11)\nfor call at\n    at ServiceClientImpl.makeUnaryRequest (/var/workspace/node_modules/@grpc/grpc-js/build/src/client.js:161:32)\n    at Service.rpcImpl (/var/workspace/node_modules/@temporalio/client/lib/connection.js:239:33)\n    at Service.rpcCall (/var/workspace/node_modules/protobufjs/src/rpc/service.js:94:21)\n    at executor (/var/workspace/node_modules/@protobufjs/aspromise/index.js:44:16)\n    at new Promise (<anonymous>)\n    at Object.asPromise (/var/workspace/node_modules/@protobufjs/aspromise/index.js:28:12)\n    at Service.rpcCall (/var/workspace/node_modules/protobufjs/src/rpc/service.js:86:21)\n    at Service.describeSchedule (eval at Codegen (/var/workspace/node_modules/@protobufjs/codegen/index.js:50:33), <anonymous>:4:15)\n    at ScheduleClient._describeSchedule (/var/workspace/node_modules/@temporalio/client/lib/schedule-client.js:131:47)\n    at Object.describe (/var/workspace/node_modules/@temporalio/client/lib/schedule-client.js:261:47)\n```\n\nWe only see this happening for one specific schedule, which triggers every half hour. It doesn't happen immediately, but only after the schedule has been running for a while. If we delete the schedule, and recreate it, the problem goes away for some time. This same problem happens on multiple identical deployments, but only for this one schedule. Once the schedule is in this state, we are getting this error when trying to describe the schedule using the TypeScript SDK but also when using the Temporal CLI and also using the Temporal web console.\n\nDescribe schedule output, before the issue occurs:\n\n```\ntemporal-admintools-6468b84b77-2pf6g:/etc/temporal$ temporal schedule describe -s monitoring_schedule -o json\n{\n  \"schedule\": {\n    \"spec\": {\n      \"structuredCalendar\": [\n        {\n          \"second\": [\n            {\n              \"step\": 1\n            }\n          ],\n          \"minute\": [\n            {\n              \"end\": 59,\n              \"step\": 30\n            }\n          ],\n          \"hour\": [\n            {\n              \"end\": 23,\n              \"step\": 1\n            }\n          ],\n          \"dayOfMonth\": [\n            {\n              \"start\": 1,\n              \"end\": 31,\n              \"step\": 1\n            }\n          ],\n          \"month\": [\n            {\n              \"start\": 1,\n              \"end\": 12,\n              \"step\": 1\n            }\n          ],\n          \"dayOfWeek\": [\n            {\n              \"end\": 6,\n              \"step\": 1\n            }\n          ]\n        }\n      ]\n    },\n    \"action\": {\n      \"startWorkflow\": {\n        \"workflowId\": \"monitoring_schedule\",\n        \"workflowType\": {\n          \"name\": \"monitoringSchedule\"\n        },\n        \"taskQueue\": {\n          \"name\": \"borneo-workers\",\n          \"kind\": \"TASK_QUEUE_KIND_NORMAL\"\n        },\n        \"input\": {},\n        \"workflowExecutionTimeout\": \"1500s\",\n        \"header\": {\n          \"fields\": {\n            \"orgInfo\": {\n              \"metadata\": {\n                \"encoding\": \"anNvbi9wbGFpbg==\"\n              },\n              \"data\": \"eyJ0ZW5hbnRJZCI6IjZiYTBmODU3LWZkYzgtOWFmNC02ZWI3LWJlZDM0NjEyMDBlNSIsIm9yZ2FuaXNhdGlvbklkIjoxfQ==\"\n            }\n          }\n        }\n      }\n    },\n    \"policies\": {\n      \"overlapPolicy\": \"SCHEDULE_OVERLAP_POLICY_SKIP\",\n      \"catchupWindow\": \"31536000s\"\n    },\n    \"state\": {}\n  },\n  \"info\": {\n    \"actionCount\": \"4\",\n    \"recentActions\": [\n      {\n        \"scheduleTime\": \"2025-03-25T10:41:17.794180870Z\",\n        \"actualTime\": \"2025-03-25T10:41:17.869016655Z\",\n        \"startWorkflowResult\": {\n          \"workflowId\": \"monitoring_schedule-2025-03-25T10:41:17Z\",\n          \"runId\": \"3f9bb004-4f31-4600-9e45-23bf195cd572\"\n        }\n      },\n      {\n        \"scheduleTime\": \"2025-03-25T11:00:00Z\",\n        \"actualTime\": \"2025-03-25T11:00:00.198352012Z\",\n        \"startWorkflowResult\": {\n          \"workflowId\": \"monitoring_schedule-2025-03-25T11:00:00Z\",\n          \"runId\": \"bf151d94-c8f7-4346-95cb-bd90cddfab72\"\n        }\n      },\n      {\n        \"scheduleTime\": \"2025-03-25T11:30:00Z\",\n        \"actualTime\": \"2025-03-25T11:30:00.410055532Z\",\n        \"startWorkflowResult\": {\n          \"workflowId\": \"monitoring_schedule-2025-03-25T11:30:00Z\",\n          \"runId\": \"d690f96a-048f-4be4-b4cf-1313bd61b1fb\"\n        }\n      },\n      {\n        \"scheduleTime\": \"2025-03-25T12:00:00Z\",\n        \"actualTime\": \"2025-03-25T12:00:00.332018132Z\",\n        \"startWorkflowResult\": {\n          \"workflowId\": \"monitoring_schedule-2025-03-25T12:00:00Z\",\n          \"runId\": \"2320d2c0-5bf1-41ef-bfad-0d549329b910\"\n        }\n      }\n    ],\n    \"futureActionTimes\": [\n      \"2025-03-25T12:30:00Z\",\n      \"2025-03-25T13:00:00Z\",\n      \"2025-03-25T13:30:00Z\",\n      \"2025-03-25T14:00:00Z\",\n      \"2025-03-25T14:30:00Z\",\n      \"2025-03-25T15:00:00Z\",\n      \"2025-03-25T15:30:00Z\",\n      \"2025-03-25T16:00:00Z\",\n      \"2025-03-25T16:30:00Z\",\n      \"2025-03-25T17:00:00Z\"\n    ],\n    \"createTime\": \"2025-03-25T10:41:17.745377738Z\"\n  },\n  \"conflictToken\": \"AAAAAAAAAAE=\"\n}\n```\n\n### Minimal Reproduction\n\n<!-- \nModify our hello world templates to demonstrate:\n\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\n- Go: https://github.com/temporalio/money-transfer-project-template-go\n- Java: https://github.com/temporalio/money-transfer-project-template-java\n- PHP: https://github.com/temporalio/samples-php#samples\n-->\n\n### Environment/Versions\n\n<!-- Please complete the following information where relevant. -->\n\n- OS and processor: [e.g. M1 Mac, x86 Windows, Linux]\n- Temporal Version: 1.25.1\n- Are you using Docker or Kubernetes or building Temporal from source? Kubernetes\n\n### Additional context\n\n<!-- Add any other context about the problem here. -->","closedAt":null,"comments":[{"id":"IC_kwDOEujx186uuqGq","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Hello @jhecking!\n\nAre you still seeing this error? If so, can you please confirm that you are operating the Temporal Cluster yourself, on Kubernetes, running Temporal server v1.25.1? Have you tried upgrading the Temporal server to latest release?\n\nThat error most probably indicates an issue with your Temporal Cluster configuration, or a bug in the Temporal Server. In any case, this is not a TS SDK side bug.\n\nI think you may be able to get some more useful details by looking at your Temporal server-side logs.\n\nLet me give just a little bit of context here. Internal to the Temporal server, schedules are actually implemented themselves as Workflow executions. To be clear, that's a Workflow type defined by the server itself, not your own Workflow; the code of that Workflow is in Go, and they execute on the Temporal Cluster's _Worker nodes_.\n\nWhen you call `DescribeSchedule`, the server frontend node sends a query for each Schedule workflow to obtain fresh status. That is the query that is failing in the error message you're seeing. The server only allows up to a certain number of pending queries to a given Workflow execution - by default, I believe that maximum is one. The error message you are getting indicates that queries are being made in excess to that limit for a single workflow execution.\n\nThis may indicate that the Worker nodes of your cluster are underpowered, though I don't see why that would affect only that specific schedule. That and the fact that \"Once the schedule is in this state, we are getting this error when trying to describe the schedule\" makes it sound like there might be something wrong in that specific schedule definition that triggers a bug when the Schedule Workflow is replayed in the context of those queries.","createdAt":"2025-06-02T16:21:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1660#issuecomment-2931466666","viewerDidAuthor":false}],"createdAt":"2025-03-25T12:20:01Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1660,"reactionGroups":[],"state":"OPEN","title":"[Bug] RESOURCE_EXHAUSTED error while describing workflow schedule","updatedAt":"2025-06-02T16:21:50Z","url":"https://github.com/temporalio/sdk-typescript/issues/1660"}
