{"assignees":[{"id":"MDQ6VXNlcjI1MTI4OA==","login":"lorensr","name":"Loren ☺️","databaseId":0}],"author":{"id":"MDQ6VXNlcjI1MTI4OA==","is_bot":false,"login":"lorensr","name":"Loren ☺️"},"body":"Given that protobufjs has a global `module.roots` field that gets added to by `pbjs`-generated code, I think we could drop the `root` arg to our `Protobuf*PayloadConverter` classes. Instead, we would go through `module.roots.*` and use the first valid `root.lookup(messageName)`. \r\n\r\nThe user requirements changes for this working would be:\r\n\r\n## Removed\r\n\r\n- Must pass `root` arg to constructor\r\n- Must use custom data converter (because we can add proto to default converter)\r\n\r\n## Added\r\n\r\n- If there are duplicate message names, they must be the same type (since we may find either one first). (Alternatively, we could search in sorted order, and let users know that they should give the root with the version of the message we should use a name that's before others alphabetically.\r\n- Must use a compatible version of `protobufjs` (we're currently on `^6.11.2` but we could probably switch to `^6.0.0`) and a package manager that dedups (so the same code is run, so we share `module.roots` with them)\r\n- Must run `pbjs -t json-modules` to generate their `root.js`, and require `root.js` in their worker and workflow code.\r\n\r\n","closedAt":"2022-06-17T22:56:45Z","comments":[{"id":"IC_kwDOEujx185FGWHT","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"I worked on adding protobuf payload converters to default payload converter in the https://github.com/temporalio/sdk-typescript/tree/use-global branch, but we decided to not complete it. The issue was:\r\n\r\n- It requires importing `protobufjs/light`, which doubles the bundle size (.25 to .5 MB)\r\n- In order to not import ^ into bundles of those not using protobufs: \r\n  - the user has to import `protobufjs` into their workflow code (so in cases in which only protobufjs types are used, an extra import statement has to be added)\r\n  - we have do to some TBD hack to get webpack to not look at our import of `protobufjs`, but it to still work at runtime if the user imported `protobufjs`\r\n  \r\n  ","createdAt":"2022-06-17T22:56:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/548#issuecomment-1159291347","viewerDidAuthor":false}],"createdAt":"2022-03-19T03:16:30Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":{"number":6,"title":"1.0","description":"","dueOn":null},"number":548,"reactionGroups":[],"state":"CLOSED","title":"[Feature Request] Use protobufjs global for deserializing protobufs","updatedAt":"2022-06-17T22:56:45Z","url":"https://github.com/temporalio/sdk-typescript/issues/548"}
