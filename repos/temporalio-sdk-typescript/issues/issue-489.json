{"assignees":[],"author":{"id":"MDQ6VXNlcjI1MTI4OA==","is_bot":false,"login":"lorensr","name":"Loren ‚ò∫Ô∏è"},"body":"@idoshamun reported in https://github.com/temporalio/documentation/pull/917 that they needed to `npm i` instead of `npm i --production` (or `npm i --only=prod` or `NODE_ENV=production npm i`), which implies that we need to move at least one devDep to deps somewhere. I haven't repro'd yet. Ido‚Äîdo you have the error message, or remember which package it was in?","closedAt":"2022-02-24T23:33:48Z","comments":[{"id":"IC_kwDOEujx184-Or9Q","author":{"login":"idoshamun"},"authorAssociation":"NONE","body":"Here it is:\r\n```\r\n2022-02-15T20:51:37.521Z [INFO] [temporal_sdk_core] Registering worker task_queue=\"content-pipeline\"\r\nError: Cannot find module 'acorn'\r\nRequire stack:\r\n- /opt/app/node_modules/acorn-import-assertions/lib/index.js\r\n- /opt/app/node_modules/webpack/lib/javascript/JavascriptParser.js\r\n- /opt/app/node_modules/webpack/lib/javascript/JavascriptModulesPlugin.js\r\n- /opt/app/node_modules/webpack/lib/WebpackOptionsApply.js\r\n- /opt/app/node_modules/webpack/lib/webpack.js\r\n- /opt/app/node_modules/webpack/lib/index.js\r\n- /opt/app/node_modules/@temporalio/worker/lib/workflow/bundler.js\r\n- /opt/app/node_modules/@temporalio/worker/lib/worker.js\r\n- /opt/app/node_modules/@temporalio/worker/lib/index.js\r\n- /opt/app/src/temporal/worker.js\r\n- /opt/app/index.js\r\n    at Function.Module._resolveFilename (internal/modules/cjs/loader.js:880:15)\r\n    at Function.Module._load (internal/modules/cjs/loader.js:725:27)\r\n    at Module.require (internal/modules/cjs/loader.js:952:19)\r\n    at require (internal/modules/cjs/helpers.js:88:18)\r\n    at Object.<anonymous> (/opt/app/node_modules/acorn-import-assertions/lib/index.js:8:38)\r\n    at Module._compile (internal/modules/cjs/loader.js:1063:30)\r\n    at Object.Module._extensions..js (internal/modules/cjs/loader.js:1092:10)\r\n    at Module.load (internal/modules/cjs/loader.js:928:32)\r\n    at Function.Module._load (internal/modules/cjs/loader.js:769:14)\r\n    at Module.require (internal/modules/cjs/loader.js:952:19) {\r\n  code: 'MODULE_NOT_FOUND',\r\n  requireStack: [\r\n    '/opt/app/node_modules/acorn-import-assertions/lib/index.js',\r\n    '/opt/app/node_modules/webpack/lib/javascript/JavascriptParser.js',\r\n    '/opt/app/node_modules/webpack/lib/javascript/JavascriptModulesPlugin.js',\r\n    '/opt/app/node_modules/webpack/lib/WebpackOptionsApply.js',\r\n    '/opt/app/node_modules/webpack/lib/webpack.js',\r\n    '/opt/app/node_modules/webpack/lib/index.js',\r\n    '/opt/app/node_modules/@temporalio/worker/lib/workflow/bundler.js',\r\n    '/opt/app/node_modules/@temporalio/worker/lib/worker.js',\r\n    '/opt/app/node_modules/@temporalio/worker/lib/index.js',\r\n    '/opt/app/src/temporal/worker.js',\r\n    '/opt/app/index.js'\r\n  ]\r\n}\r\n```","createdAt":"2022-02-18T07:08:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/489#issuecomment-1044037456","viewerDidAuthor":false},{"id":"IC_kwDOEujx184-XHO8","author":{"login":"idoshamun"},"authorAssociation":"NONE","body":"Following James Watkins-Harvey advice on Slack (https://temporalio.slack.com/archives/CTRCR8RBP/p1645195758175629?thread_ts=1644943893.749649&cid=CTRCR8RBP), I managed to find the root cause.\r\nI used `workflowsPath` instead of `workflowBundle` which caused temporal to build my workflows in production.\r\n\r\nI somehow missed the point here:\r\nhttps://docs.temporal.io/docs/typescript/production-deploy#pre-build-code\r\n\r\nI think we can close this issue now.","createdAt":"2022-02-20T14:10:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/489#issuecomment-1046246332","viewerDidAuthor":false},{"id":"IC_kwDOEujx184-ajle","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"@idoshamun Glad it helped.\r\n\r\nIt might still be useful though to highlight this point in documentation. Using `workflowsPath` is essentially a \"development mode\", and implies that you need to install development dependencies.\r\n\r\nAlong the same line, it could be useful to make the dependency from @temporalio/worker to webpack a dev-dependency (see [here](https://github.com/temporalio/sdk-typescript/blob/817312d4059200c2c15a608282d159ad51679915/packages/worker/package.json#L35)). It would be much easier for people to understand the situation when they get a message saying they're missing webpack than some less known package down the road.","createdAt":"2022-02-21T18:46:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/489#issuecomment-1047148894","viewerDidAuthor":false},{"id":"IC_kwDOEujx184-cIzc","author":{"login":"idoshamun"},"authorAssociation":"NONE","body":"@mjameswh you're right.\r\nSee my PR here: https://github.com/temporalio/documentation/pull/930\r\nHopefully it will get reviewed and merged soon","createdAt":"2022-02-22T08:56:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/489#issuecomment-1047563484","viewerDidAuthor":false},{"id":"IC_kwDOEujx184-ewmp","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"We'd like `workflowsPath` to work in prod, so let's add acorn and whatever else we need. \r\n\r\nMy repro gives this output:\r\n\r\n```\r\ngit clone https://github.com/temporalio/samples-typescript\r\ncd samples-typescript/hello-world\r\nnpm i --production\r\nnpm run build\r\nnode lib/worker.js\r\n```\r\n\r\n```\r\n2022-02-22T21:40:25.170Z [ERROR] ERROR in ./node_modules/@temporalio/common/lib/time.js 8:29-42\r\n2022-02-22T21:40:25.170Z [ERROR] Module not found: Error: Can't resolve 'ms' in '/Users/me/gh/samples-typescript/hello-world/node_modules/@temporalio/common/lib'\r\n2022-02-22T21:40:25.170Z [ERROR] resolve 'ms' in '/Users/me/gh/samples-typescript/hello-world/node_modules/@temporalio/common/lib'\r\n2022-02-22T21:40:25.170Z [ERROR]   Parsed request is a module\r\n2022-02-22T21:40:25.170Z [ERROR]   using description file: /Users/me/gh/samples-typescript/hello-world/node_modules/@temporalio/common/package.json (relative path: ./lib)\r\n2022-02-22T21:40:25.170Z [ERROR]     Field 'browser' doesn't contain a valid alias configuration\r\n2022-02-22T21:40:25.170Z [ERROR]     resolve as module\r\n2022-02-22T21:40:25.170Z [ERROR]       looking for modules in /Users/me/gh/samples-typescript/hello-world/node_modules\r\n2022-02-22T21:40:25.170Z [ERROR]         single file module\r\n2022-02-22T21:40:25.170Z [ERROR]           using description file: /Users/me/gh/samples-typescript/hello-world/package.json (relative path: ./node_modules/ms)\r\n2022-02-22T21:40:25.170Z [ERROR]             no extension\r\n2022-02-22T21:40:25.170Z [ERROR]               Field 'browser' doesn't contain a valid alias configuration\r\n2022-02-22T21:40:25.170Z [ERROR]               /Users/me/gh/samples-typescript/hello-world/node_modules/ms doesn't exist\r\n2022-02-22T21:40:25.170Z [ERROR]             .ts\r\n2022-02-22T21:40:25.170Z [ERROR]               Field 'browser' doesn't contain a valid alias configuration\r\n2022-02-22T21:40:25.170Z [ERROR]               /Users/me/gh/samples-typescript/hello-world/node_modules/ms.ts doesn't exist\r\n2022-02-22T21:40:25.170Z [ERROR]             .js\r\n2022-02-22T21:40:25.170Z [ERROR]               Field 'browser' doesn't contain a valid alias configuration\r\n2022-02-22T21:40:25.170Z [ERROR]               /Users/me/gh/samples-typescript/hello-world/node_modules/ms.js doesn't exist\r\n2022-02-22T21:40:25.170Z [ERROR]         /Users/me/gh/samples-typescript/hello-world/node_modules/ms doesn't exist\r\n2022-02-22T21:40:25.170Z [ERROR]  @ ./node_modules/@temporalio/common/lib/index.js 25:13-30\r\n2022-02-22T21:40:25.170Z [ERROR]  @ ./node_modules/@temporalio/workflow/lib/worker-interface.js 9:17-46\r\n2022-02-22T21:40:25.170Z [ERROR]  @ ../../../../../src/main.js 1:0-68 4:0-19 5:0-18 16:0-15\r\n2022-02-22T21:40:25.170Z [ERROR] \r\n2022-02-22T21:40:25.170Z [ERROR] webpack 5.69.1 compiled with 1 error in 373 ms\r\nError: Webpack finished with errors, if you're unsure what went wrong, visit our troubleshooting page at https://docs.temporal.io/docs/typescript/troubleshooting#webpack-errors\r\n```\r\n\r\n`ms` is a dep of `@temporalio/common`:\r\n\r\n<img width=\"724\" alt=\"image\" src=\"https://user-images.githubusercontent.com/251288/155225608-8a77cbed-a161-46b0-9785-9e9173d1b171.png\">\r\n\r\nBut it doesn't appear in `node_modules/ms` until I run `npm i` (without --production).\r\n\r\nNot sure when I'll get to this, but happy to review a PR if anyone would like to contribute! üòä","createdAt":"2022-02-22T21:57:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/489#issuecomment-1048250793","viewerDidAuthor":false},{"id":"IC_kwDOEujx184-g0ih","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"I was wrong. Acorn is a regular dependency of webpack, not a dev dependency. The problem isn't there.\r\n\r\nBut let's focus on the issue with `ms` for now. With `npm i`, I get the following copies of `ms`:\r\n\r\n```\r\nnode_modules/@temporalio/client/node_modules/ms\r\nnode_modules/@temporalio/common/node_modules/ms\r\nnode_modules/@temporalio/worker/node_modules/ms\r\nnode_modules/ms\r\n```\r\n\r\nBut with `npm i --production`, I get only get the followings:\r\n\r\n```\r\nnode_modules/@temporalio/client/node_modules/ms\r\nnode_modules/@temporalio/common/node_modules/ms\r\nnode_modules/@temporalio/worker/node_modules/ms\r\n```\r\n\r\nSo npm hoisted `ms` from some development package in the first case (actually, from `nodemon -> debug -> ms`), but didn't dedup `ms` (because `debug@4.3.3` require exact version `ms@2.1.2`, which is incompatible with requirement `ms@^2.1.3` from `@temporalio/common`). Now, when giving `--production`, npm actually calculates its ideal dependency tree including _all_ dependencies (ie. including dev and optional dependencies), then prune (if requested) dev and optional dependencies at a very late stage. That explains why `ms` is not getting hoisted/dedup with `npm i --production`.\r\n\r\nOne way or another, both are valid given Node's module resolution algorithm. It isn't working with our webpack bundler, however, because our default value for `resolve.modules` only includes absolute (see [here](https://github.com/temporalio/sdk-typescript/blob/fba4d46b668ef9b0feec0d953b359ab10adb9e01/packages/worker/src/workflow/bundler.ts#L106-L108) and  [here](https://github.com/temporalio/sdk-typescript/blob/fba4d46b668ef9b0feec0d953b359ab10adb9e01/packages/worker/src/worker-options.ts#L295-L299)). To get webpack to resolve dependencies using an algorithm compatible with Node's algorithm, we must also include the string  'node_modules' in `resolve.modules`.\r\n\r\nFor example, if I manually specify `nodeModulesPaths` in `hello-world/src/worker.ts`, _and add 'node_modules' to the array_, as follow:\r\n\r\n```\r\n  const worker = await Worker.create({\r\n    workflowsPath: require.resolve('./workflows'),\r\n    nodeModulesPaths: [`${__dirname}/../node_modules/`, 'node_modules'],\r\n    activities,\r\n    taskQueue: 'tutorial',\r\n  });\r\n```\r\n\r\nthen I no longer have any issue executing after `npm i --production`. Turns out that the missing `acorn` was similarly hiding inside `node_modules/webpack/node_modules/acorn`, there again because of a version incompatibility between a dev dependency and a runtime dependency.\r\n\r\nSo we simply add `node_modules` to the provided `nodeModulesPaths`, and voil√†! I shall submit a PR for this soon.","createdAt":"2022-02-23T13:38:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/489#issuecomment-1048791201","viewerDidAuthor":false}],"createdAt":"2022-02-17T23:15:59Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":489,"reactionGroups":[],"state":"CLOSED","title":"[Bug] `npm i --production` insufficient","updatedAt":"2022-02-24T23:33:48Z","url":"https://github.com/temporalio/sdk-typescript/issues/489"}
