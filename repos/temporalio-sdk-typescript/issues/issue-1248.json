{"assignees":[],"author":{"id":"MDQ6VXNlcjEzMTgxNTg=","is_bot":false,"login":"atomicleopard","name":"Atomic Leopard"},"body":"### What are you really trying to do?\r\n\r\nI have a typescript server that is both a worker and client of a temporal cluster deployed into an Azure Kubernetes cluster.\r\nThe temporal cluster uses Azure AD for authorised access, and I'm required to send a JWT for access `Authorization: Bearer <access-token>`\r\nI have been unable to get the Workflow client to successfully connect\r\n\r\n### Describe the bug\r\n\r\nI believe that the ChannelCredentials, and hence the CallCredentials are just not applied to the Connection the way I am using the typescript library.\r\n\r\nI have tried multiple different approaches, but have found it hard to debug. I have also not found many good examples, but I believe the below approaches are all valid methods that are expected to work.\r\n\r\nMethod 1 - createFromGoogleCredential\r\n\r\n```typescript\r\nconst client: CurrentOAuth2Client = {\r\n  getRequestHeaders: async () => {\r\n    const { access_token } = await auth.getAccessToken()\r\n    return { authorization: `Bearer ${access_token}` }\r\n  },\r\n}\r\nconst creds: ChannelCredentials = credentials.combineChannelCredentials(\r\n  credentials.createSsl(),\r\n  CallCredentials.createFromGoogleCredential(client),\r\n)\r\nconst connection = await Connection.connect({ address: temporalHost, credentials: creds })\r\n```\r\n\r\nMethod 2 - createFromMetadataGenerator\r\n\r\n```typescript\r\nconst callCredentials: CallMetadataGenerator = async (options: CallMetadataOptions, cb: (err: Error | null, metadata?: any) => void) => {\r\n  try {\r\n    const { access_token } = await auth.getAccessToken()\r\n    const meta = new Metadata()\r\n    meta.set('authorization', `Bearer ${access_token}`)\r\n    cb(null, meta)\r\n  } catch (e) {\r\n    TemporalClientModule.logger.error(`Failed Setting authorization header from access token: ${e.message}`)\r\n    cb(e, null)\r\n  }\r\n}\r\nconst creds: ChannelCredentials = ChannelCredentials\r\n                                 .createSsl()\r\n                                 .compose(CallCredentials.createFromMetadataGenerator(callCredentials as any))\r\nconst connection = await Connection.connect({ address: temporalHost, credentials: creds })\r\n```\r\n\r\n### Minimal Reproduction\r\n\r\nUnfortunately I am unable to reproduce or create a reproduction locally - it is documented as far as i can tell that when not using TLS, no metadata headers will be sent.\r\n\r\nWhat I can see both locally and remotely, if I add an interceptor and log the channel and call credentials on a request there is nothing there.\r\n```typescript\r\n const authorizationInterceptor: Interceptor = (\r\n  options: InterceptorOptions,\r\n  nextCall: NextCall,\r\n): InterceptingCall => {\r\n  TemporalClientModule.logger.log({\r\n    msg: 'Temporal interceptor',\r\n    options,\r\n    credentialSupplier: options.credentials,\r\n  })\r\n  return new InterceptingCall(nextCall(options))\r\n}\r\n```\r\nWhich logs \r\n```json\r\n{\r\n\"options\": {\r\n    \"credentials\": {},\r\n    \"interceptors\": [null, null ],\r\n    \"deadline\": 1694685239159,\r\n    \"method_definition\": {\r\n      \"path\": \"/temporal.api.workflowservice.v1.WorkflowService/GetSystemInfo\",\r\n      \"requestStream\": false,\r\n      \"responseStream\": false\r\n    },\r\n  }\r\n}\r\n```\r\n\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\n### Environment/Versions\r\n\r\n@temporalio/client - 1.8.4\r\n\r\n### Additional context\r\n\r\nI believe the issue comes from [this line](https://github.com/temporalio/sdk-typescript/blob/e769006fca5dc2817be79b3250b2757f46454bce/packages/client/src/connection.ts#L117). In essence I believe that this removes credentials from the resolved options.\r\n\r\n```typescript\r\nconst { tls: tlsFromConfig, credentials, ...rest } = options || {};\r\n// ...\r\nif (tls) {\r\n// ...\r\n} else {\r\n  return rest;\r\n}\r\n```\r\n\r\n<!-- Add any other context about the problem here. -->\r\n","closedAt":"2023-10-17T21:18:24Z","comments":[{"id":"IC_kwDOEujx185mzJp3","author":{"login":"atomicleopard"},"authorAssociation":"NONE","body":"Just an update, I have only been able to produce one viable workaround:\r\n\r\n1. Create the connection with static metadata with a valid Authorization header - this obviously is only valid for a limited duration\r\n2. Exclude credentials from the initial connection creation\r\n3. Use an interceptor to add a header on call start to override the initial access_token after expiry\r\n\r\n```typescript\r\nconst connection = Connection.connect({\r\n   address,\r\n   interceptors: [makeGrpcRetryInterceptor(defaultGrpcRetryOptions()), authorizationInterceptor],\r\n   metadata: {\r\n      authorization: `Bearer ${access_token}`,\r\n   },\r\n})\r\n```\r\n\r\n```typescript\r\nconst authorizationInterceptor: Interceptor = (options: InterceptorOptions, nextCall: NextCall): InterceptingCall => {\r\n   return new InterceptingCall(nextCall(options), {\r\n      start: (metadata: Metadata, listener: InterceptingListener, next: (metadata: MetadataImpl, listener: InterceptingListener | Listener) => void) => {\r\n         auth.getAccessToken().then(({ access_token }) => {\r\n            metadata.set('authorization', `Bearer ${access_token}`)\r\n            next(metadata, listener)\r\n         })\r\n      },\r\n   })\r\n}\r\n```\r\n\r\nI tried using patch-package on the above destructuring, but that wasn't enough to get the provided credentials to work, so I think there are some nuanced problems here. I also don't know what proportion is down to how authorisation is implemented in our temporal cluster, but hopefully this report is helpful in improving the library or for someone who needs a similar workaround.\r\n","createdAt":"2023-09-19T01:09:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1248#issuecomment-1724684919","viewerDidAuthor":false}],"createdAt":"2023-09-14T11:56:22Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1248,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"[Bug] Unable to provide Authorization header for a client Connection - CallCredentials does not appear to work","updatedAt":"2023-10-17T21:18:24Z","url":"https://github.com/temporalio/sdk-typescript/issues/1248"}
