{"assignees":[],"author":{"id":"MDQ6VXNlcjE5MDA4NzY=","is_bot":false,"login":"jhecking","name":"Jan Hecking"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\nI'm testing a patched workflow, by replaying an \"unpatched\" workflow history, to verify that it does not fail with a non-determinism error. To get the workflow history, I'm using the `fetchHistory()` function of the workflow client. I persist the history object to disk using `JSON.serialize`:\r\n\r\n```typescript\r\nconst history = await client.workflow.getHandle('wfId').fetchHistory()\r\nawait fs.writeFile('./unpatched-workflow-history.json', JSON.stringify(history))\r\n```\r\n\r\nThen I add another unit tests that does nothing but load the serialized workflow history from disk (using `JSON.parse`) and replay it, e.g.\r\n\r\n```typescript\r\nit('should replay an unpatched workflow history', async function () {\r\n  const history = JSON.parse((await fs.readFile('./unpatched-workflow-history.json')).toString())\r\n  Worker.runReplayHistory(DefaultWorkerOptions, history)\r\n})\r\n```\r\n\r\nThis fails with the following error:\r\n> Error: fromProto3JSONToInternalRepresentation: google.protobuf.Timestamp must be a string but got object\r\n\r\nIt took me a while to figure out the problem with Antonio's help: https://temporalio.slack.com/archives/C01DKSMU94L/p1708310456162399?thread_ts=1708279751.707509&cid=C01DKSMU94L\r\n\r\nI thought I was following the docs here: https://docs.temporal.io/dev-guide/typescript/testing#replay. In particular, this example:\r\n\r\n```typescript\r\nconst filePath = './history_file.json';\r\nconst history = await JSON.parse(fs.promises.readFile(filePath, 'utf8'));\r\nawait Worker.runReplayHistory(\r\n  {\r\n    workflowsPath: require.resolve('./your/workflows'),\r\n  },\r\n  history,\r\n);\r\n```\r\n\r\nWhat I didn't realize however, and what I don't think is very obvious, is that the JSON format returned by the Web UI and the Temporal CLI differs from the format returned by the `fetchHistory()` method.\r\n\r\n### Describe the solution you'd like\r\n\r\nWhat I eventually found out is that I can use the `History.fromObject` function to turn the JSON object loaded from disk back into a `History` object that's accepted by `Worker.runReplayHistory`, e.g. this works:\r\n\r\n```typescript\r\nit('should replay an unpatched workflow history', async function () {\r\n  const history = History.fromObject(JSON.parse((await fs.readFile('./unpatched-workflow-history.json')).toString()))\r\n  Worker.runReplayHistory(DefaultWorkerOptions, history)\r\n})\r\n```\r\n\r\nI also noticed that the `runReplayHistory` method already has some built-in logic to determine whether the `history` input value is a JSON object (from the Web UI or CLI) or a `History` object. What would be nice is if it could also detect where it's being passed a `History` object serialized into a JSON object. It could just use `History.fromObject` in that case, just like I am doing now, as IMHO this distinction between the different JSON formats is very easy to miss and the conversion could be handled automatically for the user.\r\n\r\n### Additional context\r\n\r\nFiling this feature request on the recommendation of Antonio as per our Slack conversation: https://temporalio.slack.com/archives/C01DKSMU94L/p1708310456162399?thread_ts=1708279751.707509&cid=C01DKSMU94L","closedAt":null,"comments":[{"id":"IC_kwDOEujx1850f4L2","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"You can’t use plain JSON serialization on histories, they’re supposed to be encoded in a proto JSON format.\r\n\r\nif you want to save a history you downloaded with a client you’ll need to use https://www.npmjs.com/package/proto3-json-serializer. runReplayHistory supports JSON histories in that format.","createdAt":"2024-02-20T15:51:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1362#issuecomment-1954513654","viewerDidAuthor":false},{"id":"IC_kwDOEujx1850lEEu","author":{"login":"jhecking"},"authorAssociation":"CONTRIBUTOR","body":"Ok. Like I said, the way I've solved this problem is that I use `History.fromObject()` to convert the serialised history back into a `History` object before replaying it.","createdAt":"2024-02-21T04:32:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1362#issuecomment-1955873070","viewerDidAuthor":false},{"id":"IC_kwDOEujx186N2Nbp","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"I recently added a `historyToJSON()` function in common's `proto-utils.ts`, to properly encode an existing History object to JSON, for internal purpose.\r\n\r\nThere's definitely user-side use cases for this, and implementing this correctly is far from trivial, due to bugs in `proto3-json-serializer`. We should therefore expose that function explicitly as part of some \"Temporal Utils\" API.","createdAt":"2024-09-27T18:02:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1362#issuecomment-2379798249","viewerDidAuthor":false},{"id":"IC_kwDOEujx1868WgbJ","author":{"login":"kp-eugene-kulabuhovs"},"authorAssociation":"NONE","body":"@jhecking could you provide a full code example? I'm not sure where you got the `History.fromObject()` function from. As a workaround for this issue I've tried downloading history from UI base64 encoded - it worked, but not as readable.","createdAt":"2025-08-06T12:44:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1362#issuecomment-3160016585","viewerDidAuthor":false}],"createdAt":"2024-02-19T12:26:50Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1362,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"OPEN","title":"[Feature Request] Worker.runReplayHistory() should accept a serialized History object fetched using fetchHistory()","updatedAt":"2025-08-06T12:44:26Z","url":"https://github.com/temporalio/sdk-typescript/issues/1362"}
