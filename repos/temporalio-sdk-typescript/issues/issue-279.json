{"assignees":[{"id":"MDQ6VXNlcjUyMzA0","login":"bergundy","name":"Roey Berman","databaseId":0}],"author":{"id":"MDQ6VXNlcjY3NjQ5NTc=","is_bot":false,"login":"swyxio","name":"swyx.io"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\nRight now, we have no way to support \"pure ESM\" node modules. our Webpack config is hardcoded to commonjs.\r\n\r\nSo @vkarpov15 [found](https://github.com/temporalio/samples-node/commit/c8a16cd888066c632f60a7531f34d46cbb239e93#comments) that importing `node-fetch@3` had an issue and had to downgrade to `node-fetch@2`.\r\n\r\nover time, this will increasingly be a problem, as more and more of the Node ecosystem [goes pure ESM](https://blog.sindresorhus.com/get-ready-for-esm-aa53530b3f77).\r\n\r\n### Describe the solution you'd like\r\n\r\n\"smooth\" bundling solution that addresses ESM and CJS. ","closedAt":"2021-10-15T16:11:28Z","comments":[{"id":"IC_kwDOEujx1843rIOP","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I wasnâ€™t aware es modules are not supported, they should be supported in webpack and in node.\r\nWhat does the error message look like?","createdAt":"2021-10-05T04:33:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-934052751","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843s9Oa","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"repro: https://github.com/lorensr/samples-node/tree/fetch\r\n\r\n```\r\ncd activities-examples\r\nnpm i\r\nnpm start\r\n```\r\n\r\n```\r\n> temporal-http@0.1.0 start\r\n> ts-node src/worker.ts\r\n\r\n/Users/me/gh/samples-node/activities-examples/src/activities/cancellable-fetch.ts:8\r\n  if (contentLengthHeader === null) {\r\n                                     ^\r\nError [ERR_REQUIRE_ESM]: require() of ES Module /Users/me/gh/samples-node/activities-examples/node_modules/node-fetch/src/index.js from /Users/me/gh/samples-node/activities-examples/src/activities/cancellable-fetch.ts not supported.\r\nInstead change the require of index.js in /Users/me/gh/samples-node/activities-examples/src/activities/cancellable-fetch.ts to a dynamic import() which is available in all CommonJS modules.\r\n    at Object.<anonymous> (/Users/me/gh/samples-node/activities-examples/src/activities/cancellable-fetch.ts:8:38)\r\n    at Module.m._compile (/Users/me/gh/samples-node/activities-examples/node_modules/ts-node/dist/index.js:704:29)\r\n    at Object.require.extensions.<computed> [as .ts] (/Users/me/gh/samples-node/activities-examples/node_modules/ts-node/dist/index.js:706:16)\r\n    at Object.<anonymous> (/Users/me/gh/samples-node/activities-examples/src/activities/index.ts:10:27)\r\n    at Module.m._compile (/Users/me/gh/samples-node/activities-examples/node_modules/ts-node/dist/index.js:704:29)\r\n    at Object.require.extensions.<computed> [as .ts] (/Users/me/gh/samples-node/activities-examples/node_modules/ts-node/dist/index.js:706:16)\r\n    at Object.<anonymous> (/Users/me/gh/samples-node/activities-examples/src/worker.ts:27:33)\r\n    at Module.m._compile (/Users/me/gh/samples-node/activities-examples/node_modules/ts-node/dist/index.js:704:29)\r\n    at Object.require.extensions.<computed> [as .ts] (/Users/me/gh/samples-node/activities-examples/node_modules/ts-node/dist/index.js:706:16)\r\n    at main (/Users/me/gh/samples-node/activities-examples/node_modules/ts-node/dist/bin.js:237:16)\r\n    at Object.<anonymous> (/Users/me/gh/samples-node/activities-examples/node_modules/ts-node/dist/bin.js:350:5) {\r\n  code: 'ERR_REQUIRE_ESM'\r\n}\r\n```","createdAt":"2021-10-05T15:48:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-934531994","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843s_En","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Could this be a ts node issue? Did you try with node?","createdAt":"2021-10-05T15:57:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-934539559","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843s_Zc","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"```\r\n$ node lib/worker.js\r\n/Users/me/gh/samples-node/activities-examples/lib/activities/cancellable-fetch.js:8\r\nconst node_fetch_1 = __importDefault(require(\"node-fetch\"));\r\n                                     ^\r\n\r\nError [ERR_REQUIRE_ESM]: require() of ES Module /Users/me/gh/samples-node/activities-examples/node_modules/node-fetch/src/index.js from /Users/me/gh/samples-node/activities-examples/lib/activities/cancellable-fetch.js not supported.\r\nInstead change the require of index.js in /Users/me/gh/samples-node/activities-examples/lib/activities/cancellable-fetch.js to a dynamic import() which is available in all CommonJS modules.\r\n    at Object.<anonymous> (/Users/me/gh/samples-node/activities-examples/lib/activities/cancellable-fetch.js:8:38)\r\n    at Object.<anonymous> (/Users/me/gh/samples-node/activities-examples/lib/activities/index.js:10:27)\r\n    at Object.<anonymous> (/Users/me/gh/samples-node/activities-examples/lib/worker.js:27:33) {\r\n  code: 'ERR_REQUIRE_ESM'\r\n}\r\n```","createdAt":"2021-10-05T15:58:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-934540892","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843tFPU","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"What happens if you just run node lib/activities.js?\r\nIf you get the same error this is probably an issue with node fetch","createdAt":"2021-10-05T16:25:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-934564820","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843tFfw","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"You can also confirm by trying to import a different es module","createdAt":"2021-10-05T16:26:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-934565872","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843tUhE","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"> What happens if you just run node lib/activities.js?\r\n\r\nSame error. Got it working by having TypeScript output ESM, but that results in a new error from the worker:\r\n\r\nrepro: https://github.com/lorensr/samples-node/tree/fetch-esm\r\n\r\n\r\n```\r\n$ node lib/worker.js\r\n(node:12420) ExperimentalWarning: stream/web is an experimental feature. This feature could change at any time\r\n(Use `node --trace-warnings ...` to show where the warning was created)\r\n2021-10-05T17:37:34.763Z [INFO] asset main.js 4.24 KiB [emitted] (name: main)\r\n2021-10-05T17:37:34.764Z [INFO] runtime modules 274 bytes 1 module\r\n2021-10-05T17:37:34.764Z [INFO] ../../../../../src/main.js 704 bytes [built] [code generated]\r\n2021-10-05T17:37:34.764Z [INFO] webpack 5.54.0 compiled successfully in 73 ms\r\n2021-10-05T17:37:34.782Z [INFO] Worker state changed { state: 'RUNNING' }\r\n2021-10-05T17:37:34.807Z [ERROR] Failed to activate workflow {\r\n  runId: '1fe38040-3e24-403c-830d-3190b0ab8309',\r\n  error: ReferenceError: require is not defined\r\n      at eval (webpack-internal:///../../../../../src/main.js:2:13)\r\n      at Object.../../../../../src/main.js (workflow-isolate:20:1)\r\n      at workflow-isolate:47:60\r\n      at workflow-isolate:50:12\r\n      at (<isolated-vm boundary>)\r\n      at getContext (/Users/me/gh/samples-node/activities-examples/node_modules/@temporalio/worker/lib/isolate-context-provider.js:25:22),\r\n  workflowExists: false\r\n}\r\n2021-10-05T17:37:44.808Z [ERROR] Failed to activate workflow {\r\n  runId: '1fe38040-3e24-403c-830d-3190b0ab8309',\r\n  error: ReferenceError: require is not defined\r\n      at eval (webpack-internal:///../../../../../src/main.js:2:13)\r\n      at Object.../../../../../src/main.js (workflow-isolate:20:1)\r\n      at workflow-isolate:47:60\r\n      at workflow-isolate:50:12\r\n      at (<isolated-vm boundary>)\r\n      at getContext (/Users/me/gh/samples-node/activities-examples/node_modules/@temporalio/worker/lib/isolate-context-provider.js:25:22),\r\n  workflowExists: false\r\n}\r\n```\r\n","createdAt":"2021-10-05T17:45:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-934627396","viewerDidAuthor":false},{"id":"IC_kwDOEujx184318Kq","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Interesting, webpack supports both commonjs and esm.\r\nLooks like it's the dynamic loading that's causing these issues.","createdAt":"2021-10-06T18:45:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-936886954","viewerDidAuthor":false},{"id":"IC_kwDOEujx1844Kzyr","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Moved out of the beta milestone.","createdAt":"2021-10-13T14:21:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-942357675","viewerDidAuthor":false},{"id":"IC_kwDOEujx1844OZ4X","author":{"login":"schickling"},"authorAssociation":"NONE","body":"Running into the same problem when I've set ` \"type\": \"module\",` in my `package.json` (which is become the default for new codebases).\r\n\r\nThis will also require the following code change:\r\n\r\n```ts\r\n  const workflowsPath = new URL('./workflows.js', import.meta.url).toString().replace(/^file:\\/\\//, '')\r\n  // const workflowsPath = require.resolve('./workflows.js') // instead of this\r\n  const worker = await Worker.create({\r\n    workflowsPath,\r\n```","createdAt":"2021-10-14T12:16:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-943300119","viewerDidAuthor":false},{"id":"IC_kwDOEujx1844P9zK","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"We should probably support `URL` in as a param to workflowsPath.\r\nI'll look into why webpack is failing.\r\nLooks like ts-node also doesn't work well with modules.","createdAt":"2021-10-14T20:33:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-943709386","viewerDidAuthor":false},{"id":"IC_kwDOEujx1844QMrs","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I've hacked away until I finally got webpack to support ESM.\r\nMy current solution feels a bit too hacky though.\r\nI'll keep working on it until I find a good solution.","createdAt":"2021-10-14T22:02:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-943770348","viewerDidAuthor":false},{"id":"IC_kwDOEujx1844Q9UI","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"After cleaning up, I realized it was actually pretty easy to support this.\r\nNote that with ESM imports the [file extension is mandatory](https://nodejs.org/api/esm.html#esm_mandatory_file_extensions) and I couldn't get it running with `ts-node`.\r\nAFAICT this is `ts-node` support is still WIP, see https://github.com/TypeStrong/ts-node/issues/1007.\r\n\r\nI considered supporting URLs in `workflowsPath` and `nodeModulesPaths` but I think there's not that much value in it.\r\n\r\n```ts\r\nconst workflowsPath = new URL('./workflows.js', import.meta.url).pathname;\r\n```","createdAt":"2021-10-15T04:09:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-943969544","viewerDidAuthor":false},{"id":"IC_kwDOEujx1844Q_hN","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Got it working with `ts-node` esm loader by changing workflowPath to:\r\n```ts\r\n// support running both complied code and ts-node/esm loader\r\nconst workflowsPath = new URL(`./workflows${path.extname(import.meta.url)}`, import.meta.url).pathname;\r\n```\r\n\r\n```bash\r\nnode --experimental-specifier-resolution=node --loader ts-node/esm src/worker.ts\r\n```","createdAt":"2021-10-15T04:33:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-943978573","viewerDidAuthor":false},{"id":"IC_kwDOEujx1844RA3Y","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Sample can be found here: https://github.com/temporalio/samples-node/compare/esm?expand=1","createdAt":"2021-10-15T04:36:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-943984088","viewerDidAuthor":false},{"id":"IC_kwDOEujx1844RQtZ","author":{"login":"schickling"},"authorAssociation":"NONE","body":"Thanks for pushing this forward @bergundy ðŸš€ ","createdAt":"2021-10-15T06:59:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-944048985","viewerDidAuthor":false},{"id":"IC_kwDOEujx1844Ssbw","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"No problem, better now than later :)","createdAt":"2021-10-15T16:13:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-944424688","viewerDidAuthor":false},{"id":"IC_kwDOEujx185GQyvm","author":{"login":"gajus"},"authorAssociation":"NONE","body":"This does work, but I am getting a warning about missing sourcemaps.\r\n\r\n```\r\n2022-07-08T10:11:29.956Z [INFO] WARNING in ./node_modules/@temporalio/workflow/lib/workflow.js\r\n2022-07-08T10:11:29.956Z [INFO] Module Warning (from ./node_modules/source-map-loader/dist/cjs.js):\r\n2022-07-08T10:11:29.956Z [INFO] Failed to parse source map from '/Users/gajus/Documents/dev/gajus/repchad/node_modules/@temporalio/workflow/src/workflow.ts' file: Error: ENOENT: no such file or directory, open '/Users/gajus/Documents/dev/gajus/repchad/node_modules/@temporalio/workflow/src/workflow.ts'\r\n2022-07-08T10:11:29.956Z [INFO] Error: Failed to parse source map from '/Users/gajus/Documents/dev/gajus/repchad/node_modules/@temporalio/workflow/src/workflow.ts' file: Error: ENOENT: no such file or directory, open '/Users/gajus/Documents/dev/gajus/repchad/node_modules/@temporalio/workflow/src/workflow.ts'\r\n2022-07-08T10:11:29.956Z [INFO]     at fetchFromFilesystem (/Users/gajus/Documents/dev/gajus/repchad/node_modules/source-map-loader/dist/utils.js:129:11)\r\n2022-07-08T10:11:29.956Z [INFO]     at runNextTicks (node:internal/process/task_queues:60:5)\r\n2022-07-08T10:11:29.956Z [INFO]     at processImmediate (node:internal/timers:442:9)\r\n2022-07-08T10:11:29.956Z [INFO]     at async fetchFromURL (/Users/gajus/Documents/dev/gajus/repchad/node_modules/source-map-loader/dist/utils.js:239:9)\r\n2022-07-08T10:11:29.956Z [INFO]     at async /Users/gajus/Documents/dev/gajus/repchad/node_modules/source-map-loader/dist/index.js:105:11\r\n2022-07-08T10:11:29.956Z [INFO]     at async Promise.all (index 0)\r\n2022-07-08T10:11:29.956Z [INFO]     at async Object.loader (/Users/gajus/Documents/dev/gajus/repchad/node_modules/source-map-loader/dist/index.js:89:27)\r\n2022-07-08T10:11:29.956Z [INFO]  @ ./node_modules/@temporalio/workflow/lib/index.js 93:13-34\r\n2022-07-08T10:11:29.956Z [INFO]  @ ./src/workflows.ts 1:0-55 2:19-34\r\n2022-07-08T10:11:29.956Z [INFO]  @ ./src/workflows-entrypoint-bce092c5-4064-45b4-9502-b007ae936111.js\r\n```\r\n\r\nNot entirely clear what is the fix.","createdAt":"2022-07-08T10:12:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-1178807270","viewerDidAuthor":false},{"id":"IC_kwDOEujx185GSRfW","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"This will be fixed in the next release, coming soon.","createdAt":"2022-07-08T17:00:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/279#issuecomment-1179195350","viewerDidAuthor":false}],"createdAt":"2021-10-04T18:10:21Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":279,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"[Feature Request] Plan for supporting npm modules that require ESM, eg node-fetch","updatedAt":"2022-07-08T17:00:14Z","url":"https://github.com/temporalio/sdk-typescript/issues/279"}
