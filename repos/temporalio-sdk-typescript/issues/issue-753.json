{"assignees":[],"author":{"id":"MDQ6VXNlcjI4MDY4OTc3","is_bot":false,"login":"Irvenae","name":"Irven Aelbrecht"},"body":"### What are you really trying to do?\r\n\r\nRun a test in vscode (ideally with breakpoints) using the test framework.\r\n\r\n### Describe the bug\r\n\r\nThe test framework is behaving flaky, sometimes it works (haven't tested the breakpoints), sometimes I get a segfault. This is the trace\r\n\r\nPID 79075 received SIGSEGV for address: 0x0\r\n0   segfault-handler.node               0x000000010d15d458 _ZL16segfault_handleriP9__siginfoPv + 272\r\n1   libsystem_platform.dylib            0x00000001b63384e4 _sigtramp + 56\r\n2   node                                0x0000000100611a88 _ZN4node6loaderL23ImportModuleDynamicallyEN2v85LocalINS1_7ContextEEENS2_INS1_14ScriptOrModuleEEENS2_INS1_6StringEEENS2_INS1_10FixedArrayEEE + 236\r\n3   node                                0x00000001008bb67c _ZN2v88internal7Isolate38RunHostImportModuleDynamicallyCallbackENS0_6HandleINS0_6ScriptEEENS2_INS0_6ObjectEEENS0_11MaybeHandleIS5_EE + 248\r\n4   node                                0x0000000100c30e14 _ZN2v88internal25Runtime_DynamicImportCallEiPmPNS0_7IsolateE + 396\r\n5   node                                0x0000000100f40a04 Builtins_CEntry_Return1_DontSaveFPRegs_ArgvInRegister_NoBuiltinExit + 100\r\n6   node                                0x0000000100fcedd8 Builtins_CallRuntimeHandler + 88\r\n7   node                                0x0000000100ed4418 Builtins_InterpreterEntryTrampoline + 248\r\n8   node                                0x0000000100ed4418 Builtins_InterpreterEntryTrampoline + 248\r\n9   node                                0x0000000100ed4418 Builtins_InterpreterEntryTrampoline + 248\r\n10  node                                0x0000000100ed4418 Builtins_InterpreterEntryTrampoline + 248\r\n11  node                                0x0000000100f86e00 Builtins_PromiseConstructor + 2176\r\n12  node                                0x0000000100ed1650 Builtins_JSBuiltinsConstructStub + 368\r\n13  node                                0x0000000100fcf770 Builtins_ConstructHandler + 656\r\n14  node                                0x0000000100ed4418 Builtins_InterpreterEntryTrampoline + 248\r\n15  node                                0x0000000100ed4418 Builtins_InterpreterEntryTrampoline + 248\r\n16  node                                0x0000000100f03a14 Builtins_AsyncFunctionAwaitResolveClosure + 84\r\n17  node                                0x0000000100f888b8 Builtins_PromiseFulfillReactionJob + 56\r\n18  node                                0x0000000100ef5df4 Builtins_RunMicrotasks + 596\r\n19  node                                0x0000000100ed20e4 Builtins_JSRunMicrotasksEntry + 164\r\n20  node                                0x00000001008a3a1c _ZN2v88internal12_GLOBAL__N_16InvokeEPNS0_7IsolateERKNS1_12InvokeParamsE + 2332\r\n21  node                                0x00000001008a3e50 _ZN2v88internal12_GLOBAL__N_118InvokeWithTryCatchEPNS0_7IsolateERKNS1_12InvokeParamsE + 88\r\n22  node                                0x00000001008a3f3c _ZN2v88internal9Execution16TryRunMicrotasksEPNS0_7IsolateEPNS0_14MicrotaskQueueEPNS0_11MaybeHandleINS0_6ObjectEEE + 64\r\n23  node                                0x00000001008c6b78 _ZN2v88internal14MicrotaskQueue13RunMicrotasksEPNS0_7IsolateE + 336\r\n24  node                                0x00000001008c740c _ZN2v88internal14MicrotaskQueue17PerformCheckpointEPNS_7IsolateE + 124\r\n25  node                                0x0000000100591db4 _ZN4node21InternalCallbackScope5CloseEv + 388\r\n26  node                                0x000000010059248c _ZN4node20InternalMakeCallbackEPNS_11EnvironmentEN2v85LocalINS2_6ObjectEEES5_NS3_INS2_8FunctionEEEiPNS3_INS2_5ValueEEENS_13async_contextE + 548\r\n27  node                                0x00000001005a74c8 _ZN4node9AsyncWrap12MakeCallbackEN2v85LocalINS1_8FunctionEEEiPNS2_INS1_5ValueEEE + 204\r\n28  node                                0x00000001006485c4 _ZN4node2fs13FSReqCallback7ResolveEN2v85LocalINS2_5ValueEEE + 220\r\n29  node                                0x0000000100648d88 _ZN4node2fs9AfterStatEP7uv_fs_s + 72\r\n30  node                                0x0000000100eb2794 uv__work_done + 192\r\n31  node                                0x0000000100eb5f30 uv__async_io + 320\r\n[1]    79075 segmentation fault  /usr/bin/env   /Users/irvenaelbrecht/.nvm/versions/node/v16.15.0/bin/node\r\n\r\n### Minimal Reproduction\r\n\r\nRun \"yarn test\" in https://github.com/Irvenae/ts-temporal. (You don't need to start the cluster as the test is using the test framework). You might need to rerun a couple of times to get the issue. \r\n\r\nThe test is found under src/__tests__/helloTestFramework.test.ts. It runs the greet example using Jest. I also needed to add `--experimental-vm-modules` to the node command to be able to run the test with the framework.\r\n\r\n### Environment/Versions\r\n\r\nI encountered this on a Mac M1. But I tested it before (on an older version of the temporal SDK) on Ubuntu 18.04 with the same results.\r\nI am using typescript SDK v1.0.0-rc.1\r\n\r\n","closedAt":"2022-09-09T00:51:55Z","comments":[{"id":"IC_kwDOEujx185GbnZi","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Thanks for reporting.\r\nAccording to the trace this doesn't look like an issue with the test server itself, it looks like some issue with jest with the SDK.\r\nThis is probably the 4th jest related issue we've gotten.\r\n\r\nCan you try to run the tests with a different runner and see if this still happens?\r\nI'm also wondering if it's related to `replay.test.ts` which starts a worker in debug mode which creates vm contexts in the main nodejs thread.\r\n","createdAt":"2022-07-12T11:29:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/753#issuecomment-1181644386","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Gbp0v","author":{"login":"Irvenae"},"authorAssociation":"NONE","body":"All tests should be disabled outside of `helloTestFramework.test.ts` (by doing xdescribe).","createdAt":"2022-07-12T11:40:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/753#issuecomment-1181654319","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Gbt1l","author":{"login":"Irvenae"},"authorAssociation":"NONE","body":"I have checked with Mocha and this does indeed work consistently.","createdAt":"2022-07-12T11:58:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/753#issuecomment-1181670757","viewerDidAuthor":false},{"id":"IC_kwDOEujx185J_e1g","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"This should be fixed since we downgraded get-port to the non ESM version.\r\nPlease open if you think otherwise.","createdAt":"2022-09-09T00:51:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/753#issuecomment-1241378144","viewerDidAuthor":false}],"createdAt":"2022-07-12T08:05:38Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":753,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Flaky test framework segfaults when used with Jest runner","updatedAt":"2022-09-09T00:51:55Z","url":"https://github.com/temporalio/sdk-typescript/issues/753"}
