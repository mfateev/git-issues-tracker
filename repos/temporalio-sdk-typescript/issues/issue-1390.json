{"assignees":[],"author":{"id":"MDQ6VXNlcjM2MjU4MTU5","is_bot":false,"login":"acheong08","name":"Antonio Cheong"},"body":"### What are you really trying to do?\r\n\r\nUse [uuid](https://www.npmjs.com/package/uuid)\r\n\r\n### Describe the bug\r\n\r\n```ts\r\n2024-04-08T08:27:14.376Z [WARN] Workflow failed {\r\n  namespace: 'default',\r\n  taskQueue: 'hello-world',\r\n  workflowId: 'my-workflow',\r\n  runId: 'b769edf1-a169-4eaa-9a8b-ab3a397dc162',\r\n  workflowType: 'engine',\r\n  error: Error: crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported\r\n      at rng (/home/acheong/Projects/skand/v2/engine/node_modules/uuid/dist/esm-browser/rng.js:13:0)\r\n      at v4 (/home/acheong/Projects/skand/v2/engine/node_modules/uuid/dist/esm-browser/v4.js:11:52)\r\n      at v4 (/home/acheong/Projects/skand/v2/engine/src/lib/engine.ts:128:19)\r\n      at nanoid (/home/acheong/Projects/skand/v2/engine/src/lib/engine.ts:227:33)\r\n      at executeNodes (/home/acheong/Projects/skand/v2/engine/src/lib/engine.ts:88:32)\r\n      at run (/home/acheong/Projects/skand/v2/engine/src/workflows.ts:28:24)\r\n      at Activator.startWorkflowNextHandler (/home/acheong/Projects/skand/v2/engine/node_modules/@temporalio/workflow/src/internals.ts:410:16)\r\n      at /home/acheong/Projects/skand/v2/engine/node_modules/@temporalio/workflow/src/internals.ts:428:8\r\n      at executeWithLifecycleLogging (/home/acheong/Projects/skand/v2/engine/node_modules/@temporalio/workflow/src/logs.ts:80:12)\r\n      at Activator.startWorkflow (/home/acheong/Projects/skand/v2/engine/node_modules/@temporalio/workflow/src/internals.ts:427:34)\r\n}\r\n```\r\n\r\n### Minimal Reproduction\r\n\r\nhttps://github.com/acheong08/temporal-crypto-error/\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: [e.g. M1 Mac, x86 Windows, Linux]\r\n- Temporal Version: 1.9.3\r\n- Are you using Docker or Kubernetes or building Temporal from source? No","closedAt":"2024-04-09T07:24:28Z","comments":[{"id":"IC_kwDOEujx18551sKp","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"By design, UUIDv4 requires a random number generator, and the NPM `uuid` package uses the built-in `crypto` module's `getRandomValues` function for that purpose. But the built-in `crypto` module can't be imported from workflow code because it has non-deterministic behavior.\r\n\r\nWorkflow code [must be deterministic](https://docs.temporal.io/workflows#deterministic-constraints).\r\n\r\nYou have two easy options to resolves this:\r\n1. If only care about generating some UUID, uses the `uuid4` function exported by the `@temporalio/workflow` package. That implementation internally uses a replay-safe random number generator.\r\n2. As a more general solution, non-deterministic logic should usually be moved to Activities instead. Activities have no need to be deterministic.","createdAt":"2024-04-09T04:13:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1390#issuecomment-2044117673","viewerDidAuthor":false},{"id":"IC_kwDOEujx18551wjX","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"On a side note, I'm a bit puzzled by the fact that the dependency to the `crypto` module didn't get caught by the Workflow Bundler, which would have provided a more suitable error message.\r\n\r\nI noticed the presence of a `bun.lockb` file in your repro code. Have you tried running this with Bun? Unfortunately, Node.js is the only supported JS runtime at this moment, and I honestly don't think that compatibility layers provided by alternate JS offerings will be able to reliably execute the Workflow Sandboxing engine at this time.\r\n\r\nBut if you got some success with this, I'd be interested to know more.","createdAt":"2024-04-09T04:39:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1390#issuecomment-2044135639","viewerDidAuthor":false},{"id":"IC_kwDOEujx18552bi-","author":{"login":"acheong08"},"authorAssociation":"NONE","body":"> If only care about generating some UUID, uses the uuid4 function exported by the @temporalio/workflow package. That implementation internally uses a replay-safe random number generator.\r\n\r\nMakes sense. Thanks\r\n\r\n> I noticed the presence of a bun.lockb file in your repro code. Have you tried running this with Bun? Unfortunately, Node.js is the only supported JS runtime at this moment, and I honestly don't think that compatibility layers provided by alternate JS offerings will be able to reliably execute the Workflow Sandboxing engine at this time.\r\n\r\nI tend to run bun locally out of habit and it works perfectly fine. I still run node on CI and/or servers.","createdAt":"2024-04-09T07:24:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1390#issuecomment-2044311742","viewerDidAuthor":false},{"id":"IC_kwDOEujx18552eOm","author":{"login":"acheong08"},"authorAssociation":"NONE","body":"> On a side note, I'm a bit puzzled by the fact that the dependency to the crypto module didn't get caught by the Workflow Bundler, which would have provided a more suitable error message.\r\n\r\nThat would be helpful indeed.","createdAt":"2024-04-09T07:27:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1390#issuecomment-2044322726","viewerDidAuthor":false}],"createdAt":"2024-04-08T08:33:14Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1390,"reactionGroups":[],"state":"CLOSED","title":"[Bug] crypto.getRandomValues not supported","updatedAt":"2024-04-09T07:27:59Z","url":"https://github.com/temporalio/sdk-typescript/issues/1390"}
