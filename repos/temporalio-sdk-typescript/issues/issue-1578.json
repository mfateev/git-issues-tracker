{"assignees":[],"author":{"id":"MDQ6VXNlcjY0MTIxNjk=","is_bot":false,"login":"mjameswh","name":"James Watkins-Harvey"},"body":"### Describe the bug\r\n\r\nStarting a Worker with Node option `--abort-on-uncaught-exception` results in the following error message:\r\n\r\n```\r\nUncaught TypeError: Cannot read properties of undefined (reading './node_modules/@temporalio/workflow/lib/worker-interface.js')\r\n\r\nFROM\r\n__webpack_require__ (/srv/workflows.js:7523:55)\r\n/srv/workflows.js:7591:13\r\n/srv/workflows.js:7607:3\r\n/srv/workflows.js:7610:12\r\nScript.runInContext (node:vm:149:12)\r\nparseWorkflowCode (/srv/node_modules/@temporalio/worker/lib/worker.js:1335:16)\r\nWorker.getOrCreateBundle (/srv/node_modules/@temporalio/worker/lib/worker.js:331:24)\r\nasync Worker.create (/srv/node_modules/@temporalio/worker/lib/worker.js:139:24)\r\n```\r\n\r\n\r\n### How to reproduce\r\n\r\nStart the Hello World sample's Worker with:\r\n\r\n```\r\nNODE_OPTIONS=--abort-on-uncaught-exception npm run start\r\n```\r\n\r\n### Details\r\n\r\nThe stack trace points out to the following code locations:\r\n\r\n- https://github.com/mjameswh/sdk-typescript/blob/4dcc82aa48fc285119978bd2a93acc3a0e9fd231/packages/worker/src/worker.ts#L1791-L1798\r\n\r\n- https://github.com/mjameswh/sdk-typescript/blob/4dcc82aa48fc285119978bd2a93acc3a0e9fd231/packages/worker/src/workflow/bundler.ts#L117\r\n\r\nThat is, while preloading the bundle code for the benefit of debuggers, the execution context isn't configured properly, so that `globalThis.__webpack_module_cache__` is undefined. That causes a type error while running the bundled code, which should presumably get caught by the try-catch block in worker.ts. However, the `abort-on-uncaught-exception` operates at V8's level (rather than Node's event loop level) and V8's is not aware of the cross-execution-context call involved by `script.runInContext()`, so it can't figure out that the error happening in the child context will get properly handled by the parent context, resulting in aborting execution.\r\n\r\nSome quick fixes are possible, e.g. adding a `?? {}` suffix to the problematic line in bundler, but I'm afraid the problem may reappear at a later time as other global variables get added; we should therefore consider moving the preload to the VM.\r\n\r\nMore over, this preload somewhat expensive and only pertinent if there's an attached inspector, which is rarely the case. We should therefore make it conditional to the presence of a debugger.\r\n","closedAt":null,"comments":[],"createdAt":"2024-12-02T19:19:16Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1578,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"OPEN","title":"[Bug] Worker fails to start if Node option --abort-on-uncaught-exception is set","updatedAt":"2024-12-02T19:19:16Z","url":"https://github.com/temporalio/sdk-typescript/issues/1578"}
