{"assignees":[],"author":{"id":"MDQ6VXNlcjk3MzU0Mw==","is_bot":false,"login":"gajus","name":"Gajus Kuizinas"},"body":"We need to exclude a module from being bundled.\r\n\r\nContrary to the documentation, `ignoreModules` does not achieve that.","closedAt":"2023-01-26T17:38:58Z","comments":[{"id":"IC_kwDOEujx185TwlCl","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Can you please provide more information why ignoreModules doesn't achieve what you want?\r\nHere's what the bundler does internally FTR: https://github.com/temporalio/sdk-typescript/blob/31c8cc27287ec91e495397e85cd52a30c0d1236a/packages/worker/src/workflow/bundler.ts#L180.\r\nHere's a test that successfully ignores `dns` https://github.com/temporalio/sdk-typescript/blob/31c8cc27287ec91e495397e85cd52a30c0d1236a/packages/test/src/test-bundler.ts#L60.","createdAt":"2023-01-26T16:10:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1036#issuecomment-1405243557","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Twp8s","author":{"login":"gajus"},"authorAssociation":"NONE","body":"I've added `['slonik', 'node:crypto']` and still getting error:\r\n\r\n```\r\n2023-01-26T16:23:52.171Z [ERROR] ERROR in node:crypto\r\n2023-01-26T16:23:52.171Z [ERROR] Module build failed: UnhandledSchemeError: Reading from \"node:crypto\" is not handled by plugins (Unhandled scheme).\r\n2023-01-26T16:23:52.171Z [ERROR] Webpack supports \"data:\" and \"file:\" URIs by default.\r\n2023-01-26T16:23:52.171Z [ERROR] You may need an additional plugin to handle \"node:\" URIs.\r\n```\r\n\r\nso it seems at least one of them is still being included","createdAt":"2023-01-26T16:24:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1036#issuecomment-1405263660","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Twyfi","author":{"login":"gajus"},"authorAssociation":"NONE","body":"Actually, now that I look at the Temporal source code, there is no logic there to actually exclude module. It only adds a warning if it is not already excluded.","createdAt":"2023-01-26T16:49:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1036#issuecomment-1405298658","viewerDidAuthor":false},{"id":"IC_kwDOEujx185TwyzU","author":{"login":"gajus"},"authorAssociation":"NONE","body":"It seems that it attempts to exclude it using `alias`, which unfortunately does not work for modules such as `node:`\r\n\r\nhttps://github.com/webpack/webpack/issues/14166","createdAt":"2023-01-26T16:50:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1036#issuecomment-1405299924","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Tw2cB","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"LMK if removing the `node:` prefix solves your issue for now.","createdAt":"2023-01-26T17:01:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1036#issuecomment-1405314817","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Tw4Q6","author":{"login":"gajus"},"authorAssociation":"NONE","body":"> LMK if removing the node: prefix solves your issue for now.\r\n\r\nIt does not, as explained in that webpack issue.","createdAt":"2023-01-26T17:06:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1036#issuecomment-1405322298","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Tw4bJ","author":{"login":"gajus"},"authorAssociation":"NONE","body":"I have no control over `node:` referenced in code, as it is coming from dependencies.","createdAt":"2023-01-26T17:07:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1036#issuecomment-1405322953","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Tw8jS","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"The issue you are facing is not directly about `ignoreModules`. It is that the workflow bundler is not compiling for the node target, and therefore, webpack does not even know how to process dependencies in the `node:` namespace.\r\n\r\nWould it be possible for you to ignore the module that does import that `node:` dependency?","createdAt":"2023-01-26T17:19:34Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1036#issuecomment-1405339858","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Tw835","author":{"login":"gajus"},"authorAssociation":"NONE","body":"That's what I am trying to do with `externals`.\r\n\r\nAnyway, overriding externals does the job.\r\n\r\n```ts\r\n// @see https://github.com/temporalio/sdk-typescript/issues/1036#issuecomment-1405322953\r\nconfig.externals = {\r\n  \"node:crypto\": \"{}\"\r\n};\r\n```","createdAt":"2023-01-26T17:20:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1036#issuecomment-1405341177","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Tw9gT","author":{"login":"gajus"},"authorAssociation":"NONE","body":"A Temporal-compatible patch:\r\n\r\n```ts\r\nconst temporalExternals = config.externals;\r\n\r\nconfig.externals = async (context, callback) => {\r\n  if (context.request === 'node:crypto') {\r\n    return 'var {}';\r\n  }\r\n\r\n  return temporalExternals(context, callback);\r\n};\r\n\r\nconfig.resolve.alias = {\r\n  ...config.resolve.alias,\r\n  '@': path.resolve(__dirname, '../..'),\r\n  slonik: false,\r\n};\r\n```","createdAt":"2023-01-26T17:22:47Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1036#issuecomment-1405343763","viewerDidAuthor":false}],"createdAt":"2023-01-26T15:20:21Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1036,"reactionGroups":[],"state":"CLOSED","title":"How to add module to disallowedModules?","updatedAt":"2023-01-26T17:38:58Z","url":"https://github.com/temporalio/sdk-typescript/issues/1036"}
