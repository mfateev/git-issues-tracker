{"assignees":[],"author":{"id":"MDQ6VXNlcjE5NzE4ODg0","is_bot":false,"login":"ksapchuk","name":"Kirill"},"body":"### What are you really trying to do?\nSomething changed in the last few days and we are no longer able to run tests using the temporal test library. \n<!-- \nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \n-->\n\n### Describe the bug\nThe tests fail to start the temporal test server with an error \n```\nThe current machine does not support all of the following CPU features that are required by the image: [CX8, CMOV, FXSR, MMX, SSE, SSE2, SSE3, SSSE3, SSE4_1, SSE4_2, POPCNT, LZCNT, AVX, AVX2, BMI1, BMI2, FMA, F16C].\n```\n<!-- A clear and concise description of what the bug is. -->\n\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\n\n### Minimal Reproduction\nInstall the time skipping test example https://github.com/temporalio/samples-typescript/tree/main/timer-examples#testing and run the tests\n```\ntimer-examples % npm test\n\n> temporal-timer@0.1.0 test\n> mocha --require ts-node/register --require source-map-support/register src/test/*.test.ts\n\n\n  countdownWorkflow\nThe current machine does not support all of the following CPU features that are required by the image: [CX8, CMOV, FXSR, MMX, SSE, SSE2, SSE3, SSSE3, SSE4_1, SSE4_2, POPCNT, LZCNT, AVX, AVX2, BMI1, BMI2, FMA, F16C].\nPlease rebuild the executable with an appropriate setting of the -march option.\n```\n### Environment/Versions\n\n<!-- Please complete the following information where relevant. -->\n\n- OS and processor: Apple M3 Pro\n- Temporal Version: Typescript 1.11.8\n\n### Additional context\n\n<!-- Add any other context about the problem here. -->\n","closedAt":"2025-06-26T15:31:44Z","comments":[{"id":"IC_kwDOEujx186zFNI9","author":{"login":"EssentKoen"},"authorAssociation":"NONE","body":"+1\nWe are experiencing the same issue.\n\nOS - mac - M1 through M4.\nSomething seems to be broken with https://temporal.download as well, but the error seems to indicate a version is available, but somehow broken. \nI see that I have a new version which is 10MB smaller. You can actually use this (search for \"temporal-test-server-sdk-typescript-1.11.8\" in /private/var) to locate the broken executable.\n\nColleagues who still have the temporal-dev-server cached locally have no problems whatsoever, so as a workaround if you really need to, you can manually put that executable on your laptop on that location, then run again. Not sure where you can download a correct version at the moment, we are just lucky to still have the old one lying around.\n\nIf you download a correct test server, btw - you can also configure temporal to use a custom path so you don't have to finnick around as much as I previously indicated ;)","createdAt":"2025-06-25T11:49:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1731#issuecomment-3004486205","viewerDidAuthor":false},{"id":"IC_kwDOEujx186zJRfH","author":{"login":"vault-pay"},"authorAssociation":"NONE","body":"I'm experiencing the same problem. I'm on M2 Max. ","createdAt":"2025-06-25T17:14:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1731#issuecomment-3005552583","viewerDidAuthor":false},{"id":"IC_kwDOEujx186zJS07","author":{"login":"Seven4ME"},"authorAssociation":"NONE","body":"^ Same for me","createdAt":"2025-06-25T17:15:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1731#issuecomment-3005558075","viewerDidAuthor":false},{"id":"IC_kwDOEujx186zJdI4","author":{"login":"Seven4ME"},"authorAssociation":"NONE","body":"Who faced same issue - try to execute `fd temporal /private/var/folders | xargs rm` and then re-run tests.\nIts helped to me.","createdAt":"2025-06-25T17:28:42Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1731#issuecomment-3005600312","viewerDidAuthor":false},{"id":"IC_kwDOEujx186zPcuK","author":{"login":"EssentKoen"},"authorAssociation":"NONE","body":"I think @Seven4ME 's comment suggests the download is no longer broken. \nI verified this by removing the existing executable and it indeed works. The download size is still down by 10MB, so that's nice I guess.\n\nI would love to hear a report out from someone from Temporal on how to prevent something like this - we're now quite dependent on the download actually working at all times.\n\nOther than that, I think this issue can be closed.","createdAt":"2025-06-26T05:54:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1731#issuecomment-3007171466","viewerDidAuthor":false},{"id":"IC_kwDOEujx186zWDr1","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"**TLDR**\n\nThe upstream download file has been fixed. If you're still seeing the error message, you may need to remove the cached download file; just run `rm $TMPDIR/temporal-test-server-sdk-typescript-*` from a terminal window.\n\nWe're very sorry for that.\n\n\n**What happened?**\n\nThe Temporal Test Server is developed in Java. It is then built into a standalone executable using GraalVM.\n\nUntil recently, due to limitations of our build system, it was not possible to use GraalVM to build standalone executables for ARM-based architectures. On MacOS, that was not a problem in most cases, because Apple's Rosetta would allow transparent execution the AMD64 build instead. But that wouldn't work on Linux, including in Docker running on Mac, which was a pain to many of our users.\n\nTest Server 1.30.0 added native support for ARM64. To achieve that, we had to [completely rewrite our native-build scripts](https://github.com/temporalio/sdk-java/pull/2448). However, this new native-build script unintentionally turned on some compiler optimizations that depend on specific AMD64 CPU features. Some of those CPU features are not emulated by Apple's Rosetta, which means that using the Test Server 1.30.0 on an AMD-based Mac would not work, resulting in this error message:\n\n```\nThe current machine does not support all of the following CPU features that are required by the image: [CX8, CMOV, FXSR, MMX, SSE, SSE2, SSE3, SSSE3, SSE4_1, SSE4_2, POPCNT, LZCNT, AVX, AVX2, BMI1, BMI2, FMA, F16C].\n```\n\nTo be clear, we did not explicitly turn on those compiler optimizations: they are enabled by default by GraalVM's compiler, and need to be explicitly opted out. We didn't, and that was an oversight from our part.\n\nThe native-build process for our Test Server [has now been fixed](https://github.com/temporalio/sdk-java/pull/2571), so Test Server 1.30.1 will again run properly on MacOS.\n\n\n**Why are we still downloading the AMD64 build on MacOS?**\n\nSince we are now publishing an ARM64 build of the Test Server for MacOS, some may wonder why did the SDK downloaded the AMD64 1.30.0 build, which requires these CPU flags, rather than downloading and using the ARM build, which would completely avoid the need for Rosetta? After all, using the proper executable would have also avoided the observed issue.\n\nThat's because download of the Test Server executable happens indirectly through a download service we maintain (https://temporal.download/), which is there to provide a caching layer over downloading the executables directly from GitHub. That service also provides some basic routing rules, including the rule that says \"If requesting Test Server for ARM64 on MacOS, then return the AMD64 build instead\". As part of the work on publishing Test Server for ARM64, our download service has obviously been fixed is; that is: \"If requesting Test Server *prior to 1.30.0*, for ARM64 on MacOS, then return the AMD64 build instead; otherwise, return the ARM64 build\".\n\nWe had already fixed the download service code, but we intentionally delayed redeployment of the service, to be done _after_ the release of Test Server 1.30.0. There was simply no reason to urge this redeployment, as the legacy behavior (i.e. sending AMD64 build instead of ARM64 to MacOS users) should have still been correct, simply not optimal. More importantly, doing things in that order would make it easier for us to run some final tests before turning this on by default for all of our users.\n\n\n**How can we protect ourself from similar incidents in the future?**\n\nThe SDK's `TestWorkflowEnvironment.createLocal()` and `TestWorkflowEnvironment.createTimeSkipping()` functions both accept passing in the path to predownloaded executables, rather than let them be automatically downloaded at run time by the SDK. Simply download manually the [Temporal CLI](https://github.com/temporalio/cli/releases) and the [Temporal Test Server](https://github.com/temporalio/sdk-java/releases) executables from their respective project's GitHub release page, then provide the file path of those executables when creating your `TestWorkflowEnvironment`.\n\nDespite the extra work, this may actually be highly desirable depending on your specific needs.\n\nPre-downloading both executables have several benefits, including:\n\n- Avoid test timeout flakes due to download taking too much time;\n- Avoid being affected by ocasional outtages that may affect the download service;\n- Guarantee that your tests are always running with the same version of the server.\n","createdAt":"2025-06-26T15:31:44Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}},{"content":"HEART","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1731#issuecomment-3008903925","viewerDidAuthor":false},{"id":"IC_kwDOEujx186zWuAj","author":{"login":"EssentKoen"},"authorAssociation":"NONE","body":"Thanks for the extensive update @mjameswh - much appreciated!","createdAt":"2025-06-26T16:32:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1731#issuecomment-3009077283","viewerDidAuthor":false}],"createdAt":"2025-06-25T03:03:42Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1731,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":3}},{"content":"EYES","users":{"totalCount":4}}],"state":"CLOSED","title":"[Bug] Unable to run tests","updatedAt":"2025-06-26T16:32:46Z","url":"https://github.com/temporalio/sdk-typescript/issues/1731"}
