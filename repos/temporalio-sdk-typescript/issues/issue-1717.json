{"assignees":[],"author":{"id":"MDQ6VXNlcjY0MTIxNjk=","is_bot":false,"login":"mjameswh","name":"James Watkins-Harvey"},"body":"### Describe the bug\n\nAfter upgrading `protobufjs` to 7.5.2, our feature tests using Protobuf Payload converters have started failing with the following error message:\n\n```\nFeature data_converter/binary_protobuf failed with TypeError: Cannot read properties of undefined (reading '_fullyQualifiedObjects') TypeError: Cannot read properties of undefined (reading '_fullyQualifiedObjects')\n    at Object.lookup (/home/runner/work/sdk-typescript/sdk-typescript/features/program-3122623612/node_modules/protobufjs/src/namespace.js:411:27)\n    at Object.lookupType (/home/runner/work/sdk-typescript/sdk-typescript/features/program-3122623612/node_modules/protobufjs/src/namespace.js:491:22)\n    at ProtobufBinaryPayloadConverter.validatePayload (/home/runner/work/sdk-typescript/sdk-typescript/sdk-ts/packages/common/lib/converter/protobuf-payload-converters.js:58:37)\n    at ProtobufBinaryPayloadConverter.fromPayload (/home/runner/work/sdk-typescript/sdk-typescript/sdk-ts/packages/common/lib/converter/protobuf-payload-converters.js:99:44)\n    at PayloadConverterWithProtobufs.fromPayload (/home/runner/work/sdk-typescript/sdk-typescript/sdk-ts/packages/common/lib/converter/payload-converter.js:113:26)\n    at /home/runner/work/sdk-typescript/sdk-typescript/sdk-ts/packages/common/lib/converter/payload-converter.js:60:48\n    at Array.map (<anonymous>)\n    at arrayFromPayloads (/home/runner/work/sdk-typescript/sdk-typescript/sdk-ts/packages/common/lib/converter/payload-converter.js:60:21)\n    at decodeArrayFromPayloads (/home/runner/work/sdk-typescript/sdk-typescript/sdk-ts/packages/common/lib/internal-non-workflow/codec-helpers.js:89:54)\n    at processTicksAndRejections (node:internal/process/task_queues:96:5)\n```\n\n### Minimal Reproduction\n\nThe following feature tests demonstrate this issue:\n\n- `data_converter/binary_protobuf`\n- `json_protobuf`\n\nAll SDK integration tests still pass, including those testing the Protobuf Payload Converter feature. Our `protobufs` sample also execute without problem against 1.11.8 + protobufjs 7.5.2 (didn't test other combinations). Given that the latter are more representative of how users would normally use this feature, it seems reasonable to expect that this issue might not have any user visible impact.\n\n### Misc\n\n- The `_fullyQualifiedObjects` property [was introduced in protobufjs yesterday](https://github.com/protobufjs/protobuf.js/pull/2068/files).\n- It seems likely that this upstream change may conflict with our [\"Patch Protobuf Root\"](https://github.com/temporalio/sdk-typescript/blob/3cbb5feae4188b1c5458d0edcfd2bb49c3feadff/packages/proto/src/patch-protobuf-root.ts#L20) logic.\n- Due to technical constraints of our feature test harness, our feature tests reuse some protobuf message definitions of the SDK itself, rather than defining and compiling their own protobuf messages as one would normally do.","closedAt":null,"comments":[],"createdAt":"2025-05-16T04:24:35Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1717,"reactionGroups":[],"state":"OPEN","title":"[Bug] Protobuf Payload Converter is broken after upgrading to protobufjs 7.5.2","updatedAt":"2025-05-16T05:05:03Z","url":"https://github.com/temporalio/sdk-typescript/issues/1717"}
