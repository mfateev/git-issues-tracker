{"assignees":[],"author":{"id":"MDQ6VXNlcjU5OTkxNQ==","is_bot":false,"login":"sdedovic","name":"Stevan Dedovic"},"body":"### What are you really trying to do?\nWhen using the `@temporalio/interceptors-opentelemetry` library I am seeing TONS of these errors:\n\n```\nERROR --- node_modules/@opentelemetry/api/build/src/api/diag.js : [\"Accessing resource attributes before async attributes settled\"]\n```\n\nwhich are caused by the Temporal SDKs improper use of the OTEL SDK.\n\n### Describe the bug\nSee this comment on the issue in the OTEL SDK: https://github.com/open-telemetry/opentelemetry-js/issues/5828#issuecomment-3227403161. To quote the linked comment, from one of the OTEL maintainers\n\n> Looking at the code it looks like the following is happening:\\\n> -    @temporalio/interceptors-opentelemetry bypasses the SpanProcessor which is supposed to await the async attributes and passes spans directly to SpanExporter\n> -    the SpanExporter then assumes that the resource was already awaited by the SpanProcessor, but since @temporalio/interceptors-opentelemetry bypassed the SpanProcessor this never happened.\n> -    during normal operation of an OTel SDK, this log is not written - this happens since @temporalio/interceptors-opentelemetry bypasses a required SDK component.\n>\n> **Recommendation**: @temporalio/interceptors-opentelemetry should accept a SpanProcessor instead of a SpanExporter in [makeWorkflowExporter()](https://github.com/temporalio/sdk-typescript/blob/7c88cc7ab0d02f0002178ba03a349503d5bc481c/packages/interceptors-opentelemetry/src/worker/index.ts#L73-L90), and pass the spans to SpanProcessor#onEnd(Span) instead. This will properly await the resource attributes before exporting them, log errors and and handle batching in a user-configurable way, which may be desirable.\n\n\n\n### Minimal Reproduction\nSee last comment on this issue: https://github.com/open-telemetry/opentelemetry-js/issues/5828#event-19364472301\n\n```ts\nexport function makeWorkflowExporter(\n  spanProcessor: SpanProcessor, // used with a BatchSpanProcessor for instance, which forwards to a SpanExporter\n  resource: Resource\n): InjectedSink<OpenTelemetryWorkflowExporter> {\n  // note: somehow, `SpanProcessor#shutdown()` needs to be wired up somewhere to avoid data loss on shutdown.\n  return {\n    export: {\n      fn: (info, spanData) => {\n        const spans = spanData.forEach((serialized) => {\n          Object.assign(serialized.attributes, info);\n          // Spans are copied over from the isolate and are converted to ReadableSpan instances\n          spanProcessor.onEnd(extractReadableSpan(serialized, resource));\n        });\n      },\n    },\n  };\n}\n```\n\n### Environment/Versions\n\n<!-- Please complete the following information where relevant. -->\n\n- OS and processor: x86_64-linux\n- Temporal Version: [e.g. 1.14.0?] and/or SDK version\n- Temporal from source\n\n### Additional context\nThis will affect https://github.com/temporalio/sdk-typescript/pull/1741\n","closedAt":null,"comments":[],"createdAt":"2025-08-29T16:56:46Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1779,"reactionGroups":[],"state":"OPEN","title":"[Bug] `@temporalio/interceptors-opentelemetry` OTEL bypasses a required SDK component","updatedAt":"2025-08-29T16:56:46Z","url":"https://github.com/temporalio/sdk-typescript/issues/1779"}
