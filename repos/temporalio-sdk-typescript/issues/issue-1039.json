{"assignees":[],"author":{"id":"MDQ6VXNlcjY0MTIxNjk=","is_bot":false,"login":"mjameswh","name":"James Watkins-Harvey"},"body":"### Describe the bug\r\n\r\nUnhandled promise rejections causes WFT failures. This is reasonable given that Node 16's default policy is to crash the process on unhandled promise rejections.\r\n\r\nHowever, when this happens, the WFT failure actually carries very little context information, making it difficult for the user to 1) understand the reason why the WFT failed and 2) the origin of the failing Promise.\r\n\r\nIt is therefore proposed that WFT failures caused by unhandled promise rejections should:\r\n1. use an error message that clearly indicates \"Unhandled promise rejection\";\r\n2. that the WFT failure should carry the stack trace to the place where failing promise was created; \r\n3. that a message with \"Unhandled promise rejection\" and the stack trace to the promise creation should be reported to the Worker's log.","closedAt":"2025-02-27T23:00:16Z","comments":[{"id":"IC_kwDOEujx186HvAH_","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Another surprising behavior of unhandled promise rejection: if the thrown error happens to be an instance of `TemporalFailure`, the failure will get encoded normally, but reported as a WFT failure rather than a WF failure as would generally be expected for `TemporalFailure`.\r\n\r\nFor example:\r\n\r\n```\r\nimport * as wf from '@temporalio/workflow';\r\n\r\nexport async function parentWorkflow(): Promise<void> {\r\n  // Note the missing `await` here\r\n  wf.executeChild(childWorkflow);\r\n  await wf.condition(() => false);\r\n}\r\n\r\nexport async function childWorkflow(): Promise<void> {\r\n  throw wf.ApplicationFailure.nonRetryable('I am a child and I failed');\r\n}\r\n```\r\n\r\nresults in the following history:\r\n\r\n<img width=\"2158\" alt=\"Screenshot 2024-08-09 at 02 32 55\" src=\"https://github.com/user-attachments/assets/56c9509b-0d23-4dc2-a760-7d36d1e716c3\">","createdAt":"2024-08-09T06:35:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1039#issuecomment-2277245439","viewerDidAuthor":false},{"id":"IC_kwDOEujx186PGZWX","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"**Personal notes on this issue**\r\n\r\n1. There is currently no way for Activator methods to bubble up async non-`TemporalFailure` errors out of the sandbox; therefore, all async non-`TemporalFailure` actually become Unhandled Promise Rejections at some point.\r\n\r\n2. Some Activator methods execute sync code, but don't catch errors; those errors may then bubble up through the VM abstraction, and up to the _Worker_, where the error will get encoded to protobuf. That means that, except when using the single thread workflow executor (`TEMPORAL_DEBUG=true`), those Errors may get V8 serialized through the Worker Thread's message port, causing lost of information on the errors.\r\n\r\n    For example, the following code gives the expected failure when using the single thread wf executor, but not when running with the normal threaded executor:\r\n\r\n    ```\r\n    import * as wf from '@temporalio/workflow';\r\n    \r\n    export async function throwObject(): Promise<void> {\r\n      // ignore\r\n    }\r\n    \r\n    // Throw during `initRuntime`\r\n    if (wf.inWorkflowContext()) {\r\n      // eslint-disable-next-line no-debugger\r\n      // debugger;\r\n      throw { plainObject: true };\r\n    }\r\n    ```\r\n","createdAt":"2024-10-08T21:04:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1039#issuecomment-2400818583","viewerDidAuthor":false}],"createdAt":"2023-01-27T18:50:35Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1039,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"[Bug] Unhandled promise rejections results in hard to diagnose WFT failure","updatedAt":"2025-02-27T23:00:16Z","url":"https://github.com/temporalio/sdk-typescript/issues/1039"}
