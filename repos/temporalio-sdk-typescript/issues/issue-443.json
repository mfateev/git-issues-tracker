{"assignees":[{"id":"MDQ6VXNlcjI1MTI4OA==","login":"lorensr","name":"Loren ☺️","databaseId":0}],"author":{"id":"MDQ6VXNlcjI1MTI4OA==","is_bot":false,"login":"lorensr","name":"Loren ☺️"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\n<!-- A clear and concise description of what the problem is. Ex. I'm always frustrated when [...] -->\r\n\r\nUsers expect that when they return or pass a `Date`, they'll receive a `Date`. Instead, they receive an ISO string. \r\n\r\n[Repro](https://github.com/lorensr/samples-node/commit/8ec2ef538f276bd40d07fe021392865e20beb3bf)\r\n[User feedback on slack](https://temporalio.slack.com/archives/C01DKSMU94L/p1641736724022000)\r\n\r\n### Describe the solution you'd like\r\n\r\n<!-- A clear and concise description of what you want to happen. SCREENSHOTS OR CODE SAMPLES ARE VERY HELPFUL -->\r\n\r\nIt would be helpful if they received `Date`s and other types lost during `JSON.parse`.\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context or screenshots about the feature request here. -->\r\n\r\nSlack discussions:\r\n- https://temporalio.slack.com/archives/C01DKSMU94L/p1641779190022800?thread_ts=1641736724.022000&cid=C01DKSMU94L\r\n- https://temporalio.slack.com/archives/C01DKSMU94L/p1645146054222929\r\n- https://temporalio.slack.com/archives/C01DKSMU94L/p1648694634475969?thread_ts=1648684821.751929&cid=C01DKSMU94L","closedAt":"2023-05-11T17:24:40Z","comments":[{"id":"IC_kwDOEujx184_BSzU","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I'm not convinced we should solve this issue.\r\nDate isn't part of the JSON spec, there are of course ways to support it but we'd need a cross SDK solution.","createdAt":"2022-03-02T19:34:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/443#issuecomment-1057303764","viewerDidAuthor":false},{"id":"IC_kwDOEujx184_BUYz","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"We could publish a custom data converter, and clearly in the docs say:\r\n\r\nNote: the default Data Converter doesn't support Date, Y, Z, because it uses JSON for compatibility with the other SDKs. If you're only using the TS SDK (or can create equivalent custom data converters in your other SDK), you can use `MsgpackPayloadConverter`, which supports Date, Y, and Z:\r\n\r\n```ts\r\nimport { MsgpackPayloadConverter } from `@temporalio/common/converter/msgpack`\r\n\r\n...\r\n```","createdAt":"2022-03-02T19:43:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/443#issuecomment-1057310259","viewerDidAuthor":false},{"id":"IC_kwDOEujx184_CQm8","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"This is one (probably incomplete) approach where users can keep using JSON and have date serialization:\r\n\r\n```js\r\n// Unique prefix to add to date strings so they don't get mixed up with other ISO date strings\r\nconst prefix = \"5062374f-3be6-4562-84f4-984a49678e13_date_\";\r\nfunction maybeSerializeDate(o) {\r\n  if (o instanceof Date) {\r\n    return `${prefix}${o.toJSON()}`;\r\n  }\r\n  return o;\r\n}\r\n\r\nfunction customJSONSerializer(o) {\r\n  return JSON.stringify({ wrapped: o }, (k, v) => {\r\n    if (Array.isArray(v)) {\r\n      return v.map(maybeSerializeDate);\r\n    }\r\n    if (typeof v === \"object\" && v != null) {\r\n      return Object.fromEntries(\r\n        Object.entries(v).map(([e, vv]) => [e, maybeSerializeDate(vv)])\r\n      );\r\n    }\r\n    return v;\r\n  });\r\n}\r\n\r\nfunction customJSONDeserializer(s) {\r\n  return JSON.parse(s, (k, v) => {\r\n    if (typeof v === \"string\" && v.startsWith(prefix)) {\r\n      return new Date(v.replace(prefix, \"\"));\r\n    }\r\n    return v;\r\n  }).wrapped;\r\n}\r\n\r\nconst s = customJSONSerializer({ d: new Date(), arr: [new Date()] });\r\nconsole.log(s);\r\nconst revived = customJSONDeserializer(s);\r\nconsole.log(revived);\r\n\r\n```","createdAt":"2022-03-03T01:03:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/443#issuecomment-1057556924","viewerDidAuthor":false},{"id":"IC_kwDOEujx185AGff2","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Looked at [OData](https://www.odata.org/documentation/odata-version-2-0/json-format/) and searched for others, but most popular least seems like it might be [EJSON](https://docs.mongodb.com/manual/reference/mongodb-extended-json/?_ga=2.110350661.1777308973.1647907483-776353751.1647907483), which converts `Date`s and their `Binary` type:\r\n\r\n<img width=\"424\" alt=\"image\" src=\"https://user-images.githubusercontent.com/251288/159542368-0bdc0e29-3154-4565-a726-5807ab63d958.png\">\r\n\r\n<img width=\"552\" alt=\"image\" src=\"https://user-images.githubusercontent.com/251288/159543675-4fb1997a-a3a0-4b45-9b2f-566e5463097e.png\">\r\n\r\nThinking of doing a sample `EjsonPayloadConverter`, and maybe we'll bring it into the SDK.","createdAt":"2022-03-22T17:50:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/443#issuecomment-1075443702","viewerDidAuthor":false},{"id":"IC_kwDOEujx185AGrli","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"That would work, I'm wondering if it's even worth making it the default since this is proven to be a pain for users.\r\nThe caveat would be that it wouldn't be a polyglot solution.","createdAt":"2022-03-22T18:38:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/443#issuecomment-1075493218","viewerDidAuthor":false},{"id":"IC_kwDOEujx185AKC4q","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> I'm wondering if it's even worth making it the default since this is proven to be a pain for users.\r\n\r\nThat pain exists in the JS JSON ecosystem as a whole. How would they send the JSON over `fetch` or use `Response.json()` to get JSON back if we were talking HTTP here? I vote we stick with the native JSON.stringify/JSON.parse by default and just make sure these other formats easily opt-in.","createdAt":"2022-03-23T13:27:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/443#issuecomment-1076375082","viewerDidAuthor":false},{"id":"IC_kwDOEujx185ALlak","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"I think the surprise comes from it not looking like you're making network requests, and the typing.\r\n\r\nIn workflow:\r\n\r\n```ts\r\nawait activityFn(new Date())\r\n```\r\n\r\nActivity:\r\n\r\n```ts\r\nexport activityFn(when: Date): number { \r\n  return when.getDate()\r\n}\r\n```\r\n\r\nIt compiles fine, but fails at runtime. \r\n\r\nOf course, they'll probably reach this point anyway, when trying to send instances of their own models: `activityFn(new User())` and calling User methods in the Activity. Wondering about a more general-purpose DC where the user registers all their classes, and it serializes and re-instantiates instances. ","createdAt":"2022-03-23T20:16:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/443#issuecomment-1076778660","viewerDidAuthor":false},{"id":"IC_kwDOEujx185ALntn","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"This is the cost of Temporal's abstractions. Just because we abstract that things need to be serialized doesn't mean we need to support all serializable things. What's next, `BigInt`? `RegExp`? I think default JSON w/ opt-in helpers is ideal.\r\n\r\n> Wondering about a more general-purpose DC where the user registers all their classes, and it serializes and re-instantiates instances.\r\n\r\nI think this is definitely reasonable for opt-in. `dataConverter = CustomClassDataConverter({ encoding: \"my-encoding\", classes: [MyClass1, MyClass2] })` where each class must have a static `deserialize` and a non-static `serialize`. But that isn't a default thing.","createdAt":"2022-03-23T20:27:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/443#issuecomment-1076788071","viewerDidAuthor":false},{"id":"IC_kwDOEujx185ALz6t","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I agree that we can't solve all of these cases, date is pretty standard so it might be worth an exception but, yeah, it's debatable if we should support it OOTB.\r\n\r\nWe can't take the class approach for serialization either BTW because we don't know have the function signature at runtime.\r\nThere was a proposal to add annotations to the SDK but it was rejected.\r\n\r\nAt some point we might want to add TS only features to get signatures at runtime.","createdAt":"2022-03-23T21:28:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/443#issuecomment-1076838061","viewerDidAuthor":false},{"id":"IC_kwDOEujx185AL2bB","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> because we don't know have the function signature at runtime.\r\n\r\nWhy do you need the signatures in JS? On to-payload you check whether the object has `serialize` (or `temporalSerialize` or whatever), invoke it, and use the metadata to maintain the class type (`.constructor.name`). Then on from-payload, just to the lookup and invoke the matching `deserialize` static call on the class prototype. Yes it means JS users can pass something that doesn't have `serialize`, but such is life in untyped JS.","createdAt":"2022-03-23T21:42:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/443#issuecomment-1076848321","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Bnth9","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Would like to say early on in docs:\r\n\r\nWhen building a TypeScript-only project (one where all the Clients and Workers use the TS SDK, versus a mix of different language SDKs), we recommend using `EjsonCompositePayloadConverter`, which supports:\r\n\r\n- Dates (`Date`)\r\n- Binary (`Uint8Array`)\r\n- Special numbers (`NaN`, `Infinity`, and `-Infinity`)\r\n- Regular expressions (`RegExp`)\r\n\r\nas well as custom types.\r\n\r\n```ts\r\n// payload-converter.ts\r\nimport { EjsonCompositePayloadConverter } from '@temporalio/common/lib/ejson'\r\nexport const payloadConverter = new EjsonCompositePayloadConverter()\r\n\r\n// data-converter.ts\r\nexport const dataConverter = { payloadConverterPath: require.resolve('./payload-converter') }\r\n\r\n// worker.ts\r\nimport { dataConverter } from './data-converter.ts'\r\nconst worker = await Worker.create({\r\n  dataConverter,\r\n  ...\r\n});\r\n\r\n// client.ts\r\nimport { dataConverter } from './data-converter.ts'\r\nconst client = new WorkflowClient(new Connection().service, {\r\n  dataConverter,\r\n});\r\n```\r\n\r\nOr could simplify, for cases in which codecs aren't needed, with:\r\n\r\n```ts\r\n// data-converter.ts\r\nimport { EjsonDataConverter } from '@temporalio/common/lib/ejson'\r\nexport const dataConverter = new EjsonDataConverter()\r\n\r\n// worker.ts\r\nimport { dataConverter } from './data-converter.ts'\r\nconst worker = await Worker.create({\r\n  dataConverter,\r\n  ...\r\n});\r\n\r\n// client.ts\r\nimport { dataConverter } from './data-converter.ts'\r\nconst client = new WorkflowClient(new Connection().service, {\r\n  dataConverter,\r\n});\r\n```\r\n\r\n---\r\n\r\nThis would involve adding the EJSON sample to `packages/common`: \r\n\r\nhttps://github.com/temporalio/samples-typescript/tree/main/ejson\r\n\r\nand documenting how to use `addType`:\r\n\r\n![image](https://user-images.githubusercontent.com/251288/163727292-aba140b3-b2dd-4910-966d-0df0560fb8d5.png)\r\n","createdAt":"2022-04-17T18:31:42Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/443#issuecomment-1100929149","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Bp3fs","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"@lorensr that would be a good approach for TS only, I'm wondering if there's a better cross language solution or if we even need one if we have protobuf DCs.","createdAt":"2022-04-18T15:22:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/443#issuecomment-1101494252","viewerDidAuthor":false},{"id":"IC_kwDOEujx185cDaJG","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"We're not doing this for now, let's close to avoid stacking up issues","createdAt":"2023-05-11T17:24:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/443#issuecomment-1544397382","viewerDidAuthor":false}],"createdAt":"2022-01-10T02:06:30Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":443,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":4}}],"state":"CLOSED","title":"[Feature Request] Improve default data converter","updatedAt":"2023-05-11T17:24:40Z","url":"https://github.com/temporalio/sdk-typescript/issues/443"}
