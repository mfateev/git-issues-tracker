{"assignees":[{"id":"MDQ6VXNlcjY0MTIxNjk=","login":"mjameswh","name":"James Watkins-Harvey","databaseId":0}],"author":{"id":"MDQ6VXNlcjI2MTQzODcz","is_bot":false,"login":"tareksalem","name":"tarek salem"},"body":"### What are you really trying to do?\r\n\r\nI am using temporal typescript sdk, I have a dto as the following:\r\n\r\n```typescript\r\nexport class CheckoutDTO {\r\n  voucherCode: string;\r\n  promoCode: string;\r\n  mdn?: string;\r\n  balanceAmount?: number;\r\n  reewardsAmoun?: number;\r\n}\r\n```\r\nI am using class transformer library `plainToClass` function to build the dto inside the workflow as the following:\r\n\r\n```typescript\r\nconst workflow = async (payload: PlaceOrderRequestPayloadDTO) => {\r\n  const customer = await getCustomerInfo({\r\n    brand: payload.brand,\r\n    customerId: payload.customerId,\r\n  });\r\n  // check if customer is not exist then terminate the workflow\r\n  if (!customer) {\r\n    throw ApplicationFailure.create({\r\n      message: 'customer does not exist',\r\n      details: [{ customerId: payload.customerId }],\r\n      nonRetryable: true,\r\n    });\r\n  }\r\n  const cart = await getCart({ brand: payload.brand, userId: customer.id });\r\n  await checkCartIsLocked(cart);\r\n  await setCartLock({\r\n    brand: payload.brand,\r\n    userId: customer.id,\r\n    lock: false,\r\n  });\r\n  const checkoutDTO = plainToClass(CheckoutDTO, { cart, ...payload });\r\n  return checkoutDTO;\r\n};\r\n```\r\n\r\n### Describe the bug\r\n\r\nIt fails to start the worker, the worker fails to build the workflow file with webpack\r\n\r\n![Screenshot from 2023-05-25 12-38-19](https://github.com/temporalio/sdk-typescript/assets/26143873/513c8287-4033-4db0-a54e-66a72eda005f)\r\n\r\nHere the worker configuration:\r\n\r\n```typescript\r\nRuntime.install({});\r\n        const temporalHost =\r\n          configService.get<string>('app.temporalHost') || 'localhost:7233';\r\n        const connection = await NativeConnection.connect({\r\n          address: temporalHost,\r\n        });\r\n        const workflowsPath = require.resolve(\r\n          './use-cases/placeOrder/workflows',\r\n        );\r\n        const workflowBundle = await bundleWorkflowCode({\r\n          workflowsPath,\r\n        });\r\n        process.once('SIGUSR2', function () {\r\n          connection.close();\r\n        });\r\n        process.on('SIGINT', function () {\r\n          // this is only called on ctrl+c, not restart\r\n          connection.close();\r\n        });\r\n        return {\r\n          connection,\r\n          taskQueue: 'default',\r\n          workflowBundle,\r\n          activities,\r\n        };\r\n```\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: Linux\r\n- Temporal Version: Typescript SDK 1.7.4\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n","closedAt":"2023-05-26T13:56:12Z","comments":[{"id":"IC_kwDOEujx185dI7-k","author":{"login":"tareksalem"},"authorAssociation":"NONE","body":"### Update\r\n\r\nThe Error is not related to class transformer exactly, after some tries, I found that I can't even create a class inside the workflow from another file\r\n\r\nsuppose I have the following directory structure\r\n\r\n- dtos\r\n  - checkouDTO.ts\r\n- workflow.ts\r\n\r\nIf I import checkoutDTO and create a new insance inside the workflow it will fail as the following:\r\n\r\n```typescript\r\nimport { CheckoutDTO } from './dtos'\r\n\r\nfunction placeOrder() {\r\n\r\n  // activites here\r\n  const checkoutInstance = new CheckoutDTO() // will fail\r\n}\r\n```","createdAt":"2023-05-25T09:57:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1122#issuecomment-1562623908","viewerDidAuthor":false},{"id":"IC_kwDOEujx185dLNUv","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"In the screenshot above, we can see the following chain of imports:\r\n\r\n`workflows.ts` -> `placeOrder.ts` -> `dtos/index.ts` -> `@nestjs/swagger` -....-> `@nestjs/core`\r\n\r\nThat means that, as it is defined now, `workflows.ts` transitively imports the `@nestjs/core` package. That's not possible, as the Workflow sandbox disallow any module that have non-deterministic behavior. NestJS itself use a lot of non-deterministic stuff, including file IOs, network IO, use of environment variables, etc. That doesn't mean you can't use NestJS in your project, but simply that your Workflow code may not pull anything that relates to NestJS, not even _transitively_.\r\n\r\nHere are a few possible solutions to this:\r\n1. First of all, is it really appropriate that you instantiate a `CheckoutDTO` object from the Workflow? What will you do with that object? If you later pass that object to an activity, the object will get serialized to JSON, and the activity will get a plain object, without methods. Same if a workflow or an activity _returns_ an instance of a class; the caller (either a client or a workflow) will get a plain object.\r\n2. If `CheckoutDTO` itself doesn't need a dependency on `@nestjs/swagger`, consider making `workflow.ts` import `dtos/checkout-dto` (or whatever else), so that you avoid the problematic import.\r\n3. In some cases, you may be able to get away with simply doing `import type ... from ...` (mind the `type` keyword). That would give you the type definition, but won't allow you to _instantiate_ a class.\r\n4. If you are really sure that some module will not get executed at runtime, you may add that module to the `WorkflowBundlingOptions.ignoredModules`. For example, add `@nestjs/swagger` to that list would break the transitive dependency mentioned previously. But beware that this might cause errors at runtime if the code actually use that dependency.","createdAt":"2023-05-25T16:52:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1122#issuecomment-1563219247","viewerDidAuthor":false},{"id":"IC_kwDOEujx185dP1vz","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"@tareksalem Did that help?\r\n\r\nI will close this ticket, as I believe there is nothing more to be done on our side, but you can still add answer or ask more questions in relation in the present case. You may also ask questions on our Slack Workspace, on the #typescript-sdk channel.","createdAt":"2023-05-26T13:56:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1122#issuecomment-1564433395","viewerDidAuthor":false}],"createdAt":"2023-05-25T09:43:53Z","labels":[],"milestone":null,"number":1122,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Temporal worker fails to start if I am using class transformer","updatedAt":"2023-05-26T13:56:12Z","url":"https://github.com/temporalio/sdk-typescript/issues/1122"}
