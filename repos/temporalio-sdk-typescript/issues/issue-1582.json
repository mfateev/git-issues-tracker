{"assignees":[],"author":{"id":"MDQ6VXNlcjE1MDMzMTE=","is_bot":false,"login":"selbyk","name":"Selby Kendrick"},"body":"### What are you really trying to do?\r\n\r\n<!-- \r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\n-->\r\nWe want to update to the latest and have been running `@temporalio/*@1.11.2` since 9/25/24. I tried to update to `@temporalio/*@1.11.5` a few days ago and was faced with:\r\n```\r\n2024-12-10T21:41:34.484512Z  WARN temporal_sdk_core::worker::workflow: Failing workflow task run_id={{runId}} failure=Failure { failure: Some(Failure { message: \"[TMPRL1100] Nondeterminism error: Child workflow id of scheduled event 'task/{{uuid}}' does not match child workflow id of command 'task/{{different_uuid}}'\", source: \"\", stack_trace: \"\", encoded_attributes: None, cause: None, failure_info: Some(ApplicationFailureInfo(ApplicationFailureInfo { r#type: \"\", non_retryable: false, details: None, next_retry_delay: None })) }), force_cause: NonDeterministicError }\r\nReplay failed https://cloud.temporal.io/namespaces/{{namespace}}/workflows/{{wfid}}/{{runid}}\r\nDeterminismViolationError: Replay failed with a nondeterminism error. This means that the workflow code as written is not compatible with the history that was fed in. Details: Workflow activation completion failed: Failure { failure: Some(Failure { message: \"[TMPRL1100] Nondeterminism error: Child workflow id of scheduled event 'task/{{uuid}}' does not match child workflow id of command 'task/{{different_uuid}}'\", source: \"\", stack_trace: \"\", encoded_attributes: None, cause: None, failure_info: Some(ApplicationFailureInfo(ApplicationFailureInfo { r#type: \"\", non_retryable: false, details: None, next_retry_delay: None })) }), force_cause: NonDeterministicError }\r\n    at evictionReasonToReplayError (/Users/selby/projects/monorepo/node_modules/.pnpm/@temporalio+worker@1.11.5_@swc+helpers@0.5.6_esbuild@0.21.5/node_modules/@temporalio/worker/lib/replay.js:34:20)\r\n    at Worker.runReplayHistories (/Users/selby/projects/monorepo/node_modules/.pnpm/@temporalio+worker@1.11.5_@swc+helpers@0.5.6_esbuild@0.21.5/node_modules/@temporalio/worker/lib/worker.js:228:76)\r\n    at async replayWorkflows (/Users/selby/projects/monorepo/apps/temporal-workers/workflow-tests/replay.ts:2:3826)\r\n    at async replayWorkflowsInEnv (/Users/selby/projects/monorepo/apps/temporal-workers/workflow-tests/replay.ts:2:4907)\r\n    at async replay (/Users/selby/projects/monorepo/apps/temporal-workers/workflow-tests/replay.ts:2:6297) \r\n```\r\non almost all of some of our workflow history types, including our latest histories. They seem to replay fine on `@temporalio/*@1.11.3`.\r\n\r\n### Describe the bug\r\n\r\nWe use `uuid4()` (from `@temporalio/workflow`) to generate a `workflowId` => `task/uuid4()`, and we use that `workflowId` in `startChild({ workflowId })`. We replay all running and up to the last 500 completed histories on each of our workflow types on every PR/deploy, and this part of our code and the replays have been stable for months.\r\n\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n\r\n### Minimal Reproduction\r\n\r\nMaybe we can find a minimal reproduction together. I just want to get this on your radar.\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: M2 Mac and Linux (GH Actions)\r\n- Temporal Version: 1.11.5\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n","closedAt":"2025-04-16T13:29:43Z","comments":[{"id":"IC_kwDOEujx186iQ43_","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Hey @selbyk! Would you be able to provide a bit more information regarding this error?","createdAt":"2025-03-13T18:26:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1582#issuecomment-2722336255","viewerDidAuthor":false},{"id":"IC_kwDOEujx186mVU1u","author":{"login":"selbyk"},"authorAssociation":"NONE","body":"Yeah, sorry for the delay. We were really hoping this was going to be a more widespread issue that would be resolved quickly. We're still on v1.11.2.\n\nWe have decided to make it a priority this sprint to investigate what's happening. Our core workflows are rather complex, so I will dig in and try to distill down to the root of it as best I can. I'll report back when I have something to share.","createdAt":"2025-04-09T18:35:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1582#issuecomment-2790608238","viewerDidAuthor":false},{"id":"IC_kwDOEujx186micZx","author":{"login":"selbyk"},"authorAssociation":"NONE","body":"@mjameswh Ok, this morning I finally had some time to get on this. We have 3 workflows that have replay discrepancies between v1.11.2 and v1.11.7. Two of them are very complex, but fortunately one of them is relatively small and straight forward.\n\nHow do we go from here? What is valuable to help with this on your end?","createdAt":"2025-04-10T14:52:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1582#issuecomment-2794047089","viewerDidAuthor":false},{"id":"IC_kwDOEujx186mmFaf","author":{"login":"selbyk"},"authorAssociation":"NONE","body":"So, we have narrowed down the cause on our small, straight forward workflow. It appears like a breaking change to the behavior of `signalWithStart`.\n\nI downloaded the workflow history and used the Temporal VS Code extension to run v1.11.2 and v1.11.7 in the debugger:\n\n```ts\nexport const mvpWorkflow: MVPWorkflow.Definition = async ({\n\twebhooks = [],\n}) => {\n\tsetHandler(webhookPayload, (incomingWebhook) => { // Breakpoint 1\n\t\twebhooks.push(incomingWebhook);\n\t\tlogger.debug('mvpWorkflow incoming webhook', { // Breakpoint 2\n\t\t\twebhooks,\n\t\t\tincomingWebhook,\n\t\t});\n\t});\n\n\tif (webhooks.length > 0) { // Breakpoint 3\n\t\tconst lastWebhook = webhooks.at(-1)!;\n\t\twebhooks = [];\n\t\tlogger.debug('processing webhook', {\n\t\t\tlastWebhook,\n\t\t\twebhooks,\n\t\t});\n\t\tawait processUpdateOrCreate({ data: lastWebhook });\n\t}\n\n\tawait sleep('1m');\n\n\tif (webhooks.length > 0) {\n\t\treturn await continueAsNew<typeof mvpWorkflow>({\n\t\t\tmetadata,\n\t\t\twebhooks,\n\t\t});\n\t}\n};\n```\n\nv1.11.2 hits breaks in this order: `1`, `2`, `3` (webhooks.length = 1)\n\nv1.11.7 hits breaks in this order: `1`, `3` (webhooks.length = 0), `2`\n\nAnd expectedly, the v1.11.7 replay fails because the `processUpdateOrCreate` activity is never hit.\n\nI will look into our other two workflows as well. One of those also uses `signalWithStart` heavily so I expect it to be the same issue, but the other one doesn't so I'll start there.","createdAt":"2025-04-10T19:44:58Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1582#issuecomment-2795001503","viewerDidAuthor":false},{"id":"IC_kwDOEujx186mwQEe","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"@selbyk Thanks for the updates.\n\nAssuming the webhookPayload signal is dispatched as part of the first workflow task (which is guaranteed to be the case when workflow is started using `signalWithStart`), the order should indeed be 1-2-3. This has never changed.\n\nI can't reproduce the 1-3-2 sequence on my side. The following code gives me 1-2-3 in both 1.11.2 and 1.11.7. This is also the order I get if I put breakpoints on those three lines and replay using the Temporal VS Code extension using SDK 1.11.7.\n\n```\n// workflows.ts\nexport async function example(): Promise<void> {\n  console.log('### checkpoint 1');\n  setHandler(defineSignal('mySignal'), async () => {\n    console.log('### checkpoint 2');\n  });\n  console.log('### checkpoint 3');\n}\n\n// client.ts\nconst handle = await client.workflow.signalWithStart(example, {\n  taskQueue: 'repro',\n  workflowId: 'workflow-' + nanoid(),\n  signal: 'mySignal',\n});\n```\n\nCan you try to work from this code and see if you can replicate the issue you are seeing?","createdAt":"2025-04-11T18:01:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1582#issuecomment-2797666590","viewerDidAuthor":false},{"id":"IC_kwDOEujx186nV_hU","author":{"login":"selbyk"},"authorAssociation":"NONE","body":"@mjameswh I'm not sure what you want to do with this issue, but just to follow up for anyone else who may run into it and winds up here. We ended up hopping on a call last week and, thanks to James and Thomas, traced the issue(s) back to changes in the OpenTelemetry interceptors.\n\nWe fixed our non-determinism errors by patching the interceptors:\n```ts\nclass OTELInboundInterceptor extends OpenTelemetryInboundInterceptor {\n\tpublic handleSignal(input: SignalInput, next: Next<WorkflowInboundCallsInterceptor, 'handleSignal'>): Promise<void> {\n\t\tif (patch) {\n\t\t\t// Patch needed because of a change in OpenTelemetryInboundInterceptor that broke determinism\n\t\t\treturn super.handleSignal(input, next);\n\t\t}\n\t\treturn next(input);\n\t}\n}\n\nclass OTELOutboundInterceptor extends OpenTelemetryOutboundInterceptor {\n\tpublic async scheduleLocalActivity(\n\t\tinput: LocalActivityInput,\n\t\tnext: Next<WorkflowOutboundCallsInterceptor, 'scheduleLocalActivity'>,\n\t): Promise<unknown> {\n\t\tif (patch) {\n\t\t\t// Patch needed because of a change in OpenTelemetryOutboundInterceptor that broke determinism\n\t\t\treturn super.scheduleLocalActivity(input, next);\n\t\t}\n\t\treturn next(input);\n\t}\n}\n```\n\nReplace `patch` with your patch.\n\nThank you again for so much of your time tracking down the issue. Next time I should be able to narrow it down further before opening a ticket with better details.","createdAt":"2025-04-15T21:27:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1582#issuecomment-2807560276","viewerDidAuthor":false},{"id":"IC_kwDOEujx186ndxfl","author":{"login":"selbyk"},"authorAssociation":"NONE","body":"I see https://github.com/temporalio/sdk-typescript/issues/1677 was opened to cover this, so closing this one.","createdAt":"2025-04-16T13:29:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1582#issuecomment-2809599973","viewerDidAuthor":false}],"createdAt":"2024-12-10T22:00:40Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1582,"reactionGroups":[{"content":"EYES","users":{"totalCount":3}}],"state":"CLOSED","title":"[Bug] 1.11.2 workflow histories failing to replay on 1.11.5","updatedAt":"2025-04-16T13:29:44Z","url":"https://github.com/temporalio/sdk-typescript/issues/1582"}
