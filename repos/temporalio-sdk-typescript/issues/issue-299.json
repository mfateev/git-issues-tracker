{"assignees":[{"id":"MDQ6VXNlcjUyMzA0","login":"bergundy","name":"Roey Berman","databaseId":0}],"author":{"id":"MDQ6VXNlcjUyMzA0","is_bot":false,"login":"bergundy","name":"Roey Berman"},"body":"### Describe the bug\r\n\r\nThere seems to be an issue with interceptors and query registration.\r\n\r\nInterceptors integration test is flaky.\r\n\r\nhttps://github.com/temporalio/sdk-node/pull/296/checks?check_run_id=3883673737\r\n\r\n```\r\n@temporalio/test:     message: '3 INVALID_ARGUMENT: Workflow did not register a handler for getSecret',\r\n```\r\n\r\n### To Reproduce\r\n\r\nI thought this was fixed because it stopped reproducing locally.\r\nShould be reproducible by running the entire test suite.\r\n\r\n### Expected behavior\r\n\r\nQueries and interceptors should be compatible.\r\n\r\n### Versions\r\n\r\nmain branch\r\n\r\n### Additional context\r\n\r\nThis is probably due to interceptors running async functions causing a race when start workflow, signal and query are all delivered in a single activation.","closedAt":"2021-10-14T17:38:27Z","comments":[{"id":"IC_kwDOEujx1844PAep","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Managed to reproduce this locally pretty consistently by not awaiting the signal before sending the query to the workflow.\r\nThis results in an activation that looks like this:\r\n```\r\n2021-10-14T15:14:29.440Z [DEBUG] Got workflow activation {\r\n  runId: 'be16eb44-9585-42bb-bac8-2099a8d829d5',\r\n  jobs: [\r\n    WFActivationJob { startWorkflow: [StartWorkflow] },\r\n    WFActivationJob { signalWorkflow: [SignalWorkflow] },\r\n    WFActivationJob { queryWorkflow: [QueryWorkflow] }\r\n  ],\r\n  timestamp: Timestamp {\r\n    seconds: Long { low: 1634224469, high: 0, unsigned: false },\r\n    nanos: 359507511\r\n  }\r\n}\r\n```\r\nI think the solution here is to buffer the query until workflow function has been invoked.","createdAt":"2021-10-14T15:16:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/299#issuecomment-943458217","viewerDidAuthor":false}],"createdAt":"2021-10-13T14:43:19Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":2,"title":"beta","description":"","dueOn":null},"number":299,"reactionGroups":[],"state":"CLOSED","title":"[Bug] INVALID_ARGUMENT: Workflow did not register a handler for getSecret in IT","updatedAt":"2021-10-14T17:38:27Z","url":"https://github.com/temporalio/sdk-typescript/issues/299"}
