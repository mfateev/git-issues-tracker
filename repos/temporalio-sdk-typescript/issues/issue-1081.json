{"assignees":[],"author":{"id":"MDQ6VXNlcjM3MDgyMDA5","is_bot":false,"login":"josiah-roberts","name":"Josiah \"Rebase\" Roberts"},"body":"[Link to thread](https://temporalio.slack.com/archives/C01DKSMU94L/p1678908893942829) with @bergundy\r\n\r\n### Is your feature request related to a problem? Please describe.\r\n\r\nThere's a common need to keep track of what queries and signals are legal to send to a workflow _at this moment_. My team is creating a layer for this internally, but it would be ideal to solve it on a SDK level.\r\n\r\n### Describe the solution you'd like\r\n\r\nI'd like to see a built-in query which returns the queries and signals being currently listened to. This could take two forms:\r\n\r\n**Separate**  \r\n* A `QueryDefinition<Array<string>, []>` named `queries`\r\n* A `QueryDefinition<Array<string>, []>` named `signals`\r\n\r\n**Together**\r\n* A `QueryDefinition<Array<{ name: string, type: 'query' | 'signal' }>, []>` named `handlers`\r\n\r\nIn either case, we can't preserve the _type information_ about these queries or signals, but we can at least maintain the knowledge of whether there is an active `setHandler(name, () => {...})` for a given name. This allows us to drive UX experiences that only allow **_currently legal_** operations, which is a powerful technique for code-as-source-of-truth on our workflows.\r\n\r\n### Additional context\r\n\r\nHere's a spike implementation for a `trackHandler` shim over `setHandler` that we're working on internally. Workflows need to be wrapped with `trackHandlers` in the form `export const myWorkflow = (args: Args) => trackHandlers(myWorkflowImpl, args);`. _If this was built-in, such wrapping would not be needed._\r\n\r\n```typescript\r\nconst trackedHandlerStorage = new AsyncLocalStorage<Set<string>>();\r\nconst getTrackedHandlers = () => {\r\n  const handlers = trackedHandlerStorage.getStore();\r\n  if (!handlers) {\r\n    throw new IllegalStateError('Not in a tracked context!');\r\n  }\r\n  return handlers;\r\n};\r\n\r\nexport const trackHandler: typeof setHandler = (def, handler) => {\r\n  const handlers = getTrackedHandlers();\r\n  handlers.add(def.name);\r\n  setHandler(def, ((...args) => {\r\n    trackedHandlerStorage.enterWith(handlers);\r\n    if (handler) {\r\n      return handler(...(args as Parameters<typeof handler>));\r\n    }\r\n    return undefined;\r\n  }) as typeof handler);\r\n};\r\n\r\nexport const clearHandler = (def: Parameters<typeof setHandler>[0]) => {\r\n  const handlers = getTrackedHandlers();\r\n  handlers.delete(def.name);\r\n  setHandler(def, undefined);\r\n};\r\n\r\nexport const clearHandlers = (defs: Array<Parameters<typeof setHandler>[0]>) => {\r\n  for (const def of defs) {\r\n    clearHandler(def);\r\n  }\r\n};\r\n\r\nexport const handlersQuery = defineQuery<string[]>('handlers');\r\nexport const trackHandlers = <R, TArgs extends any[]>(\r\n  callback: (...args: TArgs) => R,\r\n  ...args: TArgs\r\n): R =>\r\n  trackedHandlerStorage.run(new Set(), () => {\r\n    const handlersRef = getTrackedHandlers();\r\n    trackHandler(handlersQuery, () => [...handlersRef]);\r\n    return callback(...args);\r\n  });\r\n```","closedAt":"2025-01-21T18:39:25Z","comments":[{"id":"IC_kwDOEujx185XxjbI","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Thank you for this, I’m mostly afk until the end of the week. I’ll take some time to think about this and respond.","createdAt":"2023-03-16T19:16:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1081#issuecomment-1472607944","viewerDidAuthor":false},{"id":"IC_kwDOEujx185YbgN-","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Haven't forgotten about this.\r\nI want @cretz to review the response structure for the built-in query because we want this cross SDKs and he's really good and opinionated at API design.","createdAt":"2023-03-24T23:55:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1081#issuecomment-1483604862","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Yh41G","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I made a comment at https://github.com/temporalio/features/issues/51#issuecomment-1485273243\r\n\r\nEven though it contains a lot of details, can ignore most and just impl the \"get workflow metadata\" query to start with. We do need this as protos in https://github.com/temporalio/api/tree/master/temporal/api/sdk/v1 though, not just TS definitions.","createdAt":"2023-03-27T15:00:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1081#issuecomment-1485278534","viewerDidAuthor":false},{"id":"IC_kwDOEujx186N1zju","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"@antlai-temporal Can we close this ticket? I believe you implemented that in #1319. Anything left here?","createdAt":"2024-09-27T16:52:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1081#issuecomment-2379692270","viewerDidAuthor":false},{"id":"IC_kwDOEujx186bTHPy","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Covered by the metadata query. Done.","createdAt":"2025-01-21T18:39:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1081#issuecomment-2605478898","viewerDidAuthor":false}],"createdAt":"2023-03-16T17:15:35Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1081,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"[Proposal] Built-in registered handlers query","updatedAt":"2025-01-21T18:39:26Z","url":"https://github.com/temporalio/sdk-typescript/issues/1081"}
