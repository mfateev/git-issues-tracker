{"assignees":[],"author":{"id":"MDQ6VXNlcjUyMzA0","is_bot":false,"login":"bergundy","name":"Roey Berman"},"body":"### What are you really trying to do?\r\n\r\nUse an ESM module as a custom payload converter.\r\n\r\n### Describe the bug\r\n\r\nWhen an ESM module is used as a custom payload converter, the SDK tries to `require` it, which results in the follow error:\r\n\r\nhttps://github.com/temporalio/sdk-typescript/blob/3088f86ce6fe0c7072ba55c4db901a70b631f87e/packages/common/src/internal-non-workflow/data-converter-helpers.ts#L22\r\n\r\n(from slack)\r\n\r\n```\r\nError [ERR_REQUIRE_ESM]: require() of ES Module *****/services/asm-saas-worker/build/lib/payload-converter.js from /Users/nohehf/Documents/ESCAPE/product/node_modules/@temporalio/common/lib/internal-non-workflow/data-converter-helpers.js not supported.\r\nInstead change the require of payload-converter.js in *****/node_modules/@temporalio/common/lib/internal-non-workflow/data-converter-helpers.js to a dynamic import() which is available in all CommonJS modules.\r\n    at Hook._require.Module.require (*****/node_modules/require-in-the-middle/index.js:188:39)\r\n    at requireConverter (*****/node_modules/@temporalio/common/lib/internal-non-workflow/data-converter-helpers.js:17:18)\r\n    at loadDataConverter (*****/node_modules/@temporalio/common/lib/internal-non-workflow/data-converter-helpers.js:46:28)\r\n    at compileWorkerOptions (*****/node_modules/@temporalio/worker/lib/worker-options.js:167:76)\r\n    at Worker.create (*****/node_modules/@temporalio/worker/lib/worker.js:141:75)\r\n    at createTemporalWorker (file://*****/packages/temporal-worker/build/index.js:21:33)\r\n    at async file://*****/services/asm-saas-worker/build/index.js:44:16 {\r\n  code: 'ERR_REQUIRE_ESM'\r\n}\r\n```\r\n\r\n### Additional context\r\n\r\nSee the slack thread here (while the history is still retained): https://temporalio.slack.com/archives/C01DKSMU94L/p1699973888839069\r\n","closedAt":null,"comments":[{"id":"IC_kwDOEujx185r87zA","author":{"login":"nohehf"},"authorAssociation":"NONE","body":"Thanks @bergundy for opening the issue, I'll report my findings here asap. I'm currently trying to find a way around this.","createdAt":"2023-11-14T19:59:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1292#issuecomment-1811135680","viewerDidAuthor":false},{"id":"IC_kwDOEujx185r9HLr","author":{"login":"nohehf"},"authorAssociation":"NONE","body":"Here are the things I noticed while looking through the codebase:\r\nThe payload converter is loaded differently at: https://github.com/temporalio/sdk-typescript/blob/3088f86ce6fe0c7072ba55c4db901a70b631f87e/packages/common/src/internal-non-workflow/data-converter-helpers.ts#L22 and here https://github.com/temporalio/sdk-typescript/blob/3088f86ce6fe0c7072ba55c4db901a70b631f87e/packages/workflow/src/worker-interface.ts#L110\r\n\r\nThe payload converter is passed to Webpack via an alias: \r\nhttps://github.com/temporalio/sdk-typescript/blob/3088f86ce6fe0c7072ba55c4db901a70b631f87e/packages/worker/src/workflow/bundler.ts#L206\r\n\r\nWhereas the other code that needs to be bundled (e.g. workflows code) is bundled in a file:\r\nhttps://github.com/temporalio/sdk-typescript/blob/3088f86ce6fe0c7072ba55c4db901a70b631f87e/packages/worker/src/workflow/bundler.ts#L159\r\n\r\nThis might create some issues? I don't know how Webpack will resolve the aliases here, but as I have no issue importing ESM workflows, this might be the root cause.\r\n\r\nAlso, if I run this in my development mode (importing an ESM `.ts` payload converter) via [tsx](https://www.npmjs.com/package/tsx), so maybe it would help to bundle all the code via some modern bundler like [esbuild](https://github.com/evanw/esbuild) (which tsx uses) might help here (+ resolve other potential issues / add some benefits like speed).\r\n\r\nIs there a particular reason why the bundle is in commonjs ? Just enforcing ESM seems to be the way to go nowadays. Also, node16 is not the LTS now.\r\n\r\nPS: those are a few remarks I noted while trying to fix my issue, not critics, and I'm looking forward to helping/contributing here if possible; I hope this helps.\r\n\r\nPS2: Also, having general guidelines / docs on how to pack our code (workflows, converters...) would be nice.","createdAt":"2023-11-14T20:18:55Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1292#issuecomment-1811182315","viewerDidAuthor":false},{"id":"IC_kwDOEujx185sVim7","author":{"login":"nohehf"},"authorAssociation":"NONE","body":"After a lot of trial and error, I could finally bundle my ESM code into a commonjs payload converter using `esbuild`.\r\nHere's the command/settings that worked for me:\r\n```bash\r\nesbuild --bundle --outfile=build/index.cjs --target=esnext --platform=node --external:@temporalio/common --external:@bufbuild/protobuf src/index.ts\r\n```\r\nThe key here was to externalize `@temporalio` dependencies from the bundle, causing issues if bundled. I also externalized the dependencies that could be imported from commonjs (here `@bufbuild/protobuf`).\r\n\r\nWould you like to put this into the docs or integrate it into `@temporalio/worker` bundler?","createdAt":"2023-11-18T18:08:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1292#issuecomment-1817586107","viewerDidAuthor":false},{"id":"IC_kwDOEujx185wlvcM","author":{"login":"izakfilmalter"},"authorAssociation":"NONE","body":"@nohehf are you using `bundleWorkflowCode`? Or are you creating your own bundle? Trying to understand how to make this work with https://github.com/temporalio/samples-typescript/tree/main/production","createdAt":"2024-01-12T11:40:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1292#issuecomment-1888941836","viewerDidAuthor":false},{"id":"IC_kwDOEujx185yIdJq","author":{"login":"nohehf"},"authorAssociation":"NONE","body":"Hey @izakfilmalter\r\nWe use `bundleWorkflowCode` (indirectly through `Worker.create`).\r\nWe only manually bundle the converter to cjs via `esbuild` using the command above https://github.com/temporalio/sdk-typescript/issues/1292#issuecomment-1817586107. The converter is exported in a dedicated package and then imported using a require.\r\nSo in the end we have something like:\r\n```ts\r\nimport * as activities from './activities/index.js';\r\n// [...]\r\nconst connection = await NativeConnection.connect({ address: url });\r\n\r\nconst require = createRequire(import.meta.url);\r\n\r\nconst worker = await Worker.create({\r\n  workflowsPath: require.resolve('./workflows/index.js'),\r\n  taskQueue: 'my-ts-task-queue',\r\n  activities,\r\n  dataConverter: {\r\n    payloadConverterPath: require.resolve('<organization>/temporal-converter'), // <organization>/temporal-converter being the package name in our yarn/npm workspaces\r\n  },\r\n});\r\n```\r\n\r\nWorkflows and activities are written in TS ESM next.\r\nConverter is bundled to cjs.\r\nHope this helps :))\r\nPS: sorry for the delay, missed the notification somehow.","createdAt":"2024-01-29T14:34:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1292#issuecomment-1914819178","viewerDidAuthor":false},{"id":"IC_kwDOEujx186aoL_x","author":{"login":"rclmenezes"},"authorAssociation":"NONE","body":"I ended up using tsup like this:\n\n```javascript\n// tsup.config.js\nimport { defineConfig } from \"tsup\";\n\nexport default defineConfig({\n  entry: [\"src/index.ts\"],\n  splitting: false,\n  sourcemap: true,\n  clean: true,\n  outDir: \"build\",\n  external: [\"pg-native\", \"@temporal/common\", \"@bufbuild/protobuf\"],\n  target: \"esnext\",\n});\n```\n\nAnd this in my package.json:\n```json\n{\n  ...\n  \"scripts\": {\n    \"build\": \"tsup --config tsup.config.js --dts\",\n    \"dev\": \"dotenvx run --env-file=../app/.env --env-file=../app/.env.local --env-file=../app/.env.development -- pnpm tsx watch ./src/index.ts\",\n    \"format\": \"prettier --write \\\"**/*.{ts,tsx,md}\\\"\",\n    \"lint\": \"eslint ./src/*\",\n    \"lint:fix\": \"pnpm lint --fix\",\n    \"start\": \"node ./build/index.cjs\",\n    \"start:dev\": \"dotenvx run --env-file=../app/.env --env-file=../app/.env.local --env-file=../app/.env.development -- pnpm tsx ./build/index.cjs\",\n    \"typecheck\": \"tsc --noEmit\"\n  },\n  ...\n}\n```\n\nAnd to make my path work both in ESM and CJS:\n\n```typescript\n// worker.js\n\nconst currentDirname: string =\n  typeof __dirname !== \"undefined\" ? __dirname : path.dirname(fileURLToPath(import.meta.url));\n\nasync function run() {\n  const connection = await NativeConnection.connect({\n    address: process.env.TEMPORAL_ADDRESS ?? \"localhost:7233\",\n  });\n\n  const worker = await Worker.create({\n    workflowsPath: path.join(currentDirname, \"../../../packages/workflows/src/workflows.ts\"),\n    activities,\n    namespace: TEMPORAL_NAMESPACE,\n    taskQueue: TEMPORAL_TASK_QUEUE,\n    connection,\n  });\n\n  await worker.run();\n}\n```\n\nWorked great\n\nI still wish I could export as an ESM though... It would be lovely if @temporal/common didn't have dynamic requires","createdAt":"2025-01-16T00:46:14Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1292#issuecomment-2594226161","viewerDidAuthor":false}],"createdAt":"2023-11-14T17:58:06Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1292,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"OPEN","title":"[Bug] ESM Custom payload converters cannot be loaded","updatedAt":"2025-01-16T00:47:53Z","url":"https://github.com/temporalio/sdk-typescript/issues/1292"}
