{"assignees":[],"author":{"id":"MDQ6VXNlcjQyNjkwNzkw","is_bot":false,"login":"YufeeXing","name":"Mason Xing"},"body":"From your official doc\r\n![image](https://github.com/temporalio/sdk-typescript/assets/42690790/9cf3b316-94ec-4d59-b06b-e6d412535206)\r\nIf I want to validate the header by a remote authentication service. But in different env, the URL of the authentication service is different.\r\n\r\nAnd for determinism, the 'process' is forbidden in this workflow inbound interceptor. So how to handle this situation?\r\nLook forward to your reply. Thanks.\r\n","closedAt":"2023-06-27T08:42:07Z","comments":[{"id":"IC_kwDOEujx185eX6uc","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"One possibility would be to call a local activity from your Workflow inbound interceptor. From that activity, you will be able to access environment variables and make calls to your external auth service.\r\n\r\nYou will however need to be careful to ensure that no sensitive data get written to the history. Note that, at the moment, TS SDK does not process [headers through Payload codecs](https://github.com/temporalio/sdk-typescript/issues/514). You may however easily encode the auth header by yourself before starting the Workflow, and decode that in your auth checking Activity. You should also embed details about the Workflow execution itself in that same encrypted header (eg. the Workflow Id, a checksum of args, approximate date/time of start, etc) so that a previous header value can't be reused to start a new Workflow Execution.\r\n\r\nNote that this design is not the only possible solution, and other approaches may be more appropriate in some use cases. Before taking a decision, you should carefully analyze your threat model.","createdAt":"2023-06-08T20:53:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1135#issuecomment-1583328156","viewerDidAuthor":false},{"id":"IC_kwDOEujx185eZxBZ","author":{"login":"YufeeXing"},"authorAssociation":"NONE","body":"> One possibility would be to call a local activity from your Workflow inbound interceptor. From that activity, you will be able to access environment variables and make calls to your external auth service.\r\n> \r\n> You will however need to be careful to ensure that no sensitive data get written to the history. Note that, at the moment, TS SDK does not process [headers through Payload codecs](https://github.com/temporalio/sdk-typescript/issues/514). You may however easily encode the auth header by yourself before starting the Workflow, and decode that in your auth checking Activity. You should also embed details about the Workflow execution itself in that same encrypted header (eg. the Workflow Id, a checksum of args, approximate date/time of start, etc) so that a previous header value can't be reused to start a new Workflow Execution.\r\n> \r\n> Note that this design is not the only possible solution, and other approaches may be more appropriate in some use cases. Before taking a decision, you should carefully analyze your threat model.\r\n\r\nThanks, @mjameswh. Got your point and will try.","createdAt":"2023-06-09T01:50:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1135#issuecomment-1583812697","viewerDidAuthor":false},{"id":"IC_kwDOEujx185eafM0","author":{"login":"YufeeXing"},"authorAssociation":"NONE","body":"So, must use a local activity,right? Becaust there is no grpc request between the workflow and the local activity, if all the grpc request need authentication.\r\nHow to define a local activity or how to judge a activity is local or not?","createdAt":"2023-06-09T05:34:50Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1135#issuecomment-1584001844","viewerDidAuthor":false},{"id":"IC_kwDOEujx185ee4JE","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"> So, must use a local activity,right? Becaust there is no grpc request between the workflow and the local activity, if all the grpc request need authentication.\r\n\r\nI mentioned Local Activities, but a regular Activity would also work. The main advantages of Local Activities are:\r\n\r\n- Much lower latency\r\n- Lower foot print in the Workflow History\r\n- Guaranteed to be executed locally\r\n\r\nFor things such as \"I want to get the value of an environment variable\", using Local Activities is the obvious choice. We don't generally recommend using Local Activities for making call to external services, but they still sometime make sense if the service you are calling to is very fast, has very low probability of failure, and that retrying an operation is very cheap. I'm assuming this might be the case for your authorization service, but I may be wrong. I suggest you get a look at [this page](https://docs.temporal.io/activities#local-activity) for details on what Local Activities are and why you may want to use them over regular Activities. \r\n\r\n> How to define a local activity or how to judge a activity is local or not?\r\n\r\nIn TS SDK, the only difference in calling an Local Activity rather than an Activity is that you use `proxyLocalActivities(...)` rather than `proxyActivities(...)`. Also make sure that you set the `startToCloseTimeout` in `LocalActivityOptions` (there is a known bug in TS SDK up to 1.7.4 if you only set `scheduleToCloseTimeout`). That's it.","createdAt":"2023-06-09T21:38:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1135#issuecomment-1585152580","viewerDidAuthor":false},{"id":"IC_kwDOEujx185ekdfy","author":{"login":"YufeeXing"},"authorAssociation":"NONE","body":"Thanks, @mjameswh .\r\nI think a regular Activity may not work, becasue the goal is to authenticate all the grpc requests. As I know, There is a grpc request between a Workflow and a regular Activity. So the Activity about authtication with env variable may be blocked. This may cause a deadlock?\r\n\r\nAnd how to change a grpc header in the Interceptor or in the Activity of a Interceptor. I found a setMetadata method of NativeConnection instance, but how to get a nativeConnection instance in a interceptor? Or is there another way to change the grpc headers in the interceptors?","createdAt":"2023-06-12T05:38:38Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1135#issuecomment-1586616306","viewerDidAuthor":false},{"id":"IC_kwDOEujx185etju1","author":{"login":"YufeeXing"},"authorAssociation":"NONE","body":"```\r\n import { toPayloads, DefaultPayloadConverter } from '@temporalio/common';\r\n\r\n// in a interceptor\r\nconst token: string = await generateToken();\r\ninput.headers.Authorization = toPayloads(new DefaultPayloadConverter() ,token)![0];\r\nreturn await next(input);\r\n```\r\nI think this may work, but I am not sure if it can use the string token in the toPayloads function because the defaultPayloadConverter only support byteArray and JSON.","createdAt":"2023-06-13T10:20:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1135#issuecomment-1589001141","viewerDidAuthor":false}],"createdAt":"2023-06-07T10:49:07Z","labels":[],"milestone":null,"number":1135,"reactionGroups":[],"state":"CLOSED","title":"[Support] How to implement a real Authorization workflow inbound interceptor","updatedAt":"2023-06-27T08:42:07Z","url":"https://github.com/temporalio/sdk-typescript/issues/1135"}
