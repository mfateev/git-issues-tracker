{"assignees":[],"author":{"id":"MDQ6VXNlcjI1MTI4OA==","is_bot":false,"login":"lorensr","name":"Loren ☺️"},"body":"### What are you really trying to do?\r\n\r\n<!-- \r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\n-->\r\n\r\nSupport users who run TS SDK worker code multiple times.\r\n\r\n### Describe the bug\r\n\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n\r\nWhen `native.registerErrors(errors)` is run a second time, you get this error:\r\n\r\n```\r\nthread '<unnamed>' panicked at 'Must call `into_inner` or `drop` on `Root` https://docs.rs/neon/latest/neon/sync/index.html#drop-safety', /Users/runner/.cargo/registry/src/github.com-1ecc6299db9ec823/neon-0.8.3/src/handle/root.rs:182:13\r\nstack backtrace:\r\n   0:        0x113d2bd14 - <std::sys_common::backtrace::_print::DisplayBacktrace as core::fmt::Display>::fmt::h8483effd3e9ec544\r\n   1:        0x113d45c0c - core::fmt::write::ha34752bcd39bca36\r\n   2:        0x113d26304 - std::io::Write::write_fmt::hfc57a6e48a9ddae2\r\n   3:        0x113d2d474 - std::panicking::default_hook::{{closure}}::he9aaba83dd453f35\r\n   4:        0x113d2d054 - std::panicking::default_hook::hc87ff103cfd8260f\r\n   5:        0x113d2dab4 - std::panicking::rust_panic_with_hook::hf890018b6cf19ef5\r\n   6:        0x1135eb4bc - std::panicking::begin_panic::{{closure}}::hc28ceab4bf363482\r\n   7:        0x1135eae34 - std::sys_common::backtrace::__rust_end_short_backtrace::h28965f507c5b3b3b\r\n   8:        0x113d4df90 - std::panicking::begin_panic::hd003aa45410d163b\r\n   9:        0x113666e88 - <neon::handle::root::Root<T> as core::ops::drop::Drop>::drop::h24d3c7b78d11aee1\r\n  10:        0x11363f788 - temporal_sdk_typescript_bridge::errors::register_errors::h43400655bb40e232\r\n  11:        0x1136d237c - neon::context::internal::Scope<R>::with::hf709c02593da6b84\r\n  12:        0x11360845c - <neon::types::internal::FunctionCallback<T> as neon::types::internal::Callback<*mut neon_runtime::napi::bindings::types::Value__>>::invoke::he86aaaa185b14e07\r\nWarning: neon::sync::Root leaked during a panic\r\n FAIL  tests/sequential/queues/addCronJob/producer.test.ts\r\n  ● Test suite failed to run\r\n\r\n    internal error in Neon module: Must call `into_inner` or `drop` on `Root` https://docs.rs/neon/latest/neon/sync/index.html#drop-safety\r\n\r\n      at Object.<anonymous> (../../node_modules/@temporalio/worker/src/worker.ts:64:8)\r\n      at Object.<anonymous> (../../node_modules/@temporalio/worker/src/index.ts:11:1)\r\n```\r\n\r\nComing from: https://github.com/temporalio/sdk-typescript/blob/2232465a4f9b0cade28f0c21c2d7856053678728/packages/worker/src/worker.ts#L64\r\n\r\n### Minimal Reproduction\r\n\r\nCan make, lmk if helpful.\r\n\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\n### Environment/Versions\r\n\r\n`@temporalio/worker@0.17.2`\r\n\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n\r\nReported by user: https://temporalio.slack.com/archives/C01DKSMU94L/p1644200062345539","closedAt":"2022-02-11T22:36:23Z","comments":[{"id":"IC_kwDOEujx1849goH8","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"Moved to TS SDK - this is a bug in the bridge (or higher, depending on your opinion), but not Core.","createdAt":"2022-02-07T21:46:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/469#issuecomment-1031963132","viewerDidAuthor":false},{"id":"IC_kwDOEujx1849grA-","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Ah, I see, thanks. \r\n\r\nhttps://github.com/temporalio/sdk-typescript/blob/2232465a4f9b0cade28f0c21c2d7856053678728/packages/core-bridge/src/errors.rs#L64-L92\r\n","createdAt":"2022-02-07T22:00:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/469#issuecomment-1031974974","viewerDidAuthor":false},{"id":"IC_kwDOEujx1849hAZP","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"@lorensr Yup. That function should probably just use a `OnceCell<bool>` to lift the restriction it imposes on callers, and just do nothing if initialization has already occurred.","createdAt":"2022-02-07T23:57:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/469#issuecomment-1032062543","viewerDidAuthor":false},{"id":"IC_kwDOEujx1849hJXE","author":{"login":"SamSokolin"},"authorAssociation":"CONTRIBUTOR","body":"Just want to leave a bit more detail on the specific use case triggering this issue. We have a \"Module A\" which depends on \"@temporalio/worker\" and a \"Module B\" which depends on \"Module A\". We have integration tests for \"Module A\" written using the Jest framework. In these integration tests, we would like to mock some (but not all) of the functions implemented in \"Module B\". Jest allows you to do this using the `requireActual` function:\r\nhttps://jestjs.io/docs/jest-object#jestrequireactualmodulename\r\n\r\nThis function resolves the original module, and then also implements mocks for any specified functions. Since we want to mock \"Module B\"  differently for each suite of tests defined across our multiple Jest test files, we need to call `jest.mock` and `requireActual` multiple times.","createdAt":"2022-02-08T00:52:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/469#issuecomment-1032099268","viewerDidAuthor":false}],"createdAt":"2022-02-07T21:44:28Z","labels":[],"milestone":null,"number":469,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Allow registerErrors to be called multiple times","updatedAt":"2022-02-11T22:36:23Z","url":"https://github.com/temporalio/sdk-typescript/issues/469"}
