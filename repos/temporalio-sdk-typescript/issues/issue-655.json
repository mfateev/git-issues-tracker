{"assignees":[],"author":{"id":"MDQ6VXNlcjE5Nzk1","is_bot":false,"login":"beaucollins","name":"Beau Collins"},"body":"### What are you really trying to do?\r\n\r\nWe have problems surrounding the `ActivityInterface` type adding a string index to our interfaces.\r\n\r\n\r\n\r\n### Describe the bug\r\n\r\nThe `proxyActivities<A extends ActivityInterface>(options: AcitivityOptions): A` function takes a generic parameter `A` that _must_ implement/extend `AcivityInterface`.\r\n\r\nIn order to use our interface we must say say it `extends ActivityInterface`:\r\n\r\n```ts\r\ninterface MyActivities extends ActivityInterface {\r\n  customActivity(): Promise<'cool stuff'>;\r\n}\r\n```\r\n\r\nWhen used with `proxyActivities<A extends ActivityInterface>(options: ActivityOptions): A` `tsc` now allows us to call any method whether it exists or not because of `ActivityInterface`'s string index.\r\n\r\n```ts\r\nconst activities = proxyActivities<MyActivities>({});\r\n\r\n// Runtime error, this isn't actually a function\r\nactivities.whateverTypeScriptDoesntCare().then(/* */);\r\n```\r\n\r\nIf we remove `extends ActivityInterface` then `tsc` only allows calling methods defined in `MyActivities` but doesn't allow it to be used with `proxyActivities<A extends ActivityInterface>(options: ActivityOptions): A`\r\n\r\n#### Our Workaround\r\n\r\n```ts\r\n/**\r\n * A utility type that only presents the methods that conform to `ActivityFunction<any[], any>`\r\n */\r\ntype ActivityInterfaceFor<T> = Pick<T, keyof {[K in keyof T as T[K] extends ActivityFunction<any[], any> ? K : never]: T[K]}>;\r\n\r\nconst ourProxyActivities = proxyActivities as (<A>(options: ActivityOptions) => ActivityInterfaceFor<A>);\r\n\r\nconst {\r\n    customActivity,\r\n    // tsc correctly identifies this a problem because the method doesn't exist.\r\n    nonExistentMethod\r\n} = ourProxyActivities<MyActivities>({});\r\n```\r\n### Minimal Reproduction\r\n\r\n[This playground example is pretty similar to our environment and shows the problem and our workaround][problem-workaround].\r\n\r\n### Environment/Versions\r\n\r\n\r\n-  @temporalio/workflow@0.21.0\r\n- `tsc version 4.6.3`\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n\r\n[problem-workaround]: https://www.typescriptlang.org/play?#code/JYWwDg9gTgLgBAbzgQQMY2AN2DAngSQDsYBTKAMwENUSAaFdLHXAMQFdDGJD60Ns8AeTAZuAZ3pgoEAB64+TDCTFwAvnHLSQcAOQABUuGiUANsAgB6AO7QA1uRMQrOgNwAoD8GJkqNOAFk2VAALAHU7BycVEhlSQgATFQUBAm8KahJENzg4MB9oEHCoWwAKLzA2GAAuOAAjCAgTEkpCAEoagAUtYDESAB4dVAhwJtIdOAAfXStgylJMMh0APjdVDzchwjF4G2LIqzEawJCi+0cDuABeLJycvIoC05qSgH1yytarpbgu4Z6SAB0UGUjQWJUGwzAoxIOlaqw8FgscBgwR6cBAJBREHicDEwQgbBM8UIOngMR6MHotUqDH4zCIpHSflmKkouJgUC8AHM4F54jFkbg8m5EXADGIALQxPLoKVQaRQOAbcTwQjcACiMgpJGI-kx+Jx112ZyiAOCJBMjncIoAVDbsja4KFMtKSOg4NwTLhkeb0frsSpuAEgmEIucVDAIHVMpRMJRgCZKLUmgC4AAhGkonoO3H4i4ouZweJsTKRn2Zbacwg8vkCoMAA2S9LSvhI9bgVkyqBaOcoYlsGmgcBeLVwLz9WJxLRxMDEqB9XlsKhwOlZhDgjcYKXYnFEhD6o4A2gBdeijpb1gEOiwipHiqUyGUwOUK5VbeAIbK3FHKOhfnKUMCtD-nApgmMBtx1JQ8SrFcuTSHITZKGIfTHKGezhksJQIKorTWps2zoiGpz7Co1xSLI8hbjgwDKKhxFhlEWE4Xht4oGqP6KjElAjJkMxkKWqIqBik65gSRJwBxcDktsbH3q6spkAqSogAxGGmualoQCUrEInaOYACpCWJ+a+rUJCzNgQ6dh2LTwJowzInOg6Kj+cDAjAbBQOueB5B65AbhRiHUch9Y5tSOxdi0pJwGwvQbgActwADC3DkAU3IkeG7bmd2cWZDgRYQMoJLwJZMbslWNYJDEOYFvAm50ngDI+Bk7bAgAjmwwDAio6WKvWfTINJsQ6oktKKKkjKtheV5wDaN5uF400ZHASWEKlhD9SAmWMRcn6QXc+RQIUdhlIQFTVHUDRNC07Q-N0vQDEMvFjJM0yzPMiwrGsCJIs6cDdqVsXxfW62bdtu3qQcOVupQ+W8vA8TFWIwMxHEOKNZNLVMm2b6EdQTW0WR8GUUhxN9ODaUZdWWVMdhuH4SqNy3KKRloi8yPKOOSlDrl8PxTZyNo6NCQTSkOOtiBoryY+brPrzUAgVmYgsPGJhiMgYiak+JAweo1yE4oxPWhY+nzXA7PLoGXkdnYgEEgkc2OjmLA9QTsUYGYeCCn59UeoQXrwb+xARr6IkGmHhabNtyJRlj24cFw+5HqeoGELgF7Xh4vmZEhU2tTQLDQH0BnfNcHTAKgtil-QtgkLgEABQgh4ANK8uu9eNwFBmgSoBlt8eI0Y0kIWsEne4HhnJ5nhn3wAPxwO3NSECQCxQMeNQD63x6qEsTPvh6Xm-MFRPKHBQVUWfrIqCUQ1YRAIjmFsNT58Ie5iJ8lzfPnksZMXUB766TNvaC22cCIfhAvcbapwIK3AgJxPUk5YLXAJFAE+V9jZ0SpltGmXI6YHGYozDwQA","closedAt":"2022-07-07T00:57:46Z","comments":[{"id":"IC_kwDOEujx185DXuHj","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Thanks for reporting, we will look into it","createdAt":"2022-05-18T17:29:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/655#issuecomment-1130291683","viewerDidAuthor":false},{"id":"IC_kwDOEujx185DX0Qe","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"There are 2 problems I see here:\r\n1. You must extend `ActivityInterface` in order to use it as a type param in `proxyActivities`\r\n  - This isn't too bad but I'd be happy if it can be avoided (as in your solution)\r\n3. The returned proxy object supports using any key as an `ActivityFunction<any[], any>`\r\n  - You won't get any completions from the TS language server for undeclared properties but compilation still passes so that's not great\r\n\r\nYour workaround could be used as the actual type for proxy activities.\r\nThe only downside I see to that is that if you use a type that doesn't have any methods with a valid activity signature (`ActivityFunction`) you won't get any compiler errors, you simply wouldn't see them on the proxy.\r\n\r\nFTR, I managed to simplify the `ActivityInterfaceFor` type a bit:\r\n```ts\r\ntype ActivityInterfaceFor<T> = {[K in keyof T as T[K] extends ActivityFunction<any[], any> ? K : never]: T[K]};\r\n```\r\n\r\nOverall, I like your suggestion and I think we should change the signature.\r\n","createdAt":"2022-05-18T17:53:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/655#issuecomment-1130316830","viewerDidAuthor":false},{"id":"IC_kwDOEujx185DX3LR","author":{"login":"beaucollins"},"authorAssociation":"NONE","body":"> FTR, I managed to simplify the ActivityInterfaceFor type a bit:\r\n\r\nI originally had that but the downside to your simplified version is `tsc` no longer links the source definition's method to the returned type which has a poorer developer experience.\r\n\r\nFor example, with your simplified version, using the playground link I provided:\r\n\r\n```ts\r\nconst {\r\n    performWork,\r\n} = ourProxyActivities<NonConformingWorkflows>({});\r\n```\r\n\r\nCommand click on `performWork ` and it doesn't know where to take you because the type references are no longer connected.\r\n\r\nIf you leave the `Pick<T, keyof /* ... */>` in, command click the `performWork` and it takes you to the interface that defined it.","createdAt":"2022-05-18T18:01:11Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/655#issuecomment-1130328785","viewerDidAuthor":false},{"id":"IC_kwDOEujx185DYCmz","author":{"login":"beaucollins"},"authorAssociation":"NONE","body":"A better way to communicate what's going on we can split that `ActivityInterfaceFor` into two different utility functions.\r\n\r\n```ts\r\n// union of keys of T that extend V\r\ntype KeysWhere<T, V> = keyof {[K in keyof T as T[K] extends V ? K : never]: T[K]};\r\n\r\n// Only pick the keys that conform\r\ntype ActivityInterfaceFor<T> = Pick<T, KeysWhere<T, ActivityFunction<any[], any>;\r\n```\r\n\r\n> The only downside I see to that is that if you use a type that doesn't have any methods with a valid activity signature, you simply wouldn't see them on the proxy.\r\n\r\nI haven't actually used the API at all so I'm not entirely familiar with the expectations of using temporal here. Would it be expected to use `proxyActivities()` without calling a method on the returned interface? Because you'll get compilation errors on any attempts to use a method that doesn't exist.\r\n\r\n","createdAt":"2022-05-18T18:36:48Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/655#issuecomment-1130375603","viewerDidAuthor":false},{"id":"IC_kwDOEujx185DYwWe","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Not sure I understand the question.\r\n\r\nHere's what I think could be a reasonable interface\r\n\r\n```ts\r\nimport { ActivityInterface, ActivityFunction, ActivityOptions } from '@temporalio/workflow';\r\n\r\nconst NotAnActivityMethod = Symbol.for('__TEMPORAL_NOT_AN_ACTIVITY_METHOD');\r\ntype UntypedActivities = ActivityInterface;\r\ntype ActivityInterfaceFor<T> = {[K in keyof T]: T[K] extends ActivityFunction<any[], any> ? T[K] : typeof NotAnActivityMethod};\r\n// The other option would be to map to `never` but that means that there's no signal to the user if they've misconfigured an activity function.\r\n// Downside of the Symbol approach is that it's misleading, we can't ensure at runtime that you get a Symbol.\r\n\r\nfunction proxyActivities<A = UntypedActivities>(options: ActivityOptions): ActivityInterfaceFor<A> {\r\n    return {} as any\r\n}\r\n\r\ninterface NonConformingWorkflows {\r\n  performWork(input: boolean): Promise<'complete' | 'whatever'>;\r\n  invalidDefinition(input: boolean): string;\r\n}\r\n\r\nconst act = proxyActivities<NonConformingWorkflows>({});\r\n\r\nact.performWork(true);\r\nact.invalidDefinition();\r\n// ^^ TS complains with:\r\n// (property) invalidDefinition: typeof NotAnActivityMethod\r\n// This expression is not callable.\r\n// Type 'Symbol' has no call signatures.(2349)\r\n\r\n// For JS users this still works:\r\nconst act2 = proxyActivities({});\r\nact2.notFound();\r\n```\r\n","createdAt":"2022-05-18T21:19:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/655#issuecomment-1130562974","viewerDidAuthor":false}],"createdAt":"2022-05-18T17:15:47Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":655,"reactionGroups":[],"state":"CLOSED","title":"[Bug] ActivityInterface adds a string index to any interface that implements it","updatedAt":"2022-07-07T00:57:46Z","url":"https://github.com/temporalio/sdk-typescript/issues/655"}
