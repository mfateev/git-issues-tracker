{"assignees":[],"author":{"id":"MDQ6VXNlcjUyMjA1","is_bot":false,"login":"dandavison","name":"Dan Davison"},"body":"With node `v22.7.0` the workflow interaction below crashes the worker with the error below in protobufjs. This appears to be the same problem as discussed in https://github.com/protobufjs/protobuf.js/issues/2025, and is fixed by upgrading node to `v22.8.0`.\r\n\r\n```\r\n  error: RangeError: \"length\" is outside of buffer bounds\r\n      at Buffer.proto.utf8Write (node:internal/buffer:1066:13)\r\n      at Op.writeStringBuffer [as fn] (/Users/dan/src/temporalio/sdk-typescript/node_modules/protobufjs/src/writer_buffer.js:61:13)\r\n      at BufferWriter.finish (/Users/dan/src/temporalio/sdk-typescript/node_modules/protobufjs/src/writer.js:453:14)\r\n      at Worker.handleActivation (/Users/dan/src/temporalio/sdk-typescript/packages/worker/src/worker.ts:1166:30) {\r\n    code: 'ERR_BUFFER_OUT_OF_BOUNDS'\r\n```\r\n\r\n\r\n<details>\r\n<summary>repro</summary>\r\n\r\n```typescript\r\nimport * as wf from '@temporalio/workflow';\r\nimport * as cl from '@temporalio/client';\r\nimport * as wo from '@temporalio/worker';\r\n\r\nconst workflowId = 'wid';\r\nconst taskQueue = 'tq';\r\nexport const fetchAndAdd = wf.defineUpdate<number, [number]>('fetchAndAdd');\r\n\r\nexport async function workflow(): Promise<void> {\r\n  var count = 0;\r\n\r\n  const handler = (arg: number) => {\r\n    const prevCount = count;\r\n    count += arg;\r\n    return prevCount;\r\n  };\r\n\r\n  const validator = (arg: number) => {\r\n    if (arg < 0) {\r\n      throw new Error('Argument must not be negative');\r\n    }\r\n  };\r\n\r\n  wf.setHandler(fetchAndAdd, handler, { validator });\r\n\r\n  await wf.condition(() => count != 0);\r\n}\r\n\r\nasync function starter(client: cl.Client): Promise<void> {\r\n  const wfHandle = await client.workflow.start(workflow, {\r\n    taskQueue,\r\n    workflowId,\r\n    workflowIdReusePolicy: cl.WorkflowIdReusePolicy.WORKFLOW_ID_REUSE_POLICY_TERMINATE_IF_RUNNING,\r\n  });\r\n  await wfHandle.executeUpdate(fetchAndAdd, { args: [-1] });\r\n}\r\n\r\nasync function main(): Promise<void> {\r\n  const worker = await wo.Worker.create({\r\n    workflowsPath: __filename,\r\n    taskQueue,\r\n    bundlerOptions: {\r\n      ignoreModules: ['@temporalio/client', '@temporalio/worker'],\r\n    },\r\n  });\r\n  const connection = await cl.Connection.connect();\r\n  const client = new cl.Client({ connection });\r\n  await worker.runUntil(starter(client));\r\n}\r\n\r\nif (!wf.inWorkflowContext()) {\r\n  wo.Runtime.install({ logger: new wo.DefaultLogger('WARN') });\r\n  main().catch((err) => {\r\n    console.error(err);\r\n    process.exit(1);\r\n  });\r\n}\r\n```\r\n\r\n</details>\r\n\r\n\r\n<details>\r\n<summary>Full worker error log </summary>\r\n\r\n```\r\n2024-09-08T12:55:58.594Z [ERROR] Worker failed {\r\n  sdkComponent: 'worker',\r\n  taskQueue: 'tq',\r\n  error: RangeError: \"length\" is outside of buffer bounds\r\n      at Buffer.proto.utf8Write (node:internal/buffer:1066:13)\r\n      at Op.writeStringBuffer [as fn] (/Users/dan/src/temporalio/sdk-typescript/node_modules/protobufjs/src/writer_buffer.js:61:13)\r\n      at BufferWriter.finish (/Users/dan/src/temporalio/sdk-typescript/node_modules/protobufjs/src/writer.js:453:14)\r\n      at Worker.handleActivation (/Users/dan/src/temporalio/sdk-typescript/packages/worker/src/worker.ts:1166:30) {\r\n    code: 'ERR_BUFFER_OUT_OF_BOUNDS'\r\n  }\r\n}\r\nCombinedWorkerRunError: Worker terminated with fatal error in `runUntil`\r\n    at Worker.runUntil (/Users/dan/src/temporalio/sdk-typescript/packages/worker/src/worker.ts:1608:15)\r\n    at processTicksAndRejections (node:internal/process/task_queues:105:5)\r\n    at async main (/Users/dan/src/temporalio/samples-typescript/scratchpad/scratchpad.ts:48:3) {\r\n  cause: {\r\n    workerError: RangeError: \"length\" is outside of buffer bounds\r\n        at Buffer.proto.utf8Write (node:internal/buffer:1066:13)\r\n        at Op.writeStringBuffer [as fn] (/Users/dan/src/temporalio/sdk-typescript/node_modules/protobufjs/src/writer_buffer.js:61:13)\r\n        at BufferWriter.finish (/Users/dan/src/temporalio/sdk-typescript/node_modules/protobufjs/src/writer.js:453:14)\r\n        at Worker.handleActivation (/Users/dan/src/temporalio/sdk-typescript/packages/worker/src/worker.ts:1166:30) {\r\n      code: 'ERR_BUFFER_OUT_OF_BOUNDS'\r\n    },\r\n    innerError: ServiceError: Workflow Update failed\r\n        at WorkflowClient.rethrowGrpcError (/Users/dan/src/temporalio/sdk-typescript/packages/client/src/workflow-client.ts:754:13)\r\n        at WorkflowClient.rethrowUpdateGrpcError (/Users/dan/src/temporalio/sdk-typescript/packages/client/src/workflow-client.ts:739:10)\r\n        at WorkflowClient._startUpdateHandler (/Users/dan/src/temporalio/sdk-typescript/packages/client/src/workflow-client.ts:841:12)\r\n        at processTicksAndRejections (node:internal/process/task_queues:105:5)\r\n        at async _startUpdate (/Users/dan/src/temporalio/sdk-typescript/packages/client/src/workflow-client.ts:1113:22)\r\n        at async Object.executeUpdate (/Users/dan/src/temporalio/sdk-typescript/packages/client/src/workflow-client.ts:1190:24)\r\n        at async starter (/Users/dan/src/temporalio/samples-typescript/scratchpad/scratchpad.ts:35:3)\r\n        at async /Users/dan/src/temporalio/sdk-typescript/packages/worker/src/worker.ts:1597:16\r\n        at async Promise.allSettled (index 0)\r\n        at async Worker.runUntil (/Users/dan/src/temporalio/sdk-typescript/packages/worker/src/worker.ts:1604:44) {\r\n      cause: [Error]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n</details>","closedAt":"2024-09-09T16:30:20Z","comments":[{"id":"IC_kwDOEujx186LXTDH","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"What are you suggesting? Looks like that's a bug in Node itself, and there's really nothing we can do on our sideâ€¦","createdAt":"2024-09-09T13:32:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1510#issuecomment-2338140359","viewerDidAuthor":false},{"id":"IC_kwDOEujx186LY7AE","author":{"login":"dandavison"},"authorAssociation":"MEMBER","body":"We're keeping this issue in the `sdk-typescript` repo so that anyone who hits the problem while using the Typescript SDK will find it, and learn that it's a node issue that can be resolved by using a different node version (we've already seen reports from users who've hit it and assumed it was a problem with `sdk-typescript`).\r\n\r\nBeyond that, it looks like this affects node v22.7.0 only. I'm not sure what proportion of our users will be likely to attempt to use that node version in the future. If this is going to be a common problem for users, one thing that might be possible is to catch the error and output a helpful error message.","createdAt":"2024-09-09T16:30:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1510#issuecomment-2338566148","viewerDidAuthor":false},{"id":"IC_kwDOEujx186OXQ2O","author":{"login":"hejbiLLLLL"},"authorAssociation":"NONE","body":"Hi! \r\n\r\nI am experiencing this problem whilst using node LTS (v20.17.0) _and/or_ v22.9.0 and temporal v1.1.0 on a Mac (M1). My colleague running the same versions on Linux can't replicate the issue running the exact same code. \r\n\r\nAny advice?  \r\n\r\n\r\n**EDIT:** Solved! We had mismatching versions of the temporal packages:\r\n```\r\n\"@temporalio/activity\": \"^1.11.2\",\r\n\"@temporalio/common\": \"^1.11.2\",\r\n\"@temporalio/worker\": \"^1.11.2\",\r\n\"@temporalio/workflow\": \"^1.11.2\"\r\n```\r\nSome were 1.11.1 while some were 1.11.2, so bumping them all to the same version solved the issue. ","createdAt":"2024-10-02T11:58:20Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1510#issuecomment-2388462990","viewerDidAuthor":false}],"createdAt":"2024-09-08T13:01:59Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1510,"reactionGroups":[],"state":"CLOSED","title":"[Bug] RangeError: \"length\" is outside of buffer bounds","updatedAt":"2024-10-02T12:14:36Z","url":"https://github.com/temporalio/sdk-typescript/issues/1510"}
