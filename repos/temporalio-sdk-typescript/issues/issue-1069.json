{"assignees":[{"id":"MDQ6VXNlcjE1MzE1NDEz","login":"THardy98","name":"Thomas Hardy","databaseId":0}],"author":{"id":"MDQ6VXNlcjIxNTQ4ODY=","is_bot":false,"login":"jdnichollsc","name":"J.D Nicholls"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\nI'm trying to check if a workflow execution exists by using the workflowId.\r\n\r\n### Describe the solution you'd like\r\n\r\nI was checking the types from the TypeScript packages and I was trying to implement the below solution:\r\n```ts\r\nasync checkWorkflowExecutionExists(workflowId: string): Promise<boolean> {\r\n  const request = new temporal.api.workflowservice.v1.DescribeWorkflowExecutionRequest({\r\n    execution: new temporal.api.common.v1.WorkflowExecution({ workflowId }),\r\n    namespace: 'default',\r\n  });\r\n  const { count } = await this.client.workflowService.countWorkflowExecutions(request);\r\n  return count.greaterThan(0);\r\n}\r\n```\r\n\r\n### Additional context\r\n\r\nBut I'm getting this error:\r\n```\r\n│ [Nest] 40  - 03/02/2023, 10:15:15 PM   ERROR [ExceptionsHandler] proto_1.temporal.api.workflowservice.v1.D │\r\n│ TypeError: proto_1.temporal.api.workflowservice.v1.DescribeWorkflowExecutionRequest is not a constructor   │\r\n│     at CheckoutService.checkWorkflowExecutionExists (/baxus-services/dist/apps/api/main.js:2066:25)        │\r\n│     at CheckoutController.checkWorkflowExecutionExists (/baxus-services/dist/apps/api/main.js:1889:37)     │\r\n│     at /baxus-services/node_modules/@nestjs/core/router/router-execution-context.js:38:29                  │\r\n│     at processTicksAndRejections (node:internal/process/task_queues:96:5)                                  │\r\n│     at /baxus-services/node_modules/@nestjs/core/router/router-execution-context.js:46:28                  │\r\n│     at /baxus-services/node_modules/@nestjs/core/router/router-proxy.js:9:17  \r\n```\r\n\r\nI was inspecting the code of the '@temporalio/proto' package but I don't see any reference to that `DescribeWorkflowExecutionRequest` constructor, so why the types are wrong?\r\n\r\nThanks for your support! <3","closedAt":"2024-12-09T22:40:43Z","comments":[{"id":"IC_kwDOEujx185WljTj","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"`countWorkflowExecutions` is an operation against the visiblity API (ie. going to your ElasticSearch server, and it might possibly take to time to reflect a result).\r\n\r\nA better way to test for the existence of a specific workflow would be `client.workflow.getHandle(workflowId).describe()`. This method will throw if there is no such workflow. It will return a `WorkflowExecutionInfo` corresponding to the latest execution of a workflow with that workflowId if such a workflow exists. On this description, you can check the `status` property to know if that workflow execution is still running, has failed, or has completed normally.","createdAt":"2023-03-02T22:59:41Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1069#issuecomment-1452684515","viewerDidAuthor":false},{"id":"IC_kwDOEujx185WlnCX","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Also, we do not yet provide a high level API for the `countWorkflowExecutions` operation, but we do for the `listWorkflowExecutions`:\r\n\r\n```\r\n  for await (const workflowInfo of client.workflow.list({ query: 'WorkflowId=\"MyWorkflowId\"' })) {\r\n    console.log(`${workflowInfo.workflowId} ${workflowInfo.runId}`);\r\n  }\r\n```\r\n\r\nNote that both `listWorkflowExecutions` and `countWorkflowExecutions` are based on search queries. They are generally meant to find a list of workflows, not a single workflow.\r\n\r\nIf you still want to use the `countWorkflowExecutions` operation, you can do so through the raw gRPC API. The syntax for this would be:\r\n\r\n```ts\r\n    const response = await client.workflow.workflowService.countWorkflowExecutions({\r\n      namespace: this.options.namespace,\r\n      query: \"WorkflowId = 'test'\",\r\n    });\r\n    const count = response.count;\r\n```","createdAt":"2023-03-02T23:07:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1069#issuecomment-1452699799","viewerDidAuthor":false},{"id":"IC_kwDOEujx185WloBC","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"We could add an abstraction for this, couldn't hurt.","createdAt":"2023-03-02T23:11:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1069#issuecomment-1452703810","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Wlpa2","author":{"login":"jdnichollsc"},"authorAssociation":"NONE","body":"> client.workflow.\r\n\r\nI was checking the types and I don't see any workflow object from the client:\r\n![workflow client](https://user-images.githubusercontent.com/2154886/222584041-94841bd8-dc82-4814-80d8-baa9a2d5a0ee.png)\r\n\r\nLet me try that gRPC API, is that a good solution or do you recommend any other alternative? <3\r\n\r\nThanks for your amazing support folks!","createdAt":"2023-03-02T23:16:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1069#issuecomment-1452709558","viewerDidAuthor":false},{"id":"IC_kwDOEujx185WlqJX","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"From your screenshot, it looks like you already have a `WorkflowClient`, so that would be:\r\n- `this.client.getHandle(workflowId).describe()`,\r\n- `this.client.workflow.list()`, or\r\n- `this.client.workflowService.countWorkflowExecutions` for the raw gRPC api.","createdAt":"2023-03-02T23:20:01Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1069#issuecomment-1452712535","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Wlq4F","author":{"login":"jdnichollsc"},"authorAssociation":"NONE","body":"> Also, we do not yet provide a high level API for the `countWorkflowExecutions` operation, but we do for the `listWorkflowExecutions`:\r\n> \r\n> ```\r\n>   for await (const workflowInfo of client.workflow.list({ query: 'WorkflowId=\"MyWorkflowId\"' })) {\r\n>     console.log(`${workflowInfo.workflowId} ${workflowInfo.runId}`);\r\n>   }\r\n> ```\r\n> \r\n> Note that both `listWorkflowExecutions` and `countWorkflowExecutions` are based on search queries. They are generally meant to find a list of workflows, not a single workflow.\r\n> \r\n> If you still want to use the `countWorkflowExecutions` operation, you can do so through the raw gRPC API. The syntax for this would be:\r\n> \r\n> ```ts\r\n>     const response = await client.workflow.workflowService.countWorkflowExecutions({\r\n>       namespace: this.options.namespace,\r\n>       query: \"WorkflowId = 'test'\",\r\n>     });\r\n>     const count = response.count;\r\n> ```\r\n\r\nOh I'm getting this other error:\r\n```sh\r\n> │ [Nest] 60  - 03/02/2023, 11:19:44 PM   ERROR [ExceptionsHandler] 3 INVALID_ARGUMENT: Operation not support │\r\n│ Error: 3 INVALID_ARGUMENT: Operation not supported. Please use on Elasticsearch                            │\r\n│     at Object.callErrorFromStatus (/baxus-services/node_modules/@grpc/grpc-js/src/call.ts:81:17)           │\r\n│     at Object.onReceiveStatus (/baxus-services/node_modules/@grpc/grpc-js/src/client.ts:358:36)            │\r\n│     at /baxus-services/node_modules/@grpc/grpc-js/src/call-stream.ts:210:27                                │\r\n│     at onReceiveStatus (/baxus-services/node_modules/@temporalio/client/src/grpc-retry.ts:176:17)          │\r\n│     at Object.onReceiveStatus (/baxus-services/node_modules/@temporalio/client/src/grpc-retry.ts:180:13)   │\r\n│     at InterceptingListenerImpl.onReceiveStatus (/baxus-services/node_modules/@grpc/grpc-js/src/call-strea │\r\n│     at Object.onReceiveStatus (/baxus-services/node_modules/@grpc/grpc-js/src/client-interceptors.ts:462:3 │\r\n│     at Object.onReceiveStatus (/baxus-services/node_modules/@grpc/grpc-js/src/client-interceptors.ts:424:4 │\r\n│     at /baxus-services/node_modules/@grpc/grpc-js/src/call-stream.ts:334:24                                │\r\n│     at processTicksAndRejections (node:internal/process/task_queues:78:11)                                 │\r\n│ for call at                                                                                                │\r\n│     at ServiceClientImpl.makeUnaryRequest (/baxus-services/node_modules/@grpc/grpc-js/src/client.ts:328:30 │\r\n│     at Service.rpcImpl (/baxus-services/node_modules/@temporalio/client/src/connection.ts:340:21)          │\r\n│     at Service.rpcCall (/baxus-services/node_modules/protobufjs/src/rpc/service.js:94:21)                  │\r\n│     at executor (/baxus-services/node_modules/@protobufjs/aspromise/index.js:44:16)                        │\r\n│     at new Promise (<anonymous>)                                                                           │\r\n│     at Object.asPromise (/baxus-services/node_modules/@protobufjs/aspromise/index.js:28:12)                │\r\n│     at Service.rpcCall (/baxus-services/node_modules/protobufjs/src/rpc/service.js:86:21)                  │\r\n│     at Service.countWorkflowExecutions (eval at Codegen (/baxus-services/node_modules/@protobufjs/codegen/ │\r\n│     at CheckoutService.checkWorkflowExecutionExists (/baxus-services/dist/apps/api/main.js:2065:61)        │\r\n│     at CheckoutController.checkWorkflowExecutionExists (/baxus-services/dist/apps/api/main.js:1889:37)  \r\n```\r\n\r\nLet me try the other alternatives!","createdAt":"2023-03-02T23:23:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1069#issuecomment-1452715525","viewerDidAuthor":false},{"id":"IC_kwDOEujx185WlzD6","author":{"login":"jdnichollsc"},"authorAssociation":"NONE","body":"> * this.client.getHandle(workflowId).describe()\r\n\r\nThis is working great, thanks for your help! :tada: \r\n\r\nAbout the implementation to validate if a workflow is running with this SDK, is this Ok?\r\n\r\n```ts\r\nasync checkIfWorkflowExecutionIsRunning(workflowId: string): Promise<boolean> {\r\n  try {\r\n    const { status } = await this.client.getHandle(workflowId).describe();\r\n    return (\r\n      status.code === temporal.api.enums.v1.WorkflowExecutionStatus.WORKFLOW_EXECUTION_STATUS_RUNNING ||\r\n      status.code === temporal.api.enums.v1.WorkflowExecutionStatus.WORKFLOW_EXECUTION_STATUS_CONTINUED_AS_NEW\r\n    );\r\n  } catch (error) {\r\n    this.logger.error(`checkIfWorkflowExecutionIsRunning(${workflowId})`, error);\r\n    if (error instanceof WorkflowNotFoundError) {\r\n      return false;\r\n    }\r\n    throw error;\r\n  }\r\n}\r\n\r\n```\r\n\r\nThanks folks!","createdAt":"2023-03-03T00:04:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1069#issuecomment-1452749050","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Wlz32","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Checking for status code `WORKFLOW_EXECUTION_STATUS_RUNNING` should be enough.\r\n\r\nIf the workflow continued as new, then `getHandle(workflowId)` (without a `runId`) should have returned the continuation workflow, which will be \"running\", rather than the original workflow, which will have status \"continued as new\".","createdAt":"2023-03-03T00:08:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1069#issuecomment-1452752374","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Wl2MJ","author":{"login":"jdnichollsc"},"authorAssociation":"NONE","body":"@mjameswh Beautiful, thanks James for your amazing feedback! <3\r\n\r\nYou save my day, have a great day folks :+1: ","createdAt":"2023-03-03T00:23:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1069#issuecomment-1452761865","viewerDidAuthor":false},{"id":"IC_kwDOEujx186OPKqL","author":{"login":"nikhilbhatia08"},"authorAssociation":"CONTRIBUTOR","body":"I would like to give this issue a try.","createdAt":"2024-10-01T15:32:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1069#issuecomment-2386340491","viewerDidAuthor":false}],"createdAt":"2023-03-02T22:47:29Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"},{"id":"MDU6TGFiZWwyNTQ1Mzg0MDE2","name":"good first issue","description":"Good for newcomers","color":"7057ff"}],"milestone":null,"number":1069,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"[Feature Request] Support countWorkflowExecutions","updatedAt":"2024-12-09T22:40:43Z","url":"https://github.com/temporalio/sdk-typescript/issues/1069"}
