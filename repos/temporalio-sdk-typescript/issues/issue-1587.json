{"assignees":[],"author":{"id":"MDQ6VXNlcjEzMTAwNjUz","is_bot":false,"login":"c0sx","name":"Koshkin Nikolai"},"body":"### What are you really trying to do?\r\n\r\nHi, I have a workflow like dsl-interpreter from [sample](https://github.com/temporalio/samples-typescript/tree/main/dsl-interpreter) and I found that my workflow is slow.\r\n\r\n### Describe the bug\r\n\r\nFor some reason using async functions in workflows is drastically slower than sync functions. Could you help me? \r\n\r\nI have 2 identical workflows (synthetic examples), the difference only in using async in functions:\r\n\r\n```js\r\n// sync workflow\r\nasync function run() {\r\n  const iters = () => 0;\r\n  const condition = (iters) => iters < 10_000;\r\n  const incr = (iters) => iters + 1;\r\n  const out = (iters) => iters;\r\n\r\n  let i = iters();\r\n\r\n  while (condition(i)) {\r\n    i = incr(i);\r\n  }\r\n\r\n  return out(i);\r\n}\r\n\r\n// async workflow\r\nasync function run() {\r\n  const iters = async () => 0;\r\n  const condition = (iters) => iters < 10_000;\r\n  const incr = async (iters) => iters + 1;\r\n  const out = async (iters) => iters;\r\n\r\n  let i = await iters();\r\n\r\n  while (condition(i)) {\r\n    i = await incr(i);\r\n  }\r\n\r\n  return await out(i);\r\n}\r\n```\r\n\r\nMy worker and client\r\n```js\r\n// worker.js\r\nconst path = require('path');\r\n\r\nconst { Worker } = require('@temporalio/worker');\r\n\r\nasync function main() {\r\n  const worker = await Worker.create({\r\n    workflowsPath: path.join(__dirname, './workflows.js'),\r\n    taskQueue: 'hello-javascript',\r\n  });\r\n\r\n  await worker.run();\r\n}\r\n\r\nmain().catch((err) => {\r\n  console.error(err);\r\n  process.exit(1);\r\n});\r\n\r\n// client.js\r\nconst { Client, Connection } = require('@temporalio/client');\r\n\r\nconst { run } = require('./workflows');\r\n\r\nasync function main() {\r\n  const connection = await Connection.connect({});\r\n\r\n  const client = new Client({\r\n    connection,\r\n  });\r\n\r\n  console.time('client'); // start timer\r\n\r\n  const result = await client.workflow.execute(run, {\r\n    taskQueue: 'hello-javascript',\r\n    workflowId: 'my-business-id',\r\n    args: ['Temporal'],\r\n  });\r\n\r\n  console.timeEnd('client'); // end timer\r\n  console.log(result);\r\n}\r\n\r\nmain().catch((err) => {\r\n  console.error(err);\r\n  process.exit(1);\r\n});\r\n```\r\n\r\nAnd I have this results\r\n\r\n| Sync workflow | Async workflow | \r\n| --- | --- |\r\n| 25-30ms | 350-400ms |\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: M3 Mac\r\n- Temporal Version: \r\n\r\n```bash\r\ntemporal -v\r\ntemporal version 1.0.0 (Server 1.24.2, UI 2.28.0)\r\n```\r\n- SDK: typescript-sdk:  1.10.3\r\n\r\n- Are you using Docker or Kubernetes or building Temporal from source? \r\nI installed temporal from brew\r\n","closedAt":null,"comments":[{"id":"IC_kwDOEujx186Xr9Wv","author":{"login":"c0sx"},"authorAssociation":"NONE","body":"I found that this problem related with `promiseHooks` in `vm-shared` worker [here](https://github.com/temporalio/sdk-typescript/blob/main/packages/worker/src/workflow/vm-shared.ts#L205).\r\n\r\nIs it really important to handle any promise?","createdAt":"2024-12-16T08:16:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1587#issuecomment-2544883119","viewerDidAuthor":false},{"id":"IC_kwDOEujx186Xv8RN","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":">I found that this problem related with promiseHooks in vm-shared worker [here](https://github.com/temporalio/sdk-typescript/blob/main/packages/worker/src/workflow/vm-shared.ts#L205).\r\n\r\nYeah, I had the intuition the issue you described would be related to this `promiseHook`.\r\n\r\nIf you want to dig a bit more, I would expect that the largest part of that extra time comes from [these lines](https://github.com/temporalio/sdk-typescript/blob/53233c9091d2eb8d855839f0e8d4bab324913581/packages/worker/src/workflow/vm-shared.ts#L165-L167), which gets called [from the promise hook](https://github.com/temporalio/sdk-typescript/blob/53233c9091d2eb8d855839f0e8d4bab324913581/packages/worker/src/workflow/vm-shared.ts#L221C13-L224) (see the `.stack`, which internally calls the `prepareStackTrace` function).\r\n\r\n> Is it really important to handle any promise?\r\n\r\nThe goal of that hook is to capture the data we need for the `__stack_trace` and `__enhanced_stack_trace` Workflow queries, which are called from the Temporal UI to help diagnose Workflow issues. That's a nice to have feature, but definitely not required. In fact, `promiseHooks` is not supported on Node <16.14, in which case [that hook simply doesn't get registered](https://github.com/temporalio/sdk-typescript/blob/53233c9091d2eb8d855839f0e8d4bab324913581/packages/worker/src/workflow/vm-shared.ts#L203).\r\n\r\nAdding a worker config option to turn off this feature would be a possibility.\r\n\r\nI would however like to investigate first what can be done to reduce the runtime overhead of capturing stack traces on async contexts. I have a few ideas in mind that, I believe, could reduce the cost to nearly zero, without compromising on availability of this feature.","createdAt":"2024-12-16T15:26:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1587#issuecomment-2545927245","viewerDidAuthor":false},{"id":"IC_kwDOEujx186Yonor","author":{"login":"c0sx"},"authorAssociation":"NONE","body":"@mjameswh Hi, do you have any news?","createdAt":"2024-12-24T07:42:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1587#issuecomment-2560784939","viewerDidAuthor":false},{"id":"IC_kwDOEujx186Y0p0o","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"No, not at this time.","createdAt":"2024-12-27T18:33:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1587#issuecomment-2563939624","viewerDidAuthor":false},{"id":"IC_kwDOEujx186u3cR_","author":{"login":"c0sx"},"authorAssociation":"NONE","body":"@mjameswh Hi, do you have any updates that you could share?","createdAt":"2025-06-03T06:53:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1587#issuecomment-2933769343","viewerDidAuthor":false},{"id":"IC_kwDOEujx186u3dsF","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Still not. Sorry.","createdAt":"2025-06-03T06:55:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"CONFUSED","users":{"totalCount":1}},{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1587#issuecomment-2933775109","viewerDidAuthor":false}],"createdAt":"2024-12-13T17:00:39Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1587,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}},{"content":"EYES","users":{"totalCount":3}}],"state":"OPEN","title":"[Bug] Using async functions degrades performance","updatedAt":"2025-06-03T06:55:41Z","url":"https://github.com/temporalio/sdk-typescript/issues/1587"}
