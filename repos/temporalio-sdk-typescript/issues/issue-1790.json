{"assignees":[],"author":{"id":"MDQ6VXNlcjI1OTgzNzgw","is_bot":false,"login":"mishabruml","name":"Misha Bruml"},"body":"Related: #1582 \n\n### What are you really trying to do?\n\nI am trying to write a \"workflow history compatibiltiy test\" using `Worker.runReplayHistory`, so it can be run in CI to protect our team against accidentally introducing non-deterministic changes into our workflows.\n\n### Describe the bug\n\nI am grabbing workflow history from a recent successful workflow run, pasting it as a JSON blob, and running a test like this: \n\n```typescript\nimport { Worker } from '@temporalio/worker';\nimport workflowHistory from './workflow-history.json';\n\ndescribe('Workflow history compatibility', () => {\n  test('Workflow history is compatible', async () => {\n    await Worker.runReplayHistory(\n      {\n        workflowsPath: require.resolve('../workflow.ts'),\n      },\n      workflowHistory\n    );\n  });\n});\n```\n\nThe workflow contains several child workflows, for example:\n\n```typescript\n  const child = executeChild(ChildWorkflow, {\n    args: [childBody],\n    taskQueue: QueueConfig.ChildWorkflow,\n  });\n```\n\nWhen I run the test (locally), I get the following error:\n\n```\nDeterminismViolationError: Replay failed with a nondeterminism error. This means that the workflow code as written is not compatible with the history that was fed in. Details: Workflow activation completion failed: Failure { failure: Some(Failure { message: \"[TMPRL1100] Nondeterminism error: Child workflow id of scheduled event '83ade076-5748-4685-b311-39985365e54c' does not match child workflow id of command '01324793-0653-4b87-ba22-639e2eaffe97'\", source: \"\", stack_trace: \"\", encoded_attributes: None, cause: None, failure_info: Some(ApplicationFailureInfo(ApplicationFailureInfo { r#type: \"\", non_retryable: false, details: None, next_retry_delay: None, category: Unspecified })) }), force_cause: NonDeterministicError }\n```\n\nI have also tried modifying the workflow so that the child workflow executions start like this: \n\n```typescript\n  import { uuid4 } from '@temporalio/workflow';\n\n  const child = executeChild(ChildWorkflow, {\n    args: [childBody],\n    taskQueue: QueueConfig.ChildWorkflow,\n    workflowId: uuid4(),\n  });\n```\n\nAnd ran the workflow succesfully, grabbed the history from this run, and dropped that into my test- same outcome.\n\nThis seems like a bug, the child workflowId should not affect the determinism of the workflow run.\n\n### Environment/Versions\n\n<!-- Please complete the following information where relevant. -->\n\n- OS and processor: [e.g. Apple M2 Pro, Sequoia 5.6.1 (24G90)]\n- Temporal Version: \n```json\n    \"@temporalio/activity\": \"^1.11.1\",\n    \"@temporalio/client\": \"^1.11.3\",\n    \"@temporalio/common\": \"^1.11.2\",\n    \"@temporalio/interceptors-opentelemetry\": \"^1.11.7\",\n    \"@temporalio/nyc-test-coverage\": \"^1.11.2\",\n    \"@temporalio/worker\": \"^1.11.1\",\n    \"@temporalio/workflow\": \"^1.11.1\",\n```\n \n- Are you using Docker or Kubernetes or building Temporal from source? Docker\n","closedAt":null,"comments":[{"id":"IC_kwDOEujx187JB8JE","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"> ```\n>     \"@temporalio/activity\": \"^1.11.1\",\n>     \"@temporalio/client\": \"^1.11.3\",\n>     \"@temporalio/common\": \"^1.11.2\",\n>     \"@temporalio/interceptors-opentelemetry\": \"^1.11.7\",\n>     \"@temporalio/nyc-test-coverage\": \"^1.11.2\",\n>     \"@temporalio/worker\": \"^1.11.1\",\n>     \"@temporalio/workflow\": \"^1.11.1\",\n> ```\n\nThose would be version numbers as they are declared in your package.json, but not necessarily what's actually installed. Can you print the _installed_ version numbers of those dependencies? You should be able to get them using `npm ls`.\n\nMixing packages of different versions of `@temporalio/*` packages is not supported, not even at the patch level. Our packages have exact dependencies to other packages to avoid such incoherencies. So in practice, I expect that all of these packages will have actually been installed at 1.11.7 (or 1.11.3 if using an older version of NPM that didn't support peer dependencies).","createdAt":"2025-10-06T16:37:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1790#issuecomment-3372728900","viewerDidAuthor":false},{"id":"IC_kwDOEujx187JOBKp","author":{"login":"mishabruml"},"authorAssociation":"NONE","body":"thanks, it appears to be 1.13.0\n\nwe're on yarn 4.9.2, node 22.18.0 (npm 10.9.3)\n```\n‚îÇ ‚îú‚îÄ‚îÄ @temporalio/activity@1.13.0\n‚îÇ ‚îú‚îÄ‚îÄ @temporalio/client@1.13.0\n‚îÇ ‚îú‚îÄ‚îÄ @temporalio/common@1.13.0\n‚îÇ ‚îú‚îÄ‚îÄ @temporalio/interceptors-opentelemetry@1.13.0\n‚îÇ ‚îú‚îÄ‚îÄ @temporalio/nyc-test-coverage@1.13.0\n‚îÇ ‚îú‚îÄ‚îÄ @temporalio/testing@1.13.0\n‚îÇ ‚îú‚îÄ‚îÄ @temporalio/worker@1.13.0\n‚îÇ ‚îú‚îÄ‚îÄ @temporalio/workflow@1.13.0\n```","createdAt":"2025-10-07T09:04:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1790#issuecomment-3375895209","viewerDidAuthor":false},{"id":"IC_kwDOEujx187M2EF5","author":{"login":"mishabruml"},"authorAssociation":"NONE","body":"hi sorry @mjameswh any update on this? üôè ","createdAt":"2025-10-23T12:42:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1790#issuecomment-3436724601","viewerDidAuthor":false},{"id":"IC_kwDOEujx187M5MUP","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Given that you are using the OpenTelemetry Interceptors, I suppose you are hitting the issue described in #1677. We are working on a fix for that bug.\n\nTo confirm, how is your workflow getting started? e.g. are you using signal-with-start or update-with-start? And from where are you starting child workflows? e.g. directly from your workflow function, from signal/update handler, or both?","createdAt":"2025-10-23T15:10:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1790#issuecomment-3437544719","viewerDidAuthor":false},{"id":"IC_kwDOEujx187M6KYs","author":{"login":"mishabruml"},"authorAssociation":"NONE","body":"We're starting workflows with `client.workflow.start()` and we're starting child workflows directly from the workflow function using `startChild`/`executeChild`\n\nThanks for the hint, I'll look into #1677 üëÄ ","createdAt":"2025-10-23T15:56:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1790#issuecomment-3437798956","viewerDidAuthor":false},{"id":"IC_kwDOEujx187VxRcq","author":{"login":"jamipouchi"},"authorAssociation":"NONE","body":"Same thing is happening to us. We have 2 workflows that failed \n[TMPRL1100] Nondeterminism error: Child workflow id of scheduled event 'f378473c-2231-4ed6-ae2f-9d7effa1ab67' does not match child workflow id of command '2a14255c-0888-4964-adc8-b39ef7edf225'\n\nWe are also starting workflows with `client.workflow.start()`, and also starting child workflows directly using `executeChild`.\nHave created a ticket: https://support.temporal.io/?tab=issues&durationMs=31536000000&conversationID=ea0ee5ee-aa1f-4914-a122-929ba0be5a56\n\n\n","createdAt":"2025-11-27T15:31:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1790#issuecomment-3586463530","viewerDidAuthor":false},{"id":"IC_kwDOEujx187Wb6-v","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Which version of the Temporal SDK are you using?\n\nIf not already, can you give a try usig v1.13.2? It's fixing issue #1677, which is a very likely explanation for this bug.","createdAt":"2025-12-01T16:45:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1790#issuecomment-3597643695","viewerDidAuthor":false},{"id":"IC_kwDOEujx187WcYWX","author":{"login":"jamipouchi"},"authorAssociation":"NONE","body":"Using `v1.13.2` already.","createdAt":"2025-12-01T17:02:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1790#issuecomment-3597763991","viewerDidAuthor":false},{"id":"IC_kwDOEujx187YRMCK","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"@jamipouchi Given new information I just received privately, I'm pretty sure you're hitting this issue: #1744. There's work in progress on resolving that bug.","createdAt":"2025-12-08T18:13:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1790#issuecomment-3628384394","viewerDidAuthor":false}],"createdAt":"2025-09-26T13:36:06Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1790,"reactionGroups":[],"state":"OPEN","title":"[Bug] Replay workflow history fails with nondeterminism error, child workflow ids do not match","updatedAt":"2025-12-08T18:13:12Z","url":"https://github.com/temporalio/sdk-typescript/issues/1790"}
