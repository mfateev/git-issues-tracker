{"assignees":[{"id":"MDQ6VXNlcjUxNzY4Mw==","login":"Sushisource","name":"Spencer Judge","databaseId":0}],"author":{"id":"MDQ6VXNlcjYyODQzMQ==","is_bot":false,"login":"davidtheclark","name":"David Clark"},"body":"To use a client, we create a `Connection`, pass that into the `WorkflowClient` constructor to create a client instance, then use the client instance's methods to make requests.\r\n\r\nIn a situation where the server app may be redeployed at any moment — so clients will have outstanding connections dropped and they'll need to establish new connections — should we only need to create one `Connection` and `WorkflowClient` for the life of the client application? And we can trust that it will re-connect to the server whenever its TCP connection is dropped? Or should we instead create a new `Connection` and `WorkflowClient` for every request, so we don't have to worry about long-lasting connections getting dropped between requests?\r\n\r\nWe have been receiving some \"connection dropped\" errors, so before we proceed too far with debugging we wanted to make sure we're using the Temporal client as recommended. Thanks!\r\n\r\ncc @mengyazhu96","closedAt":"2021-11-03T15:01:32Z","comments":[{"id":"IC_kwDOEujx1844t7EZ","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"The client connection supports retries via gRPC interceptors.\r\nAFAIR we did not implement retries in case of connection lost.\r\n@Sushisource can you confirm?","createdAt":"2021-10-26T05:02:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/325#issuecomment-951562521","viewerDidAuthor":false},{"id":"IC_kwDOEujx18447idS","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"Will look into this first thing next week","createdAt":"2021-10-30T02:34:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/325#issuecomment-955131730","viewerDidAuthor":false},{"id":"IC_kwDOEujx1845HbzU","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"@davidtheclark Can you post the exact errors you're getting here? There's multiple ways a lost connection can surface.\r\n\r\nFor example:\r\n```\r\nError {\r\n    code: 14,\r\n    details: 'No connection established',\r\n    metadata: Metadata {\r\n      internalRepr: Map {},\r\n      options: {},\r\n    },\r\n    message: '14 UNAVAILABLE: No connection established',\r\n  }\r\n```\r\n\r\nIt'd be useful to know if you see that or something different. \r\n\r\nI was able to confirm that if the connection is lost, an individual call might fail after it hits the retry limit, but the connection itself still will work fine if you try to use the client again. So, yes, you can trust the `Connection` and `WorkflowClient` instance may be re-used (though, depending on your retry policy, in-progress calls may eventually fail if the connection is lost for long enough)\r\n\r\nAlso note https://github.com/temporalio/sdk-core/pull/213 which fixes an issue with workers possibly giving up if the server is down for a while","createdAt":"2021-11-02T22:11:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/325#issuecomment-958250196","viewerDidAuthor":false},{"id":"IC_kwDOEujx1845Lpo_","author":{"login":"davidtheclark"},"authorAssociation":"NONE","body":"> It'd be useful to know if you see that or something different.\r\n\r\nYes, I was seeing errors with code 14, and the same message, `14 UNAVAILABLE: No connection established`.\r\n\r\nThanks for confirming that we should be able to re-use the client indefinitely, even as server instances are swapped. There shouldn't be a long period during which no server is ready to receive connections: the new server should be live before the old server starts shutting down, so one retry should be enough.\r\n\r\nThanks for that fix. We'll open a new issue if we have more problems with connection failures after upgrading.\r\n","createdAt":"2021-11-03T15:01:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/325#issuecomment-959355455","viewerDidAuthor":false}],"createdAt":"2021-10-21T22:09:47Z","labels":[],"milestone":{"number":2,"title":"beta","description":"","dueOn":null},"number":325,"reactionGroups":[],"state":"CLOSED","title":"Guidance on connection and client instantiation pattern when long-lived connections will frequently drop","updatedAt":"2021-11-03T15:01:32Z","url":"https://github.com/temporalio/sdk-typescript/issues/325"}
