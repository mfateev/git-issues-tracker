{"assignees":[],"author":{"id":"MDQ6VXNlcjM5Nzc3ODE=","is_bot":false,"login":"mikeroelens","name":"Mike Roelens"},"body":"### Is your feature request related to a problem? Please describe.\r\nRight now in CI we're randomly getting `Failed to start ephemeral server: Failed connecting to test server after 5 seconds` errors when calling `TestWorkflowEnvironment.createLocal`.  But there's no indication as to why the test server couldn't be started.\r\n\r\nThe relevant code in sdk-core is [here](https://github.com/temporalio/sdk-core/blob/409e74ec8e80ae4c1f9043e8b413b1371b65f946/core/src/ephemeral_server/mod.rs#L314). Looks like an attempt is made to start the ephemeral test server, then connect attempts every 100ms for 5s, if not connected at that point throw an error. \r\n\r\n**Key Problem:** No idea why the test server didn't start\r\n\r\n<!-- A clear and concise description of what the problem is. Ex. I'm always frustrated when [...] -->\r\n\r\n### Describe the solution you'd like\r\n\r\nA clear error reason logged as to why the test server didn't start. Right now it's also impossible to tell if there was an error or if the server was just slow to startup (e.g. maybe it would've started fine after 6s). \r\n\r\n### Additional context\r\n\r\n<!-- Add any other context or screenshots about the feature request here. -->\r\n","closedAt":"2024-04-24T21:04:53Z","comments":[{"id":"IC_kwDOEujx1857RBMY","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> But there's no indication as to why the test server couldn't be started.\r\n\r\nUsually there is stdout/stderr from the subprocess if there's an issue, so I think we need to debug your problem specifically and see what it is and if we can improve logs/output on this specific situation.\r\n\r\n> when calling `TestWorkflowEnvironment.createLocal`\r\n\r\nI assume you're using TypeScript? Can you try setting the `server` option for that call with a `log` with a `level` of `info` or `debug`? But that may not show anything either. This should just download latest non-RC of https://github.com/temporalio/cli and execute `temporal server start-dev`.","createdAt":"2024-04-19T15:06:06Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1396#issuecomment-2068058904","viewerDidAuthor":false},{"id":"IC_kwDOEujx1857RBMZ","author":{"login":"mikeroelens"},"authorAssociation":"NONE","body":"Thank you for the fast reply! Great call, let me see what I can do to improve logging. Yes we're using TypeScript. Looks like we were actually only setting `level: 'warn'`, we'll see if `'debug'` sheds some light ðŸ¤ž ","createdAt":"2024-04-19T15:49:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1396#issuecomment-2068058905","viewerDidAuthor":false},{"id":"IC_kwDOEujx1857RBMa","author":{"login":"mikeroelens"},"authorAssociation":"NONE","body":"Hi @cretz I've had no luck trying a bunch of different things. I've created a barebones reproducible example to show what I'm experiencing. If you can check it out that would be much appreciated ðŸ™ \r\n\r\nhttps://github.com/mikeroelens/temporal-test-server-error-debugging","createdAt":"2024-04-19T19:03:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1396#issuecomment-2068058906","viewerDidAuthor":false},{"id":"IC_kwDOEujx1857RBMc","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Transferring to `sdk-typescript` repo for help here (if it is indeed something we should fix in Core we can transfer back)","createdAt":"2024-04-21T14:11:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1396#issuecomment-2068058908","viewerDidAuthor":false},{"id":"IC_kwDOEujx1857uuGp","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"@mikeroelens Thanks for reporting. This has just been fixed.\r\n\r\n> On posix platforms, stdout and stderr were not properly inherited by ephemeral servers, which meant that users would get no detail of why the server failed to start.\r\n>\r\n> For details: NodeJS is setting FD_CLOEXEC on all of its standard file descriptors (stdin, stdout, stderr), which means that these file descriptors are not inherited by child processesâ€¦ Now, the child_process module emulates the inheritance behavior by explicitly passing the file descriptor to new processes by default, so thatâ€™s not a problem when spawn is called from JS code. But it will bite you when you spawn from native code, for example when starting an ephemeral server through Core SDKâ€¦","createdAt":"2024-04-24T21:07:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1396#issuecomment-2075845033","viewerDidAuthor":false}],"createdAt":"2024-04-19T15:00:21Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1396,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"[Feature Request] Better error details on why ephemeral test server didn't start","updatedAt":"2024-04-24T21:07:36Z","url":"https://github.com/temporalio/sdk-typescript/issues/1396"}
