{"assignees":[],"author":{"id":"MDQ6VXNlcjEzMTkwNDk=","is_bot":false,"login":"ccravens","name":"Chad Cravens"},"body":"### What are you really trying to do?\r\nI'm trying to be able to use my module-alias imports with worker interceptors.\r\n\r\n### Describe the bug\r\n\r\nI use `\"module-alias\": \"2.2.2\"` in my project to create a root path for all of my imports. So instead of doing:\r\n\r\n```typescript\r\nimport { X } from '../../../../../very/long/path';\r\n```\r\n\r\nI can just do:\r\n\r\n```typescript\r\nimport { X } from '~/very/long/path';\r\n```\r\n\r\nHowever when creating a worker with interceptors:\r\n\r\n```typescript\r\nconst worker = await Worker.create({\r\n      connection: await NativeConnection.connect({\r\n        address: `${process.env.TEMPORAL_HOST}:${process.env.TEMPORAL_PORT}`,\r\n      }),\r\n      namespace: 'ns',\r\n      taskQueue: 'queue',\r\n      identity: `worker-${Utils.node._id}`,\r\n      ...(Utils.production && {\r\n        workflowBundle: {\r\n          codePath: require.resolve('../temporal/workflow-bundle.js'),\r\n        },\r\n      }),\r\n      ...(!Utils.production && { workflowsPath: require.resolve('../temporal/workflows') }),\r\n      activities,\r\n      interceptors: {\r\n        workflowModules: [require.resolve('../temporal/interceptors/temporal.interceptor')], // <<< Import Interceptor here <<<\r\n      },\r\n    });\r\n```\r\n\r\nand my Interceptor:\r\n```typescript\r\nimport { TemporalWorkflowsService } from '~/services/models/temporal-workflows.service'; // <<< THIS BREAKS\r\n\r\nclass InboundInterceptor implements WorkflowInboundCallsInterceptor {\r\n  constructor(\r\n    public readonly workflowId: string,\r\n    public readonly workflowType: string,\r\n    temporalWorkflowsService: TemporalWorkflowsService\r\n  ) {}\r\n\r\n  async execute(\r\n    input: WorkflowExecuteInput,\r\n    next: Next<WorkflowInboundCallsInterceptor, 'execute'>\r\n  ): Promise<unknown> {\r\n    console.log(`>>> INBOUND: execute(): ${this.workflowType}[${this.workflowId}]`);\r\n    try {\r\n      return await next(input);\r\n    } finally {\r\n      console.log(`>>> INBOUND: Finished execute(): ${this.workflowType}[${this.workflowId}]`);\r\n    }\r\n  }\r\n  ...\r\n  }\r\n```\r\nIt does not seem to recognize the module alias.\r\n\r\nWhat's worse is not only do I now have to convert my imports from `~` to `../../../..` for the import in the interceptor but also recursively ALL other dependencies. Is there a better way to address this?\r\n\r\n### Environment/Versions\r\nApple M2 Max Sonoma 14.5\r\n```\r\n    \"@temporalio/activity\": \"1.10.1\",\r\n    \"@temporalio/client\": \"1.10.1\",\r\n    \"@temporalio/worker\": \"1.10.1\",\r\n    \"@temporalio/workflow\": \"1.10.1\",\r\n    ```\r\nUsing the docker-compose on my local dev machine\r\n\r\n","closedAt":"2024-07-25T19:16:08Z","comments":[{"id":"IC_kwDOEujx186GLh6h","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"> It does not seem to recognize the module alias.\r\n\r\nWhat's the symptom. Do you get an error message, or is this silently failing?","createdAt":"2024-07-25T18:39:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1468#issuecomment-2251169441","viewerDidAuthor":false},{"id":"IC_kwDOEujx186GLqZm","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Two things:\r\n\r\n1. Your worker uses prebundled Workflows in production environment. Workflow Interceptors passed directly through `WorkerOptions` will be silently ignored in that case. You need to pass the list of Workflow Interceptors, together with your Workflow Code, to the `bundleWorkflowCode()` function. See [`BundleOptions.workflowInterceptorModules`](https://typescript.temporal.io/api/interfaces/worker.BundleOptions#workflowinterceptormodules).\r\n\r\n2. `module-alias`'s magic doesn't automatically extend to bundlers. You will therefore need to provide specific configuration to the Workflow Bundler to apply your aliases. Based on [module-alias example for Webpack](https://github.com/ilearnio/module-alias?tab=readme-ov-file#usage-with-webpack), that should look something like:\r\n\r\n```\r\nconst npm_package = require('./package.json');\r\nconst myAliases = npm_package._moduleAliases;\r\n\r\nwebpackConfigHook: (config) => {\r\n  if (config.resolve) {\r\n    config.resolve.alias = {\r\n      ...config.resolve.alias,\r\n      ...myAliases,\r\n    };\r\n  }\r\n  return config;\r\n}\r\n```\r\n\r\nMake sure to include this `webpackConfigHook` function in both your Worker's options (for dev usage) and `bundleWorkflowCode()`'s options (for production builds).","createdAt":"2024-07-25T18:59:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1468#issuecomment-2251204198","viewerDidAuthor":false},{"id":"IC_kwDOEujx186GLxLr","author":{"login":"ccravens"},"authorAssociation":"NONE","body":"Hello @mjameswh!\r\n\r\nThank you very much for getting back to me on this. I've really been working on this the past couple of days and I was able to find a reference to the webpackConfigHook in another issue and was able to update to this:\r\n\r\n```typescript\r\nconst { code } = await bundleWorkflowCode({\r\n      workflowsPath: require.resolve('~/temporal/workflows'),\r\n      workflowInterceptorModules: [require.resolve('~/temporal/interceptors/temporal.interceptor')],\r\n      logger: new TemporalLogger(),\r\n      webpackConfigHook: (config: Configuration) => {\r\n        if (config.resolve) {\r\n          config.resolve.plugins = [\r\n            ...(config.resolve.plugins ?? []),\r\n            new TsconfigPathsPlugin({\r\n              configFile: path.resolve(__dirname, '../../tsconfig.json'),\r\n            }),\r\n          ];\r\n        }\r\n\r\n        return config;\r\n      },\r\n      ignoreModules: [],\r\n    });\r\n```\r\n\r\nI learned more about webpack the past couple of days than I have ever wanted to lol\r\n\r\nI meant to update this issue, I appreciate your response on this and it is the correct solution. I'll close now, thanks again!","createdAt":"2024-07-25T19:16:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1468#issuecomment-2251231979","viewerDidAuthor":false}],"createdAt":"2024-07-21T15:21:05Z","labels":[],"milestone":null,"number":1468,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Interceptors Don't Seem to Support Module Alias","updatedAt":"2024-07-25T19:16:08Z","url":"https://github.com/temporalio/sdk-typescript/issues/1468"}
