{"assignees":[],"author":{"id":"MDQ6VXNlcjQyNjkwNzkw","is_bot":false,"login":"YufeeXing","name":"Mason Xing"},"body":"The situation is: We want to authenticate the values in the grpc header. The local activity is used here in the interceptor to get env variables like authentication URL and send the values in the header to the URL to authenticate. \r\nBut how to cache these user headers if there are more than one interceptors and we want to get the cache in other interceptors. Like something in Java is thread local storage.","closedAt":"2023-06-27T16:34:46Z","comments":[{"id":"IC_kwDOEujx185f6ILi","author":{"login":"YufeeXing"},"authorAssociation":"NONE","body":"In summary, Is there any way to store data in workflow execution context when excuting a activity? Then the data can be used in different child workflows, activities.","createdAt":"2023-06-27T08:52:19Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1149#issuecomment-1609073378","viewerDidAuthor":false},{"id":"IC_kwDOEujx185f9DyV","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"You can store data either in the global scope, which is *not* shared between workflow instances. Or using the workflow's `AsyncLocalStorage`, or just in the closure where you instantiate the interceptors.\r\nNote that you should avoid storing sensitive information in the persisted Temporal headers (the ones used in interceptors, not to be confused with grpc or http headers) as they are not encrypted by default (yet).","createdAt":"2023-06-27T16:18:06Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1149#issuecomment-1609841813","viewerDidAuthor":false},{"id":"IC_kwDOEujx185f9Kc1","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Here's how we use AsyncLocalStorage for implementing the opentelemetry interceptors: https://github.com/temporalio/sdk-typescript/blob/aec754c1d81520752d0c86d6a025348835c77959/packages/interceptors-opentelemetry/src/workflow/context-manager.ts#L2","createdAt":"2023-06-27T16:34:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1149#issuecomment-1609869109","viewerDidAuthor":false},{"id":"IC_kwDOEujx185gB8Ll","author":{"login":"YufeeXing"},"authorAssociation":"NONE","body":"> Here's how we use AsyncLocalStorage for implementing the opentelemetry interceptors:\r\n> \r\n> https://github.com/temporalio/sdk-typescript/blob/aec754c1d81520752d0c86d6a025348835c77959/packages/interceptors-opentelemetry/src/workflow/context-manager.ts#L2\r\n\r\nThanks for your help, @bergundy. Your reply is very helpful.\r\nI am using https://www.npmjs.com/package/continuation-local-storage to act as a storage like AsyncLocalStorage.\r\nHope this can work, too.","createdAt":"2023-06-28T09:59:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1149#issuecomment-1611121381","viewerDidAuthor":false},{"id":"IC_kwDOEujx185gGc0C","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"continuation-local-storage is outdated so I would not use it at all and in any case it will not work from the workflow context.","createdAt":"2023-06-29T01:27:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1149#issuecomment-1612303618","viewerDidAuthor":false},{"id":"IC_kwDOEujx185gGv2h","author":{"login":"YufeeXing"},"authorAssociation":"NONE","body":"> continuation-local-storage is outdated so I would not use it at all and in any case it will not work from the workflow context.\r\n\r\nI copied the context-manager.ts and export a new ContextManager() to get a instance\r\n`export default new ContextManager();`\r\nBut got a strange error:\r\n![image](https://github.com/temporalio/sdk-typescript/assets/42690790/fd662bc5-8c7a-4564-ab43-2869564d8b4d)\r\n\r\n","createdAt":"2023-06-29T03:27:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1149#issuecomment-1612381601","viewerDidAuthor":false},{"id":"IC_kwDOEujx185gHEE3","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Can you post a full reproduction?","createdAt":"2023-06-29T05:46:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1149#issuecomment-1612464439","viewerDidAuthor":false},{"id":"IC_kwDOEujx185gHEKo","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Are you using this in workflow context?","createdAt":"2023-06-29T05:47:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1149#issuecomment-1612464808","viewerDidAuthor":false},{"id":"IC_kwDOEujx185gN6LV","author":{"login":"YufeeXing"},"authorAssociation":"NONE","body":"> Are you using this in workflow context?\r\n\r\nYes, @bergundy.  In workflow context. I used it like this:\r\n1. Just copy the context-manager.ts, but export a default instance of it\r\n```\r\nimport * as otel from '@opentelemetry/api';\r\nimport { AsyncLocalStorage } from '@temporalio/workflow';\r\n\r\nexport class ContextManager implements otel.ContextManager {\r\n  protected storage = new AsyncLocalStorage<otel.Context>();\r\n\r\n  active(): otel.Context {\r\n    return this.storage.getStore() || otel.ROOT_CONTEXT;\r\n  }\r\n\r\n  bind<T>(context: otel.Context, target: T): T {\r\n    if (typeof target !== 'function') {\r\n      throw new TypeError(`Only function binding is supported, got ${typeof target}`);\r\n    }\r\n\r\n    // Stolen from https://github.com/open-telemetry/opentelemetry-js/blob/main/packages/opentelemetry-context-async-hooks/src/AbstractAsyncHooksContextManager.ts\r\n    const contextWrapper = (...args: unknown[]) => {\r\n      return this.with(context, () => target.apply(this, args));\r\n    };\r\n    Object.defineProperty(contextWrapper, 'length', {\r\n      enumerable: false,\r\n      configurable: true,\r\n      writable: false,\r\n      value: target.length,\r\n    });\r\n    /**\r\n     * It isn't possible to tell Typescript that contextWrapper is the same as T\r\n     * so we forced to cast as any here.\r\n     */\r\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n    return contextWrapper as any;\r\n  }\r\n\r\n  enable(): this {\r\n    return this;\r\n  }\r\n\r\n  disable(): this {\r\n    this.storage.disable();\r\n    return this;\r\n  }\r\n\r\n  with<A extends unknown[], F extends (...args: A) => ReturnType<F>>(\r\n    context: otel.Context,\r\n    fn: F,\r\n    thisArg?: ThisParameterType<F>,\r\n    ...args: A\r\n  ): ReturnType<F> {\r\n    const cb = thisArg == null ? fn : fn.bind(thisArg);\r\n    return this.storage.run(context, cb, ...args);\r\n  }\r\n}\r\nexport default new ContextManager()\r\n```\r\n\r\nThen in a workflow activity file, the instance was imported and used like this:\r\n```\r\nimport contextmanager from './contextmanager';\r\n\r\nasync function _activity1(headers: Headers): Promise<string> {\r\n}\r\n\r\nasync function _activity2(headers: Headers): Promise<string> {\r\n}\r\n\r\nconst localContext = contextmanager.active() || {};\r\nconst activity1= contextmanager.bind(localContext, _activity1);\r\nconst activity2 = contextmanager.bind(localContext, _activity2);\r\n\r\nexport { activity1, activity2 }\r\n```\r\nThen got the error.","createdAt":"2023-06-30T07:40:03Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1149#issuecomment-1614258901","viewerDidAuthor":false}],"createdAt":"2023-06-27T08:48:47Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1149,"reactionGroups":[],"state":"CLOSED","title":"[Support] How to cache data between different interceptors","updatedAt":"2023-06-30T07:42:01Z","url":"https://github.com/temporalio/sdk-typescript/issues/1149"}
