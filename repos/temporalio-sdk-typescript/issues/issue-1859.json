{"assignees":[],"author":{"id":"MDQ6VXNlcjk2NDI0NQ==","is_bot":false,"login":"daniellockyer","name":"Daniel Lockyer"},"body":"### What are you really trying to do?\n\nHi! üëãüèª \n\nWe have a project using the Temporal TS SDK, and previously the code was running `v1.11.8` of all Temporal packages. We had OTel instrumentation enabled (and working!) via the `@temporalio/interceptors-opentelemetry` package.\n\nUpon updating from v1.11.8 to v1.13.2, we started to see excessive CPU usage, sometimes up to 100%.\n\nWe have a different project that we bumped to v1.13.2 and didn't see excess CPU usage. The only key difference between these projects is that one has OTel enabled, and the other doesn't.\n\nRemoving all uses of `@temporalio/interceptors-opentelemetry` resolves the CPU issue, and it's back down to the level we were previously at. This implies to me what it's either a bug in `@temporalio/interceptors-opentelemetry`, or a bug in our implementation/use of it.\n\nI did a CPU profile via node inspector on one of the production instances, and couldn't see anything in the trace. I don't know if this means it's in one of the native dependencies, or V8 contexts or what.\n\nI looked at most commits between the two releases. There are some referencing OTel, but none that I'd expect to bump CPU usage up to 100%. I do not see any Temporal SDK errors in our logs.\n\nObviously, we'd like to keep instrumentation, so it'd be great to find the cause of this.\n\n### Describe the bug\n\n<img width=\"1006\" height=\"382\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/cb0650af-88fb-4cff-b55a-eef16553480f\" />\n\nWe updated the packages on the 26th (the rise) and disabled OTel on the 2nd (the drop).\n\n### Minimal Reproduction\n\nI'm currently unable to find a minimal reproduction, but here is the diff I have that would re-enable OTel instrumentation on our worker, and thus re-introduce the CPU increase. (I've had to trim out our code around it)\n\n```\ndiff --git a/xxx/index.ts b/xxx/index.ts\nindex 326f62c921..bdd1a99893 100644\n--- a/xxx/index.ts\n+++ b/xxx/index.ts\n@@ -1,4 +1,9 @@\n import path from 'path';\n+import {\n+  makeWorkflowExporter,\n+  OpenTelemetryActivityInboundInterceptor,\n+  OpenTelemetryActivityOutboundInterceptor,\n+} from '@temporalio/interceptors-opentelemetry/lib/worker';\n import {\n   NativeConnection,\n   NativeConnectionOptions,\n@@ -12,7 +17,7 @@ import { env } from '@/lib/env';\n...\n-import { otelSdk } from './lib/instrumentation';\n+import { otelSdk, resource, traceExporter } from './lib/instrumentation';\n \n const getConnection = async (): Promise<NativeConnection> => {\n   const connectionOptions: NativeConnectionOptions = {\n@@ -76,6 +81,9 @@ const getWorker = async (connection: NativeConnection): Promise<Worker> => {\n...\n+    sinks: {\n+      exporter: makeWorkflowExporter(traceExporter, resource),\n+    },\n   };\n   if (env.NODE_ENV !== 'development') {\n     options.workflowBundle = {\n@@ -93,6 +101,15 @@ const getWorker = async (connection: NativeConnection): Promise<Worker> => {\n         return config;\n       },\n     };\n+    options.interceptors = {\n+      workflowModules: [require.resolve('./workflows')],\n+      activity: [\n+        (ctx) => ({\n+          inbound: new OpenTelemetryActivityInboundInterceptor(ctx),\n+          outbound: new OpenTelemetryActivityOutboundInterceptor(ctx),\n+        }),\n+      ],\n+    };\n   }\n   return Worker.create(options);\n };\ndiff --git a/xxx/build-workflow-bundle.ts b/xxx/build-workflow-bundle.ts\nindex 212e8113b2..2a53bf8c1a 100644\n--- a/xxx/build-workflow-bundle.ts\n+++ b/xxx/build-workflow-bundle.ts\n@@ -6,6 +6,7 @@ import { bundleWorkflowCode } from '@temporalio/worker';\n async function bundle() {\n   const { code } = await bundleWorkflowCode({\n     workflowsPath: require.resolve('../workflows'),\n+    workflowInterceptorModules: [require.resolve('../workflows/flow.ts')],\n     webpackConfigHook: (config) => {\n       config.resolve = config.resolve || {};\n       config.resolve.alias = {\n\ndiff --git a/xxx/flow.ts b/xxx/flow.ts\nindex bb17ceb9db..fd366e2d88 100644\n--- a/xxx/flow.ts\n+++ b/xxx/flow.ts\n@@ -1,4 +1,9 @@\n...\n+import {\n+  OpenTelemetryInboundInterceptor,\n+  OpenTelemetryInternalsInterceptor,\n+  OpenTelemetryOutboundInterceptor,\n+} from '@temporalio/interceptors-opentelemetry/lib/workflow';\n import * as workflow from '@temporalio/workflow';\n \n@@ -40,6 +45,12 @@ ...\n...\n \n+export const interceptors: workflow.WorkflowInterceptorsFactory = () => ({\n+  inbound: [new OpenTelemetryInboundInterceptor()],\n+  outbound: [new OpenTelemetryOutboundInterceptor()],\n+  internals: [new OpenTelemetryInternalsInterceptor()],\n+});\n+\n...\n```\n\n### Environment/Versions\n\n- OS and processor: Linux\n- Temporal Version: v1.13.2\n- We're using the Temporal TS/JS packages for the projects, but also Temporal cloud\n","closedAt":null,"comments":[{"id":"IC_kwDOEujx187YupVZ","author":{"login":"mnahkies"},"authorAssociation":"CONTRIBUTOR","body":"I submitted a (as yet unreleased) patch in https://github.com/temporalio/sdk-typescript/pull/1834#issuecomment-3595493095 that solved similar problems for us.\n\nWe're running with this patch applied to our workloads using SDK `1.13.1` and seeing good results. **However** with the same patch against `1.13.2` we see performance regression, which I'm yet to understand.","createdAt":"2025-12-10T09:16:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1859#issuecomment-3636106585","viewerDidAuthor":false},{"id":"IC_kwDOEujx187Yu9K0","author":{"login":"mnahkies"},"authorAssociation":"CONTRIBUTOR","body":"Also note: You could try turning off [reusev8context](https://typescript.temporal.io/api/interfaces/worker.CompiledWorkerOptions#reusev8context) - my patch is only needed when this is enabled, as the [alternative VM](https://github.com/temporalio/sdk-typescript/blob/main/packages/worker/src/workflow/workflow-worker-thread.ts#L33-L48) does not have the same bug.\n\n(though interestingly your previous SDK version already defaulted `reusev8context` to `true`, so unclear to me why you weren't already seeing issues prior to upgrading)\n\nI've opened an issue specifically for issues I'm seeing between `1.13.1` -> `1.13.2` here: https://github.com/temporalio/sdk-typescript/issues/1860","createdAt":"2025-12-10T09:38:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1859#issuecomment-3636187828","viewerDidAuthor":false}],"createdAt":"2025-12-08T10:39:51Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1859,"reactionGroups":[],"state":"OPEN","title":"[Bug] High CPU usage with OTel instrumentation when updating to v1.13.x","updatedAt":"2025-12-10T09:38:08Z","url":"https://github.com/temporalio/sdk-typescript/issues/1859"}
