{"assignees":[],"author":{"id":"U_kgDOChu3Ew","is_bot":false,"login":"eyal-ringwald-orchid","name":""},"body":"### What are you really trying to do?\n\nthis is a bug report raised after opening a support issue #11853\n\nDuring our unit tests we run local env (as part of the beforeAll of a suite) of temporal to run the workflow on the service and those tests became flaky since on the worker initialization the worker could not connect to the new temporal env.\n\n### Describe the bug\n\nthe following code got an exception : \n      this.connection = await NativeConnection.connect(connectionOptions);\n\nTransportError: tonic::transport::Error(Transport, ConnectError(ConnectError(\"tcp connect error\", Os { code: 60, kind: TimedOut, message: \"Operation timed out\" })))            \n    120 |         this.options.temporalConfig,\n     121 |       );\n > 122 |       this.connection = await NativeConnection.connect(connectionOptions);\n           |                         ^\n    123 |     }\n    124 |     return this.connection;\n    125 |   }\n\n\nthe test looks like this : \nthis is a sample of the test beforeAll beforeEach afterAll and afterEach , the test basically runs a service with temporal worker and its beforeAll fails on starting up the worker since it does not connect.\n\nbeforeAll(async () => {\n    const port = await getFreePort();\n    originalEndpoint = process.env.TEMPORAL_ENDPOINT;\n    process.env.TEMPORAL_ENDPOINT = `localhost:${port}`;\n    env = await TestWorkflowEnvironment.createLocal({\n      server: { namespace: 'default', port, ui: false },\n    });\n })\n beforeEach(async () => {\n\n    jest.clearAllMocks();\n    installSpy.mockImplementation();\n    getCreationCycleIdSpy = jest\n      .spyOn(GetEntitiesUpdatesService.prototype, 'getCreationCycleId')\n      .mockResolvedValue({\n        [Entities.APPLICATIONS]: creationCycleId,\n        [Entities.GROUPS]: creationCycleId,\n        [Entities.POLICIES]: creationCycleId,\n        [Entities.SERVICE_PRINCIPALS]: creationCycleId,\n        [Entities.USERS]: creationCycleId,\n      });\n\n    getAppsByIdsSpy = jest\n      .spyOn(\n        InitIntegrationForSpecificIdsService.prototype,\n        'getAppsByIds',\n      )\n      .mockResolvedValue({\n        dataPersistentResult: {\n          failed: [\n            { entityName: '1', id: '1', success: false },\n            { entityName: '2', id: '2', success: false },\n          ],\n          originalNumberOfPayloads: 3,\n          success: [{ entityName: '3', id: '3', success: true }],\n        },\n      });\n   ....\n\n    const module: TestingModule = await Test.createTestingModule({\n      imports: [AppModule],\n    }).compile();\n    app = module.createNestApplication();\n    await app.init();\n  });\n\n  afterEach(async () => {\n    await app?.close();\n    })\n\n  afterAll(async () => {\n    process.env.TEMPORAL_ENDPOINT = originalEndpoint;\n    await env?.teardown();\n  });\n\n\n### Minimal Reproduction\n\nthis is not reproducible in simple test , but only when a large set of suites running together. we run the jest tests in band for the service. it smells that the number of tests is the cause for the issue so it might be related to resources issue.\nwe have around 10 suites that running such tests with same pattern of running the local env in each suite.\n\n### Environment/Versions\n\n- OS and processor: Apple M3 Pro sequia 15.3.2\n- Temporal Version: 1.11.3\n- Are you using Docker or Kubernetes or building Temporal from source? we use packages from npm. our services are deployed on docker in kubernetes , but the issue is about running a test in my development computer.\n\n### Additional context\n\nwe use nestjs.\nthe test does not fail when runing it singularily.\nI tried to create the local env for each test as well but it did not help.\nwe use runInBand option to run the tests sequentially and not in parallel.\nas a workaround i was advised  by the support team to do retries until i can connect to the local env. it works.","closedAt":null,"comments":[],"createdAt":"2025-04-22T08:48:21Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1687,"reactionGroups":[],"state":"OPEN","title":"[Bug] Temporal local env cannot be connected in unit tests","updatedAt":"2025-04-22T08:48:21Z","url":"https://github.com/temporalio/sdk-typescript/issues/1687"}
