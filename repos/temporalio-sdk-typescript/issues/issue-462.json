{"assignees":[],"author":{"id":"MDQ6VXNlcjI1MTI4OA==","is_bot":false,"login":"lorensr","name":"Loren ☺️"},"body":"## Problem\r\n\r\nCurrently, an Error thrown from a workflow results in this Worker output (& Web history):\r\n\r\n```ts\r\nthrow new Error('error in workflow');\r\n// Failing workflow activation...\r\n// { message: \"Error: error in workflow\", source: \"TypeScriptSDK\", stack_trace: \"\", cause: None, failure_info: None }\r\n```\r\n\r\nAnd throwing an object results in:\r\n\r\n```ts\r\nthrow { field: 'data' };\r\n// Failing workflow activation...\r\n// { message: \"[object Object]\", source: \"TypeScriptSDK\", stack_trace: \"\", cause: None, failure_info: None }\r\n```\r\n\r\n## Solution\r\n\r\n### Correct\r\n\r\n- `failure_info`: Should be None in Error case. Use [subclass of `TemporalFailure`](https://docs.temporal.io/docs/typescript/handling-failure/#failure-classes-reference) to get this filled in.\r\n\r\n### Change\r\n\r\n- `message`: If thrown object isn't an Error, set `message = JSON.stringify(object)`. \r\n- `stack_trace`: Fill it in when Error is thrown (currently only filled in when `instanceof TemporalFailure`). When non-Error is thrown, log warning saying \"we recommend throwing Errors so that you can see the stack trace\".\r\n- `cause`: When thrown error has a `cause` property, put a `Failure` here (currently only works when provided to constructor of `TemporalFailure` etc)\r\n- `source`: Maybe be more specific, like `TypeScriptSDK > Worker > myWorkflowName`\r\n\r\n## Related\r\n\r\n@Sushisource We can't do anything about `throw new Error(object)`, since Node calls `toString()` on it before we get it:\r\n\r\n![image](https://user-images.githubusercontent.com/251288/152221258-deac6db5-9ecf-4052-bf48-05a20b18ebba.png)\r\n\r\n![image](https://user-images.githubusercontent.com/251288/152221306-24afdf58-b090-4100-a928-74d422eb3ac6.png)\r\n","closedAt":"2022-07-29T21:24:14Z","comments":[{"id":"IC_kwDOEujx185GTOV0","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"@lorensr is this still relevant?","createdAt":"2022-07-09T00:37:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/462#issuecomment-1179444596","viewerDidAuthor":false},{"id":"IC_kwDOEujx185GX9Eo","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Yes. The first 3 bullets are fixed, but not the fourth:\r\n\r\n- `source`: Maybe be more specific, like `TypeScriptSDK > Worker > myWorkflowName`\r\n\r\nI guess if source is never Client, we can take out `Worker`. But could still differentiate between source being a Workflow, Activity, or other categories? Data converters?\r\n\r\n--- \r\n\r\nFixed: \r\n\r\nNow throwing an Error results in:\r\n\r\n```\r\n{\r\n  \"message\": \"error in workflow\",\r\n  \"source\": \"TypeScriptSDK\",\r\n  \"stackTrace\": \"Error: error in workflow\\n    at example (/Users/me/gh/samples-typescript/hello-world/src/workflows.ts:12:8)\\n    at Activator.startWorkflowNextHandler (/Users/me/gh/samples-typescript/src/internals.ts:88:16)\\n    at Activator.startWorkflow (/Users/me/gh/samples-typescript/src/internals.ts:113:6)\\n    at /Users/me/gh/samples-typescript/src/worker-interface.ts:219:35\\n    at Object.activate (/Users/me/gh/samples-typescript/src/worker-interface.ts:223:2)\\n    at evalmachine.<anonymous>:1:18\",\r\n  \"cause\": null\r\n}\r\n```\r\n\r\nand throwing an object results in:\r\n\r\n```\r\n{\r\n  \"message\": \"{\\\"field\\\":\\\"data\\\"} [A non-Error value was thrown from your code. We recommend throwing Error objects so that we can provide a stack trace]\",\r\n  \"source\": \"TypeScriptSDK\",\r\n  \"stackTrace\": \"\",\r\n  \"cause\": null\r\n}\r\n```\r\n\r\nand an Error with an Error `.cause`:\r\n\r\n```\r\n{\r\n  \"message\": \"error in workflow\",\r\n  \"source\": \"TypeScriptSDK\",\r\n  \"stackTrace\": \"Error: error in workflow\\n    at example (/Users/me/gh/samples-typescript/hello-world/src/workflows.ts:12:17)\\n    at Activator.startWorkflowNextHandler (/Users/me/gh/samples-typescript/src/internals.ts:88:16)\\n    at Activator.startWorkflow (/Users/me/gh/samples-typescript/src/internals.ts:113:6)\\n    at /Users/me/gh/samples-typescript/src/worker-interface.ts:219:35\\n    at Object.activate (/Users/me/gh/samples-typescript/src/worker-interface.ts:223:2)\\n    at evalmachine.<anonymous>:1:18\",\r\n  \"cause\": {\r\n    \"message\": \"cause error\",\r\n    \"source\": \"TypeScriptSDK\",\r\n    \"stackTrace\": \"Error: cause error\\n    at example (/Users/me/gh/samples-typescript/hello-world/src/workflows.ts:13:12)\\n    at Activator.startWorkflowNextHandler (/Users/me/gh/samples-typescript/src/internals.ts:88:16)\\n    at Activator.startWorkflow (/Users/me/gh/samples-typescript/src/internals.ts:113:6)\\n    at /Users/me/gh/samples-typescript/src/worker-interface.ts:219:35\\n    at Object.activate (/Users/me/gh/samples-typescript/src/worker-interface.ts:223:2)\\n    at evalmachine.<anonymous>:1:18\",\r\n    \"cause\": null\r\n  }\r\n}\r\n```","createdAt":"2022-07-11T17:37:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/462#issuecomment-1180684584","viewerDidAuthor":false},{"id":"IC_kwDOEujx185GYVWT","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Hmm.. we could add more info in the source field, I didn't put too much thought into it and just copied from Java.\r\nNothing in the system looks into the source field AFAIK.\r\nI would say it isn't worth the complication though.","createdAt":"2022-07-11T19:31:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/462#issuecomment-1180784019","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Hhd1P","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"@lorensr I prefer closing this, at this point changing the source field would be a breaking change, since this field is checked when parsing stack traces, and I don't the proposed enhancement is significant.","createdAt":"2022-07-29T21:24:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/462#issuecomment-1199955279","viewerDidAuthor":false}],"createdAt":"2022-02-02T19:20:20Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":462,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Put more info into workflow activation failures","updatedAt":"2022-07-29T21:24:14Z","url":"https://github.com/temporalio/sdk-typescript/issues/462"}
