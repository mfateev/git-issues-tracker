{"assignees":[{"id":"MDQ6VXNlcjI1MTI4OA==","login":"lorensr","name":"Loren â˜ºï¸","databaseId":0}],"author":{"id":"MDQ6VXNlcjEwOTg0MDI5","is_bot":false,"login":"mengyazhu96","name":"jessica"},"body":"### Is your feature request related to a problem? Please describe.\r\nWhen using pnpm with the Typescript SDK, the Temporal worker's webpack building step fails. As a workaround, we had to add the `shamefully-hoist=true` option so that pnpm reverts to npm/yarn style module locations, e.g. putting everything in `./node_modules` instead of in workspace node modules, e.g. `./workspaces/*/node_modules`\r\n\r\n### Describe the solution you'd like\r\nSupport pnpm. I'm not sure what this entails ðŸ˜… \r\n\r\n### Additional context\r\nFrom Slack thread here: https://temporalio.slack.com/archives/C01DKSMU94L/p1638764279342400\r\n\r\ncc @bergundy @spikebrehm\r\n","closedAt":"2022-04-21T21:56:28Z","comments":[{"id":"IC_kwDOEujx18464wK3","author":{"login":"spikebrehm"},"authorAssociation":"NONE","body":"There may be multiple layers of issues, but the immediate one that surfaces has to do with missing dependencies listed in your monorepo packages' `package.json`. For example, grep for `protobufjs`; youâ€™ll note that itâ€™s listed in `packages/worker/package.json` but is only used in the `packages/workflow` package, and not listed in its `package.json`. probably a mistake during refactoring. That's the first example that errored for us but there may be more issues like this in your monorepo.\r\n\r\nRelatedly, this is why we moved from npm -> pnpm â€” it fails loudly when packages/workspaces havenâ€™t configured dependencies correctly.\r\n","createdAt":"2021-12-07T14:04:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-987955895","viewerDidAuthor":false},{"id":"IC_kwDOEujx1847A-TN","author":{"login":"flybayer"},"authorAssociation":"NONE","body":"@mengyazhu96 I'm unable to get it working even with `shamefully-hoist=true`. Was there anything else you had to do?\r\n\r\n```\r\n2021-12-09T18:25:30.281Z [ERROR] ERROR in ../../node_modules/.pnpm/@temporalio+common@0.16.4/node_modules/@temporalio/common/lib/time.js 7:31-46\r\n2021-12-09T18:25:30.281Z [ERROR] Module not found: Error: Can't resolve 'long' in '/Users/b/c/flightcontrol/node_modules/.pnpm/@temporalio+common@0.16.4/node_modules/@temporalio/common/lib'\r\n2021-12-09T18:25:30.281Z [ERROR]  @ ../../node_modules/.pnpm/@temporalio+common@0.16.4/node_modules/@temporalio/common/lib/index.js 24:13-30\r\n2021-12-09T18:25:30.281Z [ERROR]  @ ../../node_modules/.pnpm/@temporalio+workflow@0.16.3/node_modules/@temporalio/workflow/lib/worker-interface.js 9:17-46\r\n2021-12-09T18:25:30.281Z [ERROR]  @ ../../../../../../src/main.js 1:0-68 4:0-19 5:0-18 26:4-7\r\n2021-12-09T18:25:30.281Z [ERROR]\r\n2021-12-09T18:25:30.281Z [ERROR] ERROR in ../../node_modules/.pnpm/@temporalio+common@0.16.4/node_modules/@temporalio/common/lib/time.js 8:29-42\r\n2021-12-09T18:25:30.281Z [ERROR] Module not found: Error: Can't resolve 'ms' in '/Users/b/c/flightcontrol/node_modules/.pnpm/@temporalio+common@0.16.4/node_modules/@temporalio/common/lib'\r\n2021-12-09T18:25:30.281Z [ERROR]  @ ../../node_modules/.pnpm/@temporalio+common@0.16.4/node_modules/@temporalio/common/lib/index.js 24:13-30\r\n2021-12-09T18:25:30.281Z [ERROR]  @ ../../node_modules/.pnpm/@temporalio+workflow@0.16.3/node_modules/@temporalio/workflow/lib/worker-interface.js 9:17-46\r\n2021-12-09T18:25:30.281Z [ERROR]  @ ../../../../../../src/main.js 1:0-68 4:0-19 5:0-18 26:4-7\r\n2021-12-09T18:25:30.281Z [ERROR]\r\n2021-12-09T18:25:30.281Z [ERROR] ERROR in ../../node_modules/.pnpm/@temporalio+proto@0.16.0/node_modules/@temporalio/proto/lib/coresdk.js 4:16-45\r\n2021-12-09T18:25:30.281Z [ERROR] Module not found: Error: Can't resolve 'protobufjs/minimal' in '/Users/b/c/flightcontrol/node_modules/.pnpm/@temporalio+proto@0.16.0/node_modules/@temporalio/proto/lib'\r\n2021-12-09T18:25:30.281Z [ERROR]  @ ../../node_modules/.pnpm/@temporalio+workflow@0.16.3/node_modules/@temporalio/workflow/lib/worker-interface.js 10:18-58\r\n2021-12-09T18:25:30.281Z [ERROR]  @ ../../../../../../src/main.js 1:0-68 4:0-19 5:0-18 26:4-7\r\n2021-12-09T18:25:30.281Z [ERROR]\r\n2021-12-09T18:25:30.281Z [ERROR] ERROR in ../../node_modules/.pnpm/@temporalio+workflow@0.16.3/node_modules/@temporalio/workflow/lib/internals.js 38:31-46\r\n2021-12-09T18:25:30.281Z [ERROR] Module not found: Error: Can't resolve 'long' in '/Users/b/c/flightcontrol/node_modules/.pnpm/@temporalio+workflow@0.16.3/node_modules/@temporalio/workflow/lib'\r\n2021-12-09T18:25:30.281Z [ERROR]  @ ../../node_modules/.pnpm/@temporalio+workflow@0.16.3/node_modules/@temporalio/workflow/lib/worker-interface.js 11:20-42\r\n2021-12-09T18:25:30.281Z [ERROR]  @ ../../../../../../src/main.js 1:0-68 4:0-19 5:0-18 26:4-7\r\n2021-12-09T18:25:30.281Z [ERROR]\r\n2021-12-09T18:25:30.281Z [ERROR] ERROR in ../../node_modules/.pnpm/@temporalio+workflow@0.16.3/node_modules/@temporalio/workflow/lib/internals.js 39:32-61\r\n2021-12-09T18:25:30.281Z [ERROR] Module not found: Error: Can't resolve 'protobufjs/minimal' in '/Users/b/c/flightcontrol/node_modules/.pnpm/@temporalio+workflow@0.16.3/node_modules/@temporalio/workflow/lib'\r\n2021-12-09T18:25:30.281Z [ERROR]  @ ../../node_modules/.pnpm/@temporalio+workflow@0.16.3/node_modules/@temporalio/workflow/lib/worker-interface.js 11:20-42\r\n2021-12-09T18:25:30.281Z [ERROR]  @ ../../../../../../src/main.js 1:0-68 4:0-19 5:0-18 26:4-7\r\n2021-12-09T18:25:30.281Z [ERROR]\r\n2021-12-09T18:25:30.281Z [ERROR] 5 errors have detailed information that is not shown.\r\n2021-12-09T18:25:30.281Z [ERROR] Use 'stats.errorDetails: true' resp. '--stats-error-details' to show it.\r\n2021-12-09T18:25:30.281Z [ERROR]\r\n2021-12-09T18:25:30.281Z [ERROR] webpack 5.65.0 compiled with 5 errors in 4357 ms\r\n```","createdAt":"2021-12-09T18:26:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-990110925","viewerDidAuthor":false},{"id":"IC_kwDOEujx1847BDca","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Sounds like all we need is to add the missing dependencies to each package.\r\nI think there's some lint rule that checks that any referenced package in your code is referenced in `package.json`, I'll get to this soon.","createdAt":"2021-12-09T18:55:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-990131994","viewerDidAuthor":false},{"id":"IC_kwDOEujx1847mkWr","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"While trying to reproduce this, I got errors that are unrelated to missing dependencies.\r\nEven dependencies that are defined properly aren't being found by webpack if I install the packages with `pnpm`.\r\nI'll continue working on it and see what I can find.","createdAt":"2021-12-23T00:52:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-999966123","viewerDidAuthor":false},{"id":"IC_kwDOEujx1847nXc7","author":{"login":"akurkin"},"authorAssociation":"NONE","body":"Encountered same issue when trying to setup monorepo with temporal typescript SDK using rushjs.io monorepo approach (which uses pnpm)","createdAt":"2021-12-23T09:47:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-1000175419","viewerDidAuthor":false},{"id":"IC_kwDOEujx1847oIrW","author":{"login":"spikebrehm"},"authorAssociation":"NONE","body":"I ended having to add all these dependencies directly to our own workspace, e.g. `packages/temporal-worker/package.json` in our monorepo:\r\n\r\n```\r\n    \"@protobufjs/aspromise\": \"^1.1.2\",\r\n    \"@protobufjs/base64\": \"^1.1.2\",\r\n    \"@protobufjs/eventemitter\": \"^1.1.0\",\r\n    \"@protobufjs/float\": \"^1.0.2\",\r\n    \"@protobufjs/inquire\": \"^1.1.0\",\r\n    \"@protobufjs/pool\": \"^1.1.0\",\r\n    \"@protobufjs/utf8\": \"^1.1.0\",\r\n    \"@temporalio/proto\": \"^0.16.0\",\r\n    \"long\": \"^5.2.0\",\r\n    \"ms\": \"^2.1.3\",\r\n    \"protobufjs\": \"^6.11.2\",\r\n    \"ts-loader\": \"^9.2.6\",\r\n    \"tslib\": \"^2.3.1\",\r\n    \"webpack\": \"^5.20.0\",\r\n```\r\n\r\nthese instead should be specified as deps in your sdk","createdAt":"2021-12-23T15:28:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-1000377046","viewerDidAuthor":false},{"id":"IC_kwDOEujx1847qI1T","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"@spikebrehm what's strange to me is that I'm getting errors for packages that are specified as dependencies.\r\nSome of the ones you've posted here are already set as dependencies in the SDK.","createdAt":"2021-12-24T17:10:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-1000901971","viewerDidAuthor":false},{"id":"IC_kwDOEujx1847qI11","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"See the pnpm issue here: https://github.com/pnpm/pnpm/issues/4155","createdAt":"2021-12-24T17:10:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-1000902005","viewerDidAuthor":false},{"id":"IC_kwDOEujx184_G0kd","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"The `temporalio@next` package still isn't working for me, but the individual packages are working with [`0.19.0-rc.1`](https://github.com/temporalio/sdk-typescript/blob/main/CHANGELOG.md#0190-rc1---2022-03-02):\r\n\r\n```ts\r\ngit clone git@github.com:temporalio/samples-typescript.git\r\ncd samples-typescript/hello-world\r\npnpm rm temporalio\r\npnpm add @temporalio/worker@next @temporalio/workflow@next @temporalio/client@next @temporalio/activity@next\r\npnpm start\r\n```\r\n\r\n```ts\r\npnpm run workflow\r\n```","createdAt":"2022-03-04T02:03:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-1058752797","viewerDidAuthor":false},{"id":"IC_kwDOEujx184_QZ5B","author":{"login":"swyxio"},"authorAssociation":"CONTRIBUTOR","body":"lets document this! makes sense that the bundle package doesnt work?","createdAt":"2022-03-08T00:01:02Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-1061264961","viewerDidAuthor":false},{"id":"IC_kwDOEujx184_QaD-","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"I don't know? I was thinking we'd be able to make it work, and then we won't have anything to document. Haven't looked into it yet","createdAt":"2022-03-08T00:02:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-1061265662","viewerDidAuthor":false},{"id":"IC_kwDOEujx184_Yeq3","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Looks like `pnpm add temporalio` doesn't install `temporalio`'s dependencies. I opened an issue, but with 718 open issues, not sure when they'll get to it. Anyone more familiar with pnpm up for taking a look? cc @flybayer \r\n\r\nhttps://github.com/pnpm/pnpm/issues/4428","createdAt":"2022-03-09T21:19:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-1063381687","viewerDidAuthor":false},{"id":"IC_kwDOEujx184_nB6U","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"> Looks like pnpm add temporalio doesn't install temporalio's dependencies.\r\n\r\nAFAIK that this is the expected behaviour for `pnpm` and `yarn3`. They both impose strict dependency resolution, which means that a package can _never_ get transitive access to dependencies of its own dependencies. If a user package needs to use some library package, it has to name that library package explicitly in its own package.json.\r\n\r\nThat means that the `temporalio` meta package simply doesn't make any sense when using `pnpm` or `yarn3`. The generic install procedure for these environments should list all temporal public packages explicitly.\r\n\r\nI think the only way around this would be to have the meta package reexport the content of all public packages, using package.json's `exports` field, and have users always import though that meta package. So for example, instead of:\r\n\r\n```\r\nimport { proxyActivities } from '@temporalio/workflow';\r\n```\r\n\r\nthe user would write:\r\n\r\n```\r\nimport { proxyActivities } from 'temporalio/workflow';\r\n```","createdAt":"2022-03-14T19:18:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-1067196052","viewerDidAuthor":false},{"id":"IC_kwDOEujx184_nHz-","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Ah, thanks! That makes sense. Looks like Yarn PnP is used by default since v2, and while it [works in loose mode](https://yarnpkg.com/features/pnp#pnp-loose-mode), strict mode has been default since v2.1.","createdAt":"2022-03-14T19:48:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-1067220222","viewerDidAuthor":false},{"id":"IC_kwDOEujx184_nTqZ","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"> ```ts\r\n> import { proxyActivities } from 'temporalio/workflow';\r\n> ```\r\n\r\nI have considered this before but I'm not convinced this is the right direction.\r\nOne of the advantages of having separate packages is that the client does not depend on any native libraries and can be easily used in environments where there's limited control of the deployment process such as serverless functions.\r\nWe could add aliases from `temporalio/*` to `@temporalio/*` but then users that only want the client would need to refactor their imports or include the native library. It would also mean that our docs and samples should reflect these alternative APIs which isn't ideal IMHO.\r\nI'm not 100% convinced this would be a real issue, I can be convinced otherwise.","createdAt":"2022-03-14T20:43:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-1067268761","viewerDidAuthor":false},{"id":"IC_kwDOEujx184_nbm0","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"> We could add aliases from `temporalio/*` to `@temporalio/*` but then users that only want the client would need to refactor their imports or include the native library. It would also mean that our docs and samples should reflect these alternative APIs which isn't ideal IMHO.\r\n\r\nI agree. Officially supporting both syntaxes would mean uncertainties for users. Not desirable.\r\n\r\n> I'm not 100% convinced this would be a real issue, I can be convinced otherwise.\r\n\r\nDon't count on me to convince you, I personally don't think this is an issue either ðŸ¤£  Honestly, I only mentioned the alternative for completeness.","createdAt":"2022-03-14T21:15:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-1067301300","viewerDidAuthor":false},{"id":"IC_kwDOEujx184_nr-y","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Okay then soft plan is to document: \r\n\r\n\"Don't install the `temporalio` package if you're using yarn or pnpm. Instead, install the `@temporalio/*` packages that you import from.\"\r\n\r\nLeaving this issue open for a bit to see if yarn/pnpm users have a different preference or ideas.","createdAt":"2022-03-14T22:33:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-1067368370","viewerDidAuthor":false},{"id":"IC_kwDOEujx185B6SpC","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I think it's safe to close this issue.\r\nIf anyone feels this is not solved, please reopen.","createdAt":"2022-04-21T21:56:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/421#issuecomment-1105799746","viewerDidAuthor":false}],"createdAt":"2021-12-06T17:57:54Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":421,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":6}}],"state":"CLOSED","title":"[Feature Request] pnpm support","updatedAt":"2022-04-21T21:56:28Z","url":"https://github.com/temporalio/sdk-typescript/issues/421"}
