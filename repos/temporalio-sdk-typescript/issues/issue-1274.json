{"assignees":[],"author":{"id":"MDQ6VXNlcjI3OTc0ODk=","is_bot":false,"login":"marcoreni","name":"Marco Reni"},"body":"### What are you really trying to do?\r\n\r\nSending an error to a Sink function and preserve all the attributes.\r\n\r\n### Describe the bug\r\n\r\nIt seems that the error that the error received from the sink function has less fields than the error which was sent.\r\n\r\nFor example: we're creating an ApplicationFailure.nonRetryable from a child workflow, and we're intercepting the error inside the parent workflow.\r\n\r\nError inside the parent workflow:\r\n```js\r\n{\r\n  cause: {\r\n    cause: undefined,\r\n    type: 'my_error_type',\r\n    nonRetryable: true,\r\n    details: [],\r\n    failure: {\r\n      message: 'my_error_message',\r\n      source: 'TypeScriptSDK',\r\n      stackTrace: 'ApplicationFailure: my_error_message\\n' +\r\n        '    at Function.nonRetryable (/usr/app/node_modules/.pnpm/@temporalio+common@1.8.6/node_modules/@temporalio/common/src/failure.ts:149:11)\\n' +\r\n        '    at nonRetryable (/usr/app/src/workflows/index.ts:51:28)',\r\n      applicationFailureInfo: [Object]\r\n    },\r\n    name: 'ApplicationFailure',\r\n    message: 'my_error_message',\r\n    stack: 'ApplicationFailure: my_error_message\\n' +\r\n      '    at Function.nonRetryable (/usr/app/node_modules/.pnpm/@temporalio+common@1.8.6/node_modules/@temporalio/common/src/failure.ts:149:11)\\n' +\r\n      '    at nonRetryable (/usr/app/src/workflows/index.ts:51:28)'\r\n  },\r\n  namespace: 'default',\r\n  execution: {\r\n    workflowId: '1698670214662-foobar',\r\n    runId: 'd46839c0-2255-489b-b8ea-37b41b8501e9'\r\n  },\r\n  workflowType: 'my_workflow_type',\r\n  retryState: 5,\r\n  failure: {\r\n    message: 'Child Workflow execution failed',\r\n    cause: {\r\n      message: 'my_error:message',\r\n      source: 'TypeScriptSDK',\r\n      stackTrace: 'ApplicationFailure: my_error_message\\n' +\r\n        '    at Function.nonRetryable (/usr/app/node_modules/.pnpm/@temporalio+common@1.8.6/node_modules/@temporalio/common/src/failure.ts:149:11)\\n' +\r\n        '    at nonRetryable (/usr/app/src/workflows/index.ts:51:28)',\r\n      applicationFailureInfo: [Object]\r\n    },\r\n    childWorkflowExecutionFailureInfo: {\r\n      namespace: 'default',\r\n      workflowExecution: [Object],\r\n      workflowType: [Object],\r\n      initiatedEventId: '23',\r\n      startedEventId: '24',\r\n      retryState: 'RETRY_STATE_RETRY_POLICY_NOT_SET'\r\n    }\r\n  },\r\n  name: 'ChildWorkflowFailure',\r\n  message: 'Child Workflow execution failed',\r\n  stack: ''\r\n}\r\n\r\n```\r\n\r\n\r\nError that is received from the sink:\r\n```js\r\n{\r\n  name: \"Error\",\r\n  message: \"Child Workflow execution failed\",\r\n  stack: \"\",\r\n  cause: {\r\n    name: \"Error\",\r\n    message: \"my_error_message\",\r\n    stack:\r\n      \"ApplicationFailure: my_error_message\\n\" +\r\n      \"    at Function.nonRetryable (/usr/app/node_modules/.pnpm/@temporalio+common@1.8.6/node_modules/@temporalio/common/src/failure.ts:149:11)\\n\" +\r\n      \"    at nonRetryable (/usr/app/src/workflows/index.ts:51:28)\",\r\n  },\r\n};\r\n\r\n```\r\n\r\nGiven that, IIUC, the sink is implemented via a postMessage, would it be possible to extend the serialization format of the error so that more fields are passed through (more specifically, we're currently interested in `type` and `details` of the cause)?\r\n\r\n### Minimal Reproduction\r\n\r\nN/A\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: M1 Mac\r\n- Temporal Version: 1.8.6\r\n- Are you using Docker or Kubernetes or building Temporal from source? Docker\r\n\r\n### Additional context\r\n","closedAt":null,"comments":[{"id":"IC_kwDOEujx185qchQR","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"This is a known limitation of sinks. As you pointed out, the data is transferred over `postMessage` from a worker thread to the main Node.js thread which uses the structured clone algorithm.\r\n\r\nhttps://nodejs.org/api/worker_threads.html#portpostmessagevalue-transferlist\r\n\r\nLooks like our documentation doesn't call out this limitation clearly enough though. I think we should add this information on `proxySinks` and the `WorkerOptions.sinks`.\r\n\r\nhttps://typescript.temporal.io/api/namespaces/workflow#sinkfunction","createdAt":"2023-10-30T19:00:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1274#issuecomment-1785861137","viewerDidAuthor":false}],"createdAt":"2023-10-30T13:02:35Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1274,"reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"state":"OPEN","title":"[Bug] Error not serialized fully when sent to Sinks","updatedAt":"2023-10-30T19:00:24Z","url":"https://github.com/temporalio/sdk-typescript/issues/1274"}
