{"assignees":[{"id":"MDQ6VXNlcjUyMzA0","login":"bergundy","name":"Roey Berman","databaseId":0}],"author":{"id":"MDQ6VXNlcjI1MTI4OA==","is_bot":false,"login":"lorensr","name":"Loren ☺️"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\n```\r\nawait Worker.create({\r\n    workflowsPath: path.join(__dirname, 'workflows'),\r\n```\r\n\r\ndoesn't work for `./workflows.js`—it only works for a `./workflows/` directory.\r\n\r\n### Describe the solution you'd like\r\n\r\nThe ability to have this file structure: https://github.com/lorensr/samples-node/blob/1d6ff776fb4d1376d62045621a7179d73b890eb1/hello-world/src/worker.ts#L18\r\n\r\n### Additional context\r\n\r\nThis would fix https://github.com/temporalio/samples-node/issues/13\r\n","closedAt":"2021-10-07T14:31:54Z","comments":[{"id":"IC_kwDOEujx1843F_Ka","author":{"login":"joebowbeer"},"authorAssociation":"CONTRIBUTOR","body":"The goal of this RFE is for the isolate to implement [Node-style import resolution](https://www.typescriptlang.org/docs/handbook/module-resolution.html#node) for `workflows`?\r\n\r\nBecause ts-loader does this, most TypeScript programmers will expect this and will trip over it if it doesn't work.\r\n\r\nThere may be some leads in the following discussion:\r\n\r\nhttps://github.com/webpack/webpack/issues/13252\r\n\r\nFor example, [this comment](https://github.com/webpack/webpack/issues/13252#issuecomment-828587290)\r\n\r\nI think the \"fix\" would need to be added to this code:\r\n\r\nhttps://github.com/temporalio/sdk-node/blob/52f67499860526cd180912797dc3e6d7fa4fc78f/packages/worker/src/isolate-builder.ts#L104","createdAt":"2021-09-21T19:26:57Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/258#issuecomment-924316314","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843K84j","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I think it's easy to just look if `workflows/index.js` exists and if it doesn't try `workflows.js` probably somewhere in the isolate builder or the worker.","createdAt":"2021-09-23T08:46:31Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/258#issuecomment-925617699","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843QP_E","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Started looking into this here: https://github.com/lorensr/sdk-node/tree/single-file\r\n\r\nwith these changes: https://github.com/lorensr/sdk-node/commit/270793cb620fa81036173585ac319e5a100800b1\r\n\r\n```\r\nworkflowsPath: `${__dirname}/workflow-file.js`\r\n```\r\n\r\nWhen I comment out these 3 lines:\r\n\r\nhttps://github.com/lorensr/sdk-node/commit/270793cb620fa81036173585ac319e5a100800b1#diff-6ca636db1dc7530aefb4f6e9c60d7d81b77e2c128068ff41f5940bb47fe67fc5R115-R117\r\n\r\nThe test doesn't succeed, but it stops erroring:\r\n\r\n![image](https://user-images.githubusercontent.com/251288/134757195-bf806136-4a84-4f9a-afae-04ff5072327f.png)\r\n\r\nWith those lines uncommented, webpack build error is:\r\n\r\n![image](https://user-images.githubusercontent.com/251288/134757280-a6f34f69-c237-42e7-be28-43a5b366632b.png)\r\n\r\nI think most telling is the line:\r\n\r\n`/Users/me/gh/sdk-node/packages/test/lib/workflow-file.js is not a directory`, which I'm guessing is coming from:\r\n\r\n`return require(${JSON.stringify(this.workflowsPath)} + '${path.sep}' + path)[name];`\r\n\r\n","createdAt":"2021-09-25T04:06:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/258#issuecomment-927006660","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843QkXD","author":{"login":"joebowbeer"},"authorAssociation":"CONTRIBUTOR","body":"> I think it's easy to just look if `workflows/index.js` exists and if it doesn't try `workflows.js` probably somewhere in the isolate builder or the worker.\r\n\r\nChecking that `workflows` path exists in worker:\r\n\r\nhttps://github.com/temporalio/sdk-node/blob/e08ffada21ea2fe10071e1cd36683ee4573185f7/packages/worker/src/worker.ts#L279\r\n\r\nconst workflowsDir = resolve(workDir, 'workflows');\r\nreturn fs.existsSync(workflowsDir) ? workflowsDir : resolve(workDir, 'workflows.js');","createdAt":"2021-09-25T08:49:39Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/258#issuecomment-927090115","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843Q9_t","author":{"login":"joebowbeer"},"authorAssociation":"CONTRIBUTOR","body":"I realized I'm conflating two different issues:\r\n* Support for single-file workflows, e.g., `workflows.js` <= THIS ISSUE\r\n* Support defaulting `workflowsPath` to single-file `workflows.js` <= #267 \r\n\r\nA fix for THIS issue won't necessarily fix the workflowsPath default issue, but is probably a prerequisite.\r\n\r\n@lorensr in the webpack error (_is not a directory_) reported above, note the `in '/src'` in the error message. I think this means that `require` is being called with path: '/src'\r\n\r\nDRAFT PR to support workflows.js as workflowsPath default: https://github.com/temporalio/sdk-node/pull/267","createdAt":"2021-09-25T22:55:44Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/258#issuecomment-927195117","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843SbUE","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"@joebowbeer commented on your draft PR with directions on how to properly support the different cases.","createdAt":"2021-09-27T06:42:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/258#issuecomment-927577348","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843UBP9","author":{"login":"joebowbeer"},"authorAssociation":"CONTRIBUTOR","body":"@bergundy more questions for you in #267 \r\n\r\nAs I wrote there,\r\n\r\n> I think the first step is to get the single-file loading working (#258) in isolate-builder, and then adjust the default workflowsPath in worker if needed to support custom loaders (incl. working around deficiencies in the loaders).","createdAt":"2021-09-27T15:39:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/258#issuecomment-927994877","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843b1qO","author":{"login":"joebowbeer"},"authorAssociation":"CONTRIBUTOR","body":"I'm moving this discussion here from #267 - I think #267 is too simplistic, and this issue needs to be fixed first.\r\n\r\nNote that the list of extensions is dependent on the loader, e.g., ts-loader or babel-loader, either of which might be used with TypeScript.\r\n\r\nThe webpack module resolver (see below) or any custom loader should both be able to work with an absolute or relative path that resolves to a folder or file, e.g. \"../workflows\".\r\n\r\nIf it resolves to a folder, `package.json` may select the file that is loaded. When specified as a filename, it typically does not include an extension, and when it does the custom loader may replace it. See resolve.extensions.\r\n\r\nhttps://webpack.js.org/concepts/module-resolution/#module-paths","createdAt":"2021-09-29T10:19:23Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/258#issuecomment-930044558","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843cshg","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"@joebowbeer I looked into it a bit.\r\nIt seems like webpack works with no extension if I comment out this line:\r\nhttps://github.com/temporalio/sdk-node/blob/9531fe25a7d3263285e8c6f98689db6d060cd59d/packages/worker/src/isolate-builder.ts#L111\r\n\r\nSo all that's left is to support workflow interceptor imports, I'll think about it some more.","createdAt":"2021-09-29T15:10:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/258#issuecomment-930269280","viewerDidAuthor":false},{"id":"IC_kwDOEujx1843oj9T","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Looks like the best way to solve this is to make interceptor module locations flexible too:\r\n\r\n```ts\r\nawait Worker.create({\r\n  workflowsPath: require.resolve('./workflows'),\r\n  interceptorModules: [require.resolve('./workflows/interceptors')],\r\n});\r\n```","createdAt":"2021-10-04T11:10:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/258#issuecomment-933379923","viewerDidAuthor":false}],"createdAt":"2021-09-21T18:54:57Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":{"number":2,"title":"beta","description":"","dueOn":null},"number":258,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"[Feature Request] Support single-file workflowsPath","updatedAt":"2021-10-07T14:31:54Z","url":"https://github.com/temporalio/sdk-typescript/issues/258"}
