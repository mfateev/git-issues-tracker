{"assignees":[{"id":"MDQ6VXNlcjI1MTI4OA==","login":"lorensr","name":"Loren ☺️","databaseId":0}],"author":{"id":"MDQ6VXNlcjE0OTgyMjc=","is_bot":false,"login":"albertyfwu","name":"Albert"},"body":"### What are you really trying to do?\r\n\r\nI'm trying to write workflow tests as described at https://docs.temporal.io/typescript/testing/#testing-workflows\r\n\r\n### Describe the bug\r\n\r\nI actually ran into a similar issue while writing temporal tests:\r\n\r\nThe script in my package.json looks like this:\r\n```\r\n\"scripts\": {\r\n    \"test\": \"NODE_ENV=test jest\"\r\n  },\r\n```\r\nI am running `yarn workspace <workspace> test`.\r\nAt first, I get this error: `You need to run with a version of node that supports ES Modules in the VM API. See https://jestjs.io/docs/ecmascript-modules`\r\n\r\n\r\nThen, if I run `NODE_OPTIONS=--experimental-vm-modules yarn workspace <workspace> test` I get this error:\r\n```\r\nCannot find module 'pnpapi' from '/Users/albertwu/workspace/project/.yarn/cache/enhanced-resolve-npm-5.10.0-7941304306-0bb9830704.zip/node_modules/enhanced-resolve/lib'\r\n\r\n    Require stack:\r\n      /Users/albertwu/workspace/project/.yarn/cache/enhanced-resolve-npm-5.10.0-7941304306-0bb9830704.zip/node_modules/enhanced-resolve/lib/index.js\r\n      /Users/albertwu/workspace/project/.yarn/__virtual__/webpack-virtual-4d546bab61/0/cache/webpack-npm-5.73.0-fc8c985a74-aa434a241b.zip/node_modules/webpack/lib/CacheFacade.js\r\n      /Users/albertwu/workspace/project/.yarn/__virtual__/webpack-virtual-4d546bab61/0/cache/webpack-npm-5.73.0-fc8c985a74-aa434a241b.zip/node_modules/webpack/lib/Compiler.js\r\n      /Users/albertwu/workspace/project/.yarn/__virtual__/webpack-virtual-4d546bab61/0/cache/webpack-npm-5.73.0-fc8c985a74-aa434a241b.zip/node_modules/webpack/lib/webpack.js\r\n      /Users/albertwu/workspace/project/.yarn/__virtual__/webpack-virtual-4d546bab61/0/cache/webpack-npm-5.73.0-fc8c985a74-aa434a241b.zip/node_modules/webpack/lib/index.js\r\n      /Users/albertwu/workspace/project/.yarn/cache/@temporalio-worker-npm-1.0.0-rc.1-2998f0d7a7-147819cf17.zip/node_modules/@temporalio/worker/lib/workflow/bundler.js\r\n      /Users/albertwu/workspace/project/.yarn/cache/@temporalio-worker-npm-1.0.0-rc.1-2998f0d7a7-147819cf17.zip/node_modules/@temporalio/worker/lib/worker.js\r\n      /Users/albertwu/workspace/project/.yarn/cache/@temporalio-worker-npm-1.0.0-rc.1-2998f0d7a7-147819cf17.zip/node_modules/@temporalio/worker/lib/index.js\r\n      /Users/albertwu/workspace/project/.yarn/unplugged/@temporalio-testing-npm-1.0.0-rc.1-8641517f72/node_modules/@temporalio/testing/lib/index.js\r\n```\r\n\r\n### Minimal Reproduction\r\n\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: [e.g. M1 Mac, x86 Windows, Linux]\r\n- Temporal Version: [e.g. 1.14.0?] and/or SDK version\r\n- Are you using Docker or Kubernetes or building Temporal from source?\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n","closedAt":"2023-03-09T00:21:50Z","comments":[{"id":"IC_kwDOEujx185GjvXL","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Thanks for reporting.\r\nI don't know much about yarn pnp, we'd have to look into this.","createdAt":"2022-07-13T23:19:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/755#issuecomment-1183774155","viewerDidAuthor":false},{"id":"IC_kwDOEujx185GjyeH","author":{"login":"albertyfwu"},"authorAssociation":"NONE","body":"maybe related to this? https://github.com/webpack/enhanced-resolve/pull/349","createdAt":"2022-07-13T23:41:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/755#issuecomment-1183786887","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Gj13B","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Might be, jest is a pretty complicated JS runtime.\r\n\r\nCan you verify that this doesn't happen when using a simpler test runner?","createdAt":"2022-07-14T00:10:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/755#issuecomment-1183800769","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Gj7Wn","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"> maybe related to this? https://github.com/webpack/enhanced-resolve/pull/349\r\n\r\nSeems like it, in which case it'd be fixed when this is merged: https://github.com/webpack/enhanced-resolve/pull/301\r\n\r\nIn the meantime, some workarounds are using mocha or not using pnp. Here's a mocha sample: https://github.com/temporalio/samples-typescript/blob/bd2e6d73dcc5de5ff41215a74745ab363ee7e52a/activities-examples/package.json#L11","createdAt":"2022-07-14T00:45:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/755#issuecomment-1183823271","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Gj9CF","author":{"login":"albertyfwu"},"authorAssociation":"NONE","body":"Thanks.\r\n\r\nCan't I also just write unit tests directly by mocking activities? Is the main benefit of the test runner the ability to do time skipping?","createdAt":"2022-07-14T00:53:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/755#issuecomment-1183830149","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Gj_mF","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I think you mean the test framework `@temporalio/testing` the main benefit of it is auto time skipping, yes.\r\nWe've also wrapped up starting the server and all of the utilities in the test environment which provides pure convenience.\r\nThe issue you're experiencing isn't related to that though.","createdAt":"2022-07-14T01:12:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/755#issuecomment-1183840645","viewerDidAuthor":false},{"id":"IC_kwDOEujx185GkCqE","author":{"login":"albertyfwu"},"authorAssociation":"NONE","body":"If I didn't use `@temporalio/testing` and just directly executed the workflow function (without going through worker), wouldn't that bypass the webpack issues?","createdAt":"2022-07-14T01:23:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/755#issuecomment-1183853188","viewerDidAuthor":false},{"id":"IC_kwDOEujx185GkEGL","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"This isn't currently possible, workflows can only be run in the isolated runtime at the moment since they rely on global state.\r\nI have some plans to loosen the runtime requirement eventually for unit testing purposes but so far it hasn't been high priority for us and you're the first one to request this \"feature\".","createdAt":"2022-07-14T01:37:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/755#issuecomment-1183859083","viewerDidAuthor":false},{"id":"IC_kwDOEujx185GzkTo","author":{"login":"esuh-descript"},"authorAssociation":"NONE","body":"We are running into this issue (the original error about ESM modules) without `yarn pnp` also (using just `yarn` and `jest`). The only fixes we've found are to apply the patches:\r\n\r\n```diff\r\ndiff --git a/node_modules/@temporalio/testing/lib/index.js b/node_modules/@temporalio/testing/lib/index.js\r\nindex 863bf4f..24b4831 100644\r\n--- a/node_modules/@temporalio/testing/lib/index.js\r\n+++ b/node_modules/@temporalio/testing/lib/index.js\r\n@@ -96,7 +96,7 @@ function addDefaults({ testServer, logger, }) {\r\n }\r\n // TS transforms `import` statements into `require`s, this is a workaround until\r\n // tsconfig module nodenext is stable.\r\n-const _importDynamic = new Function('modulePath', 'return import(modulePath)');\r\n+const _importDynamic = require;\r\n /**\r\n  * An execution environment for running Workflow integration tests.\r\n  *\r\n\r\ndiff --git a/node_modules/get-port/index.js b/node_modules/get-port/index.js\r\nindex 06e993a..07bab92 100644\r\n--- a/node_modules/get-port/index.js\r\n+++ b/node_modules/get-port/index.js\r\n@@ -1,5 +1,5 @@\r\n-import net from 'node:net';\r\n-import os from 'node:os';\r\n+const net = require('net');\r\n+const os = require('os');\r\n \r\n class Locked extends Error {\r\n \tconstructor(port) {\r\n@@ -79,7 +79,7 @@ const portCheckSequence = function * (ports) {\r\n \tyield 0; // Fall back to 0 if anything else failed\r\n };\r\n \r\n-export default async function getPorts(options) {\r\n+module.exports.default = async function getPorts(options) {\r\n \tlet ports;\r\n \tlet exclude = new Set();\r\n \r\n@@ -151,7 +151,7 @@ export default async function getPorts(options) {\r\n \tthrow new Error('No available ports found');\r\n }\r\n \r\n-export function portNumbers(from, to) {\r\n+module.exports.portNumbers = function portNumbers(from, to) {\r\n \tif (!Number.isInteger(from) || !Number.isInteger(to)) {\r\n \t\tthrow new TypeError('`from` and `to` must be integer numbers');\r\n \t}\r\n```\r\n\r\nFor now, we are unblocked by using `patch-package` to fix the issue, but it would be great to not have to patch the code ourselves. Perhaps given the small amount of code in `get-port`, it might be worthwhile to vendor and patch the upstream code in the `@temporalio/testing` package itself?","createdAt":"2022-07-18T17:47:35Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/755#issuecomment-1187923176","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Gzwc6","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"@esuh-descript Did you try `NODE_OPTIONS=--experimental-vm-modules yarn test`? \r\n\r\nOther notes on using Jest are:\r\n\r\n- Needs to be `>= 27.0.0`\r\n- Use [`testEnvironment: 'node'`](https://jestjs.io/docs/configuration#testenvironment-string). `testEnvironment: 'jsdom'` is not supported.","createdAt":"2022-07-18T18:01:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/755#issuecomment-1187972922","viewerDidAuthor":false},{"id":"IC_kwDOEujx185G08s1","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I'm considering vendoring [`get-port`](https://www.npmjs.com/package/get-port) and porting to commonjs, unfortunately that package moved from commonjs to ESM which breaks a bunch of dependencies.","createdAt":"2022-07-18T20:38:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/755#issuecomment-1188285237","viewerDidAuthor":false},{"id":"IC_kwDOEujx185XFjYt","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Closing, we don't depend on `get-port` anymore.","createdAt":"2023-03-09T00:21:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/755#issuecomment-1461073453","viewerDidAuthor":false}],"createdAt":"2022-07-13T23:15:01Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":755,"reactionGroups":[],"state":"CLOSED","title":"[Bug] with yarn pnp, there are issues running workflow tests","updatedAt":"2023-03-09T00:21:50Z","url":"https://github.com/temporalio/sdk-typescript/issues/755"}
