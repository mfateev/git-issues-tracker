{"assignees":[],"author":{"id":"MDQ6VXNlcjI1MTI4OA==","is_bot":false,"login":"lorensr","name":"Loren ☺️"},"body":"### Problem\r\n\r\n<!-- A clear and concise description of what the problem is. Ex. I'm always frustrated when [...] -->\r\n\r\nprotobufjs's `.toJSON` doesn't do [proto3-spec-compliant](https://developers.google.com/protocol-buffers/docs/proto3#json) JSON encoding, which means that if we used it, it would either error or be incompatible with the other SDKs, which use Google's libraries, which are spec-compliant. \r\n\r\nTo work around this, we do this:\r\n\r\nhttps://github.com/lorensr/sdk-node/blob/custom-data-converter/docs/protobuf-libraries.md#current-solution\r\n\r\nwhich is awkward / more setup and code than is ideal.\r\n\r\n### Solution\r\n\r\n<!-- A clear and concise description of what you want to happen. SCREENSHOTS OR CODE SAMPLES ARE VERY HELPFUL -->\r\n\r\nMake it easier to use protobufs by changing protobufjs, either by fixing their `toJSON` implementation or adding a `toProto3JSON` method. For the status of that, follow:\r\n\r\nhttps://github.com/protobufjs/protobuf.js/issues/1304\r\n","closedAt":"2023-05-11T17:28:48Z","comments":[{"id":"IC_kwDOEujx184-B9Pz","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I think the most challenging-yet-needed thing is making it work from the outside on external protobufjs-generated protos too, not just Temporal ones. Bonus points if this can be a standalone library for anyone using protobufjs (granted it'll be more maintenance and quite the test suite).\r\n\r\nI can think of ways to do this. Most are probably similar to the linked issue where a custom `toObject` is used that understands well known types.\r\n\r\nI could also understand punting proto JSON support until the ecosystem gets it together.","createdAt":"2022-02-15T19:28:03Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/481#issuecomment-1040700403","viewerDidAuthor":false},{"id":"IC_kwDOEujx184-B_uT","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"> making it work from the outside on external protobufjs-generated protos too\r\n\r\nThere are different ways that protobufjs generates protos. [proto3-json-serializer](https://www.npmjs.com/package/proto3-json-serializer) (and therefore temporal) supports one of the ways. In order to support the other ways, the protobufjs generator would need to be changed to at least include types in generated `static` classes.","createdAt":"2022-02-15T19:39:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/481#issuecomment-1040710547","viewerDidAuthor":false},{"id":"IC_kwDOEujx184-CIj7","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"This doesn't look like an issue for our repo, instead it's an issue with `protobuf.js`.\r\nThe workaround that we have now using `proto3-json-serializer` is fine, our users shouldn't care about proto JSON serialization at all, that's handled by the converter.","createdAt":"2022-02-15T20:13:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/481#issuecomment-1040746747","viewerDidAuthor":false},{"id":"IC_kwDOEujx184-CLIA","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> our users shouldn't care about proto JSON serialization at all, that's handled by the converter.\r\n\r\nFrom the doc linked in the description, it looks like they do have to care because they have to create protos a certain way (e.g. for returning) and maybe an extra protoc generator or something similar? I'm ok w/ whatever's easiest on users of course. I guess without a type registry and descriptor available there is little choice but making the user care.","createdAt":"2022-02-15T20:25:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/481#issuecomment-1040757248","viewerDidAuthor":false},{"id":"IC_kwDOEujx184-CUjE","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"> This doesn't look like an issue for our repo\r\n\r\nI like to keep issues open just for tracking external issues. But also, this issue is more broad—eg could include discussion of whether to support `static` generated messages for just `binary/protobuf`.","createdAt":"2022-02-15T21:10:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/481#issuecomment-1040795844","viewerDidAuthor":false},{"id":"IC_kwDOEujx184-CbMw","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"> From the doc linked in the description, it looks like they do have to care because they have to create protos a certain way (e.g. for returning) and maybe an extra protoc generator or something similar? I'm ok w/ whatever's easiest on users of course. I guess without a type registry and descriptor available there is little choice but making the user care.\r\n\r\n@lorensr surveyed the alternative protobuf implementations and the solution we came up with is the only one that covers all of the cases.\r\nSo yes, the users care to some degree but it doesn't matter if the proto class has a `toJSON` method or we use an external library for JSON support.\r\n\r\n> I like to keep issues open just for tracking external issues. But also, this issue is more broad—eg could include discussion of whether to support static generated messages for just binary/protobuf.\r\n\r\nSo I'd change the description of this issue to reflect that this is its purpose, and possibly close / tag it as (nothing to do now / external issue).","createdAt":"2022-02-15T21:42:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/481#issuecomment-1040823088","viewerDidAuthor":false},{"id":"IC_kwDOEujx185cDbcf","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"No need to track as an open issue, it's cluttering up the repo's issues.","createdAt":"2023-05-11T17:28:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/481#issuecomment-1544402719","viewerDidAuthor":false}],"createdAt":"2022-02-15T18:55:52Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":481,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"Tracking: spec-compliant JSON in protobuf.js","updatedAt":"2023-05-11T17:28:48Z","url":"https://github.com/temporalio/sdk-typescript/issues/481"}
