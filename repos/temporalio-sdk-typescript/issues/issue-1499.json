{"assignees":[],"author":{"id":"U_kgDOCPvRXw","is_bot":false,"login":"dp-dandy","name":"David Parsons"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\n#### Context\r\nOur team recently encountered a significant issue when attempting to start a large number of activities (~600) asynchronously within a single Temporal workflow. The SDK grouped the activity scheduling requests together, leading to a gRPC error (`ResourceExhausted`) because the total message size (15MB) exceeded the gRPC-imposed limit of 4MB.\r\n\r\nThis issue causes the workflow to freeze, as the SDK retries the `RespondWorkflowTaskCompleted` API call, which continues to fail due to the message size. Currently, the SDK does not provide any built-in mechanism to automatically handle this limitation, nor does it throw a runtime error that could help developers detect and manage the issue proactively.\r\n\r\n#### Underlying Issue\r\n- The Temporal SDK batches multiple activity scheduling commands into a single gRPC request.\r\n- When the cumulative size of these commands exceeds 4MB, gRPC rejects the request with a `ResourceExhausted` error.\r\n- The SDK does not provide an intuitive way to manage this situation, leading to potential workflow freezes and silent failures.\r\n\r\n### Describe the solution you'd like\r\n\r\n#### Feature Request\r\nTo improve the developer experience and robustness of the Temporal SDK, we request the following enhancements:\r\n\r\n1. **Automatic Request Splitting**:\r\n   - Implement a mechanism in the SDK to detect when the cumulative size of a gRPC request is approaching the 4MB limit.\r\n   - Automatically split the activity scheduling commands into smaller batches that stay within the size limit, sending them in multiple gRPC requests if necessary.\r\n\r\n2. **Runtime Error for Exceeding Limits**:\r\n   - If automatic splitting is not feasible, the SDK should throw a descriptive runtime error when a request exceeds the gRPC message size limit.\r\n   - This error should include suggestions or documentation references on how to adjust the code to stay within the limit, such as reducing the number of activities started simultaneously or compressing payloads.\r\n\r\n3. **Improved Logging and Monitoring**:\r\n   - Enhance the logging around gRPC message size limits to make it easier for developers to diagnose issues related to request size.\r\n\r\n### Additional Considerations\r\n- **Custom Data Converters**: Although developers can use custom data converters to compress payloads, this should be a secondary approach. The SDK should still provide safeguards against exceeding gRPC limits.\r\n- **Documentation**: Update the SDK documentation to clearly explain the gRPC size limitation, how it interacts with Temporal workflows, and best practices for avoiding issues.\r\n\r\n### Impact\r\nImplementing these changes would significantly reduce the likelihood of silent workflow failures and improve the overall resilience of systems built using the Temporal SDK. Developers would have better tools to manage gRPC limitations, leading to more reliable and maintainable code.\r\n\r\n---\r\nA rough incomplete solution that we are piloting is something like:\r\n```typescript\r\nimport type { ActivityFunction } from '@temporalio/common';\r\nimport { DefaultPayloadConverter } from '@temporalio/common';\r\n\r\nconst MAX_BATCH_PAYLOAD_SIZE = 3 * 1024 * 1024; // 3MB, leaving a buffer for any unknown overhead associated with the activities\r\n\r\nconst defaultPayloadConverter: DefaultPayloadConverter = new DefaultPayloadConverter();\r\n\r\nfunction getPayloadSize<PayloadType extends Parameters<ActivityFunction>>(args: PayloadType): number {\r\n    const payload = defaultPayloadConverter.toPayload(args);\r\n    if (payload.data instanceof Uint8Array) {\r\n        return payload.data.length;\r\n    }\r\n    return 0;\r\n}\r\n\r\nfunction groupIntoMaxSizePayloads<PayloadType extends Parameters<ActivityFunction>>(\r\n    activityArgs: PayloadType[],\r\n    maxSize: number = MAX_BATCH_PAYLOAD_SIZE,\r\n): PayloadType[][] {\r\n    const payloadGroups: PayloadType[][] = [];\r\n\r\n    let currentGroup: PayloadType[] = [];\r\n    let currentGroupSize = 0;\r\n    for (const args of activityArgs) {\r\n        const argsSize = getPayloadSize(args);\r\n        if (argsSize > maxSize) {\r\n            // throw some error about the request size being too big\r\n        }\r\n        // If the current group size plus the size of the next args is greater than the max size,\r\n        // push the current group and start a new one\r\n        if (currentGroupSize + argsSize > maxSize) {\r\n            payloadGroups.push(currentGroup);\r\n            currentGroup = [];\r\n            currentGroupSize = 0;\r\n        }\r\n        currentGroup.push(args);\r\n        currentGroupSize += argsSize;\r\n    }\r\n    // Push the last group if it's not empty\r\n    if (currentGroup.length > 0) {\r\n        payloadGroups.push(currentGroup);\r\n    }\r\n    return payloadGroups;\r\n}\r\n\r\nexport async function safeStartActivities<Activity extends ActivityFunction, Arguments>(\r\n    activity: Activity,\r\n    args: Arguments[],\r\n): Promise<PromiseSettledResult<Awaited<ReturnType<Activity>>>[]> {\r\n    const maxRequestSizeBatches: Parameters<Activity>[][] = groupIntoMaxSizePayloads(\r\n        args.map((arg: Arguments) => arg as Parameters<Activity>),\r\n    );\r\n    const results: PromiseSettledResult<Awaited<ReturnType<Activity>>>[] = [];\r\n    for (const maxRequestSizeBatch of maxRequestSizeBatches) {\r\n        const promises: Promise<ReturnType<Activity>>[] = maxRequestSizeBatch.map((args: Parameters<Activity>) =>\r\n            activity(args),\r\n        );\r\n        const awaited = await Promise.allSettled(promises);\r\n        results.push(...awaited);\r\n    }\r\n    return results;\r\n}\r\n\r\n```\r\n\r\n### Additional context\r\nCloud Support Thread: https://temporalio.slack.com/archives/C046BRWDV2R/p1723743294696369\r\n\r\n<!-- Add any other context or screenshots about the feature request here. -->\r\n","closedAt":null,"comments":[],"createdAt":"2024-08-16T20:06:29Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1499,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":7}}],"state":"OPEN","title":"[Feature Request] Native Request Batching to Prevent \"received message larger than max\" Errors","updatedAt":"2024-08-21T14:07:58Z","url":"https://github.com/temporalio/sdk-typescript/issues/1499"}
