{"assignees":[],"author":{"id":"MDQ6VXNlcjY0OTg5NDI4","is_bot":false,"login":"nohehf","name":""},"body":"### What are you really trying to do?\r\n\r\nUsing a custom payload converter in a temporal typescript worker.\r\n\r\n### Describe the bug\r\n\r\nAfter implementing and loading a custom payload converter in a typescript worker, it is being used as expected to start my workflow (I get logs and I can confirm it's working as expected). Still, when the activity resolves I get a `Failed to activate workflow` error.\r\nThe error being:\r\n```\r\n2023-11-14T12:50:06.988Z [ERROR] Failed to activate workflow {\r\n  namespace: 'default',\r\n  taskQueue: 'my-task-queue',\r\n  workflowId: 'worflowId',\r\n  runId: '8c924e14-1c20-4c38-a490-50e4f1c6ac6d',\r\n  workflowType: 'MyWorkflowType',\r\n  error: **************/workflow-bundle-66b7a6885e00fd3df11b.js:438\r\n              throw new errors_1.ValueError(`Unknown encoding: ${encoding}`);\r\n              ^\r\n\r\n  ValueError: Unknown encoding: custom/encoding\r\n      at DefaultPayloadConverter.fromPayload (*******/node_modules/@temporalio/common/src/converter/payload-converter.ts:163:12)\r\n      at Activator.resolveActivity (*******/node_modules/@temporalio/workflow/src/internals.ts:411:62)\r\n      at *******/node_modules/@temporalio/workflow/src/worker-interface.ts:215:29\r\n      at Object.activate (*******/node_modules/@temporalio/workflow/src/worker-interface.ts:221:2)\r\n      at evalmachine.<anonymous>:1:18\r\n      at Script.runInContext (node:vm:134:12)\r\n      at Object.runInContext (node:vm:282:6)\r\n      at Proxy.<anonymous> (*******/node_modules/@temporalio/worker/lib/workflow/vm.js:40:46)\r\n      at VMWorkflow.activate (*******/node_modules/@temporalio/worker/lib/workflow/vm-shared.js:313:33)\r\n      at handleRequest (*******/node_modules/@temporalio/worker/lib/workflow/workflow-worker-thread.js:50:47),\r\n  workflowExists: true\r\n}\r\n```\r\n\r\nAfter digging into the `sdk-typescript` code to check what would cause this error I noticed that in https://github.com/temporalio/sdk-typescript/blob/3088f86ce6fe0c7072ba55c4db901a70b631f87e/packages/workflow/src/internals.ts#L263 the payload converter being used is always the default one. Whereas in other files, the custom payload converter is being used if passed, eg: https://github.com/temporalio/sdk-typescript/blob/3088f86ce6fe0c7072ba55c4db901a70b631f87e/packages/workflow/src/worker-interface.ts#L110\r\n\r\nI guess the payloadConverter should be passed here: https://github.com/temporalio/sdk-typescript/blob/3088f86ce6fe0c7072ba55c4db901a70b631f87e/packages/workflow/src/worker-interface.ts#L96\r\n\r\nIf I'm mistaken could you clarify why the defaultPayloadConverter has to be used here? Also, I must say that It has been it hard and painful to work with custom payload converters.\r\n\r\n### Environment/Versions\r\n\r\nMachine:\r\n```\r\nOS: macOS 13.4.1 22F82 arm64\r\nHost: MacBookPro18,3\r\nKernel: 22.5.0\r\nCPU: Apple M1 Pro\r\nGPU: Apple M1 Pro\r\n```\r\n\r\n- Temporal Version: `@temporalio/worker@npm:1.8.4 (via npm:^1.8.2)`\r\n- Are you using Docker or Kubernetes or building Temporal from source: Docker for local development\r\n\r\n### Additional context\r\n\r\nI might try to open a PR for a fix if you confirm that this is indeed a bug :))\r\n\r\n### Edit 1\r\nIt seems I was mistaken, and the payload converter is indeed passed to the activator here: https://github.com/temporalio/sdk-typescript/blob/3088f86ce6fe0c7072ba55c4db901a70b631f87e/packages/workflow/src/worker-interface.ts#L113\r\n\r\nI managed to make it work by passing a TS file directly to `payloadConverterPath`. The issue might happen when the payload converter is bundled / from what it is bundled. Any advice on how to bundle it and pass it to the worker? I've had a lot of issues with this (not able to load an ESM payload converter, so I have to bundle it to esm).\r\n\r\nI still wonder how the custom converter could work for the `toPayload` but not `fromPayload`. I will try to provide a minimum reproduction.\r\n","closedAt":"2023-11-14T20:30:16Z","comments":[{"id":"IC_kwDOEujx185r7wc2","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"The custom payload converter is passed to the activator and should be loaded properly if you pass the `payloadConveterPath` worker option.\r\n\r\nI think we may have an issue with custom converters and ESM. I'll open an issue to track that separately.","createdAt":"2023-11-14T17:54:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1291#issuecomment-1810827062","viewerDidAuthor":false},{"id":"IC_kwDOEujx185r7yBn","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"https://github.com/temporalio/sdk-typescript/issues/1292","createdAt":"2023-11-14T17:58:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1291#issuecomment-1810833511","viewerDidAuthor":false},{"id":"IC_kwDOEujx185r9MAE","author":{"login":"nohehf"},"authorAssociation":"NONE","body":"I think it is indeed an issue with how I transformed my ESM ts into a commonjs bundle, but it is weird that it works to create the payload and start the activity, but not when the activity completes. I added some of my research to #1292. I'll close this issue and I hope that we will be able to fix this or provide guidelines to bundle payload converters (both would be the best actually). Ty!","createdAt":"2023-11-14T20:30:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1291#issuecomment-1811202052","viewerDidAuthor":false}],"createdAt":"2023-11-14T13:11:27Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1291,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"[Bug] Custom payload converter not being passed to \"Activator\"","updatedAt":"2023-11-14T20:30:16Z","url":"https://github.com/temporalio/sdk-typescript/issues/1291"}
