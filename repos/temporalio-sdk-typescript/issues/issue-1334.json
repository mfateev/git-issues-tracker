{"assignees":[],"author":{"id":"MDQ6VXNlcjE0ODMzNDQw","is_bot":false,"login":"Code2Life","name":"Joey Yang"},"body":"### Bun worker can not work Issue\r\n\r\nI tried to use bun as temporal worker, when running temporal client it looked perfect, the workflow created with HTTP2+gRPC, which just supported in bun.js last month.\r\n\r\nBut when I ran temporal worker it can not work, even bun.sh had implement v8 compatible vm context sandbox. Firstly I found this issue:\r\n![image](https://github.com/temporalio/sdk-typescript/assets/14833440/9bae6fe2-28bc-4587-beb5-196f5dfdaabb)\r\n\r\nThen, i tried to comment out the createHook code block, this error disappeared, but the core-bridge was broken\r\n\r\n```\r\n2024-01-10T08:41:16.131Z [INFO] webpack 5.89.0 compiled successfully in 486 ms\r\n2024-01-10T08:41:16.132Z [INFO] Workflow bundle created { size: '0.74MB' }\r\n2024-01-10T08:41:16.284520Z  INFO temporal_sdk_core::worker: Initializing worker task_queue=hello-world namespace=default\r\nthread '<unnamed>' panicked at 'Hash table capacity overflow', /Users/runner/.cargo/registry/src/index.crates.io-6f17d22bba15001f/hashbrown-0.13.2/src/raw/mod.rs:90:40\r\nnote: run with `RUST_BACKTRACE=1` environment variable to display a backtrace\r\n2024-01-10T08:41:16.286Z [INFO] Worker state changed { state: 'RUNNING' }\r\n2024-01-10T08:41:16.290075Z  INFO next_workflow_activation: temporal_sdk_core::worker: Initiated shutdown task_queue=hello-world namespace=default task_queue=hello-world\r\n2024-01-10T08:41:16.291Z [INFO] Worker state changed { state: 'DRAINED' }\r\n2024-01-10T08:41:16.291Z [INFO] Worker state changed { state: 'STOPPED' }\r\nthread 'core' panicked at 'Workflow processing terminates cleanly: Error joining workflow processing thread: Ok(\"Hash table capacity overflow\")', sdk-core/core/src/worker/mod.rs:409:14\r\n 96 |         }\r\n 97 |         this.shutDownRequested = true;\r\n 98 |         await this.send({ type: 'destroy' });\r\n 99 |         const exitCode = await this.workerThread.terminate();\r\n100 |         if (exitCode !== exports.TERMINATED_EXIT_CODE) {\r\n101 |             throw new core_bridge_1.UnexpectedError(`Failed to terminate Worker thread, exit code: ${exitCode}`);\r\n                                      ^\r\n```\r\n\r\n### Additional context\r\n\r\nBoth Temporal and bun are really amazing. Since bun provide many out-of-box features and better performance than node.js, It would be great if temporal sdk can support bun worker. \r\n","closedAt":null,"comments":[{"id":"IC_kwDOEujx185wg2RB","author":{"login":"izakfilmalter"},"authorAssociation":"NONE","body":"Would love to use bun instead!!!!","createdAt":"2024-01-11T17:40:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":8}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-1887659073","viewerDidAuthor":false},{"id":"IC_kwDOEujx185wpHdX","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"We know what we need to do to get the SDK working on bun but it'll be a significant lift and may not be prioritized just yet.","createdAt":"2024-01-12T19:19:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-1889826647","viewerDidAuthor":false},{"id":"IC_kwDOEujx185wpHk_","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I too hope we will support more JS runtimes including bun and deno.","createdAt":"2024-01-12T19:19:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":3}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-1889827135","viewerDidAuthor":false},{"id":"IC_kwDOEujx185yApAA","author":{"login":"brettgoulder"},"authorAssociation":"NONE","body":"nodejs recommends [against using createHook](https://nodejs.org/api/async_hooks.html#async-hooks):\r\n\r\n[Stability: 1](https://nodejs.org/api/documentation.html#stability-index) - Experimental. Please migrate away from this API, if you can. We do not recommend using the [createHook](https://nodejs.org/api/async_hooks.html#async_hookscreatehookcallbacks), [AsyncHook](https://nodejs.org/api/async_hooks.html#class-asynchook), and [executionAsyncResource](https://nodejs.org/api/async_hooks.html#async_hooksexecutionasyncresource) APIs as they have usability issues, safety risks, and performance implications. Async context tracking use cases are better served by the stable [AsyncLocalStorage](https://nodejs.org/api/async_context.html#class-asynclocalstorage) API. If you have a use case for createHook, AsyncHook, or executionAsyncResource beyond the context tracking need solved by [AsyncLocalStorage](https://nodejs.org/api/async_context.html#class-asynclocalstorage) or diagnostics data currently provided by [Diagnostics Channel](https://nodejs.org/api/diagnostics_channel.html), please open an issue at https://github.com/nodejs/node/issues describing your use case so we can create a more purpose-focused API.","createdAt":"2024-01-26T22:19:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-1912770560","viewerDidAuthor":false},{"id":"IC_kwDOEujx185yjvfp","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"The SDK uses v8 promise hooks `createHook`, not async hooks.\r\nWe need this functionality for showing workflow stack traces.","createdAt":"2024-02-01T18:36:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-1921972201","viewerDidAuthor":false},{"id":"IC_kwDOEujx18545-0W","author":{"login":"loicnestler"},"authorAssociation":"NONE","body":"Any updates on this? ðŸ‘€ ","createdAt":"2024-03-30T20:47:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2028465430","viewerDidAuthor":false},{"id":"IC_kwDOEujx1855O4rk","author":{"login":"maurovanetti"},"authorAssociation":"NONE","body":"In case someone wondered: No, Bun 1.1.0 (out since Monday) does not support Temporal yet. :disappointed: \r\n\r\n```\r\nerror: node:v8 createHook is not yet implemented in Bun.\r\n      at new NotImplementedError (internal:shared:20:28)\r\n      at internal:shared:3:70\r\n      at node:v8:3:46\r\n      at node:v8:77:30\r\n      at setPromiseHook (/home/mauro/Codice/in4matic/bun/temporal/node_modules/@temporalio/worker/lib/workflow/vm-shared.js:208:33)\r\n      at install (/home/mauro/Codice/in4matic/bun/temporal/node_modules/@temporalio/worker/lib/workflow/vm-shared.js:140:13)\r\n      at /home/mauro/Codice/in4matic/bun/temporal/node_modules/@temporalio/worker/lib/workflow/reusable-vm.js:139:8\r\n      at create (/home/mauro/Codice/in4matic/bun/temporal/node_modules/@temporalio/worker/lib/workflow/reusable-vm.js:138:21)\r\n      at /home/mauro/Codice/in4matic/bun/temporal/node_modules/@temporalio/worker/lib/workflow/workflow-worker-thread.js:10:36\r\n      at handleRequest (/home/mauro/Codice/in4matic/bun/temporal/node_modules/@temporalio/worker/lib/workflow/workflow-worker-thread.js:6:35)\r\n```","createdAt":"2024-04-03T08:47:57Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2033945316","viewerDidAuthor":false},{"id":"IC_kwDOEujx186AnWMF","author":{"login":"hscj87"},"authorAssociation":"NONE","body":"> nodejs recommends [against using createHook](https://nodejs.org/api/async_hooks.html#async-hooks):\r\n> \r\n> [Stability: 1](https://nodejs.org/api/documentation.html#stability-index) - Experimental. Please migrate away from this API, if you can. We do not recommend using the [createHook](https://nodejs.org/api/async_hooks.html#async_hookscreatehookcallbacks), [AsyncHook](https://nodejs.org/api/async_hooks.html#class-asynchook), and [executionAsyncResource](https://nodejs.org/api/async_hooks.html#async_hooksexecutionasyncresource) APIs as they have usability issues, safety risks, and performance implications. Async context tracking use cases are better served by the stable [AsyncLocalStorage](https://nodejs.org/api/async_context.html#class-asynclocalstorage) API. If you have a use case for createHook, AsyncHook, or executionAsyncResource beyond the context tracking need solved by [AsyncLocalStorage](https://nodejs.org/api/async_context.html#class-asynclocalstorage) or diagnostics data currently provided by [Diagnostics Channel](https://nodejs.org/api/diagnostics_channel.html), please open an issue at https://github.com/nodejs/node/issues describing your use case so we can create a more purpose-focused API.\r\n\r\nHow to disable using createHook to avoid this error?","createdAt":"2024-06-10T09:13:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2157798149","viewerDidAuthor":false},{"id":"IC_kwDOEujx186B3Oyg","author":{"login":"andreyvital"},"authorAssociation":"NONE","body":"I have the same question as @hscj87 and the same request as the original issue text. Commenting just to bump up this thread.","createdAt":"2024-06-19T13:35:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2178739360","viewerDidAuthor":false},{"id":"IC_kwDOEujx186M_mhG","author":{"login":"axe-me"},"authorAssociation":"NONE","body":"it would be great to be able to run temporal worker with bun!","createdAt":"2024-09-22T05:55:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2365483078","viewerDidAuthor":false},{"id":"IC_kwDOEujx186OcwQk","author":{"login":"tenkoverse"},"authorAssociation":"NONE","body":"@bergundy Deno 2 has removed promiseHooks stubs (https://github.com/denoland/deno/issues/25977) to provide an environment where temporals check for promiseHooks is skipped https://github.com/temporalio/sdk-typescript/blob/faa64225a7f57154931a38c1fe612fc6520943b2/packages/worker/src/workflow/vm-shared.ts#L199-L202\r\n\r\nI now have temporal clients and workers successfully working in deno 2. \r\n\r\nI would love to know the implications for having an enviroment where there are no promise hooks. What do I lose using deno to run a temporal worker instead of using node (with version >=16.14)","createdAt":"2024-10-02T22:59:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":7}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2389902372","viewerDidAuthor":false},{"id":"IC_kwDOEujx186Ok3pe","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"We use promise hooks to capture stack traces that are used in the stack trace query feature that gives visibility into where your workflow is blocked at any given point.","createdAt":"2024-10-03T18:12:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":3}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2392029790","viewerDidAuthor":false},{"id":"IC_kwDOEujx186a9tA-","author":{"login":"zammitjames"},"authorAssociation":"NONE","body":"+1 - not supporting bun has forced us to look elsewhere.","createdAt":"2025-01-18T20:29:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2599866430","viewerDidAuthor":false},{"id":"IC_kwDOEujx186bmc8q","author":{"login":"maurovanetti"},"authorAssociation":"NONE","body":"**Bun 1.2** is out today. Finally, they declare support for `http2`!\n\nI'm trying to set up Temporal with Bun 1.2 and it seems to go further than before. I have connected a client to my Temporal server, and started a workflow. Unfortunately, the NativeConnection for the worker is hanging forever, though, with no error raised.\n\nHas anyone managed to go beyond this?","createdAt":"2025-01-23T17:43:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2610548522","viewerDidAuthor":false},{"id":"IC_kwDOEujx186b1lxJ","author":{"login":"cortopy"},"authorAssociation":"NONE","body":"Mine also hangs, although I get to see a very cryptic log entry `error: Error (via napi)`. I assume it's something to do with node api compat, but this just leaves me guessing","createdAt":"2025-01-26T17:29:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"CONFUSED","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2614516809","viewerDidAuthor":false},{"id":"IC_kwDOEujx186djh39","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"I think the `@temporalio/client` package works fine at this point, though I really have to point out that we do not perform regular testing for that runtime. Using this setup in production would not be advisable.\n\nRegarding Worker support, we certainly hope to get there, but we are not actively working in that direction just now. It is simply too early for that.\n\nFor example, the \"NativeConnection hanging forever\" and \"error: Error (via napi)\" symptoms mentioned above are due to a difference in [how bun checks the error argument on napi_throw](https://github.com/oven-sh/bun/blob/1fa42d81af0806cf06ca9dc050bf06046c3a4b41/src/bun.js/bindings/napi.cpp#L1644-L1659) vs [what's done in Node](https://github.com/nodejs/node/blob/5fad0b93667ffc6e4def52996b9529ac99b26319/src/js_native_api_v8.cc#L1924-L1934). That breaks the method that [Neon Binding](https://github.com/neon-bindings/neon/blob/7f4feb10631cfd3e654112d42a3b5ed472f851e8/crates/neon/src/sys/no_panic.rs#L135-L137) uses to check either it is safe to call back into the JS environment at that time.\n\nIt is not worth fixing that issue in upstream projects just yet. Bun's team is already doing some awesome bug hunting work on their NAPI implementation. See for example https://github.com/oven-sh/bun/pull/14501 and https://github.com/oven-sh/bun/pull/16230. I'd expect a few rounds like these, so let's give them time to complete their efforts first, and then for other key dependencies to stabilize.","createdAt":"2025-02-07T16:02:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":9}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2643336701","viewerDidAuthor":false},{"id":"IC_kwDOEujx186kAI-D","author":{"login":"harrytran998"},"authorAssociation":"NONE","body":"@mjameswh So do you have any progress here? The client can fire but the worker cannot exec now. Thanks","createdAt":"2025-03-25T14:41:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2751500163","viewerDidAuthor":false},{"id":"IC_kwDOEujx186mH6hx","author":{"login":"d2201"},"authorAssociation":"NONE","body":"bump, would love to jump over to Bun with projects, that's the last blocker though ðŸ™ˆ ","createdAt":"2025-04-08T16:53:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":5}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2787092593","viewerDidAuthor":false},{"id":"IC_kwDOEujx186o19jJ","author":{"login":"d2201"},"authorAssociation":"NONE","body":"^^^ big tnx to @x04. We're getting further with this.\n\nRunning bun on canary does enable the worker, however when a workflow is picked up the following error is thrown:\n```\n2025-04-26T23:03:11.807Z [ERROR] Failed to process Worklow Activation {\n  sdkComponent: 'worker',\n  taskQueue: 'hello-world',\n  runId: '01967457-2a90-7845-a719-e13197b85375',\n  namespace: 'default',\n  workflowId: 'test',\n  workflowType: 'testWorkflow',\n  error: TypeError: undefined is not an object (evaluating 'this.activator.getAndResetSinkCalls')\n      at getAndResetSinkCalls (/temporaltest/node_modules/@temporalio/worker/lib/workflow/vm-shared.js:262:21)\n      at getAndResetSinkCalls (/temporaltest/node_modules/@temporalio/worker/lib/workflow/vm-shared.js:261:34)\n      at handleRequest (/temporaltest/node_modules/@temporalio/worker/lib/workflow/workflow-worker-thread.js:61:42)\n      at handleRequest (/temporaltest/node_modules/@temporalio/worker/lib/workflow/workflow-worker-thread.js:23:32)\n      at <anonymous> (/temporaltest/node_modules/@temporalio/worker/lib/workflow/workflow-worker-thread.js:92:38)\n      at <anonymous> (/temporaltest/node_modules/@temporalio/worker/lib/workflow/workflow-worker-thread.js:90:33),\n  workflowExists: true\n}\n```","createdAt":"2025-04-26T23:08:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2832718025","viewerDidAuthor":false},{"id":"IC_kwDOEujx186o4e5I","author":{"login":"d2201"},"authorAssociation":"NONE","body":"Adding on top of the previous comment.\n\nI have set up a new project using the [core application docs](https://docs.temporal.io/develop/typescript/core-application#install-a-temporal-sdk)\n\nI used the following command:\n```sh\nnpx @temporalio/create@1.11.7 testbundle -s hello-world --sdk-version 1.11.7 --no-git-init\n```\n\nI ran the worker with Bun:\n```sh\nbun run src/worker.ts\n```\n\nAnd ran the client to initiate a workflow:\n```sh\nbun run src/client.ts\n```\n\nThe workflow isn't being picked up by the worker. (it gets assigned, but no actual work is being done).\nNo errors are visible in worker's stdout.","createdAt":"2025-04-27T10:37:22Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2833378888","viewerDidAuthor":false},{"id":"IC_kwDOEujx186p1TLy","author":{"login":"d2201"},"authorAssociation":"NONE","body":"Got a little bit further by modifying the `ReusableVMWorkflowCreator.createWorkflow` method (the `setActivatorUntyped` does not always work for some reason - as in: does not set the activator correctly).\n\nGot blocked however at the last final step -> workflow's execution cannot be completed ðŸ¤· -- the logs are silent.\nThe only suspicion I have is, that there is something wrong within this handler: \n```ts\nawait this.nativeWorker.completeWorkflowActivation(completion.buffer.slice(completion.byteOffset))\n``` \nbut I can not easily debug it.\n\nI have also tried with running the latest code (post January's 1.11.7 release), but ended up with the same issues.\n\nBun version: 1.2.11\n\n\n![Image](https://github.com/user-attachments/assets/8a78d917-f7c8-4578-a717-7a0f8507014a)","createdAt":"2025-05-04T17:15:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2849321714","viewerDidAuthor":false},{"id":"IC_kwDOEujx186qLFY4","author":{"login":"d2201"},"authorAssociation":"NONE","body":"Update:\n\nBun version: 1.2.12 didn't change a thing (workflow's execution still cannot be completed)\n\n// EDIT 2025-05-13:\n\nBun version: 1.2.13, same as above\n\n// EDIT 2025-05-23\n\nBun version: 1.2.14, same as above\n\n// EDIT 2025-05-28\n\nBun version: 1.2.15, same as above\n\nTested both SDK versions: 1.11.7 & 1.11.8","createdAt":"2025-05-06T15:30:11Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":9}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2855032376","viewerDidAuthor":false},{"id":"IC_kwDOEujx186uHsbo","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Thanks a lot @d2201 for all this testing, and thanks @x04 for pushing the NAPI fix to bun!\n\nI unfortunately can't put time investigating this myself just now, but really appreciate the community effort.\n\n@d2201: Regarding your tests above, there are quite a lot of moving parts involved.\n\nTo simplify things a bit, I'd suggest trying to add `debugMode: true` to your worker options. That will force the worker into single thread mode, thus avoiding use of the `node:worker_threads` module.\n\nYou should also set `reuseV8Context: false`, which will force creation of a distinct vm context for each workflow execution. That execution mode is known to be significantly less efficient and increases memory usage (or at least, that's true in Node; I wouldn't be surprised if performance profile turns out to be very different in Bun and Deno), but follows a much simpler execution model that is less likely to trigger edge cases in a \"node-compatibility\" implementation.\n\nAlso make sure to set Runtime's log level to `TRACE` and turn on Core's log forwarding:\n\n```\n    Runtime.install({\n      logger: new DefaultLogger('TRACE'),\n      telemetryOptions: { logging: { forward: {}, filter: makeTelemetryFilterString({ core: 'TRACE' }) } },\n    });\n```\n\nYou may also want to experiment with the code on the main branch of the TS SDK repo, rather than the 1.11.8. Several key components of the SDK went through some significant work, including a major refactor of the native bridge layer, and multiple significant fixes in the Worker and Workflow Sandbox.\n\nI can't promise that these changes will immediately get us closer to the goal of running a Temporal Worker on Bun, and can't exclude the possibility that they might even add some more challenges due to the use of some additional NAPI featuresâ€¦ But I honestly hope that the more robust design and better error handling will make it easier to progress forward.\n\nWhile on that branch, you may also try setting environment variables `TEMPORAL_TRACE_NATIVE_CALLS=true` and `RUST_BACKTRACE=full`. Beware that the Trace Native Calls env variable may produce a huge amount of logs; it is really meant only for low level debugging of the bridge layer, but at this point, that's indeed what you are doing.","createdAt":"2025-05-30T05:13:16Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":5}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2921252584","viewerDidAuthor":false},{"id":"IC_kwDOEujx186uZlOp","author":{"login":"d2201"},"authorAssociation":"NONE","body":"@mjameswh Thank you for this summary. It helped me a lot.\n\nI think it's not the NAPI issue anymore.\n\n## Environment information\n\n```\nSDK (commit: caae0a4eec4ed489c53f102b04f7d4afde318c5b) (1.12.0-rc)\nNode v22.4.0\nBun v1.2.15\n```\n\n## Investigation results\n\nThe debug helped me with understanding what's going on (at least to some degree). It all boils down (in my opinion) to the Bun's compatibility with `node:vm`.\n\n### So what's happening?\n\nThere seems to be some sort of race condition happening.\n\nHigh-level of how Node does the part of completion:\n```\n- runs `activate` function within the workflow vm context\n- workflow gets completed (I've put console.log statements all over the place, and I see the workflow results in there)\n- `activate` function ends\n- ... bunch of other things in the process run\n- the completion is being sent out to the `core` with `successful.commands` containing the `completeWorkflowExecution` command.\n```\n\nHigh-level of how Bun does the part of completion:\n```\n- runs `activate function withing the workflow vm context\n- `activate` function ends\n- ... bunch of other things in the process run\n- the completion is being sent out to the `core` with `successful.commands` being empty\n- I see the console logs from workflow results\n```\n\nI am not sure yet how to solve it.","createdAt":"2025-05-31T23:16:36Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2925941673","viewerDidAuthor":false},{"id":"IC_kwDOEujx186uvEk4","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"> ```\n> - runs `activate function withing the workflow vm context\n> - `activate` function ends\n> - ... bunch of other things in the process run\n> - the completion is being sent out to the `core` with `successful.commands` being empty\n> - I see the console logs from workflow results\n> ```\n\nIf I understand correctly what you describe, it looks like Bun's `vm` implementation is interleaving microtasks from inside and outside the `vm`.\n\nThe JS engine is expected to maintain a distinct event queue for inside the VM, detached from the main event queue. Also, given the `microtaskMode: 'afterEvaluate'` option on `vm.createContext()`, the engine should wait for all microtasks on that inside event task queue to drain before returning from a `vm.runInContext()` call.","createdAt":"2025-06-02T16:51:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2931575096","viewerDidAuthor":false},{"id":"IC_kwDOEujx186uxCt6","author":{"login":"d2201"},"authorAssociation":"NONE","body":"Yup, I'll try to reproduce this issue in a more controllable environment and will report it to Bun's maintainers.","createdAt":"2025-06-02T19:09:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2932091770","viewerDidAuthor":false},{"id":"IC_kwDOEujx186uxRZE","author":{"login":"d2201"},"authorAssociation":"NONE","body":"Got it! Reported: https://github.com/oven-sh/bun/issues/20145","createdAt":"2025-06-02T19:27:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"ROCKET","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2932151876","viewerDidAuthor":false},{"id":"IC_kwDOEujx186uyvw1","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"> The JS engine is expected to maintain a distinct event queue for inside the VM, detached from the main event queue. Also, given the microtaskMode: 'afterEvaluate' option on vm.createContext(), the engine should wait for all microtasks on that inside event task queue to drain before returning from a vm.runInContext() call.\n\nBy the way, we [used to have a patch](https://github.com/temporalio/sdk-typescript/blob/49c6b1341daef2b94a0a989d515cbf97b8b02fa7/packages/worker/src/workflow/vm-shared.ts#L359-L365) for that, because the `microtaskMode: 'afterEvaluate'` only got added in Node 14.6. It was removed when we stopped maintaining that older release.\n\nYou may try to restore that patch and see if that gets you a bit farther.","createdAt":"2025-06-02T21:21:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2932538421","viewerDidAuthor":false},{"id":"IC_kwDOEujx186vE9N0","author":{"login":"d2201"},"authorAssociation":"NONE","body":"I think we've got it @mjameswh. Thank you for the guidance! ðŸŽ‰ \n\nAny chance we can go back to that patch, or should we just wait for bun to fix this incompatibility?\n\nVerified also that I can safely remove the `reuseV8Context` flag, but the `debugMode` needs to be kept `true`.\n\n![Image](https://github.com/user-attachments/assets/356047a8-d4f4-4098-b7be-c5d31521e584)\n\n![Image](https://github.com/user-attachments/assets/c1e4d1c9-2205-4882-9f34-5cd1a91af786)","createdAt":"2025-06-03T21:47:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2937312116","viewerDidAuthor":false},{"id":"IC_kwDOEujx186yepp7","author":{"login":"liho00"},"authorAssociation":"NONE","body":"@d2201 but its seems only pick up first activity, the rest of activities are not running on bun, tested many many times","createdAt":"2025-06-22T19:03:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2994379387","viewerDidAuthor":false},{"id":"IC_kwDOEujx186yep7P","author":{"login":"liho00"},"authorAssociation":"NONE","body":"@mjameswh how can we add that patch?","createdAt":"2025-06-22T19:05:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2994380495","viewerDidAuthor":false},{"id":"IC_kwDOEujx186ypPCQ","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"> Any chance we can go back to that patch, or should we just wait for bun to fix this incompatibility?\n\nI don't have any objection to reintroduce the patch, but we'll have to think of a good way to conditionally enable or disable it. We previously just checked for Node's release number, but I don't want to rely on that kind of things if the goal is to support multiple JS runtimes.\n\nWe'll also need to confirm that all aspects of the sandbox still work correctly with that patch. The sandboxing code has gone through some significant changes since that patch was removed. It is possible that this patch might no longer be reliable.","createdAt":"2025-06-23T16:37:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-2997153936","viewerDidAuthor":false},{"id":"IC_kwDOEujx186y6hOf","author":{"login":"d2201"},"authorAssociation":"NONE","body":"> but its seems only pick up first activity, the rest of activities are not running on bun, tested many many times\n\n@liho00 I didn't test this beyond the `hello world` sample, as it's too unstable to do anything more than that. Once the two runtimes start to behave similarly (without additional flags & custom patches), we can move on to testing other use cases.\n\n> We previously just checked for Node's release number, but I don't want to rely on that kind of things if the goal is to support multiple JS runtimes.\n\nAgreed.\n\nMy take is that Bun isn't stable enough for now, and anyone who uses Bun for more than basic CRUD examples knows that. The `node:vm` module is considered stable in Node, so every runtime that tries to be a \"drop-in Node replacement\" should at least implement all stable APIs from Node.\n\nThe patch itself might do more harm than good, and even with it:\n\n>We'll also need to confirm that all aspects of the sandbox still work correctly with that patch. The sandboxing code has gone through some significant changes since that patch was removed. It is possible that this patch might no longer be reliable.\n\nThat remains a concern.\n\nAfter all, I'm just a follower - not sure how important is it to others here - but for me Bun is mostly a convenience rather than a game changer. IMO, there are bigger DX fish to fry in the SDK, and I'd passively wait until Bun catches up. Nevertheless, I'll keep updating here as things progress, so others can have more visibility into the latest state of this issue.","createdAt":"2025-06-24T19:53:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":8}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-3001684895","viewerDidAuthor":false},{"id":"IC_kwDOEujx1867qLrw","author":{"login":"kwypchlo"},"authorAssociation":"NONE","body":"I was super excited about temporal solving my issues and introducing durability in my company workflows but we're running with bun and can't really easily migrate over to node. I'm looking forward to trying temporal once this gets resolved. FWIW thank you everyone for looking into this.","createdAt":"2025-08-03T12:41:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":15}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-3148397296","viewerDidAuthor":false},{"id":"IC_kwDOEujx187G3rX-","author":{"login":"zammitjames"},"authorAssociation":"NONE","body":"It's insane that this hasn't been implemented yet. ","createdAt":"2025-09-26T01:37:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-3336484350","viewerDidAuthor":false},{"id":"IC_kwDOEujx187KSAZb","author":{"login":"zeonglow"},"authorAssociation":"NONE","body":"If any was wondering,   Bun 1.3 doesn't do it either.\n\nI'd never heard of Promise createHook before,  but it sounds like it would be *much* easier for Bun to implement this rather than rewrite large sections of Temporal.  Assuming that's the only issue of course ðŸ˜‚\n\n```\nWelcome to Bun v1.3.0\nType \".help\" for more information.\n[!] Please note that the REPL implementation is still experimental!\n    Don't consider it to be representative of the stability or behavior of Bun overall.\n> import { promiseHooks } from 'node:v8';\nundefined\n> promiseHooks.createHook({init: console.log})\n111 | }\n112 | function setHeapSnapshotNearHeapLimit() {\n113 |   notimpl(\"setHeapSnapshotNearHeapLimit\");\n114 | }\n115 | var promiseHooks = {\n116 |     notimpl(\"createHook\");\n                             ^\nNotImplementedError: node:v8 createHook is not yet implemented in Bun.\n code: \"ERR_NOT_IMPLEMENTED\"\n\n      at createHook (node:v8:116:12)\n```","createdAt":"2025-10-11T22:56:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":7}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-3393717851","viewerDidAuthor":false},{"id":"IC_kwDOEujx187Lz_lr","author":{"login":"elonsalfati"},"authorAssociation":"NONE","body":"Did someone tag @Jarred-Sumner on this? \n\nWould be super great to make this work on bun!","createdAt":"2025-10-19T08:38:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":12}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-3419404651","viewerDidAuthor":false},{"id":"IC_kwDOEujx187VxhTf","author":{"login":"rajasekarshanmugam"},"authorAssociation":"NONE","body":"Tried on bun 1.3.3 - Hello world sample. \n\nworker - bun, client - bun = client waits for wf to execute and the worker is not picking the execution. \n\nworker - nodejs, client - bun = works.\n\nAnybody had any luck with running temporal only with bun - both worker as well as client and/or some trick to get past? ","createdAt":"2025-11-27T15:45:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":4}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-3586528479","viewerDidAuthor":false},{"id":"IC_kwDOEujx187Wnr-3","author":{"login":"nicu-dev"},"authorAssociation":"NONE","body":"@rajasekarshanmugam it's fine, bun probably not a priority for the team now, npm wasn't hacked THAT many times yet.","createdAt":"2025-12-02T08:01:54Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"CONFUSED","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-3600727991","viewerDidAuthor":false},{"id":"IC_kwDOEujx187Wrx5w","author":{"login":"BrianEstrada"},"authorAssociation":"NONE","body":"Ended up switching to using another provider for bun compatibility, would be really happy to look at Temporal again once they get support for this :)","createdAt":"2025-12-02T12:31:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"CONFUSED","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-3601800816","viewerDidAuthor":false},{"id":"IC_kwDOEujx187WsFdv","author":{"login":"hckhanh"},"authorAssociation":"NONE","body":"> Ended up switching to using another provider for bun compatibility, would be really happy to look at Temporal again once they get support for this :)\n\nWhich one do you use? @BrianEstrada ","createdAt":"2025-12-02T12:52:08Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-3601880943","viewerDidAuthor":false},{"id":"IC_kwDOEujx187XEvFU","author":{"login":"BrianEstrada"},"authorAssociation":"NONE","body":"@hckhanh don't want to promote another service here on Temporal's repo but it's one of the top 4 google search results for `durable workflows`","createdAt":"2025-12-03T18:57:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-3608342868","viewerDidAuthor":false},{"id":"IC_kwDOEujx187Z9qFX","author":{"login":"rajasekarshanmugam"},"authorAssociation":"NONE","body":"are there any pointers where to look for the isolate support in temporal..?","createdAt":"2025-12-15T17:31:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-3656819031","viewerDidAuthor":false},{"id":"IC_kwDOEujx187bOTr3","author":{"login":"slavb18"},"authorAssociation":"NONE","body":"> [@hckhanh](https://github.com/hckhanh) don't want to promote another service here on Temporal's repo but it's one of the top 4 google search results for `durable workflows`\n\nIs there option to convert temporal processes to another workflow engine ?","createdAt":"2025-12-20T17:02:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-3677960951","viewerDidAuthor":false},{"id":"IC_kwDOEujx187bOhBB","author":{"login":"hckhanh"},"authorAssociation":"NONE","body":"I am afraid that there was not","createdAt":"2025-12-20T18:25:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-3678015553","viewerDidAuthor":false},{"id":"IC_kwDOEujx187bXef9","author":{"login":"zeonglow"},"authorAssociation":"NONE","body":"Thinking on this further; Temporal *should not* work on making the app work with other runtimes.\n\nThe reason: temporal isn't about doing lots of things super fast, Bun is optimised for speed and latency and Temporal isn't.\n\nDevelopment resources are always limited; having different runtimes multiples complexity. More things to test, more reasons not to fix stuff.\n\nIMHO the fix would be to change the website so it says \"NodeJS\" rather than \"Typescript\"\n","createdAt":"2025-12-22T04:23:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_DOWN","users":{"totalCount":5}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1334#issuecomment-3680364541","viewerDidAuthor":false}],"createdAt":"2024-01-10T08:59:55Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1334,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":46}}],"state":"OPEN","title":"[Feature Request] Run temporal worker in bun","updatedAt":"2025-12-22T04:23:02Z","url":"https://github.com/temporalio/sdk-typescript/issues/1334"}
