{"assignees":[{"id":"MDQ6VXNlcjY0MTIxNjk=","login":"mjameswh","name":"James Watkins-Harvey","databaseId":0}],"author":{"id":"MDQ6VXNlcjY3MTE4MTk=","is_bot":false,"login":"Vincechen611","name":""},"body":"### What are you really trying to do?\r\nConsider calculate default maxCachedWorkflows by v8.getHeapStatistics().total_available_size instead of os.totalmem()\r\n\r\n### Describe the bug\r\n\r\nRecently, We have implement our temporal worker client with sdk-typescript and run as a container in a k8s cluster.\r\nWe have set `NODE_OPTIONS=--max-old-space-size=XXX` when starting up worker, but we found the worker pod always get OOM killed by k8s when processing task.\r\nAfter checking the detail, we found that the default `maxCachedWorkflows` is calculated by `os.totalmem()` if we didn't set.\r\nWhen running in container, the `os.totalmem()` will get the host machine memory not container resource setting (which is in [cgroup](https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/))\r\nCould we calculate default [maxCachedWorkflows](https://github.com/temporalio/sdk-typescript/blob/a261054130708744c692a50b07d3f189a43b9934/packages/worker/src/worker-options.ts#L414) with v8.getHeapStatistics().total_available_size which might reduce the chance of OOM if user didn't assign maxCachedWorkflows.\r\n\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: [Linux], [container](https://github.com/nodejs/docker-node) based on `node:16.14.0`\r\n- Temporal Version: 1.17.1 , SDK version : v1.0.0-rc.1\r\n- Are you using Docker or Kubernetes? Yes\r\n\r\n### Additional context\r\nOur worker k8s manifest.\r\n![image](https://user-images.githubusercontent.com/6711819/179886299-eb43b2c7-da47-4ca6-9d3b-272183531000.png)\r\n\r\n![image](https://user-images.githubusercontent.com/6711819/179885599-62a9d068-87bc-4cda-8d57-2343f888ee69.png)\r\n","closedAt":"2022-08-15T15:35:43Z","comments":[{"id":"IC_kwDOEujx185G6psl","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Thanks for reporting, we'll use `total_available_size` as the default instead.","createdAt":"2022-07-20T03:36:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/762#issuecomment-1189780261","viewerDidAuthor":false}],"createdAt":"2022-07-20T03:04:38Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":762,"reactionGroups":[{"content":"ROCKET","users":{"totalCount":1}}],"state":"CLOSED","title":"[Bug] worker client OOM when running as a container in a k8s cluster.","updatedAt":"2022-08-15T15:35:43Z","url":"https://github.com/temporalio/sdk-typescript/issues/762"}
