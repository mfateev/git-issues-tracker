{"assignees":[],"author":{"id":"MDQ6VXNlcjUyODgyODU=","is_bot":false,"login":"ricmatsui","name":"Ricardo Matsui"},"body":"### What are you really trying to do?\r\n\r\n<!-- \r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\n-->\r\nWhile developing using TS SDK, we run `npm run start.watch`. When we change the code in `src`, we want the worker to always restart. When we interrupt this task with `Ctrl+C`, we want the worker to always stop.\r\n\r\n### Describe the bug\r\n\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\n1. If we interrupt with `Ctrl+C`, sometimes the worker will continue to run as an orphaned process.\r\n2. Sometimes when we change the code in `src`, the worker ignores it and continues running.\r\n\r\nThis causes issues during development because old workers with old code are unexpectedly still running.\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n\r\n### Minimal Reproduction\r\n\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\nReproduction 1:\r\nRun `npx @temporalio/create@latest temporal-hello-world  --sample hello-world`\r\nRun `cd temporal-hello-world`\r\nRun `npm run start.watch`\r\nHit `Ctrl+C` after \"[INFO] Creating worker\" appears in the logs\r\nRun `ps -a | grep src/worker.js`\r\nSometimes the worker will continue running as an orphaned process\r\n\r\nVideo: https://www.loom.com/share/ff77941fd3d14940ba644759b1da0cd6\r\n\r\nReproduction 2:\r\nRun `npx @temporalio/create@latest temporal-hello-world  --sample hello-world`\r\nRun `npm run start.watch`\r\nChange `src/activities.ts` and save (for example `return \"Hello 1!\"`)\r\nWait for the \"[INFO] Creating worker\" message in the logs\r\nImmediately change `src/activities.ts` again and save (for example `return \"Hello 2!\"`)\r\nRun `npm run workflow`\r\nSometimes the old activities code will run (`\"Hello 1!\"`)\r\n\r\nIt may be easier to reproduce with a larger codebase, etc.\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: Intel Mac\r\n- Temporal Version: Temporal Server 1.15.0, TypeScript SDK 1.4.2\r\n- Are you using Docker or Kubernetes or building Temporal from source? Temporal Server in Docker\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n\r\nnodemon: 2.0.20\r\nts-node: 10.9.1\r\n\r\nOne cause seems to be related to worker `Runtime` listening to process signals in `setupShutdownHook` without any shutdown signal callbacks registered:\r\n\r\nhttps://github.com/temporalio/sdk-typescript/blob/cb1029537976c37270a61bc9744a566618c55e26/packages/worker/src/runtime.ts#L114-L124\r\n\r\nhttps://github.com/temporalio/sdk-typescript/blob/cb1029537976c37270a61bc9744a566618c55e26/packages/worker/src/runtime.ts#L397-L404\r\n\r\nWhen a listener to a process signal is added, the signal no longer causes the default behavior, so the signal is ignored. The shutdown signal callbacks are only added after the worker is started: \r\n\r\nhttps://github.com/temporalio/sdk-typescript/blob/cb1029537976c37270a61bc9744a566618c55e26/packages/worker/src/worker.ts#L1597-L1600\r\n\r\nIf the signal occurs before this, it may be ignored. There could be other issues possibly related to core, nodemon, or ts-node.\r\n\r\nWorkarounds could be:\r\n- Patch `Runtime` to only add listener to process signal when there is a callback\r\n- Add a listener for process signals that always exits for development only","closedAt":"2022-10-13T15:22:08Z","comments":[],"createdAt":"2022-10-07T20:17:58Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":909,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Ignored shutdown signal causing stale workers during development","updatedAt":"2022-10-13T15:22:08Z","url":"https://github.com/temporalio/sdk-typescript/issues/909"}
