{"assignees":[],"author":{"id":"U_kgDOBhXAOw","is_bot":false,"login":"yolken-airplane","name":"Benjamin Yolken"},"body":"### What are you really trying to do?\r\n\r\nWe're trying to detect when workflows fail to activate and return a reason back to our users.\r\n\r\n### Describe the bug\r\n\r\nWe have some workflows that fail to activate due to timeouts and other issues. The worker outputs a `Failed to activate` message with an error, but it seems like this error is always empty, i.e. `\"error\":{}`. The \"real error\" is visible in a `TRACE` message later on, but that message doesn't have as much context and also sometimes doesn't appear (not sure why). \r\n\r\nIt would be nice if the original `Failed to activate` message had more information on what happened.\r\n\r\nHere's an example of the logs when the activation failure is due to a timeout:\r\n\r\n```\r\n[TRACE] Creating workflow {\"namespace\":\"default\",\"taskQueue\":\"hello-world\",\"workflowId\":\"workflow-rB1OaMvJNTlJ0Qb6aZGp2\",\"runId\":\"44fdc3ad-1e89-4676-8f37-1b73595031a5\",\"workflowType\":\"example\"}\r\n[DEBUG] Workflow started {\"namespace\":\"default\",\"taskQueue\":\"hello-world\",\"workflowId\":\"workflow-rB1OaMvJNTlJ0Qb6aZGp2\",\"runId\":\"44fdc3ad-1e89-4676-8f37-1b73595031a5\",\"workflowType\":\"example\"}\r\n[ERROR] Failed to activate workflow {\"namespace\":\"default\",\"taskQueue\":\"hello-world\",\"workflowId\":\"workflow-rB1OaMvJNTlJ0Qb6aZGp2\",\"runId\":\"44fdc3ad-1e89-4676-8f37-1b73595031a5\",\"workflowType\":\"example\",\"error\":{},\"workflowExists\":true}\r\n[TRACE] Got workflow activation {\"jobs\":[{\"removeFromCache\":{\"message\":\"Workflow activation completion failed: Failure { failure: Some(Failure { message: \\\"Script execution timed out after 5000ms\\\", source: \\\"TypeScriptSDK\\\", stack_trace: \\\"Error: Script execution timed out after 5000ms\\\", encoded_attributes: None, cause: None, failure_info: None }) }\",\"reason\":\"LANG_FAIL\"}}],\"runId\":\"44fdc3ad-1e89-4676-8f37-1b73595031a5\",\"timestamp\":{\"seconds\":\"1667442437\",\"nanos\":223436135},\"historyLength\":6}\r\n[TRACE] Disposing workflow {\"runId\":\"44fdc3ad-1e89-4676-8f37-1b73595031a5\"}\r\n```\r\n\r\n### Minimal Reproduction\r\n\r\nMake the following changes to the [\"hello-world\" example](https://github.com/temporalio/samples-typescript/tree/main/hello-world):\r\n\r\n1. Add a `while(true) {}` in the workflow `example` function\r\n2. (Optional) Turn on trace logging in the worker via something like:\r\n\r\n```\r\n  const logger = new DefaultLogger(\"TRACE\", ({ level, message, meta }) => {\r\n    if (meta) {\r\n      console.log(`[${level}] ${message} ${JSON.stringify(meta)}`);\r\n    } else {\r\n      console.log(`[${level}] ${message}`);\r\n    }\r\n  });\r\n  Runtime.install({ logger });\r\n```\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: M1 Mac\r\n- Temporal Version: v1.18.1 (server), 1.4.3 (SDK)\r\n- Are you using Docker or Kubernetes or building Temporal from source? Using temporalite\r\n\r\n### Additional context\r\n\r\nN/A","closedAt":"2023-06-06T19:54:17Z","comments":[{"id":"IC_kwDOEujx185eIxFn","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Indeed. Let me add some context, as others are likely to stumble again on this issue.\r\n\r\nThis is actually the correct behavior in JavaScript, even though it surprises most of us. For example, try running `JSON.stringify(new Error('message'))` in a basic JS program, and you get an empty object.\r\n```\r\n$ node -e \"console.log(JSON.stringify(new Error('message')))\"\r\n> {}\r\n```\r\n\r\nThe reason for this is that [`JSON.stringify` only goes down on _enumerable own properties_](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify), whereas `Error.message` and `Error.stackTrace` are not enumerable properties.\r\n\r\nWhy then are these fields visible on the \"Got workflow activation\" line? Because at that point, you no longer have an `Error` object, but rather a `TemporalFailure` object that has been constructed from that error.\r\n\r\nPossible solutions to this includes:\r\n- Use [Node's `util.format(err)`](https://nodejs.org/api/util.html#utilformatformat-args) instead of `JSON.stringify(err)`\r\n- Define `Error.prototype.toJSON` to a function that returns a non-`Error` object that contains all of the `Error`'s properties:\r\n  ```\r\n  Object.defineProperty(Error.prototype, 'toJSON', {\r\n    value(this: any) {\r\n      const alt: any = {};\r\n      \r\n      Object.getOwnPropertyNames(this).forEach((key) => {\r\n        alt[key] = this[key];\r\n      }, this);\r\n      \r\n      return alt;\r\n    },\r\n    configurable: true,\r\n    writable: true,\r\n  });\r\n  ```\r\n- Provide a replacer function to `JSON.stringify` (ie. `JSON.stringify(obj, () => {})`)\r\n- Use [the `serialize-error` package](https://github.com/sindresorhus/serialize-error)","createdAt":"2023-06-06T19:52:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/948#issuecomment-1579356519","viewerDidAuthor":false},{"id":"IC_kwDOEujx185eIxop","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Now, regarding the TS SDK itself, I can't find any problematic case as of 1.7.3. The repro code above works correctly if not using the custom logger, or with the custom logger modified to use `util.format` instead of `JSON.stringify`.","createdAt":"2023-06-06T19:54:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/948#issuecomment-1579358761","viewerDidAuthor":false},{"id":"IC_kwDOEujx185eJ555","author":{"login":"yolken-airplane"},"authorAssociation":"NONE","body":"@mjameswh thanks for this explanation!","createdAt":"2023-06-07T00:35:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/948#issuecomment-1579654777","viewerDidAuthor":false}],"createdAt":"2022-11-03T02:42:15Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":948,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"[Bug] Error is blank in `Failed to activate workflow` messages","updatedAt":"2023-06-07T00:35:10Z","url":"https://github.com/temporalio/sdk-typescript/issues/948"}
