{"assignees":[{"id":"MDQ6VXNlcjY0MTIxNjk=","login":"mjameswh","name":"James Watkins-Harvey","databaseId":0}],"author":{"id":"MDQ6VXNlcjUyMzA0","is_bot":false,"login":"bergundy","name":"Roey Berman"},"body":"Getting this warning when running a simple test with the test environment:\r\n\r\n```\r\n $ ./node_modules/.bin/jest --detectOpenHandles\r\n\r\n...\r\nJest has detected the following 1 open handle potentially keeping Jest from exiting:\r\n\r\n  ●  neon threadsafe function\r\n...\r\n```\r\n\r\n\r\nCode for reproduction:\r\n\r\n```ts\r\nimport { TestWorkflowEnvironment } from '@temporalio/testing';\r\nimport { Worker, Runtime, DefaultLogger, LogEntry } from '@temporalio/worker';\r\nimport { someWorkflow } from './workflows';\r\n\r\nlet testEnv: TestWorkflowEnvironment;\r\n\r\nbeforeAll(async () => {\r\n  // Use console.log instead of console.error to avoid red output\r\n  // Filter INFO log messages for clearer test output\r\n  Runtime.install({\r\n    logger: new DefaultLogger('WARN', (entry: LogEntry) => console.log(`[${entry.level}]`, entry.message)),\r\n  });\r\n\r\n  testEnv = await TestWorkflowEnvironment.createTimeSkipping();\r\n});\r\n\r\nafterAll(async () => {\r\n  await testEnv?.teardown();\r\n});\r\n\r\ntest('some random test', async () => {\r\n  const { client, nativeConnection } = testEnv;\r\n  const worker = await Worker.create({\r\n    connection: nativeConnection,\r\n    taskQueue: 'test',\r\n    workflowsPath: require.resolve('./workflows'),\r\n    activities: {\r\n      // ...\r\n    },\r\n  });\r\n\r\n  await worker.runUntil(async () => {\r\n    const result = await client.workflow.execute(someWorkflow, {\r\n      args: [],\r\n      workflowId: 'money-transfer-test-workflow',\r\n      taskQueue: 'test',\r\n    });\r\n\r\n    expect(result).toEqual('test');\r\n  });\r\n});\r\n```","closedAt":null,"comments":[{"id":"IC_kwDOEujx185MX6wD","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Val did some investigating in https://github.com/temporalio/samples-typescript/issues/189","createdAt":"2022-10-17T19:03:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1281338371","viewerDidAuthor":false},{"id":"IC_kwDOEujx185O5i-D","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Test case can be reduced to this:\r\n\r\n```\r\ntest(`core-bridge registerErrors() doesn't leave open handles`, async () => {\r\n    const native = require(\"@temporalio/core-bridge\");\r\n\r\n    native.registerErrors({\r\n        IllegalStateError: () => ({}),\r\n        ShutdownError: () => ({}),\r\n        TransportError: () => ({}),\r\n        UnexpectedError: () => ({}),\r\n        GracefulShutdownPeriodExpiredError: () => ({}),\r\n    });\r\n});\r\n```\r\n\r\nThe issue is specifically with `registerErrors()`. For example, that one doesn't trigger the error message:\r\n\r\n```\r\ntest(`core-bridge getTimeOfDay() doesn't leave open handles`, async () => {\r\n    const native = require(\"@temporalio/core-bridge\");\r\n    native.getTimeOfDay();\r\n}\r\n```","createdAt":"2022-11-22T13:49:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1323708291","viewerDidAuthor":false},{"id":"IC_kwDOEujx185O5t32","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"The issue relates to usage of the `.root()` function to keep references to error constructors from Rust land.\r\n\r\n```\r\npub fn register_errors(mut cx: FunctionContext) -> JsResult<JsUndefined> {\r\n    // ...\r\n\r\n    let mapping = cx.argument::<JsObject>(0)?;\r\n    let shutdown_error = mapping\r\n        .get::<JsFunction, _, _>(&mut cx, \"ShutdownError\")?\r\n        .root(&mut cx);   // <----\r\n```\r\n\r\nNeon's `Root` object internally register a [`ThreadSafeFunction`](https://nodejs.org/api/n-api.html#asynchronous-thread-safe-function-calls), which is a special type of resource provided by Node's napi allowing native code to call a JavaScript function from any thread. It is that `ThreadSafeFunction` resource that Jest detects as being left open.","createdAt":"2022-11-22T14:20:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1323752950","viewerDidAuthor":false},{"id":"IC_kwDOEujx185PQn2-","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Opened a ticket in Neon: https://github.com/neon-bindings/neon/issues/948","createdAt":"2022-11-28T21:03:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1329757630","viewerDidAuthor":false},{"id":"IC_kwDOEujx185RjV2V","author":{"login":"igorsechyn"},"authorAssociation":"NONE","body":"We hit the same issue in our test setup. Weirdly it causes issues in CircleCI as jest just won't exit despite using `--forceExit` flag. We upgraded to the latest version of sdk and the issue still persists. It is intermittent, so it is hard to pinpoint it to temporal tests, but this behaviour started around the same time as we added temporal tests","createdAt":"2022-12-31T13:59:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1368219029","viewerDidAuthor":false},{"id":"IC_kwDOEujx185WTLBh","author":{"login":"mandriv"},"authorAssociation":"NONE","body":"Is there any known workaround?","createdAt":"2023-02-28T09:42:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1447866465","viewerDidAuthor":false},{"id":"IC_kwDOEujx185WUDtq","author":{"login":"Irvenae"},"authorAssociation":"NONE","body":"Since the new version we are hitting an issue with Jest on CircleCI as well.\r\nRunning into `Too long with no output (exceeded 10m0s): context deadline exceeded`","createdAt":"2023-02-28T12:28:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1448098666","viewerDidAuthor":false},{"id":"IC_kwDOEujx185WVnVp","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"> Is there any known workaround?\r\n\r\nI'm not aware of any workaround regarding Jest's warning about open handle. This warning message can simply be ignored. This may also cause a 10 seconds delay on process termination, which should generally not be that much of an issue.","createdAt":"2023-02-28T16:45:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1448506729","viewerDidAuthor":false},{"id":"IC_kwDOEujx185WVySL","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"> Since the new version we are hitting an issue with Jest on CircleCI as well. Running into `Too long with no output (exceeded 10m0s): context deadline exceeded`\r\n\r\n> We hit the same issue in our test setup. Weirdly it causes issues in CircleCI as jest just won't exit despite using --forceExit flag. We upgraded to the latest version of sdk and the issue still persists. It is intermittent, so it is hard to pinpoint it to temporal tests, but this behaviour started around the same time as we added temporal tests\r\n\r\nI don't think this is related to the \"detected open handle\" bug. Wondering if [this](https://github.com/facebook/jest/issues/12972) might be related, though there's unfortunately very little context to work with.\r\n\r\n@mandriv @Irvenae Let assume this is a different issue... Could you please provide more details on these situations? Here are some ideas info that might help figure this out, but feel free to add whatever that you think could be useful:\r\n- Temporal SDK/Jest/Node versions?\r\n- Collecting coverage metrics?\r\n- Is that behaviour happening consistently or is it intermittent?\r\n- If you run these tests locally using the very same command as when these tests are being run in CircleCI, does execution completes normally and process stops by itself?\r\n- Do you very get long period of time where the process stop outputting anything? How long \r\n- Can you still reproduce the error with a reduced test suite?","createdAt":"2023-02-28T17:11:32Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1448551563","viewerDidAuthor":false},{"id":"IC_kwDOEujx185WZ4oz","author":{"login":"Irvenae"},"authorAssociation":"NONE","body":"- Temporal SDK v1.6.0, Jest 29.3.0, node v16.15.0\r\n- No coverage metrics\r\n- intermittent\r\n- Locally tests complete (tried it 10 times)\r\n\r\nThis is the log we get in circleCI:\r\n```\r\n2023-02-28T09:49:27.110Z [WARN] This program is running inside a containerized environment with a memory constraint (eg. docker --memory 70226m). Node itself does not consider this memory constraint in how it manages its heap memory. There is consequently a high probability that the process will crash due to running out of memory. To increase reliability, we recommend adding '--max-old-space-size=52669' to your node arguments. Refer to https://docs.temporal.io/application-development/worker-performance for more advice on tuning your workers.\r\n2023-02-28T09:49:27.145998Z  INFO temporal_sdk_core::ephemeral_server: Downloading https://temporal.download/assets/temporalio/sdk-java/releases/download/v1.17.0/temporal-test-server_1.17.0_linux_amd64.tar.gz to /tmp/temporal-test-server-sdk-typescript-1.6.0\r\n2023-02-28T09:49:27.871Z [INFO] Creating worker {\r\n  options: {\r\n    namespace: 'default',\r\n    identity: '454@f5f8c41c3a04',\r\n    shutdownGraceTime: '10s',\r\n    maxConcurrentActivityTaskExecutions: 100,\r\n    maxConcurrentLocalActivityExecutions: 100,\r\n    enableNonLocalActivities: true,\r\n    maxConcurrentWorkflowTaskExecutions: 100,\r\n    stickyQueueScheduleToStartTimeout: '5m',\r\n    maxHeartbeatThrottleInterval: '60s',\r\n    defaultHeartbeatThrottleInterval: '30s',\r\n    isolateExecutionTimeout: '4294967295ms',\r\n    workflowThreadPoolSize: 1,\r\n    maxCachedWorkflows: 1761,\r\n    enableSDKTracing: false,\r\n    showStackTraceSources: true,\r\n    reuseV8Context: true,\r\n    debugMode: true,\r\n    interceptors: { activityInbound: [Array], workflowModules: [Array] },\r\n    sinks: { logger: [Object] },\r\n    workflowsPath: '/root/repo/packages/temporal-features/src/tests/allWorkflows.ts',\r\n    bundlerOptions: { webpackConfigHook: [Function: webpackConfigHook] },\r\n    activities: {\r\n      cancelJob: [Getter],\r\n      createItem: [Getter],\r\n      createItemWithData: [Getter],\r\n      deleteItem: [Getter],\r\n      findItems: [Getter],\r\n      findItemsInAllVersions: [Getter],\r\n      getFileJson: [Getter],\r\n      getItem: [Getter],\r\n      persistData: [Getter],\r\n      setItem: [Getter],\r\n      createOrMemoizeJob: [Getter],\r\n      getJobResult: [Getter],\r\n      getResult: [Getter],\r\n      queryWorkflow: [Getter],\r\n      signalWithStartWorkflowForItem: [Getter],\r\n      signalWorkflow: [Getter],\r\n      startAndQueryWorkflowForItem: [Getter]\r\n    },\r\n    taskQueue: 'test',\r\n    connection: NativeConnection {\r\n      nativeClient: [External: 7fe4b80045b0],\r\n      referenceHolders: Set(0) {}\r\n    },\r\n    shutdownGraceTimeMs: 10000,\r\n    stickyQueueScheduleToStartTimeoutMs: 300000,\r\n    isolateExecutionTimeoutMs: 4294967295,\r\n    maxHeartbeatThrottleIntervalMs: 60000,\r\n    defaultHeartbeatThrottleIntervalMs: 30000,\r\n    loadedDataConverter: {\r\n      payloadConverter: [DefaultPayloadConverter],\r\n      failureConverter: [DefaultFailureConverter],\r\n      payloadCodecs: []\r\n    }\r\n  }\r\n}\r\n2023-02-28T09:49:36.018Z [INFO] asset workflow-bundle-a2ca801512c61451083d.js 22.2 MiB [emitted] [immutable] (name: main)\r\n2023-02-28T09:49:36.018Z [INFO] runtime modules 1.25 KiB 6 modules\r\n2023-02-28T09:49:36.018Z [INFO] modules by path ./packages/ 4.44 MiB 726 modules\r\n2023-02-28T09:49:36.019Z [INFO] modules by path ./node_modules/ 3.54 MiB 293 modules\r\n2023-02-28T09:49:36.019Z [INFO] modules by path ./tooling/tool-version-sync/lib/*.js 4.99 KiB\r\n2023-02-28T09:49:36.019Z [INFO]   ./tooling/tool-version-sync/lib/index.js 1.2 KiB [built] [code generated]\r\n2023-02-28T09:49:36.019Z [INFO]   ./tooling/tool-version-sync/lib/toolVersions.js 1.54 KiB [built] [code generated]\r\n2023-02-28T09:49:36.019Z [INFO]   ./tooling/tool-version-sync/lib/toolMemoryLimits.js 2.25 KiB [built] [code generated]\r\n2023-02-28T09:49:36.019Z [INFO] __temporal_custom_payload_converter (ignored) 15 bytes [built] [code generated]\r\n2023-02-28T09:49:36.019Z [INFO] __temporal_custom_failure_converter (ignored) 15 bytes [built] [code generated]\r\n2023-02-28T09:49:36.019Z [INFO] webpack 5.75.0 compiled successfully in 7586 ms\r\n2023-02-28T09:49:36.116Z [INFO] Workflow bundle created { size: '22.12MB' }\r\n2023-02-28T09:49:37.170023Z  INFO temporal_sdk_core::worker: Initializing worker task_queue=test namespace=default\r\n2023-02-28T09:49:37.172Z [INFO] Worker state changed { state: 'RUNNING' }\r\n(node:454) MaxListenersExceededWarning: Possible EventTarget memory leak detected. 11 abort listeners added to [AbortSignal]. Use events.setMaxListeners() to increase limit\r\n(Use `node --trace-warnings ...` to show where the warning was created)\r\n\r\nToo long with no output (exceeded 10m0s): context deadline exceeded\r\n```\r\n\r\nIn this run it only runs 1 test file. In this test file we only create 1 timeSkipping test env, which we reuse for 12 tests.\r\nI checked the memory and we only use at a max 25% Mem of the instance so OOM is out of the question.\r\nThe `MaxListenersExceededWarning` can be ignored, sth in our code we need to resolve.\r\n\r\nA successful run would have 3 min later the Worker state changed { state: 'STOPPING' } and etc. We only print info logs I will try to reproduce with debug logs as well.","createdAt":"2023-03-01T09:03:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1449626163","viewerDidAuthor":false},{"id":"IC_kwDOEujx185WcCwZ","author":{"login":"Irvenae"},"authorAssociation":"NONE","body":"I might have been on the wrong track, I today reran this 10 times on CircleCI but no failure. I know for sure this happens when we have multiple tests running, but there it could be OOM as well (so setting node options and/or going to a single Jest worker to see if it is resolved). Anyway, I am also further investigating to potentially pinpoint it better.","createdAt":"2023-03-01T13:57:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1450191897","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Wcovo","author":{"login":"igorsechyn"},"authorAssociation":"NONE","body":"FWIW, we found that we were either running out CPU or Memory, when executing in CircleCI. The only thing that helped us is to reduce number of jest workers. we had not had a single failure since then.","createdAt":"2023-03-01T15:32:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1450347496","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Wd6AH","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":">I checked the memory and we only use at a max 25% Mem of the instance so OOM is out of the question.\r\n\r\nNot sure if this is the issue here, but I personally recommend to _always_ explicitly set Node's `--max-old-space-size` (see [this page](https://legacy-documentation-sdks.temporal.io/typescript/production-deploy#properly-configure-nodes-memory-in-docker) for some details).\r\n\r\nBased on your log, it appears you are executing inside a containerized environment with a memory constraint. Node itself doesn't play great in such cases, because it doesn't know about those constraints and instead configure its heap allocation and garbage collection to based on the machine's total memory.\r\n\r\nThe opposite is also possible: by default, Node will configure its heap allocation limit and garbage collection algorithms to 25% of available memory, up to a limit of 4GB (assuming node 14 to 18, with 64 bits cpu). That means that your Node process may not be taking advantage of all the resources available to it, which could explain that it is not performing as it should.\r\n\r\nBoth cases can be resolved by explicitly setting and properly tuning Node's `--max-old-space-size`.","createdAt":"2023-03-01T18:44:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1450680327","viewerDidAuthor":false},{"id":"IC_kwDOEujx185aKVGm","author":{"login":"NivOclear"},"authorAssociation":"NONE","body":"so any progress regarding this issue ? this not just a warning in our cicd its break the jest test and not passing them ","createdAt":"2023-04-18T08:16:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1512657318","viewerDidAuthor":false},{"id":"IC_kwDOEujx185aKa1b","author":{"login":"Irvenae"},"authorAssociation":"NONE","body":"We have resolved it by using a bigger machine and reducing the number of jest workers and setting `--max-old-space-size` (taking into account the nr of workers).\r\n\r\nI am now evaluating AVA tbh, because attaching the debugger is spotty with Jest.","createdAt":"2023-04-18T08:33:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1512680795","viewerDidAuthor":false},{"id":"IC_kwDOEujx185sgPrt","author":{"login":"Kannndev"},"authorAssociation":"NONE","body":"I am not sure if this is relevant, but i will add here just to get others opinion as well,\r\n\r\nWhen I run the test with `createLocal` it works but when i use `createTimeSkipping` test times out even after 60s. The example test is \r\n\r\n```\r\nimport { DefaultLogger, LogEntry, Runtime, Worker } from '@temporalio/worker';\r\n\r\nimport { TestWorkflowEnvironment } from '@temporalio/testing';\r\nimport { WorkflowCoverage } from '@temporalio/nyc-test-coverage';\r\nimport { example } from './workflow';\r\n\r\ndescribe('Example workflow with mocks', () => {\r\n  let testEnv: TestWorkflowEnvironment;\r\n  const workflowCoverage = new WorkflowCoverage();\r\n\r\n  beforeAll(async () => {\r\n    // Use console.log instead of console.error to avoid red output\r\n    // Filter INFO log messages for clearer test output\r\n    Runtime.install({\r\n      logger: new DefaultLogger('WARN', (entry: LogEntry) => console.log(`[${entry.level}]`, entry.message)),\r\n    });\r\n\r\n    testEnv = await TestWorkflowEnvironment.createLocal();\r\n  });\r\n\r\n  afterAll(async () => {\r\n    await testEnv?.teardown();\r\n  });\r\n\r\n  afterAll(() => {\r\n    workflowCoverage.mergeIntoGlobalCoverage();\r\n  });\r\n\r\n  it('successfully completes the Workflow with a mocked Activity', async () => {\r\n    const { client, nativeConnection } = testEnv;\r\n    const taskQueue = 'test';\r\n\r\n    const worker = await Worker.create(\r\n      workflowCoverage.augmentWorkerOptions({\r\n        connection: nativeConnection,\r\n        taskQueue: 'test',\r\n        workflowsPath: require.resolve('../workflows'),\r\n        activities: {\r\n          greet: async () => 'Hello, Temporal!',\r\n        },\r\n      })\r\n    );\r\n\r\n    await worker.runUntil(async () => {\r\n      const result = await client.workflow.execute(example, {\r\n        args: ['Temporal'],\r\n        workflowId: 'test',\r\n        taskQueue,\r\n      });\r\n      expect(result).toEqual('Hello, Temporal!');\r\n    });\r\n  });\r\n});\r\n\r\n```\r\n\r\nWhy is this behaviour happening ?, ","createdAt":"2023-11-21T07:46:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1820392173","viewerDidAuthor":false},{"id":"IC_kwDOEujx185uwMvO","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"> When I run the test with createLocal it works but when i use createTimeSkipping test times out even after 60s. The example test is\r\n\r\nThanks for the feedback.\r\n\r\nWe haven't had the capacity to investigate this further for now, we'll need more work to understand what's going on here.","createdAt":"2023-12-15T16:14:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1858128846","viewerDidAuthor":false},{"id":"IC_kwDOEujx185yh5_m","author":{"login":"jbsil"},"authorAssociation":"NONE","body":"We've found a workaround for this when running `Worker`s using the `TestWorkflowEnvironment` in jest with `--detectOpenHandles`. This does not appear to work for activities run using the `MockActivityEnvironment`, where the open handles still persist.\r\n\r\nthe summary of the worker workaround is:\r\n1. when you create your `TestWorkflowEnvironment`, store it on global, e.g. `global.TemporalEnvironment: TestWorkflowEnvironment`\r\n2. as you `Worker.create` each of your workers, store the `Worker` (await the call to create) into _something_ on global, e.g. `global.workers: Worker[]`\r\n3. as you `worker.run()` each of your workers, store the run promise as well into _something_ on global, e.g. `global.workerPromises: Promise[]`\r\n4. setup a [jest globalTeardown](https://jestjs.io/docs/configuration#globalteardown-string) to clean up all of this stuff\r\n5. on each of the `global.workers`, call `.shutdown()`, which will cause the workers to (eventually) shut down. do not try to await this\r\n6. instead, wait for all of the worker run promises, e.g. `await Promise.all(global.workerPromises)`\r\n7. finally, teardown the TWE, e.g. `await global.TemporalEnvironment.teardown()`\r\ne.g. teardown.ts\r\n```ts\r\nexport default async function teardown() {\r\n  // ask each worker to start shutting down\r\n  global.workers.forEach((worker) => {\r\n    // do not wait for this, it is non-blocking\r\n    worker.shutdown();\r\n  });\r\n  // the promises created by `Worker.run` will resolve once the worker has actually shutdown\r\n  await Promise.all(global.workerPromises);\r\n  // fyi - teardown the environment won't work until after the workers disconnect\r\n  await global.TemporalEnvironment?.teardown();\r\n}\r\n```\r\n\r\nTo get your typing correct, you can `declare global`, but note that you have to `var` your variables, `let` and `const` [wont work](https://www.typescriptlang.org/docs/handbook/release-notes/typescript-3-4.html?#type-checking-for-globalthis).\r\ne.g. \r\n```ts\r\ndeclare global {\r\n  var TemporalEnvironment: TestWorkflowEnvironment;\r\n  var workers: Worker[];\r\n  var workerPromises: Promise[];\r\n}\r\n```\r\n\r\nWe have found that the most \"sane\" configuration of this is to use a [jest globalSetup](https://jestjs.io/docs/configuration#globalsetup-string) to start the `TestWorkflowEnvironment` and all of the workers involved, because it more closely mirrors what will be happening in production (the server and workers will be running before a workflow payload arrives). But, you don't _have_ to do that part.\r\n\r\nIn our worker repos, using Node 18 and temporalio/* @ 1.9.0, this closes all of our handles and lets jest exit gracefully.\r\n\r\nWe're still unable to work around the open handles from the `MockActivityEnvironment`, though, which is disappointing.","createdAt":"2024-02-01T14:40:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1921490918","viewerDidAuthor":false},{"id":"IC_kwDOEujx185yjY7a","author":{"login":"jbsil"},"authorAssociation":"NONE","body":"It turns out that the handles opened by `MockActivityEnvironment` are in the `Runtime`. That means that you can \r\njest config\r\n```json\r\n{\r\n  ...,\r\n  \"globalTeardown\": \"tests/teardown.ts\"\r\n}\r\n```\r\nteardown.ts\r\n```ts\r\nimport { Runtime } from '@temporalio/worker';\r\nexport default async function() {\r\n  await Runtime.getInstance().shutdown();\r\n}\r\n```\r\nand your open handles will get cleaned up. There is some delay (a few seconds) after the tests finish while the Runtime shuts down, but it stops jest from complaining! \r\nHurray!","createdAt":"2024-02-01T17:48:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1921879770","viewerDidAuthor":false},{"id":"IC_kwDOEujx185yrh8F","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Thanks a lot @jbsil for sharing your findings on this issue. It will certainly help a few of our users.\r\n\r\nI have to admit that I'm very intrigued by why this solution actually resolves the symptom, as I'm pretty sure that this will not force unloading of Neon's global `ThreadSafeFunction`, but glad to know that it works. We're planning to dig into more into Jest related issues soon; I will experiment more with your workaround at that moment.","createdAt":"2024-02-02T14:36:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-1924013829","viewerDidAuthor":false},{"id":"IC_kwDOEujx18580VW4","author":{"login":"ilijaNL"},"authorAssociation":"NONE","body":"This is still ongoing issue, sometimes it also takes sometime before everything is terminated according to jest runner. ","createdAt":"2024-05-04T09:23:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-2094093752","viewerDidAuthor":false},{"id":"IC_kwDOEujx186NVwSZ","author":{"login":"jamespsterling"},"authorAssociation":"NONE","body":"We are seeing this for `MockActivityEnvironment`, \r\n\r\n\r\n```ts\r\nJest has detected the following 1 open handle potentially keeping Jest from exiting:\r\n\r\n  ●  neon threadsafe function\r\n\r\n      34 |\r\n      35 |   beforeEach(async () => {\r\n    > 36 |     env = new MockActivityEnvironment({ attempt: 2 });\r\n         |           ^\r\n      37 |\r\n      38 |     const compiledSubject = await compileTemplate({\r\n      39 |       mergeFields: allMergeFields,\r\n\r\n      at ../../../../node_modules/@temporalio/core-bridge/index.js:16:14\r\n      at Function.create (../../../../node_modules/@temporalio/worker/src/runtime.ts:202:31)\r\n      at Function.instance (../../../../node_modules/@temporalio/worker/src/runtime.ts:194:17)\r\n      at Activity.makeActivityLogger (../../../../node_modules/@temporalio/worker/src/activity.ts:82:34)\r\n      at new Activity (../../../../node_modules/@temporalio/worker/src/activity.ts:61:12)\r\n      at new MockActivityEnvironment (../../../../node_modules/@temporalio/testing/src/index.ts:416:21)\r\n      at Object.<anonymous> (src/lib/actions/emails/prepareEmailAndMessageData.spec.ts:36:11)\r\n```","createdAt":"2024-09-24T13:32:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-2371290265","viewerDidAuthor":false},{"id":"IC_kwDOEujx186ThIXp","author":{"login":"Charly-xepelin"},"authorAssociation":"NONE","body":"As @jbsil suggested I simple kept in the jest describe the promise returned by `worker.run` and waited for it in the afterAll:\r\n\r\n```typescript\r\ndescribe('My tests', () => {\r\n    let worker: Worker;\r\n    let client: typeof testEnv.client;\r\n    let workerRunPromise: Promise<void>;\r\n\r\n    // beforeAll and afterAll are injected by Jest\r\n    beforeAll(async () => {\r\n        testEnv = await TestWorkflowEnvironment.createTimeSkipping();\r\n\r\n        worker = await Worker.create({\r\n            connection: testEnv.nativeConnection,\r\n            taskQueue: 'test',\r\n            workflowsPath: require.resolve('./workflow'),\r\n            activities: mockActivities,\r\n        });\r\n\r\n        workerRunPromise = worker.run().catch((err) => console.log(err));\r\n\r\n        client = testEnv.client;\r\n    });\r\n\r\n    afterAll(async () => {\r\n        if (worker) {\r\n            worker.shutdown();\r\n            await workerRunPromise;\r\n        }\r\n        await testEnv?.teardown();\r\n    });\r\n});\r\n```","createdAt":"2024-11-13T22:16:46Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-2474935785","viewerDidAuthor":false},{"id":"IC_kwDOEujx186VU0yB","author":{"login":"caiokf"},"authorAssociation":"NONE","body":"in the afterAll, `await Runtime._instance?.shutdown()` worked for me","createdAt":"2024-11-28T04:58:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-2505264257","viewerDidAuthor":false},{"id":"IC_kwDOEujx186WVfxq","author":{"login":"Thexumaker"},"authorAssociation":"NONE","body":"@Charly-xepelin this worked for me as well\r\n","createdAt":"2024-12-06T06:05:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-2522217578","viewerDidAuthor":false},{"id":"IC_kwDOEujx187Dbrfr","author":{"login":"QuentinLemCode"},"authorAssociation":"NONE","body":"Hi ! I'm also affected by the issue. \nEven doing `await Runtime.getInstance().shutdown()` doesn't work for me. I'm using the latest version (1.13.0)\n@mjameswh Do you have any update ?","createdAt":"2025-09-11T07:22:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/928#issuecomment-3278813163","viewerDidAuthor":false}],"createdAt":"2022-10-17T18:26:52Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":928,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":7}}],"state":"OPEN","title":"[Bug] Jest detects open handles","updatedAt":"2025-09-11T07:22:29Z","url":"https://github.com/temporalio/sdk-typescript/issues/928"}
