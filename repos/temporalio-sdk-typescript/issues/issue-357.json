{"assignees":[{"id":"MDQ6VXNlcjI1MTI4OA==","login":"lorensr","name":"Loren ☺️","databaseId":0}],"author":{"id":"MDQ6VXNlcjUyMzA0","is_bot":false,"login":"bergundy","name":"Roey Berman"},"body":"[As discussed on our community slack](https://temporalio.slack.com/archives/C01DKSMU94L/p1635615168067800), we'd like to expose the number of history events and the aggregated payloads size to via `WorkflowInfo` so Workflow authors can make smarter decisions for when to continue as new.","closedAt":"2022-06-01T17:58:40Z","comments":[{"id":"IC_kwDOEujx1845N2xn","author":{"login":"calumpwebb"},"authorAssociation":"NONE","body":"can the same issue (or way of solving this) be used for other sdks? We're mainly using the Go SDK and would want workflow history size on there too. ","createdAt":"2021-11-03T20:08:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/357#issuecomment-959933543","viewerDidAuthor":false},{"id":"IC_kwDOEujx1845OtQK","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Definitely. Once implementation is defined on how best to do this, we can put this information on `WorkflowInfo` in Go assuming it's readily available. Same for Java (we try to maintain parity across SDKs). I will open the issues once the details are a bit better defined.","createdAt":"2021-11-03T21:49:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/357#issuecomment-960156682","viewerDidAuthor":false},{"id":"IC_kwDOEujx18465uaC","author":{"login":"swyxio"},"authorAssociation":"CONTRIBUTOR","body":"are people able to use https://typescript.temporal.io/api/classes/proto.temporal.api.workflowservice.v1.workflowservice-1/#getworkflowexecutionhistory to get this?","createdAt":"2021-12-07T19:35:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/357#issuecomment-988210818","viewerDidAuthor":false},{"id":"IC_kwDOEujx18466SYC","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Yes but this isn't accessible to workflows","createdAt":"2021-12-08T00:02:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/357#issuecomment-988358146","viewerDidAuthor":false},{"id":"IC_kwDOEujx1849Fa9Y","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Related: \r\n\r\n> We should give `Workflow.isContinueAsNewNeeded` flag to the SDKs. And it should be coming from the service.\r\n\r\nhttps://temporaltechnologies.slack.com/archives/C01FT8U10GK/p1643400086752909?thread_ts=1643398281.925129&cid=C01FT8U10GK","createdAt":"2022-01-29T04:31:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/357#issuecomment-1024831320","viewerDidAuthor":false},{"id":"IC_kwDOEujx1849LPaw","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Corresponding sdk-features issue: https://github.com/temporalio/sdk-features/issues/16","createdAt":"2022-02-01T00:43:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/357#issuecomment-1026356912","viewerDidAuthor":false},{"id":"IC_kwDOEujx185C6p_A","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Length we can expose now, size is waiting on it being provided by the server, which should come soon.","createdAt":"2022-05-10T17:25:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/357#issuecomment-1122672576","viewerDidAuthor":false},{"id":"IC_kwDOEujx185DIHdc","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"> Length we can expose now, size is waiting on it being provided by the server, which should come soon.\r\n\r\nObtaining the history length from the SDK would already be a huge improvement.\r\n\r\nRight now, in long running workflows, we need to \"estimate\" the history length so that we can `continueAsNew()` once we reach some arbitrary threshold. Determining an appropriate threshold is not _per se_ the issue here: it can be simply assumed that you have to continue as new after 10000 events... Lower this number if your workflow deals with large payloads...\r\n\r\nEstimating the history length, however, is the hard part at present. There is simply no good and simple way to do it.","createdAt":"2022-05-13T15:53:27Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/357#issuecomment-1126201180","viewerDidAuthor":false},{"id":"IC_kwDOEujx185EKuKU","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"In case it might be useful to someone else, it is possible to get a pretty good estimate of the history length using the following workflow interceptor:\r\n\r\n```\r\nimport { WorkflowInterceptors } from '@temporalio/workflow';\r\n\r\nlet historyLength = 0;\r\n\r\nexport const interceptors = (): WorkflowInterceptors => ({\r\n    internals: [\r\n        {\r\n            activate(input, next) {\r\n                // +2 events per activation (WorkflowTaskScheduled and WorkflowTaskStarted)\r\n                if (input.batchIndex === 0) historyLength += 2;\r\n\r\n                // +1 event for each incoming \"job\", ie.:\r\n                //\r\n                // (history event type) ................ (job type)\r\n                // ----------------------------------------------------\r\n                // WorkflowExecutionStarted ............ startWorkflow\r\n                // WorkflowExecutionSignaled ........... signalWorkflow\r\n                // ChildWorkflowExecutionStarted ....... resolveChildWorkflowExecutionStart\r\n                // ExternalWorkflowExecutionSignaled ... resolveSignalExternalWorkflow\r\n                // TimerFired .......................... fireTimer\r\n                // WorkflowTaskCompleted ............... resolveActivity\r\n                // ChildWorkflowExecutionStarted ....... resolveChildWorkflowExecution\r\n                // ...\r\n                //\r\n                historyLength += input.activation.jobs?.length ?? 0;\r\n\r\n                // Note that some [uncommon] incoming events does not result in a 'job'.\r\n                // The estimate may therefore be inaccurate. Can't do much about it.\r\n\r\n                return next(input);\r\n            },\r\n            concludeActivation(input, next) {\r\n                // +1 event per conclusion (WorkflowTaskCompleted)\r\n                historyLength += 1;\r\n\r\n                // +1 event for each outgoing \"command\", ie.:\r\n                //\r\n                // (command type) ...................... (history event type)\r\n                // ----------------------------------------------------\r\n                // startChildWorkflowExecution ......... StartStartChildWorkflowExecutionInitiated\r\n                // signalExternalWorkflowExecution ..... SignalExternalWorkflowExecution\r\n                // startTimer .......................... TimerStarted\r\n                // ...\r\n                //\r\n                historyLength += input.commands?.length ?? 0;\r\n\r\n                return next(input);\r\n            },\r\n        },\r\n    ],\r\n});\r\n\r\nexport function getTemporalHistoryLength() {\r\n    return historyLength;\r\n}\r\n```","createdAt":"2022-06-01T14:08:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/357#issuecomment-1143661204","viewerDidAuthor":false}],"createdAt":"2021-11-03T19:06:54Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":{"number":6,"title":"1.0","description":"","dueOn":null},"number":357,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"[Feature Request] Expose history size to Workflow code","updatedAt":"2022-06-01T17:58:40Z","url":"https://github.com/temporalio/sdk-typescript/issues/357"}
