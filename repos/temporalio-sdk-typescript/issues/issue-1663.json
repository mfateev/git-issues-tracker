{"assignees":[],"author":{"id":"MDQ6VXNlcjEwNjY3NDcy","is_bot":false,"login":"pn1k","name":""},"body":"### What are you really trying to do?\n\nMake a copy of value in workflow code with structuredClone() function of nodejs.\n\n### Describe the bug\n\nIt seems that webpack'ed code lack of structuredClone function.\n\n### Minimal Reproduction\n\n// in workflow code\nconst someData = { foo: 'bar' }\nconst cloneData = structuredClone(someData);\n\n### Environment/Versions\n- Node 22.14.0\n- OS and processor: Linux x86\n- Temporal SDK: 1.11.7\n\n","closedAt":null,"comments":[{"id":"IC_kwDOEujx186nd0B_","author":{"login":"lukeramsden"},"authorAssociation":"CONTRIBUTOR","body":"I've just found this too, trying to use structuredClone to copy some input arrays that are then modified inside a class. @mjameswh is there any reason not to expose this in the workflow sandbox same as we did for TextDecoder etc? I can open a PR to do that.","createdAt":"2025-04-16T13:33:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1663#issuecomment-2809610367","viewerDidAuthor":false},{"id":"IC_kwDOEujx186neASW","author":{"login":"lukeramsden"},"authorAssociation":"CONTRIBUTOR","body":"```diff\ndiff --git a/node_modules/@temporalio/worker/lib/workflow/reusable-vm.js b/node_modules/@temporalio/worker/lib/workflow/reusable-vm.js\nindex f3a06d6..8fb90fd 100644\n--- a/node_modules/@temporalio/worker/lib/workflow/reusable-vm.js\n+++ b/node_modules/@temporalio/worker/lib/workflow/reusable-vm.js\n@@ -60,6 +60,7 @@ class ReusableVMWorkflowCreator {\n             TextEncoder: node_util_1.TextEncoder,\n             TextDecoder: node_util_1.TextDecoder,\n             AbortController,\n+            structuredClone,\n         };\n         this._context = node_vm_1.default.createContext(globals, { microtaskMode: 'afterEvaluate' });\n         this.injectConsole();\ndiff --git a/node_modules/@temporalio/worker/lib/workflow/vm.js b/node_modules/@temporalio/worker/lib/workflow/vm.js\nindex 239aa90..21e2655 100644\n--- a/node_modules/@temporalio/worker/lib/workflow/vm.js\n+++ b/node_modules/@temporalio/worker/lib/workflow/vm.js\n@@ -69,6 +69,7 @@ class VMWorkflowCreator {\n             TextEncoder: node_util_1.TextEncoder,\n             TextDecoder: node_util_1.TextDecoder,\n             AbortController,\n+            structuredClone,\n         };\n         const context = node_vm_1.default.createContext(globals, { microtaskMode: 'afterEvaluate' });\n         this.script.runInContext(context);\n```\n\nIf you use patch-package, this is a patch that will get this working. Testing myself in our system it all seems to work fine.","createdAt":"2025-04-16T13:51:03Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1663#issuecomment-2809660566","viewerDidAuthor":false},{"id":"IC_kwDOEujx186rz-ti","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"_This is a summary from [this](https://temporalio.slack.com/archives/C01DKSMU94L/p1745351976943959) Slack conversation._\n\nIf the `structuredClone` function is injected this way, cloned objects prototypes will be associated with the wrong execution context, which means that `instanceof` will always return `false`, even for built-in types.\n\nFor example (this was executed ):\n\n```\nlet x = { a: [1], b: new Error(), c: new Date() };\nlet y = structuredClone(x);\n\n[x, y].map((z) => (z instanceof Object)\n => [true, false]\n\n[x, y].map((z) => (z.a instanceof Array)\n => [true, false]\n\n[x, y].map((z) => (z.b instanceof Error)\n => [true, false]\n\n[x, y].map((z) => (z.c instanceof Date)\n => [true, false]\n```\n\nWe have [a utility function](https://github.com/mjameswh/sdk-typescript/blob/4dcc82aa48fc285119978bd2a93acc3a0e9fd231/packages/workflow/src/worker-interface.ts#L165) that we use internally to recursively fix some well known prototypes on objects being transferred from an outer execution context. However, using that over `structuredClone` would break the contract of `structuredClone`, i.e. a single object reachable through multiple paths inside a source object graph should be cloned to a single object in the resulting graph. The `fixPrototypes` function could also fall in a never ending loop if the source graph contains self reference loops.\n\nFor those reasons, the best approach at this time is to load a polyfill.","createdAt":"2025-05-15T05:34:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1663#issuecomment-2882530146","viewerDidAuthor":false},{"id":"IC_kwDOEujx186r2XQY","author":{"login":"lukeramsden"},"authorAssociation":"CONTRIBUTOR","body":"Fascinating - didn't know that. I would say that's worth documenting since I think this will come up again a lot. Going to replace my patch with a poly-fill.","createdAt":"2025-05-15T09:24:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1663#issuecomment-2883154968","viewerDidAuthor":false},{"id":"IC_kwDOEujx186r829F","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"> I would say that's worth documenting since I think this will come up again a lot.\n\nYeah, been thinking about this for some time. We definitely need to provide more clarity regarding what expectations hold inside the workflow sandbox and why some things are not provided. Our current claim about only exposing \"APIs that are deterministic-safe\" is too imprecise, and not sufficient since there are other constraints at play.","createdAt":"2025-05-15T19:28:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1663#issuecomment-2884857669","viewerDidAuthor":false}],"createdAt":"2025-04-01T20:10:23Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1663,"reactionGroups":[],"state":"OPEN","title":"[Bug] Can't use structuredClone in workflow code","updatedAt":"2025-05-15T19:28:24Z","url":"https://github.com/temporalio/sdk-typescript/issues/1663"}
