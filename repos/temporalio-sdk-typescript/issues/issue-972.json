{"assignees":[],"author":{"id":"MDQ6VXNlcjE5NzE4ODg0","is_bot":false,"login":"ksapchuk","name":"Kirill"},"body":"### What are you really trying to do?\r\nWe are trying to use the `temporal_activity_schedule_to_start_latency` metric to measure how behind our workers are in picking up activities.\r\n\r\n### Describe the bug\r\nIf the activities are failing with retries the `temporal_activity_schedule_to_start_latency` metric reports high schedule to start latency despite there being no scheduling delays. Is the SDK using the activity's first run start time for calculating the activity retries' schedule to start latency? \r\n\r\n### Minimal Reproduction\r\nA failing workflow with activity retries\r\n```\r\nconst { fail } = proxyActivities<typeof activities>({\r\n  startToCloseTimeout: '5 minutes',\r\n  retry:{\r\n    maximumAttempts: 5,\r\n    initialInterval: '10 seconds',\r\n    backoffCoefficient: 1,\r\n  }\r\n});\r\n\r\nexport async function logSampleWorkflow(): Promise<void> {\r\n  await fail();\r\n}\r\n```\r\n\r\nAn activity that always fails \r\n```\r\nexport async function greet(): Promise<void> {\r\n  throw Error('failing');\r\n}\r\n```\r\n\r\nThe worker runtime is setup with prometheus telemetry.\r\n```\r\n  Runtime.install({\r\n    telemetryOptions: {\r\n      metrics: {\r\n        prometheus: { bindAddress: '0.0.0.0:9464' },\r\n      },\r\n    },\r\n  });\r\n```\r\n\r\nAfter running the workflow `curl localhost:9464/metrics` to see the metric values. A bunch of retries land in the last activity bucket and the total activity latency is 60 seconds despite the activities starting immediately after their retry window. \r\n```# TYPE temporal_activity_schedule_to_start_latency histogram\r\ntemporal_activity_schedule_to_start_latency_bucket{namespace=\"default\",service_name=\"temporal-core-sdk\",task_queue=\"instrumentation\",le=\"100\"} 1\r\ntemporal_activity_schedule_to_start_latency_bucket{namespace=\"default\",service_name=\"temporal-core-sdk\",task_queue=\"instrumentation\",le=\"500\"} 1\r\ntemporal_activity_schedule_to_start_latency_bucket{namespace=\"default\",service_name=\"temporal-core-sdk\",task_queue=\"instrumentation\",le=\"1000\"} 1\r\ntemporal_activity_schedule_to_start_latency_bucket{namespace=\"default\",service_name=\"temporal-core-sdk\",task_queue=\"instrumentation\",le=\"5000\"} 1\r\ntemporal_activity_schedule_to_start_latency_bucket{namespace=\"default\",service_name=\"temporal-core-sdk\",task_queue=\"instrumentation\",le=\"10000\"} 1\r\ntemporal_activity_schedule_to_start_latency_bucket{namespace=\"default\",service_name=\"temporal-core-sdk\",task_queue=\"instrumentation\",le=\"+Inf\"} 4\r\ntemporal_activity_schedule_to_start_latency_sum{namespace=\"default\",service_name=\"temporal-core-sdk\",task_queue=\"instrumentation\"} 60251\r\ntemporal_activity_schedule_to_start_latency_count{namespace=\"default\",service_name=\"temporal-core-sdk\",task_queue=\"instrumentation\"} 4\r\n```\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: M1 Mac\r\n- Temporal Version: 1.18.1 \r\n- Typescript SDK 1.4.4\r\n","closedAt":"2022-11-21T16:28:51Z","comments":[{"id":"IC_kwDOEujx185OsnVM","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"The SDK is using the time the activity was first scheduled:\r\n\r\nhttps://github.com/temporalio/api/blob/9645a99d585b426ebb7555b8f61f5b1ed1aa42af/temporal/api/workflowservice/v1/request_response.proto#L365-L366\r\n\r\nThere's also this which might be more useful to you.\r\n\r\n```\r\n    // When was this task attempt scheduled\r\n    google.protobuf.Timestamp current_attempt_scheduled_time = 11 [(gogoproto.stdtime) = true];\r\n```\r\n\r\nI don't think this is a bug, it should be by design, I'll double check what we do in other SDKs.","createdAt":"2022-11-18T17:27:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/972#issuecomment-1320318284","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Os2JU","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Update: after checking other SDKs, looks like they're using the `current_attempt_scheduled_time`.\r\nSee linked Core PR which corrects this behavior.","createdAt":"2022-11-18T18:22:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/972#issuecomment-1320378964","viewerDidAuthor":false}],"createdAt":"2022-11-18T02:40:32Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":972,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Activity schedule to start metric incorrect during retries ","updatedAt":"2022-11-21T16:28:51Z","url":"https://github.com/temporalio/sdk-typescript/issues/972"}
