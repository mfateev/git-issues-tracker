{"assignees":[],"author":{"id":"MDQ6VXNlcjE1ODk1MA==","is_bot":false,"login":"airhorns","name":"Harry Brundage"},"body":"### What are you really trying to do?\r\n\r\nIntegrate temporal workflows into an existing TypeScript application tested using jest\r\n\r\n### Describe the bug\r\n\r\nI am able to create and complete workflows in one jest test file using helpers similar to those found in `sdk-typescript`'s repo, but as soon as I start using the client / workers in multiple jest test files, I get strange `ShutdownError: Core is shut down` or `ShutdownError: Core is shut down and there are no more workflow replay tasks` errors. These errors seem to occur after the workers have successfully completed open workflows and activities, and seem to happen somewhat inconsistently.\r\n\r\n### Minimal Reproduction\r\n\r\nFind a repro here: https://github.com/airhorns/temporal-jest\r\n\r\nYou must run multiple test files at once to trigger the issue.\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: macOS 12.3.1, Intel Core i7\r\n- Temporal Version: temporalite with `@temporalio/worker@0.21.1`\r\n- No docker, k8s\r\n\r\n### Additional context\r\n\r\njest uses some strange techniques to isolate each test suite (each *.test.js file) from each other. The tests run in the same process, but jest monkeypatches in a custom `require` function and evaluates the tests in a custom context, allowing each test file to muck with global state and not influence all the others. This is how jest supports their module mocking and a generally good practice for avoiding test flakes. That said, it can cause issues if code is not expecting to be required more than once, or somehow escapes their global state resetting approach. I am not sure it can be turned off for jest, but I do know that jest is a VERY popular test runner such that it'd be great to get support. See https://www.npmtrends.com/jest-vs-tap-vs-ava\r\n","closedAt":"2022-05-29T20:58:16Z","comments":[{"id":"IC_kwDOEujx185CY1Ei","author":{"login":"vkarpov15"},"authorAssociation":"CONTRIBUTOR","body":"I took a closer look at this and confirmed that https://github.com/airhorns/sdk-typescript/commit/3955acdd638b2d0e5c2e7c736f1bbd19a8d4549e does fix this issue. The root cause looks like one file's copy of the Temporal module is getting another file's copy of `errors`. I haven't been able to find a better workaround than the one @airhorns suggested.","createdAt":"2022-04-29T22:15:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/614#issuecomment-1113805090","viewerDidAuthor":false},{"id":"IC_kwDOEujx185DfX-z","author":{"login":"Irvenae"},"authorAssociation":"NONE","body":"+1 for getting this fixed. \r\nI am also running in this issue. Should we make a PR for this?","createdAt":"2022-05-19T23:32:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/614#issuecomment-1132298163","viewerDidAuthor":false},{"id":"IC_kwDOEujx185DfZq6","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Let's open a PR with @airhorns' fix","createdAt":"2022-05-19T23:47:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/614#issuecomment-1132305082","viewerDidAuthor":false},{"id":"IC_kwDOEujx185DfZuf","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I think @airhorns mentioned that it didn't fully work on slack, @airhorns can you confirm?","createdAt":"2022-05-19T23:48:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/614#issuecomment-1132305311","viewerDidAuthor":false},{"id":"IC_kwDOEujx185DheDJ","author":{"login":"airhorns"},"authorAssociation":"NONE","body":"I think that might have been my mistake, just disabled the other mitigation I added beyond what we discussed and my big test suite still passed! Will open a PR","createdAt":"2022-05-20T12:31:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/614#issuecomment-1132847305","viewerDidAuthor":false}],"createdAt":"2022-04-26T14:23:53Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":614,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"[Bug] `ShutdownError: Core is shut down` error when running in jest ","updatedAt":"2022-05-29T20:58:16Z","url":"https://github.com/temporalio/sdk-typescript/issues/614"}
