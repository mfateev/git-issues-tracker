{"assignees":[{"id":"MDQ6VXNlcjUyMzA0","login":"bergundy","name":"Roey Berman","databaseId":0}],"author":{"id":"MDQ6VXNlcjUyMzA0","is_bot":false,"login":"bergundy","name":"Roey Berman"},"body":"At the moment we pass the SDK version as the default binary ID, we should use the WF bundle checksum and perhaps include activity code as part of the checksum.","closedAt":"2022-10-11T23:30:52Z","comments":[{"id":"IC_kwDOEujx1849uSnH","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"For worker/activity code, `require.cache` has all the file paths that have been loaded in the current process, which we could read the contents of from disk to hash. More discussion:\r\n\r\nhttps://temporaltechnologies.slack.com/archives/C01FG4BRQVB/p1644440779397319?thread_ts=1644439575.727109&cid=C01FG4BRQVB","createdAt":"2022-02-10T21:36:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/204#issuecomment-1035545031","viewerDidAuthor":false},{"id":"IC_kwDOEujx1849udag","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"FWIW this same concern applies to Python too. I would like to avoid reading all files or even walking the disk stat'ing them if at all possible (ntm it assumes you are running somewhere with a disk just like it assumes you are running nodejs, but we have already made those assumptions). I cannot find a way in Python to access contents of the modules without re-reading the files, I am unsure if `require.cache` makes any of that info available. But if we had to, you can possibly just get a hash of file names and each file's mtime to avoid reading entire files.","createdAt":"2022-02-10T22:19:33Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/204#issuecomment-1035589280","viewerDidAuthor":false},{"id":"IC_kwDOEujx1849ue-o","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"![image](https://user-images.githubusercontent.com/251288/153507206-2cc43a2f-4768-4849-bd9c-347d0b627cf9.png)\r\n\r\npath & mtime sounds good.","createdAt":"2022-02-10T22:27:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/204#issuecomment-1035595688","viewerDidAuthor":false},{"id":"IC_kwDOEujx1849uuGY","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"I believe mtime will be quite unreliable in terms of being stable across different worker deployments which have the same code.\r\n\r\nOne of (perhaps the most) the common use cases here is \"I just deployed a bunch of (the same) workers with this new stuff, they broke things, and I want to find/reset all workflows they messed up\". So, ending up with a consistent id for all the workers in such a deployment is very desirable. \r\n\r\nThe versioning stuff we're going to work on probably makes that a lot easier eventually, but that will always require some amount of manual specification by users, whereas this is ideally fully automatic (albeit less meaningful). \r\n\r\nSo, to the extent we can make that scenario work automatically, I think it's worth even doing something like loading up and hashing files. Practically speaking I think it's pretty low cost since you're only doing it on startup and the size of user wf code isn't exactly huge in \"hash these files\" terms. We're still talking only a few hundred ms even using slow spinny disks with _megabytes_ of workflow code, which seems unlikely. Practically speaking the OS will keep them cached so we're not really reading them from disk twice.","createdAt":"2022-02-10T23:58:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/204#issuecomment-1035657624","viewerDidAuthor":false},{"id":"IC_kwDOEujx1849u0MU","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"> I believe mtime will be quite unreliable in terms of being stable across different worker deployments which have the same code.\r\n\r\nAh, good point","createdAt":"2022-02-11T00:41:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/204#issuecomment-1035682580","viewerDidAuthor":false},{"id":"IC_kwDOEujx1849xCBz","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"True. It's a bit gross, but so long as you can override I guess it'll be ok.\r\n\r\nAlso, some deployments/packages do codegen that they then import that might have a \"generated at XX\" comment on it that'll break the hash. If cheap enough to use machine representation instead of source representation (it'll by bytecode in Python), I think we should. But I don't see where that's available in Node and I don't think it's reasonable to add a parse step.","createdAt":"2022-02-11T14:23:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/204#issuecomment-1036263539","viewerDidAuthor":false},{"id":"IC_kwDOEujx185MBRD2","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I think what we do now is good enough (using sha sum of the workflow bundle and SDK version).\r\n\r\nhttps://github.com/temporalio/sdk-typescript/blob/dc63e490a22655fbdfa9e7fce4fa6f6fe57f2c92/packages/worker/src/worker.ts#L161\r\n\r\nWe can reopen if anyone feels the current approach is lacking.","createdAt":"2022-10-11T23:30:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/204#issuecomment-1275400438","viewerDidAuthor":false}],"createdAt":"2021-08-24T12:59:57Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":204,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Set the correct worker binary ID","updatedAt":"2022-10-11T23:30:52Z","url":"https://github.com/temporalio/sdk-typescript/issues/204"}
