{"assignees":[],"author":{"id":"MDQ6VXNlcjI4Njc5","is_bot":false,"login":"joebowbeer","name":"Joe Bowbeer"},"body":"### What are you really trying to do?\r\n\r\nUnit testing workflow using jest and TestWorkflowEnvironment\r\n\r\n### Describe the bug\r\n\r\njest is likely to timeout the first time I run the tests\r\n\r\n### Minimal Reproduction\r\n\r\n```bash\r\ngit checkout https://github.com/temporal/temporal-pendulum\r\ncd position-node\r\nnvm use\r\nnpm i\r\nnpm t\r\n```\r\n\r\nOn the first run, I see timeout failures:\r\n\r\n```\r\n  2022-06-27T20:13:26.565908Z  WARN temporal_sdk_core::worker::workflow: Task not found when completing, error: status: NotFound, message: \"Completed workflow\", details: [], metadata: MetadataMap { headers: {\"content-type\": \"application/grpc\"} }, run_id: \"5d3c6943-1da7-43ab-b5cf-344429e4fa4a\"\r\n```\r\n\r\n  ✕ pendulum exitSignal (5006 ms)\r\n  ✕ pendulum getGameInfoQuery (1575 ms)\r\n  ✓ pendulum updateGameInfoSignal (323 ms)\r\n\r\n![fail](https://user-images.githubusercontent.com/28679/176031519-e5b19ab7-51a2-48bf-9a6c-3699ddfbb886.png)\r\n\r\nThe next time it usually passes:\r\n\r\n  ✓ pendulum exitSignal (839 ms)\r\n  ✓ pendulum getGameInfoQuery (338 ms)\r\n  ✓ pendulum updateGameInfoSignal (312 ms)\r\n\r\n![pass](https://user-images.githubusercontent.com/28679/176031542-304f72ff-6982-48e6-abd2-0221327856ee.png)\r\n\r\n### Environment/Versions\r\n\r\nM1 Mac\r\n@temporal/testing 1.0.0-rc.0 \r\nNode 16.15.1\r\n\r\n### Additional context\r\n\r\nIs there a race starting the test env?\r\nIs there a timeout I can/should increase?","closedAt":"2022-10-03T13:08:13Z","comments":[{"id":"IC_kwDOEujx185GUu0B","author":{"login":"vkarpov15"},"authorAssociation":"CONTRIBUTOR","body":"@joebowbeer I'm unable to repro this on either my mac or my linux box. For example, below is my output running `npm test` on temporal-pendulum after a clean install:\r\n\r\n```\r\n$ npm test\r\n\r\n> position-node@0.2.0 test /Users/val/Workspace/temporalio/temporal-pendulum/position-node\r\n> NODE_OPTIONS=--experimental-vm-modules jest\r\n\r\n(node:26895) ExperimentalWarning: VM Modules is an experimental feature. This feature could change at any time\r\n(Use `node --trace-warnings ...` to show where the warning was created)\r\n\r\n RUNS  src/workflows.test.ts\r\n  2022-07-11T00:26:28.902615Z  WARN temporal_sdk_core::worker::workflow::workflow_stream: WFT poller died, shutting down\r\n RUNS  src/workflows.test.ts\r\n  2022-07-11T00:26:30.480330Z  WARN temporal_sdk_core::worker::workflow::workflow_stream: WFT poller died, shutting down\r\n RUNS  src/workflows.test.ts\r\n  2022-07-11T00:26:31.970849Z  WARN temporal_sdk_core::worker::workflow::workflow_stream: WFT poller d PASS  src/workflows.test.ts (15.569 s)\r\n  ✓ gameInfo without overrides (2 ms)\r\n  ✓ gameInfo with overrides (1 ms)\r\n  ✓ pendulum exitSignal (3733 ms)\r\n  ✓ pendulum getGameInfoQuery (1570 ms)\r\n  ✓ pendulum updateGameInfoSignal (1493 ms)\r\n\r\n--------------|---------|----------|---------|---------|-------------------\r\nFile          | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s \r\n--------------|---------|----------|---------|---------|-------------------\r\nAll files     |   51.72 |      100 |       0 |   51.72 |                   \r\n workflows.ts |   51.72 |      100 |       0 |   51.72 | 29-56             \r\n--------------|---------|----------|---------|---------|-------------------\r\nTest Suites: 1 passed, 1 total\r\nTests:       5 passed, 5 total\r\nSnapshots:   0 total\r\nTime:        15.808 s\r\nRan all test suites.\r\n$ npm test\r\n\r\n> position-node@0.2.0 test /Users/val/Workspace/temporalio/temporal-pendulum/position-node\r\n> NODE_OPTIONS=--experimental-vm-modules jest\r\n\r\n(node:26920) ExperimentalWarning: VM Modules is an experimental feature. This feature could change at any time\r\n(Use `node --trace-warnings ...` to show where the warning was created)\r\n\r\n RUNS  src/workflows.test.ts\r\n  2022-07-11T00:26:49.897900Z  WARN temporal_sdk_core::worker::workflow::workflow_stream: WFT poller died, shutting down\r\n RUNS  src/workflows.test.ts\r\n  2022-07-11T00:26:51.311469Z  WARN temporal_sdk_core::worker::workflow::workflow_stream: WFT poller died, shutting down\r\n RUNS  src/workflows.test.ts\r\n  2022-07-11T00:26:52.602291Z  WARN temporal_sdk_core::worker::workflow::workflow_stream: WFT poller d PASS  src/workflows.test.ts (14.429 s)\r\n  ✓ gameInfo without overrides (3 ms)\r\n  ✓ gameInfo with overrides\r\n  ✓ pendulum exitSignal (3622 ms)\r\n  ✓ pendulum getGameInfoQuery (1417 ms)\r\n  ✓ pendulum updateGameInfoSignal (1288 ms)\r\n\r\n--------------|---------|----------|---------|---------|-------------------\r\nFile          | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s \r\n--------------|---------|----------|---------|---------|-------------------\r\nAll files     |   51.72 |      100 |       0 |   51.72 |                   \r\n workflows.ts |   51.72 |      100 |       0 |   51.72 | 29-56             \r\n--------------|---------|----------|---------|---------|-------------------\r\nTest Suites: 1 passed, 1 total\r\nTests:       5 passed, 5 total\r\nSnapshots:   0 total\r\nTime:        14.718 s, estimated 16 s\r\nRan all test suites.\r\n$ \r\n$ \r\n$ \r\n$ npm test\r\n\r\n> position-node@0.2.0 test /Users/val/Workspace/temporalio/temporal-pendulum/position-node\r\n> NODE_OPTIONS=--experimental-vm-modules jest\r\n\r\n(node:27004) ExperimentalWarning: VM Modules is an experimental feature. This feature could change at any time\r\n(Use `node --trace-warnings ...` to show where the warning was created)\r\n\r\n RUNS  src/workflows.test.ts\r\n  2022-07-11T00:28:28.392233Z  WARN temporal_sdk_core::worker::workflow::workflow_stream: WFT poller died, shutting down\r\n RUNS  src/workflows.test.ts\r\n  2022-07-11T00:28:29.883512Z  WARN temporal_sdk_core::worker::workflow::workflow_stream: WFT poller died, shutting down\r\n RUNS  src/workflows.test.ts\r\n  2022-07-11T00:28:31.279849Z  WARN temporal_sdk_core::worker::workflow::workflow_stream: WFT poller d PASS  src/workflows.test.ts (14.787 s)\r\n  ✓ gameInfo without overrides (2 ms)\r\n  ✓ gameInfo with overrides\r\n  ✓ pendulum exitSignal (3706 ms)\r\n  ✓ pendulum getGameInfoQuery (1488 ms)\r\n  ✓ pendulum updateGameInfoSignal (1477 ms)\r\n\r\n--------------|---------|----------|---------|---------|-------------------\r\nFile          | % Stmts | % Branch | % Funcs | % Lines | Uncovered Line #s \r\n--------------|---------|----------|---------|---------|-------------------\r\nAll files     |   51.72 |      100 |       0 |   51.72 |                   \r\n workflows.ts |   51.72 |      100 |       0 |   51.72 | 29-56             \r\n--------------|---------|----------|---------|---------|-------------------\r\nTest Suites: 1 passed, 1 total\r\nTests:       5 passed, 5 total\r\nSnapshots:   0 total\r\nTime:        15.109 s\r\nRan all test suites.\r\n$ \r\n```\r\n\r\nThe tests are slow, but seem to work. Couple of potential explanations:\r\n\r\n1. Can you try increasing the test timeout using `jest.setTimeout(15000)`? \r\n2. All the examples in the [testing docs](https://docs.temporal.io/typescript/testing) use `execute()` instead of `start()`, because [`start()` starts the workflow in \"normal time\" as opposed to \"skipped time\"](https://github.com/temporalio/documentation/pull/1252). Maybe worthwhile to try using the [pattern I use in temporal-ecommerce-ts for testing queries and signals](https://github.com/vkarpov15/temporal-ecommerce-ts/blob/95b7be70d0b2a8d95cea93ec719453c94fa68f2e/src/test/workflows.test.ts#L65-L80) rather than `runUntil()`?","createdAt":"2022-07-11T00:40:15Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/728#issuecomment-1179839745","viewerDidAuthor":false},{"id":"IC_kwDOEujx185GVTSu","author":{"login":"joebowbeer"},"authorAssociation":"CONTRIBUTOR","body":"@vkarpov15 wrote:\r\n\r\n> The tests are slow, but seem to work.\r\n\r\n> Can you try increasing the test timeout using jest.setTimeout(15000)?\r\n\r\nThanks for looking into it. I'll play with jest's `testTimeout` next time I have an opportunity. This can be configured in `jest.config.js`. However, I just tried to repro in GitPod and I'm not seeing the timeout at the moment.\r\n\r\n> All the examples in the [testing docs](https://docs.temporal.io/typescript/testing) use execute() instead of start(), because https://github.com/temporalio/documentation/pull/1252. Maybe worthwhile to try using the [pattern I use in temporal-ecommerce-ts for testing queries and signals](https://github.com/vkarpov15/temporal-ecommerce-ts/blob/95b7be70d0b2a8d95cea93ec719453c94fa68f2e/src/test/workflows.test.ts#L65-L80) rather than runUntil()?\r\n\r\nI use `start` because this workflow does not complete until it is signaled.\r\n\r\nThanks for showing me the pattern. LGTM but I don't like that each test leaves a dangling workflow (right?). It would be more hermetic for `afterEach` to complete the workflow.","createdAt":"2022-07-11T05:42:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/728#issuecomment-1179989166","viewerDidAuthor":false},{"id":"IC_kwDOEujx185GaKwr","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"@vkarpov15 you can still use runUntil, although if you have multiple tests in the same file each creating their own worker I’d suggest bundling the workflows once during setup because that could take up a lot of resources  ","createdAt":"2022-07-12T03:11:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/728#issuecomment-1181264939","viewerDidAuthor":false},{"id":"IC_kwDOEujx185GaK7S","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I generally wouldn’t recommend leaving dangling workflows around in tests but it’s okayish when using the ephemeral test server ","createdAt":"2022-07-12T03:12:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/728#issuecomment-1181265618","viewerDidAuthor":false},{"id":"IC_kwDOEujx185LbK0r","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"We’ve redone the test framework in 1.3.0. And haven’t been able to reproduce this, closing until this is reproducible.","createdAt":"2022-10-03T13:08:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/728#issuecomment-1265413419","viewerDidAuthor":false}],"createdAt":"2022-06-27T20:40:15Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":728,"reactionGroups":[],"state":"CLOSED","title":"[Bug] jest times-out on first run of TestWorkflowEnvironment","updatedAt":"2022-10-03T13:08:14Z","url":"https://github.com/temporalio/sdk-typescript/issues/728"}
