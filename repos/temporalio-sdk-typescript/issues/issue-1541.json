{"assignees":[],"author":{"id":"MDQ6VXNlcjYwNTk5MDc1","is_bot":false,"login":"jainshivsagar","name":""},"body":"### What are you really trying to do?\r\n\r\nWe are using the TypeScript SDK v1.9.0 for our temporal worker.\r\nWe are doing the load testing in the local System. At the start of the worker the Memory(or Heap) utilization was <120MB, post the load testing, the Memory(or Heap) increased to ~300MB. After 5-10 minutes of load testing the memory utilization didn't come down.\r\nPlease refer to the below screenshots of Chrome DevTool(Memory Profiler):-\r\n\r\nMemory Utilization after starting the worker:-\r\n\r\n![image](https://github.com/user-attachments/assets/22394454-9cbe-4fa2-8aef-581f0ec32418)\r\n\r\nMemory Utilization after load testing:-\r\n![image](https://github.com/user-attachments/assets/f8cb4fc1-319b-4fbb-aae3-463f42bb1458)\r\n\r\n\r\nComparison of first two Heap snapshots:-\r\n![image](https://github.com/user-attachments/assets/c304481c-e0e0-414f-96f7-aff0ef22295a)\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: 2.6 GHz 6-Core Intel Core i7, MacOs Sequoia(v15.0.1)\r\n- Temporal Version: Temporal TypeScript SDK v1.9.0\r\n- We running the worker in K8 nodes on the Staging/Prod ENV.\r\n\r\n### Worker Configurations:-\r\n```\r\n  const worker = await Worker.create({\r\n    connection,\r\n    namespace: config.Temporal.Namespace,\r\n    taskQueue: config.Temporal.TaskQueue,\r\n    workflowsPath: require.resolve('./workflows'),\r\n    activities: getActivities(),\r\n    // maxActivitiesPerSecond: 100,\r\n    // maxTaskQueueActivitiesPerSecond: 100,\r\n    // maxConcurrentActivityTaskExecutions: 2000,\r\n    maxConcurrentWorkflowTaskExecutions: 200,\r\n    maxConcurrentWorkflowTaskPolls: 100,\r\n    // maxConcurrentActivityTaskPolls: 1000,\r\n    // maxCachedWorkflows: 3000,\r\n    maxConcurrentLocalActivityExecutions: 200,\r\n    // workflowThreadPoolSize: 100,\r\n    enableNonLocalActivities: false\r\n  });\r\n```\r\n","closedAt":"2024-12-17T21:33:51Z","comments":[{"id":"IC_kwDOEujx186PG3a4","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":">  After 5-10 minutes of load testing the memory utilization didn't come down.\r\n\r\nWhat happens if you continue feeding workflows to the worker? Does memory continue to go up, or does it stay stable around some value, e.g. ~300MB?\r\n\r\nThe Worker caches Workflows in an LRU; a Workflow stays in the cache until it gets evicted either 1) to make room for another workflow that’s coming in, or 2) because processing of a Workflow Task failed. Completion of a Workflow doesn’t result in eviction.\r\n\r\nThat means that, assuming there’s no Workflow Task failures, the sticky cache size should quickly grow up to its maximum value, and then stay at that number for very long period of time (i.e. until the pod gets shutdown).","createdAt":"2024-10-08T22:40:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1541#issuecomment-2400941752","viewerDidAuthor":false},{"id":"IC_kwDOEujx186PIxQb","author":{"login":"jainshivsagar"},"authorAssociation":"NONE","body":"Hi @mjameswh ,\r\nI posted the above data after 3-4 rounds of load testing. After each round of testing, I observed that heap memory utilization was growing incrementally. After the 4th round of testing  & waiting for 5-10 mins, the heap memory utilization didn't come down.","createdAt":"2024-10-09T06:37:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1541#issuecomment-2401440795","viewerDidAuthor":false},{"id":"IC_kwDOEujx186P7WOk","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"> waiting for 5-10 mins, the heap memory utilization didn't come down.\r\n\r\nAs I said before, we do not expect a Worker's memory usage to come down once a Workflow has completed. Completed Workflows may still be queried, so caching them may still be beneficial.\r\n\r\nWhat we'd expect is for memory usage to grow until the cache size reaches its maximum capacity (`maxCachedWorkflows`), after which memory usage should remain relatively stable, as less recently used Workflows will get evicted from cache.\r\n\r\n> After each round of testing, I observed that heap memory utilization was growing incrementally.\r\n\r\n- How many Workflows get started per round?\r\n- What is the capacity of your workflow cache? i.e. `maxCachedWorkflows`? If unsure, look at your Worker Options printed to logs on Worker start.\r\n- Can you please try this with SDK 1.11.2?\r\n- In your heap snapshot, how many instances of `VMWorkflowThreadProxy` do you have? How many instances of `Activity`?\r\n\r\nYour screenshot indicates 43'890 instances of `OperatorSubscriber`. That's certainly a lot, yet could still be legitimate, depending on the number of cached Workflows; there are multiple `OperatorSubscriber` per cached Workflows and per pending Activities.\r\n\r\n- At which point in your test sequence was your heap snapshot taken?\r\n- By any chance, would it be possible for you to share your heap snapshot file? If you are a Temporal Cloud user, you may open a Zendesk ticket and include the file as a secure attachment.\r\n- Otherwise, could you please try to provide reproduction code that demonstrates this issue?","createdAt":"2024-10-15T18:13:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1541#issuecomment-2414699428","viewerDidAuthor":false},{"id":"IC_kwDOEujx186SiHIE","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"@jainshivsagar Are you still observing issues, or may we close this ticket?","createdAt":"2024-11-05T23:38:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1541#issuecomment-2458415620","viewerDidAuthor":false},{"id":"IC_kwDOEujx186X-RDr","author":{"login":"josh-berry"},"authorAssociation":"NONE","body":"Closing since we haven't heard back.","createdAt":"2024-12-17T21:33:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1541#issuecomment-2549682411","viewerDidAuthor":false}],"createdAt":"2024-10-08T07:39:13Z","labels":[],"milestone":null,"number":1541,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Memory leak on the temporal worker side(OperatorSubscriber Class Objects are taking much of the memory)","updatedAt":"2024-12-17T21:33:52Z","url":"https://github.com/temporalio/sdk-typescript/issues/1541"}
