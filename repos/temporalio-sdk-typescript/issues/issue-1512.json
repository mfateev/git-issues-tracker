{"assignees":[],"author":{"id":"MDQ6VXNlcjExODYwODQ=","is_bot":false,"login":"ikonst","name":"Ilya Priven"},"body":"### What are you really trying to do?\r\n\r\nUse the EJSON payload converter to serialize all my payload (including error details) without risking my workers crashing.\r\n\r\n**Why?** I'm using `ApplicationError`'s `details` to marshal exceptions from activity to workflow. Sometimes due to our own bugs and inattentiveness, we'd try to pass arbitrary objects (non necessarily JSONfiable) as the \"details\".\r\n\r\n### Describe the bug\r\n\r\nI've used the EJSON payload converter almost verbatim in my code. The converter throws an error when the payload cannot be converted (due to unknown type, cyclic JSON etc.):\r\n```ts\r\nthrow new UnsupportedEjsonTypeError(\r\n  `Can't run EJSON.stringify on this value: ${value}. Either convert it (or its properties) to EJSON-serializable values (see https://docs.meteor.com/api/ejson.html ), or create a custom data converter. EJSON.stringify error message: ${\r\n    errorMessage(\r\n      e,\r\n    )\r\n  }`,\r\n  e as Error,\r\n);\r\n```\r\n\r\nIf this occurs when converting an activity's response, no harm done since this will be caught by the try-catch that's responsible for catching all of the activity's errors.\r\n\r\nHowever, if this happens when encoding e.g. the `details` of an `ApplicationError`, this error will escape the `Worker.run` and effectively crash the worker.\r\n\r\n### Minimal Reproduction\r\n\r\nFrom your activity:\r\n```\r\nconst cyclic: any = {};\r\ncyclic[\"self\"] = cyclic;\r\nthrow ApplicationFailure.create({\r\n  message: \"some error\",\r\n  type: \"SomeError\",\r\n  nonRetryable: true,\r\n  details: [cyclic],\r\n});\r\n```\r\n\r\n### Environment/Versions\r\n\r\nVersion 1.9.3","closedAt":null,"comments":[],"createdAt":"2024-09-11T18:55:27Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1512,"reactionGroups":[],"state":"OPEN","title":"[Bug] Payload converter error can crash worker","updatedAt":"2024-09-11T18:55:27Z","url":"https://github.com/temporalio/sdk-typescript/issues/1512"}
