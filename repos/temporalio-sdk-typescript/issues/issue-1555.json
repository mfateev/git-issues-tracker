{"assignees":[],"author":{"id":"MDQ6VXNlcjUyNDAyNzI2","is_bot":false,"login":"ianmateusES","name":"Ian Mateus"},"body":"## Required\r\n\r\n**What is the issue?**\r\n\r\n**How can we reproduce the issue?**\r\n\r\nCreate a long-running workflow with a signal and start it. Then, make some changes to that signal and use `patched` to point to the new version.\r\n\r\n**What is the expected behavior?**\r\n\r\n\r\n\r\n## Example\r\n\r\n\r\n\r\n## Additional context (optionalâ€”the more we know, the faster it goes)\r\n\r\n**Screenshots:**\r\nN/A\r\n\r\n**Browser and version:**\r\nN/A\r\n\r\n**Device and screen size:**\r\nN/A\r\n\r\n\r\n\r\n## Expected Behavior\r\nExisting workflows are expected to use the previous signal flow, while new ones are redirected by `patched`. However, what happens is that they all end up going to the new flow, since `patched` always returns true.\r\n\r\n## Actual Behavior\r\nHow patched works inside the setHandler of a Signal. For every patchId set, wf.patched(patchId) returns true\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n- Workflow v1:\r\n\r\n```js\r\nimport { sleep, defineSignal, defineQuery, setHandler, log, patched } from '@temporalio/workflow';\r\n\r\nexport const updateMessage = defineSignal<[string]>('updateMessage');\r\nexport const query = defineQuery('query');\r\n\r\nexport async function longRunningWorkflow(): Promise<void> {\r\n  let message = 'Initial message';\r\n\r\n  setHandler(updateMessage, (newMessage: string) => {\r\n    message = newMessage;\r\n  });\r\n\r\n  setHandler(query, () => message);\r\n\r\n  await sleep(10 * 60 * 1000);\r\n}\r\n```\r\n\r\n- Workflow v2:\r\n\r\n```js\r\nimport { sleep, defineSignal, defineQuery, setHandler, log, patched } from '@temporalio/workflow';\r\n\r\nexport const updateMessage = defineSignal<[string]>('updateMessage');\r\nexport const query = defineQuery('query');\r\n\r\nexport async function longRunningWorkflow(): Promise<void> {\r\n  let message = 'Initial message';\r\n\r\n  setHandler(updateMessage, (newMessage: string) => {\r\n    if (patched('v2')) {\r\n      log.info('Workflow was patched');\r\n      message = newMessage + ' v2';\r\n    } else {\r\n      message = newMessage;\r\n    }\r\n  });\r\n\r\n  setHandler(query, () => message);\r\n\r\n  await sleep(10 * 60 * 1000);\r\n}\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: 1.8.0\r\n  - Platform: Docker v27.3.1\r\n","closedAt":"2025-01-21T22:48:46Z","comments":[{"id":"IC_kwDOEujx186SiQrv","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"I can't reproduce an incorrect behavior with the code you provided.\r\n\r\nYour report indicates you are using TS SDK 1.8.0. I think you are most likely hitting a bug that was fixed in 1.8.5 (see #1234).\r\n\r\nCan you please try this with TS SDK v1.11.3? Or if you want to remain on 1.8.x, please update to 1.8.6.","createdAt":"2024-11-06T00:18:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1555#issuecomment-2458454767","viewerDidAuthor":false},{"id":"IC_kwDOEujx186X-RcA","author":{"login":"josh-berry"},"authorAssociation":"NONE","body":"Hi @ianmateusES, did upgrading the SDK resolve this for you?","createdAt":"2024-12-17T21:34:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1555#issuecomment-2549683968","viewerDidAuthor":false},{"id":"IC_kwDOEujx186bUtmT","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Closing as we believe this was fixed in v1.8.6.","createdAt":"2025-01-21T22:48:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1555#issuecomment-2605898131","viewerDidAuthor":false}],"createdAt":"2024-09-30T19:03:40Z","labels":[],"milestone":null,"number":1555,"reactionGroups":[],"state":"CLOSED","title":"patched always true inside Signal","updatedAt":"2025-01-21T22:48:47Z","url":"https://github.com/temporalio/sdk-typescript/issues/1555"}
