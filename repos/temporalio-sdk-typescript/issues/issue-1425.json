{"assignees":[],"author":{"id":"MDQ6VXNlcjQ5MjY4Nw==","is_bot":false,"login":"lucaskatayama","name":"Lucas Katayama"},"body":"### What are you really trying to do?\r\n\r\nGet OpenTelemetry `trace_id` and `span_id` fields on Workflow **logs**.\r\n\r\n### Describe the bug\r\n\r\nThe tracing fields from OpenTelemetry (`trace_id` and `span_id`) is not appearing on Workflow logs specifically.\r\n\r\nIt works on Client and Activities.\r\n\r\nCalling `worflow.log.error`:\r\n```json\r\n{\"label\":\"workflow\",\"level\":\"error\",\"message\":\"hello\",\"namespace\":\"default\",\"runId\":\"add5d842-ca36-4fee-8e51-624d7b2bb58c\",\"sdkComponent\":\"workflow\",\"taskQueue\":\"interceptors-opentelemetry-example\",\"timestamp\":1716328238734,\"workflowId\":\"otel-example-0\",\"workflowType\":\"example\"}\r\n```\r\n\r\nCalling `activity.log.error`\r\n```json\r\n{\"activityId\":\"1\",\"activityType\":\"greet\",\"attempt\":1,\"isLocal\":false,\"label\":\"activity\",\"level\":\"error\",\"message\":\"alskjdbnkajsdbnkjandsjk\",\"namespace\":\"default\",\"sdkComponent\":\"activity\",\"span_id\":\"10036d093b04a315\",\"taskQueue\":\"interceptors-opentelemetry-example\",\"taskToken\":\"CiRjYmI4ODI1My0wOWMyLTRiMzMtOWI3YS05MTQ5ODFhMzdjM2USDm90ZWwtZXhhbXBsZS0wGiRhZGQ1ZDg0Mi1jYTM2LTRmZWUtOGU1MS02MjRkN2IyYmI1OGMgBSgBMgExQgVncmVldEoICAEQxo5AGAE=\",\"timestamp\":1716328238737,\"trace_flags\":\"01\",\"trace_id\":\"f2731bb716c062624923e55b29f8fcec\",\"workflowId\":\"otel-example-0\",\"workflowRunId\":\"add5d842-ca36-4fee-8e51-624d7b2bb58c\",\"workflowType\":\"example\"}\r\n```\r\n\r\nWhich gives `\"span_id\":\"10036d093b04a315\"` and `\"trace_id\":\"f2731bb716c062624923e55b29f8fcec\"`.\r\n\r\n### Minimal Reproduction\r\n\r\n1. From  `interceptors-opentelemetry` sample: https://github.com/temporalio/samples-typescript/tree/main/interceptors-opentelemetry\r\n2. Enable OpenTelemetry Auto Instrumentation for JS for `winston` (https://opentelemetry.io/docs/languages/js/automatic/)\r\n\r\n```\r\nexport OTEL_NODE_RESOURCE_DETECTORS=\"env,host,os,serviceinstance\"\r\nexport OTEL_SERVICE_NAME=\"client\"\r\nexport NODE_OPTIONS=\"--require @opentelemetry/auto-instrumentations-node/register\"\r\nexport OTEL_NODE_ENABLED_INSTRUMENTATIONS=\"winston,http\"\r\n```\r\n4. Enable `custom-logger` using https://github.com/temporalio/samples-typescript/tree/main/custom-logger\r\n5. Log on Workflow\r\n\r\n```typescript\r\nimport * as workflow from \"@temporalio/workflow\"\r\n\r\n// A workflow that simply calls an activity\r\nexport async function example(name: string): Promise<string> {\r\n  workflow.log.error(\"hello\");\r\n  return await greet(name);\r\n}\r\n```\r\n\r\n6. Log on Activity\r\n```typescript\r\nimport * as activity from \"@temporalio/activity\"\r\n\r\nexport async function greet(name: string): Promise<string> {\r\n  activity.log.error(\"alskjdbnkajsdbnkjandsjk\")\r\n  return `Hello, ${name}!`;\r\n}\r\n```\r\n\r\n7. Call client to execute workflow (`npm run workflow`)\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: M2 Mac\r\n- Temporal Version: \r\n```\r\n‚ùØ temporal --version\r\ntemporal version 0.12.0 (server 1.23.0) (ui 2.26.2)\r\n```\r\n- Are you using Docker or Kubernetes or building Temporal from source? No\r\n\r\n### Additional context\r\n\r\n- The trace_id and span_id are generated but they doesn't appear on logs and are being reported to newrelic correctly, because they appear on distributed tracing.\r\n\r\nFrom `ConsoleSpanExporter`\r\n```\r\n{\r\n  resource: { attributes: { 'service.name': 'interceptors-sample-worker' } },\r\n  traceId: 'd498bbf00762a58fc78c022804644789', <<<<<<<<<<\r\n  parentId: '38b7d260146c73e6', <<<<<<<<\r\n  traceState: undefined,\r\n  name: 'RunWorkflow:example',\r\n  id: 'aaa81665fd7d1198',\r\n  kind: 0,\r\n  timestamp: 1716328235467000,\r\n  duration: 46000,\r\n  attributes: {\r\n...\r\n{\r\n  resource: { attributes: { 'service.name': 'interceptors-sample-worker' } },\r\n  traceId: 'd498bbf00762a58fc78c022804644789',\r\n  parentId: 'aaa81665fd7d1198',\r\n  traceState: undefined,\r\n  name: 'StartActivity:greet',\r\n  id: 'aec76af986522d29',\r\n  kind: 0,\r\n\r\n```\r\n\r\n- I think is a problem with `winston` + `opentelemetry` on workflow context only, because it only occurs on Workflows... everywhere else is working.\r\n- I put the code here https://github.com/lucaskatayama/temporal-otel","closedAt":"2024-11-19T17:52:02Z","comments":[{"id":"IC_kwDOEujx185_MiL3","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"This is not a bug. It just can't work that way.\r\n\r\nIn the TS SDK, Workflows execute [in a sandboxed environment](https://docs.temporal.io/dev-guide/typescript/foundations#workflow-logic-requirements). Among other things, that implies that Workflow Code can't do any I/O, and therefore, [can't interact with a regular Node.js logger](https://docs.temporal.io/dev-guide/typescript/observability#logging-from-workflows).\r\n\r\nInstead, log messages emitted using the Workflow context logger are funneled through a [Workflow Sink](https://docs.temporal.io/dev-guide/typescript/observability#implementing-custom-logging-like-features-based-on-workflow-sinks) to the Runtime logger. Now, Sinks are an advanced feature of the TS SDK, but essentially, that means that messages are queued internally in the Workflow context for the duration of a Workflow Activation; at the end of an Activation, queued Sink Calls are passed from the Workflow Worker Thread, through a [V8 MessagePort](https://nodejs.org/docs/latest/api/worker_threads.html#class-messageport), back to the main SDK thread, where they get processed (in this case, passing them to the Runtime logger, which in your case would be an instance of Winston's Logger class).\r\n\r\nNote that, at the time that the call is actually passed to the Winston's Logger, execution is no longer contained by the OpenTelemetry call scope, and therefore, the OpenTelemetry Auto Instrumentation can't attach these calls to the parent context.\r\n\r\nNote also that the `@opentelemetry/auto-instrumentations-node` plugin can't reach into the Workflow sandbox, or get loaded there, as that plugin would bring in dependencies on various non-deterministic-safe modules.\r\n\r\n**The solution**\r\n\r\nWhat you can do instead is to register a `WorkflowOutboundInterceptor` on your Workflow Worker that intercepts the `getLogAttributes` function and injects the `trace_id` and `span_id` attributes from there. I think the following should work (untested):\r\n\r\n```\r\nexport class OpenTelemetryTraceInLogsWorkflowOutboundInterceptor implements WorkflowOutboundCallsInterceptor {\r\n  public getLogAttributes(\r\n    input: GetLogAttributesInput,\r\n    next: Next<WorkflowOutboundCallsInterceptor, 'getLogAttributes'>\r\n  ): Record<string, unknown> {\r\n    const span = otel.trace.getSpan(otel.context.active());\r\n    const spanContext = span?.spanContext();\r\n    if (spanContext && otel.isSpanContextValid(spanContext)) {\r\n      return next({\r\n        trace_id: spanContext.traceId,\r\n        span_id: spanContext.spanId,\r\n        trace_flags: `0${spanContext.traceFlags.toString(16)}`,\r\n        ...input,\r\n      });\r\n    } else {\r\n      return next(input);\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nI certainly agree that it would make sense to be done out of the box by our `@temporalio/interceptors-opentelemetry` Workflow Interceptor. I'll therefore keep this ticket open as a feature request.","createdAt":"2024-05-27T19:56:28Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}},{"content":"HOORAY","users":{"totalCount":1}},{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1425#issuecomment-2133992183","viewerDidAuthor":false},{"id":"IC_kwDOEujx185_Nr1q","author":{"login":"lucaskatayama"},"authorAssociation":"NONE","body":"> This is not a bug. It just can't work that way.\r\n> \r\n> In the TS SDK, Workflows execute [in a sandboxed environment](https://docs.temporal.io/dev-guide/typescript/foundations#workflow-logic-requirements). Among other things, that implies that Workflow Code can't do any I/O, and therefore, [can't interact with a regular Node.js logger](https://docs.temporal.io/dev-guide/typescript/observability#logging-from-workflows).\r\n> \r\n> Instead, log messages emitted using the Workflow context logger are funneled through a [Workflow Sink](https://docs.temporal.io/dev-guide/typescript/observability#implementing-custom-logging-like-features-based-on-workflow-sinks) to the Runtime logger. Now, Sinks are an advanced feature of the TS SDK, but essentially, that means that messages are queued internally in the Workflow context for the duration of a Workflow Activation; at the end of an Activation, queued Sink Calls are passed from the Workflow Worker Thread, through a [V8 MessagePort](https://nodejs.org/docs/latest/api/worker_threads.html#class-messageport), back to the main SDK thread, where they get processed (in this case, passing them to the Runtime logger, which in your case would be an instance of Winston's Logger class).\r\n> \r\n> Note that, at the time that the call is actually passed to the Winston's Logger, execution is no longer contained by the OpenTelemetry call scope, and therefore, the OpenTelemetry Auto Instrumentation can't attach these calls to the parent context.\r\n> \r\n> Note also that the `@opentelemetry/auto-instrumentations-node` plugin can't reach into the Workflow sandbox, or get loaded there, as that plugin would bring in dependencies on various non-deterministic-safe modules.\r\n> \r\n> **The solution**\r\n> \r\n> What you can do instead is to register a `WorkflowOutboundInterceptor` on your Workflow Worker that intercepts the `getLogAttributes` function and injects the `trace_id` and `span_id` attributes from there. I think the following should work (untested):\r\n> \r\n> ```\r\n> export class OpenTelemetryTraceInLogsWorkflowOutboundInterceptor implements WorkflowOutboundCallsInterceptor {\r\n>   public getLogAttributes(\r\n>     input: GetLogAttributesInput,\r\n>     next: Next<WorkflowOutboundCallsInterceptor, 'getLogAttributes'>\r\n>   ): Record<string, unknown> {\r\n>     const span = otel.trace.getSpan(otel.context.active());\r\n>     const spanContext = span?.spanContext();\r\n>     if (spanContext && otel.isSpanContextValid(spanContext)) {\r\n>       return next({\r\n>         input,\r\n>         trace_id: spanContext.traceId,\r\n>         span_id: spanContext.spanId,\r\n>         trace_flags: `0${spanContext.traceFlags.toString(16)}`,\r\n>       });\r\n>     } else {\r\n>       return next(input);\r\n>     }\r\n>   }\r\n> }\r\n> ```\r\n> \r\n> I certainly agree that it would make sense to be done out of the box by our `@temporalio/interceptors-opentelemetry` Workflow Interceptor. I'll therefore keep this ticket open as a feature request.\r\n\r\nYep... That WORKED @mjameswh !\r\n\r\nI think that piece of code could be in `@temporalio/interceptors-opentelemetry` ... Or at least documented ...\r\n\r\nThanks!\r\n\r\n","createdAt":"2024-05-28T03:42:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1425#issuecomment-2134293866","viewerDidAuthor":false},{"id":"IC_kwDOEujx186gaZ7k","author":{"login":"safareli"},"authorAssociation":"NONE","body":"I followed https://github.com/temporalio/samples-typescript/blob/main/interceptors-opentelemetry/src/worker.ts#L20\nand I do get traces but I do not get trace id's on logs emmited from workflows. did anyone made that part work?\n\nUPDATE:\n\nissue was that even tho we have trace and span id in logger, the node instrumentation  libs don't quite respect it I had to do this:\n\n\n```ts\nfunction timestampNanosToHrTime(timestampNanos: bigint): [number, number] {\n  // Calculate seconds by dividing nanoseconds by 1e9 and getting the whole number\n  const seconds = Number(timestampNanos / BigInt(1e9));\n\n  // Calculate remaining nanoseconds using modulo\n  const nanos = Number(timestampNanos % BigInt(1e9));\n\n  return [seconds, nanos];\n}\n\nconst logLevelToSeverityNumber = {\n  TRACE: SeverityNumber.TRACE,\n  DEBUG: SeverityNumber.DEBUG,\n  INFO: SeverityNumber.INFO,\n  WARN: SeverityNumber.WARN,\n  ERROR: SeverityNumber.ERROR,\n} as const;\n\n\n\n\nRuntime.install({\n  logger: new DefaultLogger(\"ERROR\", ({ message, ...entry_ }) => {\n      logs.getLogger(\"temporal-workflow\").emit({\n        severityNumber: logLevelToSeverityNumber[entry_.level],\n        body: message,\n        severityText: entry_.level.toLowerCase(),\n        timestamp: timestampNanosToHrTime(entry_.timestampNanos),\n        observedTimestamp: timestampNanosToHrTime(entry_.timestampNanos),\n        attributes: entry_.meta,\n      });\n    }),\n  ...\n```\n\n\nPR for reference https://github.com/temporalio/samples-typescript/pull/415","createdAt":"2025-02-28T18:17:43Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"ROCKET","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1425#issuecomment-2691276516","viewerDidAuthor":false}],"createdAt":"2024-05-21T22:23:16Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDEz","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1425,"reactionGroups":[],"state":"CLOSED","title":"[Feature Request] Add OTEL tracing information as attribute on log messages emitted using Workflow Logger","updatedAt":"2025-03-02T12:22:35Z","url":"https://github.com/temporalio/sdk-typescript/issues/1425"}
