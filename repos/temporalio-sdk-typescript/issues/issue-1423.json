{"assignees":[],"author":{"id":"MDQ6VXNlcjkxNDU3NDg2","is_bot":false,"login":"zijianzz","name":""},"body":"### What are you really trying to do?\r\n\r\n<!-- \r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\n-->\r\nUse condition with timeout inside nonCancellable scope, and wait a signal to unlock condition await\r\n\r\n### Describe the bug\r\n\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\nHello, I recently saw a weird behaviour which I don’t know if it’s normal or not because I didn’t find any documentation related to this subject. Here is a test code I used to reproduce this issue\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n```\r\nexport async function runCancellableActivity(): Promise<void> {\r\n  try {\r\n    await sleep(1000000);\r\n  } catch (err) {\r\n    await CancellationScope.nonCancellable(async () => {\r\n      try {\r\n        console.log('condition');\r\n        await condition(() => false, 10000); // worked good for => await condition(() => false);\r\n      } catch (error) {\r\n        console.log('still error', error);\r\n      }\r\n    });\r\n    throw err;\r\n  }\r\n}\r\n```\r\n### Minimal Reproduction\r\nmy condition is wrapped inside nonCancellable scope, if I understood well, CancelledFailure should never propagated into this scope but it’s not always the case, if I decide to give a timeout to my condition. my app did printed still error on console with CancelledFailure exception.\r\n\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor:  Mac Intel\r\n- Temporal Version: SDK 1.8.6 -> 1.9.2\r\n- Are you using Docker or Kubernetes or building Temporal from source? I used docker and locally host cluster\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n","closedAt":"2024-07-15T23:17:10Z","comments":[{"id":"IC_kwDOEujx185-kULP","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"What Node version?","createdAt":"2024-05-21T21:11:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1423#issuecomment-2123449039","viewerDidAuthor":false},{"id":"IC_kwDOEujx185-l9P8","author":{"login":"zijianzz"},"authorAssociation":"NONE","body":"> What Node version?\r\n\r\nI tested in both 16 and 18, I got the same result","createdAt":"2024-05-22T05:11:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1423#issuecomment-2123879420","viewerDidAuthor":false},{"id":"IC_kwDOEujx185-20b0","author":{"login":"cirias"},"authorAssociation":"NONE","body":"I run into the same issue. This is because the timeout feature in condition is implemented through a cancellable CancellationScope. And a cancellable CancellationScope cancels when any of its parent scope cancels, even when the parent is nonCancellable.\r\n\r\nThe problem is why a scope could still be cancelled even when it's inside a nonCancellable scope. Intuitively a cancellable scope in a nonCancellable scope should only be cancelled by call `cancel` method directly on the scope object.\r\n\r\nMy guess is, when the root scope is cancelled, the workflow should propagates the cancel to all cancellable scope even it's in a nonCancellable scope. But we probably need an option to disable this feature.","createdAt":"2024-05-24T01:03:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1423#issuecomment-2128299764","viewerDidAuthor":false},{"id":"IC_kwDOEujx185-23iu","author":{"login":"cirias"},"authorAssociation":"NONE","body":"@zijianzz I've been using this hack function as a walk-around.\r\n\r\n```\r\nasync function conditionTimeout(fn: () => boolean, timeout: Duration): Promise<void> {\r\n  // here should check all parents is cancellable\r\n  // in my use case this is enough\r\n  if (CancellationScope.current().cancellable) {\r\n    return condition(fn, timeout).then((pass) => {\r\n      if (!pass) {\r\n        throw ApplicationFailure.nonRetryable('condition timed out');\r\n      }\r\n    });\r\n  }\r\n\r\n  return Promise.race([\r\n    // it's impossible to cancel this sleep later after the race resolved,\r\n    // because if as long as you wrap it in a cancellable scope, it cancels immediately \r\n    // when any of the parent scopes cancelled, \r\n    // making it the same behavior as the original condition function.\r\n    sleep(timeout).then(() => {\r\n      throw ApplicationFailure.nonRetryable('condition timed out');\r\n    }),\r\n    condition(fn),\r\n  ]);\r\n}\r\n```","createdAt":"2024-05-24T01:21:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1423#issuecomment-2128312494","viewerDidAuthor":false},{"id":"IC_kwDOEujx185-8K3k","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Thanks for the repro. It looks like the behaviour for the cancelable/non-cancellable/cancellable case was never clearly defined, and the effective behaviour is definitively problematic. We'll discuss that internally.","createdAt":"2024-05-24T14:41:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1423#issuecomment-2129702372","viewerDidAuthor":false},{"id":"IC_kwDOEujx185-9o9e","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I don't think it was not clearly defined, just not properly implemented.\r\nWe'll need to fix this with a patch that ensures we don't break history compatibility.","createdAt":"2024-05-24T17:55:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1423#issuecomment-2130087774","viewerDidAuthor":false},{"id":"IC_kwDOEujx185_EJ0n","author":{"login":"cirias"},"authorAssociation":"NONE","body":"Thanks @mjameswh @bergundy ! While you discuss the cancellable/non-cancellable cases, please also consider the case of activity cancellation. Currently, to cancel an activity can only be achieved by calling it inside a cancelablescope. Given the current behavior of \"cancel on root cancels all\", we can't create a cancelable activity when the workflow is cancelled. Because the activity wrapped in a cancelablescope will be cancelled/skipped immediately.\r\n\r\nIn general, the problem is the during the cleanup process, when a workflow is cancelled, we still need the ability to control when to cancel some execution. For example, to use condition with timeout during the cleanup, or call an activity but also want to have the ability to cancel it later during the cleanup. Right now, since it cancels everything, we lose the control of cancellation.","createdAt":"2024-05-26T00:30:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1423#issuecomment-2131795239","viewerDidAuthor":false}],"createdAt":"2024-05-21T13:11:37Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1423,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Unexpected behaviour related to CancellationScope.nonCancellable","updatedAt":"2024-07-15T23:17:10Z","url":"https://github.com/temporalio/sdk-typescript/issues/1423"}
