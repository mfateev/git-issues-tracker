{"assignees":[],"author":{"id":"MDQ6VXNlcjg3ODMy","is_bot":false,"login":"NikhilVerma","name":"Nikhil Verma"},"body":"I run a series of workers on my Temporal pod bootup. They sometimes take up over 2GB of RAM simply from parsing the source maps. I've confirmed this using clinic.js.\n\n<img width=\"1800\" height=\"251\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/66606c1a-5d9e-4c11-bf92-958990222cd7\" />\n\nhttps://github.com/temporalio/sdk-typescript/blob/5473ebd3442d00624fb0ed20fa82f8d5bd78e8fd/packages/worker/src/worker.ts#L1868\n\nI am curious if there is a way to optionally allow turning off source maps? I can do so via the builder\n\n```\n\tconst { code } = await bundleWorkflowCode({\n\t\tworkflowsPath: worker.workflowsPath,\n\t\t// Remove source maps\n\t\twebpackConfigHook: config => {\n\t\t\tconfig.devtool = false;\n\t\t\treturn config;\n\t\t}\n\t});\n```\n\nBut then the extractSourceMap throws, and if I patch it I see further failures down the line in `addWorkflowBundle > SourceMapConsumer`\n\nI managed to patch it (in a dirty way)\n\n```js\n    return [code, JSON.stringify({\n            version: 3,\n            file: '',\n            sources: [],\n            mappings: '',\n    })];\n    // throw new Error(\"Can't extract inlined source map from the provided Workflow Bundle\");\n```\n\nWhich results in significantly lower bootup + IDLE ram usage\n\n\n## Before\n<img width=\"898\" height=\"229\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/f70c720e-a2fa-4de1-be23-96d17dfca737\" />\n\n\n## After\n<img width=\"905\" height=\"241\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/1ff2a405-5c93-41f9-9e5a-88e90c8b595a\" />","closedAt":null,"comments":[{"id":"IC_kwDOEujx186_s6UH","author":{"login":"SamuelMS"},"authorAssociation":"NONE","body":"Have you considered using `workflowBundle` over `workflowsPath` for production use?  e.g. compile the bundle in CI/CD ahead of time with Temporal's helper, then use that bundle with `workflowBundle: { codePath: '/app/worker/dist/workflows.cjs' }`.\n\n```typescript\nimport { bundleWorkflowCode } from '@temporalio/worker';\nimport { writeFile } from 'fs/promises';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nasync function bundle() {\n  const { code } = await bundleWorkflowCode({\n    workflowsPath: path.resolve(__dirname, './src/tasks/workflows.ts'),\n  });\n  const codePath = path.resolve(__dirname, './dist/workflows.cjs');\n\n  await writeFile(codePath, code);\n  console.log(`Bundle written to ${codePath}`);\n}\n\nbundle().catch((error) => {\n  console.error('Bundle compilation failed:', error);\n  process.exit(1);\n});\n```\n\nFrankly, I'm not sure if this'll help your RAM usage with sourcemaps, but we haven't noticed any spikes in RAM with the above approach (for a fairly massive app, at that).","createdAt":"2025-08-23T04:06:34Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1772#issuecomment-3216221447","viewerDidAuthor":false},{"id":"IC_kwDOEujx186_x7jD","author":{"login":"NikhilVerma"},"authorAssociation":"NONE","body":"@SamuelMS Actually I've tested this exclusively on the workflow bundle (because the source maps parsing happens on the bundle as well)\n\nhttps://github.com/temporalio/sdk-typescript/blob/5473ebd3442d00624fb0ed20fa82f8d5bd78e8fd/packages/worker/src/worker.ts#L729C1-L736C8\n\nYou would primarily see this issue if you run multiple workers in the same machine, this the default strategy before we can start having worker specific pods. My workaround has been to load workers synchronously with a `global.gc` call in between them, it has kept the memory pressure under 1.8GB for now which works for us for the time being.","createdAt":"2025-08-24T01:27:49Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1772#issuecomment-3217537219","viewerDidAuthor":false},{"id":"IC_kwDOEujx186__sck","author":{"login":"SamuelMS"},"authorAssociation":"NONE","body":"> [@SamuelMS](https://github.com/SamuelMS) Actually I've tested this exclusively on the workflow bundle (because the source maps parsing happens on the bundle as well)\n> \n> https://github.com/temporalio/sdk-typescript/blob/5473ebd3442d00624fb0ed20fa82f8d5bd78e8fd/packages/worker/src/worker.ts#L729C1-L736C8\n> \n> You would primarily see this issue if you run multiple workers in the same machine, this the default strategy before we can start having worker specific pods. My workaround has been to load workers synchronously with a `global.gc` call in between them, it has kept the memory pressure under 1.8GB for now which works for us for the time being.\n\nWe run multiple workers on our nodes, but use PM2 in cluster mode to manage them: https://pm2.keymetrics.io/docs/usage/cluster-mode/","createdAt":"2025-08-25T17:35:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1772#issuecomment-3221145380","viewerDidAuthor":false}],"createdAt":"2025-08-22T17:09:02Z","labels":[],"milestone":null,"number":1772,"reactionGroups":[],"state":"OPEN","title":"extractSourceMap takes a huge amount of RAM on boot","updatedAt":"2025-08-25T17:35:49Z","url":"https://github.com/temporalio/sdk-typescript/issues/1772"}
