{"assignees":[{"id":"MDQ6VXNlcjE2MjAyNjU=","login":"vkarpov15","name":"Valeri Karpov","databaseId":0}],"author":{"id":"MDQ6VXNlcjMwOTgwOA==","is_bot":false,"login":"bennidhamma","name":"Ben Joldersma"},"body":"### What are you really trying to do?\r\n\r\nTrying to get `@temporalio/nyc-test-coverage` working with our typescript temporal jest tests. \r\n\r\n### Describe the bug\r\n\r\nAfter following the instructions in the [package readme](https://github.com/temporalio/sdk-typescript/blob/main/packages/nyc-test-coverage/README.md), no coverage is generated.\r\n\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n\r\n### Minimal Reproduction\r\n\r\nI've generated a minimal repro draft PR: https://github.com/temporalio/samples-typescript/pull/192\r\n\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: Linux x86_64\r\n- Temporal Version: 1.1.0\r\n- using temporal test server\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n","closedAt":"2022-09-17T22:15:58Z","comments":[{"id":"IC_kwDOEujx185JS3A2","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Sorry, that's hopefully fixed in https://github.com/temporalio/sdk-typescript/pull/843 , which I can release Tuesday","createdAt":"2022-08-29T02:36:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/852#issuecomment-1229680694","viewerDidAuthor":false},{"id":"IC_kwDOEujx185JS64l","author":{"login":"bennidhamma"},"authorAssociation":"NONE","body":"I don't /think/ so? I pulled the repo down, built and linked the nyc-test-coverage package directly in locally and still don't get any workflow coverage in the activities-examples sample project jest tests.","createdAt":"2022-08-29T03:05:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/852#issuecomment-1229696549","viewerDidAuthor":false},{"id":"IC_kwDOEujx185JS9Rs","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I haven’t tried this package, it was contributed by @vkarpov15.\r\nIn the readme he put instructions explaining how to use this with mocha, I’m not sure if it works with jest.","createdAt":"2022-08-29T03:18:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/852#issuecomment-1229706348","viewerDidAuthor":false},{"id":"IC_kwDOEujx185JTSiv","author":{"login":"bennidhamma"},"authorAssociation":"NONE","body":"@vkarpov15, do you know if nyc-test-coverage works with jest? Any chance you could update the activities-examples sample to work with it?","createdAt":"2022-08-29T05:26:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/852#issuecomment-1229793455","viewerDidAuthor":false},{"id":"IC_kwDOEujx185JWL0d","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Looking at how this is used, it seems like it should be supported in jest but I'd test and verify.\r\n@bennidhamma can you explain exactly what steps you took?\r\nDoes this work with mocha locally?","createdAt":"2022-08-29T16:33:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/852#issuecomment-1230552349","viewerDidAuthor":false},{"id":"IC_kwDOEujx185JXH_j","author":{"login":"vkarpov15"},"authorAssociation":"CONTRIBUTOR","body":"@bennidhamma we haven't tried it with Jest yet, I'll give it a shot and see if we can get it working.","createdAt":"2022-08-29T19:59:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/852#issuecomment-1230798819","viewerDidAuthor":false},{"id":"IC_kwDOEujx185JXIrv","author":{"login":"bennidhamma"},"authorAssociation":"NONE","body":"I'll take a look at mocha too!","createdAt":"2022-08-29T20:02:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/852#issuecomment-1230801647","viewerDidAuthor":false},{"id":"IC_kwDOEujx185JXo1F","author":{"login":"bennidhamma"},"authorAssociation":"NONE","body":"I was able to get it to run and generate output in mocha. But... it doesn't look like the body of the workflow function is being covered:\r\n![image](https://user-images.githubusercontent.com/309808/187309150-6f98c572-2e40-4f6f-86b8-93f8ebb1cad2.png)\r\n\r\n![image](https://user-images.githubusercontent.com/309808/187309047-61574bd4-2745-441e-a582-fe797beb1942.png)\r\n\r\n","createdAt":"2022-08-29T22:21:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/852#issuecomment-1230933317","viewerDidAuthor":false},{"id":"IC_kwDOEujx185JXxbk","author":{"login":"bennidhamma"},"authorAssociation":"NONE","body":"> @bennidhamma can you explain exactly what steps you took?\r\n1. install `nyc`, and `@temporalio/nyc-test-coverage` (note: I linked nyc-test-coverage from a local build with lib dir)\r\n2. add workflow coverage instrumentation interceptor, sink, and call merge in after function\r\n3. build\r\n4. run `nyc instrument lib lib --in-place`\r\n5. run mocha with `npx nyc --report-dir nyc-cov --reporter lcov --reporter=text-summary mocha \"lib/mocha/*.js\"`","createdAt":"2022-08-29T23:23:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/852#issuecomment-1230968548","viewerDidAuthor":false},{"id":"IC_kwDOEujx185JXx5p","author":{"login":"bennidhamma"},"authorAssociation":"NONE","body":"(mocha changes are also in https://github.com/temporalio/samples-typescript/pull/192)","createdAt":"2022-08-29T23:27:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/852#issuecomment-1230970473","viewerDidAuthor":false},{"id":"IC_kwDOEujx185JXzHO","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Thanks for looking into this @bennidhamma, I've assigned @vkarpov15 to it for further investigation.","createdAt":"2022-08-29T23:36:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/852#issuecomment-1230975438","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Ke1MO","author":{"login":"vkarpov15"},"authorAssociation":"CONTRIBUTOR","body":"@bennidhamma I'm unable to repro. I was thinking maybe there was some issue with using npx in step 5, but that doesn't seem to matter. Below is the output of running the last 3 steps with 8100ddc6c8bbe82d4b3dcfff84ed3721aa130511:\r\n\r\n```\r\n$ npm run build\r\n\r\n> temporal-activities-examples@0.1.0 build\r\n> tsc --build\r\n\r\n$ ./node_modules/.bin/nyc instrument lib lib --in-place\r\n$ npx nyc --report-dir nyc-cov --reporter lcov --reporter=text-summary mocha \"lib/mocha/*.js\"\r\n\r\n\r\n  example workflow\r\n    ✓ returns correct result\r\n    ✓ retries one failure\r\n    ✓ bubbles up activity errors\r\n\r\n\r\n  3 passing (2s)\r\n\r\n\r\n=============================== Coverage summary ===============================\r\nStatements   : 50% ( 22/44 )\r\nBranches     : 0% ( 0/4 )\r\nFunctions    : 30% ( 3/10 )\r\nLines        : 47.5% ( 19/40 )\r\n================================================================================\r\n$ \r\n\r\n```\r\n\r\nBelow is a screenshot of the lcov HTML report for `src/workflows.ts` from the `nyc-cov` directory. It does show that `httpWorkflow()` is executed during the tests.\r\n\r\n![image](https://user-images.githubusercontent.com/1620265/190690766-063179cb-177a-49ae-ba03-2af321314fa0.png)\r\n\r\nMy best guess is that you're somehow re-building after manually instrumenting.","createdAt":"2022-09-16T17:11:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/852#issuecomment-1249596174","viewerDidAuthor":false}],"createdAt":"2022-08-29T02:27:44Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":852,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"Unable to get @temporalio/nyc-test-coverage working in jest","updatedAt":"2022-09-17T22:15:58Z","url":"https://github.com/temporalio/sdk-typescript/issues/852"}
