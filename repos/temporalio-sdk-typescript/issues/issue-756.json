{"assignees":[],"author":{"id":"MDQ6VXNlcjE0NjM2MjI=","is_bot":false,"login":"mfateev","name":"Maxim Fateev"},"body":"### What are you really trying to do?\r\n\r\nA workflow is blocked on a condition.\r\n```\r\nawait wf.condition(() => <some expression>)\r\n```\r\nA workflow has to be updated to block on a different condition expression. The naive way of\r\n\r\n```\r\nawait wf.condition(() => patched(\"patchId\") ? <new expression> : <old expression>) \r\n```\r\nis not going to work. The problem is that condition is potentially called many times. And if the first time it is called the patch returns false then it will keep returning false even for the code that wasn't executed yet. A possible workaround is to use different patchId on every condition evaluation:\r\n\r\n```\r\nvar i = 0;\r\nawait wf.condition(() => patched(\"patchId\"+(i++)) ? <new expression> : <old expression>) \r\n```\r\n### Proposal \r\n\r\nDo not require setting different patchId on every condition evaluation. The SDK should internally generate a different patch id on every call or do something else to avoid the wrong behavior. \r\n","closedAt":"2024-02-01T19:09:36Z","comments":[{"id":"IC_kwDOEujx185GnAFB","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> The naive way of [...] is not going to work. The problem is that condition is potentially called many times. And if the first time it is called the patch returns false then it will keep returning false even for the code that wasn't executed yet. \r\n\r\n`patched` is safe for multiple executions and always gives the same bool value back for the same arguments for an entire workflow run from what I understand. Why is returning false all the time after the first time a bad thing? Is it possible to give a larger example showing how this would be a problem? I am a bit confused (may be due to my lack of understanding of how `patched` works).\r\n\r\n(one option here is to make `patched()` be async which would disallow its use in the supposed-to-be-side-effect-free non-async `condition()` callback)","createdAt":"2022-07-14T16:09:21Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/756#issuecomment-1184629057","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Go6Z1","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":">  Why is returning false all the time after the first time a bad thing?\r\n\r\nThis is the same problem as using patched in a loop:\r\n```\r\nfor (...) {\r\n   if (patched(\"foo\")) {\r\n       activity2(...);\r\n   } else {\r\n      activity1(...);\r\n  }\r\n}\r\n```\r\nIf the new code is deployed after a few iterations of the loop, the `activity2` will never be invoked even if loop makes a lot of new iterations. Users expect that each new iteration is going to use the new branch.\r\n\r\nThe issue is to allow using patched inside the condition to support the ability to update a condition expression _after_ the workflow is already blocked on the condition.\r\n\r\n","createdAt":"2022-07-15T03:11:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/756#issuecomment-1185130101","viewerDidAuthor":true},{"id":"IC_kwDOEujx185Go-AV","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"> Users expect that each new iteration is going to use the new branch.\r\n\r\nThis is what happens though, Iâ€™m not following ","createdAt":"2022-07-15T03:47:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/756#issuecomment-1185144853","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Go-o5","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"> The issue is to allow using patched inside the condition to support the ability to update a condition expression after the workflow is already blocked on the condition.\r\n\r\npatched already works this way today.\r\nIt evaluates to false during replay and once the marker is seen or workflow is no longer replaying it starts returning true. ","createdAt":"2022-07-15T03:55:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/756#issuecomment-1185147449","viewerDidAuthor":false},{"id":"IC_kwDOEujx185IhLqs","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"@mfateev can we close this?","createdAt":"2022-08-16T13:43:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/756#issuecomment-1216658092","viewerDidAuthor":false},{"id":"IC_kwDOEujx185yj_pG","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"That's already how TS SDK's `patch()` works.","createdAt":"2024-02-01T19:09:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/756#issuecomment-1922038342","viewerDidAuthor":false}],"createdAt":"2022-07-14T15:56:15Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":756,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"[Bug] Support patched API inside condition.","updatedAt":"2024-02-01T19:09:37Z","url":"https://github.com/temporalio/sdk-typescript/issues/756"}
