{"assignees":[{"id":"MDQ6VXNlcjY0MTIxNjk=","login":"mjameswh","name":"James Watkins-Harvey","databaseId":0}],"author":{"id":"MDQ6VXNlcjEwNTE5MTE=","is_bot":false,"login":"thehellmaker","name":"Akash Ashok"},"body":"### What are you really trying to do?\r\n\r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\nWe had a workflow in development where we were still developing on it. Older version of workflow is still running when we change the code of workflow and deployed it and we see a crash in the system\r\n\r\n\r\n### Describe the bug\r\nError: async hook stack has become corrupted (actual: 112970, expected: 3)\r\n 1: 0x10229dab8 node::AsyncHooks::FailWithCorruptedAsyncStack(double) [/Users/random/.nvm/versions/node/v16.16.0/bin/node]\r\n 2: 0x102232164 node::AsyncHooks::pop_async_context(double) [/Users/random/.nvm/versions/node/v16.16.0/bin/node]\r\n 3: 0x102231d8c node::InternalCallbackScope::Close() [/Users/random/.nvm/versions/node/v16.16.0/bin/node]\r\n 4: 0x10223266e node::InternalMakeCallback(node::Environment*, v8::Local<v8::Object>, v8::Local<v8::Object>, v8::Local<v8::Function>, int, v8::Local<v8::Value>*, node::async_context) [/Users/random/.nvm/versions/node/v16.16.0/bin/node]\r\n 5: 0x10224a238 node::AsyncWrap::MakeCallback(v8::Local<v8::Function>, int, v8::Local<v8::Value>*) [/Users/random/.nvm/versions/node/v16.16.0/bin/node]\r\n 6: 0x102346af6 node::worker::MessagePort::OnMessage(node::worker::MessagePort::MessageProcessingMode) [/Users/random/.nvm/versions/node/v16.16.0/bin/node]\r\n 7: 0x102cd275b uv__async_io [/Users/random/.nvm/versions/node/v16.16.0/bin/node]\r\n 8: 0x102ce654b uv__io_poll [/Users/random/.nvm/versions/node/v16.16.0/bin/node]\r\n 9: 0x102cd2ce1 uv_run [/Users/random/.nvm/versions/node/v16.16.0/bin/node]\r\n10: 0x102232f9f node::SpinEventLoop(node::Environment*) [/Users/random/.nvm/versions/node/v16.16.0/bin/node]\r\n11: 0x1023a9cae node::worker::Worker::Run() [/Users/random/.nvm/versions/node/v16.16.0/bin/node]\r\n12: 0x1023ad6a2 node::worker::Worker::StartThread(v8::FunctionCallbackInfo<v8::Value> const&)::$_3::__invoke(void*) [/Users/random/.nvm/versions/node/v16.16.0/bin/node]\r\n13: 0x7ff81c0e84e1 _pthread_start [/usr/lib/system/libsystem_pthread.dylib]\r\n14: 0x7ff81c0e3f6b thread_start [/usr/lib/system/libsystem_pthread.dylib]\r\n[nodemon] app crashed - waiting for file changes before starting...\r\n^C\r\n","closedAt":null,"comments":[{"id":"IC_kwDOEujx185NL-lO","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Interesting.. this looks like a Node.js issue, can you try running with different Node.js versions?","createdAt":"2022-10-28T13:13:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/939#issuecomment-1294985550","viewerDidAuthor":false},{"id":"IC_kwDOEujx185NMxjS","author":{"login":"thehellmaker"},"authorAssociation":"NONE","body":"Actually i figured out the issue. It was a bug in the worker code which lead to an infinite loop. But this should be handled better by temporal i feel with proper error messaging\r\n\r\nMy worker has a code like this\r\n\r\n```\r\nwhile(true) {\r\n        // FIX: currentState = WorkflowState.COMPLETE\r\n        await condition(() => currentState !== WorkflowState.COMPLETE);\r\n        if (currentState === WorkflowState.REVIEWED_AND_SAVED) {\r\n            // call an activity and\r\n            return response\r\n        }\r\n}\r\n```\r\n\r\nThe commented out line with // FIX:  is the fix\r\n\r\nThe problem here is \r\n\r\n- current state is updated by a Signal\r\n- When the signal sets the currentState to anything other than  WorkflowState.REVIEWED_AND_SAVED or  WorkflowState.COMPLETE then the condition clause is always satisfied and the if condition is never satisfied \r\n- The worker now goes into infinite loop without any condition waits.","createdAt":"2022-10-28T16:23:21Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/939#issuecomment-1295194322","viewerDidAuthor":false},{"id":"IC_kwDOEujx185NMz07","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I don't know how much we can handle this since it looks like the error happens deep in Node internals.\r\nI can see why this happens though.\r\nThanks for the report.\r\n\r\nThe SDK does protect you from tight loops by setting a timeout on workflow activations but looks like something else is going on here.\r\n\r\nIt looks like async_hooks and the vm context execution timeout clash.\r\nWe should try to reproduce this and see if there's anything the SDK can do or to mitigate this but I suspect the issue is an unhandled edge case in Node.js.","createdAt":"2022-10-28T16:32:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/939#issuecomment-1295203643","viewerDidAuthor":false},{"id":"IC_kwDOEujx185TmThf","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Here is a repro without `condition`:\r\n\r\n```\r\n// Fails with corrupted async stack\r\nexport async function testWorkflow(): Promise<void> {\r\n  while (true) {\r\n    await new CancellationScope({ cancellable: true }).run(() =>\r\n      Promise.resolve(true)\r\n    );\r\n  }\r\n}\r\n```\r\n\r\nThis is obviously an endless loop. I'd expect the WFT to ends with \"Error: Script execution timed out after 10000ms\", but instead get an async hook stack corruption, as described above.\r\n\r\nMy investigation got it down to an issue in node involving: vm + microtaskMode: 'afterEvaluate' + runInContext with timeout + AsyncLocalStorage. I know for sure that it happens after the runInContextâ€™s timeout fires. Seems like either the AsyncLocalStorage internal state is not properly cleaned up on context timeout, or there are still some live functions (probably native code) attached to that context's AsyncLocalStorage that tries to access the storage after it has been cleaned up.\r\n\r\nProposed solution to improve the error message is to replace Node's builtin but experimental implementation of AsyncLocalStorage with our own implementation.","createdAt":"2023-01-24T20:04:56Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/939#issuecomment-1402550367","viewerDidAuthor":false},{"id":"IC_kwDOEujx186ZeztN","author":{"login":"vymarkov"},"authorAssociation":"NONE","body":"Unfortunately I've faced with the same issue ","createdAt":"2025-01-07T10:56:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/939#issuecomment-2574990157","viewerDidAuthor":false},{"id":"IC_kwDOEujx186ZwQC1","author":{"login":"vymarkov"},"authorAssociation":"NONE","body":"@mjameswh I would like to add that we're currently use temporal sdk v1.11.5, we use AsyncLocalStorage which is a part of @temporalio/workflow package","createdAt":"2025-01-09T09:24:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/939#issuecomment-2579562677","viewerDidAuthor":false},{"id":"IC_kwDOEujx186Z0rhn","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"@vymarkov The way this error message shows up is certainly surprising, but the fact that you are getting this indicates that execution of your workflow code is timing out.\r\n\r\nTo be exact, a single call into the workflow sandbox takes more than 10 seconds to complete; that most invariably means that you have some endless loop with nothing in it to slow down looping. That's something you will need to figure out and fix by yourself.\r\n\r\nLook for the following:\r\n- Missing `await` on `sleep()`, activity execution, child workflows, and other APIs that returns `Promise`;\r\n- `await condition()` where the predicate function immediately evaluates to true.","createdAt":"2025-01-09T16:23:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/939#issuecomment-2580723815","viewerDidAuthor":false},{"id":"IC_kwDOEujx187XMjbM","author":{"login":"yash261"},"authorAssociation":"NONE","body":"Getting the same error but it is happening randomly. I am running the playwright script in the worker","createdAt":"2025-12-04T05:49:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/939#issuecomment-3610392268","viewerDidAuthor":false}],"createdAt":"2022-10-28T09:54:30Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":939,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"OPEN","title":"[Bug] Worker crashes with \"async hook stack has become corrupted\" on Workflow Task timeout","updatedAt":"2025-12-04T05:49:26Z","url":"https://github.com/temporalio/sdk-typescript/issues/939"}
