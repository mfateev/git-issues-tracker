{"assignees":[],"author":{"id":"MDQ6VXNlcjY0MTIxNjk=","is_bot":false,"login":"mjameswh","name":"James Watkins-Harvey"},"body":"### Describe the bug\r\n\r\nThrowing a non-Error and non-Failure exception and letting that exception bubble up out of the Workflow function causes activation failure (due to `DataCloneError`) if that object contains non-serializable objects.\r\n\r\nEven though a `Failed to activate workflow` error message mentioning `DataCloneError` is visible in the log, the original exception is not accessible, making it difficult to figure out the origin of the failure.\r\n\r\nWe need to figure out how this situation can be handled better.\r\n\r\nFor example:\r\n- We could consider serializing sink arguments immediately at the call site, rather than delaying that until completion of the activation, which would allow reporting the `DataCloneError` error in context (and also let's make that error message more obvious).\r\n- By using a custom Serializer object, it might be possible to intercept serialization errors, and automatically replace problematic object by some safe alternative (ie. a JSON representation of that object, a string saying that item could not be serialized, etc).\r\n\r\n### Minimal Reproduction\r\n\r\n1. Execute the following workflow\r\n\r\n```\r\nclass MyCustomError {\r\n  public readonly x: any;\r\n  constructor(public message: string) {\r\n    this.x = () => 1;\r\n  }\r\n}\r\n\r\nexport async function exampleWorkflow(): Promise<void> {\r\n  throw new MyCustomError('Intentional error');\r\n}\r\n```\r\n\r\n2. Observe that execution produces the following error:\r\n\r\n```\r\n2023-12-20T23:39:49.741Z [ERROR] Failed to activate workflow {\r\n  namespace: 'default',\r\n  taskQueue: 'hello-world',\r\n  workflowId: 'workflow-X0CYgbSxElPenLeMFU68e',\r\n  runId: '3fe2dbe4-8f71-4755-9bee-b6fc4d02cac4',\r\n  workflowType: 'example',\r\n  error: DataCloneError: ()=>1 could not be cloned.\r\n      at new DOMException (node:internal/per_context/domexception:53:5)\r\n      at MessagePort.<anonymous> (/Users/jwatkins/Development/Temporal/TypeScriptSDK/samples-typescript/hello-world/node_modules/@temporalio/worker/lib/workflow/workflow-worker-thread.js:92:20),\r\n  workflowExists: true\r\n}\r\n```\r\n\r\n3. Note that activation don't fail and no `DataCloneError` is thrown if the `MyCustomError` class is modified to extend `Error` (the workflow task still fails, which is expected), as follows:\r\n\r\n```\r\nclass MyCustomError extends Error {\r\n  public readonly x: any;\r\n\r\n  constructor(public message: string) {\r\n    super(message);\r\n    this.x = () => 1;\r\n  }\r\n}\r\n```\r\n\r\n### Details\r\n\r\nThere are few factors contributing to this issue:\r\n- The Workflow Worker automatically logs exceptions that bubble up out of the workflow function;\r\n- The V8 Serialization can't serialize some type of objects (including functions), and throws a `DataCloneError` on encountering a non-serializable object.\r\n- As the list of all sink calls is transferred from the worker thread to the main thread as a single message, the failure to encode a single object causes the whole operation to fail.","closedAt":null,"comments":[{"id":"IC_kwDOEujx185w3IaC","author":{"login":"jan-stehlik"},"authorAssociation":"NONE","body":"hey @mjameswh thanks for writing this up, we are experiencing the same behaviour. Do you have any idea when this might be picked up / prioritised? Thanks","createdAt":"2024-01-16T10:49:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1325#issuecomment-1893500546","viewerDidAuthor":false},{"id":"IC_kwDOEujx185xgDlc","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"@jan-stehlik If your workflow is throwing exceptions that results in a `DataCloneError`, then the proper thing to do is to intercept those exceptions and throw something that can be safely serialized using the V8 serialization algorithm, such as an `ApplicationFailure` or a class that extends `Error`.\r\n\r\nThis ticket is not about _resolving_ the fact that throwing non-serializable objects results in a `DataCloneError`, as this is inherent to the V8's serialization algorithm and we have pretty much no control on it, but rather to make it easier for users to understand these situations and figure out where the non-serializable object come from.","createdAt":"2024-01-22T15:20:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1325#issuecomment-1904228700","viewerDidAuthor":false},{"id":"IC_kwDOEujx186y3APx","author":{"login":"Jac0xb"},"authorAssociation":"NONE","body":"I got this same error from the following (reset to right before the error and got the callstack)\n\n```\n  at Object.condition (/app/node_modules/.pnpm/@temporalio+workflow@1.11.8/node_modules/@temporalio/workflow/src/workflow.ts:1051:32)\n    at condition (/app/backend/packages/temporal/src/transaction_indexer/head-sync.workflow.ts:74:40)\n\n    at race (/app/backend/packages/temporal/src/transaction_indexer/head-sync.workflow.ts:74:20)\n```\n\n\nThe Line\n\n```\nawait Promise.race([sleep(\"15s\"), condition(() => signaled)]);\n```\n\n\n```\n[temporal-worker] 2025-06-24T14:35:30.813Z [ERROR] Failed to process Worklow Activation {\n[temporal-worker]   sdkComponent: 'worker',\n[temporal-worker]   taskQueue: '-----',\n[temporal-worker]   runId: '5445c4de-3fcd-461f-a165-8f0acd6df6c5',\n[temporal-worker]   namespace: 'default',\n[temporal-worker]   workflowId: '6srGWWzz6aaEG2qjuBKdGQX7Dzenhnd9ZBVEeEJ6g9z2/head',\n[temporal-worker]   workflowType: 'headSyncWorkflow',\n[temporal-worker]   error: DataCloneError: [object Promise] could not be cloned.\n[temporal-worker]       at new DOMException (node:internal/per_context/domexception:53:5)\n[temporal-worker]       at MessagePort.<anonymous> (/app/node_modules/.pnpm/@temporalio+worker@1.11.8_@swc+helpers@0.5.17/node_modules/@temporalio/worker/lib/workflow/workflow-worker-thread.js:92:20),\n[temporal-worker]   workflowExists: true\n[temporal-worker] }\n```","createdAt":"2025-06-24T14:36:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1325#issuecomment-3000763377","viewerDidAuthor":false}],"createdAt":"2023-12-21T00:15:52Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1325,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"OPEN","title":"[Bug] Throwing an exception from a workflow may result in `Failed to activate workflow` due to `DataCloneError`","updatedAt":"2025-06-24T14:36:20Z","url":"https://github.com/temporalio/sdk-typescript/issues/1325"}
