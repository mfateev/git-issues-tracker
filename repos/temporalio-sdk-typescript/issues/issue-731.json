{"assignees":[],"author":{"id":"MDQ6VXNlcjI1MTI4OA==","is_bot":false,"login":"lorensr","name":"Loren ☺️"},"body":"Repro: https://github.com/temporalio/samples-typescript/compare/repro-local\r\n\r\nNote that `refreshAccessToken` adds to `tasks` array, which makes the condition true.\r\n\r\n```\r\ngit clone https://github.com/temporalio/samples-typescript.git\r\ncd samples-typescript/hello-world\r\ngit checkout repro-local\r\nnpm start\r\n```\r\n\r\n`npm run workflow`\r\n\r\nAfter 5 seconds, worker logs:\r\n\r\n```\r\nERROR temporal_sdk_core::worker::workflow::managed_run: Error in run machines, error: RunUpdateErr { source: Nondeterminism(\"Local activity machine cannot handle this event: HistoryEvent(id: 5, Some(TimerStarted))\"), complete_resp_chan: None }\r\n```\r\n\r\nevent history: https://www.dropbox.com/s/n37xushdt9jstq3/08edc8df-2e2e-4b6a-9cf8-af20e777ae2c_events.json?dl=0","closedAt":"2022-07-07T18:45:50Z","comments":[{"id":"IC_kwDOEujx185FtSgo","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Repro code, for posterity: \r\n\r\n```ts\r\n\r\nimport { condition, defineSignal, setHandler, proxyLocalActivities } from '@temporalio/workflow';\r\n\r\nconst { refreshAccessTokenLocalActivity } = proxyLocalActivities<typeof activities>({\r\n  startToCloseTimeout: '1 minute',\r\n});\r\n\r\nexport async function weirdWorkflowLoop() {\r\n  const tasks: any = [];\r\n  let token: any = {};\r\n  let refreshAccessTokenPromise: any;\r\n\r\n  function refreshAccessToken() {\r\n    if (refreshAccessTokenPromise === undefined) {\r\n      refreshAccessTokenPromise = (async () => {\r\n        token = await refreshAccessTokenLocalActivity(); //NOTE: In the real Workflow this function is called with proxyLocalActivity\r\n\r\n        tasks.push(() => {\r\n          //this is just so the condition at the end of the main forloop unlocks\r\n        });\r\n      })();\r\n    }\r\n  }\r\n\r\n  for (;;) {\r\n    while (tasks.length) {\r\n      const task = tasks.pop();\r\n      await handleTask(task);\r\n    }\r\n    refreshAccessToken(); // intentionally not awaited\r\n    // if (!token) refreshAccessToken();\r\n    await condition(() => tasks.length > 0, '30s');\r\n  }\r\n}\r\n\r\nasync function handleTask(task: string) {\r\n  console.log('performing task:', task);\r\n  return new Promise((r) => setTimeout(r, 100));\r\n}\r\n```\r\n\r\n```ts\r\nexport async function refreshAccessTokenLocalActivity(): Promise<any> {\r\n  console.log('refreshAccessTokenLocalActivity');\r\n  //This activity makes an http request so it can fetch an access token using the refreshToken\r\n  return new Promise((resolve) => setTimeout(() => resolve({ token: 'token-foo', status: 'configured' }), 5000));\r\n}\r\n```","createdAt":"2022-06-29T03:40:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/731#issuecomment-1169500200","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Fvn5y","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"In case this can still be useful, here is a much shorter version of the repro code, more applicable to unit testing:\r\n\r\n```\r\nimport { condition, proxyLocalActivities } from '@temporalio/workflow';\r\nimport type * as activities from './activities';\r\n\r\nconst { someLocalActivity } = proxyLocalActivities<typeof activities>({\r\n  startToCloseTimeout: '1 minute',\r\n});\r\n\r\nexport async function issue731workflow() {\r\n  let completed = false;\r\n\r\n  someLocalActivity()\r\n    .then(() => {\r\n      completed = true;\r\n    })\r\n    .catch(() => {\r\n      /* intentionnaly ignored */\r\n    });\r\n\r\n  await condition(() => completed, '30s');\r\n  await sleep(100);\r\n}\r\n```","createdAt":"2022-06-29T15:18:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/731#issuecomment-1170112114","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Fvtf9","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Thanks @mjameswh ","createdAt":"2022-06-29T15:36:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/731#issuecomment-1170135037","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Kj0R1","author":{"login":"JoshVee"},"authorAssociation":"NONE","body":"This is still happening in 1.2.0:\r\n```\r\n2022-09-19T11:26:32.518958Z ERROR temporal_sdk_core::worker::workflow::managed_run: Error in run machines, error: RunUpdateErr { source: Nondeterminism(\"Continue as new workflow machine does not handle this event: HistoryEvent(id: 30, Some(TimerStarted))\"), complete_resp_chan: Some(Sender { inner: Some(Inner { state: State { is_complete: false, is_closed: false, is_rx_task_set: true, is_tx_task_set: false } }) }) }\r\n```","createdAt":"2022-09-19T11:36:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/731#issuecomment-1250903157","viewerDidAuthor":false},{"id":"IC_kwDOEujx185KlTtU","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"> This is still happening in 1.2.0:\r\n> \r\n> ```\r\n> 2022-09-19T11:26:32.518958Z ERROR temporal_sdk_core::worker::workflow::managed_run: Error in run machines, error: RunUpdateErr { source: Nondeterminism(\"Continue as new workflow machine does not handle this event: HistoryEvent(id: 30, Some(TimerStarted))\"), complete_resp_chan: Some(Sender { inner: Some(Inner { state: State { is_complete: false, is_closed: false, is_rx_task_set: true, is_tx_task_set: false } }) }) }\r\n> ```\r\n\r\n@JoshVee This would be a different problem, and is very likely a result of nondeterminism in your workflow code (possibly due to deploying new, incompatible code), where it's choosing to continue as new but the existing history was starting some timer at that point. If you believe your code is deterministic & you did not deploy new incompatible code, feel free to open a different issue - ideally with some example workflow code & history. Thanks!","createdAt":"2022-09-19T16:59:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/731#issuecomment-1251294036","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Ksi5E","author":{"login":"JoshVee"},"authorAssociation":"NONE","body":"Thanks for the response @Sushisource. Seems like the issue was caused by workflows that had been originally started on the older SDK worker, but then `ContinuedAsNew` onto the v1.2.0 worker.","createdAt":"2022-09-21T04:31:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/731#issuecomment-1253191236","viewerDidAuthor":false}],"createdAt":"2022-06-27T23:52:49Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":6,"title":"1.0","description":"","dueOn":null},"number":731,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Nondeterminism error: Local activity machine can't handle TimerStarted","updatedAt":"2022-09-21T04:31:58Z","url":"https://github.com/temporalio/sdk-typescript/issues/731"}
