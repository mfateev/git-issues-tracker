{"assignees":[],"author":{"id":"MDQ6VXNlcjE3NzcyMTE=","is_bot":false,"login":"wenerme","name":"陈杨文"},"body":"### What are you really trying to do?\r\n\r\n<!-- \r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\n-->\r\n\r\n<details>\r\n\r\n<summary>First try</summary>\r\n\r\n\r\n> ReferenceError: __TEMPORAL__ is not defined\r\n\r\n```bash\r\npnpm esbuild --external:./dist/* --external:__* --bundle --outdir=dist/ --keep-names --format=cjs --sourcemap=inline --charset=utf8 --target=node16 --platform=node \\\r\n  --banner:js=\"module = typeof module === 'undefined'? {exports:{}}:module\" \\\r\n  ./src/entrypoint.ts\r\n```\r\n\r\n</details>\r\n\r\n**Second try**\r\n\r\n> Error: Dynamic require of \"__temporal_custom_payload_converter\" is not supported\r\n\r\n```bash\r\npnpm esbuild --external:__* --bundle --outdir=dist/ --keep-names --format=iife --sourcemap=inline --charset=utf8 -- \r\n target=chrome100 \\\r\n  --global-name=__TEMPORAL__ \\\r\n  ./src/server/workflows/entrypoint.ts\r\n```\r\n\r\n\r\nesbuild to not support the alias\r\n\r\nhttps://github.com/temporalio/sdk-typescript/blob/a5eedca5d4cfb5a7b04f9bd65df5dc8547b2f27f/packages/worker/src/workflow/bundler.ts#L193-L241\r\n\r\n\r\n**Final HACK**\r\n\r\n```bash\r\nsed -i -r 's#__importStar[(]__require[(]\"__temporal_custom.*?\"[)][)]#({})#g' ./dist/entrypoint.js\r\n```\r\n\r\n> **Note**\r\n> webpack load+bundled in 0m2.032s (ignore tsc)\r\n> esbuild bundled in 40ms, worker started by tsx (without tsc), a lot faster\r\n\r\n**entrypoint.ts**\r\n\r\n```ts\r\nimport * as api from '@temporalio/workflow/lib/worker-interface.js';\r\n\r\n// Bundle all Workflows and interceptor modules for lazy evaluation\r\napi.overrideGlobals();\r\napi.setImportFuncs({\r\n  importWorkflows: () => {\r\n    return import('./workflows');\r\n  },\r\n  importInterceptors: () => {\r\n    return Promise.all([]);\r\n  },\r\n});\r\n\r\nexport { api };\r\n```\r\n\r\n**workflows.ts**\r\n\r\n```ts\r\nimport { proxyActivities } from '@temporalio/workflow';\r\nimport type * as activities from './activities';\r\n\r\nconst { greet } = proxyActivities<typeof activities>({\r\n  startToCloseTimeout: '1 minute',\r\n});\r\n\r\n/** A workflow that simply calls an activity */\r\nexport async function example(name: string): Promise<string> {\r\n  return await greet(name);\r\n}\r\n```\r\n\r\n\r\n### Describe the bug\r\n\r\n### Minimal Reproduction\r\n\r\n\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: [e.g. M1 Mac, x86 Windows, Linux]\r\n- Temporal Version: [e.g. 1.14.0?] and/or SDK version\r\n- Are you using Docker or Kubernetes or building Temporal from source?\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n\r\n","closedAt":"2023-01-13T03:29:09Z","comments":[{"id":"IC_kwDOEujx185PIzck","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Thanks for sharing the learning you acquired on this subject. It might help others trying to do similar things.\r\n\r\nThe time required to bundle workflows is indeed a frequently expressed concern of our developers. Using esbuild is often proposed as a solution to this, and we might consider supporting it officially, as an alternative to Webpack, at some point in the future.\r\n\r\nWe can't however recommend using a custom workflow bundler at this point in time. The bundling process is an integral part of the workflow sandboxing mechanisms provided by the TypeScript SDK. Bug fixes and development of new features regularly require us to modify various aspect of the bundler. That includes notably the content of the entrypoint.js file, usage of `__temporal_*` variables and pseudo files, the way source maps are encoded, the way modules are stored, and other details.\r\n\r\nCustom bundling processes are therefore very fragile and might require maintenance effort on each SDK release (possibly even some patch level releases). Possible, but definitely not something that we want to encourage broadly.\r\n\r\nFor this reason, I don't think we should include this subject in our official documentation at this point. You are however welcome to keep this ticket updated with any further learning you may acquire on this subject.","createdAt":"2022-11-25T16:55:12Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/978#issuecomment-1327707940","viewerDidAuthor":false},{"id":"IC_kwDOEujx185PI8X_","author":{"login":"wenerme"},"authorAssociation":"NONE","body":"I tried using webpack bundle in the nextjs project, but the build process failed with `Module parse failed: 'import' and 'export' may appear only with 'sourceType: module'`, the embedded bundling process depends on the env, that's harder to control.\r\n\r\nI hope the sdk can use global inject to replace the `__temporal_*` hack, I will keep using external esbuild bundling, until I need the function that provided by `__temporal_*`, then may add more hacks.\r\n\r\nAbout the `__temporal_*`, I think sdk can use a stub module like `export const {x: 'MAGIC_NUMBER'}`, the just replace the code before running will be better than the `require('__temporal_*')`.","createdAt":"2022-11-25T17:44:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/978#issuecomment-1327744511","viewerDidAuthor":false}],"createdAt":"2022-11-25T07:59:31Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":978,"reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"state":"CLOSED","title":"[Doc] Document how to bundle with esbuild","updatedAt":"2023-01-13T03:29:09Z","url":"https://github.com/temporalio/sdk-typescript/issues/978"}
