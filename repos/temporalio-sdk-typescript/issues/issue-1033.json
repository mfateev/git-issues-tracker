{"assignees":[],"author":{"id":"MDQ6VXNlcjM1MDY5NQ==","is_bot":false,"login":"yamen","name":"Yamen Sader"},"body":"### What are you really trying to do?\r\n\r\nTrying to run `npm run workflow` inside the `hello-world` app created using `npx @temporalio/create@latest`.\r\n\r\nAlso found this issue at other times, but this was the simplest way of replicating it.\r\n\r\n### Describe the bug\r\n\r\nAll examples use the `hello-world` project as a baseline.\r\n\r\nIn a client side script that gets a workflow handle, awaiting on operations that return a Promise can silently crash the script:\r\n\r\n``` javascript\r\n  // console.log is never run, process just silently exits\r\n  const handle = await client.workflow.start(example, {\r\n    args: ['Temporal'],\r\n    taskQueue: 'hello-world',\r\n    workflowId: 'workflow-' + nanoid(),\r\n  });\r\n\r\n  console.log(Date.now());\r\n```\r\n\r\nRemoving the `await` on the Promise (and sleeping to allow the relevant calls to finish without exiting the script) works just fine.\r\n\r\n```javascript\r\n    // console.log runs now\r\n   const handle = client.workflow.start(example, {\r\n    args: ['Temporal'],\r\n    taskQueue: 'hello-world',\r\n    workflowId: 'workflow-' + nanoid(),\r\n  });\r\n\r\n  await new Promise((resolve) => setTimeout(resolve, 100));\r\n\r\n  console.log(Date.now());\r\n```\r\n\r\nAwaiting on the returned Promise _indirectly_ (via say a `Promise.all`) also works:\r\n\r\n```javascript\r\n  // console.log runs here too\r\n  const handle = client.workflow.start(example, {\r\n    args: ['Temporal'],\r\n    taskQueue: 'hello-world',\r\n    workflowId: 'workflow-' + nanoid(),\r\n  });\r\n\r\n  await Promise.all([handle, new Promise((resolve) => setTimeout(resolve, 100))]);\r\n\r\n  console.log(Date.now());\r\n```\r\n\r\n### Minimal Reproduction\r\n\r\nAs per above, the current `hello-world` example should fail 'as is'. See above steps for 'fixing' it by awaiting indirectly with a sleep (or other promise).\r\n\r\n### Environment/Versions\r\n\r\nThis has been validated in at least two very different environments (Windows WSL and Mac):\r\n\r\n- Both Windows WSL2 running Ubuntu 22.04 and an M1 Mac\r\n- SDK 1.5.2\r\n- Both Temporalite and Docker Compose tried\r\n- Both Node 16.x and Node 18.x\r\n\r\n### Additional context\r\n\r\n* When stepping through with a debugger, it seems a different code path is executed based on whether `await` is called directly on the Promise or not.\r\n* Attaching some process exit hooks and debug logging will show that the process will hard exit as soon as the `Client` call is made and returns. Adding a delay to this exit will allow it to complete running.\r\n\r\n```javascript\r\nprocess.on('beforeExit', (code) => {\r\n  console.log(`Process will exit in 1 second with code: ${code}`);\r\n  setTimeout(() => {\r\n    process.exit(code);\r\n  }, 1000);\r\n});\r\n\r\nprocess.on('exit', (code) => {\r\n  // Only synchronous calls\r\n  console.log(`Process exited with code: ${code}`);\r\n});\r\n```\r\n","closedAt":"2023-06-07T19:07:39Z","comments":[{"id":"IC_kwDOEujx185ToZM3","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I experienced the same issue with grpc-js 1.8.x, we're going to release a version that fixes `@grpc/grpc-js` to `~1.7.3`.\r\nFor now I recommend using that workaround.\r\n","createdAt":"2023-01-25T04:59:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1033#issuecomment-1403097911","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Toeon","author":{"login":"yamen"},"authorAssociation":"NONE","body":"I can confirm that this fixes the issue!","createdAt":"2023-01-25T05:36:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1033#issuecomment-1403120167","viewerDidAuthor":false},{"id":"IC_kwDOEujx185Tof3B","author":{"login":"yamen"},"authorAssociation":"NONE","body":"Seems related to this issue: https://github.com/grpc/grpc-node/issues/2318\r\n\r\n* v1.7.3 works\r\n* v1.8.4 works (but seems to hold a connection open, ie script doesn't exit)\r\n* Any version works as long as there is some ref open in the script (eg calling `setInterval(() => {}, 1_000_000_000)` somewhere in the code)","createdAt":"2023-01-25T05:44:44Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1033#issuecomment-1403125185","viewerDidAuthor":false},{"id":"IC_kwDOEujx185TrEYv","author":{"login":"chadobado"},"authorAssociation":"NONE","body":"For those unfamiliar, you can work around this by adding an override to package.json:\r\n\r\nIf using npm\r\n```json\r\n\"overrides\": {\r\n    \"@temporalio/client\": {\r\n      \"@grpc/grpc-js\": \"1.7.3\"\r\n    }\r\n  }\r\n  ```\r\n\r\nIf using yarn (must be in root package.json if monorepo):\r\n```json\r\n\"resolutions\": {\r\n    \"@temporalio/client/@grpc/grpc-js\": \"1.7.3\"\r\n  },\r\n```","createdAt":"2023-01-25T15:28:55Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1033#issuecomment-1403799087","viewerDidAuthor":false},{"id":"IC_kwDOEujx185TtHDI","author":{"login":"yamen"},"authorAssociation":"NONE","body":"Seems to be fixed properly in 1.8.7 now.","createdAt":"2023-01-25T23:00:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-typescript/issues/1033#issuecomment-1404334280","viewerDidAuthor":false},{"id":"IC_kwDOEujx185TtOh_","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Thanks for pointing this out @yamen.\r\nCC @mjameswh.","createdAt":"2023-01-25T23:40:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1033#issuecomment-1404364927","viewerDidAuthor":false},{"id":"IC_kwDOEujx185eQbKL","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Closing as there is nothing more to be done on this ticket. Updating `@grpc/grpc-js` to 1.8.x is already tracked in #1023.","createdAt":"2023-06-07T19:07:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1033#issuecomment-1581363851","viewerDidAuthor":false}],"createdAt":"2023-01-25T04:13:58Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1033,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"[Bug] Silent crashes when awaiting promises returned from `Client` (using `hello-world` sample)","updatedAt":"2023-06-07T19:07:40Z","url":"https://github.com/temporalio/sdk-typescript/issues/1033"}
