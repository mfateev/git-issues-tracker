{"assignees":[],"author":{"id":"MDQ6VXNlcjE4MDE4ODY0","is_bot":false,"login":"danielrearden","name":"Daniel Rearden"},"body":"### What are you really trying to do?\r\n\r\nWe are migrating from jest to [vitest](https://vitest.dev/) and hitting a memory error whenever running multiple test files and using multi-threading.\r\n\r\n### Describe the bug\r\n\r\n* A memory error that causes all subsequent tests to fail\r\n```\r\nRangeError [Error]: WebAssembly.instantiate(): Out of memory: wasm memory\r\n    at node:internal/deps/cjs-module-lexer/dist/lexer:1:33593\r\nEmitted 'error' event on Tinypool instance at:\r\n    at EventEmitterReferencingAsyncResource.runInAsyncScope (node:async_hooks:202:9)\r\n    at Tinypool.emit (file://***Projects/vitest-temporal-issue/node_modules/tinypool/dist/esm/index.js:60:31)\r\n    at Worker.<anonymous> (file://***Projects/vitest-temporal-issue/node_modules/tinypool/dist/esm/index.js:566:30)\r\n    at Worker.emit (node:events:527:28)\r\n    at Worker.[kOnErrorMessage] (node:internal/worker:289:10)\r\n    at Worker.[kOnMessage] (node:internal/worker:300:37)\r\n    at MessagePort.<anonymous> (node:internal/worker:201:57)\r\n    at MessagePort.[nodejs.internal.kHybridDispatch] (node:internal/event_target:643:20)\r\n    at MessagePort.exports.emitMessage (node:internal/per_context/messageport:23:28)\r\n```\r\n* Multiple unhandled rejections returned even when tests seemingly pass\r\n```\r\nError: A panic occurred while executing a `neon::event::Channel::send` callback\r\n```\r\n* This error that pops up when we drop the number of tests per suite but keep multi-threading on\r\n```\r\nthread '<unnamed>' panicked at 'Attempted to dereference a `neon::handle::Root` from the wrong module ', /Users/runner/.cargo/registry/src/github.com-1ecc6299db9ec823/neon-0.10.1/src/handle/root.rs:168:13\r\nFATAL ERROR: /Users/runner/.cargo/registry/src/github.com-1ecc6299db9ec823/neon-runtime-0.10.1/src/napi/tsfn.rs:191:18 Failed to set an object property\r\n 1: 0x1044742dc node::Abort() [***.nvm/versions/node/v16.15.1/bin/node]\r\n 2: 0x104474464 node::errors::TryCatchScope::~TryCatchScope() [***.nvm/versions/node/v16.15.1/bin/node]\r\n 3: 0x1044742f4 node::OnFatalError(char const*, char const*) [***.nvm/versions/node/v16.15.1/bin/node]\r\n 4: 0x104448cdc napi_open_callback_scope [***.nvm/versions/node/v16.15.1/bin/node]\r\n 5: 0x11601987c neon_runtime::napi::error::fatal_error::h36bb70038ef82b4d [***Projects/vitest-temporal-issue/node_modules/@temporalio/core-bridge/releases/aarch64-apple-darwin/index.node]\r\n 6: 0x116019f6c neon_runtime::napi::no_panic::create_error::h5fc2dfded95b7565 [***Projects/vitest-temporal-issue/node_modules/@temporalio/core-bridge/releases/aarch64-apple-darwin/index.node]\r\n 7: 0x116483670 neon_runtime::napi::tsfn::ThreadsafeFunction$LT$T$GT$::callback::h93e803bb4ad8e14a [***Projects/vitest-temporal-issue/node_modules/@temporalio/core-bridge/releases/aarch64-apple-darwin/index.node]\r\n 8: 0x10444b744 v8impl::(anonymous namespace)::ThreadSafeFunction::AsyncCb(uv_async_s*) [***.nvm/versions/node/v16.15.1/bin/node]\r\n 9: 0x104ce5f00 uv__async_io [***.nvm/versions/node/v16.15.1/bin/node]\r\n10: 0x104cf7c78 uv__io_poll [***.nvm/versions/node/v16.15.1/bin/node]\r\n11: 0x104ce6390 uv_run [***.nvm/versions/node/v16.15.1/bin/node]\r\n12: 0x1043c2ccc node::SpinEventLoop(node::Environment*) [***.nvm/versions/node/v16.15.1/bin/node]\r\n13: 0x1045069e8 node::worker::Worker::Run() [***.nvm/versions/node/v16.15.1/bin/node]\r\n14: 0x104509c10 node::worker::Worker::StartThread(v8::FunctionCallbackInfo<v8::Value> const&)::$_3::__invoke(void*) [***.nvm/versions/node/v16.15.1/bin/node]\r\n15: 0x1a03d426c _pthread_start [/usr/lib/system/libsystem_pthread.dylib]\r\n16: 0x1a03cf08c thread_start [/usr/lib/system/libsystem_pthread.dylib]\r\n```\r\n\r\n### Minimal Reproduction\r\n\r\nhttps://github.com/danielrearden/vitest-temporal-issue\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: M1 macOS 12.6\r\n- Temporal Version: SDK 1.2.0\r\n- Are you using Docker or Kubernetes or building Temporal from source? Docker\r\n\r\n### Additional context\r\n\r\n- The same tests run just fine in jest, even with workers enabled (i.e. no --runInBand)\r\n- Disabling multi-threading fixes the issue (but obviously slows down tests to a painful pace)\r\n- Running vitest against tests that do NOT attempt to spin up a Temporal worker causes no issues\r\n","closedAt":"2022-12-08T22:37:54Z","comments":[{"id":"IC_kwDOEujx185QE6WO","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Apparently resolved as of 1.5.0 (presumably by #983).\r\n\r\nI can no longer reproduce any of the reported errors (there were still present in 1.4.4).","createdAt":"2022-12-08T22:37:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/876#issuecomment-1343464846","viewerDidAuthor":false},{"id":"IC_kwDOEujx185QcFEd","author":{"login":"john-griffin"},"authorAssociation":"NONE","body":"Thanks, can confirm this is fixed! I was able to switch back to vitest.","createdAt":"2022-12-13T19:08:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-typescript/issues/876#issuecomment-1349538077","viewerDidAuthor":false}],"createdAt":"2022-09-20T19:27:33Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":876,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"[Bug] Unable to run tests using Temporal SDK using vitest","updatedAt":"2022-12-13T19:08:01Z","url":"https://github.com/temporalio/sdk-typescript/issues/876"}
