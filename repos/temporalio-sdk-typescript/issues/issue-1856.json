{"assignees":[],"author":{"id":"MDQ6VXNlcjQ1ODg3NDk0","is_bot":false,"login":"stathis-alexander","name":"Alexander Stathis"},"body":"### What are you really trying to do?\n\nWe are trying to build `@temporalio/core-bridge`'s rust from source. \n\n### Describe the bug\n\nWe run our application in Alpine images (I know, I know), and so we rely on being able to build the rust binary from source. This broke after 0.12.0, since the `bridge-macros` were refactored into a separate top level folder which is not included in the `files` in the `package.json`, and thus are not contained in the installed package. \n\nI tried to patch them in, but there is an [issue in our package manager](https://github.com/oven-sh/bun/issues/13330), bun, that prevents this from working. I've worked around it in our build pipeline by committing these files to our repo directly where they're needed, but it's less than ideal.\n\nThese files should be included in the `core-bridge` package along with the other rust source files so that we can build them from source. \n\n### Environment/Versions\n\nWe're building in alpine. \n\n### Additional context\n\nI've opened this PR to address this issue: https://github.com/temporalio/sdk-typescript/pull/1852\n\nAdditionally, I could open another PR to enable building alpine / musl binaries if desired. The documentation suggests this would be very difficult, but it is not so hard to do. \n\nWe use the following patch:\n```\ndiff --git a/Cargo.toml b/Cargo.toml\nindex ecc4e78e0321e2df5d1045e1a1607f4256a9e478..5e9bcb4165ac27ded9933c9dd91352a496e21033 100644\n--- a/Cargo.toml\n+++ b/Cargo.toml\n@@ -18,6 +18,7 @@ opt-level = 3\n debug = false\n lto = true\n incremental = false\n+strip = true\n \n [dependencies]\n anyhow = \"1.0\"\ndiff --git a/common.js b/common.js\nindex 7ffd6da0af2b0362d91d669578ef21e126323f20..065d88e4a17e4861329384bad7fadc05ece286ce 100644\n--- a/common.js\n+++ b/common.js\n@@ -14,13 +14,20 @@ const targets = [\n   'aarch64-apple-darwin',\n   'x86_64-unknown-linux-gnu',\n   'aarch64-unknown-linux-gnu',\n+  'x86_64-unknown-linux-musl',\n+  'aarch64-unknown-linux-musl',\n   // TODO: this is not supported on macos\n   'x86_64-pc-windows-msvc',\n   'x86_64-pc-windows-gnu',\n ];\n \n const archAlias = { x64: 'x86_64', arm64: 'aarch64' };\n-const platformMapping = { darwin: 'apple-darwin', linux: 'unknown-linux-gnu', win32: 'pc-windows-msvc' };\n+const platformMapping = {\n+  darwin: 'apple-darwin',\n+  linux: 'unknown-linux-gnu',\n+  linux_musl: 'unknown-linux-musl',\n+  win32: 'pc-windows-msvc',\n+};\n \n class PrebuildError extends Error {\n   constructor(message) {\n@@ -29,12 +36,16 @@ class PrebuildError extends Error {\n   }\n }\n \n+function isMuslSystem() {\n+  return process.report.getReport().sharedObjects.some((lib) => lib.includes('musl'));\n+}\n+\n function getPrebuiltTargetName() {\n   const arch = archAlias[os.arch()];\n   if (arch === undefined) {\n     throw new PrebuildError(`No prebuilt module for arch ${os.arch()}`);\n   }\n-  const platform = platformMapping[os.platform()];\n+  const platform = isMuslSystem() ? platformMapping[`${os.platform()}_musl`] : platformMapping[os.platform()];\n   if (platform === undefined) {\n     throw new PrebuildError(`No prebuilt module for platform ${os.platform()}`);\n   }\n@@ -50,4 +61,12 @@ function getPrebuiltPath() {\n   }\n }\n \n-module.exports = { targets, archAlias, platformMapping, PrebuildError, getPrebuiltPath, getPrebuiltTargetName };\n+module.exports = {\n+  targets,\n+  archAlias,\n+  platformMapping,\n+  PrebuildError,\n+  getPrebuiltPath,\n+  getPrebuiltTargetName,\n+  isMuslSystem,\n+};\ndiff --git a/scripts/build.js b/scripts/build.js\nindex a6271fcb72c25a08caa5a6388c9b82e4e1ede186..c7ab17df5ca3c73c49540ed681afd3889ec950d3 100644\n--- a/scripts/build.js\n+++ b/scripts/build.js\n@@ -93,6 +93,8 @@ function compile(requestedTarget) {\n   if (status !== 0 || error) {\n     throw new Error(`Failed to build${target ? ' for ' + target : ''}: status code ${status}`, error);\n   }\n+\n+  try { fs.rmdirSync('target', { recursive: true });  } catch (err) {}\n }\n \n if (requestedTargets.length > 0) {\n```\n along with \n```\n\nRUN <<EOF\n  apk add --no-cache build-base cmake protoc protobuf-dev rustup\n\n  rustup-init -y\nEOF\n\nENV RUSTFLAGS=\"-C target-feature=-crt-static\"\nENV PATH=\"/root/.cargo/bin:$PATH\"\nENV BUILD_CORE_RELEASE=\"true\"\n```\nin the docker file. ","closedAt":"2025-12-05T20:14:27Z","comments":[],"createdAt":"2025-12-04T18:54:31Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1856,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Cannot build `@temporalio/core-bridge` rust from source","updatedAt":"2025-12-05T20:14:27Z","url":"https://github.com/temporalio/sdk-typescript/issues/1856"}
