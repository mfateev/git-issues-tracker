{"assignees":[],"author":{"id":"MDQ6VXNlcjUyMzA0","is_bot":false,"login":"bergundy","name":"Roey Berman"},"body":"**To Reproduce**\r\nSteps to reproduce the behavior:\r\n1. Run `node packages/test/lib/perf/all-in-one.js --iterations 20000 --workflow sync --concurrent-wf-clients 500`\r\n2. Observe the printed number of WFs per second over time\r\n\r\n**Expected behavior**\r\nWorker should not slow down\r\n\r\n**Additional context**\r\n- CPU usage increases over time indicating that it's not a problem with poll throughput\r\n- Using a pool of 8 isolates (compared to 1) makes the slow down less dramatic","closedAt":"2021-07-27T08:50:18Z","comments":[{"id":"IC_kwDOEujx1840v9US","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Looks like disposing of the workflow isolate context after activation slows down the degradation, results are inconsistent though.\r\n\r\nSampled output from running `perf` with 16 isolates:\r\n\r\nWith no dispose:\r\n```\r\nWFs complete (4946/20000), WFs/s 83.0 (81.0), heap used / total MB: 28.03 / 63.39)\r\nWFs complete (7372/20000), WFs/s 72.0 (71.5), heap used / total MB: 24.57 / 60.39)\r\nWFs complete (12844/20000), WFs/s 10.0 (54.6), heap used / total MB: 23.95 / 40.56)\r\nWFs complete (13831/20000), WFs/s 38.0 (52.7), heap used / total MB: 31.28 / 60.53)\r\n```\r\nWith dispose:\r\n```\r\nWFs complete (7922/20000), WFs/s 80.9 (75.4), heap used / total MB: 24.85 / 60.64)\r\nWFs complete (11589/20000), WFs/s 41.9 (67.7), heap used / total MB: 35.96 / 62.56)\r\nWFs complete (13100/20000), WFs/s 62.9 (67.1), heap used / total MB: 30.72 / 62.81)\r\nWFs complete (15246/20000), WFs/s 24.0 (66.5), heap used / total MB: 26.14 / 57.27)\r\nWFs complete (17932/20000), WFs/s 53.9 (65.1), heap used / total MB: 29.07 / 61.23)\r\nWFs complete (19800/20000), WFs/s 44.8 (64.2), heap used / total MB: 20.49 / 29.22)\r\nWFs complete (20000/20000), WFs/s 2.5 (61.5), heap used / total MB: 20.64 / 22.72)\r\n```\r\n\r\nA second time:\r\n```\r\nWFs complete (3921/30000), WFs/s 87.0 (75.4), heap used / total MB: 27.17 / 60.72)\r\nWFs complete (11277/30000), WFs/s 62.0 (66.3), heap used / total MB: 28.42 / 61.47)\r\nWFs complete (15164/30000), WFs/s 50.0 (63.9), heap used / total MB: 34.02 / 61.41)\r\nWFs complete (19258/30000), WFs/s 60.0 (58.6), heap used / total MB: 30.55 / 63.36)\r\nWFs complete (21249/30000), WFs/s 12.9 (55.7), heap used / total MB: 18.73 / 61.33)\r\nWFs complete (24167/30000), WFs/s 48.0 (50.7), heap used / total MB: 20.58 / 40.55)\r\nWFs complete (25793/30000), WFs/s 15.0 (49.5), heap used / total MB: 32.16 / 61.03)\r\nWFs complete (29955/30000), WFs/s 9.9 (42.1), heap used / total MB: 32.53 / 61.47)\r\nWFs complete (30000/30000), WFs/s 10.4 (41.9), heap used / total MB: 24.44 / 33.47)\r\n```","createdAt":"2021-07-22T15:05:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/162#issuecomment-884987154","viewerDidAuthor":false},{"id":"IC_kwDOEujx1840wBEt","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Made this final check to verify this is all isolate related:\r\nRemoved all isolate related code and replaced `workflowOperator.mergeMapWithState` with:\r\n```ts\r\nconst completion = coresdk.workflow_completion.WFActivationCompletion.encodeDelimited({\r\n  runId: activation.runId,\r\n  successful: {\r\n    commands: [{ completeWorkflowExecution: { result: await defaultDataConverter.toPayload(undefined) } }],\r\n  },\r\n}).finish();\r\nreturn { state: undefined, output: { close: true, completion, span, parentSpan: root } };\r\n```\r\n\r\nNo slow down was observed for a while, CPU was stable at around 13%.\r\n```\r\nWFs complete (2359/50000), WFs/s 121.0 (102.5), heap used / total MB: 25.41 / 62.61)\r\nWFs complete (4236/50000), WFs/s 120.0 (108.5), heap used / total MB: 31.95 / 63.36)\r\nWFs complete (6254/50000), WFs/s 121.8 (111.6), heap used / total MB: 27.81 / 63.61)\r\nWFs complete (9868/50000), WFs/s 104.0 (113.4), heap used / total MB: 27.53 / 64.36)\r\nWFs complete (13508/50000), WFs/s 102.0 (112.5), heap used / total MB: 25.47 / 64.61)\r\nWFs complete (19382/50000), WFs/s 124.1 (113.9), heap used / total MB: 26.17 / 64.36)\r\nWFs complete (23214/50000), WFs/s 109.0 (113.7), heap used / total MB: 20.61 / 65.11)\r\n```\r\n\r\nAfter some point CPU dropped to 5% and processing rate dropped with it, htop reveals docker VM is working hard and my fanless M1 MBP is getting too hot for me to keep typing.\r\nLooks like it got better after a while:\r\n```\r\nWFs complete (30006/50000), WFs/s 31.0 (87.4), heap used / total MB: 31.44 / 57.50)\r\nWFs complete (33950/50000), WFs/s 47.9 (76.1), heap used / total MB: 29.12 / 60.69)\r\nWFs complete (44305/50000), WFs/s 101.0 (75.3), heap used / total MB: 26.38 / 63.03)\r\nWFs complete (46865/50000), WFs/s 94.0 (75.8), heap used / total MB: 26.62 / 60.25)\r\n```\r\n\r\nNext steps would be to reproduce this in an environment where the Temporal server with DB is not overloaded.\r\n\r\n","createdAt":"2021-07-22T15:24:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/162#issuecomment-885002541","viewerDidAuthor":false},{"id":"IC_kwDOEujx18401ecS","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"After further investigation, seems like the cause was the SDK leaking isolate references.\r\nFix is pending.","createdAt":"2021-07-26T07:03:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/162#issuecomment-886433554","viewerDidAuthor":false}],"createdAt":"2021-07-22T14:30:12Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":{"number":2,"title":"beta","description":"","dueOn":null},"number":162,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Worker significantly slows down over time","updatedAt":"2021-07-27T08:50:18Z","url":"https://github.com/temporalio/sdk-typescript/issues/162"}
