{"assignees":[],"author":{"id":"MDQ6VXNlcjUyMjA1","is_bot":false,"login":"dandavison","name":"Dan Davison"},"body":"If the workflow below is started, and then a signal and an update are sent in the 2nd Workflow task, the workflow exits without the update handler ever being executed. See @bergundy's original comment https://github.com/temporalio/sdk-typescript/pull/1459#pullrequestreview-2184277781\r\n\r\n```typescript\r\nexport async function workflow(): Promise<string> {\r\n  var numFoos = 0;\r\n\r\n  wf.setHandler(fooSignal, () => {\r\n    numFoos++;\r\n  });\r\n\r\n  wf.setHandler(fooUpdate, () => {\r\n    numFoos++;\r\n  });\r\n\r\n  await wf.condition(() => numFoos > 0);\r\n  return `foos: ${numFoos}`;\r\n}\r\n```\r\n\r\nThe fix will be to group update activation jobs together with signals here:\r\n\r\n https://github.com/temporalio/sdk-typescript/blob/ce0532f9be2d47db48c00ebbf17a39063ae42753/packages/worker/src/workflow/vm-shared.ts#L314-L317\r\n\r\nFixing this will be backwards incompatible w.r.t. replay of existing workflows, so will need to use an SDK flag.\r\n\r\nWe did not update that code when we implemented update because core orders the activation jobs and we were planning to eliminate this typescript code, but this decision overlooked the fact that update and signal activation jobs need to be placed into the same batch in order for them all to be executed before giving the chance for an awaitable such as the `workflow.condition()` above to be unblocked.\r\n\r\n","closedAt":"2024-08-14T21:59:20Z","comments":[],"createdAt":"2024-07-24T00:02:45Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1474,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Workflows can be constructed in which update handlers do not, but should, execute","updatedAt":"2024-08-14T21:59:20Z","url":"https://github.com/temporalio/sdk-typescript/issues/1474"}
