{"assignees":[],"author":{"id":"MDQ6VXNlcjE5MzIzODM=","is_bot":false,"login":"safareli","name":"Irakli Safareli"},"body":"### What are you really trying to do?\n\nWhen using otel if workflow has tracestate header like this:\n\n<img width=\"641\" height=\"168\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/c450bc8e-ec7c-4d16-8bc3-ee0051a26509\" />\n\nexporting span from worker fails\n\n\n### Describe the bug\n\ngetting this errors:\n\n```\nTypeError: _a.serialize is not a function\n    at sdkSpanToOtlpSpan (/app/node_modules/.pnpm/@opentelemetry+otlp-transformer@0.57.2_@opentelemetry+api@1.9.0/node_modules/@opentelemetry/otlp-transformer/src/trace/internal.ts:44:33)\n    at <anonymous> (/app/node_modules/.pnpm/@opentelemetry+otlp-transformer@0.57.2_@opentelemetry+api@1.9.0/node_modules/@opentelemetry/otlp-transformer/src/trace/internal.ts:159:11)\n    at Array.map (<anonymous>)\n    at spanRecordsToResourceSpans (/app/node_modules/.pnpm/@opentelemetry+otlp-transformer@0.57.2_@opentelemetry+api@1.9.0/node_modules/@opentelemetry/otlp-transformer/src/trace/internal.ts:158:34)\n    at createExportTraceServiceRequest (/app/node_modules/.pnpm/@opentelemetry+otlp-transformer@0.57.2_@opentelemetry+api@1.9.0/node_modules/@opentelemetry/otlp-transformer/src/trace/internal.ts:110:20)\n    at Object.serializeRequest (/app/node_modules/.pnpm/@opentelemetry+otlp-transformer@0.57.2_@opentelemetry+api@1.9.0/node_modules/@opentelemetry/otlp-transformer/src/trace/json/trace.ts:26:52)\n    at OTLPExportDelegate.export (/app/node_modules/.pnpm/@opentelemetry+otlp-exporter-base@0.57.2_@opentelemetry+api@1.9.0/node_modules/@opentelemetry/otlp-exporter-base/src/otlp-export-delegate.ts:69:48)\n    at OTLPTraceExporter.export (/app/node_modules/.pnpm/@opentelemetry+otlp-exporter-base@0.57.2_@opentelemetry+api@1.9.0/node_modules/@opentelemetry/otlp-exporter-base/src/OTLPExporterBase.ts:32:26)\n    at Object.fn (/app/node_modules/.pnpm/@temporalio+interceptors-opentelemetry@1.11.7_@temporalio+activity@1.11.7_@temporalio+c_49fd2775686fed0552daf86155185cd7/node_modules/@temporalio/interceptors-opentelemetry/src/worker/index.ts:86:24)\n    at <anonymous> (/app/node_modules/.pnpm/@temporalio+worker@1.11.7/node_modules/@temporalio/worker/src/worker.ts:1364:23)\n    at Array.map (<anonymous>)\n    at Worker.processSinkCalls (/app/node_modules/.pnpm/@temporalio+worker@1.11.7/node_modules/@temporalio/worker/src/worker.ts:1362:21)\n    at Worker.handleActivation (/app/node_modules/.pnpm/@temporalio+worker@1.11.7/node_modules/@temporalio/worker/src/worker.ts:1208:22)\n\n```\n\n### Minimal Reproduction\n\n\nreproducing this locally was bit hacky.\nhad to add this so tracestate was passed to temporal when invoking a workflow via js client.\n\n<img width=\"1686\" height=\"234\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/050feb21-0218-4e3b-bff2-3aeffe610421\" />\n\n\nthen once the trace state is passed to workflow  in the makeWorkflowExporter that's passed to Worker.create we get `traceState` that is instance of Object and not an instance of expected TraceState. via debugger you can see this:\n\n<img width=\"521\" height=\"198\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/6feb9579-94e6-4e79-b7d2-999da58d428f\" />\n\nbecause of this then at some point when span is converted to an request to otel collector as there is traceState .serialize is called on it but this object has no methods only that `_internalState` which is private prop of the TraceState see:\n\n<img width=\"944\" height=\"539\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/51d91e1f-77f2-458a-a398-c65ccd00c402\" />\n\n\nI suppose the trace state is moved across different JS contexts (from workflow code to host) and information that this object is instance of TraceState is lost and on the other end we just get Object.\n\n<!-- \nModify our hello world templates to demonstrate:\n\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\n- Go: https://github.com/temporalio/money-transfer-project-template-go\n- Java: https://github.com/temporalio/money-transfer-project-template-java\n- PHP: https://github.com/temporalio/samples-php#samples\n-->\n\n### Environment/Versions\n\n\n\n- OS and processor: M1 Mac\n- Temporal SDK Version: 1.11.7\n- Are you using Docker or Kubernetes or building Temporal from source? no\n\n\n\n#### hacky fix on my end was to do this:\n\n```ts\nconst fixTemporalBug = (traceState: TraceState): TraceState => {\n  const res = new TraceState();\n\n  (res as any)._internalState = (traceState as any)._internalState;\n\n  return res;\n};\n\n// inlined version of makeWorkflowExporter that fixes traceState bug in Temporal\nconst makeWorkflowExporterFixed = (\n  exporter: SpanExporter,\n  resource: Resource,\n): InjectedSink<OpenTelemetryWorkflowExporter> => {\n  return {\n    export: {\n      fn: (info: WorkflowInfo, spanData: SerializableSpan[]): void => {\n        const spans = spanData.map((serialized) => {\n          Object.assign(serialized.attributes, info);\n          // Spans are copied over from the isolate and are converted to ReadableSpan instances\n          const {\n            spanContext: { traceState, ...spanContext },\n            ...rest\n          } = serialized;\n\n          return {\n            spanContext: (): SpanContext => ({\n              ...spanContext,\n              traceState: traceState == null ? traceState : fixTemporalBug(traceState as any),\n            }),\n            resource,\n            ...rest,\n          };\n        });\n\n        // Ignore the export result for simplicity\n        exporter.export(spans, () => undefined);\n      },\n    },\n  };\n};\n```","closedAt":"2026-01-20T18:00:32Z","comments":[{"id":"IC_kwDOEujx18613tHy","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"Thanks for the detailed report, that's helpful.\n\nThis is actually the second time I here about this issue (see [previous discussion](https://temporalio.slack.com/archives/C01DKSMU94L/p1746432163574499) on our Slack workspace), though we never got far enough in investigating this the other time.\n\nInterestingly, however, you are _only_ the second user reporting this, which makes me think that this may only show up in some specific environment. Do you happen to have a dependency on the `dd-trace` package? Or any other particular trace/otel-related dependency?\n\nBoth your trace and the other user's traces show the `@opentelemetry/otlp-transformer@0.57.2` package, whereas our SDK is built and tested against v0.46.0 without problem. But `otlp-transformer` [introduced that specific `ctx.traceState?.serializer()` line](https://github.com/open-telemetry/opentelemetry-js/commit/5b070b80a43f8c29ac1ea87f868b5ba01b11b0a3#diff-f43120d2e8669c168489dd2e7b44fb28f5e0316e64c5270418294378bb8ed284R35) in v0.35.1. So I suppose `traceState` would \"normally\" be undefined unless something else is present that forces those to be generated...\n\nIn any case, this is indeed an issue from our side, and  it needs to be fixed. As you correctly figured out, the trace data are sent from the Workflow Worker thread to the main thread, which goes through V8's serialization protocol. Functions and classes do not survive that serialization, and there's really nothing we can do about that. That means we'll probably need to adopt a solution kind of similar to the hack you figured out. Or maybe we can/should just drop the `traceState` entirely, WDYT?","createdAt":"2025-07-09T06:20:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1738#issuecomment-3051278834","viewerDidAuthor":false},{"id":"IC_kwDOEujx1862uLhv","author":{"login":"safareli"},"authorAssociation":"NONE","body":"Instances of TraceState  have .serialize() method which converts it to string. long term solution in workflow land will perform that method call to get serialized string version of trace state. and then `makeWorkflowExporter` will addopt my changes but use `new TraceState(traceStateSerialized)` instead of my hacky way.","createdAt":"2025-07-12T14:13:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1738#issuecomment-3065559151","viewerDidAuthor":false},{"id":"IC_kwDOEujx1862_nn_","author":{"login":"JCMais"},"authorAssociation":"NONE","body":"We are having the same issue after adding trace propagation, all temporal packages are on `1.11.7`, and here are the other related packages:\n```\n        \"dd-trace\": \"5.22.0\",\n        \"@sentry/node\": \"9.12.0\",\n        \"@sentry/opentelemetry\": \"9.12.0\",\n        \"@opentelemetry/api\": \"1.9.0\",\n        \"@opentelemetry/auto-instrumentations-node\": \"0.56.0\",\n        \"@opentelemetry/core\": \"1.30.1\",\n        \"@opentelemetry/exporter-metrics-otlp-grpc\": \"0.57.2\",\n        \"@opentelemetry/exporter-metrics-otlp-http\": \"0.57.2\",\n        \"@opentelemetry/exporter-trace-otlp-grpc\": \"0.57.2\",\n        \"@opentelemetry/exporter-trace-otlp-http\": \"0.57.2\",\n        \"@opentelemetry/host-metrics\": \"0.35.5\",\n        \"@opentelemetry/instrumentation\": \"0.57.2\",\n        \"@opentelemetry/resource-detector-gcp\": \"0.33.0\",\n        \"@opentelemetry/resources\": \"1.30.1\",\n        \"@opentelemetry/sdk-metrics\": \"1.30.1\",\n        \"@opentelemetry/sdk-node\": \"0.57.2\",\n        \"@opentelemetry/sdk-trace-base\": \"1.30.1\",\n        \"@opentelemetry/sdk-trace-node\": \"1.30.1\",\n        \"@opentelemetry/semantic-conventions\": \"1.30.0\",\n```\n\nAdding Sentry as related just because the trace propagation is done through Sentry-related headers:\n\n<img width=\"687\" height=\"197\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/3cbb71ab-d611-4857-b7ba-06190071db0d\" />\n\nStack trace:\n```\nTypeError: _a.serialize is not a function\nat sdkSpanToOtlpSpan (trace/internal.js:14:83)\nat trace/internal.js:110:62\nat Array.map (<anonymous>)\nat spanRecordsToResourceSpans (trace/internal.js:110:42)\nat createExportTraceServiceRequest (trace/internal.js:74:24)\nat Object.serializeRequest (protobuf/trace.js:27:72)\nat OTLPExportDelegate.export (src/otlp-export-delegate.js:44:52)\nat OTLPTraceExporter.export (src/OTLPExporterBase.js:29:30)\nat Object.fn (lib/worker/index.js:88:32)\nat worker/lib/worker.js:899:29\nat Array.map (<anonymous>)\nat Worker.processSinkCalls (worker/lib/worker.js:897:41)\nat Worker.handleActivation (worker/lib/worker.js:778:32)\n```","createdAt":"2025-07-14T16:03:19Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1738#issuecomment-3070130687","viewerDidAuthor":false},{"id":"IC_kwDOEujx187J3zcz","author":{"login":"lukeramsden"},"authorAssociation":"CONTRIBUTOR","body":"Seeing this issue too\n\n```\n$ npm ls | grep @opentelemetry\n├── @opentelemetry/api@1.9.0\n├── @opentelemetry/auto-instrumentations-node@0.55.2\n├── @opentelemetry/exporter-trace-otlp-proto@0.57.0\n├── @opentelemetry/resources@1.30.0\n├── @opentelemetry/sdk-node@0.57.0\n├── @opentelemetry/sdk-trace-base@1.30.0\n├── @opentelemetry/semantic-conventions@1.34.0\n$ npm ls | grep @temporalio\n├── @temporalio/activity@1.13.0\n├── @temporalio/client@1.13.0\n├── @temporalio/common@1.13.0\n├── @temporalio/interceptors-opentelemetry@1.13.0\n├── @temporalio/testing@1.13.0\n├── @temporalio/worker@1.13.0\n├── @temporalio/workflow@1.13.0\n```\n\n\n```\n\"TypeError: _a.serialize is not a function\\n    at sdkSpanToOtlpSpan (/opt/app/lib/node_modules/@opentelemetry/exporter-trace-otlp-proto/node_modules/@opentelemetry/otlp-transformer/build/src/trace/internal.js:14:83)\\n    at /opt/app/lib/node_modules/@opentelemetry/exporter-trace-otlp-proto/node_modules/@opentelemetry/otlp-transformer/build/src/trace/internal.js:110:62\\n    at Array.map (<anonymous>)\\n    at spanRecordsToResourceSpans (/opt/app/lib/node_modules/@opentelemetry/exporter-trace-otlp-proto/node_modules/@opentelemetry/otlp-transformer/build/src/trace/internal.js:110:42)\\n    at createExportTraceServiceRequest (/opt/app/lib/node_modules/@opentelemetry/exporter-trace-otlp-proto/node_modules/@opentelemetry/otlp-transformer/build/src/trace/internal.js:74:24)\\n    at Object.serializeRequest (/opt/app/lib/node_modules/@opentelemetry/exporter-trace-otlp-proto/node_modules/@opentelemetry/otlp-transformer/build/src/trace/protobuf/trace.js:27:72)\\n    at OTLPExportDelegate.export (/opt/app/lib/node_modules/@opentelemetry/exporter-trace-otlp-proto/node_modules/@opentelemetry/otlp-exporter-base/build/src/otlp-export-delegate.js:44:52)\\n    at OTLPTraceExporter.export (/opt/app/lib/node_modules/@opentelemetry/exporter-trace-otlp-proto/node_modules/@opentelemetry/otlp-exporter-base/build/src/OTLPExporterBase.js:29:30)\\n    at Object.fn (/opt/app/lib/node_modules/@temporalio/interceptors-opentelemetry/lib/worker/index.js:91:32)\\n    at /opt/app/lib/node_modules/@temporalio/worker/lib/worker.js:1035:29\"\n```","createdAt":"2025-10-09T17:23:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/1738#issuecomment-3386849075","viewerDidAuthor":false}],"createdAt":"2025-07-04T16:13:50Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1738,"reactionGroups":[],"state":"CLOSED","title":"[Bug] opentelemetry traceState is handled properly in  makeWorkflowExporter","updatedAt":"2026-01-20T18:00:32Z","url":"https://github.com/temporalio/sdk-typescript/issues/1738"}
