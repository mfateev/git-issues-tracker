{"assignees":[],"author":{"id":"U_kgDOBeRo5Q","is_bot":false,"login":"brianlu-scale","name":"Brian Lu"},"body":"### What are you really trying to do?\r\n\r\nTrying to get worker deployments to work correctly in a container that uses yarn to only install dependencies, not devDependencies.\r\n\r\n### Describe the bug\r\n\r\nRunning the workers in Docker containers that are built with `yarn workspaces focus --production @packages/temporal-workflows` results in workers that won't execute with the following stack trace:\r\n```\r\n2022-08-04T03:32:56.766Z [ERROR] Failed to activate workflow {\r\n  runId: 'b2fd073b-42a6-40ce-b719-1468474d7f2c',\r\n  error: TypeError: (seconds || long_1.default.UZERO).mul is not a function\r\n      at tsToMs (/opt/app-root/src/.yarn/cache/@temporalio-internal-workflow-common-npm-1.0.0-rc.1-b66f54d7d6-4272b669aa.zip/node_modules/@temporalio/internal-workflow-common/lib/time.js:30:10)\r\n      at /opt/app-root/src/.yarn/cache/@temporalio-worker-npm-1.0.0-rc.1-2998f0d7a7-147819cf17.zip/node_modules/@temporalio/worker/lib/worker.js:664:90\r\n      at async /opt/app-root/src/.yarn/cache/@temporalio-worker-npm-1.0.0-rc.1-2998f0d7a7-147819cf17.zip/node_modules/@temporalio/worker/lib/tracing.js:65:20\r\n      at async /opt/app-root/src/.yarn/cache/@temporalio-worker-npm-1.0.0-rc.1-2998f0d7a7-147819cf17.zip/node_modules/@temporalio/worker/lib/worker.js:593:28,\r\n  workflowExists: false\r\n}\r\n```\r\n\r\nHowever, if we build this instead with `yarn workspaces focus --all @packages/temporal-workflows`, the worker/container works, which implies that some devDependency needs to be listed as a dependency (likely the `long` package).\r\n\r\n### Minimal Reproduction\r\n\r\nI'm having issues figuring out how to reproduce this or test this to be honest. I tried testing this solution by forking this repository to see if making the suggested changes would fix it but run into errors trying to use the forked repository as my `temporalio` version. I get the following error (https://community.temporal.io/t/fork-temporal-sdk-typescript/5630).\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\nContainers have been built on both M1Macs and Linux machines, using the latest Temporal SDK version. We're using yarn pnp and 3.2.0.\r\n\r\n### Additional context\r\n\r\nRelated to [this forum post](https://community.temporal.io/t/worker-error-with-mul-is-not-a-function/5573)","closedAt":"2022-08-12T23:29:35Z","comments":[{"id":"IC_kwDOEujx185IIJGC","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"In your stack trace, it's being used inside `internal-workflow-common`, where it's a dependency, not a devDependency, so it should be installed.\r\n\r\nhttps://github.com/temporalio/sdk-typescript/blob/723de0fbc7a04e68084ec99453578e7027eb3803/packages/internal-workflow-common/package.json#L16\r\n\r\nWhen you run without `--production` in the production Docker containers, there's no error? ","createdAt":"2022-08-10T03:01:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/810#issuecomment-1210093954","viewerDidAuthor":false},{"id":"IC_kwDOEujx185IVGax","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"The problem is that `protobufjs/light` delegates loading of `long` to the `@protobufjs/inquire` package. Now, the `@protobufjs/inquire` itself does not declare a dependency on `long` in its package.json.\r\n\r\nThis pattern works in most environment, thanks to the way traditional package managers lay out their node_modules directory, but is forbidden by Yarn 3 and PNPM, though the extend to which they goes in applying that restriction depend on various configuration item... Yarn 3's PnP is essentially the strictest of all.\r\n\r\nThis should be fixed in our next release.\r\n\r\nIn the mean time, it is possible to fix this locally by adding the following to your .yarnrc.yml file:\r\n```\r\npackageExtensions:\r\n  \"@protobufjs/inquire@*\":\r\n    dependencies:\r\n      long: \"5.2.0\"\r\n```\r\n","createdAt":"2022-08-12T20:31:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-typescript/issues/810#issuecomment-1213490865","viewerDidAuthor":false}],"createdAt":"2022-08-09T21:24:21Z","labels":[{"id":"MDU6TGFiZWwyNTQ1Mzg0MDA2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":810,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Issue with Long dependency being listed as devDependency","updatedAt":"2022-08-12T23:29:35Z","url":"https://github.com/temporalio/sdk-typescript/issues/810"}
