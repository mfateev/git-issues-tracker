{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNTA0MDQ5","is_bot":false,"login":"Quinn-With-Two-Ns","name":"Quinn Klassen"},"body":"## Expected Behavior\r\n\r\nRemoving/adding a local activity should fail with a nondeterminism error\r\n\r\n## Actual Behavior\r\n\r\nWorkflow succeeds \r\n\r\n## Steps to Reproduce the Problem\r\n\r\nIf you save a history for the following workflow, add or remove calls to `helloworldActivity`, and replay the replay does not error\r\n```\r\nfunc LocalActivityWorkflow(ctx workflow.Context, name string) error {\r\n\tao := workflow.LocalActivityOptions{\r\n\t\tScheduleToCloseTimeout: time.Minute,\r\n\t}\r\n\tctx = workflow.WithLocalActivityOptions(ctx, ao)\r\n\tvar helloworldResult string\r\n         workflow.ExecuteLocalActivity(ctx, helloworldActivity, name).Get(ctx, &helloworldResult)\r\n         workflow.ExecuteLocalActivity(ctx, helloworldActivity, name).Get(ctx, &helloworldResult)\r\n\treturn workflow.ExecuteLocalActivity(ctx, helloworldActivity, name).Get(ctx, &helloworldResult)\r\n}\r\n```\r\n\r\nNote: assuming https://github.com/temporalio/sdk-go/issues/876 is already resolved\r\n\r\nThis seems to be due to https://github.com/temporalio/sdk-go/blob/38b2b69f18bdc3bcaf1b4e48f940d1c60b5f9253/internal/internal_task_handlers.go#L919 when the workflow returns we skip adding to the replay commands https://github.com/temporalio/sdk-go/blob/38b2b69f18bdc3bcaf1b4e48f940d1c60b5f9253/internal/internal_task_handlers.go#L928\r\n\r\nThis issue probably effects more commands than just local activities. ","closedAt":"2023-01-04T21:27:37Z","comments":[{"id":"IC_kwDODN1w685QeO0m","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"I tried just removing these breaks and it seems to cause false positives with other commands like `UpsertMemo`","createdAt":"2022-12-13T23:57:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/983#issuecomment-1350102310","viewerDidAuthor":false},{"id":"IC_kwDODN1w685QeP4Z","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Ug, was introduced at the same as the other workflow completed ignoring stuff. Does it seem like too much of a burden to change to `w.isWorkflowCompleted && !w.isInReplayer {` on these and get the matcher working? We can discuss half-impl alternatives that at least solves matching completed workflows if not very well.","createdAt":"2022-12-13T23:59:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/983#issuecomment-1350106649","viewerDidAuthor":false},{"id":"IC_kwDODN1w685QedQe","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Looking at the error more closely the actual issue is the workflow execution commands are not in the replay history, but are in the real history causing a mismatch. hmm\r\n\r\n```\r\n--- FAIL: TestReplayTestSuite (0.00s)\r\n    --- FAIL: TestReplayTestSuite/TestContinueAsNewWorkflow (0.00s)\r\n        /Users/quinnklassen/Documents/Code/sdk-go/test/replaytests/replay_test.go:172: \r\n            \tError Trace:\t/Users/quinnklassen/Documents/Code/sdk-go/test/replaytests/replay_test.go:172\r\n            \tError:      \tReceived unexpected error:\r\n            \t            \tnondeterministic workflow: missing replay command for WorkflowExecutionContinuedAsNew: (EventId:5, EventTime:(), EventType:WorkflowExecutionContinuedAsNew, Version:0, TaskId:7343443, WorkerMayIgnore:false, Attributes:&HistoryEvent_WorkflowExecutionContinuedAsNewEventAttributes{WorkflowExecutionContinuedAsNewEventAttributes:&WorkflowExecutionContinuedAsNewEventAttributes{NewExecutionRunId:74f38af0-7c7d-4aae-bc10-6c34ba946693,WorkflowType:&v1.WorkflowType{Name:ContinueAsNewWorkflow,},TaskQueue:&v11.TaskQueue{Name:replay-test,Kind:Normal,},Input:&v1.Payloads{Payloads:[]*Payload{&Payload{Metadata:map[string][]byte{encoding: [106 115 111 110 47 112 108 97 105 110],},Data:[102 97 108 115 101],},},},WorkflowRunTimeout:0s,WorkflowTaskTimeout:10s,WorkflowTaskCompletedEventId:4,BackoffStartInterval:<nil>,Initiator:Unspecified,Failure:nil,LastCompletionResult:nil,Header:&v1.Header{Fields:map[string]*Payload{},},Memo:nil,SearchAttributes:nil,},})\r\n            \tTest:       \tTestReplayTestSuite/TestContinueAsNewWorkflow\r\n```","createdAt":"2022-12-14T00:25:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/983#issuecomment-1350161438","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Qegju","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"possibly we could add all the the workflow execution commands to `skipDeterministicCheckForEvent` as the execution result mismatch would get caught by the replayer at a higher level, thoughts @cretz ? ","createdAt":"2022-12-14T00:32:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/983#issuecomment-1350174958","viewerDidAuthor":false},{"id":"IC_kwDODN1w685QjDC4","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Not following exactly as the original description was saying \"the replay does not error\" was the issue but this is showing an error.\r\n\r\nRegardless, can you replicate this error in replay today? Even without the replayer (i.e. unfinished workflow on another worker or a zero-cache setup)? What _exactly_ is the problem here? (sorry for not understanding) I want to be _very_ cautious about doing anything but fixing something that may already be broken and even then be very cautious there.\r\n\r\nThe goal was to get replayer working with no effect to existing workflows, but if existing workflow replay checks are broken giving false mismatches, we should probably fix that. I'd be hesitant to add more mismatch check possibilities to non-replayer workflow checks today.","createdAt":"2022-12-14T13:36:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/983#issuecomment-1351364792","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Qkz6a","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"The error I posted is the error we get if we remove the breaks in other words making the change you suggested `w.isWorkflowCompleted && !w.isInReplayer {` .\r\n\r\n>Regardless, can you replicate this error in replay today? Even without the replayer (i.e. unfinished workflow on another worker or a zero-cache setup)? \r\n\r\nNo it requires making the above code changes.\r\n\r\n>I want to be very cautious about doing anything but fixing something that may already be broken and even then be very cautious there.\r\n\r\ncompletely agree, the original issue is as I described in this issue. That issue could be solved by removing the `break` statements on workflow complete. Removing those breaks causes the `WorkflowExecution...` events to end up in the his `respondEvents` but not the `replayEvents`","createdAt":"2022-12-14T17:32:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/983#issuecomment-1351827098","viewerDidAuthor":false},{"id":"IC_kwDODN1w685QlGYA","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Now I definitely admit ignorance wrt respond vs replay, etc. I'm on board w/ any solution that lets most non-determinisms get caught by the replayer for a complete workflow _and_, most importantly, has no impact on non-replayer code today from a user POV. If that means fixing this or ignoring it, your call.","createdAt":"2022-12-14T18:18:36Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/983#issuecomment-1351902720","viewerDidAuthor":false}],"createdAt":"2022-12-13T23:06:21Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":983,"reactionGroups":[],"state":"CLOSED","title":"Replaying non deterministic workflows that use local activities can give false negatives","updatedAt":"2023-01-04T21:27:37Z","url":"https://github.com/temporalio/sdk-go/issues/983"}
