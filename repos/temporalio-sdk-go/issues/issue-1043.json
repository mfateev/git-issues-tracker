{"assignees":[],"author":{"id":"MDQ6VXNlcjczMjY4MDA=","is_bot":false,"login":"tarampampam","name":"PÐ°ramtamtÄm"},"body":"Hi there and thank you so much for the great service!\r\n\r\nMy question may be a bit stupid, but anyway - is there any legal way to get the task queue size? I mean: \"How many tasks in the task queue named `%name%` are scheduled for processing, but have not been processed yet?\".\r\n\r\nThis is necessary to implement the autoscaling mechanism (more tasks in queue for processing - more workers, and vice versa) on my side. And yes, I know about the \"[custom workers metrics](https://github.com/temporalio/samples-go/tree/main/metrics)\", but I am looking for a better (read - simpler) way.\r\n\r\nI use the latest version of Temporal with PostgreSQL as storage.","closedAt":"2023-03-01T04:30:10Z","comments":[{"id":"IC_kwDODN1w685Vbsvc","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"You can use `Client.DescribeTaskQueue` which is a low-level call that returns https://pkg.go.dev/go.temporal.io/api/workflowservice/v1#DescribeTaskQueueResponse that contains a status with a backlog count hint, but it may be a fuzzy number. You can do the same via tctl: https://docs.temporal.io/tctl-v1/taskqueue/#describe.\r\n\r\n> This is necessary to implement the autoscaling mechanism\r\n\r\nI am not sure that is the best way to scale workers. A better way is to check whether the workers have slots of work available to still perform. If they don't, you need more workers usually. See https://docs.temporal.io/application-development/worker-performance.\r\n\r\nYou can also feel free to come join us on the forums or public Slack to discuss worker tuning.","createdAt":"2023-02-16T16:03:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1043#issuecomment-1433324508","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Vczsd","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"Take a look at these docs also: https://docs.temporal.io/server/production-deployment#faqs\r\nIn general we recommend scaling workers based on `schedule_to_start_latency`.","createdAt":"2023-02-16T19:39:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1043#issuecomment-1433615133","viewerDidAuthor":false},{"id":"IC_kwDODN1w685VfDMV","author":{"login":"tarampampam"},"authorAssociation":"NONE","body":"```go\r\n// I have tried with `video_transcoding` too with different types of taskqueueType\r\nresp, rErr := temporal.Client().DescribeTaskQueue(ctx, \"video-transcoding\", enums.TASK_QUEUE_TYPE_ACTIVITY)\r\nif rErr != nil {\r\n\treturn rErr\r\n}\r\n\r\nfmt.Println(resp.TaskQueueStatus)\r\n```\r\n\r\nIs always `nil`, but... Why? A tasks queue exists (I have workers on it when I execute `DescribeTaskQueue`).\r\n\r\nAnd about the `schedule_to_start_latency` metric:\r\n\r\n```txt\r\ntask_schedule_to_start_latency_sum{namespace=\"default\",operation=\"RecordActivityTaskStarted\",service_name=\"history\",task_type=\"Activity\",taskqueue=\"default\"} 4.012997128000003\r\ntask_schedule_to_start_latency_count{namespace=\"default\",operation=\"RecordActivityTaskStarted\",service_name=\"history\",task_type=\"Activity\",taskqueue=\"default\"} 314\r\ntask_schedule_to_start_latency_sum{namespace=\"default\",operation=\"RecordActivityTaskStarted\",service_name=\"history\",task_type=\"Activity\",taskqueue=\"video_transcoding\"} 421589.4196587619\r\ntask_schedule_to_start_latency_count{namespace=\"default\",operation=\"RecordActivityTaskStarted\",service_name=\"history\",task_type=\"Activity\",taskqueue=\"video_transcoding\"} 75\r\ntask_schedule_to_start_latency_sum{namespace=\"default\",operation=\"RecordWorkflowTaskStarted\",service_name=\"history\",task_type=\"Workflow\",taskqueue=\"__sticky__\"} 4.952772867000001\r\ntask_schedule_to_start_latency_count{namespace=\"default\",operation=\"RecordWorkflowTaskStarted\",service_name=\"history\",task_type=\"Workflow\",taskqueue=\"__sticky__\"} 362\r\ntemporal_activity_schedule_to_start_latency_sum{activity_type=\"temporal_sys_tq_scanner_scvg_activity\",client_name=\"temporal_go\",namespace=\"temporal_system\",service_name=\"worker\",task_queue=\"temporal_sys_tq_scanner_taskqueue_0\",worker_type=\"none\",workflow_type=\"temporal_sys_tq_scanner_workflow\"} 0.008792396\r\ntemporal_activity_schedule_to_start_latency_count{activity_type=\"temporal_sys_tq_scanner_scvg_activity\",client_name=\"temporal_go\",namespace=\"temporal_system\",service_name=\"worker\",task_queue=\"temporal_sys_tq_scanner_taskqueue_0\",worker_type=\"none\",workflow_type=\"temporal_sys_tq_scanner_workflow\"} 1\r\n```\r\n\r\n> Full diff you can find here: https://www.diffchecker.com/YvohbHiY/ (TTL 1 week). On the left side, tasks were scheduled, but workers were not started. On the right side - I ran the workers, and when ~80% of the activities were processed - I captured the metrics again\r\n\r\nIt looks like static, because when I have ~10 scheduled activities on the `video-transcoding` without workers on it, and when workers are started to process those jobs - nothing was changed :(","createdAt":"2023-02-17T07:13:33Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1043#issuecomment-1434202901","viewerDidAuthor":false},{"id":"IC_kwDODN1w685VguMl","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Is always nil, but... Why?\r\n\r\nI think you'll have to call `Client.WorkflowService().DescribeTaskQueue(` with a full https://pkg.go.dev/go.temporal.io/api/workflowservice/v1#DescribeTaskQueueRequest that has `IncludeTaskQueueStatus` as `true` to get status. I had forgotten about that flag. Usually doing a low-level task queue describe is not used for scaling, there are other methods. See the worker tuning guide I mentioned.\r\n\r\n> It looks like static, because when I have ~10 scheduled activities on the video-transcoding without workers on it\r\n\r\nIf activities don't start the metric won't have value. It is a measurement of the difference between scheduled and start, not scheduled and current time if never started.","createdAt":"2023-02-17T13:18:54Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1043#issuecomment-1434641189","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Vg89Q","author":{"login":"tarampampam"},"authorAssociation":"NONE","body":"@cretz Thanks for your answer! But it still doesn't work for me :( At this moment I have many scheduled activities in the task queue named `video-transcoding`:\r\n\r\n![image](https://user-images.githubusercontent.com/7326800/219673769-5dd99cdd-d737-4702-ab6b-d4c658c71e68.png)\r\n\r\n![image](https://user-images.githubusercontent.com/7326800/219675015-4b4e2015-f4d5-4566-b8ea-1fe5b3681903.png)\r\n\r\nBut without running workers for these activities - they should be in the backlog, right? To make a decision to up or downscale the workers (attached to this task queue) I read the server metrics, and as said in the documentation:\r\n\r\n> Poll Success Rate = (poll_success + poll_success_sync) / (poll_success + poll_success_sync + poll_timeouts)\r\n>\r\n> Poll Success Rate should be >90% in most cases of systems with a steady load. For high volume and low latency, try to target >95%.\r\n\r\nI got: `{PollSuccess:72 PollSuccessSync:50 PollTimeouts:16}; Poll Success Rate: 88.40579710144928`. After a set of experiments, I noticed this value does not depend on the actual workers' count (all tests were made on my laptop).\r\n\r\nAn attempt to get the backlog size is also failed:\r\n\r\n```go\r\nresp, tErr := temporal.Client().WorkflowService().DescribeTaskQueue(ctx, &workflowservice.DescribeTaskQueueRequest{\r\n  Namespace: opt.temporal.namespace,\r\n  TaskQueue: &v14.TaskQueue{\r\n    Name: \"video-transcoding\",\r\n  },\r\n  TaskQueueType: enums.TASK_QUEUE_TYPE_ACTIVITY,\r\n  IncludeTaskQueueStatus: true,\r\n})\r\n\r\nif tErr != nil {\r\n  return tErr\r\n}\r\n\r\nlog.Info(\"Task queue\", zap.Any(\"resp\", resp))\r\n```\r\n\r\nIn the logs:\r\n\r\n```\r\nTask queue      {\"resp\": \"&DescribeTaskQueueResponse{Pollers:[]*PollerInfo{},TaskQueueStatus:&v14.TaskQueueStatus{BacklogCountHint:0,ReadLevel:700000,AckLevel:700000,RatePerSecond:1000,TaskIdBlock:&TaskIdBlock{StartId:800001,EndId:900000,},},}\"}\r\n```\r\n\r\nAs you can see `BacklogCountHint` is `0` (always). What am I doing wrong? ðŸ˜ž ","createdAt":"2023-02-17T14:09:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1043#issuecomment-1434701648","viewerDidAuthor":false},{"id":"IC_kwDODN1w685WAmVb","author":{"login":"tarampampam"},"authorAssociation":"NONE","body":"Guys?","createdAt":"2023-02-24T07:49:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1043#issuecomment-1442997595","viewerDidAuthor":false},{"id":"IC_kwDODN1w685WDxkt","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> But without running workers for these activities - they should be in the backlog, right?\r\n\r\nYes, but the hint may not reflect that value. I am getting details on that value now, but it is a mostly internal value that you should not use for scaling workers. Please do not use this for scaling and ignore this low-level API task queue status hint for your use case.\r\n\r\n> To make a decision to up or downscale the workers (attached to this task queue) I read the server metrics, and as said in the documentation\r\n\r\nI think that part of the documentation you were looking at is only for downscaling (i.e. having too many workers). To know whether to scale up, you should use the available slots metric for knowing when to scale up (or change options).\r\n\r\nSimply put - you can use server-side poll metrics to see if there are more workers polling than there are tasks to be given. This will let you know you have too many (which is mostly harmless). You can use SDK-side slot metrics to know whether the slots are being all used up. This will let you know you need to scale up (or increase some of the max-concurrent metrics).\r\n\r\nIf this is unclear in https://docs.temporal.io/application-development/worker-performance, can we improve it in some way?\r\n\r\nAlso, for more back-and-forth communication like questions, feel free to ask in our forums or Slack.","createdAt":"2023-02-24T15:15:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1043#issuecomment-1443830061","viewerDidAuthor":false}],"createdAt":"2023-02-16T14:51:01Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDky","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1043,"reactionGroups":[],"state":"CLOSED","title":"[question] Is there any way to get the task queue size (backlog)?","updatedAt":"2023-03-01T04:30:10Z","url":"https://github.com/temporalio/sdk-go/issues/1043"}
