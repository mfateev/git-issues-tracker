{"assignees":[],"author":{"id":"MDQ6VXNlcjQ0NjA0ODU5","is_bot":false,"login":"itendtolosealot","name":""},"body":"## Expected Behavior\r\nConcurrent accesses to the maps need to be protected\r\n\r\n## Actual Behavior\r\nConcurrent access to the map is causing SDK to crash, leading to a stuck client. \r\n\r\n## Steps to Reproduce the Problem\r\nWe are unaware of specific  ways to reproduce the issue. This happens intermittently and when it does, the impact is catastrophic as it impacts all the workflows executing on the runner.  \r\n\r\nWe are using Temporal (and Temporal SDK) to develop a Serverless Workflow based orchestrator. We encountered this issue when a parent workflow triggers a large number of child workflows (Ex: ForEach statement in SWF). During the execution of the child, we are getting stack-traces like below \r\n\r\n```\r\nfatal error: concurrent map writes\r\n\r\ngoroutine 84634 [running]:\r\ngo.temporal.io/sdk/internal.(*commandsHelper).addCommand(0xc00211ed20, {0x31d45e0, 0xc0011bbfe0})\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.23.1/internal/internal_command_state_machine.go:958 +0x1eb\r\ngo.temporal.io/sdk/internal.(*activityCommandStateMachine).cancel(0xc00100d0e0)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.23.1/internal/internal_command_state_machine.go:591 +0x7f\r\ngo.temporal.io/sdk/internal.(*commandsHelper).requestCancelActivityTask(0x31a57a0?, {0xc0013a0580?, 0x132eb00?})\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.23.1/internal/internal_command_state_machine.go:1020 +0x39\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentImpl).RequestCancelActivity(0xc00111f080, {{0xc0013a0580?, 0x2705c20?}})\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.23.1/internal/internal_event_handlers.go:663 +0x38\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteActivity.func3({0xc000a74fb8?, 0xc000615f28?}, 0x0?)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.23.1/internal/workflow.go:622 +0x75\r\ngo.temporal.io/sdk/internal.(*channelImpl).Close(0xc002418040?)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.23.1/internal/internal_workflow.go:887 +0x97\r\ngo.temporal.io/sdk/internal.(*cancelCtx).cancel(0xc002418000, 0x0, {0x31a57a0, 0xc0000bfd40})\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.23.1/internal/context.go:333 +0xff\r\ngo.temporal.io/sdk/internal.(*cancelCtx).cancel(0xc002c6dc20, 0x1, {0x31a57a0, 0xc0000bfd40})\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.23.1/internal/context.go:340 +0x1e2\r\ngo.temporal.io/sdk/internal.WithCancel.func1()\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.23.1/internal/context.go:196 +0x30\r\nruntime.Goexit()\r\n\t/usr/local/go/src/runtime/panic.go:540 +0x1bb\r\ngo.temporal.io/sdk/internal.(*coroutineState).exit.func1({0xc000ac4000?, 0x3196760?}, 0xc000a58101?)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.23.1/internal/internal_workflow.go:992 +0x17\r\ngo.temporal.io/sdk/internal.(*coroutineState).initialYield(0xc00211edc0, 0x3, {0xc000a58120, 0x19})\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.23.1/internal/internal_workflow.go:914 +0x89\r\ngo.temporal.io/sdk/internal.(*coroutineState).yield(...)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.23.1/internal/internal_workflow.go:923\r\ngo.temporal.io/sdk/internal.(*channelImpl).Receive(0xc000f2e510, {0x31c5740, 0xc0015b28a0}, {0x0, 0x0})\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.23.1/internal/internal_workflow.go:715 +0x237\r\ngo.temporal.io/sdk/internal.(*futureImpl).Get(0xc0000ce3c0, {0x31c5740, 0xc0015b28a0}, {0x2718020?, 0xc000137080})\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.23.1/internal/internal_workflow.go:318 +0x66\r\ngitlab.eng.vmware.com/core-build/swf-runtime/pkg/runtime.(*ForEach).runBatch(0x7?, {0x31c5740, 0xc0015b28a0}, {0xc000972000?, 0xc000aac501?, 0xc000844ba0?}, {0xc0007f9000?, 0xc00099f758?, 0x2c179b4?}, {0x2c00278, ...}, ...)\r\n\t/work/pkg/runtime/foreach.go:153 +0x215\r\n```\r\n\t\r\n\tThe snippet of the code for foreach.go that's relevant to this is given below\r\n\t\r\n\t\r\n```\r\nfutures := lo.Map(list, func(input map[string]any, i int) workflow.Future {\r\n\t\tfuture, settable := workflow.NewFuture(ctx)\r\n\t\tworkflow.Go(ctx, func(ctx workflow.Context) {\r\n\t\t\tconfig := &RunActionConfiguration{\r\n\t\t\t\tActions:        actions,\r\n\t\t\t\tMode:           mode,\r\n\t\t\t\tParams:         input,\r\n\t\t\t\tWorkflow:       configuration.Workflow,\r\n\t\t\t\tEnvironmentID:  configuration.EnvironmentID,\r\n\t\t\t\tWorkflowURL:    configuration.WorkflowURL,\r\n\t\t\t\tOrganizationID: configuration.OrganizationID,\r\n\t\t\t}\r\n\r\n\t\t\tsettable.Set(f.actionsRunner.Run(ctx, config))\r\n\t\t})\r\n\t\treturn future\r\n\t})\r\n\r\n\tvar results []map[string]any\r\n\r\n\tvar errList error\r\n\tfor _, future := range futures {\r\n\t\tresult := map[string]any{}\r\n\t\tif err := future.Get(ctx, &result); err != nil {\r\n\t\t\terrList = multierr.Append(errList, err)\r\n\t\t} else {\r\n\t\t\tresults = append(results, result)\r\n\t\t}\r\n\t}\r\n```\r\nThe line 153 in the foreach.go refers to future.Get()\r\n\r\n\r\n## Specifications\r\n\r\n  - Version: 1.23.1\r\n  - Platform: Linux/Kubernetes\r\n","closedAt":"2023-10-16T16:00:09Z","comments":[{"id":"IC_kwDODN1w685jh27j","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"What does `lo.Map` do and what is its signature?","createdAt":"2023-08-08T15:17:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1669820131","viewerDidAuthor":false},{"id":"IC_kwDODN1w685jh84x","author":{"login":"itendtolosealot"},"authorAssociation":"NONE","body":"```\r\nfunc Map[T any, R any](collection []T, iteratee func(item T, index int) R) []R {\r\n\tresult := make([]R, len(collection))\r\n\r\n\tfor i, item := range collection {\r\n\t\tresult[i] = iteratee(item, i)\r\n\t}\r\n\r\n\treturn result\r\n}\r\n```\r\nIt operates as a Map operation. ","createdAt":"2023-08-08T15:31:48Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1669844529","viewerDidAuthor":false},{"id":"IC_kwDODN1w685jilFP","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Can you share what else is happening in your workflow? From the stack trace it looks like you are cancelling the context, but that is not in the code sample you shared.","createdAt":"2023-08-08T17:16:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1670009167","viewerDidAuthor":false},{"id":"IC_kwDODN1w685jkxXL","author":{"login":"itendtolosealot"},"authorAssociation":"NONE","body":"[runner_logs (2).txt](https://github.com/temporalio/sdk-go/files/12297802/runner_logs.2.txt)\r\n\r\nThe workflow is invoking a collection of actionRunners, which in turn execute the ChildWorkflow. As this is a batch, the child workflows are executed in parallel.  So, in the actionRunner code,  we create a **new** context using the WithCancel() function and cancel the **new** context when the actionRunner work is completed.  \r\n\r\nAlso, at the end of the Child Workflow execution, the context is cancelled. This is because the runner doesn't distinguish between Child/Parent. At the end of every workflow execution the context is canceled.\r\n\r\nAre these incorrect use of the SDK? I am attaching the complete logs.\r\n\r\n\r\n","createdAt":"2023-08-09T03:02:55Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1670583755","viewerDidAuthor":false},{"id":"IC_kwDODN1w685ju7Ho","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Are you seeing this exception in your parent or child workflow?\r\n\r\nAs long as your following the constraints for programming in a workflow like determinism and not using goroutines/synchronization primitives, etc.","createdAt":"2023-08-10T13:39:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1673245160","viewerDidAuthor":false},{"id":"IC_kwDODN1w685jvyWx","author":{"login":"itendtolosealot"},"authorAssociation":"NONE","body":"The failure is seen while the parent workflow is waiting on Futures from all the Child Executions. \r\n\r\nWe are not using go routines in the workflow tasks. We use workflow.Go. \r\n\r\nIn the runner we have a single  long running house keeping task, which is running as a go routine.  It is not responsible for activities or tasks. This go routine uses Synchronization primitives. \r\n\r\nAt the point when this go routine gets triggered, there is no workflow.Context. Consequently, it is not possible to trigger this as a separate workflow.Go routine. ","createdAt":"2023-08-10T15:39:38Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1673471409","viewerDidAuthor":false},{"id":"IC_kwDODN1w685jwBFL","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"That should all be fine, this seems like an SDK bug. Are you using any disconnected contexts in this workflow?","createdAt":"2023-08-10T16:20:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1673531723","viewerDidAuthor":false},{"id":"IC_kwDODN1w685jwK2t","author":{"login":"itendtolosealot"},"authorAssociation":"NONE","body":"Yes. Whenever a Parent/Child workflow is completed, it creates a Disconnected context. This is used to send events from the runner to an another entity to indicate the success/failure of the workflow.  \r\n\r\n","createdAt":"2023-08-10T16:49:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1673571757","viewerDidAuthor":false},{"id":"IC_kwDODN1w685jwMGV","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"ack most likely another instance of https://github.com/temporalio/sdk-go/issues/743","createdAt":"2023-08-10T16:53:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1673576853","viewerDidAuthor":false},{"id":"IC_kwDODN1w685j4Iq4","author":{"login":"itendtolosealot"},"authorAssociation":"NONE","body":"Hi Quinn,\r\nThank you so much for providing a likely diagnosis for this issue. I went through #743. People appear to have been struggling to reproduce the issue. In our case, it was observed very frequently (one in 3 experiments). \r\nSetup:\r\n1. Temporal (separate pods for history, matching, front-end, worker, web, etc) deployed Kubernetes Cluster deployed inside a VM\r\n2. Task/Activity Pollers set to 32\r\n3. We trigger a workflow, that invokes  128 child workflows in parallel using Foreach\r\n\r\nRepeat the experiment. We hit it one out of 3 times\r\n\r\nWith the default poller setting of 2, we experienced it once in 10 experiments. \r\n\r\nIn our case, we didn't experience any significant loading as well. \r\n\r\nThanks,\r\nAshvin","createdAt":"2023-08-12T03:42:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1675659960","viewerDidAuthor":false},{"id":"IC_kwDODN1w685kLdz5","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Hi Ashvin\r\n\r\nWhat has blocked us from debugging/fixing this issue is a lack of a full reproduction.\r\n\r\nWe understand it is some combination of child workflow, cancelation and possibly using a disconnected context leads to a race in the SDK\r\n\r\n\r\n","createdAt":"2023-08-16T14:29:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1680727289","viewerDidAuthor":false},{"id":"IC_kwDODN1w685klwdz","author":{"login":"itendtolosealot"},"authorAssociation":"NONE","body":"We are looking for some workarounds for this. Are there any that come to your mind? ","createdAt":"2023-08-22T07:23:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1687619443","viewerDidAuthor":false},{"id":"IC_kwDODN1w685k1rKl","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"No unfortunately ","createdAt":"2023-08-24T14:28:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1691792037","viewerDidAuthor":false},{"id":"IC_kwDODN1w685k4X-E","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"@itendtolosealot I believe I found the issue. A potential work around, until I can PR and release a fix, would be to not use defers in workflows.\r\n","createdAt":"2023-08-24T22:32:54Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1692499844","viewerDidAuthor":false},{"id":"IC_kwDODN1w685npOwp","author":{"login":"itendtolosealot"},"authorAssociation":"NONE","body":"I wanted to thank you for the Workaround. We have applied the WA and ran 10-12 runs at scale. We did not see the issue.","createdAt":"2023-09-28T10:10:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1738861609","viewerDidAuthor":false},{"id":"IC_kwDODN1w685pMLoy","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Closing as the fix has no been merged and released","createdAt":"2023-10-16T16:00:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1190#issuecomment-1764801074","viewerDidAuthor":false}],"createdAt":"2023-08-08T15:09:02Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1190,"reactionGroups":[],"state":"CLOSED","title":"Temporal SDK crash ","updatedAt":"2023-10-16T16:00:09Z","url":"https://github.com/temporalio/sdk-go/issues/1190"}
