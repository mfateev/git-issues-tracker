{"assignees":[{"id":"MDQ6VXNlcjIwNTA0MDQ5","login":"Quinn-With-Two-Ns","name":"Quinn Klassen","databaseId":0}],"author":{"id":"MDQ6VXNlcjE3Mzk2Mzky","is_bot":false,"login":"subhan-nadeem","name":"Subhan Nadeem"},"body":"## Expected Behavior\r\n\r\n- `workflow.ErrSessionFailed` is returned when attempting to reschedule an activity after the process on which a session exists is restarted.\r\n\r\n## Actual Behavior\r\n\r\n- After process restarts, session is recreated with the same ID and workflows are scheduled on the same task queue as the previous session.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Start a local worker that executes below workflow, make note of the session ID logged to screen\r\n  1. Kill the local worker, wait ~1 minute (default session heartbeat timeout is 20 seconds, at which point the session should be marked as 'failed')\r\n  1. Restart the local worker. The session is recreated with the same ID and `workflow.ErrSessionFailed` is not returned.\r\n\r\n```\r\n func MyWorkflow(\r\n\tctx workflow.Context,\r\n) (error) {\r\n\tctx = workflow.WithActivityOptions(\r\n\t\tctx,\r\n\t\tworkflow.ActivityOptions{\r\n\t\t\tStartToCloseTimeout: 10 * time.Minute,\r\n\t\t\tHeartbeatTimeout:    1 * time.Minute,\r\n\t\t\tRetryPolicy: &temporal.RetryPolicy{\r\n\t\t\t\tMaximumAttempts: 1,\r\n\t\t\t},\r\n\t\t},\r\n\t)\r\n\r\n\tctx, err := workflow.CreateSession(ctx, &workflow.SessionOptions{\r\n\t\tExecutionTimeout: math.MaxInt64,\r\n\t\tCreationTimeout:  1 * time.Minute,\r\n\t})\r\n\tif err != nil {\r\n\t\treturn errors.Wrap(err, \"creating session context\")\r\n\t}\r\n\r\n\tfmt.Println(\"SESSION ID: \" + workflow.GetSessionInfo(ctx).SessionID)\r\n\r\n\terr = workflow.ExecuteActivity(\r\n\t\tctx,\r\n\t\tMyActivity,\r\n\t).Get(ctx, nil)\r\n\tif err == nil {\r\n\t\treturn errors.Wrap(err, \"no error found\")\r\n\t}\r\n// kill the worker while first activity is in progress, then spin worker back up. this should cause second activity to execute\r\n\terr = workflow.ExecuteActivity(\r\n\t\tctx,\r\n\t\tMyActivity,\r\n\t).Get(ctx, nil)\r\n\tif errors.Is(err, workflow.ErrSessionFailed) {\r\n\t\treturn errors.Wrap(err, \"found session failure error\")\r\n\t} else {\r\n\t\treturn errors.Wrap(err, \"did not find session failure error\")\r\n\t}\r\n}\r\n\r\nfunc MyActivity(ctx context.Context) error {\r\n\ttime.Sleep(1 * time.Minute)\r\n\treturn nil\r\n}\r\n```\r\n\r\n\r\n\r\n## Specifications\r\n\r\n  - Version: v1.13.0\r\n  - Platform: M1 MacOS\r\n","closedAt":"2025-02-04T18:26:33Z","comments":[{"id":"IC_kwDODN1w685LbhMw","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Version: v1.13.0\r\n\r\n@subhan-nadeem - We have made a lot of improvements since this version, most importantly #746. Can you upgrade and confirm that this issue persists? ","createdAt":"2022-10-03T14:12:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/926#issuecomment-1265505072","viewerDidAuthor":false},{"id":"IC_kwDODN1w685LjBIt","author":{"login":"subhan-nadeem"},"authorAssociation":"NONE","body":"> > Version: v1.13.0\r\n> \r\n> @subhan-nadeem - We have made a lot of improvements since this version, most importantly #746. Can you upgrade and confirm that this issue persists?\r\n\r\nI ran the above test on v1.18.0. \r\n\r\nAfter killing the worker, the workflow event history reported an `ActivityTaskTimedOut` failure for `internalSessionCreationActivity` with message: `activity ScheduleToStart timeout\r\nCaused By: activity Heartbeat timeout` (this seems like the intended behaviour)\r\n\r\nAfter restarting the worker, the worker immediately reported a session failure, cancelled the hanging activity, and then the entire workflow (see logs below). This part I'm now confused about; is this intended behaviour? I would ideally like to catch the session failure in the workflow somehow and restart the workflow, rather than having it be cancelled.\r\n\r\n```\r\n12:11:34.508 Session failed                                                        log/with_logger.go:56                                                           \r\n{\r\n  \"Attempt\": 1,\r\n  \"Error\": \"activity error (type: internalSessionCreationActivity, scheduledEventID: 6, startedEventID: 0, identity: ): activity ScheduleToStart timeout (type: ScheduleToStart): activity Heartbeat timeout (type: Heartbeat)\",\r\n  \"Namespace\": \"default\",\r\n  \"RunID\": \"be99c277-f66e-4551-ad2e-829422505b09\",\r\n  \"TaskQueue\": \"TASK_QUEUE\",\r\n  \"WorkerID\": \"76929@LUSJCRXV6CV6K@\",\r\n  \"WorkflowID\": \"0bb2c03d-c02a-4cec-bd95-9aeb3ef03109\",\r\n  \"WorkflowType\": \"MyWorkflow\",\r\n  \"sessionID\": \"cc31806d-4f10-42df-9da1-3e03078d41b6\"\r\n}\r\n\r\n12:11:34.508 RequestCancelActivity                                                 log/with_logger.go:56                                                           \r\n{\r\n  \"ActivityID\": \"11\",\r\n  \"Attempt\": 1,\r\n  \"Namespace\": \"default\",\r\n  \"RunID\": \"be99c277-f66e-4551-ad2e-829422505b09\",\r\n  \"TaskQueue\": \"TASK_QUEUE\",\r\n  \"WorkerID\": \"76929@LUSJCRXV6CV6K@\",\r\n  \"WorkflowID\": \"0bb2c03d-c02a-4cec-bd95-9aeb3ef03109\",\r\n  \"WorkflowType\": \"Myworkflow\"\r\n}\r\n```","createdAt":"2022-10-04T19:17:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/926#issuecomment-1267470893","viewerDidAuthor":false},{"id":"IC_kwDODN1w685LjGvC","author":{"login":"subhan-nadeem"},"authorAssociation":"NONE","body":"\r\nI did notice this however on v1.18.0:\r\n\r\n- If I kill the worker with the session and start it back up after its `HeartbeatTimeout` and before its `CreationTimeout`, the session gets recreated with the same ID without any session failures reported (this seems like a bug?)\r\n- The activity I run reports a heartbeat error during the time the worker is down, and reschedules itself for retry on the same task queue it was scheduled on initially. Because the original session worker died, I believe that task queue disappears and the activity hangs in the \"Scheduled\" state forever, even after I restart the session worker","createdAt":"2022-10-04T19:40:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/926#issuecomment-1267493826","viewerDidAuthor":false},{"id":"IC_kwDODN1w685L5994","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> After restarting the worker, the worker immediately reported a session failure, cancelled the hanging activity, and then the entire workflow (see logs below). This part I'm now confused about; is this intended behaviour? I would ideally like to catch the session failure in the workflow somehow and restart the workflow, rather than having it be cancelled.\r\n\r\nYes, I believe this is the intended behavior and you would setup workflow retry policy to retry the workflow since your session failed. Or you can react to the session failure explicitly.\r\n\r\n> If I kill the worker with the session and start it back up after its HeartbeatTimeout and before its CreationTimeout, the session gets recreated with the same ID without any session failures reported (this seems like a bug?)\r\n\r\nIs this after the session has started? Heartbeat timeout only applies after session start.\r\n\r\n> activity hangs in the \"Scheduled\" state forever, even after I restart the session worker\r\n\r\nThis may be a bug. The activity should be marked cancelled. I will check on this.","createdAt":"2022-10-10T15:29:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/926#issuecomment-1273487224","viewerDidAuthor":false},{"id":"IC_kwDODN1w685MvZ1W","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"> The activity I run reports a heartbeat error during the time the worker is down, and reschedules itself for retry on the same task queue it was scheduled on initially. Because the original session worker died, I believe that task queue disappears and the activity hangs in the \"Scheduled\" state forever, even after I restart the session worker\r\n\r\nWhat steps did you take to cause this behavior?  I was not able to reproduce this, but maybe I need to kill the worker at a specific time.\r\n\r\nFor the original issue, along with the suggestion @cretz made we have an open feature to make sessions handle worker restart smoother https://github.com/temporalio/sdk-go/issues/937.","createdAt":"2022-10-21T22:27:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/926#issuecomment-1287494998","viewerDidAuthor":false},{"id":"IC_kwDODN1w686dCxC1","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Closing due to lack of reproduction, can reopen if there is more information","createdAt":"2025-02-04T18:26:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/926#issuecomment-2634748085","viewerDidAuthor":false}],"createdAt":"2022-10-01T03:54:29Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"},{"id":"LA_kwDODN1w687UGgkJ","name":"external dependency","description":"Waiting on something externally","color":"c5def5"}],"milestone":null,"number":926,"reactionGroups":[],"state":"CLOSED","title":"Unable to reproduce `workflow.ErrSessionFailed`, session gets recreated with same ID after process restarts","updatedAt":"2025-02-04T18:26:35Z","url":"https://github.com/temporalio/sdk-go/issues/926"}
