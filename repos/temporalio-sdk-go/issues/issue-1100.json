{"assignees":[],"author":{"id":"MDQ6VXNlcjY3NDUzMTcy","is_bot":false,"login":"qiuyijie-stripe","name":""},"body":"## Expected Behavior\r\nSay I expect `testWorkflow` to invoke `testActivity` twice with certain arguments\r\n```\r\nenv.OnActivity(testActivity, mock.Anything, testActivityParams{...}).Return(...).Times(2) \r\nreq := testWorkflowRequest{...}\r\n\r\n// Workflow actually invokes testActivity three times. Expect to see a test failure here due to the extra unexpected invocation.\r\nenv.ExecuteWorkflow(testWorkflow, req)\r\n``` \r\n\r\n## Actual Behavior\r\n* Test passes, but seeing the following error message from test output:\r\n```\r\nassert: mock: The method has been called over 2 times.\r\n\tEither do one more Mock.On(testActivity).Return(...), or remove extra call.\r\n\tThis call was unexpected: ...\r\n```\r\n* `env.AssertExpectations` doesn't catch the extra invocation, as it delegates to testify's `mock.AssertExpectations`, which only verifies that all configured invocations have been satisfied.\r\n* `env.AssertNumberOfCalls` doesn't catch the extra invocation either. Instead this happens:\r\n```\r\nenv.OnActivity(testActivity, mock.Anything, testActivityParams{...}).Return(...).Times(2) \r\nreq := testWorkflowRequest{...}\r\n\r\n// Workflow actually invokes testActivity three times but test doesn't fail\r\nenv.ExecuteWorkflow(testWorkflow, req)\r\n\r\n// Expect this assertion to fail but it passes\r\nenv.AssertNumberOfCalls(\"testActivity\", 2)\r\n// Expect this assertion to succeed but it fails\r\nenv.AssertNumberOfCalls(\"testActivity\", 3)\r\n```\r\n\r\nI think this behavior has to do with the fact that `env.AssertNumberOfCalls` delegates to testify's `mock.AssertNumberOfCalls`. However, testify expects the test to have [already failed](https://github.com/stretchr/testify/blob/437071b948cd89bdbaaf43a41f19fbe1a0945f6f/mock/mock.go#L468) early when the extra invocation occurred, and therefore does not increment its invocation counter. As a result, when the test unexpectedly continues on, the actual invocation counter remains at 2 even though there have been 3 calls to the activity.\r\n\r\ntestify's behavior seems correct and reasonable in this case. However, I'd expect `TestWorkflowEnvironment` to surface and respect the error and failure surfaced by testfify, and mark the test case as failed.\r\n\r\n## Steps to Reproduce the Problem\r\nSee above\r\n\r\n## Specifications\r\n\r\n  - Version: v1.18.1\r\n  - Platform: macOS Ventura 13.3.1","closedAt":null,"comments":[{"id":"IC_kwDODN1w685br_tj","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I admit to not looking into this, but just curious if you can confirm that `env.GetWorkflowError()` is `nil`?","createdAt":"2023-05-08T12:13:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1100#issuecomment-1538259811","viewerDidAuthor":false},{"id":"IC_kwDODN1w685btioQ","author":{"login":"qiuyijie-stripe"},"authorAssociation":"NONE","body":"Yes. I assert `env.GetWorkflowError()` is nil in all my test cases, and invoke `AssertExpectations` as part of `AfterTest`. ","createdAt":"2023-05-08T16:11:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/1100#issuecomment-1538664976","viewerDidAuthor":false}],"createdAt":"2023-05-06T01:37:30Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1100,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"OPEN","title":"TestWorkflowEnvironment should surface errors and respect failure signal surfaced by underlying mock","updatedAt":"2023-05-08T16:12:35Z","url":"https://github.com/temporalio/sdk-go/issues/1100"}
