{"assignees":[],"author":{"id":"MDQ6VXNlcjE3MzkxMjEw","is_bot":false,"login":"ingyamilmolinar","name":"ymolinar"},"body":"## Expected Behavior\r\nWorkflow testing environment should respect the activity retry policy set in the workflow.Context.\r\n\r\n## Actual Behavior\r\nWorkflow testing environment is not retrying activities when it should based on the retry policy.\r\n\r\n## Steps to Reproduce the Problem\r\n1. Register the following workflow and activity:\r\n```\r\nfunc Workflow(ctx workflow.Context) error {\r\nao := workflow.ActivityOptions{\r\nStartToCloseTimeout: 1 * time.Second,\r\n// NOTE: using default retry policy which is unlimited retries\r\n}\r\nctx = workflow.WithActivityOptions(ctx, ao)\r\n\r\nfuture := workflow.ExecuteActivity(ctx, Activity)\r\nif err := future.Get(ctx, nil); err != nil {\r\nreturn err\r\n}\r\nreturn nil\r\n}\r\n\r\nfunc Activity(ctx context.Context) error {\r\nreturn nil\r\n}\r\n```\r\n2. Write a test for your workflow and mock the activity to return an error once:\r\n```\r\nenv.OnActivity(Activity, mock.Anything).Return(errors.New(\"Error occurred\")).Once()\r\n```\r\n3. Verify that the workflow error is nil in your test (because the activity should be retried once after failing):\r\n```\r\nvar wts testsuite.WorkflowTestSuite\r\nenv = wts.NewTestWorkflowEnvironment()\r\nenv.OnActivity(Activity, mock.Anything).Return(errors.New(\"Error occurred\")).Once()\r\n\r\nenv.ExecuteWorkflow(Workflow)\r\n\r\nExpect(env.IsWorkflowCompleted()).To(BeTrue())\r\nExpect(env.GetWorkflowError()).To(BeNil()) // THIS WILL FAIL!\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: SDK v1.4.1\r\n  - Platform: Linux 5.7.0-0.bpo.2-amd64 #1 SMP Debian 5.7.10-1~bpo10+1 (2020-07-30) x86_64 GNU/Linux\r\n\r\n","closedAt":"2021-06-11T02:12:31Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg1OTIxMDQzNw==","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"Looks like the default retry policy is not set for local unit test environment. If you explicitly set the retry policy, the test should work. \r\n\r\nHere is a working example (for hello world workflow at https://github.com/temporalio/samples-go/tree/master/helloworld):\r\n1) set retry policy in workflow:\r\n\tao := workflow.ActivityOptions{\r\n\t\tStartToCloseTimeout: 10 * time.Second,\r\n\t\tRetryPolicy: &temporal.RetryPolicy{\r\n\t\t\tInitialInterval: time.Second,\r\n\t\t\tBackoffCoefficient: 2,\r\n\t\t\tMaximumAttempts: 3,\r\n\t\t},\r\n\t}\r\n2) set mock to fail for first attempt:\r\n\tenv.OnActivity(Activity, mock.Anything, \"Temporal\").Return(func(ctx context.Context, msg string) (string, error) {\r\n\t\tinfo := activity.GetInfo(ctx)\r\n\t\tif info.Attempt == 1 {\r\n\t\t\treturn \"\", errors.New(\"retry me\")\r\n\t\t}\r\n\r\n\t\treturn Activity(ctx, msg)\r\n\t  })\r\n\r\nThe default policy is set by server, we need to set the default one for test as well. Created a separate issue to track that: https://github.com/temporalio/sdk-go/issues/461","createdAt":"2021-06-11T02:12:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/406#issuecomment-859210437","viewerDidAuthor":false}],"createdAt":"2021-04-13T22:23:48Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":406,"reactionGroups":[],"state":"CLOSED","title":"Activity Retry Policy is ignored in workflow tests","updatedAt":"2021-06-11T02:12:31Z","url":"https://github.com/temporalio/sdk-go/issues/406"}
