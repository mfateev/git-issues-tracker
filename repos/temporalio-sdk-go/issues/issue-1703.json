{"assignees":[],"author":{"id":"MDQ6VXNlcjI2OTAzMjc=","is_bot":false,"login":"delanne","name":"Xavier Delannoy"},"body":"## Expected Behavior\r\n\r\n - no crash\r\n\r\n## Actual Behavior\r\n\r\nwhen testing several Activities with t.Parallel, the test framework crash with \"fatal error: concurrent map writes\"\r\n\r\n```\r\nfatal error: concurrent map writes\r\n...\r\ngoroutine 129 [running]:\r\ngo.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).setActivityHandle(...)\r\n\t/Users/xavier.delannoy/go/pkg/mod/go.temporal.io/sdk@v1.30.0/internal/internal_workflow_testsuite.go:1415\r\ngo.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeActivity(0x140000e4488, {0x10304e900?, 0x1031d92a8?}, {0x14000513020, 0x1, 0x1})\r\n\t/Users/xavier.delannoy/go/pkg/mod/go.temporal.io/sdk@v1.30.0/internal/internal_workflow_testsuite.go:703 +0x524\r\ngo.temporal.io/sdk/internal.(*TestActivityEnvironment).ExecuteActivity(0x1030c99a0?, {0x10304e900?, 0x1031d92a8?}, {0x14000513020?, 0x140004d1f38?, 0x1028bb6a0?})\r\n\t/Users/xavier.delannoy/go/pkg/mod/go.temporal.io/sdk@v1.30.0/internal/workflow_testsuite.go:195 +0x2c\r\ngithub.com/strangebee/godsl/flow/activities/strings.Test_Activity_TrimRight.func1(0x140004c36c0)\r\n\t/Users/xavier.delannoy/go/src/github.com/strangebee/Delannoy/godsl/flow/activities/strings/trimright_test.go:150 +0xac\r\ntesting.tRunner(0x140004c36c0, 0x14000494390)\r\n\t/usr/local/go/src/testing/testing.go:1690 +0xe4\r\ncreated by testing.(*T).Run in goroutine 24\r\n\t/usr/local/go/src/testing/testing.go:1743 +0x314\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. write some activities\r\n  2. write tests for these activities with t.Parallel\r\n  3. run tests in a loop in order to reproduce the race conditions\r\n\r\n## Specifications\r\n\r\n  - Version: SDK 1.30\r\n  - Platform: Darwin \r\n\r\n## Investigation\r\n\r\ncode: \r\n```\r\nfunc (env *testWorkflowEnvironmentImpl) setActivityHandle(activityID, runID string, handle *testActivityHandle) {\r\n\tenv.activities[env.makeUniqueActivityID(activityID, runID)] = handle\r\n}\r\n```\r\n\r\n```\r\n\t\tactivities             map[string]*testActivityHandle\r\n```\r\n\r\nas several go routines can write in the map 'activities', the type of activities should be a [sync.Map](https://pkg.go.dev/sync#Map) or use a mutex to protect the write \r\n\r\n## Potential fix\r\n\r\ninternal/internal_workflow_testsuite.go:1415\r\n```\r\nfunc (env *testWorkflowEnvironmentImpl) setActivityHandle(activityID, runID string, handle *testActivityHandle) {\r\n\tenv.locker.Lock()\r\n\tdefer env.locker.Unlock()\r\n\tenv.activities[env.makeUniqueActivityID(activityID, runID)] = handle\r\n}\r\n```","closedAt":"2025-01-28T15:35:39Z","comments":[{"id":"IC_kwDODN1w686Se-X7","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"To clarify, are you seeing this data race when the same test environment being shared by multiple tests?","createdAt":"2024-11-05T16:09:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1703#issuecomment-2457593339","viewerDidAuthor":false},{"id":"IC_kwDODN1w686S0FlD","author":{"login":"delanne"},"authorAssociation":"NONE","body":"> To clarify, are you seeing this data race when the same test environment being shared by multiple tests?\r\n\r\nall tests are run in parallel. Here is an example of how I write a test\r\n\r\n```\r\nfunc Test_Activity_FooBar(t *testing.T) {\r\n\ttestSuite := &testsuite.WorkflowTestSuite{}\r\n\tenv := testSuite.NewTestActivityEnvironment()\r\n\r\n\tenv.RegisterActivity(FooBar)\r\n\r\n\tt.Parallel()\r\n\ttests := []struct {\r\n\t\tname     string\r\n\t\tp        *FooBarParams\r\n\t\texpected internal.Return\r\n\t}{\r\n\t\t{\r\n\t\t\tname: \"foobar test1\",\r\n\t\t\tp: &FooBarParams{\r\n\t\t\t\tString1: \"foobar\",\r\n\t\t\t\tString2: \"foobar\",\r\n\t\t\t},\r\n\t\t\texpected: internal.Return{Value: float64(0)},\r\n\t\t},\r\n     .....\r\n\t}\r\n\r\n\tfor _, tt := range tests {\r\n\t\tt.Run(tt.name, func(t *testing.T) {\r\n\t\t\tt.Parallel()\r\n\t\t\tval, err := env.ExecuteActivity(FooBar,\r\n\t\t\t\ttt.p,\r\n\t\t\t)\r\n\t\t\trequire.NoError(t, err)\r\n\t\t\tres := &internal.Return{}\r\n\t\t\terr = val.Get(res)\r\n\t\t\trequire.NoError(t, err)\r\n\t\t\trequire.Equal(t, &tt.expected, res)\r\n\t\t})\r\n\t}\r\n}\r\n```\r\n\r\nDo you mean that the line `env := testSuite.NewTestActivityEnvironment()` should be after the line `t.Parallel()` ?  (make sense to me) ","createdAt":"2024-11-07T20:14:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1703#issuecomment-2463127875","viewerDidAuthor":false},{"id":"IC_kwDODN1w686cIBPx","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Sorry for the late reply this slipped through the cracks , \n\n> Do you mean that the line env := testSuite.NewTestActivityEnvironment() should be after the line t.Parallel() ? (make sense to me)\n\n\nYes, The test environment should not be shared for multiple tests. Each test should have its own environment ","createdAt":"2025-01-28T15:35:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1703#issuecomment-2619347953","viewerDidAuthor":false}],"createdAt":"2024-11-05T00:49:24Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1703,"reactionGroups":[],"state":"CLOSED","title":"fatal error: concurrent map writes when u","updatedAt":"2025-01-28T15:35:41Z","url":"https://github.com/temporalio/sdk-go/issues/1703"}
