{"assignees":[],"author":{"id":"MDQ6VXNlcjk2NzY2Mzc=","is_bot":false,"login":"miquelpuigmena","name":"Miquel Puig i Mena"},"body":"I want to see how an activity times out due to heartbeat timeout while testing. But it doesn't raise the Heartbeat timeout. See the tests in Steps to Reproduce the Problem section\r\n\r\n## Expected Behavior\r\nI would expect to see the test failing due to HeartbeatTimeout\r\n\r\n## Actual Behavior\r\nThe tests are passing\r\n\r\n## Steps to Reproduce the Problem\r\n- make a folder with `workflow.go` and `workflow_test.go` below ðŸ‘‡ \r\n- `go test ./...`\r\n\r\nworkflow.go\r\n```go\r\npackage hbtimeout\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"time\"\r\n\r\n\t\"go.temporal.io/sdk/temporal\"\r\n\t\"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\ntype In struct {\r\n\tSleep     int\r\n\tHeartbeat int\r\n}\r\n\r\nfunc Workflow(ctx workflow.Context, in In) error {\r\n\toptions := workflow.ActivityOptions{\r\n\t\tStartToCloseTimeout: time.Second * 10,\r\n\t\tHeartbeatTimeout:    time.Second * time.Duration(in.Heartbeat),\r\n\t\tRetryPolicy: &temporal.RetryPolicy{\r\n\t\t\tMaximumAttempts: 1,\r\n\t\t},\r\n\t}\r\n\r\n\tctx = workflow.WithActivityOptions(ctx, options)\r\n\r\n\terr := workflow.ExecuteActivity(ctx, Do, in.Sleep).Get(ctx, nil)\r\n\tif err != nil {\r\n\t\treturn err\r\n\t}\r\n\r\n\treturn nil\r\n}\r\n\r\nfunc Do(ctx context.Context, sleep int) error {\r\n\ttime.Sleep(time.Second * time.Duration(sleep))\r\n\treturn nil\r\n}\r\n```\r\nworkflow_test.go\r\n```go\r\npackage hbtimeout\r\n\r\nimport (\r\n\t\"testing\"\r\n\t\"time\"\r\n\r\n\t\"github.com/stretchr/testify/suite\"\r\n\t\"go.temporal.io/sdk/testsuite\"\r\n)\r\n\r\ntype UnitTestSuite struct {\r\n\tsuite.Suite\r\n\ttestsuite.WorkflowTestSuite\r\n}\r\n\r\nfunc TestUnitTestSuite(t *testing.T) {\r\n\tsuite.Run(t, new(UnitTestSuite))\r\n}\r\n\r\nfunc (s *UnitTestSuite) Test_Workflow() {\r\n\tenv := s.NewTestWorkflowEnvironment()\r\n\tenv.SetTestTimeout(time.Second * 20)\r\n\tenv.RegisterActivity(Do)\r\n\tenv.ExecuteWorkflow(Workflow, In{Sleep: 9, Heartbeat: 1})\r\n\ts.True(env.IsWorkflowCompleted())\r\n\ts.NoError(env.GetWorkflowError())\r\n\tenv.AssertExpectations(s.T())\r\n}\r\n```\r\n\r\n## Specifications\r\n  - Version: \r\n  - Platform: testing locally\r\n","closedAt":"2026-01-16T01:08:48Z","comments":[{"id":"IC_kwDODN1w685q0Vk9","author":{"login":"gugabfigueiredo"},"authorAssociation":"NONE","body":"as pointed out in the #1167 , activity timeouts are hardcoded to 10min in [testWorkflowEnvironmentImpl.executeActivity](https://github.com/temporalio/sdk-go/blob/0352634b45b1b81293c9bf3cec3bb033b82f841f/internal/internal_workflow_testsuite.go#L557)\r\n\r\n```go\r\nfunc (env *testWorkflowEnvironmentImpl) executeActivity(\r\n\tactivityFn interface{},\r\n\targs ...interface{},\r\n) (converter.EncodedValue, error) {\r\n\r\n        ...\r\n\r\n\tparameters := ExecuteActivityParams{\r\n\t\tExecuteActivityOptions: ExecuteActivityOptions{\r\n\t\t\tScheduleToCloseTimeout: 600 * time.Second,\r\n\t\t\tStartToCloseTimeout:    600 * time.Second,\r\n\t\t},\r\n\t\tActivityType: *activityType,\r\n\t\tInput:        input,\r\n\t\tHeader:       env.header,\r\n\t}\r\n\r\n        ...\r\n}\r\n```\r\n\r\nheartbeatTimeouts are straight up ignored\r\n\r\nas a workaround I have been testing for consistent heartbeat strategies with the following, changing the code in `workflow_test.go`:\r\n```go\r\nfunc (s *UnitTestSuite) Test_Workflow() {\r\n\tenv := s.NewTestWorkflowEnvironment()\r\n\tenv.SetTestTimeout(time.Second * 1)\r\n\tenv.RegisterActivity(Do)\r\n        defer func() {\r\n\t\terr := recover()\r\n\t\tif r != nil {\r\n\t\t\ts.True(strings.HasPrefix(err.(string), \"test timeout\"))\r\n\t\t}\r\n\t}()\r\n\tenv.ExecuteWorkflow(Workflow, In{Sleep: 9, Heartbeat: 2})\r\n}\r\n```\r\n\r\nwhen heartbeats are set appropriately, they will keep test workflow alive and it is possible to test for consistent timeout error over longer workload.","createdAt":"2023-11-03T09:21:00Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1282#issuecomment-1792104765","viewerDidAuthor":false},{"id":"IC_kwDODN1w685q2Oe8","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"The workflow test environment is meant mostly for just testing workflows though it has some activity support. You should use a `TestActivityEnvironment` to test activity behavior, and if you want to test how a workflow reacts to an activity result/failure, you can mock it. If you must test these together with real-world behavior semantics, you should use a real server (e.g. `testsuite.StartDevServer`).","createdAt":"2023-11-03T15:00:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1282#issuecomment-1792599996","viewerDidAuthor":false},{"id":"IC_kwDODN1w685q6fFH","author":{"login":"gugabfigueiredo"},"authorAssociation":"NONE","body":"a `TestActivityEnvironment` is just a wrapper for`testWorkflowEnvironmentImpl` ([/internal/workflow_testsuite.go#L70](https://github.com/temporalio/sdk-go/blob/0352634b45b1b81293c9bf3cec3bb033b82f841f/internal/workflow_testsuite.go#L70))\r\n```go\r\n\t// TestActivityEnvironment is the environment that you use to test activity\r\n\tTestActivityEnvironment struct {\r\n\t\timpl *testWorkflowEnvironmentImpl\r\n\t}\r\n```\r\n\r\nwhich means that when running activities, the same limitations apply, this makes the test environment ignore developer setup and not behave as expected, as we cannot provide or set ExecuteActivityOptions.\r\n\r\n[Edit]: In my case, I was just trying to validate heartbeat strategies considering different workloads\r\n\r\nwill try `testsuite.StartDevServer`, which at least I can write into tests to get the expected behavior","createdAt":"2023-11-05T11:59:40Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1282#issuecomment-1793716551","viewerDidAuthor":false},{"id":"IC_kwDODN1w685q68lh","author":{"login":"gugabfigueiredo"},"authorAssociation":"NONE","body":" > will try `testsuite.StartDevServer`, which at least I can write into tests to get the expected behaviour\r\n\r\nThis worked for my needs ([see here](https://gist.github.com/gugabfigueiredo/ab64a66fac1fc2fc05c97c737da4a6f6)).\r\n\r\nI suppose then it comes to temporal developers wether there is a use case or not for normal configurations to the Activity and Workflow test environments.\r\n\r\nPersonally, I would argue in favour of test environment interface being able to deal with this, as it seems like a lot of work to validate implementation against a simple feature. The heartbeat timeout is still set by the internal implementation, its just set to zero value while other timeouts are hardcoded ([/internal/internal_workflow_testsuite.go#L579](https://github.com/temporalio/sdk-go/blob/0352634b45b1b81293c9bf3cec3bb033b82f841f/internal/internal_workflow_testsuite.go#L579)):\r\n\r\n```go\r\n\tparameters := ExecuteActivityParams{\r\n\t\tExecuteActivityOptions: ExecuteActivityOptions{\r\n\t\t\tScheduleToCloseTimeout: 600 * time.Second,\r\n\t\t\tStartToCloseTimeout:    600 * time.Second,\r\n\t\t},\r\n\t\tActivityType: *activityType,\r\n\t\tInput:        input,\r\n\t\tHeader:       env.header,\r\n\t}\r\n\r\n...\r\n\r\n\tscheduleTaskAttr.HeartbeatTimeout = &parameters.HeartbeatTimeout\r\n\r\n...\r\n```","createdAt":"2023-11-05T20:30:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1282#issuecomment-1793837409","viewerDidAuthor":false},{"id":"IC_kwDODN1w685q-6w-","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> a `TestActivityEnvironment` is just a wrapper for `testWorkflowEnvironmentImpl` [...] which means that when running activities, the same limitations apply\r\n\r\nBut it's a different level of exposed abstraction. The point is that if you want to test how your workflow reacts to a certain type of activity failure, mock that activity and return that error. If you want to test how your activity works regardless of workflow, use the activity environment. If you must test all behaviors of activity and workflow together based on real-time, it may not make sense to use an activity or time-skipping workflow environment, it may make sense to use a real combined one.\r\n\r\nSome timeouts we do respect in the workflow environment however, but are on time-skipping basis not based on real time. I will leave this issue open to investigate if real-time heartbeat timeout can/should be respected.","createdAt":"2023-11-06T13:55:24Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1282#issuecomment-1794878526","viewerDidAuthor":false}],"createdAt":"2023-10-26T16:44:42Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1282,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":5}}],"state":"CLOSED","title":"Heartbeat timeout not raised while testing","updatedAt":"2026-01-16T01:08:48Z","url":"https://github.com/temporalio/sdk-go/issues/1282"}
