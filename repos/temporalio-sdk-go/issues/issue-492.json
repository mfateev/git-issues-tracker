{"assignees":[],"author":{"id":"MDQ6VXNlcjg2NjkzNTc4","is_bot":false,"login":"si-stripe","name":"simon"},"body":"## Expected Behavior\r\nWith a `WORKFLOW_ID_REUSE_POLICY_ALLOW_DUPLICATE` reuse policy, a Workflow ID should be able to be reused as soon as the Workflow before it completes.\r\n\r\n## Actual Behavior\r\nIf I immediately try and reuse a Workflow ID I get:\r\n\r\n```\r\n2021/07/19 23:53:58 ERROR Workflow panic Namespace default TaskQueue ---- WorkerID --- WorkflowType WorkflowManagerWorkflow WorkflowID someWorkflowId-manager RunID c68cd12c-3761-4e8b-9b9c-44e541216a8f Attempt 1 Error adding duplicate command CommandType: ChildWorkflow, ID: someWorkflowId, state=Created, isDone()=false, history=[Created] StackTrace coroutine root [panic]:\r\ngo.temporal.io/sdk/internal.panicIllegalState(...)\r\n        external/io_temporal_go_sdk/internal/internal_decision_state_machine.go:393\r\ngo.temporal.io/sdk/internal.(*commandsHelper).addCommand(0xc00013f400, 0x1de05c8, 0xc000635780)\r\n        external/io_temporal_go_sdk/internal/internal_decision_state_machine.go:841 +0x349\r\ngo.temporal.io/sdk/internal.(*commandsHelper).startChildWorkflowExecution(0xc00013f400, 0xc000646500, 0x0, 0x0)\r\n        external/io_temporal_go_sdk/internal/internal_decision_state_machine.go:1021 +0x59\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentImpl).ExecuteChildWorkflow(0xc000f53680, 0xc000ec8280, 0x8, 0x0, 0x0, 0x0, 0xc000d66728, 0x7, 0xc00063e7e0, 0xe, ...)\r\n        external/io_temporal_go_sdk/internal/internal_event_handlers.go:395 +0x2e9\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteChildWorkflow(0xc0001434a0, 0x1dd2ee8, 0xc000fb0ed0, 0x1fcee8d, 0x10, 0xc000635680, 0x1, 0x1, 0x10, 0x11b0240)\r\n        external/io_temporal_go_sdk/internal/workflow.go:708 +0x86d\r\ngo.temporal.io/sdk/internal.ExecuteChildWorkflow(0x1dd2ee8, 0xc000fb0ed0, 0x11e6740, 0x1b86f88, 0xc000635680, 0x1, 0x1, 0x0, 0x0)\r\n        external/io_temporal_go_sdk/internal/workflow.go:671 +0x193\r\ngo.temporal.io/sdk/workflow.ExecuteChildWorkflow(...)\r\n        external/io_temporal_go_sdk/workflow/workflow.go:182\r\nreflect.Value.call(0x11bab60, 0x1b86f98, 0x13, 0x135e73d, 0x4, 0xc000f0edf0, 0x1, 0x1, 0x1d97740, 0x133c320, ...)\r\n        GOROOT/src/reflect/value.go:476 +0x8e7\r\nreflect.Value.Call(0x11bab60, 0x1b86f98, 0x13, 0xc000f0edf0, 0x1, 0x1, 0x1d97740, 0x133c320, 0xc0001434a0)\r\n        GOROOT/src/reflect/value.go:337 +0xb9\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteWorkflow(0xc0001434a0, 0x1dd2d60, 0xc00013f540, 0xc000984108, 0x17, 0x0, 0x0, 0x0, 0x0, 0x0, ...)\r\n        external/io_temporal_go_sdk/internal/workflow.go:391 +0x2cb\r\ngo.temporal.io/sdk/internal.(*workflowExecutor).Execute(0xc00013f4c0, 0x1dd2d60, 0xc00013f540, 0x0, 0xc000dcc738, 0xc8c8e5, 0x0)\r\n        external/io_temporal_go_sdk/internal/internal_worker.go:755 +0x316\r\ngo.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func1(0x1dd2ee8, 0xc000f4fad0)\r\n        external/io_temporal_go_sdk/internal/internal_workflow.go:494 +0xf5\r\n2021/07/19 23:53:58 WARN  Failed to process workflow task. Namespace default TaskQueue ---- WorkerID --- WorkflowType WorkflowManagerWorkflow WorkflowID someWorkflowId-manager RunID c68cd12c-3761-4e8b-9b9c-44e541216a8f Attempt 1 Error adding duplicate command CommandType: ChildWorkflow, ID: someWorkflowId, state=Created, isDone()=false, history=[Created]\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Create a Workflow that starts a child workflow with ID `ChildWorkflow`\r\n  2. Have ChildWorkflow return and send a signal to Parent workflow that it's done\r\n  3. When Parent workflow receives done signal, start a new child workflow with ID `ChildWorkflow`\r\n\r\n## Specifications\r\n\r\n  - Version: 1.9.2\r\n  - Platform: Go\r\n","closedAt":"2022-12-02T16:23:10Z","comments":[{"id":"IC_kwDODN1w6840oLNM","author":{"login":"si-stripe"},"authorAssociation":"NONE","body":"I can get around this by adding a `workflow.Sleep(ctx, 1*time.Millisecond)`","createdAt":"2021-07-20T00:13:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/492#issuecomment-882946892","viewerDidAuthor":false},{"id":"IC_kwDODN1w6840oLUG","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"@si-stripe\r\n\r\nworkflow ID reuse policy specifies when the current workflow finishes (completed / timeout / terminated / cancelled, etc) & if caller trying to start a workflow with the same workflow ID, what is the behavior.\r\n\r\nabove meaning workflow ID reuse policy will not be even evaluated if there is a workflow with the same workflow ID running.\r\n\r\ne.g. # 1\r\nT = 0 workflow with workflow ID 1 is running\r\nT = 1 caller try to start a workflow with same workflow ID, as long as above workflow is still running, this call to start will fail\r\n\r\ne.g. # 2\r\nT = 0 workflow with workflow ID 1 is running\r\nT = 1 above workflow finished (completed / timeout / failed / cancelled, etc)\r\nT = 2 caller try to start a workflow with same workflow ID, with workflow ID reuse policy, since above workflow is finished, this policy will be evaluated accordingly","createdAt":"2021-07-20T00:15:05Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/492#issuecomment-882947334","viewerDidAuthor":false},{"id":"IC_kwDODN1w6840oLzs","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"the error / stack trace is emitted by go SDK, probably due to child state machine invariant being broken.\r\n@Sushisource  any suggestion?","createdAt":"2021-07-20T00:20:35Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/492#issuecomment-882949356","viewerDidAuthor":false},{"id":"IC_kwDODN1w6840oL0c","author":{"login":"si-stripe"},"authorAssociation":"NONE","body":"I have the signal being sent in a `defer` function, which should run just before the Workflow returns.\r\n\r\nWhat ends up happening is:\r\nT = 0: Workflow with workflow ID 1 is running\r\nT = 1: Workflow runs the `defer` function, signaling to Parent that it's done\r\nT = 1.5: Parent receives signal and tries to run new Workflow with same ID\r\nT = 2: Workflow actually returns\r\n\r\nIs there a better way for a parent workflow to know when the child finishes without blocking on a `future.Get()`?","createdAt":"2021-07-20T00:20:42Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/492#issuecomment-882949404","viewerDidAuthor":false},{"id":"IC_kwDODN1w6840qbtN","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"In your scenario, the child is not completed yet when the signal is received. So the attempt to schedule another child with the same ID fails per design.\r\n\r\nWaiting on the child's future is the supported way to learn about a child's completion. I don't understand why you are trying to use a signal for this.","createdAt":"2021-07-20T16:43:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/492#issuecomment-883538765","viewerDidAuthor":true},{"id":"IC_kwDODN1w6840rZhD","author":{"login":"si-stripe"},"authorAssociation":"NONE","body":"I wanted to use signals/select to control my Workflow without polling. \r\n\r\nI can achieve this by creating a goroutine that blocks on `future.Get()` and then sends a Signal to indicate that the child is done. If you think it's a common pattern, I'm happy to add some docs for this","createdAt":"2021-07-21T00:24:45Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/492#issuecomment-883791939","viewerDidAuthor":false},{"id":"IC_kwDODN1w685PmT2a","author":{"login":"Drahflow"},"authorAssociation":"NONE","body":"We hit the same issue today, and I became convinced the issue has been closed in error. The internal state machine command IDs for child workflows depend only on the child's workflow ID:\r\nhttps://github.com/temporalio/sdk-go/blob/a23dec9aba94a515920e3d298ce29190316b295d/internal/internal_command_state_machine.go#L429,L435\r\n... but if the same workflow ever tries to create two children with the same ID (which is legal if it made sure that the first has completed before) it will still panic.","createdAt":"2022-12-02T15:44:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/492#issuecomment-1335442842","viewerDidAuthor":false},{"id":"IC_kwDODN1w685PmfWi","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@Drahflow - Reopening as I believe this issue probably does exist. In the meantime as a workaround can you use unique child workflow IDs for each child workflow invocation?","createdAt":"2022-12-02T16:14:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/492#issuecomment-1335489954","viewerDidAuthor":false},{"id":"IC_kwDODN1w685PmgOV","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@Drahflow - Can you provide a small standalone replication? Can you make sure you are waiting for child workflow completion in this replication?","createdAt":"2022-12-02T16:17:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/492#issuecomment-1335493525","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Pmhlm","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Ok, after attempted replication, I am able to create children with the same ID. Please make sure you confirm the previous one is complete. Here's an example of creating a child every 5 seconds:\r\n\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"fmt\"\r\n\t\"log\"\r\n\t\"time\"\r\n\r\n\t\"github.com/google/uuid\"\r\n\t\"go.temporal.io/sdk/client\"\r\n\t\"go.temporal.io/sdk/worker\"\r\n\t\"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\nfunc main() {\r\n\tif err := run(); err != nil {\r\n\t\tlog.Fatal(err)\r\n\t}\r\n}\r\n\r\nfunc run() error {\r\n\tctx, cancel := context.WithCancel(context.Background())\r\n\tdefer cancel()\r\n\r\n\tlog.Printf(\"Creating client\")\r\n\tc, err := client.NewClient(client.Options{})\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"failed creating client: %w\", err)\r\n\t}\r\n\tdefer c.Close()\r\n\r\n\tlog.Printf(\"Starting worker\")\r\n\ttaskQueue := uuid.NewString()\r\n\tworker := worker.New(c, taskQueue, worker.Options{})\r\n\tworker.RegisterWorkflow(MyWorkflow)\r\n\tworker.RegisterWorkflow(MyChildWorkflow)\r\n\tif err := worker.Start(); err != nil {\r\n\t\treturn fmt.Errorf(\"failed starting worker client: %w\", err)\r\n\t}\r\n\r\n\tlog.Printf(\"Starting workflow\")\r\n\trun, err := c.ExecuteWorkflow(ctx, client.StartWorkflowOptions{TaskQueue: taskQueue}, MyWorkflow)\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"failed starting workflow: %w\", err)\r\n\t}\r\n\r\n\treturn run.Get(ctx, nil)\r\n}\r\n\r\nfunc MyWorkflow(ctx workflow.Context) error {\r\n\t// Start children with the same ID over and over\r\n\tctx = workflow.WithChildOptions(ctx, workflow.ChildWorkflowOptions{\r\n\t\tWorkflowID: workflow.GetInfo(ctx).WorkflowExecution.ID + \"-child\",\r\n\t})\r\n\tfor {\r\n\t\tworkflow.GetLogger(ctx).Info(\"Starting child and waiting for completion\")\r\n\t\tif err := workflow.ExecuteChildWorkflow(ctx, MyChildWorkflow).Get(ctx, nil); err != nil {\r\n\t\t\treturn err\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunc MyChildWorkflow(ctx workflow.Context) error {\r\n\treturn workflow.Sleep(ctx, 5*time.Second)\r\n}\r\n```\r\n\r\nThat command is removed on child workflow complete. So the dupe command ID is acceptable.","createdAt":"2022-12-02T16:23:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/492#issuecomment-1335499110","viewerDidAuthor":false}],"createdAt":"2021-07-20T00:12:33Z","labels":[],"milestone":null,"number":492,"reactionGroups":[],"state":"CLOSED","title":"Cannot reuse Workflow ID immediately","updatedAt":"2022-12-02T16:23:38Z","url":"https://github.com/temporalio/sdk-go/issues/492"}
