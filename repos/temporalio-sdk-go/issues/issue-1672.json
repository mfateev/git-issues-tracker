{"assignees":[],"author":{"id":"MDQ6VXNlcjQ5NzEzNTA4","is_bot":false,"login":"ClairePhi","name":"Claire Philippe"},"body":"## Expected Behavior\r\n\r\nI expect `AssertNumberOfCalls` to succeed only with one given “expectedCalls” value.\r\n\r\nIn the “Steps to reproduce” section below, there are two assertions to assert the number of times the Activity is Called: 0 and 1. I expect that: \r\n- At least one of the two assertions fails.\r\n- In particular, the first assertion fails.\r\n\r\n## Actual Behavior\r\n\r\nIt is possible for `AssertNumberOfCalls` to succeed with two “expectedCalls” values.\r\n\r\nIn the “Steps to reproduce” section below, the two assertions succeed and the test succeeds.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nmain.go:\r\n\r\n```\r\npackage main\r\n\r\nimport (\r\n   \"context\"\r\n   \"time\"\r\n\r\n   \"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\nfunc MyWorkflow(ctx workflow.Context, input string) error {\r\n   return workflow.ExecuteActivity(\r\n      workflow.WithActivityOptions(ctx, workflow.ActivityOptions{\r\n         StartToCloseTimeout: time.Minute,\r\n      }),\r\n      MyActivity,\r\n      input).Get(ctx, nil)\r\n\r\n}\r\n\r\nfunc MyActivity(ctx context.Context, input string) (string, error) {\r\n   return input, nil\r\n}\r\n\r\n```\r\n\r\nmain_test.go:\r\n\r\n```\r\nimport (\r\n\t\"testing\"\r\n\r\n\t\"github.com/stretchr/testify/mock\"\r\n\t\"github.com/stretchr/testify/require\"\r\n\t\"go.temporal.io/sdk/testsuite\"\r\n)\r\n\r\nfunc Test_Workflow(t *testing.T) {\r\n\ttestSuite := testsuite.WorkflowTestSuite{}\r\n\tenv := testSuite.NewTestWorkflowEnvironment()\r\n\r\n\tenv.OnActivity(MyActivity, mock.Anything, \"input\").Return(\"output\", nil)\r\n\r\n\tenv.ExecuteWorkflow(MyWorkflow, \"input\")\r\n\r\n\trequire.True(t, env.IsWorkflowCompleted())\r\n\trequire.NoError(t, env.GetWorkflowError())\r\n\r\n\tenv.AssertNumberOfCalls(t, \"MyActivity\", 0)\r\n\tenv.AssertNumberOfCalls(t, \"MyActivity\", 1)\r\n}\r\n```\r\n## Specifications\r\n\r\ngo.mod\r\n\r\n```\r\nmodule sandbox.com\r\n\r\n\r\ngo 1.22.3\r\n\r\n\r\nrequire (\r\n   github.com/stretchr/testify v1.9.0\r\n   go.temporal.io/sdk v1.29.1\r\n)\r\n\r\n\r\nrequire (\r\n   github.com/davecgh/go-spew v1.1.1 // indirect\r\n   github.com/facebookgo/clock v0.0.0-20150410010913-600d898af40a // indirect\r\n   github.com/gogo/protobuf v1.3.2 // indirect\r\n   github.com/golang/mock v1.6.0 // indirect\r\n   github.com/google/uuid v1.6.0 // indirect\r\n   github.com/grpc-ecosystem/go-grpc-middleware v1.4.0 // indirect\r\n   github.com/grpc-ecosystem/grpc-gateway/v2 v2.22.0 // indirect\r\n   github.com/nexus-rpc/sdk-go v0.0.10 // indirect\r\n   github.com/pborman/uuid v1.2.1 // indirect\r\n   github.com/pmezard/go-difflib v1.0.0 // indirect\r\n   github.com/robfig/cron v1.2.0 // indirect\r\n   github.com/stretchr/objx v0.5.2 // indirect\r\n   go.temporal.io/api v1.38.0 // indirect\r\n   golang.org/x/exp v0.0.0-20240525044651-4c93da0ed11d // indirect\r\n   golang.org/x/net v0.28.0 // indirect\r\n   golang.org/x/sync v0.8.0 // indirect\r\n   golang.org/x/sys v0.24.0 // indirect\r\n   golang.org/x/text v0.17.0 // indirect\r\n   golang.org/x/time v0.3.0 // indirect\r\n   google.golang.org/genproto/googleapis/api v0.0.0-20240822170219-fc7c04adadcd // indirect\r\n   google.golang.org/genproto/googleapis/rpc v0.0.0-20240822170219-fc7c04adadcd // indirect\r\n   google.golang.org/grpc v1.65.0 // indirect\r\n   google.golang.org/protobuf v1.34.2 // indirect\r\n   gopkg.in/yaml.v3 v3.0.1 // indirect\r\n)\r\n```\r\n\r\n## Additional comments\r\n\r\n### Impact\r\n\r\nI think that testing that an Activity or a Workflow is Called once is a common use case. I also think that it is a common use case that Activities and Workflows are not named the same (see Additional comments section below).\r\n\r\nUsers of this function might incorrectly see their tests passing when they should not.\r\n\r\n### Possible fix\r\n\r\nMy understanding is that the behavior was introduced by [that PR](https://github.com/temporalio/sdk-go/pull/1371), which makes the assertion check if the number of Activities OR the number of Workflows were called N times. Here as we have 0 workflows named MyActivity, they were never called. Hence the assertion `env.AssertNumberOfCalls(t, \"MyActivity\", 0)` succeeds.\r\n\r\nHere is an idea to fix that. This is only an attempt - I’m not familiar with the repo: \r\n- Revert [that PR](https://github.com/temporalio/sdk-go/pull/1371) -> the bug will be fixed. It will assert that nbWorkflows + nbActivities == N\r\n- In order to take into account [that issue](https://github.com/temporalio/sdk-go/issues/887) -> create two methods:\r\n```\r\nfunc (e *TestWorkflowEnvironment) AssertNumberOfCallsActivity(t mock.TestingT, methodName string, expectedCalls int) bool\r\nfunc (e *TestWorkflowEnvironment) AssertNumberOfCallsWorkflow(t mock.TestingT, methodName string, expectedCalls int) bool\r\n```\r\n\r\nIf you agree on the principle, I can open a PR.","closedAt":"2025-01-21T18:55:45Z","comments":[{"id":"IC_kwDODN1w686P4K0R","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> create two methods:\r\n\r\nThe linked PR at https://github.com/temporalio/sdk-go/pull/1371 created `AssertActivityNumberOfCalls` and `AssertWorkflowNumberOfCalls`, can you confirm they work for your use case?","createdAt":"2024-10-15T13:06:24Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1672#issuecomment-2413866257","viewerDidAuthor":false},{"id":"IC_kwDODN1w686QA05X","author":{"login":"ClairePhi"},"authorAssociation":"NONE","body":"> can you confirm they work for your use case?\r\n\r\nYes I think they would fit well for my second bullet point, thank you.\r\n\r\nI still believe that `env.AssertNumberOfCalls` behavior could introduce errors in user tests. According to the method naming, if someone asserts that an Activity was called once, then they would expect the test to fail if the Activity was never called, and it doesn't.","createdAt":"2024-10-16T08:49:56Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1672#issuecomment-2416135767","viewerDidAuthor":false},{"id":"IC_kwDODN1w686QE0Br","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"https://github.com/temporalio/sdk-go/pull/1371 was maybe developed wrong. @Quinn-With-Two-Ns - thoughts?","createdAt":"2024-10-16T15:30:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1672#issuecomment-2417180779","viewerDidAuthor":false},{"id":"IC_kwDODN1w686QG3MF","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"`AssertNumberOfCalls ` is inherently ambiguous since it doesn't differentiate between workflow, activity or nexus calls. If you are trying to assert on the number of activity calls you should use `AssertActivityNumberOfCalls` .","createdAt":"2024-10-16T19:09:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-go/issues/1672#issuecomment-2417718021","viewerDidAuthor":false},{"id":"IC_kwDODN1w686bTObZ","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"New method were added in https://github.com/temporalio/sdk-go/commit/e2bec163bb792071556cedae4d0590a14fc8ee9d","createdAt":"2025-01-21T18:55:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1672#issuecomment-2605508313","viewerDidAuthor":false}],"createdAt":"2024-10-15T09:21:50Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1672,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"AssertNumberOfCalls on an Activity succeeds even if the Activity is not called the asserted number of times.","updatedAt":"2025-01-21T18:55:47Z","url":"https://github.com/temporalio/sdk-go/issues/1672"}
