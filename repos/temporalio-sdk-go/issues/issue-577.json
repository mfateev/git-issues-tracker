{"assignees":[{"id":"MDQ6VXNlcjIwNjM5Ng==","login":"cretz","name":"Chad Retz","databaseId":0}],"author":{"id":"MDQ6VXNlcjg0NDExMDE0","is_bot":false,"login":"yiminc","name":"Yimin Chen"},"body":"**Is your feature request related to a problem? Please describe.**\r\nWhen worker configured to have multiple pollers, all pollers share one connection and will poll from only one frontend server. This does not work well when worker count is the same or smaller than frontend server count.\r\n\r\n**Describe the solution you'd like**\r\nThere should have an option to be able to specify how many connections you want for one worker so the load is more evenly distributed among frontend servers. \r\n\r\n**Describe alternatives you've considered**\r\nUser has to start more workers to have the load more evenly distributed across all frontend servers.\r\n\r\n","closedAt":"2021-10-13T13:55:15Z","comments":[{"id":"IC_kwDODN1w68436aic","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"For some context, gRPC provides most of this out of the box. The address provided to the client can be a comma-delimited set of addresses or `dns://someaddr:1234` for `A` record-based discovery (can even use your own resolver, e.g. `dns://myconsulserver.local/someaddr:1234`), see [docs](https://github.com/grpc/grpc/blob/master/doc/naming.md)\r\n\r\nThat resolves the set of hosts. As for load balancing, default is \"pick first\" which would only do the first address. gRPC does have a built-in round robin load balancer, but you have to opt-in by setting service config to `{\"loadBalancingPolicy\":\"round_robin\"}`.  See [load balancing docs](https://github.com/grpc/grpc/blob/master/doc/load-balancing.md). Otherwise, both resolvers and load balancers are easy to write custom versions of if necessary.\r\n\r\nIf those ways of providing sets of hosts (comma-delimited or dns discovery) are acceptable and round robin is good enough for these needs, to keep from having to expose too many gRPC internals, I think a load balancer connection config with just round robin support at first would be fine to start. I would have to investigate Java and Node SDKs to see if they already have similar solutions and/or if they'd need to have this feature.","createdAt":"2021-10-07T18:44:58Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/577#issuecomment-938059932","viewerDidAuthor":false},{"id":"IC_kwDODN1w6843-fKK","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"We will definitely want parity in all SDKs if we do this. Good news is pollers are in core, so for core/node/other future core SDKs we need only do it once.\r\n\r\nI like the idea of leaning on this being built in and just exposing a flag to opt in to round-robin if you pass multiple addresses.","createdAt":"2021-10-08T21:32:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/577#issuecomment-939127434","viewerDidAuthor":false},{"id":"IC_kwDODN1w6844Cnpn","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"After a bit more research, we already default to round robin in Go, see https://github.com/temporalio/sdk-go/blob/662d4c6ea1519a5ca1401ab3fbf886b555f2a71d/internal/grpc_dialer.go#L59-L60\r\n\r\nHowever, we don't support multiple addresses, only DNS resolution that can provide multiple addresses. So DNS round-robin works already today, and I can add a small resolver to work with multiple addresses.","createdAt":"2021-10-11T17:17:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/577#issuecomment-940210791","viewerDidAuthor":false},{"id":"IC_kwDODN1w6844C3TC","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> There should have an option to be able to specify how many connections you want for one worker so the load is more evenly distributed among frontend servers.\r\n\r\n@yiminc - Can you clarify this statement? Are you saying we should support weights? Or is the ability to provide a set of addresses to round-robin amongst acceptable? (note, DNS-based round-robin is already supported)","createdAt":"2021-10-11T18:08:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/577#issuecomment-940274882","viewerDidAuthor":false},{"id":"IC_kwDODN1w6844GRKj","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"After further discussion, the use case originally presented by @yiminc only needed to use `dns:///` to solve their problem. However the PR at #582 still has value because one may want to provide multiple addresses explicitly instead of using DNS discovery.\r\n\r\nIt should be noted this is not the ideal way to scale gRPC. This has client-side HA benefits, but scaling gRPC is best done at the request level on the server side.","createdAt":"2021-10-12T16:20:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/577#issuecomment-941167267","viewerDidAuthor":false},{"id":"IC_kwDODN1w6844Ktt6","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"The immediate use case for this issue has been solved using the `dns:///` prefix.\r\n\r\nFor general-purpose use, instead of supporting an explicit option to provide multiple addresses in #582, we have decided to simple document how users can do it in #585.","createdAt":"2021-10-13T13:55:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/577#issuecomment-942332794","viewerDidAuthor":false},{"id":"IC_kwDODN1w6844MpOc","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"As discussed with the team today, in the future we might want to support multiple DNS hosts with a fallback based connection strategy as opposed to round-robin.\r\n\r\nWe will also want to make sure that other SDKs can support multiple addresses in the same way @cretz solved this for go.\r\n@Spikhalskiy will verify this can be done in Java.\r\nAs for Core based SDKs, the solution is much more complex due to the mixed language environment and we decided that it's not a high priority for us yet.\r\n\r\nWe already have issues tracking this in Java and Node.\r\n@wolfy-j FYI for the PHP SDK.","createdAt":"2021-10-14T00:59:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/577#issuecomment-942838684","viewerDidAuthor":false}],"createdAt":"2021-10-07T16:56:49Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDky","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":577,"reactionGroups":[],"state":"CLOSED","title":"Distribute pollers to multiple frontend servers.","updatedAt":"2021-10-14T00:59:13Z","url":"https://github.com/temporalio/sdk-go/issues/577"}
