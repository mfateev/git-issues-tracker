{"assignees":[],"author":{"id":"MDQ6VXNlcjE3Mzk2Mzky","is_bot":false,"login":"subhan-nadeem","name":"Subhan Nadeem"},"body":"## Expected Behavior\r\n\r\nWhen executing a workflow with `testsuite.TestWorkflowEnvironment` that has two activities, which each start an additional workflow on a newly instantiated `testsuite.TestWorkflowEnvironment`, I expect the nested internal workflows to complete synchronously before the outer workflow completes synchronously as well.\r\n\r\n## Actual Behavior\r\n\r\nOne of the nested test workflows that is started by an activity on a new `testsuite.TestWorkflowEnvironment` exits its `ExecuteWorkflow` call before `testEnvironment.WorkflowIsCompleted()` returns true. If I write `for !testEnvironment.WorkflowIsCompleted() { }` to block the main thread until the workflow completes, eventually `testEnvironment.WorkflowIsCompleted()` evaluates to true, indicating that the workflow is operating in a separate goroutine after `ExecuteWorkflow` returns.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nThe below sample workflow is an approximation of what my code does: a workflow that fires off two activities; each activity starts another workflow by instantiating a new `testsuite.TestWorkflowEnvironment` and executed another workflow. \r\n\r\nUnfortunately, the sample workflow does not seem to reproduce the buggy behaviour and I'm unable to paste my full source code. [Here](https://temporalio.slack.com/archives/CTRCR8RBP/p1668449589481079) is the Slack thread that initially raised the issue\r\n\r\n```\r\nfunc MyWorkflow(\r\n\tctx workflow.Context,\r\n\tstop bool,\r\n) error {\r\n\tif stop {\r\n\t\treturn nil\r\n\t}\r\n\r\n\tvar futures []workflow.Future\r\n\tfor i := 0; i < 2; i++ {\r\n\t\tfuture := workflow.ExecuteActivity(\r\n\t\t\tworkflow.WithActivityOptions(ctx, workflow.ActivityOptions{StartToCloseTimeout: 1 * time.Minute}),\r\n\t\t\tATestActivity,\r\n\t\t)\r\n\t\tfutures = append(futures, future)\r\n\t}\r\n\tfor _, f := range futures {\r\n\t\tif err := f.Get(ctx, nil); err != nil {\r\n\t\t\treturn err\r\n\t\t}\r\n\t}\r\n\r\n\treturn nil\r\n}\r\n\r\n\r\nfunc ATestActivity(ctx context.Context) error {\r\n\tt := testsuite.WorkflowTestSuite{}\r\n\tenv := t.NewTestWorkflowEnvironment()\r\n\tenv.RegisterActivity(s.SleepActivity)\r\n\tenv.ExecuteWorkflow(MyWorkflow, true)\r\n\r\n\trandomID := uuid.NewUUID().String()\r\n\tfor !env.IsWorkflowCompleted() {\r\n\t\tfmt.Println(\"WORKFLOW NOT COMPLETED \" + randomID)\r\n\t}\r\n\r\n\tfmt.Println(\"WORKFLOW COMPLETED \" + randomID)\r\n\r\n\treturn nil\r\n}\r\n\r\nfunc (s *TestSuite) TestMyWorkflow() {\r\n\tt := testsuite.WorkflowTestSuite{}\r\n\tenv := t.NewTestWorkflowEnvironment()\r\n\tenv.RegisterActivity(ATestActivity)\r\n\r\n\tenv.ExecuteWorkflow(MyWorkflow, false)\r\n\ts.NoError(env.GetWorkflowError())\r\n}\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version:\r\n  - Platform:\r\n","closedAt":null,"comments":[{"id":"IC_kwDODN1w685PPgeH","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Unfortunately, the sample workflow does not seem to reproduce the buggy behaviour and I'm unable to paste my full source code.\r\n\r\nIs there any code to reproduce? Can you continually reduce your source that you cannot paste until it is something you can paste while also replicating the error?\r\n\r\n> [Here](https://temporalio.slack.com/archives/CTRCR8RBP/p1668449589481079) is the Slack thread that initially raised the issue\r\n\r\nNote, our public Slack threads are regularly culled so this link may not be valid in the future (but no need, I think you have the gist here).","createdAt":"2022-11-28T17:20:37Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/967#issuecomment-1329465223","viewerDidAuthor":false}],"createdAt":"2022-11-28T16:56:25Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"},{"id":"LA_kwDODN1w687UGgkJ","name":"external dependency","description":"Waiting on something externally","color":"c5def5"}],"milestone":null,"number":967,"reactionGroups":[],"state":"OPEN","title":"testsuite.TestWorkflowEnvironment does not complete workflows synchronously when activities create new environments to start nested workflows","updatedAt":"2022-11-29T18:20:54Z","url":"https://github.com/temporalio/sdk-go/issues/967"}
