{"assignees":[],"author":{"id":"MDQ6VXNlcjMyNTU3NzA2","is_bot":false,"login":"codemonkeycxy","name":"Xinyi Chen"},"body":"## Expected Behavior\r\nSay I have the following activity code\r\n```\r\nfunc (a *Activities) MyActivity(ctx) (out, error)(\r\n  g, gctx := errgroup.WithContext(ctx)\r\n  g.SetLimit(4)\r\n  for _, batch := range batches {\r\n    batch := batch\r\n    g.Go(func() error {\r\n      activity.RecordHeartbeat(gctx)\r\n      // Goroutine logic\r\n    })\r\n  }\r\n  if err := g.Wait(); err != nil {\r\n    return nil, err\r\n  }\r\n\r\n  for _, item := range array {\r\n    activity.RecordHeartbeat(ctx)\r\n    // Additional logic\r\n  }\r\n}\r\n```\r\nI expect heartbeat to get sent out to the server and my activity to NOT time out\r\n\r\n## Actual Behavior\r\nActivity timed out with `activity Heartbeat timeout`\r\n\r\nThis is because `g.Wait()` cancels `gctx` but `gctx` is still referenced in SDK `Heartbeat` function's goroutine https://github.com/temporalio/sdk-go/blob/master/internal/internal_task_handlers.go#L2031. Due to the batch heartbeat logic, `gctx` was used after `g.Wait()` had finished in my code and caused a `context canceled` error when making the call to the server\r\n\r\nI could change `activity.RecordHeartbeat(gctx)` to `activity.RecordHeartbeat(ctx)` but wonder if SDK can avoid this pitfall by using context.Background()\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1.\r\n  1.\r\n  1.\r\n\r\n## Specifications\r\n\r\n  - Version: go.temporal.io/sdk v1.27.0\r\n  - Platform: Linux\r\n","closedAt":null,"comments":[{"id":"IC_kwDODN1w686G07WQ","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Talked offline discussed we should:\r\n* Clarify the documentation around how `RecordHeartbeat` will behave if the calling context is cancelled\r\n* If `RecordHeartbeat` is called with multiple contexts we should use the last non cancelled context.","createdAt":"2024-08-01T04:44:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1574#issuecomment-2262021520","viewerDidAuthor":false}],"createdAt":"2024-07-31T19:17:48Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1574,"reactionGroups":[],"state":"OPEN","title":"Batched heartbeat got canceled due to caller context cancellation","updatedAt":"2024-08-01T04:44:54Z","url":"https://github.com/temporalio/sdk-go/issues/1574"}
