{"assignees":[],"author":{"id":"MDQ6VXNlcjMxNTM0MzYw","is_bot":false,"login":"vmalyavin","name":"Vasiliy Malyavin"},"body":"[You can view full workflow code of reproduction in repo](https://github.com/vmalyavin/temporalissue)\r\n\r\nWe have a simple workflow cycle with select\r\n- pereodic polling(payment status from activity every 2-3min)\r\n- workflow-cancel signal receive\r\n- timeout\r\n```go\r\npackage testflow\r\n\r\nimport (\r\n\t\"time\"\r\n\r\n\t\"go.temporal.io/sdk/workflow\"\r\n\r\n\t\"temporalissue/models\"\r\n\t\"temporalissue/workflows/testflow/signals\"\r\n)\r\n\r\nfunc PollPaymentStatus20MinOrReceiveCancel(\r\n\tctx workflow.Context, order *models.Order,\r\n) models.PaymentStatus {\r\n\tvar status models.PaymentStatus\r\n\r\n\t// cycle over timer - 20min\r\n\titsOver := false\r\n\toverTimer := workflow.NewTimer(ctx, 20*time.Minute)\r\n\toverCallback := func(_ workflow.Future) { itsOver = true }\r\n\r\n\tfor !itsOver {\r\n\t\tpollTimer, pollCallback := pollPaymentStatus(\r\n\t\t\tctx, 3*time.Minute, &status, order,\r\n\t\t)\r\n\t\tselector := workflow.NewSelector(ctx).\r\n\t\t\tAddFuture(pollTimer, pollCallback).\r\n\t\t\tAddFuture(overTimer, overCallback).\r\n\t\t\tAddReceive(signals.CancellationReceive(ctx, order))\r\n\t\tselector.Select(ctx)\r\n\r\n\t\t// end cycle if paymentstatus is changed from new; or order is cancelled\r\n\t\tif status == models.PaymentStatusNew || order.Status == models.OrderStatusCancel {\r\n\t\t\tbreak\r\n\t\t}\r\n\t}\r\n\r\n\treturn status\r\n}\r\n```\r\n\r\nthen after end of the cycle we \r\n- complete workflow\r\n\r\nor  \r\n- cancel it(by signal) and poll payment status for 10min after cancel:\r\n```go\r\nfunc PollPaymentStatus10Min(\r\n\tctx workflow.Context, order *models.Order,\r\n) models.PaymentStatus {\r\n\tvar status models.PaymentStatus\r\n\r\n\t// cycle over timer - 10min\r\n\titsOver := false\r\n\toverTimer := workflow.NewTimer(ctx, 10*time.Minute)\r\n\toverCallback := func(_ workflow.Future) { itsOver = true }\r\n\r\n\tfor !itsOver {\r\n\t\tpollTimer, pollCallback := pollPaymentStatus(\r\n\t\t\tctx, 2*time.Minute, &status, order,\r\n\t\t)\r\n\t\tselector := workflow.NewSelector(ctx).\r\n\t\t\tAddFuture(pollTimer, pollCallback).\r\n\t\t\tAddFuture(overTimer, overCallback)\r\n\t\t// no cancel receive\r\n\t\tselector.Select(ctx)\r\n\r\n\t\t// end cycle if paymentstatus is changed from new\r\n\t\tif status != models.PaymentStatusNew {\r\n\t\t\tbreak\r\n\t\t}\r\n\t}\r\n\r\n\treturn status\r\n}\r\n```\r\n## Expected Behavior\r\nWorkflow is gracefully cancelled and all timers is cancelled by workflow context\r\n\r\n## Actual Behavior\r\npanic with events outside workflow context:\r\n_\"test panicked: getState: illegal access from outside of workflow context\"_\r\n\r\n## Steps to Reproduce the Problem\r\nExample of workflow with error reproduction available\r\n[in repo](https://github.com/vmalyavin/temporalissue)\r\nyou can pull it and try\r\n\r\n## Specifications\r\n  - Version: 1.25.1\r\n","closedAt":"2023-12-01T16:15:10Z","comments":[{"id":"IC_kwDODN1w685q5p8E","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"The issue appears to be that return a cancelled error from a workflow in the test suite causes the test suite to call the [cancel callback ](https://github.com/temporalio/sdk-go/blob/master/internal/internal_workflow_testsuite.go#L876). This is not allowed as at this point the workflow execution is finished.","createdAt":"2023-11-04T17:12:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1287#issuecomment-1793498884","viewerDidAuthor":false},{"id":"IC_kwDODN1w685q-XMw","author":{"login":"vmalyavin"},"authorAssociation":"NONE","body":"It means - this is testsuite-only problem?\r\n","createdAt":"2023-11-06T12:41:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1287#issuecomment-1794732848","viewerDidAuthor":false},{"id":"IC_kwDODN1w685rAZHD","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Yes this would only effect the testsuite, not the devserver or a normal temporal cluster","createdAt":"2023-11-06T16:05:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1287#issuecomment-1795264963","viewerDidAuthor":false}],"createdAt":"2023-11-03T22:38:37Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1287,"reactionGroups":[],"state":"CLOSED","title":"Error \"getState: illegal access from outside of workflow context\" after sdk update  1.22.1 -> 1.25.1","updatedAt":"2023-12-01T16:15:10Z","url":"https://github.com/temporalio/sdk-go/issues/1287"}
