{"assignees":[],"author":{"id":"MDQ6VXNlcjQxMjc3ODMw","is_bot":false,"login":"anz-rfc","name":""},"body":"## Expected Behavior\r\n\r\nIf a workflow sets Activity RetryPolicy with MaximumAttempts=1 then corresponding activity execution will not be attempted more than 1 time.\r\n\r\nThis expectation is based on interpretation of MaximumAttempts parameter as documented in [temporal-v0.28.0-changelog](https://docs.temporal.io/blog/temporal-v0.28.0-changelog/#what-has-changed):\r\n\r\n> Activity retry refactors ðŸ” :\r\n> To disable Activity retries, configure Activities with RetryOptions that set maximumAttempts to 1.\r\n\r\nThe number of retry attempts when running against real temporal server (temporalio/auto-setup:1.7.0 ) and running the workflow using the temporal go SDK workflow unit test framework will be the same.\r\n\r\n## Actual Behavior\r\n\r\nWhen running the workflow using the temporal go sdk workflow unit test framework, if a workflow sets a Activity RetryPolicy with MaximumAttempts=1 then corresponding activity execution is attempted _twice_ (one more time than expected).\r\n\r\nSimiliar pattern observed if MaximumAttempts is set to some value n > 1  During unit tests the activity is executed n+1 times, one more time than expected.\r\n\r\nThe same behaviour is not observed when the workflow is run against a real temporal server outside of the temporal go sdk unit test framework\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n### unit test `retry_test.go` reproduces this behaviour\r\n\r\n```\r\npackage main\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"fmt\"\r\n\t\"testing\"\r\n\t\"time\"\r\n\r\n\t\"github.com/stretchr/testify/mock\"\r\n\t\"github.com/stretchr/testify/suite\"\r\n\t\"go.temporal.io/sdk/client\"\r\n\t\"go.temporal.io/sdk/temporal\"\r\n\t\"go.temporal.io/sdk/testsuite\"\r\n\t\"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\nconst MaximumActivityExecutionAttempts = 1\r\n\r\nvar NoRetryPolicy = temporal.RetryPolicy{\r\n\tInitialInterval:        time.Second * 1,\r\n\tBackoffCoefficient:     2.0,\r\n\tMaximumInterval:        time.Second * 60,\r\n\tMaximumAttempts:        MaximumActivityExecutionAttempts,\r\n\tNonRetryableErrorTypes: []string{},\r\n}\r\n\r\nvar StandardActivityOptions = workflow.ActivityOptions{\r\n\tTaskQueue:              \"test\",\r\n\tScheduleToCloseTimeout: time.Hour * 24 * 3,\r\n\tScheduleToStartTimeout: time.Hour * 24 * 3,\r\n\tStartToCloseTimeout:    time.Hour * 24 * 3,\r\n\tWaitForCancellation:    false,\r\n\tRetryPolicy:            &NoRetryPolicy,\r\n}\r\n\r\nfunc Foo(ctx workflow.Context) error {\r\n\tctx = workflow.WithActivityOptions(ctx, StandardActivityOptions)\r\n\terr := workflow.ExecuteActivity(ctx, Bar).Get(ctx, nil)\r\n\treturn err\r\n}\r\n\r\nfunc Bar(ctx context.Context) error {\r\n\treturn nil\r\n}\r\n\r\ntype RetryActivitySuite struct {\r\n\tsuite.Suite\r\n\ttestsuite.WorkflowTestSuite\r\n\r\n\tenv *testsuite.TestWorkflowEnvironment\r\n}\r\n\r\nfunc (s *RetryActivitySuite) SetupTest() {\r\n\ts.env = s.NewTestWorkflowEnvironment()\r\n\ts.env.SetStartWorkflowOptions(client.StartWorkflowOptions{RetryPolicy: nil})\r\n\ts.env.RegisterWorkflow(Foo)\r\n}\r\n\r\nfunc (s *RetryActivitySuite) AfterTest(suiteName, testName string) {\r\n\ts.env.AssertExpectations(s.T())\r\n}\r\n\r\nfunc (s *RetryActivitySuite) TestActivityRetryPolicyMaximumOneAttempt() {\r\n\r\n\tvar count int = 0\r\n\r\n\ts.env.OnActivity(Bar, mock.Anything).Return(\r\n\t\tfunc(ctx context.Context) error {\r\n\t\t\tcount += 1\r\n\t\t\terr := fmt.Errorf(\"simulated Bar activity failure (mock has been called %d time(s))\", count)\r\n\t\t\treturn err\r\n\t\t},\r\n\t)\r\n\r\n\ts.env.ExecuteWorkflow(Foo)\r\n\ts.True(s.env.IsWorkflowCompleted())\r\n\ts.Error(s.env.GetWorkflowError())\r\n\r\n\t// We expect the mock Bar activity to be called\r\n\t// the same number of times as the activity retry policy's\r\n\t// MaximumAttempts parameter\r\n\ts.Equal(MaximumActivityExecutionAttempts, count)\r\n}\r\n\r\nfunc TestRetryActivitySuite(t *testing.T) {\r\n\tsuite.Run(t, new(RetryActivitySuite))\r\n}\r\n```\r\n\r\n\r\n```\r\nmkdir -p temporal_retry_in_test_harness && cd temporal_retry_in_test_harness\r\ngo mod init example.com/temporal_retry_in_test_harness\r\n# <save copy of above test as retry_test.go in working dir>\r\ngo test -v ./...\r\n```\r\n\r\nthe test will fail and the following output will be visible\r\n\r\n\r\n```\r\n$ go test -v ./...\r\n=== RUN   TestRetryActivitySuite\r\n=== RUN   TestRetryActivitySuite/TestActivityRetryPolicyMaximumOneAttempt\r\n2021/05/05 16:27:13 ERROR Activity error. WorkflowID default-test-workflow-id RunID default-test-run-id ActivityType Bar Attempt 1 Error simulated Bar activity failure (mock has been called 1 time(s))\r\n2021/05/05 16:27:13 DEBUG Auto fire timer TimerID 2 TimerDuration 2s TimeSkipped 2s\r\n2021/05/05 16:27:13 ERROR Activity error. WorkflowID default-test-workflow-id RunID default-test-run-id ActivityType Bar Attempt 2 Error simulated Bar activity failure (mock has been called 2 time(s))\r\n2021/05/05 16:27:13 DEBUG handleActivityResult: *workflowservice.RespondActivityTaskFailedRequest. ActivityID 1 ActivityType Bar\r\n    retry_test.go:80: \r\n        \tError Trace:\tretry_test.go:80\r\n        \tError:      \tNot equal: \r\n        \t            \texpected: 1\r\n        \t            \tactual  : 2\r\n        \tTest:       \tTestRetryActivitySuite/TestActivityRetryPolicyMaximumOneAttempt\r\n    workflow_testsuite.go:771: PASS:\tBar(string)\r\n--- FAIL: TestRetryActivitySuite (0.00s)\r\n    --- FAIL: TestRetryActivitySuite/TestActivityRetryPolicyMaximumOneAttempt (0.00s)\r\nFAIL\r\nFAIL\texample.com/temporal_retry_in_test_harness\t1.054s\r\nFAIL\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: go.temporal.io/sdk v1.6.0\r\n  - Platform: macOS catalina\r\n\r\n`cat go.mod`\r\n\r\n```\r\n$ cat go.mod \r\nmodule example.com/temporal_retry_in_test_harness\r\n\r\ngo 1.14\r\n\r\nrequire (\r\n\tgithub.com/stretchr/testify v1.7.0\r\n\tgo.temporal.io/sdk v1.6.0\r\n)\r\n```\r\n\r\n`cat go.sum | grep -i temporal`\r\n\r\n```\r\ngo.temporal.io/api v1.4.1-0.20210318194442-3f93fcec559f h1:TuHm1nX42+u7/5j9N9Mg3eX4jsri7mrpd0FivOciBH0=\r\ngo.temporal.io/api v1.4.1-0.20210318194442-3f93fcec559f/go.mod h1:c2dcPOVyWUq3IH9RIzfmKkKNSfHotYcfNzJOW+demW8=\r\ngo.temporal.io/sdk v1.6.0 h1:uVbyCd6Rs77rk5ohhWRYtPnQ7STZD2xLDAkJn8JnbaQ=\r\ngo.temporal.io/sdk v1.6.0/go.mod h1:7vODGLBoovAW72JxeMq4jENWmEkzKceNVTiIEOF5xJY=\r\n```","closedAt":"2022-07-08T13:58:58Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDgzMjQ1Njc0OA==","author":{"login":"anz-rfc"},"authorAssociation":"NONE","body":"From debugging the temporal go SDK during unit testing, the logic that defines how many retry attempts happen during workflow unit testing using go SDK appears to be here: \r\n\r\nhttps://github.com/temporalio/sdk-go/blob/fc2850edf7102469b569a274a3b6f4d5ac24db50/internal/internal_task_handlers.go#L1019-L1021\r\n\r\nit is called from `go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeActivityWithRetryForTest`\r\n\r\nIn contrast, look at the handling of maximum attempts inside the actual temporal server:\r\n\r\nhttps://github.com/temporalio/temporal/blob/30c89b9f91dafc13d2d75fda266d81ce8bc72f3e/service/history/retry.go#L59-L68\r\n\r\nRelated to temporal server PR \"Start attempts with 1 instead of 0\" https://github.com/temporalio/temporal/pull/554 , related to issue https://github.com/temporalio/temporal/issues/232\r\n\r\n\r\nLooks perhaps like the temporal go SDK used for unit testing workflow disagrees with temporal server about 1-based vs 0-based activity execution attempt numbering.","createdAt":"2021-05-05T06:53:11Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/429#issuecomment-832456748","viewerDidAuthor":false},{"id":"IC_kwDODN1w685EaJcr","author":{"login":"fauzymk"},"authorAssociation":"NONE","body":"Hi, I also run into the same problem. Any solution or workaround?","createdAt":"2022-06-06T17:35:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/429#issuecomment-1147705131","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Eak4Y","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I will try to investigate this shortly...","createdAt":"2022-06-06T19:25:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/429#issuecomment-1147817496","viewerDidAuthor":false},{"id":"IC_kwDODN1w685GRnI9","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I have confirmed that this does not occur any longer (it appears to have been fixed a while back). Pasting the exact same replication code does pass the test suite. I am closing, but please update or create a new issue if you have a test case that can replicate.","createdAt":"2022-07-08T13:58:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/429#issuecomment-1179021885","viewerDidAuthor":false}],"createdAt":"2021-05-05T06:31:31Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":429,"reactionGroups":[],"state":"CLOSED","title":"Activity RetryPolicy MaximumAttempts behaves differently in workflow unit test compared to executing same workflow against real temporal server","updatedAt":"2022-07-08T13:58:58Z","url":"https://github.com/temporalio/sdk-go/issues/429"}
