{"assignees":[{"id":"MDQ6VXNlcjIwNjM5Ng==","login":"cretz","name":"Chad Retz","databaseId":0}],"author":{"id":"MDQ6VXNlcjQzODIxMDA=","is_bot":false,"login":"jmoseley","name":"Jeremy Moseley"},"body":"* Have a child and a parent workflow. The parent workflow does something interesting while the child is executing\r\n* Inside the parent workflow, call `GetChildWorkflowExecution` to obtain the `runID` for the child\r\n* Inside the parent sleep for some amount of time\r\n* Inside of the parent workflow, after the sleep, use `.IsReady()` to determine if the child has completed or not\r\n* In tests, use `OnWorkflow` to mock a child workflow, and use `.After` to delay completion some amount of time\r\n\r\n## Expected Behavior\r\n\r\n* The parent workflow should do the interesting work while the child is executing, and `IsReady == false` until the appropriate amount of time has elapsed.\r\n\r\n## Actual Behavior\r\n\r\n* The parent sees `IsReady() == true` immediately after calling `GetChildWorkflowExecution` and sleeping\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nHere is a sample the reproduces the issue. The first test (without mocking the child) passes, the second does not.\r\n\r\n```\r\npackage workflows_test\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"fmt\"\r\n\t\"testing\"\r\n\t\"time\"\r\n\r\n\t\"github.com/stretchr/testify/mock\"\r\n\t\"github.com/stretchr/testify/suite\"\r\n\r\n\t\"go.temporal.io/sdk/testsuite\"\r\n\t\"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\nfunc Workflow(ctx workflow.Context) (string, error) {\r\n\tlogger := workflow.GetLogger(ctx)\r\n\tchildWorkflowContext := workflow.WithChildOptions(ctx, workflow.ChildWorkflowOptions{\r\n\t\tWorkflowID: \"child_workflow\",\r\n\t})\r\n\tchildWorkflowFuture := workflow.ExecuteChildWorkflow(childWorkflowContext, ChildWorkflow)\r\n\r\n\tvar childWorkflowExecution workflow.Execution\r\n\terr := childWorkflowFuture.GetChildWorkflowExecution().Get(ctx, &childWorkflowExecution)\r\n\tif err != nil {\r\n\t\tlogger.Error(\"Error getting child workflow execution\")\r\n\t\treturn \"FAILURE\", err\r\n\t}\r\n\r\n\tlogger.Info(\"Got child workflow execution\", \"WorkflowID\", childWorkflowExecution.ID, \"RunID\", childWorkflowExecution.RunID)\r\n\r\n\tworkflow.Sleep(ctx, time.Minute*5)\r\n\r\n\tif childWorkflowFuture.IsReady() {\r\n\t\tlogger.Error(\"Child workflow finished before activity\")\r\n\t\treturn \"FAILURE\", nil\r\n\t}\r\n\r\n\tactivityContext := workflow.WithActivityOptions(ctx, workflow.ActivityOptions{\r\n\t\tScheduleToCloseTimeout: time.Minute,\r\n\t\tStartToCloseTimeout:    time.Minute,\r\n\t})\r\n\tworkflow.ExecuteActivity(activityContext, MyCoolActivity, childWorkflowExecution.RunID).Get(ctx, nil)\r\n\tlogger.Info(\"Finished activity, waiting for child to finish.\")\r\n\r\n\terr = childWorkflowFuture.Get(ctx, nil)\r\n\tif err != nil {\r\n\t\tlogger.Error(\"Child workflow failed\")\r\n\t\treturn \"FAILURE\", err\r\n\t}\r\n\r\n\tlogger.Info(\"Child workflow complete\")\r\n\r\n\treturn \"SUCCESS\", nil\r\n}\r\n\r\nfunc ChildWorkflow(ctx workflow.Context) (string, error) {\r\n\tworkflow.Sleep(ctx, time.Hour*2)\r\n\r\n\treturn \"\", nil\r\n}\r\n\r\nfunc MyCoolActivity(ctx context.Context, childWorkflowRunID string) error {\r\n\tfmt.Printf(\"Child Workflow: %s\\n\", childWorkflowRunID)\r\n\r\n\treturn nil\r\n}\r\n\r\ntype UnitTestSuite struct {\r\n\tsuite.Suite\r\n\ttestsuite.WorkflowTestSuite\r\n\r\n\tenv *testsuite.TestWorkflowEnvironment\r\n}\r\n\r\nfunc (s *UnitTestSuite) SetupTest() {\r\n\ts.env = s.NewTestWorkflowEnvironment()\r\n}\r\n\r\nfunc (s *UnitTestSuite) AfterTest(suiteName, testName string) {\r\n\ts.env.AssertExpectations(s.T())\r\n}\r\n\r\n// Test without mocking the child workflow.\r\nfunc (s *UnitTestSuite) Test_SampleWorkflow_NoMockChild() {\r\n\ts.env.RegisterWorkflow(Workflow)\r\n\ts.env.RegisterWorkflow(ChildWorkflow)\r\n\r\n\ts.env.OnActivity(MyCoolActivity, mock.Anything, mock.Anything).Return(nil)\r\n\r\n\ts.env.ExecuteWorkflow(Workflow)\r\n\r\n\ts.True(s.env.IsWorkflowCompleted())\r\n\ts.NoError(s.env.GetWorkflowError())\r\n\r\n\tvar result string\r\n\ts.env.GetWorkflowResult(&result)\r\n\r\n\ts.Equal(result, \"SUCCESS\")\r\n\r\n\ts.env.AssertExpectations(s.T())\r\n}\r\n\r\n// Test with mocking the child workflow.\r\nfunc (s *UnitTestSuite) Test_SampleWorkflow_MockChild() {\r\n\ts.env.RegisterWorkflow(Workflow)\r\n\ts.env.RegisterWorkflow(ChildWorkflow)\r\n\r\n\ts.env.OnActivity(MyCoolActivity, mock.Anything, mock.Anything).Return(nil)\r\n\ts.env.OnWorkflow(ChildWorkflow, mock.Anything).After(time.Hour).Return(\r\n\t\tfunc(ctx workflow.Context) (string, error) {\r\n\t\t\treturn \"SUCCESS\", nil\r\n\t\t},\r\n\t)\r\n\r\n\ts.env.ExecuteWorkflow(Workflow)\r\n\r\n\ts.True(s.env.IsWorkflowCompleted())\r\n\ts.NoError(s.env.GetWorkflowError())\r\n\r\n\tvar result string\r\n\ts.env.GetWorkflowResult(&result)\r\n\r\n\ts.Equal(result, \"SUCCESS\")\r\n\r\n\ts.env.AssertExpectations(s.T())\r\n}\r\n\r\nfunc TestUnitTestSuite(t *testing.T) {\r\n\tsuite.Run(t, new(UnitTestSuite))\r\n}\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: v1.8.0\r\n  - Platform: go-sdk\r\n","closedAt":null,"comments":[{"id":"IC_kwDODN1w6840zVex","author":{"login":"jmoseley"},"authorAssociation":"NONE","body":"Just made a small update, the reproduction was not quite right.","createdAt":"2021-07-23T19:38:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/495#issuecomment-885872561","viewerDidAuthor":false},{"id":"IC_kwDODN1w68401UUO","author":{"login":"vitarb"},"authorAssociation":"CONTRIBUTOR","body":"Thanks for reporting the issue and including a repro, we are going to look at it soon.","createdAt":"2021-07-26T05:38:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/495#issuecomment-886392078","viewerDidAuthor":false},{"id":"IC_kwDODN1w6844nLio","author":{"login":"rupalivohra"},"authorAssociation":"NONE","body":"Hey @vitarb - Is there an eta for this to be addressed?","createdAt":"2021-10-22T16:40:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/495#issuecomment-949794984","viewerDidAuthor":false},{"id":"IC_kwDODN1w685nXr_v","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"I'll note this issue can be worked around by not using `OnWorkflow`, instead register your own \"mock\" workflow\r\n\r\ninstead of this\r\n```\r\ns.env.RegisterWorkflow(ChildWorkflow)\r\ns.env.OnWorkflow(ChildWorkflow, mock.Anything).After(time.Hour).Return(\r\n  func(ctx workflow.Context) (string, error) {\r\n\t  return \"SUCCESS\", nil\r\n  },\r\n)\r\n```\r\n\r\nregister your own\r\n```\r\nenv.RegisterWorkflowWithOptions(func(ctx workflow.Context) (string, error) {\r\n\tworkflow.Sleep(ctx, time.Hour)\r\n         return \"SUCCESS\", nil\r\n}, workflow.RegisterOptions{\r\n  Name: \"ChildWorkflow\",\r\n})\r\n```\r\n\r\n\r\n","createdAt":"2023-09-25T18:30:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/495#issuecomment-1734262767","viewerDidAuthor":false},{"id":"IC_kwDODN1w686gDkZU","author":{"login":"dibrito"},"authorAssociation":"NONE","body":"Try something like:\n\n`    s.env.OnWorkflow(ChildWorkflow, mock.Anything).Return(testsuite.ErrMockStartChildWorkflowFailed)`\n\nto simulate a failure in starting the child workflow.\n\nRegisterWorkflowWithOptions didn't work for me.\n","createdAt":"2025-02-26T14:49:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/495#issuecomment-2685290068","viewerDidAuthor":false}],"createdAt":"2021-07-23T18:29:45Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":495,"reactionGroups":[],"state":"OPEN","title":"Calling `GetChildWorkflowExecution` for a mocked workflow in a test causes the runner to complete the child workflow.","updatedAt":"2025-02-26T14:49:13Z","url":"https://github.com/temporalio/sdk-go/issues/495"}
