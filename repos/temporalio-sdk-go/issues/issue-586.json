{"assignees":[],"author":{"id":"MDQ6VXNlcjEyODUxMzAy","is_bot":false,"login":"roselander","name":"Jason Roselander"},"body":"## Expected Behavior\r\n\r\nShould be able to specify exact input struct to match when calling `OnActivity`.\r\n\r\n## Actual Behavior\r\n\r\nError: `Unexpected Metho\r\n[delete_role.txt](https://github.com/temporalio/\r\n[delete_role_activities.txt](https://github.com/temporalio/sdk-go/files/7341180/delete_role_activities.txt)\r\nsdk-go/files/7341171/delete_role.txt)\r\nd Call`, and actual activity input observed by test environment is missing field which I know is set by the workflow. Output:\r\n\r\n```\r\n\tmock: Unexpected Method Call\r\n\t-----------------------------\r\n\tDeleteRole2(*auth0.DeleteRoleActivities,<nil>,auth0.DeleteRoleActivityInput)\r\n\t\t\t0: &auth0.DeleteRoleActivities{auth0:auth0.Auth0(nil)}\r\n\t\t\t1: <nil>\r\n\t\t\t2: auth0.DeleteRoleActivityInput{RoleName:\"\"}\r\n\tThe closest call I have is:\r\n\tDeleteRole2(string,string,auth0.DeleteRoleActivityInput)\r\n\t\t\t0: \"mock.Anything\"\r\n\t\t\t1: \"mock.Anything\"\r\n\t\t\t2: auth0.DeleteRoleActivityInput{RoleName:\"test-role\"}\r\n```\r\n[delete_role_test.txt](https://github.com/temporalio/sdk-go/files/7341185/delete_role_test.txt)\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nSee attached WF, Activity, and Unit Test.\r\n","closedAt":"2021-11-01T17:54:51Z","comments":[{"id":"IC_kwDODN1w6844MFeU","author":{"login":"roselander"},"authorAssociation":"NONE","body":"[delete_role_activities.txt](https://github.com/temporalio/sdk-go/files/7341191/delete_role_activities.txt)\r\n[delete_role.txt](https://github.com/temporalio/sdk-go/files/7341192/delete_role.txt)\r\n","createdAt":"2021-10-13T20:24:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/586#issuecomment-942692244","viewerDidAuthor":false},{"id":"IC_kwDODN1w6844YKTq","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@roselander - The issue here is you are using a function pointer on the type instead of an instance of the type. Activity function references are expected to be already associated with an instance.\r\n\r\nIf you changed:\r\n\r\n```go\r\n\ts.env.OnActivity(\r\n\t\t(*DeleteRoleActivities).DeleteRole2,\r\n\t\tmock.Anything,\r\n\t\tmock.Anything,\r\n\t\tDeleteRoleActivityInput{\"test-role\"},\r\n\t).Return(\r\n\t\tDeleteRoleActivityOutput{},\r\n\t\tnil,\r\n\t)\r\n```\r\n\r\nto\r\n\r\n```go\r\n\ts.env.OnActivity(\r\n\t\tnew(DeleteRoleActivities).DeleteRole2,\r\n\t\tmock.Anything,\r\n\t\tDeleteRoleActivityInput{\"test-role\"},\r\n\t).Return(\r\n\t\tDeleteRoleActivityOutput{},\r\n\t\tnil,\r\n\t)\r\n```\r\n\r\nThen it would work. Also, you should change your invocation of `ExecuteActivity` _inside_ the workflow to use an instance of the `DeleteRoleActivities` instead of a reference to the function without an instance of the receiver, but that's not required.\r\n\r\nThe reason this is allowed to be registered and in general works at runtime is because both `new(DeleteRoleActivities).DeleteRole2` and `(*DeleteRoleActivities).DeleteRole2` resolve to the same activity name of `DeleteRole2`, but to the mocking engine, the former looks like `DeleteRole2(context, param)` and the latter looks like `DeleteRole2(*DeleteRoleActivities, context, param)` which messes up the param deserializer.","createdAt":"2021-10-18T14:52:08Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/586#issuecomment-945857770","viewerDidAuthor":false},{"id":"IC_kwDODN1w6845Aks1","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Please feel free to reopen if your issue remains unresolved. Thanks!","createdAt":"2021-11-01T17:54:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/586#issuecomment-956451637","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Blo29","author":{"login":"laniehei"},"authorAssociation":"MEMBER","body":"How do I mock an activity input that involves a pointer? e.g. \r\n\r\n```\r\ntype DeleteRoleActivityInput struct {\r\n     Role *string \r\n}\r\ntestRole := \"testRole\"\r\ns.env.OnActivity(\r\n\t\tnew(DeleteRoleActivities).DeleteRole2,\r\n\t\tmock.Anything,\r\n\t\tDeleteRoleActivityInput{Role: &testRole},\r\n\t).Return(\r\n\t\tDeleteRoleActivityOutput{},\r\n\t\tnil,\r\n\t)\r\n```\r\n\r\nIt fails when I test the given workflow because 'testRole' is a different spot in memory. ","createdAt":"2022-04-15T20:44:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/586#issuecomment-1100385725","viewerDidAuthor":false},{"id":"IC_kwDODN1w685BlwM5","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"The mocking library is https://pkg.go.dev/github.com/stretchr/testify/mock so the parameter matching is done via https://pkg.go.dev/github.com/stretchr/testify/mock#Mock.On. I am not an expert on that mocking library, but it seems that except for some special cases, it just does equality check. In Go, equality check on pointers means they must point to the same thing (so that literal `testRole` variable, ref https://go.dev/ref/spec#Comparison_operators).\r\n\r\nUsually though, when you mock, you don't need to be so specific on the argument types to do your assertion. Per https://pkg.go.dev/go.temporal.io/sdk/internal#TestWorkflowEnvironment.OnActivity we made a special case where you can provide a callback here, and in there you can assert exact data. If you _really_ wanted to have advanced matching though, you could do something like (untested):\r\n\r\n```go\r\ns.env.OnActivity(\r\n  new(DeleteRoleActivities).DeleteRole2,\r\n  mock.Anything,\r\n  mock.MatchedBy(func(in *DeleteRoleActivityInput) bool { return *in.Role == \"testRole\" }),\r\n)\r\n```\r\n\r\n(Also note, in Go pointers to primitives are usually discouraged if just using for knowing `nil` vs value. If the difference between empty string and `nil` is significant it can make sense, but otherwise treating an empty string as unset is clearer.)","createdAt":"2022-04-15T21:19:24Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/586#issuecomment-1100415801","viewerDidAuthor":false},{"id":"IC_kwDODN1w685B-TDE","author":{"login":"roselander"},"authorAssociation":"NONE","body":"Is there any reason not to throw a descriptive error if someone uses the `(*Activities).Activity` invocation? ","createdAt":"2022-04-22T20:50:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/586#issuecomment-1106849988","viewerDidAuthor":false},{"id":"IC_kwDODN1w685B-UN8","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Kinda. In Go, `(*SomeStruct).Function(string)` and `Function(*SomeStruct, string)` look the same at runtime. Technically I can do some advanced things to confirm whether that first param is a receiver or not maybe, but I think it's technically ok to register `(*SomeStruct).Function(string)` and accept `*SomeStruct` as the first param, so not sure we should explicitly prevent it.","createdAt":"2022-04-22T20:56:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/586#issuecomment-1106854780","viewerDidAuthor":false}],"createdAt":"2021-10-13T20:23:45Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":586,"reactionGroups":[],"state":"CLOSED","title":"Activity mocking in test framework not able to do exact match of arguments","updatedAt":"2022-04-22T20:56:13Z","url":"https://github.com/temporalio/sdk-go/issues/586"}
