{"assignees":[],"author":{"id":"MDQ6VXNlcjI2NTg0NDc4","is_bot":false,"login":"albertteoh","name":"Albert"},"body":"**Is your feature request related to a problem? Please describe.**\r\n\r\nWe have adopted OpenTelemetry Go SDK as our primary instrumentation library; however, with Temporal requiring Tally, it means we'll have a combination of different metrics libraries which are both pull and push based, which complicates our deployment configuration.\r\n\r\n**Describe the solution you'd like**\r\nFor Temporal to support OpenTelemetry for its metrics instrumentation.\r\n\r\n**Describe alternatives you've considered**\r\n\r\n- Implement the [`metrics.Handler`](https://github.com/temporalio/sdk-go/blob/master/internal/common/metrics/handler.go#L34) interface to wrap OpenTelemetry. However, one of the interface methods returns the `Handler` itself, which is in an `internal` package. So, this alternative doesn't seem to be feasible (but correct me if I'm wrong). Moreover, it's not a particularly nice solution.\r\n\r\n**Additional context**\r\nI have read that adopting OpenTelemetry was delayed because of its instability ([reference](https://community.temporal.io/t/opentracing-and-opentelemetry-for-temporal/3986/3)). \r\n\r\nIt now seems that the API and protocol are now stable ([link](https://opentelemetry.io/docs/specs/status/#metrics)), and many components of the SDK are also stable ([link](https://opentelemetry.io/docs/specs/otel/metrics/sdk/#meterprovider)).\r\n","closedAt":"2023-06-14T13:30:35Z","comments":[{"id":"IC_kwDODN1w685e1zMN","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"You linked to stability of the spec not stability of the Go SDK. Right now https://opentelemetry.io/docs/instrumentation/go/ shows metrics as beta.\r\n\r\n> However, one of the interface methods returns the Handler itself, which is in an internal package. So, this alternative doesn't seem to be feasible (but correct me if I'm wrong). \r\n\r\nThe handler and all types it may need are aliased and exported from the `client` package.\r\n\r\n> Moreover, it's not a particularly nice solution.\r\n\r\nShould be really easy and this type of solution is used by many who have other metrics implementations. Of course we would like to support it once the OTel Go metrics API is stable.","createdAt":"2023-06-14T12:59:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1137#issuecomment-1591161613","viewerDidAuthor":false},{"id":"IC_kwDODN1w685e2AZ-","author":{"login":"albertteoh"},"authorAssociation":"NONE","body":"> You linked to stability of the spec not stability of the Go SDK. Right now https://opentelemetry.io/docs/instrumentation/go/ shows metrics as beta.\r\n\r\nAh yes, you're right! ðŸ˜„ It's fair that it's not yet supported in Temporal.\r\n\r\n> The handler and all types it may need are aliased and exported from the client package.\r\n\r\nGotcha, I might give this another shot, thanks for the help!","createdAt":"2023-06-14T13:30:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/1137#issuecomment-1591215742","viewerDidAuthor":false},{"id":"IC_kwDODN1w685w1JXy","author":{"login":"albertteoh"},"authorAssociation":"NONE","body":"Just thought to mention that metrics are now considered stable in OpenTelemetry.\r\n\r\n![Screenshot 2024-01-16 at 1 28 27â€¯pm](https://github.com/temporalio/sdk-go/assets/26584478/b95aa89c-9d8e-428e-9d04-73543169d37e)\r\n","createdAt":"2024-01-16T02:28:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1137#issuecomment-1892980210","viewerDidAuthor":false},{"id":"IC_kwDODN1w685w1TQc","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"@albertteoh Otel metrics are now implemented,  because they  are stable https://github.com/temporalio/sdk-go/blob/master/contrib/opentelemetry/handler.go\r\n\r\nExpect them to be in the next release soon","createdAt":"2024-01-16T03:34:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/1137#issuecomment-1893020700","viewerDidAuthor":false},{"id":"IC_kwDODN1w685ykg0w","author":{"login":"albertteoh"},"authorAssociation":"NONE","body":"> Expect them to be in the next release soon\r\n\r\nThank you for adding OTEL metrics instrumentation! \r\nWe're quite keen on this feature; when is the next release planned for @Quinn-With-Two-Ns?","createdAt":"2024-02-01T20:23:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1137#issuecomment-1922174256","viewerDidAuthor":false},{"id":"IC_kwDODN1w685ykixv","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"@albertteoh This has been release for a couple weeks now https://github.com/temporalio/sdk-go/releases/tag/contrib%2Fopentelemetry%2Fv0.4.0\r\n\r\nNote: the open telemetry contrib package release is not tied with the SDK release","createdAt":"2024-02-01T20:28:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/1137#issuecomment-1922182255","viewerDidAuthor":false},{"id":"IC_kwDODN1w685yk8IH","author":{"login":"albertteoh"},"authorAssociation":"NONE","body":"Ah, thanks so much @Quinn-With-Two-Ns! I didn't realise there was a separate release for the otel contrib package.","createdAt":"2024-02-01T21:34:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1137#issuecomment-1922286087","viewerDidAuthor":false},{"id":"IC_kwDODN1w685yu7Ji","author":{"login":"albertteoh"},"authorAssociation":"NONE","body":"Hi @Quinn-With-Two-Ns, I tried upgrading the otel contrib package and it resulted in the following build error:\r\n```\r\n# go.temporal.io/sdk/internal/protocol\r\n../../../../pkg/mod/go.temporal.io/sdk@v1.25.1/internal/protocol/util.go:39:40: cannot use msg.Body (variable of type *anypb.Any) as *types.Any value in argument to types.AnyMessageName\r\n# go.temporal.io/sdk/internal/common/metrics\r\n../../../../pkg/mod/go.temporal.io/sdk@v1.25.1/internal/common/metrics/grpc.go:120:44: cannot use s (variable of type *\"github.com/gogo/status\".Status) as *\"google.golang.org/grpc/internal/status\".Status value in argument to serviceerror.FromStatus\r\n```\r\n\r\nI think the problem is because, as part of the otel package upgrade, it also upgraded the `api` package from 1.24.0 -> 1.26.1. \r\n1.26.1 has a breaking change to switch from the deprecated gogo library to google/protobuf.\r\n\r\nSince we're still on the latest SDK release v1.25.1, it still uses `github.com/gogo/protobuf/types.AnyMessageName` which now has an incompatible parameter `google.golang.org/protobuf/types/known/anypb.Any`.\r\n\r\nDo you know how we can resolve this?","createdAt":"2024-02-02T23:32:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":8}}],"url":"https://github.com/temporalio/sdk-go/issues/1137#issuecomment-1924903522","viewerDidAuthor":false}],"createdAt":"2023-06-14T01:30:48Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDky","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1137,"reactionGroups":[],"state":"CLOSED","title":"Support OpenTelemetry Metrics","updatedAt":"2024-02-02T23:32:11Z","url":"https://github.com/temporalio/sdk-go/issues/1137"}
