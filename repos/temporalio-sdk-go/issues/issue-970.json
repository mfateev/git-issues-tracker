{"assignees":[{"id":"MDQ6VXNlcjIwNTA0MDQ5","login":"Quinn-With-Two-Ns","name":"Quinn Klassen","databaseId":0}],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"## Expected Behavior\r\n\r\nWhen a workflow's context is reset due to cache staleness, all mutable aspects should be reset to original values\r\n\r\n## Actual Behavior\r\n\r\nWhen a workflow's context is reset due to cache staleness, the mutated search attribute map remains (and I presume memo too)\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nThis sample program will cause a non-determinism error due to cache reset not working right. (there is another issue concerning workers sharing cache that I may open another issue for)\r\n\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"fmt\"\r\n\t\"log\"\r\n\t\"time\"\r\n\r\n\t\"github.com/google/uuid\"\r\n\t\"go.temporal.io/sdk/client\"\r\n\t\"go.temporal.io/sdk/worker\"\r\n\t\"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\nfunc main() {\r\n\tif err := run(); err != nil {\r\n\t\tlog.Fatal(err)\r\n\t}\r\n}\r\n\r\nfunc run() error {\r\n\tctx, cancel := context.WithCancel(context.Background())\r\n\tdefer cancel()\r\n\r\n\tlog.Printf(\"Creating client\")\r\n\tc, err := client.NewClient(client.Options{})\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"failed creating client: %w\", err)\r\n\t}\r\n\tdefer c.Close()\r\n\r\n\tlog.Printf(\"Starting worker1\")\r\n\ttaskQueue := uuid.NewString()\r\n\tworker1 := worker.New(c, taskQueue, worker.Options{})\r\n\tworker1.RegisterWorkflow(MyWorkflow)\r\n\tif err := worker1.Start(); err != nil {\r\n\t\treturn fmt.Errorf(\"failed starting worker client: %w\", err)\r\n\t}\r\n\r\n\tlog.Printf(\"Starting workflow\")\r\n\trun, err := c.ExecuteWorkflow(ctx, client.StartWorkflowOptions{TaskQueue: taskQueue}, MyWorkflow)\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"failed starting workflow: %w\", err)\r\n\t}\r\n\r\n\tlog.Printf(\"Sending signal in 2 seconds\")\r\n\ttime.Sleep(2 * time.Second)\r\n\tif err := c.SignalWorkflow(ctx, run.GetID(), run.GetRunID(), \"tick\", nil); err != nil {\r\n\t\treturn err\r\n\t}\r\n\r\n\tlog.Printf(\"Stopping worker1 and starting worker2\")\r\n\tworker1.Stop()\r\n\tworker2 := worker.New(c, taskQueue, worker.Options{})\r\n\tworker2.RegisterWorkflow(MyWorkflow)\r\n\tif err := worker2.Start(); err != nil {\r\n\t\treturn fmt.Errorf(\"failed starting worker client: %w\", err)\r\n\t}\r\n\tdefer worker2.Stop()\r\n\r\n\tlog.Printf(\"Sending signal in 2 seconds, then ending program in 10\")\r\n\ttime.Sleep(2 * time.Second)\r\n\tif err := c.SignalWorkflow(ctx, run.GetID(), run.GetRunID(), \"tick\", nil); err != nil {\r\n\t\treturn err\r\n\t}\r\n\ttime.Sleep(10 * time.Second)\r\n\treturn nil\r\n}\r\n\r\nfunc MyWorkflow(ctx workflow.Context) error {\r\n\t// Do one thing is a search attribute is there or add it if not\r\n\t_, exists := workflow.GetInfo(ctx).SearchAttributes.GetIndexedFields()[\"CustomTextField\"]\r\n\tlog.Printf(\"Search attribute exists? %v. Replaying? %v.\", exists, workflow.IsReplaying(ctx))\r\n\tvar err error\r\n\tif exists {\r\n\t\terr = workflow.Sleep(ctx, 100*time.Millisecond)\r\n\t} else {\r\n\t\terr = workflow.UpsertSearchAttributes(ctx, map[string]interface{}{\"CustomTextField\": \"some value\"})\r\n\t}\r\n\tif err != nil {\r\n\t\treturn err\r\n\t}\r\n\r\n\t// Now just wait for signals over and over\r\n\tsignalCh := workflow.GetSignalChannel(ctx, \"tick\")\r\n\tfor {\r\n\t\tsignalCh.Receive(ctx, nil)\r\n\t\tlog.Printf(\"Signal received (replaying? %v)\", workflow.IsReplaying(ctx))\r\n\t}\r\n}\r\n```","closedAt":"2022-12-07T00:12:12Z","comments":[{"id":"IC_kwDODN1w685PhBTt","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Can confirm `Memo` also has the same issue as `SearchAttributes`","createdAt":"2022-12-01T16:48:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/970#issuecomment-1334056173","viewerDidAuthor":false}],"createdAt":"2022-12-01T16:04:37Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDg2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":970,"reactionGroups":[],"state":"CLOSED","title":"Search attributes and memos are kept from previous runs when resetting workflow context","updatedAt":"2022-12-07T00:12:12Z","url":"https://github.com/temporalio/sdk-go/issues/970"}
