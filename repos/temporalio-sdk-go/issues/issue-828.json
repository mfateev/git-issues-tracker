{"assignees":[],"author":{"id":"MDQ6VXNlcjQ2NDY2NDAw","is_bot":false,"login":"grantfuhr","name":"Grant Fuhr"},"body":"## Expected Behavior\r\nWorkflows replayed on the same version of a worker should not panic.\r\n\r\n## Actual Behavior\r\nWhen replaying a workflow that contains a local activity called by an interceptor, the replay panics. This occurs when replaying on the same worker, or a copy of the worker on a different task queue. \r\n\r\n## Steps to Reproduce the Problem\r\n[Here is a gist](https://gist.github.com/grantfuhr/972db470d98763a59541968329b2e532) with a test case that demonstrates the error.\r\n\r\nSample error output from running the test:\r\n```\r\n2022/06/07 15:12:49 ERROR Workflow panic WorkflowType Greet WorkflowID ReplayId RunID 0dfd038d-a331-40e1-b0c2-a583785ab439 Attempt 1 Error lookup failed for scheduledEventID to activityID: scheduleEventID: 8, activityID: 8 StackTrace process event for hello_world [panic]:\r\ngo.temporal.io/sdk/internal.panicIllegalState(...)\r\n\t/Users/grant.fuhr/go/pkg/mod/go.temporal.io/sdk@v1.14.0/internal/internal_decision_state_machine.go:409\r\ngo.temporal.io/sdk/internal.(*commandsHelper).handleActivityTaskScheduled(0xc004304870, {0x7248e80, 0x1}, 0xc0035ccec0?)\r\n\t/Users/grant.fuhr/go/pkg/mod/go.temporal.io/sdk@v1.14.0/internal/internal_decision_state_machine.go:973 +0x109\r\ngo.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).ProcessEvent(0xc003874780, 0xc0021815c0, 0xf0?, 0x0)\r\n\t/Users/grant.fuhr/go/pkg/mod/go.temporal.io/sdk@v1.14.0/internal/internal_event_handlers.go:824 +0x27e\r\ngo.temporal.io/sdk/internal.(*workflowExecutionContextImpl).ProcessWorkflowTask(0xc00370a380, 0xc0035ad470)\r\n\t/Users/grant.fuhr/go/pkg/mod/go.temporal.io/sdk@v1.14.0/internal/internal_task_handlers.go:878 +0xca8\r\ngo.temporal.io/sdk/internal.(*workflowTaskHandlerImpl).ProcessWorkflowTask(0xc000e95760, 0xc0035ad470, 0x0)\r\n\t/Users/grant.fuhr/go/pkg/mod/go.temporal.io/sdk@v1.14.0/internal/internal_task_handlers.go:727 +0x485\r\ngo.temporal.io/sdk/internal.(*WorkflowReplayer).replayWorkflowHistory(0xc003874720, {0x62bba78, 0xc003874738}, {0x62cd4f8?, 0xc0040008c0}, {0x5e32369, 0xf}, 0xc002f13890)\r\n\t/Users/grant.fuhr/go/pkg/mod/go.temporal.io/sdk@v1.14.0/internal/internal_worker.go:1197 +0x64e\r\ngo.temporal.io/sdk/internal.(*WorkflowReplayer).ReplayWorkflowHistory(0xc00348fe60?, {0x0?, 0x0?}, 0x5e2160f?)\r\n\t/Users/grant.fuhr/go/pkg/mod/go.temporal.io/sdk@v1.14.0/internal/internal_worker.go:1080 +0x205\r\ngithub.com/DataDog/temporalite/temporaltest_test.TestReplayInterceptor(0xc0033564e0)\r\n\t/Users/grant.fuhr/open-source/temporalite/temporaltest/server_test.go:220 +0x876\r\ntesting.tRunner(0xc0033564e0, 0x5ef5f58)\r\n\t/usr/local/Cellar/go/1.18.2/libexec/src/testing/testing.go:1439 +0x102\r\ncreated by testing.(*T).Run\r\n\t/usr/local/Cellar/go/1.18.2/libexec/src/testing/testing.go:1486 +0x35f\r\n    server_test.go:222: lookup failed for scheduledEventID to activityID: scheduleEventID: 8, activityID: 8\r\n```\r\n\r\n## Specifications\r\n\r\n  - Go-SDK Version: 1.14.0\r\n  - Server Version: 1.16.2\r\n","closedAt":"2022-06-30T12:08:20Z","comments":[{"id":"IC_kwDODN1w685EiFPe","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks for the report! At first glance I agree, this should not error. I will investigate.","createdAt":"2022-06-08T11:17:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/828#issuecomment-1149785054","viewerDidAuthor":false},{"id":"IC_kwDODN1w685EiMiX","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Ok, I believe I see the problem here. The replayer does not run interceptors. I will add `worker.WorkflowReplayer.SetWorkerInterceptors([]WorkerInterceptor)` which should be fairly easy.","createdAt":"2022-06-08T11:51:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":4}}],"url":"https://github.com/temporalio/sdk-go/issues/828#issuecomment-1149814935","viewerDidAuthor":false},{"id":"IC_kwDODN1w685E7R5E","author":{"login":"Lercher"},"authorAssociation":"NONE","body":"I'm getting apparently the same panic with Go SDK 1.14.1. The ambient situation is different from the original report. I can't reconstruct it properly from the logs, but I guess some workflow instance was re-hydrated from scratch (i.e. from the recorded events) in a plain worker process. However, I can't guarantee that the (interpreted) workflow code is indeed identical to the original one which created the event stream.\r\n\r\n```log\r\n2022/06/14 16:44:36 ERROR Workflow panic \r\nNamespace default \r\nTaskQueue fse \r\nWorkerID 4644@some-server@ \r\nWorkflowType TRU-vt100-inmietsetzung@v100 \r\nWorkflowID TRU-vt100-inmietsetzung.VTVertrag.7CVT01UDO4FGHU291MKNKNF5TKAS39 \r\nRunID d7dd6ea4-b974-40f5-b192-e9eb634bb4cf \r\nAttempt 1 \r\nError lookup failed for scheduledEventID to activityID: scheduleEventID: 29, activityID: 29 StackTrace process event for fse [panic]:\r\n\r\ngo.temporal.io/sdk/internal.panicIllegalState(...)\r\n        go.temporal.io/sdk@v1.14.1-0.20220322131744-55cf584de5c7/internal/internal_decision_state_machine.go:409\r\ngo.temporal.io/sdk/internal.(*commandsHelper).handleActivityTaskScheduled(0xc00008e140, {0xc000719778, 0x2}, 0x0?)\r\n        go.temporal.io/sdk@v1.14.1-0.20220322131744-55cf584de5c7/internal/internal_decision_state_machine.go:973 +0x109\r\ngo.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).ProcessEvent(0xc0003cc4b0, 0xc0002fb740, 0xd8?, 0x0)\r\n        go.temporal.io/sdk@v1.14.1-0.20220322131744-55cf584de5c7/internal/internal_event_handlers.go:824 +0x27e\r\ngo.temporal.io/sdk/internal.(*workflowExecutionContextImpl).ProcessWorkflowTask(0xc0002589a0, 0xc00018d380)\r\n        go.temporal.io/sdk@v1.14.1-0.20220322131744-55cf584de5c7/internal/internal_task_handlers.go:878 +0xca8\r\ngo.temporal.io/sdk/internal.(*workflowTaskHandlerImpl).ProcessWorkflowTask(0xc0005b6000, 0xc00018d380, 0xc00018dcb0)\r\n        go.temporal.io/sdk@v1.14.1-0.20220322131744-55cf584de5c7/internal/internal_task_handlers.go:727 +0x485\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).processWorkflowTask(0xc0005b00d0, 0xc00018d380)\r\n        go.temporal.io/sdk@v1.14.1-0.20220322131744-55cf584de5c7/internal/internal_task_pollers.go:284 +0x2cd\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).ProcessTask(0xc0005b00d0, {0xddb860?, 0xc00018d380?})\r\n        go.temporal.io/sdk@v1.14.1-0.20220322131744-55cf584de5c7/internal/internal_task_pollers.go:255 +0x6c\r\ngo.temporal.io/sdk/internal.(*baseWorker).processTask(0xc0000d6140, {0xddb420?,0xc0000b9e90})\r\n        go.temporal.io/sdk@v1.14.1-0.20220322131744-55cf584de5c7/internal/internal_worker_base.go:398 +0x167\r\ncreated by go.temporal.io/sdk/internal.(*baseWorker).runTaskDispatcher\r\n        go.temporal.io/sdk@v1.14.1-0.20220322131744-55cf584de5c7/internal/internal_worker_base.go:302 +0xb5\r\n\r\n2022/06/14 16:44:36 WARN  Failed to process workflow task. Namespace default TaskQueue fse WorkerID 4644@some-server@ WorkflowType TRU-vt100-inmietsetzung@v100 WorkflowID TRU-vt100-inmietsetzung.VTVertrag.7CVT01UDO4FGHU291MKNKNF5TKAS39 RunID d7dd6ea4-b974-40f5-b192-e9eb634bb4cf Attempt 1 Error lookup failed for scheduledEventID to activityID: scheduleEventID: 29, activityID: 29\r\n2022/06/14 16:44:36 INFO  Task processing failed with error Namespace default TaskQueue fse WorkerID 4644@some-server@ WorkerType WorkflowWorker Error Workflow executionsRow not found.  WorkflowId: fse, RunId: 34ba3ca7-4886-4157-aabe-65e2f3366761\r\n```\r\n\r\n(slightly formatted for better readability)\r\n\r\nSorry @cretz, I don't understand your last comment: Is it something I can investigate/change myself or is it about some possible SDK or temporal-server change? Regarding missing interceptors in the _replayer_: does such a change also affect re-hydration of ordinary workflow execution state or only the replays for tests and debugging?\r\n\r\nThanks, Martin.\r\n\r\nPS: looking at the gist above, interceptors seem to be some user extensibility points as they are added to the options struct. I'm pretty sure that my worker code won't add such interceptors.","createdAt":"2022-06-15T12:08:49Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/828#issuecomment-1156390468","viewerDidAuthor":false},{"id":"IC_kwDODN1w685E7aHf","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"The error you received commonly occurs if you have non-determinism. See https://community.temporal.io/t/go-sdk-troubleshooting. This issue just happens to share that same stack trace because it appears non-deterministic due to a replayer issue.","createdAt":"2022-06-15T12:43:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/828#issuecomment-1156424159","viewerDidAuthor":false},{"id":"IC_kwDODN1w685E8UeC","author":{"login":"Lercher"},"authorAssociation":"NONE","body":"> The error you received commonly occurs if you have non-determinism.\r\n\r\nYes, I see: It's indeed the best explanation as we are working on implementations currently. I just was distracted by the nearly identical stack trace and no one mentioning non-determinism in this ticket. Sorry, my bad, and thank you very much.\r\n","createdAt":"2022-06-15T16:08:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/828#issuecomment-1156663170","viewerDidAuthor":false}],"createdAt":"2022-06-07T19:16:49Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":828,"reactionGroups":[],"state":"CLOSED","title":"Replay of Local Activities Executed by an Interceptor","updatedAt":"2022-06-30T12:08:20Z","url":"https://github.com/temporalio/sdk-go/issues/828"}
