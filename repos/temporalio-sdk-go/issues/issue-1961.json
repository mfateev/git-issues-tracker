{"assignees":[],"author":{"id":"MDQ6VXNlcjI0MzU0NTY4","is_bot":false,"login":"josvegit","name":"Johan Svedlund Nordstr√∂m"},"body":"## Expected Behavior\n\nshould not get the illegalContext error\n\n\n## Actual Behavior\n```\nRunning tool: /opt/homebrew/bin/go test -timeout 30s -run ^Test_Subscription_Workflow_Tests$ -testify.m ^(Test_ExampleWorkflow)$ example.com -timeout=5m\n\n2025/05/29 11:13:56 INFO  Received activation signal\n2025/05/29 11:13:56 INFO  ExecuteChildWorkflow WorkflowType ActivationWorkflow\n2025/05/29 11:13:56 INFO  Activation workflow started\n2025/05/29 11:13:56 DEBUG Auto fire timer TimerID 0 TimerDuration 1s TimeSkipped 1s\n2025/05/29 11:13:56 INFO  Received activation signal\n2025/05/29 11:13:56 INFO  ExecuteChildWorkflow WorkflowType ActivationWorkflow\n--- FAIL: Test_Subscription_Workflow_Tests (0.00s)\n    --- FAIL: Test_Subscription_Workflow_Tests/Test_ExampleWorkflow (0.00s)\n        /Users/johansvedlundnordstrom/dev/reproduce/workflow_testsuite.go:1236: FAIL:\tDummyActivity(string,workflows.DummyActivityInput)\n            \t\tat: [/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/workflow_testsuite.go:414 /Users/johansvedlundnordstrom/dev/reproduce/some_test.go:110]\n        /Users/johansvedlundnordstrom/dev/reproduce/workflow_testsuite.go:1236: FAIL: 0 out of 1 expectation(s) were met.\n            \tThe code you are testing needs to make 1 more call(s).\n            \tat: [/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/workflow_testsuite.go:1236 /Users/johansvedlundnordstrom/dev/reproduce/some_test.go:27 /Users/johansvedlundnordstrom/go/pkg/mod/github.com/stretchr/testify@v1.10.0/suite/suite.go:180 /opt/homebrew/Cellar/go/1.24.1/libexec/src/runtime/panic.go:792 /Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow.go:782 /Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/workflow.go:1490 /Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow.go:1029 /Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/context.go:336 /Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/context.go:206 /Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow.go:593 /Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow_testsuite.go:2288 /Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow_testsuite.go:2921 /Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow_testsuite.go:896 /Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow_testsuite.go:836 /Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow_testsuite.go:626 /Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow_testsuite.go:570 /Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/workflow_testsuite.go:832 /Users/johansvedlundnordstrom/dev/reproduce/some_test.go:119]\n        /Users/johansvedlundnordstrom/dev/reproduce/internal_workflow.go:782: test panicked: getState: illegal access from outside of workflow context\n            goroutine 36 [running]:\n            runtime/debug.Stack()\n            \t/opt/homebrew/Cellar/go/1.24.1/libexec/src/runtime/debug/stack.go:26 +0x64\n            github.com/stretchr/testify/suite.failOnPanic(0x1400047c540, {0x104d33640, 0x104f15540})\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/github.com/stretchr/testify@v1.10.0/suite/suite.go:89 +0x38\n            github.com/stretchr/testify/suite.Run.func1.1()\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/github.com/stretchr/testify@v1.10.0/suite/suite.go:188 +0x22c\n            panic({0x104d33640?, 0x104f15540?})\n            \t/opt/homebrew/Cellar/go/1.24.1/libexec/src/runtime/panic.go:792 +0x124\n            go.temporal.io/sdk/internal.assertNotInReadOnlyStateCancellation({0x104f23af0?, 0x140000a2060?})\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow.go:782 +0xa4\n            go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).NewTimerWithOptions.func2({0x1400007c018?, 0x104a6fdd8?}, 0xb8?)\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/workflow.go:1490 +0x44\n            go.temporal.io/sdk/internal.(*channelImpl).Close(0x140001141c0?)\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow.go:1029 +0xb4\n            go.temporal.io/sdk/internal.(*cancelCtx).cancel(0x14000114180, 0x1, {0x104f18580, 0x1400035d470})\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/context.go:336 +0xb0\n            go.temporal.io/sdk/internal.WithCancel.func1()\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/context.go:206 +0x34\n            go.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func2()\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow.go:593 +0x28\n            go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).RequestCancelExternalWorkflow(0x14000146008, {0x104b6e6fd, 0x16}, {0x14000152000, 0x15}, {0x14000130060, 0x1b}, 0x1400000c180)\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow_testsuite.go:2288 +0x2c8\n            go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).RequestCancelExternalWorkflow.(*testWorkflowEnvironmentImpl).cancelWorkflow.(*testWorkflowEnvironmentImpl).cancelWorkflowByID.func4()\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow_testsuite.go:2921 +0x40\n            go.temporal.io/sdk/internal.(*testCallbackHandle).processCallback(0x140000e7448)\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow_testsuite.go:896 +0xc4\n            go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).startMainLoop(0x14000291188)\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow_testsuite.go:836 +0x110\n            go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeWorkflowInternal(0x14000291188, 0x0, {0x1050e298c, 0xe}, 0x0)\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow_testsuite.go:626 +0x3a8\n            go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeWorkflow(0x14000291188, {0x104d4f880, 0x104f10748}, {0x0, 0x0, 0x0})\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/internal_workflow_testsuite.go:570 +0x118\n            go.temporal.io/sdk/internal.(*TestWorkflowEnvironment).ExecuteWorkflow(0x14000409960?, {0x104d4f880?, 0x104f10748?}, {0x0?, 0x2?, 0x2?})\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/go.temporal.io/sdk@v1.34.0/internal/workflow_testsuite.go:832 +0xb8\n            example%2ecom.(*WorkflowTestSuite).Test_ExampleWorkflow(0x140002b05a0)\n            \t/Users/johansvedlundnordstrom/dev/reproduce/some_test.go:119 +0x194\n            reflect.Value.call({0x14000444800?, 0x1400018f328?, 0x14000471001?}, {0x104b5e4cd, 0x4}, {0x1400018af20, 0x1, 0x104714b44?})\n            \t/opt/homebrew/Cellar/go/1.24.1/libexec/src/reflect/value.go:584 +0x978\n            reflect.Value.Call({0x14000444800?, 0x1400018f328?, 0x66a?}, {0x1400018af20?, 0x105375c88?, 0x105578e40?})\n            \t/opt/homebrew/Cellar/go/1.24.1/libexec/src/reflect/value.go:368 +0x94\n            github.com/stretchr/testify/suite.Run.func1(0x1400047c540)\n            \t/Users/johansvedlundnordstrom/go/pkg/mod/github.com/stretchr/testify@v1.10.0/suite/suite.go:202 +0x394\n            testing.tRunner(0x1400047c540, 0x140002b06c0)\n            \t/opt/homebrew/Cellar/go/1.24.1/libexec/src/testing/testing.go:1792 +0xe4\n            created by testing.(*T).Run in goroutine 35\n            \t/opt/homebrew/Cellar/go/1.24.1/libexec/src/testing/testing.go:1851 +0x374\nFAIL\nexit status 1\nFAIL\texample.com\t0.208s\n```\n\n\n## Steps to Reproduce the Problem\n\nrun the following test\n\n```\npackage workflows\n\nimport (\n\t\"context\"\n\t\"errors\"\n\t\"testing\"\n\t\"time\"\n\n\t\"github.com/stretchr/testify/mock\"\n\t\"github.com/stretchr/testify/suite\"\n\t\"go.temporal.io/sdk/testsuite\"\n\t\"go.temporal.io/sdk/workflow\"\n)\n\ntype WorkflowTestSuite struct {\n\tsuite.Suite\n\ttestsuite.WorkflowTestSuite\n\n\ttestEnv *testsuite.TestWorkflowEnvironment\n}\n\nfunc (s *WorkflowTestSuite) SetupTest() {\n\ts.testEnv = s.NewTestWorkflowEnvironment()\n}\n\nfunc (s *WorkflowTestSuite) AfterTest(suiteName, testName string) {\n\ts.testEnv.AssertExpectations(s.T())\n}\n\nfunc Test_Subscription_Workflow_Tests(t *testing.T) {\n\tsuite.Run(t, new(WorkflowTestSuite))\n}\n\nfunc MyCoolWorkflow(ctx workflow.Context) error {\n\tselector := workflow.NewSelector(ctx)\n\tvar activationWorkflow *workflow.Execution\n\tselector.AddReceive(workflow.GetSignalChannel(ctx, \"activate\"), func(c workflow.ReceiveChannel, more bool) {\n\t\tc.Receive(ctx, nil)\n\t\tworkflow.GetLogger(ctx).Info(\"Received activation signal\")\n\t\tif activationWorkflow != nil {\n\t\t\tworkflow.RequestCancelExternalWorkflow(ctx, activationWorkflow.ID, activationWorkflow.RunID)\n\t\t}\n\n\t\tcwf := workflow.ExecuteChildWorkflow(\n\t\t\tctx,\n\t\t\tActivationWorkflow,\n\t\t)\n\n\t\tvar res workflow.Execution\n\t\tif err := cwf.GetChildWorkflowExecution().Get(ctx, &res); err != nil {\n\t\t\tworkflow.GetLogger(ctx).Error(\"Failed to start child workflow\", \"error\", err)\n\t\t\treturn\n\t\t}\n\t\tactivationWorkflow = &res\n\n\t\tselector.AddFuture(cwf, func(f workflow.Future) {\n\t\t\tif err := f.Get(ctx, nil); err != nil {\n\t\t\t\tworkflow.GetLogger(ctx).Error(\"Child workflow failed\", \"error\", err)\n\t\t\t} else {\n\t\t\t\tworkflow.GetLogger(ctx).Info(\"Child workflow completed successfully\")\n\t\t\t}\n\t\t\tactivationWorkflow = nil\n\t\t})\n\t})\n\n\tfor selector.HasPending() || activationWorkflow != nil {\n\t\tselector.Select(ctx)\n\t}\n\treturn nil\n}\n\ntype DummyActivityInput struct{}\n\nfunc DummyActivity(ctx context.Context, d DummyActivityInput) error {\n\treturn nil\n}\n\nfunc ActivationWorkflow(ctx workflow.Context) error {\n\tctx = workflow.WithActivityOptions(ctx, workflow.ActivityOptions{\n\t\tStartToCloseTimeout: time.Minute,\n\t})\n\tworkflow.GetLogger(ctx).Info(\"Activation workflow started\")\n\tif err := workflow.Sleep(ctx, time.Hour); err != nil {\n\t\tworkflow.GetLogger(ctx).Error(\"Activation workflow failed\", \"error\", err)\n\t\treturn err\n\t}\n\tworkflow.GetLogger(ctx).Info(\"Activation workflow completed\")\n\n\tvar err error\n\tif errors.Is(ctx.Err(), workflow.ErrCanceled) {\n\t\tnewCtx, _ := workflow.NewDisconnectedContext(ctx)\n\t\terr = workflow.ExecuteActivity(newCtx, DummyActivity, DummyActivityInput{}).Get(newCtx, nil)\n\t\tworkflow.GetLogger(ctx).Info(\"Activation workflow canceled, running dummy activity in disconnected context\")\n\t} else {\n\t\terr = workflow.ExecuteActivity(ctx, DummyActivity, DummyActivityInput{}).Get(ctx, nil)\n\t}\n\n\treturn err\n}\n\nfunc (s *WorkflowTestSuite) Test_ExampleWorkflow() {\n\ts.testEnv.OnActivity(DummyActivity, mock.Anything, DummyActivityInput{}).Return(nil).Once()\n\ts.testEnv.RegisterWorkflow(ActivationWorkflow)\n\n\ts.testEnv.RegisterDelayedCallback(func() {\n\t\ts.testEnv.SignalWorkflow(\"activate\", nil)\n\t}, 0)\n\ts.testEnv.RegisterDelayedCallback(func() {\n\t\ts.testEnv.SignalWorkflow(\"activate\", nil)\n\t}, time.Second)\n\ts.testEnv.ExecuteWorkflow(MyCoolWorkflow)\n\ts.NoError(s.testEnv.GetWorkflowError())\n\ts.testEnv.IsWorkflowCompleted()\n}\n\n```\n\n\n\n\n## Specifications\n\nrunning on Mac silicon but it does not really matter where you run it\n","closedAt":null,"comments":[{"id":"IC_kwDODN1w686uQR3B","author":{"login":"yuandrew"},"authorAssociation":"MEMBER","body":"Thanks for the bug report! Looks like there's an issue with the test environment propagating `ctx` from inside the `selector.AddReceive`","createdAt":"2025-05-30T21:09:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1961#issuecomment-2923503041","viewerDidAuthor":false},{"id":"IC_kwDODN1w687Jp4ae","author":{"login":"josvegit"},"authorAssociation":"NONE","body":"I think this is still an issue","createdAt":"2025-10-08T20:51:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1961#issuecomment-3383199390","viewerDidAuthor":false},{"id":"IC_kwDODN1w687J2Xdw","author":{"login":"yuandrew"},"authorAssociation":"MEMBER","body":"Yes, I unfortunately haven't been able to prioritize this issue, hoping I can get to it soon","createdAt":"2025-10-09T16:02:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1961#issuecomment-3386472304","viewerDidAuthor":false}],"createdAt":"2025-05-29T09:24:37Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDg2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1961,"reactionGroups":[],"state":"OPEN","title":"Getting a strange error when writing tests which does not occur in real temporal deployment","updatedAt":"2025-10-09T16:02:34Z","url":"https://github.com/temporalio/sdk-go/issues/1961"}
