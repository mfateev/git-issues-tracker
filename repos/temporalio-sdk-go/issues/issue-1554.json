{"assignees":[],"author":{"id":"MDQ6VXNlcjQ0Njc3MDI0","is_bot":false,"login":"vl4deee11","name":"vl4deee11"},"body":"## Expected Behavior\r\n\r\n No NonDeterministicError \r\n\r\n## Actual Behavior\r\n\r\n NonDeterministicError\r\n\r\n\r\nI have a workflow that works great and at the end of the workflow there is a timer that does a simple thing, look at the code below:\r\n\r\n```\r\nfunc CourierWorkflow(ctx workflow.Context, order *models.Order) error {\r\n\twg := workflow.NewWaitGroup(ctx)\r\n\r\n\t// ....\r\n\tvar statusUpdatedChan = workflow.NewChannel(ctx)\r\n\terr = workflow.SetUpdateHandler(ctx, StatusUpdateHandler, onStatusUpdate(ctx, order, wg, statusUpdatedChan))\r\n\tif err != nil {\r\n\t\tlogger.Error(\"SetUpdateHandler failed\", \"Error\", err)\r\n\t\treturn err\r\n\t}\r\n\r\n\t// ....\r\n\r\n\tselector.AddReceive(statusUpdatedChan, func(c workflow.ReceiveChannel, _ bool) { c.Receive(ctx, &err) })\r\n\r\n\tdoneTimeFuture := workflow.NewTimer(ctx, 48*time.Hour)\r\n\tselector.AddFuture(doneTimeFuture, func(_ workflow.Future) {\r\n\t\torder.Status = models.StatusDone\r\n\t})\r\n\r\n\tfor {\r\n\t\tselector.Select(ctx)\r\n\t\tif order.Status == models.StatusDone {\r\n\t\t\tbreak\r\n\t\t}\r\n\t\t// another actions\r\n\t}\r\n}\r\n\r\nfunc onStatusUpdate(ctx workflow.Context, order *models.Order, wg workflow.WaitGroup, statusUpdatedChan workflow.Channel) func(ctx workflow.Context, signal models.OrderSignal) (*models.Order, error) {\r\n\tlogger := workflow.GetLogger(ctx)\r\n\treturn func(ctx workflow.Context, signal models.OrderSignal) (*models.Order, error) {\r\n\t\tlogger.Info(\"onStatusUpdate: got new update\", \"Status\", signal.Status, \"PrevStatus\", order.Status)\r\n\t\torderStatus := order.Status\r\n\t\tswitch orderStatus {\r\n\t\t//... update order data\r\n\t\tdefault:\r\n\t\t\treturn order, nil\r\n\t\t}\r\n\r\n\t\tstatusUpdatedChan.Send(ctx, afterStatusUpdate(ctx, order, wg, nil))\r\n\t\treturn order, nil\r\n\t}\r\n}\r\n\r\nfunc afterStatusUpdate(ctx workflow.Context, order *models.Order, wg workflow.WaitGroup, canceledStatus *models.Status) error {\r\n\tswitch order.Status {\r\n\tcase models.StatusAtVendor, models.StatusInDelivery, models.StatusAtClient, models.StatusDelivered:\r\n\t\t// -> PANIC HERE, code works from 2023 with no problem\r\n\t\terr := activities.FinishCourierStepForOrderExecute(ctx, order)\r\n\t\tif err != nil {\r\n\t\t\treturn err\r\n\t\t}\r\n\tcase models.StatusCanceled:\r\n\t\tactivities.SkipCourierStepsForOrderExecute(ctx, order)\r\n\t}\r\n\treturn nil\r\n}\r\n```\r\n\r\n\r\nAnd with this timer, everything is fine in 99.9% of cases, but sometimes a non-determinism error crashes, and the replays go normal on the same workflow on which the non-determinism error occurs\r\n\r\nReplay works great, no problem with workflows\r\n\r\nStack trace:\r\n\r\n```\r\nprocess event for courier [panic]:\r\ngo.temporal.io/sdk/internal.panicIllegalState(...)\r\n\t/go/src/git.uzum.io/foodtech/develop/operations/logistics-orders/vendor/go.temporal.io/sdk/internal/internal_command_state_machine.go:455\r\ngo.temporal.io/sdk/internal.(*commandsHelper).handleActivityTaskScheduled(0xc009dfc3c0, {0xc00d45cbfc, 0x3}, 0x0?)\r\n\t/go/src/git.uzum.io/foodtech/develop/operations/logistics-orders/vendor/go.temporal.io/sdk/internal/internal_command_state_machine.go:1038 +0x109\r\ngo.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).ProcessEvent(0xc00cf42d98, 0xc00de35400, 0x0?, 0x0)\r\n\t/go/src/git.uzum.io/foodtech/develop/operations/logistics-orders/vendor/go.temporal.io/sdk/internal/internal_event_handlers.go:1031 +0x24a\r\ngo.temporal.io/sdk/internal.(*workflowExecutionContextImpl).ProcessWorkflowTask(0xc0098de900, 0xc00b29f170)\r\n\t/go/src/git.uzum.io/foodtech/develop/operations/logistics-orders/vendor/go.temporal.io/sdk/internal/internal_task_handlers.go:960 +0x11bf\r\ngo.temporal.io/sdk/internal.(*workflowTaskHandlerImpl).ProcessWorkflowTask(0xc000166340, 0xc00b29f170, 0xc006727740)\r\n\t/go/src/git.uzum.io/foodtech/develop/operations/logistics-orders/vendor/go.temporal.io/sdk/internal/internal_task_handlers.go:778 +0x4f6\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).processWorkflowTask(0xc000984400, 0xc00b29f170)\r\n\t/go/src/git.uzum.io/foodtech/develop/operations/logistics-orders/vendor/go.temporal.io/sdk/internal/internal_task_pollers.go:329 +0x2dd\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).ProcessTask(0xc000984400, {0x157ff00?, 0xc00b29f170})\r\n\t/go/src/git.uzum.io/foodtech/develop/operations/logistics-orders/vendor/go.temporal.io/sdk/internal/internal_task_pollers.go:302 +0x6c\r\ngo.temporal.io/sdk/internal.(*baseWorker).processTask(0xc0001ba280, {0x157fa80?, 0xc0081f2330})\r\n\t/go/src/git.uzum.io/foodtech/develop/operations/logistics-orders/vendor/go.temporal.io/sdk/internal/internal_worker_base.go:440 +0x167\r\ncreated by go.temporal.io/sdk/internal.(*baseWorker).runTaskDispatcher\r\n\t/go/src/git.uzum.io/foodtech/develop/operations/logistics-orders/vendor/go.temporal.io/sdk/internal/internal_worker_base.go:334 +0xb5\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1.  -\r\n\r\n## Specifications\r\n\r\n  - Version: \r\n```\r\n\r\n        go.temporal.io/api v1.19.1-0.20230322213042-07fb271d475b\r\n\tgo.temporal.io/sdk v1.22.1\r\n\tgo.temporal.io/sdk/contrib/tally v0.2.0\r\n\r\n ```\r\n  - Platform: temporal 1.22.1\r\n\r\n\r\n","closedAt":"2024-09-01T23:36:21Z","comments":[{"id":"IC_kwDODN1w686Ff8lU","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Can you try downloading the history for these failing workflows and testing with the replayer and see if the error reproduces?\r\n\r\nhttps://docs.temporal.io/develop/go/testing-suite#replay\r\n\r\nI also notice you using `SetUpdateHandler`  on a vey old SDK and an older Server release, Workflow Update is an experimental feature and numerous bug fixes and API changes have been made since that release so it is possible it is related to workflow update and upgrading would fix it.","createdAt":"2024-07-19T17:42:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1554#issuecomment-2239744340","viewerDidAuthor":false},{"id":"IC_kwDODN1w686Fm8iI","author":{"login":"vl4deee11"},"authorAssociation":"NONE","body":"@Quinn-With-Two-Ns Hello, as I wrote earlier, the replay is successful, without errors, and the only version that I can update the sdk to is 1.24.1. `SetUpdateHandler` I took from the documentation here https://docs.temporal.io/develop/go/message-passing#handle-update","createdAt":"2024-07-21T11:42:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1554#issuecomment-2241579144","viewerDidAuthor":false},{"id":"IC_kwDODN1w686F5MAo","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"The latest Go SDK is [v1.28.1](https://github.com/temporalio/sdk-go/releases/tag/v1.28.1) there are multiple bugs on fixed on the Server and SDK that could cause this behaviour your seeing. I would recommend upgrading your SDK and Server to the latest stable release.","createdAt":"2024-07-23T21:37:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1554#issuecomment-2246361128","viewerDidAuthor":false},{"id":"IC_kwDODN1w686F7Bm_","author":{"login":"vl4deee11"},"authorAssociation":"NONE","body":"I found one bug in sdk in version 1.24.1, now I will fix it at the level of my code, because it is very difficult to update the sdk and the temporal version in the prod, given that the latest updates did not go very smoothly\r\n\r\n","createdAt":"2024-07-24T04:28:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1554#issuecomment-2246842815","viewerDidAuthor":false}],"createdAt":"2024-07-19T09:15:48Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"},{"id":"LA_kwDODN1w687UGgkJ","name":"external dependency","description":"Waiting on something externally","color":"c5def5"}],"milestone":null,"number":1554,"reactionGroups":[],"state":"CLOSED","title":"Unknown NonDeterministicError","updatedAt":"2024-09-01T23:36:21Z","url":"https://github.com/temporalio/sdk-go/issues/1554"}
