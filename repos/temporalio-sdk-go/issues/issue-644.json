{"assignees":[],"author":{"id":"MDQ6VXNlcjU3Nzg3Mjg=","is_bot":false,"login":"nolotz","name":"Noah-Jerome Lotzer"},"body":"## Expected Behavior\r\nNo panic\r\n\r\n## Actual Behavior\r\nIf the intermediate workflow has a clean-up activity combined with a child workflow, it panics when root workflow gets canceled.\r\n\r\n```\r\n2021/11/21 20:05:05 ERROR Workflow panic Namespace default TaskQueue default WorkerID 1@6789789c47-xddcp@ WorkflowType MiddleWorkflow WorkflowID 19e5df4c-20ee-4800-818e-71a068512770_5 RunID d977d17c-4916-47f2-8460-d6fc18c28be9 Attempt 1 Error lookup failed for scheduledEventID to activityID: scheduleEventID: 15, activityID: 14 StackTrace process event for default [panic]:\r\ngo.temporal.io/sdk/internal.panicIllegalState(...)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.11.1/internal/internal_decision_state_machine.go:395\r\ngo.temporal.io/sdk/internal.(*commandsHelper).handleActivityTaskScheduled(0xc0005983c0, {0xc00065ca28, 0x2}, 0x45b7954)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.11.1/internal/internal_decision_state_machine.go:925 +0x10a\r\ngo.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).ProcessEvent(0xc0005b0318, 0xc00039bf40, 0xf8, 0x0)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.11.1/internal/internal_event_handlers.go:816 +0x279\r\ngo.temporal.io/sdk/internal.(*workflowExecutionContextImpl).ProcessWorkflowTask(0xc0003c61c0, 0xc000760960)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.11.1/internal/internal_task_handlers.go:878 +0xccd\r\ngo.temporal.io/sdk/internal.(*workflowTaskHandlerImpl).ProcessWorkflowTask(0xc00071c0c0, 0xc000760960, 0xc0009302d0)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.11.1/internal/internal_task_handlers.go:729 +0x493\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).processWorkflowTask(0xc0000a9520, 0xc000760960)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.11.1/internal/internal_task_pollers.go:286 +0x2cd\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).ProcessTask(0xc0000a9520, {0xfd7b00, 0xc000760960})\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.11.1/internal/internal_task_pollers.go:257 +0x6c\r\ngo.temporal.io/sdk/internal.(*baseWorker).processTask(0xc0003ae0f0, {0xfd76c0, 0xc0003dbbd0})\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.11.1/internal/internal_worker_base.go:343 +0xdd\r\ncreated by go.temporal.io/sdk/internal.(*baseWorker).runTaskDispatcher\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.11.1/internal/internal_worker_base.go:270 +0xba\r\n2021/11/21 20:05:05 WARN  Failed to process workflow task. Namespace default TaskQueue default WorkerID 1@6789789c47-xddcp@ WorkflowType MiddleWorkflow WorkflowID 19e5df4c-20ee-4800-818e-71a068512770_5 RunID d977d17c-4916-47f2-8460-d6fc18c28be9 Attempt 1 Error lookup failed for scheduledEventID to activityID: scheduleEventID: 15, activityID: 14\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n```\r\nfunc RootWorkflow(ctx workflow.Context) error {\r\n  info := workflow.GetInfo(ctx)\r\n\r\n  ctx = workflow.WithChildOptions(ctx, workflow.ChildWorkflowOptions{\r\n    TaskQueue:           info.TaskQueueName,\r\n    WaitForCancellation: true,\r\n    ParentClosePolicy:   enums.PARENT_CLOSE_POLICY_REQUEST_CANCEL,\r\n  })\r\n\r\n  err := workflow.ExecuteChildWorkflow(ctx, \"IntermediateWorkflow\").\r\n    GetChildWorkflowExecution().\r\n    Get(ctx, nil)\r\n  if err != nil {\r\n    return err\r\n  }\r\n\r\n  err = workflow.Sleep(ctx, time.Second * 30)\r\n  if err != nil {\r\n    return err\r\n  }\r\n\r\n  return errors.New(\"error\")\r\n}\r\n\r\nfunc IntermediateWorkflow(ctx workflow.Context) error {\r\n  info := workflow.GetInfo(ctx)\r\n  ctx = workflow.WithActivityOptions(ctx, workflow.ActivityOptions{\r\n    TaskQueue:           info.TaskQueueName,\r\n    StartToCloseTimeout: time.Second * 20,\r\n  })\r\n  ctx = workflow.WithChildOptions(ctx, workflow.ChildWorkflowOptions{\r\n    TaskQueue:           info.TaskQueueName,\r\n    WaitForCancellation: true,\r\n    ParentClosePolicy: enums.PARENT_CLOSE_POLICY_REQUEST_CANCEL,\r\n  })\r\n  cronWorkflow := workflow.ExecuteChildWorkflow(ctx, CRONWorkflow)\r\n\r\n  defer func() {\r\n    ctx, _ := workflow.NewDisconnectedContext(ctx)\r\n    _ = workflow.ExecuteActivity(ctx, MiddleCleanUpActivity).Get(ctx, nil)\r\n  }()\r\n\r\n  var (\r\n    err error\r\n  )\r\n\r\n  selector := workflow.NewSelector(ctx)\r\n  selector.AddReceive(ctx.Done(), func(c workflow.ReceiveChannel, more bool) {\r\n    c.Receive(ctx, nil)\r\n    err = ctx.Err()\r\n  })\r\n  selector.AddFuture(cronWorkflow, func(f workflow.Future) {\r\n    err = f.Get(ctx, nil)\r\n  })\r\n  selector.Select(ctx)\r\n\r\n  return err\r\n}\r\n\r\nfunc CRONWorkflow(ctx workflow.Context) error {\r\n  err := workflow.Sleep(ctx, time.Hour * 5)\r\n  if err != nil {\r\n    return err\r\n  }\r\n\r\n  return workflow.NewContinueAsNewError(ctx, CRONWorkflow)\r\n}\r\n\r\nfunc MiddleCleanUpActivity(ctx context.Context) error {\r\n  return nil\r\n}\r\n```\r\n\r\n\r\n## Specifications\r\n\r\n  - Version: 1.11.1\r\n  - Platform: 1.13.1\r\n","closedAt":"2021-12-02T17:39:27Z","comments":[{"id":"IC_kwDODN1w6846Ja3B","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thank you very much for the code to replicate! I am investigating immediately.","createdAt":"2021-11-22T13:53:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/644#issuecomment-975547841","viewerDidAuthor":false},{"id":"IC_kwDODN1w6846Jk30","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I have replicated and confirmed that this was not introduced as a regression in any recent version (happens at least back through `v1.5.0`). I am doing more research into a fix.","createdAt":"2021-11-22T14:33:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/644#issuecomment-975588852","viewerDidAuthor":false},{"id":"IC_kwDODN1w6846JyAP","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"A smaller replication:\r\n\r\n```go\r\nfunc Workflow(ctx workflow.Context) error {\r\n\t// Start child but ignore future result\r\n\tworkflow.ExecuteChildWorkflow(ctx, workflow.Sleep, 5*time.Hour)\r\n\r\n\t// Receive from done channel\r\n\t// XXX: This is important, waiting for child future or anything else does not trigger this\r\n\tctx.Done().Receive(ctx, nil)\r\n\r\n\t// Run after-cancel activity\r\n\tctx, _ = workflow.NewDisconnectedContext(ctx)\r\n\tctx = workflow.WithActivityOptions(ctx, workflow.ActivityOptions{StartToCloseTimeout: 5 * time.Minute})\r\n\treturn workflow.ExecuteActivity(ctx, DoNothing).Get(ctx, nil)\r\n}\r\n\r\nfunc DoNothing(context.Context) error { return nil }\r\n```","createdAt":"2021-11-22T15:28:46Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/644#issuecomment-975642639","viewerDidAuthor":false}],"createdAt":"2021-11-21T20:19:11Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":644,"reactionGroups":[],"state":"CLOSED","title":"Workflow panics after cancellation with clean up activity and child workflow","updatedAt":"2021-12-02T17:39:27Z","url":"https://github.com/temporalio/sdk-go/issues/644"}
