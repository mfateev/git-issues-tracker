{"assignees":[],"author":{"id":"MDQ6VXNlcjQzMjEwMA==","is_bot":false,"login":"recht","name":"Joakim Recht"},"body":"**Is your feature request related to a problem? Please describe.**\r\n\r\nCurrently, when sending a query to a workflow that is in running state but not active on any worker, a worker will receive the request, replay history, process the query, and forget everything again. On next query the same thing happens. This is in contrast to starting the workflow from scratch without restarting the worker. Then the workflow is in the worker cache, ready to serve queries. Same if the worker has restarted, but workflow state has changed so that the workflow got loaded into the cache.\r\n\r\nBecause replays can get a bit expensive, especially if encryption/offloading codecs are used (which we do), it would be nice if querying a workflow would add it to the worker sticky cache.\r\n\r\n**Describe the solution you'd like**\r\nA config property that allows us to specify that workflows that are queried should also be inserted into the cache.\r\n\r\nWhile debugging locally I did this:\r\n```\r\ndiff --git a/internal/internal_task_handlers.go b/internal/internal_task_handlers.go\r\nindex 8312587..342f7f4 100644\r\n--- a/internal/internal_task_handlers.go\r\n+++ b/internal/internal_task_handlers.go\r\n@@ -812,7 +812,7 @@ func (wth *workflowTaskHandlerImpl) GetOrCreateWorkflowContext(\r\n                        return\r\n                }\r\n \r\n-               if wth.cache.MaxWorkflowCacheSize() > 0 && task.Query == nil {\r\n+               if wth.cache.MaxWorkflowCacheSize() > 0 {\r\n                        workflowContext, _ = wth.cache.putWorkflowContext(runID, workflowContext)\r\n                        workflowContext.Lock()\r\n                        workflowContext.cached = true\r\n```\r\n\r\nIt's unclear if that's the right solution or if that has other unintended consequences, but at least it keeps the workflow in the sticky worker cache, making queries much faster.\r\n\r\n**Describe alternatives you've considered**\r\nDoing less queries, or faster codecs. Regardless, it seems wasteful to have to replay on every single query.\r\n","closedAt":null,"comments":[{"id":"IC_kwDODN1w686UXCep","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"I believe this is a limitation on the server. Query only tasks cannot set the sticky cache attribute so the worker cache would not actually be used even if the SDK did keep it in cache. There is an [issue](https://github.com/temporalio/temporal/issues/4463) to add this feature on the server side, once this is closed the SDK could keep the workflow in cache.","createdAt":"2024-11-20T16:36:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1716#issuecomment-2489067433","viewerDidAuthor":false},{"id":"IC_kwDODN1w686UX02O","author":{"login":"recht"},"authorAssociation":"CONTRIBUTOR","body":"Ok, thanks - so I guess the only reason why it made any difference for me was that I was only running a single worker so queries always went to that worker?","createdAt":"2024-11-20T18:23:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1716#issuecomment-2489273742","viewerDidAuthor":false},{"id":"IC_kwDODN1w686Vt9-t","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"There are multiple ways a query can be delivered to a workflow, if the worker was already in the cache it will be used. The problem is direct queries cannot add the workflow to the sticky task queue so the server would always send the whole history down again causing a replay.","createdAt":"2024-12-02T15:30:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1716#issuecomment-2511855533","viewerDidAuthor":false},{"id":"IC_kwDODN1w686Vy8Cx","author":{"login":"recht"},"authorAssociation":"CONTRIBUTOR","body":"Ok, but with the change I tried there was no replay after the first query - it's possible that the worker receives all the data, but it doesn't actually replay (checked by adding print statements in the workflow code and observing with and without the change)","createdAt":"2024-12-02T23:02:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1716#issuecomment-2513158321","viewerDidAuthor":false}],"createdAt":"2024-11-19T22:15:46Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDky","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1716,"reactionGroups":[],"state":"OPEN","title":"Make it possible to keep workflows in worker cache also if they're only queried","updatedAt":"2024-12-02T23:02:04Z","url":"https://github.com/temporalio/sdk-go/issues/1716"}
