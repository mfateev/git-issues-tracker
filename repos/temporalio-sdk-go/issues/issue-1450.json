{"assignees":[],"author":{"id":"MDQ6VXNlcjMyMDk4MTU=","is_bot":false,"login":"wsny","name":"William Snyders"},"body":"## Expected Behavior\r\nShould not receive errors about metrics being registered incorrectly.\r\n\r\n## Actual Behavior\r\nReceiving a Prometheus error about the workflow_task_execution_failed metric being registered with different labels.\r\n\r\n```\r\na previously registered descriptor with the same fully-qualified name as Desc{fqName: \"temporal_workflow_task_execution_failed_total\", help: \"temporal_workflow_task_execution_failed_total counter\", constLabels: {}, variableLabels: {app,client_name,namespace,environment,workflow_type,failure_reason,task_queue,worker_type,deployment,activity_type,env}} has different label names or a different help string\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nI am still working on STR's (don't know how to break all the below with test code yet), but I can see that this metric is being used with different tags in different places.\r\n\r\n#1295 added a tag here\r\nhttps://github.com/temporalio/sdk-go/blob/69bc6c3a19cdb21d5252c3ad4a490109b9a2f39c/internal/internal_task_pollers.go#L421\r\n\r\nBut it is not being added in these uses of the metric.\r\nhttps://github.com/temporalio/sdk-go/blob/69bc6c3a19cdb21d5252c3ad4a490109b9a2f39c/internal/internal_event_handlers.go#L1108\r\nhttps://github.com/temporalio/sdk-go/blob/69bc6c3a19cdb21d5252c3ad4a490109b9a2f39c/internal/internal_event_handlers.go#L1298\r\n\r\nAnd that will cause issues with Prometheus, as shown in this example.\r\n\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"fmt\"\r\n\t\"time\"\r\n\r\n\t\"github.com/prometheus/client_golang/prometheus\"\r\n\t\"github.com/uber-go/tally/v4\"\r\n\ttallyprom \"github.com/uber-go/tally/v4/prometheus\"\r\n\r\n\t\"go.temporal.io/sdk/client\"\r\n\tsdktally \"go.temporal.io/sdk/contrib/tally\"\r\n)\r\n\r\nfunc main() {\r\n\tmetricsHandler := setupPrometheus()\r\n\t// These lines in any order will cause an error where the metrics have different labels\r\n\tmetricsHandler.Counter(\"testing\").Inc(1)\r\n\tmetricsHandler.WithTags(map[string]string{\"someName\": \"someValue\"}).Counter(\"testing\").Inc(1)\r\n}\r\n\r\n// Just setup stuff for Prometheus below here\r\nvar PrometheusSanitizeOptions = tally.SanitizeOptions{\r\n\tNameCharacters:       tally.ValidCharacters{Ranges: tally.AlphanumericRange, Characters: []rune{'_'}},\r\n\tKeyCharacters:        tally.ValidCharacters{Ranges: tally.AlphanumericRange, Characters: []rune{'_'}},\r\n\tValueCharacters:      tally.ValidCharacters{Ranges: tally.AlphanumericRange, Characters: []rune{'_'}},\r\n\tReplacementCharacter: tally.DefaultReplacementCharacter,\r\n}\r\n\r\nfunc setupPrometheus() client.MetricsHandler {\r\n\tcfg := tallyprom.Configuration{\r\n\t\tListenAddress: \"localhost:9090\",\r\n\t}\r\n\treporter, _ := cfg.NewReporter(tallyprom.ConfigurationOptions{\r\n\t\tRegistry: prometheus.NewRegistry(),\r\n\t\tOnError: func(err error) {\r\n\t\t\tfmt.Printf(\"BOOM: %+v\\n\", err)\r\n\t\t},\r\n\t})\r\n\tscopeOpts := tally.ScopeOptions{CachedReporter: reporter, SanitizeOptions: &PrometheusSanitizeOptions}\r\n\tscope, _ := tally.NewRootScope(scopeOpts, time.Second)\r\n\tscope = sdktally.NewPrometheusNamingScope(scope)\r\n\treturn sdktally.NewMetricsHandler(scope)\r\n}\r\n```\r\n\r\nWhich causes this error\r\n```\r\na previously registered descriptor with the same fully-qualified name as Desc{fqName: \"testing_total\", help: \"testing_total counter\", constLabels: {}, variableLabels: {someName}} has different label names or a different help string\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: sdk-go@v1.26.1\r\n","closedAt":"2024-10-04T20:33:01Z","comments":[{"id":"IC_kwDODN1w6857zgYY","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":":+1: We should ideally only be recording this metric in one place and it should always contain the same tag/label set. Thanks for reporting! This is on our backlog and we will see about fixing.","createdAt":"2024-04-25T12:46:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":5}}],"url":"https://github.com/temporalio/sdk-go/issues/1450#issuecomment-2077099544","viewerDidAuthor":false},{"id":"IC_kwDODN1w686PfXfp","author":{"login":"AmirSoleimani"},"authorAssociation":"NONE","body":"I noticed that the issue has been closed and addressed. I've been facing the same issue and the merged changes addressed it (I had to pull the master branch to test). However, I haven't seen a new release with the fix yet. Can you provide any updates on when the fix might be included in a release? Thank you for your help! - cc @yuandrew ","createdAt":"2024-10-11T12:59:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1450#issuecomment-2407364585","viewerDidAuthor":false},{"id":"IC_kwDODN1w686Q1PMu","author":{"login":"yuandrew"},"authorAssociation":"MEMBER","body":"Hey Amir, sorry for the delay, there are a few more changes we are hoping to get into the next release, I am hoping we can cut a new release in the next 2 weeks!","createdAt":"2024-10-22T17:37:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1450#issuecomment-2429874990","viewerDidAuthor":false},{"id":"IC_kwDODN1w686RvKPN","author":{"login":"yuandrew"},"authorAssociation":"MEMBER","body":"v1.30.0 has just been released","createdAt":"2024-10-29T18:38:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1450#issuecomment-2445059021","viewerDidAuthor":false}],"createdAt":"2024-04-25T03:19:40Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1450,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"Metric `workflow_task_execution_failed` is used with different sets of labels causing errors with Prometheus","updatedAt":"2024-10-29T18:38:37Z","url":"https://github.com/temporalio/sdk-go/issues/1450"}
