{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNTA0MDQ5","is_bot":false,"login":"Quinn-With-Two-Ns","name":"Quinn Klassen"},"body":"## Expected Behavior\r\nEvicting a workflow from cache does not cause a race condition in the SDK\r\n\r\n## Actual Behavior\r\nEvicting a workflow from cache does causes a race condition in the SDK\r\n\r\n\r\n## Steps to Reproduce the Problem\r\nTo reproduce run add this workflow and a test to run it to `test` in the Go SDK\r\n```\r\nfunc (w *Workflows) ReproduceRace(ctx workflow.Context) error {\r\n\tre := func(ctx workflow.Context) {\r\n\t\tfmt.Printf(\"Goroutine running \\n\")\r\n\t\tctx, _ = workflow.NewDisconnectedContext(ctx)\r\n\t\tchildCtx, childCancel := workflow.WithCancel(ctx)\r\n\t\tchildCtx = workflow.WithChildOptions(childCtx, workflow.ChildWorkflowOptions{WaitForCancellation: true})\r\n\t\tchild := workflow.ExecuteChildWorkflow(childCtx, w.SleepForDuration, 10*time.Minute)\r\n\t\tif err := child.GetChildWorkflowExecution().Get(ctx, nil); err != nil {\r\n\t\t\tpanic(err)\r\n\t\t}\r\n\r\n\t\tdefer func() {\r\n\t\t\tfmt.Printf(\"Goroutine defer \\n\")\r\n\t\t\ttime.Sleep(time.Second)\r\n\t\t\tchildCancel()\r\n\t\t}()\r\n\r\n\t\tworkflow.Sleep(ctx, time.Hour)\r\n\t\tfmt.Printf(\"!!!! Ran passed sleep, this is unexpected \\n\")\r\n\t}\r\n\r\n\tfor i := 0; i < 10; i++ {\r\n\t\tfmt.Printf(\"Launching goroutine: %d \\n\", i)\r\n\t\tworkflow.Go(ctx, re)\r\n\t}\r\n\tfmt.Printf(\"Workflow sleeping \\n\")\r\n\tworkflow.Sleep(ctx, 5*time.Second)\r\n\tfmt.Printf(\"Workflow returning \\n\")\r\n\treturn nil\r\n}\r\n```\r\nand run with race detector on like\r\n`go test --race  -run TestIntegrationSuite -testify.m TestConcurrentMapWriteWorkflow`\r\n\r\nThis will trigger a race condition in the SDK, the exact races change between runs, but here is one\r\n```\r\nWARNING: DATA RACE\r\nRead at 0x00c0003fe6f0 by goroutine 65:\r\n  runtime.mapaccess1()\r\n      /opt/homebrew/Cellar/go/1.21.0/libexec/src/runtime/map.go:396 +0x26c\r\n  go.temporal.io/sdk/internal.(*commandsHelper).getCommand()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_command_state_machine.go:919 +0x54\r\n  go.temporal.io/sdk/internal.(*commandsHelper).requestCancelExternalWorkflowExecution()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_command_state_machine.go:1202 +0x70\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentImpl).RequestCancelChildWorkflow()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_event_handlers.go:372 +0x8c\r\n  go.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).RequestCancelChildWorkflow()\r\n      <autogenerated>:1 +0x20\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteChildWorkflow.func2.1()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/workflow.go:956 +0x158\r\n  go.temporal.io/sdk/internal.(*channelImpl).Close()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:901 +0x114\r\n  go.temporal.io/sdk/internal.(*cancelCtx).cancel()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/context.go:333 +0xdc\r\n  go.temporal.io/sdk/internal.WithCancel.func1()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/context.go:196 +0x4c\r\n  go.temporal.io/sdk/test_test.(*Workflows).ReproduceRace.func1.1()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/test/workflow_test.go:835 +0x78\r\n  runtime.deferCallSave()\r\n      /opt/homebrew/Cellar/go/1.21.0/libexec/src/runtime/panic.go:798 +0x8c\r\n  go.temporal.io/sdk/internal.(*coroutineState).initialYield()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:928 +0xa0\r\n  go.temporal.io/sdk/internal.(*coroutineState).yield()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:937 +0x378\r\n  go.temporal.io/sdk/internal.(*channelImpl).Receive()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:729 +0x2dc\r\n  go.temporal.io/sdk/internal.(*futureImpl).Get()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:321 +0x74\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).Sleep()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/workflow.go:1153 +0x58\r\n  go.temporal.io/sdk/internal.(*WorkflowOutboundInterceptorBase).Sleep()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/interceptor_base.go:258 +0x64\r\n  go.temporal.io/sdk/test_test.(*tracingWorkflowOutboundInterceptor).Sleep()\r\n      <autogenerated>:1 +0x20\r\n  go.temporal.io/sdk/internal.Sleep()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/workflow.go:1148 +0x90\r\n  go.temporal.io/sdk/workflow.Sleep()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/workflow/deterministic_wrappers.go:174 +0x208\r\n  go.temporal.io/sdk/test_test.(*Workflows).ReproduceRace.func1()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/test/workflow_test.go:842 +0x1f0\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine.func1()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:1040 +0xf0\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine.func2()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:1041 +0x44\r\n\r\nPrevious write at 0x00c0003fe6f0 by goroutine 61:\r\n  runtime.mapaccessK()\r\n      /opt/homebrew/Cellar/go/1.21.0/libexec/src/runtime/map.go:519 +0x1ec\r\n  go.temporal.io/sdk/internal.(*commandsHelper).moveCommandToBack()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_command_state_machine.go:963 +0x5bc\r\n  go.temporal.io/sdk/internal.(*childWorkflowCommandStateMachine).cancel()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_command_state_machine.go:711 +0xb0\r\n  go.temporal.io/sdk/internal.(*commandsHelper).requestCancelExternalWorkflowExecution()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_command_state_machine.go:1203 +0x84\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentImpl).RequestCancelChildWorkflow()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_event_handlers.go:372 +0x8c\r\n  go.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).RequestCancelChildWorkflow()\r\n      <autogenerated>:1 +0x20\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteChildWorkflow.func2.1()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/workflow.go:956 +0x158\r\n  go.temporal.io/sdk/internal.(*channelImpl).Close()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:901 +0x114\r\n  go.temporal.io/sdk/internal.(*cancelCtx).cancel()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/context.go:333 +0xdc\r\n  go.temporal.io/sdk/internal.WithCancel.func1()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/context.go:196 +0x4c\r\n  go.temporal.io/sdk/test_test.(*Workflows).ReproduceRace.func1.1()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/test/workflow_test.go:835 +0x78\r\n  runtime.deferCallSave()\r\n      /opt/homebrew/Cellar/go/1.21.0/libexec/src/runtime/panic.go:798 +0x8c\r\n  go.temporal.io/sdk/internal.(*coroutineState).initialYield()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:928 +0xa0\r\n  go.temporal.io/sdk/internal.(*coroutineState).yield()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:937 +0x378\r\n  go.temporal.io/sdk/internal.(*channelImpl).Receive()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:729 +0x2dc\r\n  go.temporal.io/sdk/internal.(*futureImpl).Get()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:321 +0x74\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).Sleep()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/workflow.go:1153 +0x58\r\n  go.temporal.io/sdk/internal.(*WorkflowOutboundInterceptorBase).Sleep()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/interceptor_base.go:258 +0x64\r\n  go.temporal.io/sdk/test_test.(*tracingWorkflowOutboundInterceptor).Sleep()\r\n      <autogenerated>:1 +0x20\r\n  go.temporal.io/sdk/internal.Sleep()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/workflow.go:1148 +0x90\r\n  go.temporal.io/sdk/workflow.Sleep()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/workflow/deterministic_wrappers.go:174 +0x208\r\n  go.temporal.io/sdk/test_test.(*Workflows).ReproduceRace.func1()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/test/workflow_test.go:842 +0x1f0\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine.func1()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:1040 +0xf0\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine.func2()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:1041 +0x44\r\n\r\nGoroutine 65 (running) created at:\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:1031 +0x578\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).Go()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:308 +0x70\r\n  go.temporal.io/sdk/test_test.(*tracingWorkflowOutboundInterceptor).Go()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/test/integration_test.go:4090 +0x19c\r\n  go.temporal.io/sdk/internal.Go()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/workflow.go:450 +0x98\r\n  go.temporal.io/sdk/workflow.Go()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/workflow/deterministic_wrappers.go:138 +0x188\r\n  go.temporal.io/sdk/test_test.(*Workflows).ReproduceRace()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/test/workflow_test.go:848 +0x178\r\n  go.temporal.io/sdk/test_test.(*Workflows).ReproduceRace-fm()\r\n      <autogenerated>:1 +0x44\r\n  runtime.call16()\r\n      /opt/homebrew/Cellar/go/1.21.0/libexec/src/runtime/asm_arm64.s:478 +0x74\r\n  reflect.Value.Call()\r\n      /opt/homebrew/Cellar/go/1.21.0/libexec/src/reflect/value.go:380 +0x90\r\n  go.temporal.io/sdk/internal.executeFunction()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_worker.go:1797 +0x34c\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteWorkflow()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/workflow.go:530 +0x1fc\r\n  go.temporal.io/sdk/internal.(*WorkflowInboundInterceptorBase).ExecuteWorkflow()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/interceptor_base.go:154 +0x64\r\n  go.temporal.io/sdk/test_test.(*signalWorkflowInboundInterceptor).ExecuteWorkflow()\r\n      <autogenerated>:1 +0x20\r\n  go.temporal.io/sdk/test_test.(*tracingWorkflowInboundInterceptor).ExecuteWorkflow()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/test/integration_test.go:4133 +0x158\r\n  go.temporal.io/sdk/internal.(*workflowExecutor).Execute()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_worker.go:805 +0x370\r\n  go.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func1()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:512 +0x150\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine.func1()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:1040 +0xf0\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine.func2()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:1041 +0x44\r\n\r\nGoroutine 61 (finished) created at:\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:1031 +0x578\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).Go()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:308 +0x70\r\n  go.temporal.io/sdk/test_test.(*tracingWorkflowOutboundInterceptor).Go()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/test/integration_test.go:4090 +0x19c\r\n  go.temporal.io/sdk/internal.Go()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/workflow.go:450 +0x98\r\n  go.temporal.io/sdk/workflow.Go()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/workflow/deterministic_wrappers.go:138 +0x188\r\n  go.temporal.io/sdk/test_test.(*Workflows).ReproduceRace()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/test/workflow_test.go:848 +0x178\r\n  go.temporal.io/sdk/test_test.(*Workflows).ReproduceRace-fm()\r\n      <autogenerated>:1 +0x44\r\n  runtime.call16()\r\n      /opt/homebrew/Cellar/go/1.21.0/libexec/src/runtime/asm_arm64.s:478 +0x74\r\n  reflect.Value.Call()\r\n      /opt/homebrew/Cellar/go/1.21.0/libexec/src/reflect/value.go:380 +0x90\r\n  go.temporal.io/sdk/internal.executeFunction()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_worker.go:1797 +0x34c\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteWorkflow()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/workflow.go:530 +0x1fc\r\n  go.temporal.io/sdk/internal.(*WorkflowInboundInterceptorBase).ExecuteWorkflow()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/interceptor_base.go:154 +0x64\r\n  go.temporal.io/sdk/test_test.(*signalWorkflowInboundInterceptor).ExecuteWorkflow()\r\n      <autogenerated>:1 +0x20\r\n  go.temporal.io/sdk/test_test.(*tracingWorkflowInboundInterceptor).ExecuteWorkflow()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/test/integration_test.go:4133 +0x158\r\n  go.temporal.io/sdk/internal.(*workflowExecutor).Execute()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_worker.go:805 +0x370\r\n  go.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func1()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:512 +0x150\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine.func1()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:1040 +0xf0\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine.func2()\r\n      /Users/quinnklassen/Documents/Code/sdk-go/internal/internal_workflow.go:1041 +0x44\r\n==================\r\n```\r\n\r\nI believe the reason for these races is how we clean up a cached workflow when we evict it from the cache (In this case we are evicting when the workflow is completed) \r\n\r\nWhen we evict a workflow from the cache we call `runtime.Goexit()` [from each Go routine the workflow launched](https://github.com/temporalio/sdk-go/blob/master/internal/internal_workflow.go#L1006). Calling `runtime.Goexit()` terminates those Go routines, but also calls their respective defers. Since we clean up all the workflows Go routines in [a loop](https://github.com/temporalio/sdk-go/blob/master/internal/internal_workflow.go#L1142), and don't do any synchronization between them, we are running all their defers in parallel. If more than one of those defers does something that generates a command there is a race on multiple data structure in the SDK state machine. I'll note note every command that would normally generate a command will generate a command in this case because the `dispatcherImpl` is no longer running a lot of those function like `ExecuteActivity` will panic. Canceling a child workflow is not one of those cases.\r\n\r\n","closedAt":"2023-08-29T13:52:32Z","comments":[{"id":"IC_kwDODN1w685k3Mse","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Possibly the root cause of these bugs https://github.com/temporalio/sdk-go/issues/743, https://github.com/temporalio/sdk-go/issues/1190","createdAt":"2023-08-24T18:14:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1209#issuecomment-1692191518","viewerDidAuthor":false}],"createdAt":"2023-08-24T18:13:11Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1209,"reactionGroups":[],"state":"CLOSED","title":"Race condition when evicting a workflow from cache","updatedAt":"2023-08-29T13:52:32Z","url":"https://github.com/temporalio/sdk-go/issues/1209"}
