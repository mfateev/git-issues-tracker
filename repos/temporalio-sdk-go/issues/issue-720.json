{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"## Expected Behavior\r\n\r\nCancellation inside a workflow of coroutines should not do racy things.\r\n\r\n## Actual Behavior\r\n\r\nHere are some data races in master as of this writing:\r\n\r\n<details>\r\n<summary>Data race 1</summary>\r\n\r\n```\r\nWARNING: DATA RACE\r\nWrite at 0x00c000236868 by goroutine 11:\r\n  go.temporal.io/sdk/internal.(*cancelCtx).cancel()\r\n      /path/to/temporal-sdk-go/internal/context.go:316 +0xa4\r\n  go.temporal.io/sdk/internal.WithCancel.func1()\r\n      /path/to/temporal-sdk-go/internal/context.go:195 +0x4f\r\n  go.temporal.io/sdk/internal.MyTest1.func1.1.1()\r\n      /path/to/temporal-sdk-go/internal/internal_coroutines_test.go:1393 +0x56\r\n  runtime.deferCallSave()\r\n      /path/to/Go/src/runtime/panic.go:950 +0x81\r\n  go.temporal.io/sdk/internal.(*coroutineState).initialYield()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:860 +0xa8\r\n  go.temporal.io/sdk/internal.(*coroutineState).yield()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:869 +0x3e4\r\n  go.temporal.io/sdk/internal.(*channelImpl).Receive()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:684 +0x331\r\n  go.temporal.io/sdk/internal.(*futureImpl).Get()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:310 +0x9d\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).Sleep()\r\n      /path/to/temporal-sdk-go/internal/workflow.go:976 +0x5e\r\n  go.temporal.io/sdk/internal.Sleep()\r\n      /path/to/temporal-sdk-go/internal/workflow.go:971 +0x88\r\n  go.temporal.io/sdk/internal.MyTest1.func1.1()\r\n      /path/to/temporal-sdk-go/internal/internal_coroutines_test.go:1396 +0x11a\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine.func1()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:971 +0x17e\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine·dwrap·33()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:972 +0x47\r\n\r\nPrevious read at 0x00c000236868 by goroutine 10:\r\n  go.temporal.io/sdk/internal.propagateCancel()\r\n      /path/to/temporal-sdk-go/internal/context.go:226 +0x11c\r\n  go.temporal.io/sdk/internal.WithCancel()\r\n      /path/to/temporal-sdk-go/internal/context.go:194 +0x144\r\n  go.temporal.io/sdk/internal.MyTest1.func1.1.1()\r\n      /path/to/temporal-sdk-go/internal/internal_coroutines_test.go:1392 +0x47\r\n  runtime.deferCallSave()\r\n      /path/to/Go/src/runtime/panic.go:950 +0x81\r\n  go.temporal.io/sdk/internal.(*coroutineState).initialYield()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:860 +0xa8\r\n  go.temporal.io/sdk/internal.(*coroutineState).yield()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:869 +0x3e4\r\n  go.temporal.io/sdk/internal.(*channelImpl).Receive()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:684 +0x331\r\n  go.temporal.io/sdk/internal.(*futureImpl).Get()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:310 +0x9d\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).Sleep()\r\n      /path/to/temporal-sdk-go/internal/workflow.go:976 +0x5e\r\n  go.temporal.io/sdk/internal.Sleep()\r\n      /path/to/temporal-sdk-go/internal/workflow.go:971 +0x88\r\n  go.temporal.io/sdk/internal.MyTest1.func1.1()\r\n      /path/to/temporal-sdk-go/internal/internal_coroutines_test.go:1396 +0x11a\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine.func1()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:971 +0x17e\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine·dwrap·33()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:972 +0x47\r\n```\r\n</details>\r\n\r\n<details>\r\n<summary>Data race 2</summary>\r\n\r\n```\r\nWARNING: DATA RACE\r\nRead at 0x00c000234868 by goroutine 11:\r\n  go.temporal.io/sdk/internal.(*cancelCtx).cancel()\r\n      /path/to/temporal-sdk-go/internal/context.go:313 +0x84\r\n  go.temporal.io/sdk/internal.WithCancel.func1()\r\n      /path/to/temporal-sdk-go/internal/context.go:195 +0x4f\r\n  runtime.deferCallSave()\r\n      /path/to/Go/src/runtime/panic.go:950 +0x81\r\n  go.temporal.io/sdk/internal.(*coroutineState).initialYield()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:860 +0xa8\r\n  go.temporal.io/sdk/internal.(*coroutineState).yield()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:869 +0x3e4\r\n  go.temporal.io/sdk/internal.(*channelImpl).Receive()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:684 +0x331\r\n  go.temporal.io/sdk/internal.(*futureImpl).Get()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:310 +0x9d\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).Sleep()\r\n      /path/to/temporal-sdk-go/internal/workflow.go:976 +0x5e\r\n  go.temporal.io/sdk/internal.Sleep()\r\n      /path/to/temporal-sdk-go/internal/workflow.go:971 +0x88\r\n  go.temporal.io/sdk/internal.MyTest2.func1.1()\r\n      /path/to/temporal-sdk-go/internal/internal_coroutines_test.go:1418 +0x79\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine.func1()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:971 +0x17e\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine·dwrap·33()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:972 +0x47\r\n\r\nPrevious write at 0x00c000234868 by goroutine 14:\r\n  go.temporal.io/sdk/internal.(*cancelCtx).cancel()\r\n      /path/to/temporal-sdk-go/internal/context.go:316 +0xa4\r\n  go.temporal.io/sdk/internal.WithCancel.func1()\r\n      /path/to/temporal-sdk-go/internal/context.go:195 +0x4f\r\n  runtime.deferCallSave()\r\n      /path/to/Go/src/runtime/panic.go:950 +0x81\r\n  go.temporal.io/sdk/internal.(*coroutineState).initialYield()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:860 +0xa8\r\n  go.temporal.io/sdk/internal.(*coroutineState).yield()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:869 +0x3e4\r\n  go.temporal.io/sdk/internal.(*channelImpl).Receive()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:684 +0x331\r\n  go.temporal.io/sdk/internal.(*futureImpl).Get()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:310 +0x9d\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).Sleep()\r\n      /path/to/temporal-sdk-go/internal/workflow.go:976 +0x5e\r\n  go.temporal.io/sdk/internal.Sleep()\r\n      /path/to/temporal-sdk-go/internal/workflow.go:971 +0x88\r\n  go.temporal.io/sdk/internal.MyTest2.func1.1()\r\n      /path/to/temporal-sdk-go/internal/internal_coroutines_test.go:1418 +0x79\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine.func1()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:971 +0x17e\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine·dwrap·33()\r\n      /path/to/temporal-sdk-go/internal/internal_workflow.go:972 +0x47\r\n```\r\n</details>\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nWill add tests to PR.","closedAt":"2022-02-09T20:30:03Z","comments":[],"createdAt":"2022-02-09T16:09:03Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":720,"reactionGroups":[],"state":"CLOSED","title":"Coroutine/context cancellation race conditions","updatedAt":"2022-02-09T20:30:03Z","url":"https://github.com/temporalio/sdk-go/issues/720"}
