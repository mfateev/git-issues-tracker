{"assignees":[],"author":{"id":"MDQ6VXNlcjE0NjM2MjI=","is_bot":false,"login":"mfateev","name":"Maxim Fateev"},"body":"## Expected Behavior\r\n`Channel.ReceiveAsync` should be able to receive all pending messages in a Channel.\r\n\r\n## Actual Behavior\r\n1. A goroutine blocked on `Channel.Receive` and then a message is sent to the channel. \r\n2. `Channel.ReceiveAsync` from a different goroutine will not receive the message.\r\n\r\nThis behavior is problematic as we say that draining all signal messages through `Channel.ReceiveAsync` before completing a workflow is enough to ensure that there is no signal loss.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nThis problem manifests itself when the goroutine that is blocked on `Channel.Receive` doesn't get a chance to wake up. This happens when a workflow task fails with UNHANDLED_COMMAND due to a new signal received during the workflow task that tried to complete the workflow.\r\n\r\n## Notes\r\n\r\nI believe that fix to this issue might be backward incompatible as it potentially can change the order of execution of goroutines. The probability of this affecting any workflow is very low, but it should be considered.\r\n","closedAt":"2023-02-23T02:03:39Z","comments":[{"id":"IC_kwDODN1w685VmbPz","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"I'm able to reproduce the problem when using a Selector to receive the signal. So the Selector has the same issue.","createdAt":"2023-02-19T23:56:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1048#issuecomment-1436136435","viewerDidAuthor":true},{"id":"IC_kwDODN1w685VmdkO","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"I see two solutions:\r\n1. AsyncReceive always takes precedence\r\n2. A main workflow goroutine has the lowest precedence. This is the path all other SDKs took.","createdAt":"2023-02-20T00:22:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1048#issuecomment-1436145934","viewerDidAuthor":true},{"id":"IC_kwDODN1w685VrPFh","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"We are adding the ability for internal SDK patches https://github.com/temporalio/api/pull/259 this could be a candidate.\r\n\r\nCan you post an example workflow that causes this? I am not able to replicate the signal getting dropped. ","createdAt":"2023-02-20T18:14:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1048#issuecomment-1437397345","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Vvaf2","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Not understanding this issue exactly but haven't done a deep read on the reproduction (I may have to make a more simplified reproduction). If a user has `Receive` and `ReceiveAsync` I would think there are no guarantees which will win (even if the winner is deterministic). If a user has a non-primary coroutine that they need to ensure finishes before primary coroutine completion (e.g. one with a `Receive`), they are required to make that assurance in code.","createdAt":"2023-02-21T13:28:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1048#issuecomment-1438492662","viewerDidAuthor":false},{"id":"IC_kwDODN1w685V5eNH","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"After thinking about this I kind of agree that requiring the clean goroutine exit is the way to go. Closing the issue.","createdAt":"2023-02-23T02:03:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1048#issuecomment-1441129287","viewerDidAuthor":true}],"createdAt":"2023-02-19T22:15:06Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1048,"reactionGroups":[],"state":"CLOSED","title":"Channel.Receive consumes message before goroutine is woken up","updatedAt":"2023-02-23T02:03:39Z","url":"https://github.com/temporalio/sdk-go/issues/1048"}
