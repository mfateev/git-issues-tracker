{"assignees":[],"author":{"id":"MDQ6VXNlcjI2NTg0NDc4","is_bot":false,"login":"albertteoh","name":"Albert"},"body":"## Expected Behavior\r\n\r\nWorkflow activities to be child spans of the workflow that's executing them.\r\n\r\n## Actual Behavior\r\n\r\nFrom this screenshot, the \"FulfillmentWorkflow\" is the workflow that executes the list of activities that you see as \"root\" spans below it (prefixed with `StartActivity` and `RunActivity`).\r\n\r\nMaybe this is expected behaviour given it's executed asynchronously?\r\n\r\n<img width=\"1337\" alt=\"temporal-trace\" src=\"https://github.com/temporalio/sdk-go/assets/26584478/a6dd1b83-69a3-45bb-b5dd-20ad18246b22\">\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nUse the opentelemetry interceptor:\r\n\r\n```go\r\nimport (\r\n        // ...\r\n        \"go.temporal.io/sdk/contrib/opentelemetry\"\r\n)\r\n\r\nfunc New(...) {\r\n\tintceptor, err := opentelemetry.NewTracingInterceptor(opentelemetry.TracerOptions{\r\n\t\tTextMapPropagator: otel.GetTextMapPropagator(),\r\n\t})\r\n\tif err != nil {\r\n\t\treturn nil, fmt.Errorf(\"creating tracing interceptor: %w\", err)\r\n\t}\r\n\r\n\ttlogger := zapAdapter{logger}\r\n\tc, err := client.Dial(client.Options{\r\n                 // ...\r\n\t\tInterceptors:      []interceptor.ClientInterceptor{intceptor},\r\n\t})\r\n\tif err != nil {\r\n\t\tlogger.Fatalf(\"unable to create client: %s\", err)\r\n\t}\r\n// ...\r\n}\r\n```\r\n\r\nThen the workflow is executed like so:\r\n```go\r\n\tworkflowOptions := temporal.StartWorkflowOptions{\r\n\t\tID:        id,\r\n\t\tTaskQueue: taskQueue,\r\n\t}\r\n\tif _, err := m.client.ExecuteWorkflow(\r\n\t\tctx,\r\n\t\tworkflowOptions,\r\n\t\tFulfillmentWorkflow,\r\n\t\t// input args\r\n\t); err != nil {\r\n\t\treturn fmt.Errorf(\"unable to execute workflow, error: %w\", err)\r\n\t}\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version:\r\n```\r\n\tgo.opentelemetry.io/otel/sdk v1.16.0\r\n\tgo.temporal.io/api v1.23.0\r\n\tgo.temporal.io/sdk v1.23.1\r\n\tgo.temporal.io/sdk/contrib/opentelemetry v0.2.0\r\n```\r\n","closedAt":"2024-02-13T08:03:36Z","comments":[{"id":"IC_kwDODN1w685zjzGU","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Hrmm, while there can be span breakage across replays, it shouldn't affect the fact that the overall parent is still the same `StartWorkflow` from the client. Can you confirm that the client is created the same way for all execute-workflow calls and workers in use? Can you alter https://github.com/temporalio/samples-go/tree/main/opentelemetry to replicate your error.","createdAt":"2024-02-12T14:17:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1386#issuecomment-1938764180","viewerDidAuthor":false},{"id":"IC_kwDODN1w685zrDFu","author":{"login":"albertteoh"},"authorAssociation":"NONE","body":"Thanks for the speedy response, @cretz!\r\n\r\nAfter a lot of debugging, it turns out this is not a bug, but rather that the \"StartWorkflow:FulfillmentWorkflow\" had a pending child span \"RunWorkflow:FulfillmentWorkflow\" which all the activities depended on.\r\n\r\nThe reason why the activity spans were orphaned was because the \"RunWorkflow:FulfillmentWorkflow\" span is only emitted upon completion. I've attached a screenshot of the trace after completing the workflow, showing the child spans happily reunited with their parent ðŸ˜„ \r\n\r\nYour suggestion was very helpful by the way, because it gave me context that activities should correctly be nested under their parent workflow, so it allowed me to invest time into debugging further rather than exiting/giving up too early.\r\n\r\n<img width=\"743\" alt=\"Screenshot 2024-02-13 at 7 00 31â€¯pm\" src=\"https://github.com/temporalio/sdk-go/assets/26584478/66b4959a-4e33-4a0e-b3fa-3c89a7ef6b8f\">\r\n","createdAt":"2024-02-13T08:03:36Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/1386#issuecomment-1940664686","viewerDidAuthor":false}],"createdAt":"2024-02-12T11:17:59Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1386,"reactionGroups":[],"state":"CLOSED","title":"Activity spans not nested under parent workflow","updatedAt":"2024-02-13T13:21:09Z","url":"https://github.com/temporalio/sdk-go/issues/1386"}
