{"assignees":[],"author":{"id":"MDQ6VXNlcjI1MTg3MTAz","is_bot":false,"login":"yuandrew","name":"Andrew Yuan"},"body":"## Expected Behavior\nWorker shutdown should be consistently handled with local activities.\n\n\n## Actual Behavior\nIf a local activity has logic to complete on `ctx.Done()`, sometimes the local activity completes first, other times the worker shuts down first. The former will cancel the context for the worker, causing a different error message to be bubbled up (`context canceled`) instead of `ErrWorkerShutdown`.\n\nThis is the goroutine that handles the local activity execution: [link](https://github.com/temporalio/sdk-go/blob/a92189071ec5931c88a97284d60b8b06f1024fc3/internal/internal_task_pollers.go#L689)\n\nwhich causes us to [skip inspecting context ](https://github.com/temporalio/sdk-go/blob/a92189071ec5931c88a97284d60b8b06f1024fc3/internal/internal_task_pollers.go#L734)for the cause. \n\n## Steps to Reproduce the Problem\n\n  1. Execute this workflow and activity, stop a worker, then create a new worker on the same task queue.\n```\nfunc (a *Activities) ReactToCancel(ctx context.Context) error {\n\tfmt.Println(\"[ReactToCancel]\")\n\tselect {\n\tcase <-time.After(1 * time.Second):\n\t\treturn nil\n\tcase <-ctx.Done():\n\t\treturn ctx.Err()\n\t}\n}\nfunc (w *Workflows) WorkflowReactToCancel(ctx workflow.Context, localActivity bool) error {\n\tvar activities *Activities\n\n\tctx = workflow.WithLocalActivityOptions(ctx, workflow.LocalActivityOptions{\n\t\tStartToCloseTimeout:    5 * time.Second,\n\t\tScheduleToCloseTimeout: 5 * time.Second,\n\t\tRetryPolicy: &temporal.RetryPolicy{\n\t\t\tMaximumAttempts: 10,\n\t\t},\n\t})\n\terr := workflow.ExecuteLocalActivity(ctx, activities.ReactToCancel).Get(ctx, nil)\n\tif err != nil {\n\t\treturn err\n\t}\n\treturn nil\n}\n```\n  1.An easy way to hit this bug is to change `ReactToCancel` to the code above, then run `TestLocalActivityCancelFromWorkerShutdown`. Sometimes the test should pass, and other runs the test should fail.\n  1.\n\n## Specifications\n\n  - Version:1.34.0\n  - Platform:\n","closedAt":"2025-07-15T14:41:20Z","comments":[{"id":"IC_kwDODN1w6863OBj6","author":{"login":"yuandrew"},"authorAssociation":"MEMBER","body":"No longer able to repro the issue, I believe #1910 has fixed this race","createdAt":"2025-07-15T14:41:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1928#issuecomment-3073906938","viewerDidAuthor":false}],"createdAt":"2025-04-22T17:38:48Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDg2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1928,"reactionGroups":[],"state":"CLOSED","title":"Race condition with Local Activities and worker shutdown","updatedAt":"2025-07-15T14:41:20Z","url":"https://github.com/temporalio/sdk-go/issues/1928"}
