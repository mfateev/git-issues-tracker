{"assignees":[],"author":{"id":"MDQ6VXNlcjE0Njk3MA==","is_bot":false,"login":"emetsger","name":"Elliot Metsger"},"body":"## Expected Behavior\nI expect the test environment to have parity with the production runtime environment.\n\nWhen a workflow receives a cancellation request whilst a non-heartbeating activity is executing, I expect the workflow to block waiting for the activity to return before advancing the workflow, including the execution of any `defer`ed funcs.\n\nTwo observations:\n\n1. The expected behavior seems to only occur in the _production_ runtime when `WaitForCancellation` activity option is `true`.\n1. The expected behavior does not occur _at all_ in the test runtime (i.e., using `TestWorkflowEnvironment`).  In testing, the workflow does not block, regardless of `WaitForCancellation`.\n\nThis issue and test case relates to **observation #2**.  I was trying to write a test case for #1, and encountered buggy behavior in the test environment.\n\nSee additional context in [Slack](https://temporalio.slack.com/archives/CTDTU3J4T/p1711112606967079).\n\n## Actual Behavior\nIn the test runtime, the workflow receives a cancelation request and immediately moves on to executing deferred without waiting for the currently executing activity to complete.\n\n## Steps to Reproduce the Problem\nRun the supplied [test case](https://gist.github.com/emetsger/053591b397ab64c97d77e94830ec1d1e)\n\nThe test case expects the activity in the main body of the workflow to complete before the activity in the deferred func.  The test case demonstrates that the deferred activity executes while the main activity is still running.\n\nThe test issues a cancelation request using a delayed callback, and the activity uses `time.Sleep()` to ensure that cancelation occurs while the activity is executing.\n\n## Specifications\n* Version: `go.temporal.io/sdk v1.26.0`, `go.temporal.io/sdk v1.25.1`\n* Platform: `Darwin Kernel Version 22.6.0`, `go version go1.21.4 darwin/arm64`\n\n","closedAt":null,"comments":[],"createdAt":"2024-03-23T15:04:57Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1427,"reactionGroups":[],"state":"OPEN","title":"TestWorkflowEnvironment workflow Context does not block when canceled","updatedAt":"2025-02-04T18:25:03Z","url":"https://github.com/temporalio/sdk-go/issues/1427"}
