{"assignees":[{"id":"MDQ6VXNlcjIwNjM5Ng==","login":"cretz","name":"Chad Retz","databaseId":0}],"author":{"id":"MDQ6VXNlcjE1OTg2NjU5","is_bot":false,"login":"embano1","name":"Michael Gasch"},"body":"## Expected Behavior\nInvocation count assertions provided by the mocking library, such as `Once()` or `Times(n)` should not show different error/panic behavior affecting test results and always fail a test if the assertion does not hold.\n\nEither it should be documented that these methods should not be used due to this behavior or fixed, e.g. when recovering from panic and failing the test instead of passing.\n\n## Actual Behavior\nThis activity is configured with retries. Under test, it throws `PanicError` in the logs when the code is executed multiple times (retries) but the **test succeeds** with `exit code 0`.\n\n```go\nenv.OnActivity(\"MyActivity\", any, any).Return(nil, errors.New(\"test failure\")).Once() \n```\n\nThis activity is also configured with retries but since no error is returned it is only invoked once. Under test, it **fails the test** with a mocking error indicating that the function was only called once, i.e. `exit code != 0`.\n\n```go\nenv.OnActivity(\"MyActivity\", any, any).Return(nil, nil).Twice()\n```\n\ncc/ @cretz\n\n## Steps to Reproduce the Problem\nSee above\n\n## Specifications\n* Version: `go.temporal.io/sdk v1.10.0`\n* Platform: n/a\n\n","closedAt":null,"comments":[{"id":"IC_kwDODN1w685Hv-iP","author":{"login":"alfa-alex"},"authorAssociation":"NONE","body":"Ran into the same issue (`go.temporal.io/sdk v1.15.0`).\r\n\r\nWhat's your current position on this? Should the use of invocation count assertions be avoided at the moment?","createdAt":"2022-08-03T10:19:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/642#issuecomment-1203759247","viewerDidAuthor":false},{"id":"IC_kwDODN1w685HwDhC","author":{"login":"alfa-alex"},"authorAssociation":"NONE","body":"Actually for my use-case there was a relatively simple fix to this: Calling `Test` on the `mock`.\r\n\r\nSo, instead of the original\r\n```go\r\n// NewTestWorkflowEnvironment creates a new instance of TestWorkflowEnvironment. Use the returned TestWorkflowEnvironment\r\n// to run your workflow in the test environment.\r\nfunc (s *WorkflowTestSuite) NewTestWorkflowEnvironment() *TestWorkflowEnvironment {\r\n\treturn &TestWorkflowEnvironment{impl: newTestWorkflowEnvironmentImpl(s, nil)}\r\n}\r\n```\r\nI'm now constructing the `TestWorkflowEnvironment` with:\r\n```go\r\n// NewTestWorkflowEnvironmentWithTest creates a new instance of TestWorkflowEnvironment. Use the returned TestWorkflowEnvironment\r\n// to run your workflow in the test environment.\r\nfunc (s *WorkflowTestSuite) NewTestWorkflowEnvironmentWithTest(t mock.TestingT) *TestWorkflowEnvironment {\r\n\tenv := &TestWorkflowEnvironment{impl: newTestWorkflowEnvironmentImpl(s, nil)}\r\n\tenv.mock.Test(t)\r\n\treturn env\r\n}\r\n```\r\nin the `workflow_testsuite.go`. This does actually fail the test in the above case.\r\n\r\nWell possible this has undesired side-effects, but maybe something to consider. An alternative to having a different constructor would of course be to add a `Setter` func to the `TestWorkflowEnvironment`, but it felt quite naturally to me to construct the env with the test.","createdAt":"2022-08-03T10:40:57Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/642#issuecomment-1203779650","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Hwrn7","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Under test, it throws PanicError in the logs when the code is executed multiple times (retries) but the test succeeds with exit code 0.\r\n\r\nIIUC the original issue correctly, the code properly panics at call time when the invocation count is wrong, but the user is not checking `env.GetWorkflowError()` to get the actual workflow error so it doesn't fail their test.\r\n\r\nThe test environment is not just for running with the Go testing library. A panic calling the mock, whether that's for the assertion not holding or the body of the mock panicking, will follow normal panic paths. It is up to the user whether they treat a panic in a workflow as an error in their chosen environment.\r\n\r\nAlternatively, if you can't properly assert that the panic does not occur in the workflow for whatever reason, you can just count invocations inside the body of the mock and assert later.\r\n\r\nDoes that help? Or am I misunderstanding the concern?","createdAt":"2022-08-03T13:21:53Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/642#issuecomment-1203943931","viewerDidAuthor":false},{"id":"IC_kwDODN1w685HxNf8","author":{"login":"alfa-alex"},"authorAssociation":"NONE","body":"So you imply we should check the invocation count assertions via `env.GetWorkflowError()`? I thought that's what `env.AssertExpectations(t)` is for. The documentation reads:\r\n```go\r\n// AssertExpectations  asserts that everything specified with OnActivity\r\n// in fact called as expected.  Calls may have occurred in any order.\r\n```\r\n\r\nTo give you a minimal working example, change the `Test_Workflow` test of the `helloworld` sample in the `temporal-samples` project to:\r\n```go\r\n\ttestSuite := &testsuite.WorkflowTestSuite{}\r\n\tenv := testSuite.NewTestWorkflowEnvironment()\r\n\r\n\t// Mock activity implementation\r\n\tenv.OnActivity(Activity, mock.Anything, \"Temporal\").Return(\"\", errors.New(\"some error\")).Once()\r\n\tenv.ExecuteWorkflow(Workflow, \"Temporal\")\r\n\r\n\trequire.True(t, env.IsWorkflowCompleted())\r\n\tenv.AssertExpectations(t)\r\n```\r\nEven though the output correctly indicates that `Activity` was called more than once, the test doesn't fail. And `env.AssertExpectations` returns true.\r\n\r\nAm I misunderstanding the description of that function?","createdAt":"2022-08-03T15:13:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/642#issuecomment-1204082684","viewerDidAuthor":false},{"id":"IC_kwDODN1w685HxSSO","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> So you imply we should check the invocation count assertions via env.GetWorkflowError()? I thought that's what env.AssertExpectations(t) is for.\r\n\r\nMy mistake, yes, you can and should use that function if you want to assert the mocking expectations and you are in a test setting. I had forgotten about this helper. But you also want to check no error happened _inside_ the workflow by checking the workflow error.\r\n\r\nThe docs for https://pkg.go.dev/github.com/stretchr/testify/mock#Mock.AssertExpectations basically calls https://github.com/stretchr/testify/blob/v1.8.0/mock/mock.go#L610-L612 which seems to suggest it only fails if there were fewer calls than expected, not more. I believe this is how that mocking library works - when invoking more than expected, error at callsite, when invoking fewer than expected, error at expectation assertion site.","createdAt":"2022-08-03T15:23:04Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/642#issuecomment-1204102286","viewerDidAuthor":false},{"id":"IC_kwDODN1w685H2jtD","author":{"login":"alfa-alex"},"authorAssociation":"NONE","body":"Yeah, it looks like a testify issue. I think it's been described here: https://github.com/stretchr/testify/issues/608.\r\n\r\nThank you!\r\n\r\n---\r\n\r\nEdit: To summarize, the invocation count assertions should probably best be avoided. Other than that you could use the following \"solution\" from a user side (if you need this in a test and you are testing a workflow run that is expected to fail, so you want to distinguish the errors):\r\n```go\r\nerr := env.GetWorkflowError()\r\nvar panicErr *temporal.PanicError\r\nif ok := errors.As(err, &panicErr); ok && strings.HasPrefix(panicErr.Error(), \"\\nassert: mock:\") {\r\n\tassert.Fail(t, \"failed mock assertion\")\r\n}\r\n```","createdAt":"2022-08-04T16:27:12Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/642#issuecomment-1205484355","viewerDidAuthor":false},{"id":"IC_kwDODN1w685H3K4B","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> invocation count assertions should probably best be avoided\r\n\r\nConcur. And on a general best-practices note, the ease of adding counts can tempt one to overly assert counts leading to unnecessary expectations about the internals of the code under test. But if you had to manually count if you needed to confirm invocation counts, you'd be more willing to only do it where it was important to verify behavior.","createdAt":"2022-08-04T18:46:02Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/642#issuecomment-1205644801","viewerDidAuthor":false}],"createdAt":"2021-11-18T15:42:31Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":642,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"OPEN","title":"Inconsistent behavior when asserting invocations","updatedAt":"2024-03-15T05:00:05Z","url":"https://github.com/temporalio/sdk-go/issues/642"}
