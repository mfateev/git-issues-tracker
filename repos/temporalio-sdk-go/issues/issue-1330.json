{"assignees":[],"author":{"id":"MDQ6VXNlcjIwMjgwNTg=","is_bot":false,"login":"caramelomartins","name":"Hugo Martins"},"body":"Hey! I'll stick to template.\r\n\r\n**Is your feature request related to a problem? Please describe.**\r\n\r\nOpenTelemetry allows specifying \"a remote service\" to which a connection is made [through a peer service name](https://opentelemetry.io/docs/instrumentation/java/automatic/agent-config/#peer-service-name). This can be helpful to determine interactions between services - namely workers - even if Temporal's architecture is asynchronous.\r\n\r\nCurrently,  none of the available options in [TracerStartSpanOptions](https://github.com/temporalio/sdk-go/blob/5fdbecc56c8cd3bab8e8e33f7073070b98cefc0c/interceptor/tracing_interceptor.go#L123) allows us to infer if a worker is making a request that will be fulfilled by another worker. This makes it impossible to add peer service information in outbound calls (e.g. `StartActivity` or `StartWorkflow`).\r\n\r\n**Describe the solution you'd like**\r\n\r\nOne potential approach could be to share the `TaskQueue` as a `TracerStartSpanOption`, similar to what is already done with the Name and Operation being executed. This would allow developers to externally infer if a cross-service request is being made based on whether the `TaskQueue` of the outbound request is different than the `TaskQueue` where a worker is executing now.\r\n\r\nI'm sure this isn't an appropriate solution for all situations, but that could be left to the developer to decide - depending on the architecture of their services. Just providing the `TaskQueue` there could potentially open space for attempting to infer peer services.\r\n\r\n**Describe alternatives you've considered**\r\n\r\nI considered using the Name as the peer service but that value changes to often to be able to provide a meaningful signal for cross-service interactions. Nonetheless, I'm very open to other suggestions about how to go about doing this.\r\n\r\nI'm happy to open a PR and work on this, but wouldn't want to do that before opening a feature request and discussing it.\r\n\r\nThank you!","closedAt":null,"comments":[{"id":"IC_kwDODN1w685vzJHE","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"It's not just task queue, there are a lot of things people may want as tags or customize the span.\r\n\r\nI wonder if there is a way to provide the context to `TracerStartSpanOptions` (that is probably `interface{ Value(any) any }`) so that you can extract anything out of the context. For a workflow context this would be easy enough to get the info, but for a client context, you may be expected to provide something to the context before starting.\r\n\r\nAnother approach may be to have a special context key for storing tags on the context, and you can have an outer interceptor that sets this task queue that is then read by the span starter.","createdAt":"2024-01-03T16:55:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1330#issuecomment-1875677636","viewerDidAuthor":false},{"id":"IC_kwDODN1w685v6QZo","author":{"login":"caramelomartins"},"authorAssociation":"NONE","body":"@cretz I mentioned `TaskQueue` in attempt to not overload the feature request with a lot of things. Your suggestion is sensible though, I feel users will increasingly want to have more and more data - likely.\r\n\r\nAdding more generic approaches, though, could easily complicate matters a bit, no? Adding the `TaskQueue` seems quite simple, if we do add context then there's already a divergence between `context.Context` and `workflow.Context` depending on the span that we are about to start.\r\n\r\nI wonder if it makes sense to add the `TaskQueue` as an intermediate step, while discussing more generic approaches keeps happening?\r\n\r\n","createdAt":"2024-01-04T18:06:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1330#issuecomment-1877542504","viewerDidAuthor":false},{"id":"IC_kwDODN1w685v-zfz","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@Quinn-With-Two-Ns do you have an opinion here? Maybe we want `ActivityContext` and `WorkflowContext` fields? Maybe can just provide the `interface{ Value(any) any }` and ask outer interceptors to set what they may want? Or maybe we should just encourage users that need advanced tracer implementations to write their own interceptors instead of using the existing ones? Or maybe task queue is ok for now?","createdAt":"2024-01-05T14:07:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1330#issuecomment-1878734835","viewerDidAuthor":false},{"id":"IC_kwDODN1w685v_97t","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Hm I don't think just attaching `ActivityContext` and `WorkflowContext` fields is sufficient since you may also want to have additional information on the client trace calls as well. I  guess `interface{ Value(any) any }` cannot be auto set based on what is in the calling correct?","createdAt":"2024-01-05T17:42:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1330#issuecomment-1879039725","viewerDidAuthor":false},{"id":"IC_kwDODN1w685wACh7","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> I guess interface{ Value(any) any } cannot be auto set based on what is in the calling correct?\r\n\r\nIt would be set by our primary tracing interceptor impl. To propagate info, you'd have to pass information through the context via an outer interceptor probably. Another approach maybe is a certain context key that contains span tags that is then extracted at span creation time. Of course this also requires an outer interceptor to take something like the task queue and put it in there.\r\n\r\nSo two questions: 1) Do we want to support generic span tag customization or just add task queue to span options? and 2) If we do want to support generic span tag customization, how do we do it reasonably?","createdAt":"2024-01-05T17:58:45Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1330#issuecomment-1879058555","viewerDidAuthor":false},{"id":"IC_kwDODN1w685wAIAW","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"I would support generic span tag customization over adding just task queue. I am not sure any approach will really fufill the ask of this issue\r\n\r\n>allows us to infer if a worker is making a request that will be fulfilled by another worker\r\n\r\nSince task queue or any information added on the interceptor side is not enough to tell if a call will be fulfilled by the callers worker or a remote worker in general","createdAt":"2024-01-05T18:16:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-go/issues/1330#issuecomment-1879080982","viewerDidAuthor":false},{"id":"IC_kwDODN1w685wAObY","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I suppose it will be enough if they guarantee it's a different task queue, but for the same task queue you are correct there is no guarantee.","createdAt":"2024-01-05T18:39:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1330#issuecomment-1879107288","viewerDidAuthor":false},{"id":"IC_kwDODN1w685wJx53","author":{"login":"caramelomartins"},"authorAssociation":"NONE","body":"> I would support generic span tag customization over adding just task queue. I am not sure any approach will really fufill the ask of this issue\r\n> \r\n> > allows us to infer if a worker is making a request that will be fulfilled by another worker\r\n> \r\n> Since task queue or any information added on the interceptor side is not enough to tell if a call will be fulfilled by the callers worker or a remote worker in general\r\n\r\n> I suppose it will be enough if they guarantee it's a different task queue, but for the same task queue you are correct there is no guarantee.\r\n\r\nThis is currently the architecture I'm working with, a single queue for each worker, which is why I feel having the queue in there would work out. It might not be a generic solution for all users though, as described, I understand that.","createdAt":"2024-01-08T18:28:08Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1330#issuecomment-1881611895","viewerDidAuthor":false}],"createdAt":"2023-12-20T09:54:24Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDky","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1330,"reactionGroups":[],"state":"OPEN","title":"Add TaskQueue to TracerStartSpanOptions","updatedAt":"2024-01-08T18:28:29Z","url":"https://github.com/temporalio/sdk-go/issues/1330"}
