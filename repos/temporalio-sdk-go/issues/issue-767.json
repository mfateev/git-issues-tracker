{"assignees":[],"author":{"id":"MDQ6VXNlcjE1NzkzODQ=","is_bot":false,"login":"mbark","name":"Martin Wohlfart"},"body":"## Expected Behavior\r\n\r\nWhen using `workflowcheck` it should always terminate.\r\n\r\n## Actual Behavior\r\n\r\nWhen using `text/template` in the workflow code `workflowcheck` gets stuck and never terminates.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nSee my [example repo](https://github.com/mbark/temporal-workflowcheck-error) here. I added a `Makefile` to simplify running `workflowcheck`, `make workflowcheck` will download it and run the version referenced in `tools.go` for you.\r\n\r\nTo reproduce:\r\n  1. Run `make workflowcheck`;\r\n  1. `workflowcheck` doesn't terminate;\r\n  1. Comment lines 16-20 in `workflow.go`;\r\n  2. Re-run `make workflowcheck`;\r\n  3. It terminates successfully.\r\n\r\n## Specifications\r\n\r\n  - Version: `go.temporal.io/sdk/contrib/tools/workflowcheck v0.0.0-20220324161800-48b3cb957491`\r\n  - Platform: macOS\r\n","closedAt":"2022-04-19T17:05:50Z","comments":[{"id":"IC_kwDODN1w685Aj42-","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks for the report! To investigate, we will want to run with debug enabled and/or run via `go vet` just to see it isn't heavy rather than stuck.","createdAt":"2022-03-30T13:35:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/767#issuecomment-1083149758","viewerDidAuthor":false},{"id":"IC_kwDODN1w685BqRDu","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks for the reproducer! I have replicated this. Strangely I cannot replicate on Windows, only Linux. Here's what the Windows output shows:\r\n\r\n```\r\nc:\\path\\to\\temporal-workflowcheck-error\\main.go:20:2: templateworkflowcheck.Workflow is non-deterministic, reason: calls non-deterministic function (*text/template.Template).Execute\r\n  (*text/template.Template).Execute is non-deterministic, reason: calls non-deterministic function (*text/template.Template).execute\r\n    (*text/template.Template).execute is non-deterministic, reason: calls non-deterministic function (*text/template.state).walk\r\n      (*text/template.state).walk is non-deterministic, reason: calls non-deterministic function (*text/template.state).printValue\r\n        (*text/template.state).printValue is non-deterministic, reason: calls non-deterministic function text/template.printableValue\r\n          text/template.printableValue is non-deterministic, reason: calls non-deterministic function reflect.PtrTo\r\n            reflect.PtrTo is non-deterministic, reason: calls non-deterministic function (*reflect.rtype).ptrTo\r\n              (*reflect.rtype).ptrTo is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n                (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n                  (*sync.Map).dirtyLocked is non-deterministic, reason: iterates over map\r\n              (*reflect.rtype).ptrTo is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n                (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n                  (*sync.Map).dirtyLocked is non-deterministic, reason: iterates over map\r\n          text/template.printableValue is non-deterministic, reason: calls non-deterministic function reflect.PtrTo\r\n            reflect.PtrTo is non-deterministic, reason: calls non-deterministic function (*reflect.rtype).ptrTo\r\n              (*reflect.rtype).ptrTo is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n                (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n                  (*sync.Map).dirtyLocked is non-deterministic, reason: iterates over map\r\n              (*reflect.rtype).ptrTo is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n                (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n                  (*sync.Map).dirtyLocked is non-deterministic, reason: iterates over map\r\n          text/template.printableValue is non-deterministic, reason: calls non-deterministic function (reflect.Value).Addr\r\n            (reflect.Value).Addr is non-deterministic, reason: calls non-deterministic function (*reflect.rtype).ptrTo\r\n              (*reflect.rtype).ptrTo is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n                (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n                  (*sync.Map).dirtyLocked is non-deterministic, reason: iterates over map\r\n              (*reflect.rtype).ptrTo is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n                (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n                  (*sync.Map).dirtyLocked is non-deterministic, reason: iterates over map\r\n```\r\n\r\nI am continuing to investigate Linux. In the meantime, you can add `//workflowcheck:ignore` either above or at the end of that `.Execute` line. Also, you can upgrade your version with `go get go.temporal.io/sdk/contrib/tools/workflowcheck@latest` which does have some output improvements but it doesn't solve this issue.\r\n\r\nFrom the static analyzer's POV, `Template.Execute` will be considered non-deterministic due to its internals having lots of non-deterministic code. So you're going to need to ignore `text/template` anyways with `//workflowcheck:ignore`. Technically you could make that as always deterministic via config (see README at https://github.com/temporalio/sdk-go/tree/master/contrib/tools/workflowcheck) but then if other people use the package non-deterministically you'll never know.","createdAt":"2022-04-18T17:42:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/767#issuecomment-1101598958","viewerDidAuthor":false}],"createdAt":"2022-03-30T09:48:46Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":767,"reactionGroups":[],"state":"CLOSED","title":"workflowcheck gets stuck forever when using templates in the workflow","updatedAt":"2022-04-19T17:05:50Z","url":"https://github.com/temporalio/sdk-go/issues/767"}
