{"assignees":[],"author":{"id":"MDQ6VXNlcjMyODc1NzQ3","is_bot":false,"login":"nghiant3223","name":"Nguyen Trong Nghia"},"body":"## Expected Behavior\r\nNo data race in writing/reading stick cache size.\r\n\r\n## Actual Behavior\r\nData race sometimes happens. This behavior is flaky.\r\n\r\n```\r\n==================\r\nWARNING: DATA RACE\r\nRead at 0x0001043c4998 by goroutine 8:\r\n  go.temporal.io/sdk/internal.NewWorkerCache()\r\n      /Users/nghianguyen/go/pkg/mod/go.temporal.io/sdk@v1.20.0/internal/internal_worker_cache.go:86 +0x3d8\r\n  go.temporal.io/sdk/internal.NewAggregatedWorker()\r\n      /Users/nghianguyen/go/pkg/mod/go.temporal.io/sdk@v1.20.0/internal/internal_worker.go:1426 +0x3b0\r\n  go.temporal.io/sdk/internal.NewWorker()\r\n      /Users/nghianguyen/go/pkg/mod/go.temporal.io/sdk@v1.20.0/internal/worker.go:275 +0x80\r\n  go.temporal.io/sdk/worker.New()\r\n      /Users/nghianguyen/go/pkg/mod/go.temporal.io/sdk@v1.20.0/worker/worker.go:245 +0x9c\r\n  github.com/temporal/test.TestTemporal.func2()\r\n      /Users/nghianguyen/Desktop/tsworkspace/temporal/test/temporal_test.go:32 +0x3c\r\n  testing.tRunner()\r\n      /usr/local/go/src/testing/testing.go:1576 +0x188\r\n  testing.(*T).Run.func1()\r\n      /usr/local/go/src/testing/testing.go:1629 +0x40\r\n\r\nPrevious write at 0x0001043c4998 by goroutine 7:\r\n  go.temporal.io/sdk/internal.SetStickyWorkflowCacheSize()\r\n      /Users/nghianguyen/go/pkg/mod/go.temporal.io/sdk@v1.20.0/internal/internal_worker_cache.go:69 +0x6c\r\n  go.temporal.io/sdk/worker.SetStickyWorkflowCacheSize()\r\n      /Users/nghianguyen/go/pkg/mod/go.temporal.io/sdk@v1.20.0/worker/worker.go:276 +0x40\r\n  github.com/temporal/test.TestTemporal.func1()\r\n      /Users/nghianguyen/Desktop/tsworkspace/temporal/test/temporal_test.go:15 +0x38\r\n  testing.tRunner()\r\n      /usr/local/go/src/testing/testing.go:1576 +0x188\r\n  testing.(*T).Run.func1()\r\n      /usr/local/go/src/testing/testing.go:1629 +0x40\r\n\r\nGoroutine 8 (running) created at:\r\n  testing.(*T).Run()\r\n      /usr/local/go/src/testing/testing.go:1629 +0x5e4\r\n  github.com/temporal/test.TestTemporal()\r\n      /Users/nghianguyen/Desktop/tsworkspace/tenporal/test/temporal_test.go:19 +0x58\r\n  testing.tRunner()\r\n      /usr/local/go/src/testing/testing.go:1576 +0x188\r\n  testing.(*T).Run.func1()\r\n      /usr/local/go/src/testing/testing.go:1629 +0x40\r\n\r\nGoroutine 7 (running) created at:\r\n  testing.(*T).Run()\r\n      /usr/local/go/src/testing/testing.go:1629 +0x5e4\r\n  github.com/temporal/test.TestTemporal()\r\n      /Users/nghianguyen/Desktop/tsworkspace/temporal/test/temporal_test.go:11 +0x3c\r\n  testing.tRunner()\r\n      /usr/local/go/src/testing/testing.go:1576 +0x188\r\n  testing.(*T).Run.func1()\r\n      /usr/local/go/src/testing/testing.go:1629 +0x40\r\n==================\r\n2024/02/02 11:06:23 INFO  No logger configured for temporal client. Created default one.\r\n2024/02/02 11:06:23 INFO  No logger configured for temporal client. Created default one.\r\n2024/02/02 11:06:23 INFO  No logger configured for temporal client. Created default one.\r\n2024/02/02 11:06:23 INFO  No logger configured for temporal client. Created default one.\r\n2024/02/02 11:06:23 INFO  No logger configured for temporal client. Created default one.\r\n2024/02/02 11:06:23 INFO  No logger configured for temporal client. Created default one.\r\n2024/02/02 11:06:23 INFO  No logger configured for temporal client. Created default one.\r\n2024/02/02 11:06:23 INFO  No logger configured for temporal client. Created default one.\r\n2024/02/02 11:06:23 INFO  No logger configured for temporal client. Created default one.\r\n--- FAIL: TestTemporal (0.00s)\r\n    --- FAIL: TestTemporal/read (0.07s)\r\n        testing.go:1446: race detected during execution of test\r\n    --- FAIL: TestTemporal/write (0.25s)\r\n        testing.go:1446: race detected during execution of test\r\nFAIL\r\nFAIL\tgithub.com/temporal/test\t0.840s\r\nFAIL\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n1. Write a test file:\r\n```go\r\n// File: main_test.go\r\n\r\npackage temporal\r\n\r\nimport (\r\n\t\"testing\"\r\n\r\n\t\"go.temporal.io/sdk/client\"\r\n\t\"go.temporal.io/sdk/worker\"\r\n)\r\n\r\nfunc TestTemporal(t *testing.T) {\r\n\tt.Run(\"write\", func(t *testing.T) {\r\n\t\tt.Parallel()\r\n\r\n\t\tfor i := 0; i < 1_000_000; i++ {\r\n\t\t\tworker.SetStickyWorkflowCacheSize(100)\r\n\t\t}\r\n\t})\r\n\r\n\tt.Run(\"read\", func(t *testing.T) {\r\n\t\tt.Parallel()\r\n\r\n\t\tfor i := 0; i < 100; i++ {\r\n\t\t\ttemporalClient, err := client.Dial(client.Options{\r\n\t\t\t\tHostPort:  \"localhost:7233\",\r\n\t\t\t\tNamespace: \"default\",\r\n\t\t\t},\r\n\t\t\t)\r\n\t\t\tif err != nil {\r\n\t\t\t\tpanic(err)\r\n\t\t\t}\r\n\r\n\t\t\tworker.New(temporalClient, \"default\", worker.Options{})\r\n\t\t}\r\n\t})\r\n}\r\n```\r\n\r\n2. Run the test file with `-race` flag\r\n\r\n```\r\n$ go test -race .\r\n```\r\n\r\n## Root Cause Analysis\r\n\r\nThe sticky cache size is set with lock [here](https://github.com/temporalio/sdk-go/blob/master/internal/internal_worker_cache.go#L61-L70), but it is read without lock [here](https://github.com/temporalio/sdk-go/blob/master/internal/internal_worker_cache.go#L82-L87).\r\n\r\n## Specifications\r\n\r\n  - Version:\r\n    - Go version: v1.20.11\r\n    - Temporal SDK: v1.20.0\r\n  - Platform: darwin/arm64\r\n","closedAt":"2024-02-06T04:14:33Z","comments":[{"id":"IC_kwDODN1w685yqwDs","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks, we do need to fix this.\r\n\r\nNote, the reason most have not hit this is because `SetStickyWorkflowCacheSize` needs to be called before it ever can be used (so before all workers and replayers). It has no effect if called after first use. If you're in a situation where you are calling `SetStickyWorkflowCacheSize` after it is first accessed, it won't work.","createdAt":"2024-02-02T13:27:50Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1375#issuecomment-1923809516","viewerDidAuthor":false},{"id":"IC_kwDODN1w685yv2w0","author":{"login":"nghiant3223"},"authorAssociation":"CONTRIBUTOR","body":"Yes. Can I make a contribution? @cretz ","createdAt":"2024-02-03T05:52:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1375#issuecomment-1925147700","viewerDidAuthor":false},{"id":"IC_kwDODN1w685y3C-h","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Yes, thanks! Remember though, do not try to update this cache setting after already creating workers. It won't work. So whatever you're doing to hit this race signifies a bigger problem.","createdAt":"2024-02-05T13:38:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1375#issuecomment-1927032737","viewerDidAuthor":false}],"createdAt":"2024-02-02T04:19:53Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1375,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"Data race due to missing lock/unlock","updatedAt":"2024-02-06T04:14:33Z","url":"https://github.com/temporalio/sdk-go/issues/1375"}
