{"assignees":[],"author":{"id":"MDQ6VXNlcjQ0MzE4","is_bot":false,"login":"dancavallaro","name":"Dan Cavallaro"},"body":"## Expected Behavior\r\nworkflowcheck@latest (which points to 0.1.0, the only version available at pkg.go.dev) should work with the Go 1.22 toolchain.\r\n\r\n## Actual Behavior\r\nWhen built with Go 1.22, workflowcheck fails with:\r\n\r\n```\r\npanic: runtime error: invalid memory address or nil pointer dereference [recovered]\r\n\tpanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0x1908f0]\r\n\r\ngoroutine 68 [running]:\r\ngo/types.(*Checker).handleBailout(0x400019e200, 0x4000247b98)\r\n\t/usr/local/go/src/go/types/check.go:367 +0x9c\r\npanic({0x316ee0?, 0x5b3c50?})\r\n\t/usr/local/go/src/runtime/panic.go:770 +0x124\r\ngo/types.(*StdSizes).Sizeof(0x0, {0x3ee798, 0x5b78a0})\r\n\t/usr/local/go/src/go/types/sizes.go:228 +0x320\r\ngo/types.(*Config).sizeof(...)\r\n\t/usr/local/go/src/go/types/sizes.go:333\r\ngo/types.representableConst.func1({0x3ee798?, 0x5b78a0?})\r\n\t/usr/local/go/src/go/types/const.go:76 +0x9c\r\ngo/types.representableConst({0x3efe30, 0x5ac4e0}, 0x400019e200, 0x5b78a0, 0x4000245f98)\r\n\t/usr/local/go/src/go/types/const.go:92 +0x138\r\ngo/types.(*Checker).representation(0x400019e200, 0x4000071600, 0x5b78a0)\r\n\t/usr/local/go/src/go/types/const.go:256 +0x68\r\ngo/types.(*Checker).implicitTypeAndValue(0x400019e200, 0x4000071600, {0x3ee798, 0x5b78a0})\r\n\t/usr/local/go/src/go/types/expr.go:375 +0x340\r\ngo/types.(*Checker).convertUntyped(0x400019e200, 0x4000071600, {0x3ee798, 0x5b78a0})\r\n\t/usr/local/go/src/go/types/const.go:289 +0x30\r\ngo/types.(*Checker).matchTypes(0x400019e200, 0x40000715c0, 0x4000071600)\r\n\t/usr/local/go/src/go/types/expr.go:926 +0x7c\r\ngo/types.(*Checker).binary(0x400019e200, 0x40000715c0, {0x3ef340, 0x40000743c0}, {0x3eefb0, 0x40000109c0}, {0x3ef850, 0x40000109e0}, 0x28, 0x359a)\r\n\t/usr/local/go/src/go/types/expr.go:800 +0x114\r\ngo/types.(*Checker).exprInternal(0x400019e200, 0x0, 0x40000715c0, {0x3ef340, 0x40000743c0}, {0x0, 0x0})\r\n\t/usr/local/go/src/go/types/expr.go:1416 +0x1d4\r\ngo/types.(*Checker).rawExpr(0x400019e200, 0x0, 0x40000715c0, {0x3ef340?, 0x40000743c0?}, {0x0?, 0x0?}, 0x0)\r\n\t/usr/local/go/src/go/types/expr.go:979 +0x12c\r\ngo/types.(*Checker).expr(0x400019e200, 0x3ee540?, 0x40000715c0, {0x3ef340?, 0x40000743c0?})\r\n\t/usr/local/go/src/go/types/expr.go:1513 +0x38\r\ngo/types.(*Checker).stmt(0x400019e200, 0x0, {0x3ef6a0, 0x4000070880})\r\n\t/usr/local/go/src/go/types/stmt.go:570 +0xdb0\r\ngo/types.(*Checker).stmtList(0x400019e200, 0x0, {0x4000010b40?, 0x0?, 0x0?})\r\n\t/usr/local/go/src/go/types/stmt.go:121 +0x88\r\ngo/types.(*Checker).funcBody(0x400019e200, 0x3ee798?, {0x400000e3f0?, 0x5b7a80?}, 0x4000071300, 0x4000074450, {0x0?, 0x0?})\r\n\t/usr/local/go/src/go/types/stmt.go:41 +0x21c\r\ngo/types.(*Checker).funcDecl.func1()\r\n\t/usr/local/go/src/go/types/decl.go:852 +0x44\r\ngo/types.(*Checker).processDelayed(0x400019e200, 0x0)\r\n\t/usr/local/go/src/go/types/check.go:467 +0x12c\r\ngo/types.(*Checker).checkFiles(0x400019e200, {0x4000048120, 0x1, 0x1})\r\n\t/usr/local/go/src/go/types/check.go:411 +0x188\r\ngo/types.(*Checker).Files(...)\r\n\t/usr/local/go/src/go/types/check.go:372\r\ngolang.org/x/tools/go/packages.(*loader).loadPackage(0x4000120000, 0x40001729c0)\r\n\t/go/pkg/mod/golang.org/x/tools@v0.10.0/go/packages/packages.go:1055 +0x870\r\ngolang.org/x/tools/go/packages.(*loader).loadRecursive.func1()\r\n\t/go/pkg/mod/golang.org/x/tools@v0.10.0/go/packages/packages.go:854 +0x178\r\nsync.(*Once).doSlow(0x0?, 0x0?)\r\n\t/usr/local/go/src/sync/once.go:74 +0x100\r\nsync.(*Once).Do(...)\r\n\t/usr/local/go/src/sync/once.go:65\r\ngolang.org/x/tools/go/packages.(*loader).loadRecursive(0x0?, 0x0?)\r\n\t/go/pkg/mod/golang.org/x/tools@v0.10.0/go/packages/packages.go:842 +0x50\r\ngolang.org/x/tools/go/packages.(*loader).loadRecursive.func1.1(0x0?)\r\n\t/go/pkg/mod/golang.org/x/tools@v0.10.0/go/packages/packages.go:849 +0x30\r\ncreated by golang.org/x/tools/go/packages.(*loader).loadRecursive.func1 in goroutine 16\r\n\t/go/pkg/mod/golang.org/x/tools@v0.10.0/go/packages/packages.go:848 +0x84\r\nexit status 2\r\n```\r\n\r\nAs far as I can tell, this is a known/expected issue resulting from a Go change in 1.22: https://github.com/golang/go/issues/62167. Other libraries/packages have also run into this and fixed it, e.g. https://github.com/ent/ent/issues/3864. \r\n\r\nAnd indeed from what I can tell, you've already fixed this in workflowcheck on HEAD, you just need to publish a new version. TL;DR of the issue, as I understand it, is that Go analyzers when built with the 1.22 toolchain also require a version of `x/tools` at least as new as v0.13.0. workflowcheck's go.mod has x/tools v0.13.0 *now* in the repo, but workflowcheck v0.1.0 depends on x/tools v0.10.0.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nMinimal example showing the error with Go 1.22:\r\n\r\n```\r\n> cat main.go\r\npackage main\r\n\r\nimport \"fmt\"\r\n\r\nfunc main() {\r\n\tfmt.Println(\"Hello, world!\")\r\n}\r\n> docker run -it --rm -v .:/workflowcheck --workdir /workflowcheck golang:1.22-bookworm sh -c \"go run go.temporal.io/sdk/contrib/tools/workflowcheck@latest main.go\"\r\ngo: downloading go.temporal.io/sdk v1.25.1\r\ngo: downloading go.temporal.io/sdk/contrib/tools/workflowcheck v0.1.0\r\ngo: downloading golang.org/x/tools v0.10.0\r\ngo: downloading gopkg.in/yaml.v2 v2.4.0\r\ngo: downloading golang.org/x/sys v0.9.0\r\ngo: downloading golang.org/x/mod v0.11.0\r\npanic: runtime error: invalid memory address or nil pointer dereference [recovered]\r\n\tpanic: runtime error: invalid memory address or nil pointer dereference\r\n[signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0x1908f0]\r\n```\r\n\r\nBut it works fine with Go 1.21.7, as expected:\r\n\r\n```\r\n> docker run -it --rm -v .:/workflowcheck --workdir /workflowcheck golang:1.21.7-bookworm sh -c \"go run go.temporal.io/sdk/contrib/tools/workflowcheck@latest main.go\"\r\ngo: downloading go.temporal.io/sdk/contrib/tools/workflowcheck v0.1.0\r\ngo: downloading go.temporal.io/sdk v1.25.1\r\ngo: downloading golang.org/x/tools v0.10.0\r\ngo: downloading gopkg.in/yaml.v2 v2.4.0\r\ngo: downloading golang.org/x/sys v0.9.0\r\ngo: downloading golang.org/x/mod v0.11.0\r\n>\r\n```\r\n\r\nAlternatively, a consumer can work around it by adding workflowcheck to one's go.mod/tools.go while ensuring you have a version of x/tools at least as new as v0.13.0, and then omitting `@latest` when `go install`ing workflowcheck so that it builds in module-aware mode, using the newer version of x/tools from the consumer's go.mod. \r\n\r\n```\r\n> cat go.mod\r\nmodule github.com/dancavallaro\r\n\r\ngo 1.22.0\r\n\r\nrequire go.temporal.io/sdk/contrib/tools/workflowcheck v0.1.0\r\n\r\nrequire (\r\n\tgolang.org/x/mod v0.14.0 // indirect\r\n\tgolang.org/x/tools v0.17.0 // indirect\r\n\tgopkg.in/yaml.v2 v2.4.0 // indirect\r\n)\r\n> docker run -it --rm -v .:/workflowcheck --workdir /workflowcheck golang:1.22-bookworm sh -c \"go run go.temporal.io/sdk/contrib/tools/workflowcheck main.go\"\r\ngo: downloading go.temporal.io/sdk/contrib/tools/workflowcheck v0.1.0\r\ngo: downloading golang.org/x/tools v0.17.0\r\ngo: downloading gopkg.in/yaml.v2 v2.4.0\r\ngo: downloading golang.org/x/mod v0.14.0\r\n>\r\n```\r\n\r\nThat seems like a best practice anyway so I'll stick with that, but nonetheless wanted to give you a heads up about this issue so you can publish a new version of workflowcheck. \r\n## Specifications\r\n\r\n  - Version: Go 1.22 toolchain, with workflowcheck v0.1.0\r\n  - Platform:\r\n```\r\n> uname -a\r\nDarwin MAC-KJ9HW94GKX 23.3.0 Darwin Kernel Version 23.3.0: Wed Dec 20 21:31:00 PST 2023; root:xnu-10002.81.5~7/RELEASE_ARM64_T6020 arm64\r\n> docker run -it --rm -v .:/workflowcheck --workdir /workflowcheck golang:1.22-bookworm uname -a\r\nLinux c23f0ee858ea 6.5.11-linuxkit #1 SMP PREEMPT Wed Dec  6 17:08:31 UTC 2023 aarch64 GNU/Linux\r\n```","closedAt":"2024-03-13T15:25:10Z","comments":[{"id":"IC_kwDODN1w685zUWNK","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"There is already a fix merged for this https://github.com/temporalio/sdk-go/commit/72a5b6fbc0831183fb69d0debb560fdbfc6a8fdb. We will release a `v0.2.0` after the Go SDK is released. ","createdAt":"2024-02-08T18:32:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}},{"content":"HEART","users":{"totalCount":3}}],"url":"https://github.com/temporalio/sdk-go/issues/1382#issuecomment-1934713674","viewerDidAuthor":false},{"id":"IC_kwDODN1w685zUh3L","author":{"login":"dancavallaro"},"authorAssociation":"NONE","body":"Roger! I did see that you'd upgraded x/tools already but I wasn't sure if this specific issue was on your radar for an upcoming release. Thanks for confirming!","createdAt":"2024-02-08T19:02:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1382#issuecomment-1934761419","viewerDidAuthor":false},{"id":"IC_kwDODN1w6852tbGn","author":{"login":"guygof"},"authorAssociation":"NONE","body":"> There is already a fix merged for this [72a5b6f](https://github.com/temporalio/sdk-go/commit/72a5b6fbc0831183fb69d0debb560fdbfc6a8fdb). We will release a `v0.2.0` after the Go SDK is released.\r\n\r\nI saw 1.26.0 was released with the fix - will workflowcheck 0.2.0 be released soon? I see the latest version still crashes.\r\nThanks @Quinn-With-Two-Ns !","createdAt":"2024-03-12T13:10:41Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1382#issuecomment-1991618983","viewerDidAuthor":false},{"id":"IC_kwDODN1w6852t0Oj","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Yes it will be","createdAt":"2024-03-12T14:00:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/1382#issuecomment-1991721891","viewerDidAuthor":false},{"id":"IC_kwDODN1w68525BVa","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Closing since workflowcheck v0.2.0 is released https://github.com/temporalio/sdk-go/releases/tag/contrib%2Ftools%2Fworkflowcheck%2Fv0.2.0","createdAt":"2024-03-13T15:25:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1382#issuecomment-1994659162","viewerDidAuthor":false}],"createdAt":"2024-02-08T18:28:55Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1382,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":4}}],"state":"CLOSED","title":"workflowcheck v0.1.0 fails with Go 1.22","updatedAt":"2024-03-13T15:25:10Z","url":"https://github.com/temporalio/sdk-go/issues/1382"}
