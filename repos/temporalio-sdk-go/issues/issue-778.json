{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"A couple of issues have potentially been observed with the workflow/activity test env:\r\n\r\n1. A mocked activity may not return a value if the context is cancelled\r\n2. An activity called on the cancelled context for cleanup is immediately returning and still running the activity\r\n\r\nNeed standalone replication, then debugging/fix if applicable.","closedAt":"2022-04-25T17:42:55Z","comments":[{"id":"IC_kwDODN1w685BeumT","author":{"login":"awsaba"},"authorAssociation":"NONE","body":"\r\n> 2. An activity called on the cancelled context for cleanup is immediately returning and still running the activity\r\n\r\nOur use case is not so much clean up as multiple steps of bookeeping. Putting a `switch` after every return to distinguish between an `ActivityError` and cancellation seems like the obvious but wrong solution since it would have to added after most activities.\r\n\r\nThe workflows and test:\r\n```go\r\npackage cancelwork\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"fmt\"\r\n\t\"time\"\r\n\r\n\t\"go.temporal.io/sdk/activity\"\r\n\t\"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\n// CancelMe is long-running activity that is the most likely to be running\r\n// when a cancel is received\r\nfunc CancelMe(ctx context.Context, _ string) (string, error) {\r\n\ttime.Sleep(1 * time.Second)\r\n\treturn \"long-running-result\", nil\r\n}\r\n\r\n// SaveStatus just logs the status, but could do some database operation\r\nfunc SaveStatus(ctx context.Context, value string) error {\r\n\tlogger := activity.GetLogger(ctx)\r\n\ttime.Sleep(3 * time.Second)\r\n\tlogger.Error(fmt.Sprintf(\"from SaveStatus, value is: \\\"%s\\\"\", value))\r\n\treturn nil\r\n}\r\n\r\n// SomeWorkflow calls a long running op to do something\r\nfunc SomeWorkflow(ctx workflow.Context) error {\r\n\tlogger := workflow.GetLogger(ctx)\r\n\tao := workflow.ActivityOptions{\r\n\t\tStartToCloseTimeout:    10 * time.Minute,\r\n\t\tScheduleToCloseTimeout: 24 * time.Hour,\r\n\t\tWaitForCancellation:    true,\r\n\t}\r\n\tctx = workflow.WithActivityOptions(ctx, ao)\r\n\r\n\tdefer func() {\r\n\t\tlogger.Error(\"some other log before return\")\r\n\t}()\r\n\r\n\tvar val string\r\n\terr := workflow.ExecuteActivity(ctx, CancelMe, \"\").Get(ctx, &val)\r\n\tif err != nil {\r\n\t\tlogger.Error(fmt.Sprintf(\"error in CancelMe: %s, is there a way to get val: \\\"%s\\\"\", err.Error(), val))\r\n\t\tperr := workflow.ExecuteActivity(ctx, SaveStatus, val).Get(ctx, nil)\r\n\t\tif perr != nil {\r\n\t\t\tlogger.Error(fmt.Sprintf(\"if cancelled, this should fail with cancel and not execute SaveStatus: \\\"%s\\\"\", perr.Error()))\r\n\t\t}\r\n\t\treturn err\r\n\t}\r\n\r\n\treturn nil\r\n}\r\n```\r\n\r\n```\r\nimport (\r\n\t\"context\"\r\n\t\"testing\"\r\n\t\"time\"\r\n\r\n\t\"github.com/stretchr/testify/mock\"\r\n\t\"github.com/stretchr/testify/suite\"\r\n\t\"go.temporal.io/sdk/testsuite\"\r\n)\r\n\r\ntype CancelMeSuite struct {\r\n\tsuite.Suite\r\n\ttestsuite.WorkflowTestSuite\r\n}\r\n\r\nfunc TestCancel(t *testing.T) {\r\n\tsuite.Run(t, &CancelMeSuite{})\r\n}\r\n\r\nfunc (s *CancelMeSuite) TestCancel() {\r\n\tenv := s.NewTestWorkflowEnvironment()\r\n\tenv.OnActivity(CancelMe, mock.AnythingOfType(\"*context.timerCtx\"), \"\").\r\n\t\tReturn(func(ctx context.Context, _ string) (string, error) {\r\n\t\t\tenv.CancelWorkflow()\r\n\t\t\treturn \"mocked-return\", nil\r\n\t\t}).After(time.Minute)\r\n\r\n\tenv.RegisterWorkflow(SomeWorkflow)\r\n\tenv.RegisterActivity(CancelMe)\r\n\tenv.RegisterActivity(SaveStatus)\r\n\r\n\tenv.ExecuteWorkflow(SomeWorkflow)\r\n\ts.True(env.IsWorkflowCompleted())\r\n\ts.Error(env.GetWorkflowError())\r\n\r\n\tenv.AssertExpectations(s.T())\r\n        // sleep to see the output from SaveStatus\r\n\ttime.Sleep(5 * time.Second)\r\n}\r\n```\r\n \r\nThe log output will log the error, and then eventually print out the log message from the 2nd activity (`SaveStatus`) called with the already cancelled context.\r\n","createdAt":"2022-04-13T23:33:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/778#issuecomment-1098574227","viewerDidAuthor":false},{"id":"IC_kwDODN1w685BhFvc","author":{"login":"awsaba"},"authorAssociation":"NONE","body":"Follow up from Slack thread:\r\n\r\n> A couple of issues have potentially been observed with the workflow/activity test env:\r\n> \r\n>     1. A mocked activity may not return a value if the context is cancelled\r\n> \r\nBased on Maxim's responses in the Slack thread, this is expected. For our use case that would need the returned `&val` for a cleanup activity using a disconnected context, we are going to think about how else we can structure that.\r\n\r\n>     2. An activity called on the cancelled context for cleanup is immediately returning and still running the activity\r\n> \r\n>> The call is going to fail immediately without ever generating a ScheduleActivityTask command.\r\n\r\nI think this means that `ExecuteActivity` with a cancelled context in a workflow test should _not_ be executing the activity, WDYT?","createdAt":"2022-04-14T13:34:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/778#issuecomment-1099193308","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Biuaa","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"To clarify here... Based on my tests, if you don't respect cancellation in the activity, you won't return from `ExecuteActivity` here. You must heartbeat in activities to receive cancellation and you'll probably want a `HeartbeatTimeout` so you don't have to wait 15 seconds.\r\n\r\nSo basically if your activity was:\r\n\r\n```go\r\nfunc CancelMe(ctx context.Context, _ string) (string, error) {\r\n\tfor {\r\n\t\tactivity.RecordHeartbeat(ctx)\r\n\t\tselect {\r\n\t\tcase <-ctx.Done():\r\n\t\t\treturn \"long-running-result\", nil\r\n\t\tcase <-time.After(1 * time.Second):\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n\r\nThen `ExecuteActivity` would not return an error on cancel, it'd return the expected value. If you didn't have that mechanism but instead ignored the concept of heartbeat and cancellation, your activity could run until the end of time and cancellation would have no affect on it.\r\n\r\n> I think this means that `ExecuteActivity` with a cancelled context in a workflow test should _not_ be executing the activity, WDYT?\r\n\r\nAgreed. I will open a PR for this.","createdAt":"2022-04-14T21:07:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/778#issuecomment-1099622042","viewerDidAuthor":false},{"id":"IC_kwDODN1w685BqJ6r","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I have opened #780 to make sure activities invoked with a cancelled context are not started.","createdAt":"2022-04-18T17:04:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/778#issuecomment-1101569707","viewerDidAuthor":false},{"id":"IC_kwDODN1w685CF9Sr","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"We have merged #780 which has some fixes for this area. The next release may be in ~2 weeks. I am closing now, but reopen or comment if you think the PR doesn't address any specific activity + cancellation + test suite issues.","createdAt":"2022-04-25T17:42:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/778#issuecomment-1108858027","viewerDidAuthor":false},{"id":"IC_kwDODN1w685CF9vK","author":{"login":"awsaba"},"authorAssociation":"NONE","body":"@cretz Thanks!","createdAt":"2022-04-25T17:45:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/778#issuecomment-1108859850","viewerDidAuthor":false}],"createdAt":"2022-04-13T21:54:10Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":778,"reactionGroups":[],"state":"CLOSED","title":"Potential issue with activity mocking and cancellation","updatedAt":"2022-04-25T17:45:18Z","url":"https://github.com/temporalio/sdk-go/issues/778"}
