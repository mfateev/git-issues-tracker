{"assignees":[],"author":{"id":"U_kgDOBpttjA","is_bot":false,"login":"EllieSager-Forte","name":"Ellie A Sager"},"body":"## Expected Behavior\r\nInvocation count assertions provided by the mocking library, such as Once() or Times(n) should always fail a test if the assertion does not hold. The same should happen if an unexpected invocation occurs during a test.\r\n\r\n## Actual Behavior\r\nThis workflow has only one activity that is non-retry-able. Under test, it throws a PanicError in the logs when the code is executed and mock invocation is missing. Yet the test always succeeds with exit code 0.\r\n\r\n```\r\nerr := workflow.ExecuteActivity(\r\n  workflow.WithActivityOptions(ctx, workflow.ActivityOptions \r\n  {RetryPolicy: &temporal.RetryPolicy{MaximumAttempts: 1}}), \r\n  MyActivity).Get(ctx, nil) // what if we forget to mock \"MyActivity\" method??\r\n  \tif err != nil { log.Error(\"error in workflow, don't interrupt workflow!\", \"some message\", err.Error()) }\r\n```\r\n\r\nA test for the workflow should mock the activity to be invoked at least once, but a developer has forgotten to add the mock. Here is a line you might expect in a test, that is missing:`env.OnActivity(\"MyActivity\", any).Return(nil, errors.New(\"test failure\")).Once()`\r\nThis activity is configured with NO retries and even though logs correctly print a panic statement,  no error is returned and the test succeeds. Since workflow is set up to continue after the error, we end up with a workflow that succeeds and has no errors. So, [the method outlined here](https://github.com/temporalio/sdk-go/issues/642#issuecomment-1204102286): \"check no error happened inside the workflow by checking the workflow error\" - `s.assertions.NoError(s.env.GetWorkflowError())` - won't work.\r\n\r\nOne might argue that since we don't care if the activity fails inside our workflow, the workflow will always succeed and, therefore, the tests with the activity failing should be always marked as \"PASSED\". However, there is a difference between an activity failing in prod for a legitimate reason and activity failing due to a forgotten mock invocation. We definitely want to know about missing or incorrect mocks in our tests! Since your guys's code already detects discrepancies in mock calls, why don't we just mark the test as FAILED in this case?\r\n\r\nOR, alternatively, you can expose the `env.mock` field as suggested here: https://github.com/temporalio/sdk-go/issues/642#issuecomment-1203779650 or provide a setter for it.\r\n\r\nThis issue is being opened based on this conversation: https://temporalio.slack.com/archives/CTDTU3J4T/p1669935765304739 (long) and\r\nhttps://temporalio.slack.com/archives/CTDTU3J4T/p1669935765304739 (short)\r\n\r\n## Steps to Reproduce the Problem\r\nSee above\r\n\r\n## Specifications\r\n\r\n  - Version: temporal sdk@v1.16.0/testify@v1.8.0\r\n  - Platform: n/a\r\n","closedAt":null,"comments":[{"id":"IC_kwDODN1w685P1Poo","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> One might argue that since we don't care if the activity fails inside our workflow, the workflow will always succeed and, therefore, the tests with the activity failing should be always marked as \"PASSED\". However, there is a difference between an activity failing in prod for a legitimate reason and activity failing due to a forgotten mock invocation. We definitely want to know about missing or incorrect mocks in our tests! Since your guys's code already detects discrepancies in mock calls, why don't we just mark the test as FAILED in this case?\r\n\r\nDo you definitely want to know about missing or incorrect activities in production? The test is acting like production. If your workflow is built to not care about missing activities, it won't care about missing activities regardless of environment (or any other error).\r\n\r\nIf someone wants to test a missing activity behavior they can. It is important that our test environment fail similar to how production fails when you are missing an activity.\r\n\r\nYour workflow is written to run regardless of that activity, so one could argue there's no benefit to mocking it since your workflow doesn't care if it even ran. You'll never know whether you remember to even register that activity in production.","createdAt":"2022-12-06T13:14:46Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/975#issuecomment-1339357736","viewerDidAuthor":false}],"createdAt":"2022-12-06T00:36:01Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":975,"reactionGroups":[],"state":"OPEN","title":"Missing mock invocation causes PanicError in a test but the test succeeds with exit code 0.","updatedAt":"2022-12-06T13:18:34Z","url":"https://github.com/temporalio/sdk-go/issues/975"}
