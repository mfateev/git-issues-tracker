{"assignees":[],"author":{"id":"MDQ6VXNlcjE0NjM2MjI=","is_bot":false,"login":"mfateev","name":"Maxim Fateev"},"body":"## Expected Behavior\r\nWorkflow goroutines are never scheduled to run after the main workflow function returns.\r\n\r\n## Actual Behavior\r\n\r\nOther goroutines are given chance to execute after the main workflow function returns.\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nSee https://github.com/temporalio/samples-go/pull/255","closedAt":"2024-08-31T02:05:15Z","comments":[{"id":"IC_kwDODN1w685VsPqU","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"I wonder if we should consider it an error to have unfinished workflow goroutines once the main workflow function returns? ","createdAt":"2023-02-20T23:17:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1049#issuecomment-1437661844","viewerDidAuthor":false},{"id":"IC_kwDODN1w685VvV42","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> I wonder if we should consider it an error to have unfinished workflow goroutines once the main workflow function returns?\r\n\r\nNah, shouldn't even warn IMO. An unawaited promise/task in other languages make sense, but quite often Goroutines are fire-and-forget and/or just run forever waiting on a signal that will never come.\r\n\r\nNote, technically this may be a backwards incompatible change if a post-return coroutine updates a value a query may use.","createdAt":"2023-02-21T13:15:28Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1049#issuecomment-1438473782","viewerDidAuthor":false},{"id":"IC_kwDODN1w685VwnQu","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":">Goroutines are fire-and-forget and/or just run forever waiting on a signal that will never come\r\n\r\nWriting fire and forget goroutines is not safe, you have no guarantee it will run. you need something like a `waitgroup`. Also that sounds like a memory leak?\r\n\r\nYeah this does seem backwards incompatible. Currently we say our workflow goroutines have similar semantics to normal goroutines. normal goroutines do not stop executing if the parent stops.","createdAt":"2023-02-21T16:55:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1049#issuecomment-1438807086","viewerDidAuthor":false},{"id":"IC_kwDODN1w685VwyDD","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Writing fire and forget goroutines is not safe, you have no guarantee it will run\r\n\r\nThat may be ok with me as a user\r\n\r\n> Also that sounds like a memory leak?\r\n\r\nNah, IIRC we `runtime.Goexit` all goroutines belonging to a workflow.\r\n\r\n> Yeah this does seem backwards incompatible. Currently we say our workflow goroutines have similar semantics to normal goroutines. normal goroutines do not stop executing if the parent stops.\r\n\r\nIf you're looking for an analogy, it's not like a \"parent\" and more like a \"process\" IMO. I think workflow completion is like `os.Exit()`. But yes, if today we run coroutines after workflow complete we probably can't change without that SDK version marker thing.\r\n\r\nI think other SDKs may have this same \"problem\" (if we decide this is wrong behavior; starting to wonder). In Python I don't think I immediately stop all coroutines on the primary one completing. I just collect commands until all yielded/complete and send them back. I wonder how core reacts to a command coming after workflow completion. Will bring up at standup.","createdAt":"2023-02-21T17:28:34Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1049#issuecomment-1438851267","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Vw5tA","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":">Nah, IIRC we runtime.Goexit all goroutines belonging to a workflow.\r\n\r\nI'll have to look at the code, but if we do that means `defer` will still run.\r\n\r\n>If you're looking for an analogy, it's not like a \"parent\" and more like a \"process\" IMO. I think workflow completion is like os.Exit(). But yes, if today we run coroutines after workflow complete we probably can't change without that SDK version marker thing.\r\n\r\nhhm yeah if those are the semantics then nothing should be run after the workflow exit including `defer` statements. \r\n","createdAt":"2023-02-21T17:52:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/1049#issuecomment-1438882624","viewerDidAuthor":false},{"id":"IC_kwDODN1w686Kcgji","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Going to mark this as closed as with the addition of workflow update the current behaviour is desirable\r\n\r\nhttps://github.com/temporalio/features/issues/481 ","createdAt":"2024-08-31T02:05:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1049#issuecomment-2322729186","viewerDidAuthor":false}],"createdAt":"2023-02-20T19:45:25Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1049,"reactionGroups":[],"state":"CLOSED","title":"All workflow gorounies should never run after workflow method returns.","updatedAt":"2024-08-31T02:05:15Z","url":"https://github.com/temporalio/sdk-go/issues/1049"}
