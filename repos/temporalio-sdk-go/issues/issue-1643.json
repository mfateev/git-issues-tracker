{"assignees":[],"author":{"id":"MDQ6VXNlcjIyNzg5ODUx","is_bot":false,"login":"ndtretyak","name":"Nikolay Tretyak"},"body":"## Expected Behavior\r\nSearch attributes from `GetVersion` does not affect `OnUpsertSearchAttributes` mock\r\n\r\n## Actual Behavior\r\nTests fail if `UpsertSearchAttributes` calls from versioning are not mocked explicitly\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Use `GetVersion` and `UpsertSearchAttribute` in your workflow\r\n  1. Use `env.OnUpsertSearchAttribute` in a test to validate the arguments of `UpsertSearchAttributes`\r\n  1. Test will fail on unexpected calls to `UpsertSearchAttributes` made from `GetVersion`\r\n\r\n","closedAt":"2025-01-21T19:00:19Z","comments":[{"id":"IC_kwDODN1w686MvB6I","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Search attributes from `GetVersion` is intended to affect `OnUpsertSearchAttributes`. `OnUpsertSearchAttributes` is intended to be called on any upsert search attribute, which includes `GetVersion`. We should clarify in the docs that `OnUpsertSearchAttributes` will be used used for `GetVersion`","createdAt":"2024-09-19T14:23:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1643#issuecomment-2361138824","viewerDidAuthor":false},{"id":"IC_kwDODN1w686MwOqj","author":{"login":"ndtretyak"},"authorAssociation":"CONTRIBUTOR","body":"When multiple `GetVersion` calls are present across different branches of a workflow, mocking each `OnUpsertSearchAttributes` becomes challenging due to the accumulation of all previous `changeID`s in an unpredictable order.\r\n\r\nAdditionally, `getChangeVersions` is non-deterministic because it iterates over a map, and its result is used in the `UpsertSearchAttributes` call.\r\nhttps://github.com/temporalio/sdk-go/blob/82836041f24dca3bcc5b7de9973dcbd340602de4/internal/internal_event_handlers.go#L926","createdAt":"2024-09-19T16:15:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1643#issuecomment-2361453219","viewerDidAuthor":false},{"id":"IC_kwDODN1w686NW92y","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"You shouldn't need to assert the exact value of `changeID` if you are not interested in it. You should be able to use something like [MatchedBy](https://pkg.go.dev/github.com/stretchr/testify/mock#MatchedBy) to just match the key in the map.\r\n\r\n```\r\nenv.OnUpsertSearchAttributes(mock.MatchedBy(func(attr map[string]interface{}) bool {\r\n```","createdAt":"2024-09-24T15:17:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1643#issuecomment-2371607986","viewerDidAuthor":false},{"id":"IC_kwDODN1w686NXhCf","author":{"login":"ndtretyak"},"authorAssociation":"CONTRIBUTOR","body":"Thanks! This is exactly what I needed.","createdAt":"2024-09-24T16:19:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1643#issuecomment-2371752095","viewerDidAuthor":false}],"createdAt":"2024-09-19T13:06:59Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1643,"reactionGroups":[],"state":"CLOSED","title":"Ignore search attributes from GetVersion in mocks","updatedAt":"2025-01-21T19:00:19Z","url":"https://github.com/temporalio/sdk-go/issues/1643"}
