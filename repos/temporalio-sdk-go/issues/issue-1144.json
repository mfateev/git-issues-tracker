{"assignees":[],"author":{"id":"MDQ6VXNlcjE3NDYxNzQ1","is_bot":false,"login":"nitesh237","name":"Nitesh Gupta"},"body":"## Expected Behavior\r\nWhen replaying the mutable side-effect behind workflow versioning, the command should be generated in the same exact order as they were generated during the execution.\r\n\r\n## Actual Behavior\r\nWe are seeing non-determinism error while replaying due to missing mutable-side effect marker.\r\n\r\n```\r\nPanicError: lookup failed for scheduledEventID to activityID: scheduleEventID: 13, activityID: 13 \r\nprocess event for example-task-queue [panic]:\r\ngo.temporal.io/sdk/internal.panicIllegalState(...)\r\n\t/Users/nitesh/go/pkg/mod/go.temporal.io/sdk@v1.22.2/internal/internal_command_state_machine.go:455\r\ngo.temporal.io/sdk/internal.(*commandsHelper).handleActivityTaskScheduled(0x14001a315e0, {0x14001507798, 0x2}, 0x40?)\r\n\t/Users/nitesh/go/pkg/mod/go.temporal.io/sdk@v1.22.2/internal/internal_command_state_machine.go:1038 +0xf0\r\ngo.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).ProcessEvent(0x1400089ef90, 0x14001a29b00, 0x20?, 0x0)\r\n\t/Users/nitesh/go/pkg/mod/go.temporal.io/sdk@v1.22.2/internal/internal_event_handlers.go:1031 +0x248\r\ngo.temporal.io/sdk/internal.(*workflowExecutionContextImpl).ProcessWorkflowTask(0x140015fd3b0, 0x1400137c600)\r\n\t/Users/nitesh/go/pkg/mod/go.temporal.io/sdk@v1.22.2/internal/internal_task_handlers.go:962 +0xed0\r\ngo.temporal.io/sdk/internal.(*workflowTaskHandlerImpl).ProcessWorkflowTask(0x14000cd6c30, 0x1400137c600, 0x140018daa20)\r\n\t/Users/nitesh/go/pkg/mod/go.temporal.io/sdk@v1.22.2/internal/internal_task_handlers.go:780 +0x364\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).processWorkflowTask(0x14000ccc900, 0x1400137c600)\r\n\t/Users/nitesh/go/pkg/mod/go.temporal.io/sdk@v1.22.2/internal/internal_task_pollers.go:329 +0x2d0\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).ProcessTask(0x14000ccc900, {0x106c9dac0?, 0x1400137c600})\r\n\t/Users/nitesh/go/pkg/mod/go.temporal.io/sdk@v1.22.2/internal/internal_task_pollers.go:302 +0x70\r\ngo.temporal.io/sdk/internal.(*baseWorker).processTask(0x14000ca28c0, {0x106c9d640, 0x140019515a0})\r\n\t/Users/nitesh/go/pkg/mod/go.temporal.io/sdk@v1.22.2/internal/internal_worker_base.go:440 +0x15c\r\ncreated by go.temporal.io/sdk/internal.(*baseWorker).runTaskDispatcher\r\n\t/Users/nitesh/go/pkg/mod/go.temporal.io/sdk@v1.22.2/internal/internal_worker_base.go:334 +0x98\r\n```\r\n\r\n\r\n## Steps to Reproduce the Problem\r\nBelow sample workflow reproduces the non-determinism issue.\r\n```\r\n// Workflow is a Hello World workflow definition.\r\nfunc Workflow(ctx workflow.Context, name string) (string, error) {\r\n\tuid := \"\"\r\n\tlogger := workflow.GetLogger(ctx)\r\n\tlogger.Info(\"HelloWorld workflow started\", \"name\", name)\r\n\r\n\tv := workflow.GetVersion(ctx, \"mutable-side-effect-bug\", workflow.DefaultVersion, 1)\r\n\tif v == 1 {\r\n\t\tvar err error\r\n\t\tuid, err = generateUUID(ctx)\r\n\t\tif err != nil {\r\n\t\t\tlogger.Error(\"failed to generated uuid\", \"Error\", err)\r\n\t\t\treturn \"\", err\r\n\t\t}\r\n\r\n\t\tlogger.Info(\"generated uuid\", \"uuid-val\", uid)\r\n\t}\r\n\r\n\tao := workflow.ActivityOptions{\r\n\t\tStartToCloseTimeout: 10 * time.Second,\r\n\t}\r\n\tctx = workflow.WithActivityOptions(ctx, ao)\r\n\r\n\tvar result string\r\n\terr := workflow.ExecuteActivity(ctx, Activity, name).Get(ctx, &result)\r\n\tif err != nil {\r\n\t\tlogger.Error(\"Activity failed.\", \"Error\", err)\r\n\t\treturn \"\", err\r\n\t}\r\n\r\n\tlogger.Info(\"HelloWorld workflow completed.\", \"result\", result)\r\n\r\n\treturn uid, nil\r\n}\r\n\r\nfunc generateUUID(ctx workflow.Context) (string, error) {\r\n\tvar generatedUUID string\r\n\r\n\terr := workflow.MutableSideEffect(ctx, \"generate-random-uuid\", func(ctx workflow.Context) interface{} {\r\n\t\treturn uuid.NewString()\r\n\t}, func(a, b interface{}) bool {\r\n\t\treturn a.(string) == b.(string)\r\n\t}).Get(&generatedUUID)\r\n\tif err != nil {\r\n\t\treturn \"\", err\r\n\t}\r\n\r\n\treturn generatedUUID, nil\r\n}\r\n\r\nfunc Activity(ctx context.Context, name string) (string, error) {\r\n\tlogger := activity.GetLogger(ctx)\r\n\tlogger.Info(\"Activity\", \"name\", name)\r\n\treturn \"Hello \" + name + \"!\", nil\r\n}\r\n```\r\n\r\n## Specifications\r\nAs part of [this](https://github.com/temporalio/sdk-go/pull/809/files#diff-2977c91b9b6dd9d4ccf4c150ad6cb4b1c360334b5602cb3324d87769d7fe51e0R701) change, we are only recording side effect marker command while replaying based on lookup in `wc.mutableSideEffectsRecorded` map since mutable side-effect doesn't leave a marker in the history always. \r\nThis works in a normal scenario, however, there is a catch, it seems while replaying `workflow.GetVersion` doesn’t generate a command [explicitly](https://github.com/temporalio/sdk-go/blob/ae9ed7bebea6d1a371f20417f053c5d28730e365/internal/internal_event_handlers.go#L775) (don’t know the reason). This is leading to a wrong lookup in `wc.mutableSideEffectsRecorded` specifically due to the wrong value in `wc.commandsHelper.nextCommandEventID`. This is leading to missing marker command while replaying.\r\n\r\n  - Version:\r\n  1.22.2, however, the bug seems to exist in 1.23.0 as well.\r\n  \r\n","closedAt":"2023-06-23T17:59:23Z","comments":[],"createdAt":"2023-06-16T19:53:18Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1144,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"Non-determinism while replaying mutable side-effect behind workflow versioning ","updatedAt":"2023-06-23T17:59:23Z","url":"https://github.com/temporalio/sdk-go/issues/1144"}
