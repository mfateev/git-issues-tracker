{"assignees":[],"author":{"id":"U_kgDOBkYHNA","is_bot":false,"login":"mattpercy-anz","name":"Matthew Percy"},"body":"## Expected Behavior\r\nRunning a workflow replay should succeed if there have been no workflow/activity code changes, but are run on different Go versions\r\n\r\n## Actual Behavior\r\nReplays can fail once the Go version changes\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nThis occurs due to the protojson serialisation of the workflow results in the payload struct:\r\n  https://github.com/temporalio/sdk-go/blob/master/internal/internal_worker.go#L1290\r\nThe proto equal in the replayer is comparing the byte array of the marshalled workflow result. But due to a \"feature\" in the protojson encoder, a random space is sometimes prepended before fields when marshalling (see [here](https://github.com/protocolbuffers/protobuf-go/commit/582ab3de426ef0758666e018b422dd20390f7f26), [here](https://github.com/protocolbuffers/protobuf-go/blob/master/internal/encoding/json/encode.go#L239) and [here](https://github.com/protocolbuffers/protobuf-go/blob/master/internal/encoding/json/encode.go#L272)). This is dependant on your Go version (see [here](https://github.com/protocolbuffers/protobuf-go/blob/master/internal/detrand/rand.go#L40)), and only occurs when the protojson output is multiline.\r\n\r\nA workaround would be to create a custom data converter in order to ensure we had payloads encoded in a way that was consistent regardless of Go version. However, I raise this issue because this is an obscure problem that isn't made clear to the users of temporal, and we had hoped to use the replay function to help regression test our workflows and ensure backwards compatibility.\r\n\r\nMy request is that the replay code allow us to perform the final workflow result equality ourselves, that way we could pull the results out and compare the decoded data, rather than proto comparing the two payloads and potentially flagging a \"failed\" replay, though the results are actually the same.\r\n\r\nFor testing this, I made a small change to the helloworld sample code (I can provide my changes if need be) to return a proto struct instead of a string, and recorded the results, one replay file from a workflow ran on Go 1.18.9:\r\n```\r\n\"result\": {\r\n          \"payloads\": [\r\n            {\r\n              \"metadata\": {\r\n                \"encoding\": \"anNvbi9wcm90b2J1Zg==\",\r\n                \"messageType\": \"VGVzdEhvbGRlcg==\"\r\n              },\r\n              \"data\": \"eyJ0ZXN0cyI6W3sidGVzdElkIjoiSGVsbG8gVGVtcG9yYWwhIn0sIHsidGVzdElkIjoiSGVsbG8gVGVtcG9yYWwhIn0sIHsidGVzdElkIjoiSGVsbG8gVGVtcG9yYWwhIn0sIHsidGVzdElkIjoiSGVsbG8gVGVtcG9yYWwhIn0sIHsidGVzdElkIjoiSGVsbG8gVGVtcG9yYWwhIn0sIHsidGVzdElkIjoiSGVsbG8gVGVtcG9yYWwhIn0sIHsidGVzdElkIjoiSGVsbG8gVGVtcG9yYWwhIn0sIHsidGVzdElkIjoiSGVsbG8gVGVtcG9yYWwhIn0sIHsidGVzdElkIjoiSGVsbG8gVGVtcG9yYWwhIn0sIHsidGVzdElkIjoiSGVsbG8gVGVtcG9yYWwhIn1dfQ==\"\r\n            }\r\n          ]\r\n        },\r\n```\r\nAnd the other on Go 1.19.4:\r\n```\r\n\"result\": {\r\n          \"payloads\": [\r\n            {\r\n              \"metadata\": {\r\n                \"encoding\": \"anNvbi9wcm90b2J1Zg==\",\r\n                \"messageType\": \"VGVzdEhvbGRlcg==\"\r\n              },\r\n              \"data\": \"eyJ0ZXN0cyI6W3sidGVzdElkIjoiSGVsbG8gVGVtcG9yYWwhIn0seyJ0ZXN0SWQiOiJIZWxsbyBUZW1wb3JhbCEifSx7InRlc3RJZCI6IkhlbGxvIFRlbXBvcmFsISJ9LHsidGVzdElkIjoiSGVsbG8gVGVtcG9yYWwhIn0seyJ0ZXN0SWQiOiJIZWxsbyBUZW1wb3JhbCEifSx7InRlc3RJZCI6IkhlbGxvIFRlbXBvcmFsISJ9LHsidGVzdElkIjoiSGVsbG8gVGVtcG9yYWwhIn0seyJ0ZXN0SWQiOiJIZWxsbyBUZW1wb3JhbCEifSx7InRlc3RJZCI6IkhlbGxvIFRlbXBvcmFsISJ9LHsidGVzdElkIjoiSGVsbG8gVGVtcG9yYWwhIn1dfQ==\"\r\n            }\r\n          ]\r\n        },\r\n```\r\nIf you base64 decode the data, you'll see that the only difference is whitespace.\r\n\r\nVery happy to provide any extra information for this. Thanks!\r\n\r\n## Specifications\r\n\r\n  - Version: go.temporal.io/sdk v1.18.1, https://hub.docker.com/r/temporalio/auto-setup 1.17.4\r\n  - Platform: Mac OS 12.6.1\r\n","closedAt":"2023-01-30T06:52:10Z","comments":[{"id":"IC_kwDODN1w685P7T_z","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"This is interesting! I was not aware that `protojson` was _intentionally_ made non-deterministic. We need to check other places that we do byte-for-byte payload comparison on mismatch (especially once we fix #876). Though I think that's only on workflow complete too when reading `isCommandMatchEvent`.\r\n\r\nA custom check on workflow complete may not be robust enough. What I think we should probably do is if the payload encoding is `json/*`, we should JSON unmarshal into `interface{}` and `reflect.DeepEqual` those.","createdAt":"2022-12-07T13:13:38Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/978#issuecomment-1340948467","viewerDidAuthor":false},{"id":"IC_kwDODN1w685QJLWG","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"@cretz I think we should also remove [this](https://github.com/temporalio/sdk-go/blob/66eb848f196bef644809a86903732762524be6e6/internal/internal_event_handlers.go#L802) use of `proto.equal` used while processing events. It shouldn't cause any non determinism as it is used today but someone could easily misuse it in the future. ","createdAt":"2022-12-09T17:40:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/978#issuecomment-1344583046","viewerDidAuthor":false},{"id":"IC_kwDODN1w685QJO88","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Note, that's only for checking against encoded `nil` which by default is encoded as `\"null\"`, so it's probably safe.\r\n\r\nConcur in general, we should never compare `json/*` payloads by bytes again. We should have a helper that does a JSON equality for JSON encoding and byte comparison otherwise.\r\n\r\nNote, technically proto binary marshalling is non-deterministic too I believe. But you have to opt-in to using proto binary conversion in our SDKs. But you can't do a structural comparison without the actual types to deserialize to like you can in JSON. So we may just need to add this as a note/caveat.\r\n\r\nAnd really, we need to stop using payload comparison anyways. I don't believe we need to check input/output _data_ (replayer or during replay). And for mutable side effect, it's just for `nil` that we're using proto equality, otherwise we do use their equals checker.","createdAt":"2022-12-09T17:55:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/978#issuecomment-1344597820","viewerDidAuthor":false},{"id":"IC_kwDODN1w685QJTnn","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":">And really, we need to stop using payload comparison anyways. I don't believe we need to check input/output data (replayer or during replay). \r\n\r\nAgreed. Other than the one posted and tests we do a lot in [isCommandMatchEvent](https://github.com/temporalio/sdk-go/blob/v1.19.0/internal/internal_task_handlers.go#L1276) they are mostly protected by `strictMode ` always being `false` (and looking back on the git history can't find when it was ever used). We should probably remove this option and any checks controlled by it OR expose it and only enable wen run from the replayer (we'd also need to fix how we compare payloads as well in this case)\r\n\r\n\r\n","createdAt":"2022-12-09T18:16:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/978#issuecomment-1344616935","viewerDidAuthor":false},{"id":"IC_kwDODN1w685QJTyP","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Concur on removing the strict option. Not sure why it's there either.","createdAt":"2022-12-09T18:17:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/978#issuecomment-1344617615","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Qdnoh","author":{"login":"mattpercy-anz"},"authorAssociation":"CONTRIBUTOR","body":"> I don't believe we need to check input/output data (replayer or during replay)\r\n\r\nIf you were to stop verifying input/output, will that also mean that the replayer won't flag a difference between a workflow returning a valid response vs one returning an error? If so, that will make using the replayer even less desirable.\r\n\r\nWe need to ensure workflow changes are deterministic, and work correctly when we use workflow versioning. Ideally we would have unit tests to cover version variations, but the test suite doesn't allow setting the workflow version.\r\n\r\nPlease correct me if i'm misunderstanding, or there's an alternate way to cover this type of workflow testing.\r\n\r\nThanks","createdAt":"2022-12-13T22:44:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/978#issuecomment-1349941793","viewerDidAuthor":false},{"id":"IC_kwDODN1w685QeKda","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> If you were to stop verifying input/output, will that also mean that the replayer won't flag a difference between a workflow returning a valid response vs one returning an error?\r\n\r\nIt's just not verifying the contents of the return. Fail and success are different commands and would mismatch properly.","createdAt":"2022-12-13T23:49:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/978#issuecomment-1350084442","viewerDidAuthor":false},{"id":"IC_kwDODN1w685T7aAd","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Resolved as part of https://github.com/temporalio/sdk-go/pull/990","createdAt":"2023-01-30T06:52:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/978#issuecomment-1408081949","viewerDidAuthor":false}],"createdAt":"2022-12-07T10:59:38Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":978,"reactionGroups":[],"state":"CLOSED","title":"Replay results inconsistent between Go versions","updatedAt":"2023-01-30T06:52:10Z","url":"https://github.com/temporalio/sdk-go/issues/978"}
