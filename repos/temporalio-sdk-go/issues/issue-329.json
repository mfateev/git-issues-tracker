{"assignees":[],"author":{"id":"MDQ6VXNlcjM2NTYxMQ==","is_bot":false,"login":"shaunco","name":"Shaun"},"body":"## Expected Behavior\r\nAfter switching to v1.3.0 of the sdk-go package, we started getting `Potential deadlock detected: workflow goroutine \"root\" didn't yield for over a second` panics on `ExecuteLocalActivity()` calls. Happens about 9 out of 10 times, but seems to randomly succeed that 10th time. All is good if I switch back to v1.2.0.\r\n\r\n```\r\n4:57PM INF Started Worker%!(EXTRA string=Namespace, string=default, string=TaskQueue, string=MY_TASK_QUEUE, string=WorkerID, string=48528@MYMACHINE@)\r\n4:57PM ERR Workflow panic%!(EXTRA string=Namespace, string=default, string=TaskQueue, string=MY_TASK_QUEUE, string=WorkerID, string=48528@MYMACHINE@, string=WorkflowType, string=MyService.Create, string=WorkflowID, string=MyService.Create-workflow-1f309338-a827-4f34-8035-efc22fdd8fa5, string=RunID, string=bb53d3e1-9ba4-447f-825f-4f0eeb3ad2e1, string=Attempt, int32=5, string=Error, *internal.workflowPanicError=Potential deadlock detected: workflow goroutine \"root\" didn't yield for over a second, string=StackTrace, string=process event for MY_TASK_QUEUE [panic]:\r\ngo.temporal.io/sdk/internal.(*coroutineState).call(0xc00059b270)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.3.0/internal/internal_workflow.go:874 +0x35e\r\ngo.temporal.io/sdk/internal.(*dispatcherImpl).ExecuteUntilAllBlocked(0xc00059b220, 0x0, 0x0)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.3.0/internal/internal_workflow.go:959 +0x53f\r\ngo.temporal.io/sdk/internal.executeDispatcher(0x2044d60, 0xc00059cec0, 0x20490a0, 0xc00059b220)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.3.0/internal/internal_workflow.go:566 +0x87\r\ngo.temporal.io/sdk/internal.(*syncWorkflowDefinition).OnWorkflowTaskStarted(0xc00059ce80)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.3.0/internal/internal_workflow.go:539 +0x78\r\ngo.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).ProcessEvent(0xc000700460, 0xc00055a4c0, 0x26b0100, 0x0, 0x0)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.3.0/internal/internal_event_handlers.go:791 +0x60e\r\ngo.temporal.io/sdk/internal.(*workflowExecutionContextImpl).ProcessWorkflowTask(0xc0005ab170, 0xc000453d70, 0x0, 0x0, 0x0, 0x0)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.3.0/internal/internal_task_handlers.go:876 +0xcb2\r\ngo.temporal.io/sdk/internal.(*workflowTaskHandlerImpl).ProcessWorkflowTask(0xc000332fd0, 0xc000453d70, 0xc000694330, 0x0, 0x0, 0x0, 0x0)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.3.0/internal/internal_task_handlers.go:727 +0x6bf\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).processWorkflowTask(0xc000092750, 0xc000453d70, 0x0, 0x0)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.3.0/internal/internal_task_pollers.go:288 +0x36e\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).ProcessTask(0xc000092750, 0x1cb6040, 0xc000453d70, 0x0, 0x0)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.3.0/internal/internal_task_pollers.go:259 +0x10b\r\ngo.temporal.io/sdk/internal.(*baseWorker).processTask(0xc0002bc000, 0x1cb6040, 0xc000453d70)\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.3.0/internal/internal_worker_base.go:343 +0x1a2\r\ncreated by go.temporal.io/sdk/internal.(*baseWorker).runTaskDispatcher\r\n\t/go/pkg/mod/go.temporal.io/sdk@v1.3.0/internal/internal_worker_base.go:270 +0x3ac)\r\n4:57PM WRN Failed to process workflow task.%!(EXTRA string=Namespace, string=default, string=TaskQueue, string=MY_TASK_QUEUE, string=WorkerID, string=48528@MYMACHINE@, string=WorkflowType, string=MyService.Create, string=WorkflowID, string=MyService.Create-workflow-1f309338-a827-4f34-8035-efc22fdd8fa5, string=RunID, string=bb53d3e1-9ba4-447f-825f-4f0eeb3ad2e1, string=Attempt, int32=5, string=Error, *internal.workflowPanicError=Potential deadlock detected: workflow goroutine \"root\" didn't yield for over a second)\r\n```\r\n\r\n## Actual Behavior\r\n`ExecuteLocalActivity()` should consistently work\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n1. Execute a workflow that executes a local activity\r\n\r\n(will add more details if discovered)\r\n\r\n## Specifications\r\n\r\n  - Version: SDK 1.3.0, Temporal Server 1.5.1\r\n  - Platform: Ubuntu\r\n","closedAt":"2021-01-12T20:34:48Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDc1ODM2NTkzOA==","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"This is thrown when a workflow thread is blocked for over a second. Workflow threads are not allowed to do any RPC and use any Go language synchronization primitives. So it usually indicates the problem in the workflow code. Are you making any RPC calls from the workflow or use any other primitives that are not allowed?\r\n\r\nI believe just executing a local activity is not enough to cause this issue.\r\n","createdAt":"2021-01-12T03:12:30Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/329#issuecomment-758365938","viewerDidAuthor":true},{"id":"MDEyOklzc3VlQ29tbWVudDc1ODg0NDgyOA==","author":{"login":"shaunco"},"authorAssociation":"NONE","body":"The workflow had no code prior to executing the local activity. A previous execution of the workflow had failed (debugger stopped the process), and the workflow was being re-executed by Temporal.","createdAt":"2021-01-12T18:16:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/329#issuecomment-758844828","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1ODg0NTQ0Mw==","author":{"login":"shaunco"},"authorAssociation":"NONE","body":"Perhaps the workflow thread was blocked by Delve, via a breakpoint that had been set? Was this blocked thread detection newly added in 1.3.0?","createdAt":"2021-01-12T18:17:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/329#issuecomment-758845443","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1ODg2NzQyNA==","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"Yes, blocking the workflow thread on breakpoint would cause the deadlock detector to fire. The https://github.com/temporalio/sdk-go/pull/330 introduced the TEMPORAL_DEBUG environment variable that can be used to disable the deadlock detector for debugging purposes. ","createdAt":"2021-01-12T18:57:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/329#issuecomment-758867424","viewerDidAuthor":true},{"id":"MDEyOklzc3VlQ29tbWVudDc1ODg5MjI4Nw==","author":{"login":"shaunco"},"authorAssociation":"NONE","body":"Great! We'll stay with 1.2.0 until #330 makes it in to a future release.","createdAt":"2021-01-12T19:44:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/329#issuecomment-758892287","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDc1ODkzODY3OQ==","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"Resolving as #330 provides a solution for debugging.","createdAt":"2021-01-12T20:34:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/329#issuecomment-758938679","viewerDidAuthor":true},{"id":"IC_kwDODN1w685XUIJ7","author":{"login":"jatins"},"authorAssociation":"NONE","body":"If you, like me, are using temporal with Bazel and passing `--test_env=TEMPORAL_DEBUG=true` basel flag, or `os.Setenv('TEMPORAL_DEBUG', true)` aren't working, then this is for you\r\n\r\n\r\n```diff\r\ns.env = s.NewTestWorkflowEnvironment() // s is testify suite\r\n\r\n+ workerOptions := worker.Options{DeadlockDetectionTimeout: 5 * time.Minute}\r\n+ s.env.SetWorkerOptions(workerOptions)\r\n```","createdAt":"2023-03-11T11:49:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/329#issuecomment-1464894075","viewerDidAuthor":false}],"createdAt":"2021-01-08T01:04:56Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":329,"reactionGroups":[],"state":"CLOSED","title":"Potential deadlock detected: workflow goroutine \"root\" didn't yield for over a second","updatedAt":"2023-03-11T11:49:05Z","url":"https://github.com/temporalio/sdk-go/issues/329"}
