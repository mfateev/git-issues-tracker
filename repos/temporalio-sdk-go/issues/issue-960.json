{"assignees":[{"id":"MDQ6VXNlcjIwNTA0MDQ5","login":"Quinn-With-Two-Ns","name":"Quinn Klassen","databaseId":0}],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"## Expected Behavior\r\n\r\nThe same log statements in workflow and activity should be at the same stack depth so that a shared caller-skip (e.g. in Zap or Zerolog) can work for both.\r\n\r\n## Actual Behavior\r\n\r\nWe wrap the workflow logger in a replay safe version which properly skips logs during replay. The problem is this adds an extra stack frame for just workflows. We should either: 1) wrap activities in a similar fashion, or 2) stop using a wrapped replayer, or 3) have a `interface WithSkipCallers { AddCallerSkip(int) }` interface that loggers can implement.\r\n\r\nOnly 3 is backwards compatible. 1 or 2 could break existing user expectations.\r\n\r\n## Replication\r\n\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"fmt\"\r\n\t\"log\"\r\n\t\"os\"\r\n\t\"time\"\r\n\r\n\t\"github.com/google/uuid\"\r\n\t\"github.com/rs/zerolog\"\r\n\t\"go.temporal.io/sdk/activity\"\r\n\t\"go.temporal.io/sdk/client\"\r\n\tsdklog \"go.temporal.io/sdk/log\"\r\n\t\"go.temporal.io/sdk/worker\"\r\n\t\"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\nfunc main() {\r\n\tif err := run(); err != nil {\r\n\t\tlog.Fatal(err)\r\n\t}\r\n}\r\n\r\nfunc run() error {\r\n\tctx, cancel := context.WithCancel(context.Background())\r\n\tdefer cancel()\r\n\r\n\tlog.Printf(\"Creating client\")\r\n\tlogWriter := zerolog.ConsoleWriter{Out: os.Stdout, TimeFormat: zerolog.TimeFormatUnix}\r\n\t// We add 3 more to the skip count because we are in our log\r\n\t// TODO(cretz): We need 3 for workflows but only 2 for activities because\r\n\t// workflows add an extra wrapping which increases the stack depth\r\n\tskipLogFrameCount := zerolog.CallerSkipFrameCount + 3\r\n\tc, err := client.Dial(client.Options{\r\n\t\tLogger: &ZeroLogLogger{\r\n\t\t\tzerolog.New(logWriter).With().CallerWithSkipFrameCount(skipLogFrameCount).Timestamp().Logger(),\r\n\t\t},\r\n\t})\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"failed creating client: %w\", err)\r\n\t}\r\n\tdefer c.Close()\r\n\r\n\tlog.Printf(\"Starting worker\")\r\n\ttaskQueue := uuid.NewString()\r\n\tw := worker.New(c, taskQueue, worker.Options{})\r\n\tw.RegisterWorkflow(MyWorkflow)\r\n\tw.RegisterActivity(MyActivity)\r\n\tif err := w.Start(); err != nil {\r\n\t\treturn fmt.Errorf(\"failed starting worker client: %w\", err)\r\n\t}\r\n\tdefer w.Stop()\r\n\r\n\tlog.Printf(\"Starting workflow\")\r\n\trun, err := c.ExecuteWorkflow(ctx, client.StartWorkflowOptions{TaskQueue: taskQueue}, MyWorkflow)\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"failed starting workflow: %w\", err)\r\n\t}\r\n\r\n\t// Wait for complete\r\n\treturn run.Get(ctx, nil)\r\n}\r\n\r\nfunc MyWorkflow(ctx workflow.Context) error {\r\n\tworkflow.GetLogger(ctx).Info(\"Workflow started\")\r\n\treturn workflow.ExecuteActivity(\r\n\t\tworkflow.WithActivityOptions(ctx, workflow.ActivityOptions{ScheduleToCloseTimeout: 1 * time.Minute}),\r\n\t\tMyActivity,\r\n\t).Get(ctx, nil)\r\n}\r\n\r\nfunc MyActivity(ctx context.Context) error {\r\n\tactivity.GetLogger(ctx).Info(\"Activity started\")\r\n\treturn nil\r\n}\r\n\r\ntype ZeroLogLogger struct{ underlying zerolog.Logger }\r\n\r\nvar _ sdklog.WithLogger = &ZeroLogLogger{}\r\n\r\nfunc (z *ZeroLogLogger) Debug(msg string, keyvals ...interface{}) {\r\n\tlogEvent(z.underlying.Debug(), msg, keyvals...)\r\n}\r\n\r\nfunc (z *ZeroLogLogger) Info(msg string, keyvals ...interface{}) {\r\n\tlogEvent(z.underlying.Info(), msg, keyvals...)\r\n}\r\n\r\nfunc (z *ZeroLogLogger) Warn(msg string, keyvals ...interface{}) {\r\n\tlogEvent(z.underlying.Warn(), msg, keyvals...)\r\n}\r\n\r\nfunc (z *ZeroLogLogger) Error(msg string, keyvals ...interface{}) {\r\n\tlogEvent(z.underlying.Error(), msg, keyvals...)\r\n}\r\n\r\nfunc (z *ZeroLogLogger) With(keyvals ...interface{}) sdklog.Logger {\r\n\treturn &ZeroLogLogger{z.underlying.With().Fields(keyvals).Logger()}\r\n}\r\n\r\nfunc logEvent(e *zerolog.Event, msg string, keyvals ...interface{}) {\r\n\tif len(keyvals) > 0 {\r\n\t\te = e.Fields(keyvals)\r\n\t}\r\n\t// We have previously set caller skip frames to work with this\r\n\te.Caller().Msg(msg)\r\n}\r\n```","closedAt":"2023-09-01T14:09:00Z","comments":[{"id":"IC_kwDODN1w685YECrD","author":{"login":"Multiply"},"authorAssociation":"NONE","body":"We've been trying to work around this with zap since we started out with Temporal as well.\r\n\r\nWhat is the easiest path forward, if we'd like to contribute a workaround or fix?","createdAt":"2023-03-21T08:44:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/960#issuecomment-1477454531","viewerDidAuthor":false},{"id":"IC_kwDODN1w685YE_4v","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@Quinn-With-Two-Ns - thoughts on a `WithSkipCallers` interface in https://pkg.go.dev/go.temporal.io/sdk/log?","createdAt":"2023-03-21T11:54:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/960#issuecomment-1477705263","viewerDidAuthor":false},{"id":"IC_kwDODN1w685YGzFD","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"@cretz so the idea is `WithSkipCallers` returns a new logger that skips more frames and we would check for this interface when creating the logger in certain places ?","createdAt":"2023-03-21T16:30:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/960#issuecomment-1478177091","viewerDidAuthor":false},{"id":"IC_kwDODN1w685YG92r","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@Quinn-With-Two-Ns - Yes. I can think of only two places: workflow and activity execution start. I think a test can confirm https://pkg.go.dev/runtime#Caller, w/ the set number of skips inside the a log statement in activity and workflow, returns the expected frame/file/whatever.\r\n\r\nCan call it `WithCallerSkip` instead, that may be clearer to read.\r\n\r\nWe should also update https://github.com/temporalio/samples-go/blob/dc35150cd901e0a20c107a42a3b5506b544b355d/zapadapter/zap_adapter.go#L40-L42","createdAt":"2023-03-21T16:45:26Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/960#issuecomment-1478221227","viewerDidAuthor":false},{"id":"IC_kwDODN1w685YHDbT","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Why can't users intercept `GetLogger` calls in workflows and activities to set different  amounts in workflows vs activities?","createdAt":"2023-03-21T16:51:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/960#issuecomment-1478244051","viewerDidAuthor":false},{"id":"IC_kwDODN1w685YHNKn","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"My concern is that we don't use `GetLogger` for our _own_ logging internally or that the interceptor isn't ready for all uses. But if you can 1) confirm or make sure we do (at least for the logger stored on these contexts that are used internally once the interceptor is ready), and 2) update the sample showing how to do it, I think that would be good enough. I think workflow not found, task failure, and panic would be good example logs to confirm.\r\n\r\nEDIT: Hrmm, arguably you don't need log skip at some of those early times. Would be worth checking. But yes, a sample update showing that interceptors reasonably skip frames as needed is probably good enough.","createdAt":"2023-03-21T17:10:37Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/960#issuecomment-1478283943","viewerDidAuthor":false},{"id":"IC_kwDODN1w685YNsto","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"hm testing `GetLogger` since the workflow logger is wrapped it is not possible to set the skip level.\r\n\r\nI don't like ``WithSkipCallers` just because it seems arbitrary where the SDK is skipping. I would prefer wrapping activities so the skip depth is the same, but I wouldn't die on that hill.","createdAt":"2023-03-22T17:31:04Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/960#issuecomment-1479986024","viewerDidAuthor":false},{"id":"IC_kwDODN1w685YOLz2","author":{"login":"Multiply"},"authorAssociation":"NONE","body":"Maybe split the logger into one for internals, one for workflows and one for activities? If none is defined, fall back to the current logger, so there's no backwards breaking changes.","createdAt":"2023-03-22T19:05:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/960#issuecomment-1480113398","viewerDidAuthor":false},{"id":"IC_kwDODN1w685YO1hz","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> I would prefer wrapping activities so the skip depth is the same, but I wouldn't die on that hill.\r\n\r\nJust realized people already are setting skip-caller for their activity logger with certain expectations, so this wouldn't work.\r\n\r\n> Maybe split the logger into one for internals, one for workflows and one for activities? If none is defined, fall back to the current logger, so there's no backwards breaking changes.\r\n\r\nI don't think it's worth multiple entirely new options for this skip-caller use case.\r\n\r\nI can only think of `type WithCallerSkip interface { Logger WithCallerSkip(int) }` at the moment.","createdAt":"2023-03-22T21:27:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/960#issuecomment-1480284275","viewerDidAuthor":false},{"id":"IC_kwDODN1w685kcuhg","author":{"login":"debuggerpk"},"authorAssociation":"CONTRIBUTOR","body":"> I don't think it's worth multiple entirely new options for this skip-caller use case.\r\n\r\nThe typescript sdk has multiple entry points for logging.\r\n","createdAt":"2023-08-20T10:48:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/960#issuecomment-1685252192","viewerDidAuthor":false},{"id":"IC_kwDODN1w685kgrjv","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> The typescript sdk has multiple entry points for logging.\r\n\r\nNot following exactly what is meant by \"entry points\". TypeScript has ways to access loggers from activities and workflows same as Go, but has a global runtime set logger as opposed to per client in Go (TS also has to use sinks and other confusing concepts due to its sandbox and how it forwards Rust logs, both of which are not related to Go SDK).\r\n\r\nYou can of course use custom logging in your activities and workflows (though you should skip logging from a workflow when replaying).","createdAt":"2023-08-21T13:02:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/960#issuecomment-1686288623","viewerDidAuthor":false}],"createdAt":"2022-11-17T17:23:24Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":960,"reactionGroups":[],"state":"CLOSED","title":"Loggers use different stack depths when being called from workflow vs activity","updatedAt":"2023-09-01T14:09:00Z","url":"https://github.com/temporalio/sdk-go/issues/960"}
