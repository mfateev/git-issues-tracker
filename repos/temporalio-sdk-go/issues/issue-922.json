{"assignees":[],"author":{"id":"MDQ6VXNlcjYwOTIyMw==","is_bot":false,"login":"Drahflow","name":"Jens-Wolfhard Schicke-Uffmann"},"body":"## Expected Behavior\r\n\r\nTesting a workflow which signals external workflows should work, even if the signal data is modified later in the workflow.\r\n\r\n## Actual Behavior\r\n\r\nIt does not (reliably), specifically data-races such as this can be observed (occasionally):\r\n\r\n```\r\n==================\r\nWARNING: DATA RACE\r\nRead at 0x00c000515190 by goroutine 113:\r\n  reflect.typedmemmove()\r\n      /usr/lib/go-1.19/src/runtime/mbarrier.go:178 +0x0\r\n[...]\r\n  github.com/stretchr/testify/mock.Arguments.Diff()\r\n      /home/drahflow/go/pkg/mod/github.com/stretchr/testify@v1.8.0/mock/mock.go:883 +0x18e\r\n  github.com/stretchr/testify/mock.(*Mock).findExpectedCall()\r\n      /home/drahflow/go/pkg/mod/github.com/stretchr/testify@v1.8.0/mock/mock.go:355 +0x146\r\n  github.com/stretchr/testify/mock.(*Mock).MethodCalled()\r\n      /home/drahflow/go/pkg/mod/github.com/stretchr/testify@v1.8.0/mock/mock.go:460 +0xb9\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).SignalExternalWorkflow.func2()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/internal_workflow_testsuite.go:2118 +0x329\r\n\r\nPrevious write at 0x00c000515190 by goroutine 97:\r\n  github.com/payrails/demo/pkg/merchant/workflows/consumer_checkout.cancelPaymentMethods.func1.2()\r\n      /work/pkg/merchant/workflows/consumer_checkout/main.go:829 +0xfc\r\n[...]\r\n\r\nGoroutine 113 (running) created at:\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).SignalExternalWorkflow()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/internal_workflow_testsuite.go:2115 +0x396\r\n  go.temporal.io/sdk/internal.signalExternalWorkflow()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/workflow.go:1077 +0x46e\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).SignalExternalWorkflow()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/workflow.go:1040 +0xc4\r\n  go.temporal.io/sdk/internal.SignalExternalWorkflow()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/workflow.go:1035 +0x20d\r\n  go.temporal.io/sdk/workflow.SignalExternalWorkflow()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/workflow/workflow.go:221 +0x171\r\n  github.com/payrails/demo/pkg/merchant/workflows/consumer_checkout.(*Channel[...]).Reply()\r\n      /work/pkg/merchant/workflows/consumer_checkout/channels.go:91 +0x66\r\n  github.com/payrails/demo/pkg/merchant/workflows/consumer_checkout.waitForFinalize.func1()\r\n      /work/pkg/merchant/workflows/consumer_checkout/main.go:725 +0x271\r\n  github.com/payrails/demo/pkg/merchant/workflows/consumer_checkout.(*Channel[...]).OnSignal.func1()\r\n      /work/pkg/merchant/workflows/consumer_checkout/channels.go:57 +0x11a\r\n  go.temporal.io/sdk/internal.(*selectorImpl).Select.func2.1()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/internal_workflow.go:1158 +0xa1\r\n  go.temporal.io/sdk/internal.(*selectorImpl).Select()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/internal_workflow.go:1253 +0x120d\r\n[...]\r\n\r\nGoroutine 97 (running) created at:\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/internal_workflow.go:981 +0x65a\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).Go()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/internal_workflow.go:299 +0x86\r\n  go.temporal.io/sdk/internal.newDispatcher()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/internal_workflow.go:598 +0x282\r\n  go.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/internal_workflow.go:488 +0x1c4\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeWorkflowInternal.func1()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/internal_workflow_testsuite.go:486 +0xc2\r\n  go.temporal.io/sdk/internal.(*testCallbackHandle).processCallback()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/internal_workflow_testsuite.go:732 +0xfb\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).startMainLoop()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/internal_workflow_testsuite.go:672 +0x2a4\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeWorkflowInternal()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/internal_workflow_testsuite.go:508 +0x4f1\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeWorkflow()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/internal_workflow_testsuite.go:452 +0x1cc\r\n  go.temporal.io/sdk/internal.(*TestWorkflowEnvironment).ExecuteWorkflow()\r\n      /home/drahflow/go/pkg/mod/go.temporal.io/sdk@v1.15.0/internal/workflow_testsuite.go:516 +0xf84\r\n[...]\r\n==================\r\n```\r\n[Edited for brevity and NDAs].\r\n\r\nThe code for the conflicting write at\r\n`/work/pkg/merchant/workflows/consumer_checkout/main.go:829 +0xfc`\r\nis a standard member-access to a struct which was sent as part of the signal payload. This works on real execution, as the signal data is serialized and sent before the workflow processing continues (as far as I can see), but in `TestWorkflowEnvironment.SignalExternalWorkflow`, a new go-routine is spawned, which tries to look up the correct mock of the signal receiver _concurrently_ with the rest of the workflow proceeding (and modifying the data of the signal currently being processed): https://github.com/temporalio/sdk-go/blob/754b253bb196d69c64317af1ed28fa85a74d584d/internal/internal_workflow_testsuite.go#L2068\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Make workflow which sends signal to other workflow and immediately proceeds to modify member fields of the signal payload\r\n  1. Build a workflow test and mock the signal receiver\r\n  1. Run the workflow test very often with `go test -race`\r\n\r\n## Specifications\r\n\r\n  - Version: go.temporal.io/sdk v1.15.0\r\n  - Platform: linux, x86_64, go version go1.19.1 linux/amd64","closedAt":null,"comments":[{"id":"IC_kwDODN1w685LKPlU","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks! This is similar to #908. Some of the test environment was not developed in a concurrency safe way. We will fix.","createdAt":"2022-09-28T14:11:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/922#issuecomment-1260976468","viewerDidAuthor":false}],"createdAt":"2022-09-28T14:02:43Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":922,"reactionGroups":[],"state":"OPEN","title":"TestWorkflowEnvironment.SignalExternalWorkflow data race on signal data","updatedAt":"2022-09-28T14:11:34Z","url":"https://github.com/temporalio/sdk-go/issues/922"}
