{"assignees":[{"id":"MDQ6VXNlcjE0NjM2MjI=","login":"mfateev","name":"Maxim Fateev","databaseId":0},{"id":"MDQ6VXNlcjE3NjY1MTU=","login":"samarabbas","name":"Samar Abbas","databaseId":0},{"id":"MDQ6VXNlcjU1NTIzODE=","login":"mastermanu","name":"","databaseId":0}],"author":{"id":"MDQ6VXNlcjU1NTIzODE=","is_bot":false,"login":"mastermanu","name":""},"body":"## Expected Behavior\r\nBoth activities execute and finish.\r\n\r\n## Actual Behavior\r\nOnly one of the activities execute. The other one never even starts executing and the workflow is just stuck\r\n\r\n## Steps to Reproduce the Problem\r\nCreate a Workflow that spawns and waits for two LOCAL activities.\r\n\r\n## Specifications\r\n\r\n  - Version:\r\n  - Platform:\r\n","closedAt":"2020-08-14T06:41:21Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDY3MzAxMDgxMA==","author":{"login":"mastermanu"},"authorAssociation":"MEMBER","body":"Was able to reproduce this was a simple integration test. Am debugging","createdAt":"2020-08-12T17:31:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/228#issuecomment-673010810","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDY3MzE0MDU3MQ==","author":{"login":"mastermanu"},"authorAssociation":"MEMBER","body":"The Go SDK currently has a bug where Local Activities executed in parallel cause the Workflow to hang.\r\nThe issue here is that for Local Activities started in parallel, they are incorrectly assigned the same activity ID as it uses the \"next command event ID\" and for local activities, that next command event ID is only incremented when the local activity finishes.\r\n\r\nFurthermore, that local activity ID is then used on replay to match a previous local activity result with a blocked future, which means that if we were to just change the semantics blindly on the client (to perhaps use a separate id counter for local activities), existing workflows with local activity IDs would pretty much be broken, so we need to find a way to fix this in a backwards compatible fashion.\r\n\r\nRelevant code:\r\ngo-sdk/internal/internal_decision_state_machine.go\r\n\r\nLine 891 in 00fb030\r\n\r\n func (h *commandsHelper) recordLocalActivityMarker(activityID string, details map[string]*commonpb.Payloads, failure *failurepb.Failure) commandStateMachine { \r\n--> This is where the command ID is incremented for a local activity\r\ngo-sdk/internal/internal_event_handlers.go\r\n\r\nLine 1114 in 478fbb8\r\n\r\n func (weh *workflowExecutionEventHandlerImpl) handleLocalActivityMarker(details map[string]*commonpb.Payloads, failure *failurepb.Failure) error { \r\n--> This is where we process previous local activity results on replay\r\ngo-sdk/internal/internal_event_handlers.go\r\n\r\nLine 483 in 478fbb8\r\n\r\n activityID := wc.GenerateSequenceID() \r\n--> This is where the local activityID is assigned. The GenerateSequenceID() returns the same ID unless an actual command happens, which is why multiple local activities spawned result in having the same activity ID.\r\nTO BE FURTHER INVESTIGATED: The same issue could potentially exist for mutable side effects and regular side effects that were spawned in parallel if they are on actually on separate Go Routines as they get the sequence number and increment after execution is finished. In that case, the sideeffect ID would be overwritten by the last write that wins.","createdAt":"2020-08-12T22:26:01Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/228#issuecomment-673140571","viewerDidAuthor":false}],"createdAt":"2020-08-12T17:28:27Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDg2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":228,"reactionGroups":[],"state":"CLOSED","title":"Workflow hangs if we try to run two local activities in parallel","updatedAt":"2020-08-14T06:41:21Z","url":"https://github.com/temporalio/sdk-go/issues/228"}
