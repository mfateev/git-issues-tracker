{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"## Expected Behavior\r\n\r\nReplay should only care about events in history\r\n\r\n## Actual Behavior\r\n\r\nThere is a report of replay breaking due to missing local activity","closedAt":"2022-03-01T15:05:56Z","comments":[{"id":"IC_kwDODN1w684-ok77","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I am not able to replicate this. My replication attempt is collapsed below:\r\n\r\n<details><summary>main.go</summary>\r\n\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"fmt\"\r\n\t\"log\"\r\n\t\"strings\"\r\n\t\"time\"\r\n\r\n\t\"github.com/gogo/protobuf/jsonpb\"\r\n\t\"github.com/google/uuid\"\r\n\tenumspb \"go.temporal.io/api/enums/v1\"\r\n\thistorypb \"go.temporal.io/api/history/v1\"\r\n\t\"go.temporal.io/sdk/client\"\r\n\t\"go.temporal.io/sdk/worker\"\r\n\t\"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\nfunc main() {\r\n\tif err := run(); err != nil {\r\n\t\tlog.Fatal(err)\r\n\t}\r\n}\r\n\r\nfunc run() error {\r\n\tctx, cancel := context.WithCancel(context.Background())\r\n\tdefer cancel()\r\n\r\n\tlog.Printf(\"Creating client\")\r\n\tc, err := client.NewClient(client.Options{})\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"failed creating client: %w\", err)\r\n\t}\r\n\tdefer c.Close()\r\n\r\n\tlog.Printf(\"Starting worker\")\r\n\ttaskQueue := uuid.NewString()\r\n\tw := worker.New(c, taskQueue, worker.Options{})\r\n\tw.RegisterWorkflow(HelloWorkflow)\r\n\tw.RegisterActivity(HelloActivity)\r\n\tif err := w.Start(); err != nil {\r\n\t\treturn fmt.Errorf(\"failed starting worker client: %w\", err)\r\n\t}\r\n\tdefer w.Stop()\r\n\r\n\tlog.Printf(\"Running workflow\")\r\n\trun, err := c.ExecuteWorkflow(ctx, client.StartWorkflowOptions{TaskQueue: taskQueue}, HelloWorkflow, \"Temporal\")\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"failed starting workflow: %w\", err)\r\n\t} else if err = run.Get(ctx, nil); err != nil {\r\n\t\treturn fmt.Errorf(\"workflow failed: %w\", err)\r\n\t}\r\n\r\n\tlog.Printf(\"Loading history\")\r\n\tvar history historypb.History\r\n\titer := c.GetWorkflowHistory(ctx, run.GetID(), run.GetRunID(), false, enumspb.HISTORY_EVENT_FILTER_TYPE_ALL_EVENT)\r\n\tfor iter.HasNext() {\r\n\t\tevent, err := iter.Next()\r\n\t\tif err != nil {\r\n\t\t\treturn fmt.Errorf(\"failed getting history: %w\", err)\r\n\t\t}\r\n\t\thistory.Events = append(history.Events, event)\r\n\t}\r\n\tvar buf strings.Builder\r\n\tif err := (&jsonpb.Marshaler{Indent: \"  \"}).Marshal(&buf, &history); err != nil {\r\n\t\treturn fmt.Errorf(\"failed dumping history: %w\", err)\r\n\t}\r\n\tlog.Printf(\"History:\\n%v\", buf.String())\r\n\r\n\tlog.Printf(\"Running replayer\")\r\n\treplayer := worker.NewWorkflowReplayer()\r\n\treplayer.RegisterWorkflow(HelloWorkflow)\r\n\tif err := replayer.ReplayWorkflowHistory(nil, &history); err != nil {\r\n\t\treturn fmt.Errorf(\"failed replaying history: %w\", err)\r\n\t}\r\n\tlog.Printf(\"Replay completed successfully\")\r\n\r\n\treturn nil\r\n}\r\n\r\nfunc HelloWorkflow(ctx workflow.Context, name string) (string, error) {\r\n\tctx = workflow.WithLocalActivityOptions(ctx, workflow.LocalActivityOptions{ScheduleToCloseTimeout: 2 * time.Second})\r\n\tvar res string\r\n\terr := workflow.ExecuteLocalActivity(ctx, HelloActivity, name).Get(ctx, &res)\r\n\treturn res, err\r\n}\r\n\r\nfunc HelloActivity(ctx context.Context, name string) (string, error) {\r\n\treturn \"Hello, \" + name + \"!\", nil\r\n}\r\n```\r\n</details>\r\n\r\nThe replayer works well with local activities as expected.","createdAt":"2022-02-25T12:47:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/740#issuecomment-1050824443","viewerDidAuthor":false},{"id":"IC_kwDODN1w684-olNQ","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I will leave this open a bit so others can read before closing.","createdAt":"2022-02-25T12:49:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/740#issuecomment-1050825552","viewerDidAuthor":false},{"id":"IC_kwDODN1w684-p3FL","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"The issue seems to be specific to local activities registered by name. I will confirm replication and provide fix.","createdAt":"2022-02-25T19:46:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/740#issuecomment-1051160907","viewerDidAuthor":false}],"createdAt":"2022-02-24T19:29:07Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":740,"reactionGroups":[],"state":"CLOSED","title":"Execute local activity by string name fails during replay","updatedAt":"2022-03-01T15:05:56Z","url":"https://github.com/temporalio/sdk-go/issues/740"}
