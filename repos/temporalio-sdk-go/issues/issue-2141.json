{"assignees":[],"author":{"id":"MDQ6VXNlcjg3MjY5","is_bot":false,"login":"autocracy","name":"Jeff Ferland"},"body":"## Summary\n\nThe test environment's activity alias registry uses short function names (e.g., `func1`) as keys, which causes collisions when multiple packages register activities using anonymous functions. This results in local activities being incorrectly routed to unrelated registered activity mocks, causing panics due to signature mismatches.\n\n## Affected Version\n\n- `go.temporal.io/sdk` v1.38.0 (and likely earlier versions)\n\n## Reproduction\n\n### Minimal Test Case Demonstrating the Bug\n\n```go\npackage alias_collision_test\n\nimport (\n\t\"context\"\n\t\"testing\"\n\t\"time\"\n\n\t\"github.com/stretchr/testify/require\"\n\t\"github.com/stretchr/testify/suite\"\n\t\"go.temporal.io/sdk/activity\"\n\t\"go.temporal.io/sdk/testsuite\"\n\t\"go.temporal.io/sdk/workflow\"\n)\n\ntype AliasCollisionSuite struct {\n\tsuite.Suite\n\ttestsuite.WorkflowTestSuite\n}\n\nfunc TestAliasCollisionSuite(t *testing.T) {\n\tsuite.Run(t, new(AliasCollisionSuite))\n}\n\n// SomeActivityRequest is a request type for a registered activity\ntype SomeActivityRequest struct {\n\tValue string\n}\n\n// SomeActivityResponse is a response type for a registered activity\ntype SomeActivityResponse struct {\n\tResult string\n}\n\n// TestAliasCollision_Fails demonstrates the bug where anonymous functions\n// with the same short name collide in the activity alias registry.\nfunc (s *AliasCollisionSuite) TestAliasCollision_Fails() {\n\tenv := s.NewTestWorkflowEnvironment()\n\n\t// Register an activity using an anonymous function.\n\t// This anonymous function gets a short name like \"func1\" in the registry.\n\tenv.RegisterActivityWithOptions(\n\t\tfunc(ctx context.Context, req *SomeActivityRequest) (*SomeActivityResponse, error) {\n\t\t\treturn &SomeActivityResponse{Result: \"from registered activity\"}, nil\n\t\t},\n\t\tactivity.RegisterOptions{Name: \"SomeActivity\"},\n\t)\n\n\t// This workflow executes a LOCAL activity using an INLINE anonymous function.\n\t// The inline function also gets a short name like \"func1\".\n\t// Due to the collision, the test environment incorrectly tries to call\n\t// the registered \"SomeActivity\" with the wrong arguments.\n\ttestWorkflow := func(ctx workflow.Context) (string, error) {\n\t\tlao := workflow.LocalActivityOptions{\n\t\t\tScheduleToCloseTimeout: 10 * time.Second,\n\t\t}\n\t\tctx = workflow.WithLocalActivityOptions(ctx, lao)\n\n\t\tvar result string\n\t\t// This inline anonymous function takes only context and returns (string, error)\n\t\t// but the registry thinks it should call SomeActivity which takes\n\t\t// (context.Context, *SomeActivityRequest) -> (*SomeActivityResponse, error)\n\t\terr := workflow.ExecuteLocalActivity(ctx, func(ctx context.Context) (string, error) {\n\t\t\treturn \"from inline local activity\", nil\n\t\t}).Get(ctx, &result)\n\n\t\treturn result, err\n\t}\n\n\tenv.ExecuteWorkflow(testWorkflow)\n\n\trequire.True(s.T(), env.IsWorkflowCompleted())\n\trequire.NoError(s.T(), env.GetWorkflowError())\n\n\tvar result string\n\trequire.NoError(s.T(), env.GetWorkflowResult(&result))\n\trequire.Equal(s.T(), \"from inline local activity\", result)\n}\n\n// TestAliasCollision_Workaround demonstrates the workaround: use named functions\n// instead of anonymous functions when registering activities.\nfunc (s *AliasCollisionSuite) TestAliasCollision_Workaround() {\n\tenv := s.NewTestWorkflowEnvironment()\n\n\t// WORKAROUND: Use a named function instead of an anonymous function.\n\t// Named functions have unique full names that won't collide.\n\tenv.RegisterActivityWithOptions(\n\t\tnamedActivityMock, // This gets a unique name like \"alias_collision_test.namedActivityMock\"\n\t\tactivity.RegisterOptions{Name: \"SomeActivity\"},\n\t)\n\n\ttestWorkflow := func(ctx workflow.Context) (string, error) {\n\t\tlao := workflow.LocalActivityOptions{\n\t\t\tScheduleToCloseTimeout: 10 * time.Second,\n\t\t}\n\t\tctx = workflow.WithLocalActivityOptions(ctx, lao)\n\n\t\tvar result string\n\t\terr := workflow.ExecuteLocalActivity(ctx, func(ctx context.Context) (string, error) {\n\t\t\treturn \"from inline local activity\", nil\n\t\t}).Get(ctx, &result)\n\n\t\treturn result, err\n\t}\n\n\tenv.ExecuteWorkflow(testWorkflow)\n\n\trequire.True(s.T(), env.IsWorkflowCompleted())\n\trequire.NoError(s.T(), env.GetWorkflowError())\n\n\tvar result string\n\trequire.NoError(s.T(), env.GetWorkflowResult(&result))\n\trequire.Equal(s.T(), \"from inline local activity\", result)\n}\n\n// namedActivityMock is a named function used as a workaround for the alias collision bug.\nfunc namedActivityMock(ctx context.Context, req *SomeActivityRequest) (*SomeActivityResponse, error) {\n\treturn &SomeActivityResponse{Result: \"from registered activity\"}, nil\n}\n```\n\n### Expected Behavior\n\nBoth tests should pass. The inline local activity function should execute independently of the registered activity mock, as they are completely separate functions with different purposes.\n\n### Actual Behavior\n\n`TestAliasCollision_Fails` panics with:\n```\nreflect: Call with too few input arguments\n```\n\nThe test environment incorrectly routes the inline local activity to the registered \"SomeActivity\" mock because both anonymous functions have the same short name (`func1`).\n\n## Root Cause Analysis\n\n### 1. Short function names used as alias keys\n\nIn `internal/internal_worker.go`, the `getFunctionName` function returns only the short name:\n\n```go\nfunc getFunctionName(i interface{}) (name string, isMethod bool) {\n    fullName := runtime.FuncForPC(reflect.ValueOf(i).Pointer()).Name()\n    elements := strings.Split(fullName, \".\")\n    shortName := elements[len(elements)-1]  // Returns \"func1\", \"func2\", etc.\n    return strings.TrimSuffix(shortName, \"-fm\"), isMethod\n}\n```\n\n### 2. Alias stored using short name\n\nIn `internal/internal_worker.go` line ~730:\n```go\nif len(alias) > 0 && r.activityAliasMap != nil {\n    r.activityAliasMap[fnName] = alias  // fnName is \"func1\"\n}\n```\n\n### 3. Test environment looks up alias for local activities\n\nIn `internal/internal_workflow_testsuite.go` line ~1559:\n```go\nfunc (env *testWorkflowEnvironmentImpl) ExecuteLocalActivity(...) {\n    ae := &activityExecutor{name: getActivityFunctionName(env.registry, params.ActivityFn), fn: params.ActivityFn}\n    if at, _ := getValidatedActivityFunction(params.ActivityFn, params.InputArgs, env.registry); at != nil {\n        // This finds the wrong alias because both functions have short name \"func1\"\n        ae.name = at.Name\n    }\n    // ...\n}\n```\n\n### 4. Mock lookup uses the wrong name\n\nIn `internal/internal_workflow_testsuite.go` line ~1817:\n```go\nm := &mockWrapper{env: a.env, name: a.name, fn: a.fn, isWorkflow: false}\nif mockRet := m.getActivityMockReturnWithActualArgs(ctx, inputArgs); mockRet != nil {\n    // Finds the mock for \"SomeActivity\" when it shouldn't\n}\n```\n\n## Proposed Fix\n\n### Option 1: Use full function name as alias key (Recommended)\n\nChange the alias map to use full function names instead of short names:\n\n```go\nfunc (r *registry) RegisterActivityWithOptions(a interface{}, options RegisterActivityOptions) {\n    // ... existing code ...\n    \n    // Use full function name as alias key\n    fullName := runtime.FuncForPC(reflect.ValueOf(af).Pointer()).Name()\n    \n    if len(alias) > 0 && r.activityAliasMap != nil {\n        r.activityAliasMap[fullName] = alias\n    }\n}\n\nfunc (r *registry) getActivityAlias(fnName string) (string, bool) {\n    // fnName should also be the full function name\n    alias, ok := r.activityAliasMap[fnName]\n    return alias, ok\n}\n```\n\nThis requires updating all callers of `getActivityAlias` to pass the full function name.\n\n### Option 2: Skip alias lookup for anonymous functions in test environment\n\nIn `ExecuteLocalActivity`, detect anonymous functions and skip the alias lookup:\n\n```go\nfunc (env *testWorkflowEnvironmentImpl) ExecuteLocalActivity(...) {\n    ae := &activityExecutor{name: getActivityFunctionName(env.registry, params.ActivityFn), fn: params.ActivityFn}\n    \n    // Only look up alias if this is not an anonymous function\n    fullName := runtime.FuncForPC(reflect.ValueOf(params.ActivityFn).Pointer()).Name()\n    if !isAnonymousFunction(fullName) {\n        if at, _ := getValidatedActivityFunction(params.ActivityFn, params.InputArgs, env.registry); at != nil {\n            ae.name = at.Name\n        }\n    }\n    // ...\n}\n\nfunc isAnonymousFunction(fullName string) bool {\n    // Anonymous functions have names ending in \".funcN\" where N is a number\n    parts := strings.Split(fullName, \".\")\n    if len(parts) == 0 {\n        return false\n    }\n    lastPart := parts[len(parts)-1]\n    return strings.HasPrefix(lastPart, \"func\") && len(lastPart) > 4\n}\n```\n\n## Real-World Impact\n\nThis bug affects users of [protoc-gen-go-temporal](https://github.com/cludden/protoc-gen-go-temporal), which generates code that uses anonymous functions for expression evaluation in workflow ID generation:\n\n```go\n// Generated code in lifecycle_temporal.pb.go\nfunc (o *ServerDrainChildOptions) Build(ctx workflow.Context, req protoreflect.Message) (workflow.ChildWorkflowOptions, error) {\n    // ...\n    if err := workflow.ExecuteLocalActivity(ctx, func(ctx context.Context) (string, error) {\n        id, err := expression.EvalExpression(ServerDrainIdexpression, req)\n        // ...\n    }).Get(ctx, &opts.WorkflowID); err != nil {\n        // ...\n    }\n    // ...\n}\n```\n\nWhen users register activities with anonymous functions in their tests, these collide with the generated expression evaluation functions.\n\n## Workaround\n\nUntil this is fixed, users should use **named functions** instead of anonymous functions when calling `RegisterActivityWithOptions` or generated `Register*Activity` functions:\n\n```go\n// Instead of this (FAILS):\nenv.RegisterActivityWithOptions(\n    func(ctx context.Context, req *MyRequest) (*MyResponse, error) {\n        return &MyResponse{}, nil\n    },\n    activity.RegisterOptions{Name: \"MyActivity\"},\n)\n\n// Do this (WORKS):\nfunc myActivityMock(ctx context.Context, req *MyRequest) (*MyResponse, error) {\n    return &MyResponse{}, nil\n}\n\nenv.RegisterActivityWithOptions(myActivityMock, activity.RegisterOptions{Name: \"MyActivity\"})\n```\n\n## Environment\n\n- Go version: 1.25.5\n- OS: macOS (also affects Linux)\n- Temporal SDK version: v1.38.0\n","closedAt":null,"comments":[{"id":"IC_kwDODN1w687eE1Mt","author":{"login":"yuandrew"},"authorAssociation":"MEMBER","body":"Thanks for the issue and thorough write-up!\n\nWe strongly discourage usage of anonymous functions for local activities, see the following line in the doc comment for [ExecuteLocalActivity](https://pkg.go.dev/go.temporal.io/sdk/workflow#ExecuteLocalActivity)\n\n> WARNING: Technically, an anonymous function can be used as a local activity, but this is not recommended as their name is generated by the Go runtime and is not deterministic. This is only allowed for backward compatibility.\n\nChanging alias lookup would be very difficult to do in a non-breaking way with old histories, so that is not something we want to do at the moment.\n\nWe hope to eventually flag this in the WorkflowCheck tool as non-deterministic, https://github.com/temporalio/sdk-go/issues/1341. ","createdAt":"2026-01-08T21:08:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/2141#issuecomment-3725808429","viewerDidAuthor":false}],"createdAt":"2026-01-08T02:07:59Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDg2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":2141,"reactionGroups":[],"state":"OPEN","title":"Activity Alias Collision in Test Environment When Using Anonymous Functions","updatedAt":"2026-01-08T21:08:03Z","url":"https://github.com/temporalio/sdk-go/issues/2141"}
