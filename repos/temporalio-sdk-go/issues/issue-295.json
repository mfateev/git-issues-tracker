{"assignees":[],"author":{"id":"MDQ6VXNlcjE0NjM2MjI=","is_bot":false,"login":"mfateev","name":"Maxim Fateev"},"body":"## Expected Behavior\r\nNo data races\r\n\r\n## Actual Behavior\r\n\r\n```\r\n==================\r\nWARNING: DATA RACE\r\nWrite at 0x00c000120629 by goroutine 124:\r\n  go.temporal.io/sdk/internal.(*coroutineState).close()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_workflow.go:868 +0x5a\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine.func1()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_workflow.go:909 +0x148\r\n\r\nPrevious read at 0x00c000120629 by goroutine 61:\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).Close()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_workflow.go:991 +0x174\r\n  go.temporal.io/sdk/internal.(*syncWorkflowDefinition).Close()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_workflow.go:548 +0xb7\r\n  go.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).Close()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_event_handlers.go:941 +0xb7\r\n  go.temporal.io/sdk/internal.(*workflowExecutionContextImpl).clearState()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_task_handlers.go:570 +0x20b\r\n  go.temporal.io/sdk/internal.(*workflowExecutionContextImpl).onEviction()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_task_handlers.go:534 +0xb8\r\n  go.temporal.io/sdk/internal.getWorkflowCache.func1.1()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_task_handlers.go:433 +0x61\r\n\r\nGoroutine 124 (running) created at:\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_workflow.go:899 +0x1d8\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).Go()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_workflow.go:298 +0xa9\r\n  go.temporal.io/sdk/test_test.(*tracingOutboundCallsInterceptor).Go()\r\n      /Users/maxim/temporal/temporal-go-sdk/test/integration_test.go:787 +0x1c5\r\n  go.temporal.io/sdk/internal.newDispatcher()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_workflow.go:558 +0x1a9\r\n  go.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_workflow.go:478 +0x2af\r\n  go.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).handleWorkflowExecutionStarted()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_event_handlers.go:955 +0x287\r\n  go.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).ProcessEvent()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_event_handlers.go:773 +0x64f\r\n  go.temporal.io/sdk/internal.(*workflowExecutionContextImpl).ProcessWorkflowTask()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_task_handlers.go:891 +0x18d6\r\n  go.temporal.io/sdk/internal.(*workflowTaskHandlerImpl).ProcessWorkflowTask()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_task_handlers.go:778 +0xa64\r\n  go.temporal.io/sdk/internal.(*workflowTaskPoller).processWorkflowTask()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_task_pollers.go:286 +0x414\r\n  go.temporal.io/sdk/internal.(*workflowTaskPoller).ProcessTask()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_task_pollers.go:259 +0xe2\r\n  go.temporal.io/sdk/internal.(*baseWorker).processTask()\r\n      /Users/maxim/temporal/temporal-go-sdk/internal/internal_worker_base.go:343 +0x1aa\r\n==================\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\nI got it executing  TestIntegrationSuite/TestLongRunningActivityWithHB\r\n\r\n","closedAt":"2020-11-23T18:49:16Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDczMjMxMzMzOQ==","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"@mfateev FYI I made the same fix in https://github.com/temporalio/sdk-go/pull/294 that's in your PR","createdAt":"2020-11-23T17:35:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/295#issuecomment-732313339","viewerDidAuthor":false}],"createdAt":"2020-11-22T23:50:35Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":295,"reactionGroups":[],"state":"CLOSED","title":"Data race on cache eviction","updatedAt":"2020-11-23T18:49:16Z","url":"https://github.com/temporalio/sdk-go/issues/295"}
