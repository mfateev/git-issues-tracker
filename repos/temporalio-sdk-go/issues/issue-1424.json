{"assignees":[],"author":{"id":"MDQ6VXNlcjc2NDI3MQ==","is_bot":false,"login":"mrkaspa","name":"Michel Perez"},"body":"## Expected Behavior\r\n\r\nI should no receive the error ```context deadline exceeded``` when doing DB operations with the context passed in the Activity parameter\r\n\r\n## Actual Behavior\r\n\r\nI have code like this in my app\r\n\r\n```go\r\nfunc CleanupActivity(ctx context.Context) error {\r\n\t// this is a TemporalLogger (pkg/logger/temporal.go)\r\n\tlog := activity.GetLogger(ctx)\r\n\r\n\treturn cleanup.Cleanup(ctx, param.JobID)\r\n}\r\n```\r\n\r\n```go\r\nfunc Cleanup(ctx context.Context, jobID string) error {\r\n\tdb := database.GetDB()\r\n\r\n\t// Fetch the job from the database.\r\n\tj := &job.Job{ID: jobID}\r\n\terr := db.NewSelect().Model(j).WherePK().Scan(ctx)\r\n\tif err != nil {\r\n\t\treturn wferrors.NewTaskError(errors.WithStack(err), wferrors.ErrCodeDatabase, \"failed to fetch job\")\r\n\t}\r\n```\r\n\r\nand inside the cleanup.Cleanup function I do database operations with the Bun library that uses the context that is passed so when it tries to make a query I got the error:\r\n\r\n```\r\nDatabaseError, failed to fetch job, context deadline exceeded\r\n```\r\n\r\nso the database query is failing due  to  ```context deadline exceeded```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Use the context passed in the Activity as argument for database access\r\n  2. Deploy on production\r\n\r\n## Specifications\r\n\r\n  - Version: go.temporal.io/sdk v1.25.1\r\n  - Platform: Linux\r\n","closedAt":"2025-02-04T18:19:53Z","comments":[{"id":"IC_kwDODN1w6853svxw","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"The context passed into an activity has documentation around when users should expect it to be cancelled \r\n\r\nhttps://github.com/temporalio/sdk-go/blob/3da09e02e2d4b36d24cc52a6ef0c9c46e92b78c1/activity/doc.go#L77\r\n\r\nI would suspect in your case the activity is timing out before the database operation is complete. ","createdAt":"2024-03-19T22:05:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1424#issuecomment-2008218736","viewerDidAuthor":false},{"id":"IC_kwDODN1w6853zrhR","author":{"login":"mrkaspa"},"authorAssociation":"NONE","body":"Yes, I thought that, but the problem is that my deadline is of 1 hour per activity and when it starts failing for example failed the job 1 the subsquents jobs keep failing for the same reason, how can fail a new job for this reason if I have a deadline of  1 hour per activity.\r\n\r\nbtw, this is how I have the workflow settings\r\n\r\n```go\r\nactivityoptions := workflow.ActivityOptions{\r\n\t\t// Set Activity Timeout duration\r\n\t\t// ScheduleToCloseTimeout: 5 * time.Second,\r\n\t\tStartToCloseTimeout: 60 * time.Minute,\r\n\t\t// ScheduleToStartTimeout: 10 * time.Second,\r\n\t}\r\n\tctx = workflow.WithActivityOptions(ctx, activityoptions)\r\n\tctx = workflow.WithRetryPolicy(ctx, temporal.RetryPolicy{\r\n\t\tMaximumAttempts: 10,\r\n\t})\r\n```","createdAt":"2024-03-20T16:47:07Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1424#issuecomment-2010036305","viewerDidAuthor":false},{"id":"IC_kwDODN1w6853zxGy","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"The timeouts can be shorter depending on what other activity and workflow option, it is also possible the error is coming from some internal deadline set in your database library and not the activity context. You can check the deadline of the context using `ctx.Deadline()` to see when the context would expire.\r\n\r\nhttps://pkg.go.dev/context#Context","createdAt":"2024-03-20T16:58:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1424#issuecomment-2010059186","viewerDidAuthor":false},{"id":"IC_kwDODN1w68530DEU","author":{"login":"mrkaspa"},"authorAssociation":"NONE","body":"The problem is that this does not happen everytime, in our production experience we have deployed the solution and everything works fine for some executions, and after some days one workflow starts to fail and the next ones will always fail for the same reason","createdAt":"2024-03-20T17:18:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1424#issuecomment-2010132756","viewerDidAuthor":false},{"id":"IC_kwDODN1w68530Z9M","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"On one of these occurrences can you share the actual activity schedule event ? ","createdAt":"2024-03-20T17:45:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1424#issuecomment-2010226508","viewerDidAuthor":false},{"id":"IC_kwDODN1w68558dTR","author":{"login":"mrkaspa"},"authorAssociation":"NONE","body":"@Quinn-With-Two-Ns where can I see that?","createdAt":"2024-04-09T19:09:57Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1424#issuecomment-2045891793","viewerDidAuthor":false},{"id":"IC_kwDODN1w68558doc","author":{"login":"mrkaspa"},"authorAssociation":"NONE","body":"rn this is failing again\r\n\r\n```\r\nerror\r\nactivity error (type: PreprocessingActivity, scheduledEventID: 5, startedEventID: 6, identity: ): activity StartToClose timeout (type: StartToClose): activity StartToClose timeout (type: StartToClose)\r\n\r\nError\r\nlast connection error: connection error: desc = \"error reading server preface: read tcp 172.17.0.12:39422->52.26.119.98:7233: use of closed network connection\"\r\n\r\nPanicError\r\nruntime error: index out of range [4096] with length 4096\r\n```\r\n\r\nwe are seeing this error, I wonder if somehow the connection with the temporal servers is lost","createdAt":"2024-04-09T19:10:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1424#issuecomment-2045893148","viewerDidAuthor":false},{"id":"IC_kwDODN1w68558gFV","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"The last errors looks like an issue with you application and not the SDK, but just the error message  is not enough  for me to provide any insight and I cannot tell what is wrong with your application. \r\n\r\nTo  help debug any further what I would need is a stand alone reproduction of the issue showing the SDK canceling the context outside of the documented cases where users should expect it to be cancelled https://github.com/temporalio/sdk-go/blob/3da09e02e2d4b36d24cc52a6ef0c9c46e92b78c1/activity/doc.go#L77","createdAt":"2024-04-09T19:18:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1424#issuecomment-2045903189","viewerDidAuthor":false},{"id":"IC_kwDODN1w68558iNh","author":{"login":"mrkaspa"},"authorAssociation":"NONE","body":"we are using nomad to deploy our containers and when restart them the issue is solved, this issue uses to happen everyweek, all the workflows start to throw timeouts and I think the reason is they lost connection with the temporal servers, so the temporal server can not execute the activities and time out","createdAt":"2024-04-09T19:24:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1424#issuecomment-2045911905","viewerDidAuthor":false}],"createdAt":"2024-03-19T21:56:41Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1424,"reactionGroups":[],"state":"CLOSED","title":"Context deadline exceeded when using the context passed to the activity","updatedAt":"2025-02-04T18:19:53Z","url":"https://github.com/temporalio/sdk-go/issues/1424"}
