{"assignees":[],"author":{"id":"MDQ6VXNlcjI0OTMxNTc=","is_bot":false,"login":"hodbn","name":"hodbn"},"body":"## Expected Behavior\r\nA test activity environment can execute multiple activities in parallel.\r\n\r\nI'm assuming this is the expected behavior since one can execute multiple parallel activities on a real workflow.\r\nAlso, the [docs](https://docs.temporal.io/dev-guide/go/testing#test-activities) doesn't specify this limit.\r\n\r\n## Actual Behavior\r\nA test activity environment might crash (race) when executing multiple activities in parallel.\r\nThe cause looks to be [concurrent reads and writes](https://github.com/temporalio/sdk-go/blob/5d5b9c4c44a3f00df55958147b052d1e27233a4f/internal/internal_workflow_testsuite.go#L1340-L1351) to a map in `testWorkflowEnvironmentImpl`.\r\n```\r\nplayground â€º go test ./...\r\n?       github.com/example/playground/helloworld       [no test files]\r\n?       github.com/example/playground/helloworld/starter       [no test files]\r\n?       github.com/example/playground/helloworld/worker        [no test files]\r\nfatal error: concurrent map read and map write\r\n\r\ngoroutine 88 [running]:\r\ngo.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).getActivityHandle(0x1400029a1e0, {0x1400038073e, 0x2}, {0x105777eaf?, 0x10577b469?})\r\n        /Users/user/.go/pkg/mod/go.temporal.io/sdk@v1.25.1/internal/internal_workflow_testsuite.go:1286 +0xa8\r\ngo.temporal.io/sdk/internal.(*activityExecutorWrapper).Execute(0x1400038d7e0, {0x105aa5ef8?, 0x14000412070}, 0x0)\r\n        /Users/user/.go/pkg/mod/go.temporal.io/sdk@v1.25.1/internal/internal_workflow_testsuite.go:1623 +0x118\r\ngo.temporal.io/sdk/internal.(*activityTaskHandlerImpl).Execute(0x140003d5420, {0x10577b47f, 0x16}, 0x140003e4210)\r\n        /Users/user/.go/pkg/mod/go.temporal.io/sdk@v1.25.1/internal/internal_task_handlers.go:2084 +0x6f4\r\ngo.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeActivity(0x1400029a1e0, {0x105930b60?, 0x105a96a00?}, {0x0, 0x0, 0x0})\r\n        /Users/user/.go/pkg/mod/go.temporal.io/sdk@v1.25.1/internal/internal_workflow_testsuite.go:603 +0x49c\r\ngo.temporal.io/sdk/internal.(*TestActivityEnvironment).ExecuteActivity(0x140003c09c0?, {0x105930b60?, 0x105a96a00?}, {0x0?, 0x1533bc000000000?, 0x6577fa36?})\r\n        /Users/user/.go/pkg/mod/go.temporal.io/sdk@v1.25.1/internal/workflow_testsuite.go:191 +0x2c\r\ngithub.com/example/playground_test.TestSomething.func1(0x0?)\r\n        /Users/user/git/playground/main_test.go:23 +0x48\r\ntesting.tRunner(0x140003c09c0, 0x1400038c850)\r\n        /opt/homebrew/Cellar/go/1.21.4/libexec/src/testing/testing.go:1595 +0xe8\r\ncreated by testing.(*T).Run in goroutine 19\r\n        /opt/homebrew/Cellar/go/1.21.4/libexec/src/testing/testing.go:1648 +0x33c\r\n\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Run this with `go test ./...`:\r\n```golang\r\n// main_test.go\r\npackage main_test\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"fmt\"\r\n\t\"testing\"\r\n\r\n\t\"go.temporal.io/sdk/testsuite\"\r\n)\r\n\r\nfunc NopActivity(ctx context.Context) error {\r\n\treturn nil\r\n}\r\n\r\nfunc TestSomething(t *testing.T) {\r\n\ttestSuite := &testsuite.WorkflowTestSuite{}\r\n\tenv := testSuite.NewTestActivityEnvironment()\r\n\tenv.RegisterActivity(NopActivity)\r\n\r\n\tfor i := 0; i < 100; i++ {\r\n\t\tt.Run(fmt.Sprintf(\"iter-%d\", i), func(t *testing.T) {\r\n\t\t\tt.Parallel()\r\n\t\t\t_, _ = env.ExecuteActivity(NopActivity)\r\n\t\t})\r\n\t}\r\n}\r\n```\r\n  2. Most times you'll get a crash. You can play with the number of iterations.\r\n\r\n## Specifications\r\n\r\n  - Version: go sdk `v1.25.1`\r\n  - Platform: macOS\r\n","closedAt":"2024-01-03T18:24:53Z","comments":[{"id":"IC_kwDODN1w685uzP93","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"The `ActivityTestEnvironment` is not designed to be thread safe. There is no documentation that says it is OK to use in multiple go routines. In the sdk-go package I would assume an API is not thread safe unless explicitly documented.","createdAt":"2023-12-16T20:55:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1324#issuecomment-1858928503","viewerDidAuthor":false},{"id":"IC_kwDODN1w685vzjtg","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Closing as this is expected behaviour, feel free to reopen if you have additional questions ","createdAt":"2024-01-03T18:24:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1324#issuecomment-1875786592","viewerDidAuthor":false}],"createdAt":"2023-12-16T20:40:27Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1324,"reactionGroups":[],"state":"CLOSED","title":"Concurrent map writes with ActivityTestEnvironment","updatedAt":"2024-01-03T18:24:53Z","url":"https://github.com/temporalio/sdk-go/issues/1324"}
