{"assignees":[],"author":{"id":"MDQ6VXNlcjM0Njk1MzI=","is_bot":false,"login":"kevinawoo","name":"Kevin Woo"},"body":"The behavior described via SDK docs and how the the OTel package was written is different. [Community Slack Discussion](https://temporalio.slack.com/archives/CTDTU3J4T/p1744839840976459)\n\nAccording to these comments, the behavior is that the these metrics are monotone increasing. \n- https://github.com/temporalio/sdk-go/blob/a92189071ec5931c88a97284d60b8b06f1024fc3/client/client.go#L1315-L1316\n- https://github.com/temporalio/sdk-go/blob/a92189071ec5931c88a97284d60b8b06f1024fc3/internal/common/metrics/handler.go#L49-L53\n\nHowever the current OTel implementation supports explicitly supports negative numbers with the use of `UpDownCounter`\n- https://github.com/temporalio/sdk-go/blob/a92189071ec5931c88a97284d60b8b06f1024fc3/contrib/opentelemetry/handler.go#L120-L121\n- https://github.com/temporalio/sdk-go/blob/a92189071ec5931c88a97284d60b8b06f1024fc3/contrib/opentelemetry/handler_test.go#L89\n\n\n## The Bug\nThe ask is to either fix the docs, or change OTel's emitted metric to be a `Counter` so that it matches how it's more commonly used.\n\nThe `UpDownCounter` type doesn't make contextual sense for the metrics emitted by the Temporal SDK.\n\nSee the **OTel-Contrib-Packages** section below on how other SDKs use `UpDownCounters` vs `Counters`.\n\n\n## Specifications\n  - Version: v1.34.0\n\n\n## References\n\n### Temporal Go SDK\nThe introduction of OTel was introduced in https://github.com/temporalio/sdk-go/pull/1336#discussion_r1443293471, with this comment left ambiguous about which counter type to use, however a [test case](https://github.com/temporalio/sdk-go/pull/1336/files#diff-f987a1b77ea038f5dfb730dff688338f356b0dcb8c4f5bc4ea9c4137f0c3b5acR90) was introduced to support negative numbers.\n\nThe summary of an [internal discussion](https://temporaltechnologies.slack.com/archives/C01FG4BRQVB/p1745346080185219) is that the package was built for general usage, without any limitations on the value.\n\nCurrently, all usages of the counter calls `.Inc(1)`, however this may change, especially numbers `> 1`.\n\nThe behavior of the metrics was copied from the behavior of Tally.\n\n\n### Tally\nuber-go/tally is ambiguous in which values is allowed, but it's implementation supports negative numbers:\n- https://github.com/uber-go/tally/blob/12d200cf909b1094affc40bf4bf70fc99c5f39a3/stats.go#L72-L74\n- There's no test cases that specifically address negative numbers https://github.com/uber-go/tally/blob/12d200cf909b1094affc40bf4bf70fc99c5f39a3/stats_test.go#L86-L101\n\n\n### Prometheus\nPrometheus does not support negative numbers for counters and will panic if a negative number is provided. https://github.com/prometheus/client_golang/blob/9b83d994624f3cab82ec593133a598b3a27d0841/prometheus/counter.go#L126-L129\n\n\n### OTel Contrib Packages\nOTel's Prometheus package implements `counters` as `monotonic` `sums`, which follows the spirit of Prometheus's implementation.\n\n> [A Counter] is a cumulative metric that represents a single monotonically increasing counter whose value can only increase or be reset to zero on restart.\n\n-[OTel's Prometheus Design Doc #Counters](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/d64038bc0e15111b345d218e17b3c0d4bed63ce5/receiver/prometheusreceiver/DESIGN.md#counter)\n- and it's code [prometheusreceiver/internal/util.go](https://github.com/open-telemetry/opentelemetry-collector-contrib/blob/d64038bc0e15111b345d218e17b3c0d4bed63ce5/receiver/prometheusreceiver/internal/util.go#L97-L102)\n\n\n\nThere's limited usage of `UpDownCounters` in all of the `receiver` packages. This metric is mostly commonly used to show the number of things in flight/active.\n\nNote, I think Fluent's usage is actually a bug in how the code is auto generated.\n\n\n<details> \n<summary>23 occurrences (expand to see usage patterns)</summary>\n<kbd>\n\n![Image](https://github.com/user-attachments/assets/057774b6-8200-4c9d-86bb-75785357b761)\n\n</kbd>\n\n</details>\n\n\n\nWhere the `Counter` type is used as **a cumulative metric that represents a single monotonically increasing counter whose value can only increase or be reset to zero on restart.**\n\n\n<details>\n<summary>Temporal SDK usage of `counter` metric type</summary>\n\n<kbd>\n\n![Image](https://github.com/user-attachments/assets/b6cee77f-bbac-4261-9acc-5e68f4b27d76)\n\n</kbd>\n</details> \n\n<details>\n<summary>Other SDK's use of `counter` type (164 occurrences)</summary>\n\n<kbd>\n\n![Image](https://github.com/user-attachments/assets/4572214d-ba7d-48a6-b1dd-3ede1f238a44)\n\n</kbd>\n</details> ","closedAt":null,"comments":[{"id":"IC_kwDODN1w686pQ5xe","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"@kevinawoo Yeah, so this is all objectively true, but I think the consequence is fairly low. We use gauges in other places, so any metrics collection system is going to need to support those (I know in the community thread, they mention their system doesn't handle gauges well - but what system would that be? There'd be a lot of metrics that are gauges now [and should be] that they would be unable to use), and although these particular metrics probably can and should be simple counters, the fact that they aren't isn't exactly causing any damage.\n\nSo with that in mind we discussed on the SDK team and we're not likely to take this on immediately. We have a broader effort tracked to normalize metrics across SDKs, I've parented this under that in Jira, and when we take on that effort we can decide if we'll do this then too.","createdAt":"2025-04-29T18:15:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/1929#issuecomment-2839780446","viewerDidAuthor":false},{"id":"IC_kwDODN1w686phfUF","author":{"login":"danielhochman"},"authorAssociation":"NONE","body":"Google Cloud Monitoring (formerly known as Stackdriver) doesn't natively support gauge deltas in their metrics query builder. This makes any sort of interactive debugging or exploration of metrics quite painful. Displaying a gauge is fine, just not deltas without writing [MQL which is deprecated](https://cloud.google.com/stackdriver/docs/deprecations/mql) or their flavor of PromQL which is [slightly different](https://cloud.google.com/stackdriver/docs/managed-prometheus/promql-differences) than PromQL, neither of which our team is trained up on.","createdAt":"2025-05-01T05:20:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/1929#issuecomment-2844128517","viewerDidAuthor":false}],"createdAt":"2025-04-23T01:00:32Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDg2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1929,"reactionGroups":[],"state":"OPEN","title":"OTel emitted metrics do not match behavior described in the docs","updatedAt":"2025-05-01T05:20:40Z","url":"https://github.com/temporalio/sdk-go/issues/1929"}
