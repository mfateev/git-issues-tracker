{"assignees":[],"author":{"id":"U_kgDOB1E09g","is_bot":false,"login":"burnaevk","name":""},"body":"## Expected Behavior\r\n\r\nWe run distributed tracing with OTel and `go.temporal.io/sdk/contrib/opentelemetry` trace / span propagator. We expect to see calls to `worfklowService.GetSystemInfo` made by `loadCapabilities` (https://github.com/temporalio/sdk-go/blob/d9a574d4ffa4f43e4a9ea4e133feeb5fedb0392c/internal/internal_workflow_client.go#L1151) in our distributed trace, as sometimes intermittent network failures may result in this call failing. If this call is not included in the trace, the reason of the failure is not obvious. \r\n\r\n## Actual Behavior\r\n\r\n`worfklowService.GetSystemInfo` call is not visible in the parent trace; instead, a new trace is created for this individual call. \r\n\r\n## Cause\r\n\r\nhttps://github.com/temporalio/sdk-go/blob/d9a574d4ffa4f43e4a9ea4e133feeb5fedb0392c/internal/internal_workflow_client.go#L1165 creates a new background context; parent context is not passed to `loadCapabilities` or `ensureInitialized. \r\n\r\nAll callers of ensureInitialized have parent context available, except worker (which might've used context.Background() explicitly) \r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Set up Temporal SDK client with tracing interceptor\r\n\r\n```\r\n\topts := opentelemetry.TracerOptions{}\r\n\ttracingInterceptor, err := opentelemetry.NewTracingInterceptor(opts)\r\n\tif err != nil {\r\n\t\treturn nil, ErrTracing\r\n\t}\r\n\tc, err := client.NewLazyClient(client.Options{\r\n...\r\n\t\tInterceptors:       []interceptor.ClientInterceptor{tracingInterceptor}\r\n,...\r\n\t})\r\n```\r\n\r\n  1. Start a new trace in your business logic code and execute an arbitrary SDK call\r\n  1. Check logs / traces for presence of the `worfklowService.GetSystemInfo` call\r\n\r\n## Specifications\r\n\r\n  - Version: v1.25.1\r\n  - Platform: go sdk\r\n","closedAt":"2024-06-27T17:44:56Z","comments":[{"id":"IC_kwDODN1w6851nuz6","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":":+1: Yes, we should plumb the context through the capabilities loader (it also will allow it to be subject to proper cancellation and such). It probably wasn't originally set because it is a lazy/memoized call so only the first context matters, but we still should I believe.\r\n\r\nNote, you may consider using `ConnectionOptions.DialOptions` with a gRPC stats handler (or gRPC interceptor) from https://pkg.go.dev/go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc if you really want to trace all gRPC calls. The Temporal interceptor is only for a select few high-level operations. But that doesn't change the fact that we should use the outer context when calling get-system-info.","createdAt":"2024-03-01T15:01:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1406#issuecomment-1973349626","viewerDidAuthor":false},{"id":"IC_kwDODN1w686C2EpJ","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"@cretz I believe this is resolved now since [loadCapabilities](https://github.com/temporalio/sdk-go/blob/master/internal/internal_workflow_client.go#L1216) now takes the context and it is wired up in all possible locations we could.","createdAt":"2024-06-27T16:54:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1406#issuecomment-2195212873","viewerDidAuthor":false},{"id":"IC_kwDODN1w686C2acB","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Concur. Closing. @burnaevk - let us know if you still get issues (of course `go.temporal.io/sdk/contrib/opentelemetry` does not instrument the client, but `go.opentelemetry.io/contrib/instrumentation/google.golang.org/grpc/otelgrpc` can as mentioned above).","createdAt":"2024-06-27T17:44:56Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1406#issuecomment-2195302145","viewerDidAuthor":false}],"createdAt":"2024-02-29T23:49:32Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1406,"reactionGroups":[],"state":"CLOSED","title":"Calls to worfklowService.GetSystemInfo are not included in the distrubuted trace.","updatedAt":"2024-06-27T17:45:11Z","url":"https://github.com/temporalio/sdk-go/issues/1406"}
