{"assignees":[],"author":{"id":"MDQ6VXNlcjg1NDYzMzg1","is_bot":false,"login":"hungcs","name":"hw"},"body":"## Expected Behavior\r\nCanceling a workflow should cancel the workflow without side effects or replays.\r\n\r\n## Actual Behavior\r\nCanceling workflows works the majority of the time, but for some cases it returns this error:\r\n\r\n`Task processing failed with error Namespace project TaskQueue taskqueue WorkerID 19252@hung-MacBook-Pro.local@ WorkerType WorkflowWorker Error BadRequestCancelActivityAttributes: invalid history builder state for action: add-activitytask-cancel-requested-event`\r\n\r\nThis causes Temporal to keep attempting replays with `Attempt 1` until the workflow is terminated manually. The workflow is marked as `running` when it should be `canceled`. In the logs, the workflow is canceled at the same activity step `(WaitQueryCompleteActivity)`, but one succeeds and other fails with the error and keeps replaying.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n1. `ExecuteQueryWorkflow (workflow.ActivityOptions{WaitForCancellation:    true})`\r\n  - workflow.ExecuteLocalActivity(CreateQueryActivity)\r\n  - workflow.ExecuteLocalActivity(RunQueryActivity)\r\n  - f(ctx, data)\r\n  -- workflow.ExecuteActivity(ctx, WaitQueryCompleteActivity, engine).Get(ctx, nil)....\r\n\r\n2. client.CancelWorkflow(context.Background(), getQueryWorkflowID(queryId), \"\")\r\n\r\npossibly related?: https://github.com/temporalio/sdk-go/issues/469\r\n\r\n## Specifications\r\n\r\n  - Version:\r\n -- go.temporal.io/api v1.4.1-0.20210420220407-6f00f7f98373\r\n-- go.temporal.io/sdk v1.7.0\r\n  - Platform:\r\n  -- Mac\r\n\r\nLogs:\r\n[query 118 success- 8546f839-3403-4841-af11-a25ba8ca91eb.json.txt](https://github.com/temporalio/sdk-go/files/6718209/query.118.success-.8546f839-3403-4841-af11-a25ba8ca91eb.json.txt)\r\n[query 119 succes - 5c3e2e65-44b7-4899-ab0d-fbf29ab21106.json.txt](https://github.com/temporalio/sdk-go/files/6718210/query.119.succes.-.5c3e2e65-44b7-4899-ab0d-fbf29ab21106.json.txt)\r\n\r\n","closedAt":"2023-08-29T18:19:38Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg3NTA4OTM5Mw==","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"@hungcs If you happen to have some minimal sample code that reproduces the issue that would be much appreciated","createdAt":"2021-07-06T21:20:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-875089393","viewerDidAuthor":false},{"id":"IC_kwDODN1w6841jNvz","author":{"login":"azuisleet"},"authorAssociation":"NONE","body":"This is a result of the state machine in sdk-go completing an activity and concurrently a cancel request also issuing a cancel for the same activity.\r\n\r\nIn temporal-server, `HasActivityFinishEvent` is supposed to check for something like this, but when an activity completes, it calls `DeleteActivity` which clears all the related fields. It's not clear me to how `HasActivityFinishEvent` is meant to check for completed activities.\r\n\r\nI will put together a sample when I get a chance, but I also need to confirm it's not an issue with the database I'm using.","createdAt":"2021-08-13T12:26:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-898423795","viewerDidAuthor":false},{"id":"IC_kwDODN1w6841jVJg","author":{"login":"azuisleet"},"authorAssociation":"NONE","body":"I have created a sample that shows this issue. \r\n\r\nHere is the worker:\r\nhttps://gist.github.com/azuisleet/e136167e54b92b33ea45f5d3f21ac7ea\r\n\r\nAnd a command to dispatch the workflow, and then cancel it at the same time as the activity:\r\nhttps://gist.github.com/azuisleet/6bb9dc621e10db21dfeee12c5b46e22c\r\n\r\nThis works consistently regardless of the storage engine. The workflow becomes stuck trying to cancel a completed activity, with the server reporting the error message described above:\r\n\r\n```\r\ntemporal                | {\"level\":\"warn\",\"ts\":\"2021-08-13T13:17:20.025Z\",\"msg\":\"invalid history builder state for action\",\"service\":\"history\",\"shard-id\":1,\"address\":\"172.24.0.3:7234\",\"shard-item\":\"0xc000662280\",\"component\":\"history-cache\",\"wf-action\":\"add-activitytask-cancel-requested-event\",\"wf-history-event-id\":12,\"error-type\":\"InvalidHistoryAction\",\"bool\":false,\"wf-schedule-id\":5,\"wf-id\":\"b639b495-490f-4958-8ae9-013374c3b6fc\",\"wf-run-id\":\"e3745b20-6361-4a79-a215-805bfe82b733\",\"wf-namespace-id\":\"34e86ca4-28e1-445d-8a7e-1f9a6d863d9c\",\"logging-call-at\":\"mutable_state_impl.go:4400\"}\r\ntemporal                | {\"level\":\"info\",\"ts\":\"2021-08-13T13:17:20.025Z\",\"msg\":\"Failing the workflow task.\",\"service\":\"history\",\"shard-id\":1,\"address\":\"172.24.0.3:7234\",\"shard-item\":\"0xc000662280\",\"component\":\"history-engine\",\"value\":\"BadRequestCancelActivityAttributes: invalid history builder state for action: add-activitytask-cancel-requested-event\",\"wf-id\":\"b639b495-490f-4958-8ae9-013374c3b6fc\",\"wf-run-id\":\"e3745b20-6361-4a79-a215-805bfe82b733\",\"wf-namespace-id\":\"34e86ca4-28e1-445d-8a7e-1f9a6d863d9c\",\"logging-call-at\":\"workflowTaskHandlerCallbacks.go:469\"}\r\n```","createdAt":"2021-08-13T13:21:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-898454112","viewerDidAuthor":false},{"id":"IC_kwDODN1w6841kW4J","author":{"login":"azuisleet"},"authorAssociation":"NONE","body":"Should activities be allowed to complete if a `WorkflowExecutionCancelRequested` has already been persisted in the workflow history? (`mutableState.IsCancelRequested()` being true). It seems like this isn't allowed given that the mutable state removes all traces of the activity upon completion.","createdAt":"2021-08-13T21:13:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-898723337","viewerDidAuthor":false},{"id":"IC_kwDODN1w6845fbRF","author":{"login":"mnussbaum"},"authorAssociation":"NONE","body":"I'm also seeing this issue every time I run the cancellation go sample at https://github.com/temporalio/samples-go/tree/main/cancellation","createdAt":"2021-11-09T21:01:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-964539461","viewerDidAuthor":false},{"id":"IC_kwDODN1w6845fbzL","author":{"login":"hungcs"},"authorAssociation":"NONE","body":"@mnussbaum what version of ~~Go~~ Temporal are you using? This was supposed to be fixed in [1.9](https://github.com/temporalio/sdk-go/releases/tag/v1.9.0), wondering if you're still encountering this","createdAt":"2021-11-09T21:04:04Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-964541643","viewerDidAuthor":false},{"id":"IC_kwDODN1w6845fdMk","author":{"login":"mnussbaum"},"authorAssociation":"NONE","body":"Go version:\r\n\r\n```\r\n$ go version\r\ngo version go1.17.3 linux/amd64\r\n```\r\n\r\nWhen I run the cancellation example's `cancellation/cancel/main.go` the worker from that example starts printing these lines indefinitely:\r\n\r\n```\r\n2021/11/09 15:58:54 INFO  heartbeating... Namespace default TaskQueue cancel-activity WorkerID 483128@tecopa@ ActivityID 5 ActivityType ActivityToBeCanceled Attempt 1 WorkflowType YourWo\r\nrkflow WorkflowID workflowID-to-cancel RunID dd0b6b04-d04b-4859-9e66-5ceac0780548\r\n2021/11/09 15:58:54 INFO  context is cancelled Namespace default TaskQueue cancel-activity WorkerID 483128@tecopa@ ActivityID 5 ActivityType ActivityToBeCanceled Attempt 1 WorkflowType Y\r\nourWorkflow WorkflowID workflowID-to-cancel RunID dd0b6b04-d04b-4859-9e66-5ceac0780548\r\n2021/11/09 15:58:54 INFO  ActivityToBeCanceled returns I am canceled by Done, <nil> Namespace default TaskQueue cancel-activity WorkerID 483128@tecopa@ WorkflowType YourWorkflow Workflow\r\nID workflowID-to-cancel RunID dd0b6b04-d04b-4859-9e66-5ceac0780548 Attempt 1\r\n2021/11/09 15:58:54 DEBUG ExecuteActivity Namespace default TaskQueue cancel-activity WorkerID 483128@tecopa@ WorkflowType YourWorkflow WorkflowID workflowID-to-cancel RunID dd0b6b04-d04\r\nb-4859-9e66-5ceac0780548 Attempt 1 ActivityID 15 ActivityType ActivityToBeSkipped\r\n2021/11/09 15:58:54 DEBUG RequestCancelActivity Namespace default TaskQueue cancel-activity WorkerID 483128@tecopa@ WorkflowType YourWorkflow WorkflowID workflowID-to-cancel RunID dd0b6b\r\n04-d04b-4859-9e66-5ceac0780548 Attempt 1 ActivityID 15\r\n2021/11/09 15:58:54 INFO  Task processing failed with error Namespace default TaskQueue cancel-activity WorkerID 483128@tecopa@ WorkerType WorkflowWorker Error BadRequestCancelActivityAt\r\ntributes: invalid history builder state for action: add-activitytask-cancel-requested-event\r\n2021/11/09 15:59:04 DEBUG Cached state staled, new task has unexpected events Namespace default TaskQueue cancel-activity WorkerID 483128@tecopa@ WorkflowID workflowID-to-cancel RunID dd\r\n0b6b04-d04b-4859-9e66-5ceac0780548 Attempt 2 CachedPreviousStartedEventID 14 TaskFirstEventID 1 TaskStartedEventID 20 PreviousStartedEventID 8\r\n```\r\n\r\nI believe this is the same issue based on the same `invalid history builder state for action` message in the original post, but my apologies if this is a different issue","createdAt":"2021-11-09T21:11:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-964547364","viewerDidAuthor":false},{"id":"IC_kwDODN1w6845feFq","author":{"login":"hungcs"},"authorAssociation":"NONE","body":"sorry, I meant the temporal version ","createdAt":"2021-11-09T21:13:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-964551018","viewerDidAuthor":false},{"id":"IC_kwDODN1w6845fgZk","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@mnussbaum - I may have been able to replicate and this may be showing us an issue we've been seeing. I will confirm and get back.","createdAt":"2021-11-09T21:23:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-964560484","viewerDidAuthor":false},{"id":"IC_kwDODN1w6845fgdj","author":{"login":"mnussbaum"},"authorAssociation":"NONE","body":"I'm running temporal locally via the latest version of https://github.com/temporalio/docker-compose, which I believe is running on 1.13.0","createdAt":"2021-11-09T21:24:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-964560739","viewerDidAuthor":false},{"id":"IC_kwDODN1w6845frYd","author":{"login":"azuisleet"},"authorAssociation":"NONE","body":"(Edited, my mistake) this issue occurred for me pre-1.10.0.\r\n\r\nCancelling a workflow concurrently with an activity completion creates an invalid state: The go state machine is trying cancel everything, even though it should actually replay the last activity completion event, due to the ordering of events in the workflow history, the cancel event appears before the completion event, hence the suggestion in https://github.com/temporalio/sdk-go/issues/481#issuecomment-898723337 that this may be a temporal service issue.\r\n\r\nIf the Go state machine were allowed to potentially replay \"alternate branches\" beyond the cancel event, it would also be able to un-stuck itself.","createdAt":"2021-11-09T22:31:34Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-964605469","viewerDidAuthor":false},{"id":"IC_kwDODN1w6845fu81","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I have opened #623 to address this.","createdAt":"2021-11-09T22:56:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-964620085","viewerDidAuthor":false},{"id":"IC_kwDODN1w6845fvsf","author":{"login":"azuisleet"},"authorAssociation":"NONE","body":"My mistake, I didn't check the version of the SDK when I was testing. I think the issue was actually mitigated with #504\r\n\r\nWhen I upgrade to 1.11.0 and temporal 1.13.1, I cannot reproduce the issue, as the cancel always appears first in the event history:\r\n\r\n![image](https://user-images.githubusercontent.com/712742/141019248-7a4beba0-824a-4a35-9f56-8b4d4b795bfb.png)\r\n\r\nedit:\r\nUpdated my comment. I also checked v1.8.0, v1.9.0, and v1.10.0. The issue stops occurring in v1.10.0\r\n\r\n","createdAt":"2021-11-09T23:02:07Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-964623135","viewerDidAuthor":false},{"id":"IC_kwDODN1w6845gcKH","author":{"login":"mnussbaum"},"authorAssociation":"NONE","body":"The temporal samples-go repo looks like it's on sdk version 1.11.0 from https://github.com/temporalio/samples-go/blob/main/go.mod#L16. Do you think the error I'm seeing from the sample's cancellation example is a different issue?\r\n\r\n```\r\n2021/11/09 15:58:54 INFO  Task processing failed with error Namespace default TaskQueue cancel-activity WorkerID 483128@tecopa@ WorkerType WorkflowWorker Error BadRequestCancelActivityAt\r\ntributes: invalid history builder state for action: add-activitytask-cancel-requested-event\r\n```","createdAt":"2021-11-10T05:40:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-964805255","viewerDidAuthor":false},{"id":"IC_kwDODN1w685lNEMP","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"The issue created as part of this was solved.","createdAt":"2023-08-29T18:19:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/481#issuecomment-1697923855","viewerDidAuthor":false}],"createdAt":"2021-06-25T18:50:36Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":481,"reactionGroups":[],"state":"CLOSED","title":"Canceling workflow can cause infinite replay attempts","updatedAt":"2023-08-29T18:19:38Z","url":"https://github.com/temporalio/sdk-go/issues/481"}
