{"assignees":[{"id":"MDQ6VXNlcjUxNzY4Mw==","login":"Sushisource","name":"Spencer Judge","databaseId":0}],"author":{"id":"MDQ6VXNlcjMyNjg5Mjgw","is_bot":false,"login":"chooilow","name":""},"body":"## Expected Behavior\r\nWorkflow should finish in a Canceled state.\r\n\r\n## Actual Behavior\r\nWorkflow remains stuck in a Running state.\r\n\r\nWorker logs:\r\n\r\n```\r\n2021/03/05 15:00:47 INFO  cancel workflow started Namespace default TaskQueue cancel-activity WorkerID 1228@DESKTOP-N6GI56U@ WorkflowType Workflow WorkflowID workflowID-to-cancel RunID 64579d93-9785-4a09-80c3-216935e67981 Attempt 1\r\n2021/03/05 15:00:47 DEBUG NewTimer Namespace default TaskQueue cancel-activity WorkerID 1228@DESKTOP-N6GI56U@ WorkflowType Workflow WorkflowID workflowID-to-cancel RunID 64579d93-9785-4a09-80c3-216935e67981 Attempt 1 TimerID 5 Duration 1m0s\r\n2021/03/05 15:00:56 DEBUG RequestCancelTimer Namespace default TaskQueue cancel-activity WorkerID 1228@DESKTOP-N6GI56U@ WorkflowType Workflow WorkflowID workflowID-to-cancel RunID 64579d93-9785-4a09-80c3-216935e67981 Attempt 1 TimerID 5\r\n2021/03/05 15:00:56 DEBUG ExecuteActivity Namespace default TaskQueue cancel-activity WorkerID 1228@DESKTOP-N6GI56U@ WorkflowType Workflow WorkflowID workflowID-to-cancel RunID 64579d93-9785-4a09-80c3-216935e67981 Attempt 1 ActivityID 10 ActivityType CleanupActivity\r\n2021/03/05 15:00:56 INFO  cleanupActivity started Namespace default TaskQueue cancel-activity WorkerID 1228@DESKTOP-N6GI56U@ ActivityID 10 ActivityType CleanupActivity Attempt 1 WorkflowType Workflow WorkflowID workflowID-to-cancel RunID 64579d93-9785-4a09-80c3-216935e67981\r\n2021/03/05 15:00:56 ERROR Workflow panic Namespace default TaskQueue cancel-activity WorkerID 1228@DESKTOP-N6GI56U@ WorkflowType Workflow WorkflowID workflowID-to-cancel RunID 64579d93-9785-4a09-80c3-216935e67981 Attempt 1 Error lookup failed for scheduledEventID to activityID: scheduleEventID: 11, activityID: 10 StackTrace process event for cancel-activity [panic]:\r\ngo.temporal.io/sdk/internal.panicIllegalState(...)\r\n        C:/Users/chooi/go/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_decision_state_machine.go:393\r\ngo.temporal.io/sdk/internal.(*commandsHelper).handleActivityTaskScheduled(0xc00006e640, 0xc00054e050, 0x2, 0xb)\r\n        C:/Users/chooi/go/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_decision_state_machine.go:878 +0x171\r\ngo.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).ProcessEvent(0xc00055ab40, 0xc00055e200, 0x4e5140001, 0x0, 0x0)\r\n        C:/Users/chooi/go/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_event_handlers.go:800 +0x41e\r\ngo.temporal.io/sdk/internal.(*workflowExecutionContextImpl).ProcessWorkflowTask(0xc0000787e0, 0xc000366540, 0x1ef2c20, 0xc0000f0150, 0xc0000787e0, 0x0)\r\n        C:/Users/chooi/go/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_task_handlers.go:876 +0x73c\r\ngo.temporal.io/sdk/internal.(*workflowTaskHandlerImpl).ProcessWorkflowTask(0xc000430210, 0xc000366540, 0xc000571ef0, 0x0, 0x0, 0x0, 0x0)\r\n        C:/Users/chooi/go/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_task_handlers.go:727 +0x759\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).processWorkflowTask(0xc00040e270, 0xc000366540, 0x0, 0x0)\r\n        C:/Users/chooi/go/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_task_pollers.go:288 +0x4ae\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).ProcessTask(0xc00040e270, 0x17af4a0, 0xc000366540, 0x19ff500, 0xc000401da0)\r\n        C:/Users/chooi/go/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_task_pollers.go:259 +0x87\r\ngo.temporal.io/sdk/internal.(*baseWorker).processTask(0xc000446000, 0x17af060, 0xc0005600c0)\r\n        C:/Users/chooi/go/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_worker_base.go:343 +0xc6\r\ncreated by go.temporal.io/sdk/internal.(*baseWorker).runTaskDispatcher\r\n        C:/Users/chooi/go/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_worker_base.go:270 +0x106\r\n```\r\n## Steps to Reproduce the Problem\r\nAdd a simple workflow.Sleep to the cancelactivity sample code, and cancel the workflow before the timer expires:\r\n```\r\nfunc Workflow(ctx workflow.Context) error {\r\n\tao := workflow.ActivityOptions{\r\n\t\tScheduleToStartTimeout: time.Minute,\r\n\t\tStartToCloseTimeout:    time.Minute * 30,\r\n\t\tHeartbeatTimeout:       time.Second * 5,\r\n\t\tWaitForCancellation:    true,\r\n\t}\r\n\tlogger := workflow.GetLogger(ctx)\r\n\tlogger.Info(\"cancel workflow started\")\r\n\r\n\tctx = workflow.WithActivityOptions(ctx, ao)\r\n\r\n\tvar a *Activities // Used to call activities by function pointer\r\n\tdefer func() {\r\n\t\t// When workflow is canceled, it has to get a new disconnected context to execute any activities\r\n\t\tnewCtx, _ := workflow.NewDisconnectedContext(ctx)\r\n\t\tworkflow.ExecuteActivity(newCtx, a.CleanupActivity).Get(ctx, nil)\r\n\t}()\r\n\r\n\tif err := workflow.Sleep(ctx, time.Minute * 1); err != nil {\r\n\t\treturn err\r\n\t}\r\n\r\n\tvar result string\r\n\terr := workflow.ExecuteActivity(ctx, a.ActivityToBeCanceled).Get(ctx, &result)\r\n\tlogger.Info(fmt.Sprintf(\"activityToBeCanceled returns %v, %v\", result, err))\r\n\r\n\terr = workflow.ExecuteActivity(ctx, a.ActivityToBeSkipped).Get(ctx, nil)\r\n\tlogger.Error(\"Error from activityToBeSkipped\", \"Error\", err)\r\n\r\n\tlogger.Info(\"Workflow completed.\")\r\n\r\n\treturn nil\r\n}\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: Latest sdk-go 1.5.0 on temporal service 1.7.0\r\n  - Platform: Windows\r\n","closedAt":"2021-03-16T17:39:17Z","comments":[],"createdAt":"2021-03-05T22:30:32Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":378,"reactionGroups":[],"state":"CLOSED","title":"Workflow panics after cleanup activity, if cancel occurs during workflow sleep","updatedAt":"2021-03-16T17:39:17Z","url":"https://github.com/temporalio/sdk-go/issues/378"}
