{"assignees":[{"id":"MDQ6VXNlcjIwNjM5Ng==","login":"cretz","name":"Chad Retz","databaseId":0}],"author":{"id":"MDQ6VXNlcjE1NzA4Mw==","is_bot":false,"login":"krousey","name":"Kris Rousey"},"body":"I have a set of workflows and activities implemented as methods on a struct. I happened to name an activity method with the same name as the workflow method. Everything actually works when running the workflow, but the test framework errors out complaining about different amount of return values. The workflow method only returns an error while the activity method returns a value and an error.\r\n\r\nIf I change the name of the activity method in all places, the tests start passing.\r\n\r\n## Expected Behavior\r\n\r\nPassing tests.\r\n\r\n## Actual Behavior\r\n\r\n```console\r\ngo test\r\n--- FAIL: Test_Workflow (0.00s)\r\n    workflows_test.go:20: \r\n        \tError Trace:\t/tmp/example/workflows_test.go:20\r\n        \tError:      \tReceived unexpected error:\r\n        \t            \tworkflow execution error (type: GenericName, workflowID: default-test-workflow-id, runID: default-test-run-id): mock of GenericName has incorrect number of returns, expected 1, but actual is 2\r\n        \tTest:       \tTest_Workflow\r\nFAIL\r\nexit status 1\r\nFAIL\texample\t0.003s\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nworkflows.go:\r\n```go\r\npackage example\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"time\"\r\n\r\n\t\"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\ntype Workflows struct{}\r\n\r\nfunc (w *Workflows) GenericName(ctx workflow.Context, input string) error {\r\n\treturn workflow.ExecuteActivity(\r\n\t\tworkflow.WithActivityOptions(ctx, workflow.ActivityOptions{\r\n\t\t\tStartToCloseTimeout: time.Minute,\r\n\t\t}),\r\n\t\tActivities{}.GenericName,\r\n\t\tinput).Get(ctx, nil)\r\n\r\n}\r\n\r\ntype Activities struct{}\r\n\r\nfunc (a Activities) GenericName(ctx context.Context, input string) (string, error) {\r\n\treturn input, nil\r\n}\r\n```\r\n\r\nworkflows_test.go:\r\n```go\r\npackage example\r\n\r\nimport (\r\n\t\"testing\"\r\n\r\n\t\"github.com/stretchr/testify/mock\"\r\n\t\"github.com/stretchr/testify/require\"\r\n\t\"go.temporal.io/sdk/testsuite\"\r\n)\r\n\r\nfunc Test_Workflow(t *testing.T) {\r\n\ttestSuite := testsuite.WorkflowTestSuite{}\r\n\tenv := testSuite.NewTestWorkflowEnvironment()\r\n\r\n\tenv.OnActivity(new(Activities).GenericName, mock.Anything, \"input\").Return(\"output\", nil)\r\n\r\n\tenv.ExecuteWorkflow(new(Workflows).GenericName, \"input\")\r\n\r\n\trequire.True(t, env.IsWorkflowCompleted())\r\n\trequire.NoError(t, env.GetWorkflowError())\r\n}\r\n```\r\n  \r\n## Specifications\r\n\r\n go.mod:\r\n```go\r\nmodule example\r\n\r\ngo 1.18\r\n\r\nrequire (\r\n\tgithub.com/stretchr/testify v1.8.0\r\n\tgo.temporal.io/sdk v1.16.0\r\n)\r\n\r\nrequire (\r\n\tgithub.com/davecgh/go-spew v1.1.1 // indirect\r\n\tgithub.com/facebookgo/clock v0.0.0-20150410010913-600d898af40a // indirect\r\n\tgithub.com/gogo/googleapis v1.4.1 // indirect\r\n\tgithub.com/gogo/protobuf v1.3.2 // indirect\r\n\tgithub.com/gogo/status v1.1.1 // indirect\r\n\tgithub.com/golang/mock v1.6.0 // indirect\r\n\tgithub.com/golang/protobuf v1.5.2 // indirect\r\n\tgithub.com/google/uuid v1.3.0 // indirect\r\n\tgithub.com/grpc-ecosystem/go-grpc-middleware v1.3.0 // indirect\r\n\tgithub.com/pborman/uuid v1.2.1 // indirect\r\n\tgithub.com/pmezard/go-difflib v1.0.0 // indirect\r\n\tgithub.com/robfig/cron v1.2.0 // indirect\r\n\tgithub.com/stretchr/objx v0.4.0 // indirect\r\n\tgo.temporal.io/api v1.11.0 // indirect\r\n\tgo.uber.org/atomic v1.9.0 // indirect\r\n\tgolang.org/x/net v0.0.0-20220728181054-f92ba40d432d // indirect\r\n\tgolang.org/x/sys v0.0.0-20220728004956-3c1f35247d10 // indirect\r\n\tgolang.org/x/text v0.3.7 // indirect\r\n\tgolang.org/x/time v0.0.0-20210723032227-1f47c861a9ac // indirect\r\n\tgoogle.golang.org/genproto v0.0.0-20220725144611-272f38e5d71b // indirect\r\n\tgoogle.golang.org/grpc v1.48.0 // indirect\r\n\tgoogle.golang.org/protobuf v1.28.1 // indirect\r\n\tgopkg.in/yaml.v3 v3.0.1 // indirect\r\n)\r\n\r\n```\r\n","closedAt":"2024-04-03T23:32:37Z","comments":[{"id":"IC_kwDODN1w685JHz-o","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I am not sure this is related to naming. It seems you have an activity that returns just a single `error` and a mock that is returning an actual output and a nil error. Hence the message \"incorrect number of returns, expected 1, but actual is 2\".\r\n\r\nYour mock return count should match your definition's return count.","createdAt":"2022-08-25T05:14:15Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/887#issuecomment-1226784680","viewerDidAuthor":false},{"id":"IC_kwDODN1w685JK_7I","author":{"login":"krousey"},"authorAssociation":"MEMBER","body":"I do not have an activity that returns a single `error`. I have an activity that returns `(string, error)`. I have a workflow with the same function name that returns just an `error`.  The most important indication that this is a naming issue is what I said in the original report:\r\n\r\n## **If I change the name of the activity method in all places, the tests start passing.**\r\n\r\nI think there's a general limitation in Temporal that you can't name the activity the same as the workflow.  But Temporal allows you to register workflows with well-known names not derived from the function names like:\r\n\r\n```go\r\nw.RegisterWorkflowWithOptions(wf.GenericName, workflow.RegisterOptions{Name: \"different-wf-name\"})\r\n```\r\n\r\nHowever, in the workflow testsuite, I don't register the workflow. I also don't register activities. I didn't expect this to be an issue since it doesn't appear that I'm registering either activities or workflows.\r\n\r\nI think I've traced it down to the workflow testsuite registering workflows and activities under the hood, but not allowing registration options to prevent name collisions.\r\n\r\nThe activity is registered under the hood during `env.OnActivity` here: https://github.com/temporalio/sdk-go/blob/master/internal/workflow_testsuite.go#L334\r\n\r\nThe workflow is registered under the hood during `env.ExecuteWorkflow` here: https://github.com/temporalio/sdk-go/blob/master/internal/internal_workflow_testsuite.go#L451\r\n\r\n\r\nSo the crux of this bug is \"Perfectly valid workflow code can't be tested using the `TestWorkflowEnvironment`\"","createdAt":"2022-08-25T18:28:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/887#issuecomment-1227620040","viewerDidAuthor":false},{"id":"IC_kwDODN1w685JVTMW","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I see, thanks for the update. I will try to replicate shortly. It is possible we are reusing a mock somewhere.","createdAt":"2022-08-29T13:37:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/887#issuecomment-1230320406","viewerDidAuthor":false},{"id":"IC_kwDODN1w685JWyEt","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@krousey - I have replicated this and have confirmed the workflow environment uses a shared mock for its workflow and activities call ðŸ˜ž. Specifically the `OnActivity` registers the mock and the `ExecuteWorkflow` checks for mocks before running the actual method. That's where the error is happening.\r\n\r\nI am unsure I can break these out into separate mocks at this time without breaking backwards compatibility and upsetting how things like https://pkg.go.dev/go.temporal.io/sdk/internal#TestWorkflowEnvironment.AssertNotCalled are meant to work for workflow or activity invocations.\r\n\r\nI am thinking about just documenting this limitation. Is this acceptable for now or do you think it's worth the effort to separate the mocks?","createdAt":"2022-08-29T18:38:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/887#issuecomment-1230709037","viewerDidAuthor":false},{"id":"IC_kwDODN1w685JXVo1","author":{"login":"krousey"},"authorAssociation":"MEMBER","body":"I'm not sure what the appropriate level of effort is here. It's an easy fix on my end, just frustrating to figure out the actual issue.\r\n\r\nOther than splitting the mocks, allowing aliasing could work. If fixes aren't possible, documentation is fine. Detecting the situation and emitting an appropriate error message is even better.","createdAt":"2022-08-29T20:59:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/887#issuecomment-1230854709","viewerDidAuthor":false},{"id":"IC_kwDODN1w685JXal1","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Unfortunately you can have multiple mocks of the same name I believe with different behaviors based on param matching. I will research some solutions, worst case being just documenting this limitation.","createdAt":"2022-08-29T21:21:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/887#issuecomment-1230874997","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Z8mAZ","author":{"login":"netixen"},"authorAssociation":"NONE","body":"I just stumbled on to the same bug with a twist. The collision was between two workflows in different packages.\r\nSuch as `bluepackage.Workflow` and `greenpackage.Workflow`.","createdAt":"2023-04-14T18:25:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/887#issuecomment-1509056537","viewerDidAuthor":false},{"id":"IC_kwDODN1w685svfzg","author":{"login":"ignatk"},"authorAssociation":"NONE","body":"Hit the same here. I can see we don't incorporate the type information into mock names. Perhaps if we do so it will allow the mock framework to disambiguate?","createdAt":"2023-11-23T12:55:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/887#issuecomment-1824390368","viewerDidAuthor":false},{"id":"IC_kwDODN1w685swP4T","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Unfortunately the challenge here is not  disambiguating inside the SDK,  the challenge is doing it in  a way  that doesn't break the user facing API, which is impossible","createdAt":"2023-11-23T15:07:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/887#issuecomment-1824587283","viewerDidAuthor":false},{"id":"IC_kwDODN1w685swbV7","author":{"login":"ignatk"},"authorAssociation":"NONE","body":"I see. I must admit I'm new to temporal and not familiar with the code base, but it seems a bit weird that a change in the testing framework may break user facing API? Can, for example `TestWorkflowEnvironment` have different behaviour than \"real\" workflow environment?","createdAt":"2023-11-23T15:41:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/887#issuecomment-1824634235","viewerDidAuthor":false},{"id":"IC_kwDODN1w6854UeKx","author":{"login":"krousey"},"authorAssociation":"MEMBER","body":"did https://github.com/temporalio/sdk-go/pull/1371 fix this?","createdAt":"2024-03-25T18:20:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/887#issuecomment-2018632369","viewerDidAuthor":false}],"createdAt":"2022-08-22T04:19:17Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":887,"reactionGroups":[],"state":"CLOSED","title":"TestSuite: Workflow names seemingly collide with activity names in mock expectations","updatedAt":"2024-04-03T23:32:37Z","url":"https://github.com/temporalio/sdk-go/issues/887"}
