{"assignees":[],"author":{"id":"U_kgDOBdaNMA","is_bot":false,"login":"Pharaohsk","name":"Su"},"body":"## Expected Behavior\nIn a three-node cluster using Temporal, the time on each node is not synchronized. The Temporal server is deployed on the main control node, where Service A starts a workflow and sets configurations such as ScheduleToCloseTimeout and other timeout settings. When the task is scheduled to execute on Service B on node B, the local time on node B is later than that on node A. As a result, when Service B executes the task, its local time has already exceeded the timeout. It is expected that no error will be reported.\n\n## Actual Behavior\nreturn err : Activity complete after timeout..\nFile : internal/internal_task_handlers.go\n```go\n\tinfo := getActivityEnv(ctx)\n\tctx, dlCancelFunc := context.WithDeadline(ctx, info.deadline)\n\tdefer dlCancelFunc()\n\n\toutput, err := activityImplementation.Execute(ctx, t.Input)\n\t// Check if context canceled at a higher level before we cancel it ourselves\n\tisActivityCancel := ctx.Err() == context.Canceled\n\n\tdlCancelFunc()\n\tif <-ctx.Done(); ctx.Err() == context.DeadlineExceeded {\n\t\tath.logger.Info(\"Activity complete after timeout.\",\n\t\t\ttagWorkflowID, t.WorkflowExecution.GetWorkflowId(),\n\t\t\ttagRunID, t.WorkflowExecution.GetRunId(),\n\t\t\ttagActivityType, activityType,\n\t\t\ttagAttempt, t.Attempt,\n\t\t\ttagResult, output,\n\t\t\ttagError, err,\n\t\t)\n\t\treturn nil, ctx.Err()\n\t}\n```\nI think the code should use context.WithTimeout instead of context.WithDeadline(ctx, info.deadline).\n\n## Steps to Reproduce the Problem\n\n  1.Use Temporal in a cluster with two or more nodes, with the Temporal server running on the main control node.\n  2.Configure the task timeout and allow the task to be scheduled for execution on another node.\n  3.Modify the time on all hosts in the cluster to be unsynchronized, with the time difference exceeding the configured task timeout.\n\n## Specifications\n\n  - Version: v1.22.0\n  - Platform: go version go1.18 linux\n","closedAt":"2025-04-23T13:12:41Z","comments":[{"id":"IC_kwDODN1w686nAXri","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Interesting. The deadline calculated on the worker is based on the server start-time of the task because that's how server uses it. The server will timeout the activity for the same period of time, this is just a worker-side to keep activities from running forever. The time is started when the server starts the task, not when the worker starts the task. I am not sure we support situations of significant clock skew. I think there is an expectation that server and worker clocks must be reasonably accurate and that timeouts should be set high enough to not be hit except in rare/failure scenarios.\n\nI will confer with the team, but we'd strongly recommend clock accuracy and timeouts high enough to overcome and skew difference.","createdAt":"2025-04-14T14:24:41Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1912#issuecomment-2801892066","viewerDidAuthor":false},{"id":"IC_kwDODN1w686n3FZO","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"After conferring with team, we may be able to make deadline relative for start to close timeout, but we cannot for schedule to close.","createdAt":"2025-04-18T21:38:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1912#issuecomment-2816235086","viewerDidAuthor":false},{"id":"IC_kwDODN1w686oVs0O","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"We have opened #1926 to warn when SDK and server clocks vary significantly, and we have opened #1930 to have start-to-close timeout be relative to local time instead of server time. We cannot do this with schedule to close, because there is no local-time equivalent of when first scheduled to base the timeout off of so we have to use the server time.\n\n(closing issue in favor of those two issues, but feel free to keep commenting)","createdAt":"2025-04-23T13:12:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1912#issuecomment-2824260878","viewerDidAuthor":false}],"createdAt":"2025-04-13T14:02:40Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDg2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1912,"reactionGroups":[],"state":"CLOSED","title":"activity Schedule To Close timeout（Activity complete after timeout）","updatedAt":"2025-04-23T13:12:42Z","url":"https://github.com/temporalio/sdk-go/issues/1912"}
