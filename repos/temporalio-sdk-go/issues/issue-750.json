{"assignees":[],"author":{"id":"MDQ6VXNlcjUzMjEwOA==","is_bot":false,"login":"Spikhalskiy","name":"Dmitry Spikhalsky"},"body":"Temporal GoSDK should issue metrics in compliance with OpenMetrics specification to allow having a single dashboard and set of Grafana queries for both Java and Go SDKs. \r\nJavaSDK is already compliant with the spec.\r\nProbably the best solution would be to temporarily expose corrected metrics in addition to the old format. An alternative solution would be to provide an opt-in configuration option to the new format. \r\n\r\n# Counters\r\n\r\n**Counter metrics should have `_total` postfix.**\r\n\r\nSpecification:\r\n- https://github.com/OpenObservability/OpenMetrics/blob/main/specification/OpenMetrics.md#counter \r\n\r\n> A MetricPoint in a Metric with the type Counter MUST have one value called Total.\r\n\r\n- https://github.com/OpenObservability/OpenMetrics/blob/main/specification/OpenMetrics.md#counter-1\r\n\r\n> The MetricPoint’s Total Value Sample MetricName MUST have the suffix _total\r\n\r\n# Timers \r\n\r\n**Timer metrics exported as histograms should have `_seconds` postfix before the existing `_bucket` postfix.**\r\n\r\nSpecification:\r\n- https://prometheus.io/docs/practices/naming/ \r\n\r\n> ...should have a suffix describing the unit, in plural form. Note that an accumulating count has total as a suffix, in addition to the unit if applicable.\r\n>   - http_request_duration_seconds\r\n\r\n- https://github.com/OpenObservability/OpenMetrics/blob/main/specification/OpenMetrics.md#unit\r\n\r\n> Unit specifies MetricFamily units. If non-empty, it MUST be a suffix of the MetricFamily name separated by an underscore.\r\n\r\n# Additional context\r\n\r\n## Complete Exposition examples\r\n\r\nThere is a good example in OpenMetrics of what the correct “complete exposition” looks like for different types:\r\nhttps://github.com/OpenObservability/OpenMetrics/blob/main/specification/OpenMetrics.md#overall-structure\r\n~~~~\r\n# TYPE acme_http_router_request_seconds summary\r\n# UNIT acme_http_router_request_seconds seconds\r\n# HELP acme_http_router_request_seconds Latency though all of ACME's HTTP request router.\r\nacme_http_router_request_seconds_sum{path=\"/api/v1\",method=\"GET\"} 9036.32\r\nacme_http_router_request_seconds_count{path=\"/api/v1\",method=\"GET\"} 807283.0\r\nacme_http_router_request_seconds_created{path=\"/api/v1\",method=\"GET\"} 1605281325.0\r\nacme_http_router_request_seconds_sum{path=\"/api/v2\",method=\"POST\"} 479.3\r\nacme_http_router_request_seconds_count{path=\"/api/v2\",method=\"POST\"} 34.0\r\nacme_http_router_request_seconds_created{path=\"/api/v2\",method=\"POST\"} 1605281325.0\r\n# TYPE go_goroutines gauge\r\n# HELP go_goroutines Number of goroutines that currently exist.\r\ngo_goroutines 69\r\n# TYPE process_cpu_seconds counter\r\n# UNIT process_cpu_seconds seconds\r\n# HELP process_cpu_seconds Total user and system CPU time spent in seconds.\r\nprocess_cpu_seconds_total 4.20072246e+06\r\n# EOF\r\n~~~~\r\n\r\n## Reference implementation in Micrometer\r\n\r\nIn Micrometer, the OpenMetrics/Prometheus convention is enforced in `PrometheusNamingConvention` class.\r\n\r\n`_total`: https://github.com/micrometer-metrics/micrometer/blob/main/implementations/micrometer-registry-prometheus/src/main/java/io/micrometer/prometheus/PrometheusNamingConvention.java#L66\r\n`_seconds`: https://github.com/micrometer-metrics/micrometer/blob/main/implementations/micrometer-registry-prometheus/src/main/java/io/micrometer/prometheus/PrometheusNamingConvention.java#L73\r\n\r\n# Examples of metrics that are currently exported between Go and Java\r\n\r\n| Go | Java |\r\n|----|------|\r\n| temporal_request | temporal_request_total |\r\n| temporal_activity_execution_latency_bucket | temporal_activity_execution_latency_seconds_bucket |\r\n| temporal_workflow_canceled | temporal_workflow_canceled_total |\r\n|temporal_workflow_continue_as_new | temporal_workflow_continue_as_new_total|\r\n|temporal_workflow_task_execution_latency_bucket | temporal_workflow_task_execution_latency_seconds_bucket|\r\n|temporal_activity_execution_failed | temporal_activity_execution_failed_total|","closedAt":"2022-03-28T17:00:36Z","comments":[],"createdAt":"2022-03-10T00:28:26Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDky","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":750,"reactionGroups":[],"state":"CLOSED","title":"Sync metrics format with OpenMetrics and JavaSDK","updatedAt":"2022-03-28T17:00:36Z","url":"https://github.com/temporalio/sdk-go/issues/750"}
