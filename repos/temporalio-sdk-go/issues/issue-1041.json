{"assignees":[],"author":{"id":"MDQ6VXNlcjE1Njc0MTQ5","is_bot":false,"login":"raymondsze","name":"Sze Ka Wai Raymond"},"body":"## Expected Behavior\r\nI expect the parent workflow can be run successfully and only one child workflow is executed (because same workflow id). \r\n\r\n## Actual Behavior\r\nIt hanged in the second child workflow `childWorkflowFuture.GetChildWorkflowExecution().Get(ctx, &childWE)`. \r\n\r\n## Steps to Reproduce the Problem\r\nI followed the documentation in https://legacy-documentation-sdks.temporal.io/go/spawn-a-child-workflow-execution.\r\nIf I spawn two childworkflow, both with the same workflowId. The second one will be hanged when calling `childWorkflowFuture.GetChildWorkflowExecution().Get(ctx, &childWE)`. What I want to do is, if the child workflow is already registered and running, then don't do anything. If the child workflow is completed or not yet registered, then register and run the child workflow without waiting. \r\n\r\n## Specifications\r\n\r\n  - Version:\r\n  - Platform:\r\n","closedAt":"2023-03-16T20:45:18Z","comments":[{"id":"IC_kwDODN1w685Vasi3","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Can you provide the SDK version you are using (to see if it includes https://github.com/temporalio/sdk-go/pull/999) and if possible provide a small amount of code to demonstrate this? You should be able to respond to the duplicate error coming back from that `Get`.","createdAt":"2023-02-16T13:06:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1041#issuecomment-1433061559","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Vecqq","author":{"login":"raymondsze"},"authorAssociation":"NONE","body":"Sure. The sdk version is the latest,  v1.21.1\r\n```go\r\n\r\nfunc ConsumerWorkflow(ctx workflow.Context) error {\r\n\tlogger := workflow.GetLogger(ctx)\r\n\tfor i := 0; i < 2; i++ {\r\n\t\tchildWorkflowOptions := workflow.ChildWorkflowOptions{\r\n\t\t\tParentClosePolicy:     enums.PARENT_CLOSE_POLICY_ABANDON,\r\n\t\t\tWorkflowID:            fmt.Sprintf(\"consumer-%v-%v\", workflow.GetInfo(ctx).WorkflowExecution.ID, 0),\r\n\t\t\tWorkflowIDReusePolicy: enums.WORKFLOW_ID_REUSE_POLICY_REJECT_DUPLICATE,\r\n\t\t}\r\n\t\tctx = workflow.WithChildOptions(ctx, childWorkflowOptions)\r\n\t\tlogger.Info(\"BEFORE EXECUTE!\")\r\n\t\tchildWorkflow := workflow.ExecuteChildWorkflow(ctx, ChildWorkflow, i)\r\n\t\tlogger.Info(\"AFTER EXECUTE!\")\r\n\t\tlogger.Info(\"BEFORE GET EXECUTION!\")\r\n\t\t_ = childWorkflow.GetChildWorkflowExecution().Get(ctx, nil)\r\n\t\tlogger.Info(\"AFTER GET EXECUTION!\")\r\n\t}\r\n\treturn nil\r\n}\r\n```\r\n\r\nHere is the log\r\n\r\nWorker\r\n```bash\r\n2023/02/17 11:22:28 INFO  No logger configured for temporal client. Created default one.\r\n2023/02/17 11:22:28 INFO  Started Worker Namespace default TaskQueue hello-world WorkerID 4822@Raymond@\r\n2023/02/17 11:22:39 INFO  BEFORE EXECUTE! Namespace default TaskQueue hello-world WorkerID 4822@Raymond@ WorkflowType ConsumerWorkflow WorkflowID hello_world_1626421842992435200 RunID ea2be856-3b9d-452e-8f7d-b4b439f489b9 Attempt 1\r\n2023/02/17 11:22:39 DEBUG ExecuteChildWorkflow Namespace default TaskQueue hello-world WorkerID 4822@Raymond@ WorkflowType ConsumerWorkflow WorkflowID hello_world_1626421842992435200 RunID ea2be856-3b9d-452e-8f7d-b4b439f489b9 Attempt 1 ChildWorkflowID consumer-hello_world_1626421842992435200-0 WorkflowType ChildWorkflow\r\n2023/02/17 11:22:39 INFO  AFTER EXECUTE! Namespace default TaskQueue hello-world WorkerID 4822@Raymond@ WorkflowType ConsumerWorkflow WorkflowID hello_world_1626421842992435200 RunID ea2be856-3b9d-452e-8f7d-b4b439f489b9 Attempt 1\r\n2023/02/17 11:22:39 INFO  BEFORE GET EXECUTION! Namespace default TaskQueue hello-world WorkerID 4822@Raymond@ WorkflowType ConsumerWorkflow WorkflowID hello_world_1626421842992435200 RunID ea2be856-3b9d-452e-8f7d-b4b439f489b9 Attempt 1\r\n2023/02/17 11:22:39 INFO  AFTER GET EXECUTION! Namespace default TaskQueue hello-world WorkerID 4822@Raymond@ WorkflowType ConsumerWorkflow WorkflowID hello_world_1626421842992435200 RunID ea2be856-3b9d-452e-8f7d-b4b439f489b9 Attempt 1\r\n2023/02/17 11:22:39 INFO  BEFORE EXECUTE! Namespace default TaskQueue hello-world WorkerID 4822@Raymond@ WorkflowType ConsumerWorkflow WorkflowID hello_world_1626421842992435200 RunID ea2be856-3b9d-452e-8f7d-b4b439f489b9 Attempt 1\r\n2023/02/17 11:22:39 INFO  AFTER EXECUTE! Namespace default TaskQueue hello-world WorkerID 4822@Raymond@ WorkflowType ConsumerWorkflow WorkflowID hello_world_1626421842992435200 RunID ea2be856-3b9d-452e-8f7d-b4b439f489b9 Attempt 1\r\n2023/02/17 11:22:39 INFO  BEFORE GET EXECUTION! Namespace default TaskQueue hello-world WorkerID 4822@Raymond@ WorkflowType ConsumerWorkflow WorkflowID hello_world_1626421842992435200 RunID ea2be856-3b9d-452e-8f7d-b4b439f489b9 Attempt 1\r\n```\r\nThe \"AFTER GET EXECUTION!\" line didn't print for the 2nd child workflow that with the same workflow id. And the workflow keeps \"Running\" status.\r\n\r\nClient\r\n```\r\n2023/02/17 11:22:39 INFO  No logger configured for temporal client. Created default one.\r\n2023/02/17 11:22:39 Started workflow WorkflowID hello_world_1626421842992435200 RunID ea2be856-3b9d-452e-8f7d-b4b439f489b9\r\n```","createdAt":"2023-02-17T03:26:22Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1041#issuecomment-1434045098","viewerDidAuthor":false},{"id":"IC_kwDODN1w685VfYET","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"I can reproduce this looks like `WorkflowIDReusePolicy: enums.WORKFLOW_ID_REUSE_POLICY_REJECT_DUPLICATE` is not handled correctly","createdAt":"2023-02-17T08:25:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1041#issuecomment-1434288403","viewerDidAuthor":false},{"id":"IC_kwDODN1w685VfnnC","author":{"login":"raymondsze"},"authorAssociation":"NONE","body":"@Quinn-With-Two-Ns \r\nAny workaround or I need wait a fix?","createdAt":"2023-02-17T09:13:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1041#issuecomment-1434352066","viewerDidAuthor":false},{"id":"IC_kwDODN1w685VfqHR","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"I'll take a look, one obvious work around is to not using the same workflow ID for any child workflow.","createdAt":"2023-02-17T09:19:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1041#issuecomment-1434362321","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Vfu66","author":{"login":"raymondsze"},"authorAssociation":"NONE","body":"But this is what I wanna achieve.\r\n\r\nIf the child workflow does not exists --> start the child workflow\r\nIf the child workflow already exists and completed --> restart the child workflow\r\nIf the child workflow already exists and running --> do nothing\r\n\r\nbasically it is like a notifier to notify the child workflow there is a new message in something like mailbox, the child workflow is responsible to take the messages out of the mailbox. If the child is already picking message, then don't do anything to make sure only one child workflow is running.","createdAt":"2023-02-17T09:38:16Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1041#issuecomment-1434382010","viewerDidAuthor":false},{"id":"IC_kwDODN1w685VgsTl","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Since it's your workflow, you know whether you've started a child or not. You can maintain a set of child workflow futures keyed by their ID to get-or-create. Granted we need to fix this issue, but you still control what children you start and can easily check for your conditions.","createdAt":"2023-02-17T13:11:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1041#issuecomment-1434633445","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Vh5Qq","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"The problem appears to be from this PR https://github.com/temporalio/sdk-go/pull/999 the `ChildWorkflowExecutionAlreadyStartedError` is only set on one of the two futures child workflow use, so waiting on the execution future never unblocks. @Sushisource I can't see why we wouldn't propagate the error to both futures?","createdAt":"2023-02-17T17:11:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1041#issuecomment-1434948650","viewerDidAuthor":false},{"id":"IC_kwDODN1w685XG-df","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"This would break determinism if someone waited on the execution future in a selector, probably the best thing to do here is to use `SDKFlags` implemented here https://github.com/temporalio/sdk-go/pull/1056 to version the fix.","createdAt":"2023-03-09T07:09:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1041#issuecomment-1461446495","viewerDidAuthor":false}],"createdAt":"2023-02-16T11:45:23Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1041,"reactionGroups":[],"state":"CLOSED","title":"Workflow got hanged if spawn childWorkflow with same workflowId","updatedAt":"2023-03-16T20:45:18Z","url":"https://github.com/temporalio/sdk-go/issues/1041"}
