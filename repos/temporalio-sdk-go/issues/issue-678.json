{"assignees":[],"author":{"id":"MDQ6VXNlcjEwNjA4NzM=","is_bot":false,"login":"tminusplus","name":"Travis"},"body":"## Expected Behavior\r\n\r\nNo panic should occur while the worker is executing an activity.\r\n\r\n## Actual Behavior\r\n\r\nWorker panics intermittently while executing an activity.\r\n\r\nStack Trace:\r\n```\r\nexternal/io_temporal_go_sdk/internal/internal_workflow.go:499 +0xd2\r\ngo.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func1({0x2745f38, 0xc000439bc0})\r\n\texternal/io_temporal_go_sdk/internal/internal_worker.go:741 +0x292\r\ngo.temporal.io/sdk/internal.(*workflowExecutor).Execute(0xc0034d6580, {0x2745de8, 0xc0034d6600}, 0x25)\r\n\texternal/io_temporal_go_sdk/internal/workflow.go:415 +0x166\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteWorkflow(0xc00b7ab9f0, {0x2745de8, 0xc0034d6600}, 0xc0045cb7e8)\r\n\texternal/io_temporal_go_sdk/internal/internal_worker.go:1512 +0x136\r\ngo.temporal.io/sdk/internal.executeFunction({0x11802e0, 0xc0003f1ee0}, {0xc001471e08, 0x1, 0xc001420000})\r\n\tGOROOT/src/reflect/value.go:339 +0xc5\r\nreflect.Value.Call({0x11802e0, 0xc0003f1ee0, 0x403c6c}, {0xc0045cb800, 0x1, 0x1})\r\n\tGOROOT/src/reflect/value.go:543 +0x814\r\n... service backtrace for workflow ...\r\ngo.temporal.io/sdk/workflow.ExecuteActivity(...)\r\n\texternal/io_temporal_go_sdk/internal/workflow.go:455 +0x185\r\ngo.temporal.io/sdk/internal.ExecuteActivity({0x2745f38, 0xc000439d70}, {0x11cb080, 0x254c158}, {0xc000474fc0, 0x1, 0x1})\r\n\texternal/io_temporal_go_sdk/internal/workflow.go:511 +0x782\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteActivity(0xc00b7ab9f0, {0x2745f38, 0xc000439dd0}, {0x29d3360, 0x6}, {0xc000474fc0, 0x1, 0x1})\r\n\texternal/io_temporal_go_sdk/internal/internal_event_handlers.go:463 +0x545\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentImpl).ExecuteActivity(0xc000100e00, {{{0x0, 0x0}, {0xc00004bb00, 0xf}, 0x0, 0x0, 0x1a3185c5000, 0x0, 0x0, ...}, ...}, ...)\r\n\texternal/io_temporal_go_sdk/internal/internal_event_handlers.go:452\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentImpl).GenerateSequence(...)\r\n\texternal/io_temporal_go_sdk/internal/internal_decision_state_machine.go:833\r\ngo.temporal.io/sdk/internal.(*commandsHelper).getNextID(...)\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nWe haven't been able to reproduce this, as it infrequently occurs. The workflow we are running is on a cron schedule and I've edited one of the example workflows to match its behavior:\r\n```\r\nfunc SampleBranchWorkflow(ctx workflow.Context, totalBranches int) (result []string, err error) {\r\n\tao := workflow.ActivityOptions{\r\n\t\tStartToCloseTimeout: 10 * time.Second,\r\n\t}\r\n\tctx = workflow.WithActivityOptions(ctx, ao)\r\n\r\n        var futures []workflow.Future\r\n        for batch := 0; batch < 10; batch++ {\r\n\t    for i := 1; i <= totalBranches; i++ {\r\n\t\tfuture := workflow.ExecuteActivity(ctx, SampleActivity, activityInput)\r\n\t\tfutures = append(futures, future)\r\n\t    }\r\n \r\n            // Block until this batch finishes processing\r\n            for _, future := range futures {\r\n\t\terr = future.Get(ctx, nil)\r\n\t\tif err != nil {\r\n\t\t\treturn\r\n\t\t}\r\n\t    }\r\n        }\r\n\r\n\t// One last sweep to ensure all scheduled activities are complete\r\n\tfor _, future := range futures {\r\n            err = future.Get(ctx, nil)\r\n\t    if err != nil {\r\n\t\treturn\r\n\t    }\r\n\t}\r\n}\r\n```\r\n\r\nThe activity we run downloads an archive, processes files within it, and then uploads the result.\r\n\r\nI am keeping an eye on our workers for this, to see if I can provide more information and figure out steps to reproduce the issue. \r\n\r\nI will also make the recommended changes in https://github.com/temporalio/sdk-go/issues/475 to only check the futures once, and see if the issue still occurs like that.\r\n\r\n## Specifications\r\n\r\n  - Version: SDK v1.11.1 and Temporal v1.12.3\r\n  - Platform: Linux\r\n","closedAt":"2022-06-01T13:31:11Z","comments":[{"id":"IC_kwDODN1w6847meCV","author":{"login":"tminusplus"},"authorAssociation":"NONE","body":"We had this happen on another workflow which has a cron schedule. This one basically the sample cron workflow, and the activity uses a heartbeat:\r\n```\r\n// SampleCronWorkflow executes on the given schedule\r\n// The schedule is provided when starting the Workflow\r\nfunc SampleCronWorkflow(ctx workflow.Context) (*CronResult, error) {\r\n\r\n\tworkflow.GetLogger(ctx).Info(\"Cron workflow started.\", \"StartTime\", workflow.Now(ctx))\r\n\r\n\tao := workflow.ActivityOptions{\r\n\t\tStartToCloseTimeout: 10 * time.Second,\r\n\t}\r\n\tctx1 := workflow.WithActivityOptions(ctx, ao)\r\n\r\n\t// Start from 0 for first cron job\r\n\tlastRunTime := time.Time{}\r\n\t// Check to see if there was a previous cron job\r\n\tif workflow.HasLastCompletionResult(ctx) {\r\n\t\tvar lastResult CronResult\r\n\t\tif err := workflow.GetLastCompletionResult(ctx, &lastResult); err == nil {\r\n\t\t\tlastRunTime = lastResult.RunTime\r\n\t\t}\r\n\t}\r\n\tthisRunTime := workflow.Now(ctx)\r\n\r\n\terr := workflow.ExecuteActivity(ctx1, DoSomething, lastRunTime, thisRunTime).Get(ctx, nil)\r\n\tif err != nil {\r\n\t\t// Cron job failed\r\n\t\t// Next cron will still be scheduled by the Server\r\n\t\tworkflow.GetLogger(ctx).Error(\"Cron job failed.\", \"Error\", err)\r\n\t\treturn nil, err\r\n\t}\r\n\r\n\treturn &CronResult{RunTime: thisRunTime}, nil\r\n}\r\n```\r\n\r\nThe error logs are as follows, had to redact sensitive information but the workflow IDs are the same for all the log lines:\r\n```\r\n18:22:33 DEBUG ExecuteActivity …redacted… RunID f4c08e61-65c8-4e9a-88a4-3300bed6cafd Attempt 1 …redacted…\r\n18:15:06 INFO  Task processing failed with error WorkerType WorkflowWorker Error Workflow executionsRow not found.  …redacted… RunId: 2c879b3e-45bd-4532-9542-1fb888677a9b\r\n18:15:06 WARN  Failed to process workflow task. …redacted… RunID f4c08e61-65c8-4e9a-88a4-3300bed6cafd Attempt 1 Error Attempt to generate a command before processing WorkflowTaskStarted event\r\n\texternal/io_temporal_go_sdk/internal/internal_workflow.go:499 +0xd2\r\ngo.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func1({0x276a398, 0xc0004a18f0})\r\n\texternal/io_temporal_go_sdk/internal/internal_worker.go:741 +0x292\r\ngo.temporal.io/sdk/internal.(*workflowExecutor).Execute(0xc000be4580, {0x276a248, 0xc000be4600}, 0x25)\r\n\texternal/io_temporal_go_sdk/internal/workflow.go:415 +0x166\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteWorkflow(0xc001373ea0, {0x276a248, 0xc000be4600}, 0xc0012fbb48)\r\n\texternal/io_temporal_go_sdk/internal/internal_worker.go:1512 +0x136\r\ngo.temporal.io/sdk/internal.executeFunction({0x11c8fe0, 0xc0014ef430}, {0xc001088e08, 0x1, 0xc00005e400})\r\n\tGOROOT/src/reflect/value.go:339 +0xc5\r\nreflect.Value.Call({0x11c8fe0, 0xc0014ef430, 0x403c6c}, {0xc0012fbb60, 0x1, 0x1})\r\n\tGOROOT/src/reflect/value.go:543 +0x814\r\nreflect.Value.call({0x11c8fe0, 0xc0014ef430, 0x7f15f77fb5b8}, {0x13e726c, 0x4}, {0xc0012fbb60, 0x1, 0xa})\r\n... service backtrace for workflow ...\r\n\texternal/io_temporal_go_sdk/workflow/workflow.go:113\r\ngo.temporal.io/sdk/workflow.ExecuteActivity(...)\r\n\texternal/io_temporal_go_sdk/internal/workflow.go:455 +0x185\r\ngo.temporal.io/sdk/internal.ExecuteActivity({0x276a398, 0xc0004a19e0}, {0x11ea880, 0xc000ba46d0}, {0xc000ba46e0, 0x1, 0x1})\r\n\texternal/io_temporal_go_sdk/internal/workflow.go:511 +0x782\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteActivity(0xc001373ea0, {0x276a398, 0xc0004a1a70}, {0x297b409, 0x11}, {0xc000ba46e0, 0x1, 0x1})\r\n\texternal/io_temporal_go_sdk/internal/internal_event_handlers.go:463 +0x545\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentImpl).ExecuteActivity(0xc000d07600, {{{0x0, 0x0}, {0xc0000b99a0, 0xf}, 0x0, 0x0, 0x6fc23ac00, 0x2540be400, 0x0, ...}, ...}, ...)\r\n\texternal/io_temporal_go_sdk/internal/internal_event_handlers.go:452\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentImpl).GenerateSequence(...)\r\n\texternal/io_temporal_go_sdk/internal/internal_decision_state_machine.go:833\r\ngo.temporal.io/sdk/internal.(*commandsHelper).getNextID(...)\r\n```\r\n\r\nThe run 2c879b3e-45bd-4532-9542-1fb888677a9b ID does not exist in our logs and within the namespace history, the only mention of it anywhere is in that error message.","createdAt":"2021-12-22T23:31:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/678#issuecomment-999940245","viewerDidAuthor":false},{"id":"IC_kwDODN1w6847yyYu","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Sorry it took me a bit to get to this.\r\n\r\nDo you do anything besides heartbeat to affect the workflow externally? I know you mentioned no queries, but maybe signals? I wonder if there is an activity cancel or a heartbeat or something that is trying to run on the newly scheduled workflow before it starts.\r\n\r\nI do think this may be related #475 (which is pending https://github.com/temporalio/temporal/issues/2300) but may not be specifically concerning queries. Basically it seems something is trying to be processed on the newly-scheduled-but-not-yet-started workflow causing this issue. Have you been able to somewhat-reliably replicate yet? I will attempt to do so as well.","createdAt":"2021-12-30T20:19:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/678#issuecomment-1003169326","viewerDidAuthor":false},{"id":"IC_kwDODN1w6849aYMA","author":{"login":"tminusplus"},"authorAssociation":"NONE","body":"@cretz likewise, apologies on the delayed response. \r\n\r\nWe do not have any queries or signals running on the workflow, other than the web UI.\r\n\r\nWe updated our Temporal server from v1.12.3 to v1.14.2 a month ago and haven't seen the issue again. I looked through the release notes for the server and was unable to find anything that sounds directly related to this. Will keep an eye on our logs and see if it appears again.","createdAt":"2022-02-04T20:26:51Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/678#issuecomment-1030324992","viewerDidAuthor":false},{"id":"IC_kwDODN1w6849alZJ","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":":+1: I will leave this open for a bit to see if you can replicate.","createdAt":"2022-02-04T21:53:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/678#issuecomment-1030379081","viewerDidAuthor":false},{"id":"IC_kwDODN1w6849goEg","author":{"login":"tminusplus"},"authorAssociation":"NONE","body":"Awesome thanks, will continue slow rolling this. if you ever want to clear this out of the issue board no worries, I can open a new one too and refer back to this. \r\n\r\nAlso I confirmed on another server that this occurs on server v1.13.1. So perhaps something in the upgrade from v1.13 to v1.14 either made this less common or fixed it.","createdAt":"2022-02-07T21:46:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/678#issuecomment-1031962912","viewerDidAuthor":false},{"id":"IC_kwDODN1w685EKjS6","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Clearing out to defer to #475 ","createdAt":"2022-06-01T13:31:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/678#issuecomment-1143616698","viewerDidAuthor":false}],"createdAt":"2021-12-22T23:11:21Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"},{"id":"LA_kwDODN1w687UGgkJ","name":"external dependency","description":"Waiting on something externally","color":"c5def5"}],"milestone":null,"number":678,"reactionGroups":[],"state":"CLOSED","title":"Worker panics while executing activity","updatedAt":"2022-06-01T13:31:11Z","url":"https://github.com/temporalio/sdk-go/issues/678"}
