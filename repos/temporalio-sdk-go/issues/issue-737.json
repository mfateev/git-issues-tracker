{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"**Is your feature request related to a problem? Please describe.**\r\n\r\nWe may not be updating `temporal_workflow_task_execution_failed` when a data converter fails to convert workflow input.\r\n\r\n**Describe the solution you'd like**\r\n\r\nMake sure we are updating that metric in that situation.","closedAt":"2022-03-01T14:40:47Z","comments":[{"id":"IC_kwDODN1w684-mddr","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Also confirm that `temporal_activity_execution_failed` is properly incremented on activity failure.","createdAt":"2022-02-24T21:12:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/737#issuecomment-1050269547","viewerDidAuthor":false},{"id":"IC_kwDODN1w684-ojGF","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"See the collapsed script below:\r\n\r\n<details>\r\n  <summary>main.go</summary>\r\n  \r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"fmt\"\r\n\t\"io\"\r\n\t\"log\"\r\n\t\"net/http\"\r\n\t\"strings\"\r\n\t\"time\"\r\n\r\n\t\"github.com/google/uuid\"\r\n\t\"github.com/prometheus/client_golang/prometheus\"\r\n\t\"github.com/uber-go/tally/v4\"\r\n\ttallyprometheus \"github.com/uber-go/tally/v4/prometheus\"\r\n\tcommonpb \"go.temporal.io/api/common/v1\"\r\n\t\"go.temporal.io/sdk/client\"\r\n\tsdktally \"go.temporal.io/sdk/contrib/tally\"\r\n\t\"go.temporal.io/sdk/converter\"\r\n\t\"go.temporal.io/sdk/temporal\"\r\n\t\"go.temporal.io/sdk/worker\"\r\n\t\"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\nfunc main() {\r\n\tif err := run(); err != nil {\r\n\t\tlog.Fatal(err)\r\n\t}\r\n}\r\n\r\nfunc run() error {\r\n\tctx, cancel := context.WithCancel(context.Background())\r\n\tdefer cancel()\r\n\r\n\tlog.Printf(\"Creating client with Prometheus metrics server and failable data converter\")\r\n\tfailableConverter := newFailableConverter()\r\n\tc, err := client.NewClient(client.Options{\r\n\t\tDataConverter: failableConverter,\r\n\t\tMetricsHandler: sdktally.NewMetricsHandler(newPrometheusScope(tallyprometheus.Configuration{\r\n\t\t\tListenAddress: \"127.0.0.1:9090\",\r\n\t\t\tTimerType:     \"histogram\",\r\n\t\t})),\r\n\t})\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"failed creating client: %w\", err)\r\n\t}\r\n\tdefer c.Close()\r\n\r\n\tlog.Printf(\"Starting worker\")\r\n\ttaskQueue := uuid.NewString()\r\n\tw := worker.New(c, taskQueue, worker.Options{})\r\n\tw.RegisterWorkflow(HelloWorkflow)\r\n\tw.RegisterActivity(HelloActivity)\r\n\tif err := w.Start(); err != nil {\r\n\t\treturn fmt.Errorf(\"failed starting worker client: %w\", err)\r\n\t}\r\n\tdefer w.Stop()\r\n\r\n\t// Test that a workflow decoder failure appears in metrics\r\n\tlog.Printf(\"Starting workflow with bad value\")\r\n\tfailableConverter.shouldFailFromPayload = true\r\n\trun, err := c.ExecuteWorkflow(ctx, client.StartWorkflowOptions{TaskQueue: taskQueue}, HelloWorkflow, \"Temporal\")\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"failed starting workflow: %w\", err)\r\n\t}\r\n\terr = run.Get(ctx, nil)\r\n\t// We expect an error here for decoding\r\n\tif err == nil || !strings.Contains(err.Error(), \"unable to decode the workflow function input\") {\r\n\t\treturn fmt.Errorf(\"expected decode error, got: %w\", err)\r\n\t}\r\n\tlog.Printf(\"Got expected error: %v\", err)\r\n\r\n\t// Check the Prometheus metrics\r\n\tlog.Printf(\"Waiting 3 seconds, then checking metrics\")\r\n\ttime.Sleep(3 * time.Second)\r\n\tmetricLines, err := getMetricLines()\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"failed getting metrics: %v\", err)\r\n\t}\r\n\tfor _, line := range metricLines {\r\n\t\tif !strings.HasPrefix(line, \"#\") && strings.Contains(line, \"temporal_workflow_failed\") {\r\n\t\t\tlog.Printf(\"Found metric line: %v\", line)\r\n\t\t}\r\n\t}\r\n\r\n\t// Test that an activity failure appears in metrics\r\n\tlog.Printf(\"Starting workflow with failing activity\")\r\n\tfailableConverter.shouldFailFromPayload = false\r\n\thelloActivityShouldFail = true\r\n\trun, err = c.ExecuteWorkflow(ctx, client.StartWorkflowOptions{TaskQueue: taskQueue}, HelloWorkflow, \"Temporal\")\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"failed starting workflow: %w\", err)\r\n\t}\r\n\terr = run.Get(ctx, nil)\r\n\t// We expect an error here for activity\r\n\tif err == nil || !strings.Contains(err.Error(), \"intentionally failing activity\") {\r\n\t\treturn fmt.Errorf(\"expected decode error, got: %w\", err)\r\n\t}\r\n\tlog.Printf(\"Got expected error: %v\", err)\r\n\r\n\t// Check the Prometheus metrics\r\n\tlog.Printf(\"Waiting 3 seconds, then checking metrics\")\r\n\ttime.Sleep(3 * time.Second)\r\n\tmetricLines, err = getMetricLines()\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"failed getting metrics: %v\", err)\r\n\t}\r\n\tfor _, line := range metricLines {\r\n\t\tif !strings.HasPrefix(line, \"#\") && strings.Contains(line, \"temporal_samples_temporal_activity_execution_failed\") {\r\n\t\t\tlog.Printf(\"Found metric line: %v\", line)\r\n\t\t}\r\n\t}\r\n\r\n\treturn nil\r\n}\r\n\r\nfunc getMetricLines() ([]string, error) {\r\n\tresp, err := http.Get(\"http://127.0.0.1:9090/metrics\")\r\n\tif err != nil {\r\n\t\treturn nil, fmt.Errorf(\"failed getting metrics: %w\", err)\r\n\t}\r\n\tbody, err := io.ReadAll(resp.Body)\r\n\tresp.Body.Close()\r\n\tif err != nil {\r\n\t\treturn nil, fmt.Errorf(\"failed reading response body: %w\", err)\r\n\t} else if resp.StatusCode != http.StatusOK {\r\n\t\treturn nil, fmt.Errorf(\"expected metrics 200 status, got: %v, body: %s\", resp.StatusCode, body)\r\n\t}\r\n\treturn strings.Split(string(body), \"\\n\"), nil\r\n}\r\n\r\nfunc HelloWorkflow(ctx workflow.Context, name string) (string, error) {\r\n\tctx = workflow.WithActivityOptions(ctx, workflow.ActivityOptions{\r\n\t\tScheduleToCloseTimeout: 2 * time.Second,\r\n\t\t// No retry\r\n\t\tRetryPolicy: &temporal.RetryPolicy{MaximumAttempts: 1},\r\n\t})\r\n\tvar res string\r\n\terr := workflow.ExecuteActivity(ctx, HelloActivity, name).Get(ctx, &res)\r\n\treturn res, err\r\n}\r\n\r\nvar helloActivityShouldFail = false\r\n\r\nfunc HelloActivity(ctx context.Context, name string) (string, error) {\r\n\tif helloActivityShouldFail {\r\n\t\treturn \"\", fmt.Errorf(\"intentionally failing activity\")\r\n\t}\r\n\treturn \"Hello, \" + name + \"!\", nil\r\n}\r\n\r\ntype failableConverter struct {\r\n\tconverter.DataConverter\r\n\tshouldFailFromPayload bool\r\n}\r\n\r\nfunc newFailableConverter() *failableConverter {\r\n\treturn &failableConverter{DataConverter: converter.GetDefaultDataConverter()}\r\n}\r\n\r\nfunc (f *failableConverter) FromPayload(payload *commonpb.Payload, valuePtr interface{}) error {\r\n\tif f.shouldFailFromPayload {\r\n\t\treturn fmt.Errorf(\"intentionally failing conversion\")\r\n\t}\r\n\treturn f.DataConverter.FromPayload(payload, valuePtr)\r\n}\r\n\r\nfunc (f *failableConverter) FromPayloads(payloads *commonpb.Payloads, valuePtrs ...interface{}) error {\r\n\tif f.shouldFailFromPayload {\r\n\t\treturn fmt.Errorf(\"intentionally failing conversion\")\r\n\t}\r\n\treturn f.DataConverter.FromPayloads(payloads, valuePtrs...)\r\n}\r\n\r\n// Taken from https://github.com/temporalio/samples-go/blob/main/metrics/worker/main.go\r\nfunc newPrometheusScope(c tallyprometheus.Configuration) tally.Scope {\r\n\treporter, err := c.NewReporter(\r\n\t\ttallyprometheus.ConfigurationOptions{\r\n\t\t\tRegistry: prometheus.NewRegistry(),\r\n\t\t\tOnError: func(err error) {\r\n\t\t\t\tlog.Println(\"error in prometheus reporter\", err)\r\n\t\t\t},\r\n\t\t},\r\n\t)\r\n\tif err != nil {\r\n\t\tlog.Fatalln(\"error creating prometheus reporter\", err)\r\n\t}\r\n\tscopeOpts := tally.ScopeOptions{\r\n\t\tCachedReporter:  reporter,\r\n\t\tSeparator:       tallyprometheus.DefaultSeparator,\r\n\t\tSanitizeOptions: &sanitizeOptions,\r\n\t\tPrefix:          \"temporal_samples\",\r\n\t}\r\n\tscope, _ := tally.NewRootScope(scopeOpts, time.Second)\r\n\r\n\tlog.Println(\"prometheus metrics scope created\")\r\n\treturn scope\r\n}\r\n\r\n// Taken from https://github.com/temporalio/samples-go/blob/main/metrics/worker/main.go\r\nvar (\r\n\tsafeCharacters = []rune{'_'}\r\n\r\n\tsanitizeOptions = tally.SanitizeOptions{\r\n\t\tNameCharacters: tally.ValidCharacters{\r\n\t\t\tRanges:     tally.AlphanumericRange,\r\n\t\t\tCharacters: safeCharacters,\r\n\t\t},\r\n\t\tKeyCharacters: tally.ValidCharacters{\r\n\t\t\tRanges:     tally.AlphanumericRange,\r\n\t\t\tCharacters: safeCharacters,\r\n\t\t},\r\n\t\tValueCharacters: tally.ValidCharacters{\r\n\t\t\tRanges:     tally.AlphanumericRange,\r\n\t\t\tCharacters: safeCharacters,\r\n\t\t},\r\n\t\tReplacementCharacter: tally.DefaultReplacementCharacter,\r\n\t}\r\n)\r\n```\r\n</details>\r\n\r\nFor bad data converter, the following logs appear:\r\n\r\n    Starting workflow with bad value\r\n    ...\r\n    Found metric line: temporal_workflow_failed{activity_type=\"none\",client_name=\"temporal_go\",namespace=\"default\",task_queue=\"none\",worker_type=\"none\",workflow_type=\"HelloWorkflow\"} 1\r\n    \r\nThis shows that a bad data conversion results in a `temporal_workflow_failed` Prometheus metric.\r\n\r\nFor activity failure, the following logs appear:\r\n\r\n    Starting workflow with failing activity\r\n    ...\r\n    Found metric line: temporal_activity_execution_failed{activity_type=\"HelloActivity\",client_name=\"temporal_go\",namespace=\"default\",task_queue=\"fc69a0a4_8b94_48d4_85d6_948d7b75e928\",worker_type=\"none\",workflow_type=\"HelloWorkflow\"} 1\r\n\r\nThis shows that a failed activity results in a `temporal_activity_execution_failed` Prometheus metric.\r\n\r\nLeaving open for people to see before closing.","createdAt":"2022-02-25T12:35:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/737#issuecomment-1050816901","viewerDidAuthor":false},{"id":"IC_kwDODN1w684-6d17","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Closing as metric updates confirmed. Anyone can reopen if issue persists.","createdAt":"2022-03-01T14:40:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/737#issuecomment-1055513979","viewerDidAuthor":false}],"createdAt":"2022-02-23T21:33:41Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDky","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":737,"reactionGroups":[],"state":"CLOSED","title":"Confirm that temporal_workflow_task_execution_failed is updated on data conversion failure","updatedAt":"2022-03-01T14:40:47Z","url":"https://github.com/temporalio/sdk-go/issues/737"}
