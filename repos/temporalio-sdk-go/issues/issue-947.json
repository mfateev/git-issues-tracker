{"assignees":[{"id":"MDQ6VXNlcjUxNzY4Mw==","login":"Sushisource","name":"Spencer Judge","databaseId":0}],"author":{"id":"MDQ6VXNlcjE0NjM2MjI=","is_bot":false,"login":"mfateev","name":"Maxim Fateev"},"body":"## Expected Behavior\r\nAn attempt to start a child workflow with the same ID as the one already running should result in `ChildWorkflowExecutionAlreadyStartedError`.\r\n\r\n## Actual Behavior\r\n```\r\n2022/11/06 11:12:07 ERROR Workflow panic Namespace default TaskQueue child-workflow WorkerID 8968@Maxims-MacBook-Pro.local@ WorkflowType SampleParentWorkflow WorkflowID parent-workflow_ed5bbdc7-183d-43b7-936a-d2a9e4d9bd2f RunID b4a73c0b-a1d3-4ef9-ab29-8bfd34b4138d Attempt 1 Error adding duplicate command CommandType: ChildWorkflow, ID: ABC-SIMPLE-CHILD-WORKFLOW-ID, state=Created, isDone()=false, history=[Created] StackTrace coroutine root [panic]:\r\ngo.temporal.io/sdk/internal.panicIllegalState(...)\r\n        /Users/maxim/go/pkg/mod/go.temporal.io/sdk@v1.17.0/internal/internal_command_state_machine.go:502\r\ngo.temporal.io/sdk/internal.(*commandsHelper).addCommand(0x14000554230, {0x1016656f0, 0x140000a3290})\r\n        /Users/maxim/go/pkg/mod/go.temporal.io/sdk@v1.17.0/internal/internal_command_state_machine.go:998 +0x2f8\r\ngo.temporal.io/sdk/internal.(*commandsHelper).startChildWorkflowExecution(0x41b8?, 0x102180668?)\r\n        /Users/maxim/go/pkg/mod/go.temporal.io/sdk@v1.17.0/internal/internal_command_state_machine.go:1228 +0x38\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentImpl).ExecuteChildWorkflow(_, {{{0x140001b21e0, 0xe}, 0x0, 0x0, 0x0, {0x1013796f7, 0x7}, {0x10138d56c, 0x1c}, ...}, ...}, ...)\r\n        /Users/maxim/go/pkg/mod/go.temporal.io/sdk@v1.17.0/internal/internal_event_handlers.go:476 +0x3b0\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteChildWorkflow(0x140005506c0?, {0x10165fff8?, 0x1400017e000}, {0x1017c363a, 0x13}, {0x140000a3200, 0x1, 0x1})\r\n        /Users/maxim/go/pkg/mod/go.temporal.io/sdk@v1.17.0/internal/workflow.go:903 +0x6b8\r\ngo.temporal.io/sdk/internal.ExecuteChildWorkflow({0x10165fff8, 0x140005506c0}, {0x101548ca0, 0x101651d80}, {0x140000a3200, 0x1, 0x1})\r\n        /Users/maxim/go/pkg/mod/go.temporal.io/sdk@v1.17.0/internal/workflow.go:851 +0x188\r\ngo.temporal.io/sdk/workflow.ExecuteChildWorkflow(...)\r\n        /Users/maxim/go/pkg/mod/go.temporal.io/sdk@v1.17.0/workflow/workflow.go:181\r\ngithub.com/temporalio/samples-go/child-workflow.SampleParentWorkflow({0x10165fff8, 0x14000550690})\r\n        /Users/maxim/temporal/temporal-go-samples/child-workflow/parent_workflow.go:25 +0x164\r\nreflect.Value.call({0x101539b00?, 0x101651d88?, 0x102000f18?}, {0x101376901, 0x4}, {0x1400000fb48, 0x1, 0x5?})\r\n        /opt/homebrew/Cellar/go/1.19.2/libexec/src/reflect/value.go:584 +0x688\r\nreflect.Value.Call({0x101539b00?, 0x101651d88?, 0x5000?}, {0x1400000fb48?, 0x1400044bcf8?, 0x10134ce50?})\r\n        /opt/homebrew/Cellar/go/1.19.2/libexec/src/reflect/value.go:368 +0x90\r\ngo.temporal.io/sdk/internal.executeFunction({0x101539b00, 0x101651d88}, {0x1400044bde8, 0x1, 0x14000090000?})\r\n        /Users/maxim/go/pkg/mod/go.temporal.io/sdk@v1.17.0/internal/internal_worker.go:1651 +0x140\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteWorkflow(0x14000554280, {0x10165fea8?, 0x14000109d40}, 0x1400000fb30)\r\n        /Users/maxim/go/pkg/mod/go.temporal.io/sdk@v1.17.0/internal/workflow.go:504 +0x14c\r\ngo.temporal.io/sdk/internal.(*workflowExecutor).Execute(0x14000113300, {0x10165fea8, 0x14000109d40}, 0x25?)\r\n        /Users/maxim/go/pkg/mod/go.temporal.io/sdk@v1.17.0/internal/internal_worker.go:771 +0x238\r\ngo.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func1({0x10165fff8, 0x14000550570})\r\n        /Users/maxim/go/pkg/mod/go.temporal.io/sdk@v1.17.0/internal/internal_workflow.go:553 +0xd0\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n[Modified child_worklfow sample](https://github.com/temporalio/samples-go/compare/main...mfateev:duplicated_child?expand=1):\r\n```go\r\nfunc SampleParentWorkflow(ctx workflow.Context) (string, error) {\r\n\tlogger := workflow.GetLogger(ctx)\r\n\r\n\tcwo := workflow.ChildWorkflowOptions{\r\n\t\tWorkflowID: \"ABC-SIMPLE-CHILD-WORKFLOW-ID\",\r\n\t}\r\n\tctx = workflow.WithChildOptions(ctx, cwo)\r\n\r\n\tvar result string\r\n\tchild1 := workflow.ExecuteChildWorkflow(ctx, SampleChildWorkflow, \"World\")\r\n\r\n\tworkflow.Sleep(ctx, 10*time.Second)\r\n\terr := workflow.ExecuteChildWorkflow(ctx, SampleChildWorkflow, \"World\").Get(ctx, &result)\r\n\tif err != nil {\r\n\t\tlogger.Error(\"Parent execution received second child execution failure.\", \"Error\", err)\r\n\t\treturn \"\", err\r\n\t}\r\n\terr = child1.Get(ctx, &result)\r\n\tif err != nil {\r\n\t\tlogger.Error(\"Parent execution received child execution failure.\", \"Error\", err)\r\n\t\treturn \"\", err\r\n\t}\r\n\r\n\tlogger.Info(\"Parent execution completed.\", \"Result\", result)\r\n\treturn result, nil\r\n}\r\n\r\nfunc SampleChildWorkflow(ctx workflow.Context, name string) (string, error) {\r\n\tlogger := workflow.GetLogger(ctx)\r\n\tgreeting := \"Hello \" + name + \"!\"\r\n\tlogger.Info(\"Child workflow execution: \" + greeting)\r\n\tworkflow.Sleep(ctx, 15*time.Second)\r\n\treturn greeting, nil\r\n}\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version:         go.temporal.io/sdk v1.17.0\r\n","closedAt":"2023-01-06T03:12:39Z","comments":[{"id":"IC_kwDODN1w685N15Ea","author":{"login":"bohlander"},"authorAssociation":"NONE","body":"We have seen this same panic even when the 1st child workflow has exited before the 2nd one is started. \r\n\r\nWe have some long running (~40 day) workflows that have a timer that runs daily.  These have been stable for 6+ months, but last night we had a significant amount of them fail with: `adding duplicate command CommandType: ChildWorkflow, ID: <snip>, state=Created, isDone()=false, history=[Created]\",\"Namespace\":\"default\",\"RunID\":\"10c62aba-5487-4a5f-b1c1-93badbdb5ee8\",\"StackTrace\":<snip> `. This occurs when the workflow with the timer is attempting to start a child workflow. \r\n\r\n<img width=\"1230\" alt=\"Screen Shot 2022-11-06 at 10 41 06 AM\" src=\"https://user-images.githubusercontent.com/470585/200379335-e129b5c3-0244-4595-afe4-f9417363d836.png\">\r\n<img width=\"1257\" alt=\"Screen Shot 2022-11-06 at 10 40 40 AM\" src=\"https://user-images.githubusercontent.com/470585/200379357-e4798b23-db8c-4953-b545-93b71fb5916f.png\">\r\n\r\nYou can see it finished the childworkflow with same id finished at 11/5/22 7:21:31.  Then the duplicate command failure occurs ~24 hrs later at 11/6/22 7:20:52 (the temporal web UI screenshot is in PST whereas the logs are in UTC)","createdAt":"2022-11-07T17:49:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/947#issuecomment-1305973018","viewerDidAuthor":false}],"createdAt":"2022-11-06T19:21:15Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":947,"reactionGroups":[],"state":"CLOSED","title":"Panic: Error adding duplicate command on duplicated child workflow","updatedAt":"2023-01-06T03:12:39Z","url":"https://github.com/temporalio/sdk-go/issues/947"}
