{"assignees":[],"author":{"id":"U_kgDOC8HryQ","is_bot":false,"login":"VinayBhupelliAPT","name":"Vinay Bhupelli"},"body":"## The Problem\n\nI'm using Temporal with the OpenTelemetry MetricsHandler, and I've noticed that my custom activity metrics work great with exemplars (I can click from a metric spike in Grafana directly to the trace), but the built-in Temporal SDK metrics don't have this feature.\n\nHere's what I mean:\n\n**My custom metrics (working great):**\n```go\nfunc ProcessPaymentActivity(ctx context.Context, orderID string) error {\n    // ctx contains active span with trace_id and span_id\n    // When I pass ctx to the metric, OpenTelemetry extracts these IDs\n    // and attaches them as an exemplar\n    paymentCounter.Add(ctx, 1, metric.WithAttributes(...))\n}\n```\nWhen I look at this in Grafana, I see little dots on the graph. Each dot has the trace_id and span_id embedded. Click a dot, boom - I'm looking at the exact trace for that metric point.\n\n**SDK metrics (not working):**\n```go\n// Inside Temporal SDK - internal/internal_task_handlers.go:1906\nfunc (wth *workflowTaskHandlerImpl) completeWorkflow(...) {\n    // Workflow completion\n    metricsHandler.Counter(metrics.WorkflowCompletedCounter).Inc(1)\n    // ❌ No context passed - can't create exemplar\n}\n```\n([See actual code](https://github.com/temporalio/sdk-go/blob/master/internal/internal_task_handlers.go#L1906))\n\nNo dots. Can't click through to traces. Have to manually hunt for the trace by timestamp.\n\n## Why This Happens\n\nI dug into the code and found the issue. The `MetricsHandler` interface doesn't have a context parameter:\n\n```go\n// From internal/common/metrics/handler.go\ntype CounterIface interface {\n    Inc(value int64)  // No way to pass context!\n}\n```\n\nThis means the OpenTelemetry bridge has no choice but to use an empty context:\n\n```go\n// From contrib/opentelemetry/metricshandler.go\nfunc (c *counter) Inc(value int64) {\n    // Can't pass the actual context, so using background\n    c.otelCounter.Add(context.Background(), value)\n    // context.Background() has no trace info\n    // → OpenTelemetry can't extract trace_id and span_id\n    // → No exemplar created\n}\n```\n\nWithout the context containing trace information, OpenTelemetry can't extract the trace_id and span_id needed to create the exemplar that links the metric to the trace.\n\n**References in SDK code where metrics are recorded without context:**\n- [internal/internal_task_handlers.go:1906](https://github.com/temporalio/sdk-go/blob/master/internal/internal_task_handlers.go#L1906) - `WorkflowCompletedCounter`\n- [internal/internal_task_handlers.go:1916](https://github.com/temporalio/sdk-go/blob/master/internal/internal_task_handlers.go#L1916) - `WorkflowEndToEndLatency`\n- [internal/internal_task_handlers.go:1897](https://github.com/temporalio/sdk-go/blob/master/internal/internal_task_handlers.go#L1897) - `WorkflowFailedCounter`\n- [internal/internal_task_handlers.go:1863](https://github.com/temporalio/sdk-go/blob/master/internal/internal_task_handlers.go#L1863) - `WorkflowCanceledCounter`\n- [internal/internal_worker_base.go:379](https://github.com/temporalio/sdk-go/blob/master/internal/internal_worker_base.go#L379) - `WorkerStartCounter`\n- [internal/internal_worker_base.go:426](https://github.com/temporalio/sdk-go/blob/master/internal/internal_worker_base.go#L426) - `PollerStartCounter`\n- Many more throughout the SDK\n## Why This Matters (Real Production Scenario)\n\nLast week we had an incident where `temporal_activity_execution_latency` spiked to 5 seconds at 2:32 PM.\n\n**Without exemplars (current experience):**\n1. Notice the spike in Grafana\n2. Write down the timestamp\n3. Open Tempo/Jaeger in another tab\n4. Search for traces in that time window\n5. Filter by activity type\n6. Click through 20+ traces to find the slow one\n7. Finally find it after 5-10 minutes\n\n**With exemplars (what I want):**\n1. Notice the spike in Grafana\n2. Click the exemplar dot on the graph (which contains trace_id and span_id)\n3. Grafana uses the trace_id to instantly open the exact trace in Tempo\n4. See the root cause immediately (database timeout on retry )\n\nThis difference is huge for production debugging. The exemplar acts as a direct link from the metric data point to the specific trace execution.\n\n## Current Workaround (Not Ideal)\n\nRight now I have to add custom metrics in my activity code to get exemplars:\n\n```go\nfunc ProcessPaymentActivity(ctx context.Context, orderID string) (string, error) {\n    startTime := time.Now()\n\n    // ... payment processing logic ...\n\n    // Custom metric WITH exemplar - works because I pass ctx\n    // ctx contains active span → has trace_id and span_id\n    // OpenTelemetry extracts these and creates exemplar automatically\n    duration := time.Since(startTime).Milliseconds()\n    paymentCounter.Add(ctx, 1,\n        metric.WithAttributes(\n            attribute.String(\"status\", \"success\"),\n            attribute.String(\"gateway\", \"stripe\"),\n        ),\n    )\n    paymentDuration.Record(ctx, float64(duration),\n        metric.WithAttributes(\n            attribute.String(\"status\", \"success\"),\n        ),\n    )\n    // Result: Metric stored with exemplar containing trace_id and span_id\n\n    return result, nil\n}\n```\n\nThis works great for my custom metrics, but:\n- The built-in Temporal SDK metrics like `temporal_workflow_completed`, `temporal_activity_execution_latency`, etc. still don't have exemplars\n- I can see exemplars (with trace_id/span_id) on my custom counters, but not on the SDK's metrics\n- Inconsistent experience - some metrics are clickable, some aren't\n## Proposed Solution\n\nThe fix is pretty straightforward - add a context parameter to the metrics interface:\n\n**Change the interface:**\n```go\n// Current\ntype CounterIface interface {\n    Inc(value int64)\n}\n\n// Proposed\ntype CounterIface interface {\n    Inc(ctx context.Context, value int64)\n}\n```\n\n**Update SDK calls** (context is already available):\n```go\n// Current\na.metricsHandler.Counter(metrics.ActivityTaskError).Inc(1)\n\n// Proposed\na.metricsHandler.Counter(metrics.ActivityTaskError).Inc(ctx, 1)\n```\n\n**OpenTelemetry bridge can now pass context:**\n```go\n// Current (forced to use empty context)\nfunc (c *counter) Inc(value int64) {\n    c.otelCounter.Add(context.Background(), value)\n    // No trace_id or span_id → no exemplar\n}\n\n// After change\nfunc (c *counter) Inc(ctx context.Context, value int64) {\n    c.otelCounter.Add(ctx, value)\n    // OpenTelemetry extracts trace_id and span_id from ctx\n    // Creates exemplar: {trace_id: \"abc...\", span_id: \"123...\", value: 1}\n    // Metric exported with exemplar attached\n}\n```\n\nOnce the context is passed through, OpenTelemetry handles the rest automatically - it extracts the trace_id and span_id from the active span in the context and creates an exemplar that links the metric data point to the trace.\n\n## Why This Would Be Awesome\n\n**Faster debugging:** Click from metric → trace in seconds instead of manually hunting for 5-10 minutes\n\n**Better observability:** All metrics (not just custom ones) would link to traces\n\n**Industry standard:** Prometheus, Grafana, and all major observability vendors support this pattern\n\n## Backward Compatibility\n\nI know this is an interface change, but there are ways to keep it backward compatible:\n\n**Option 1:** Add a new method alongside the old one\n```go\ntype CounterIface interface {\n    Inc(value int64)  // Keep for compatibility\n    IncWithContext(ctx context.Context, value int64)  // New, preferred\n}\n```\n\n**Option 2:** Check if the handler supports the new interface\n```go\nif counter, ok := handler.Counter(name).(CounterIfaceV2); ok {\n    counter.Inc(ctx, 1)  // New way\n} else {\n    handler.Counter(name).Inc(1)  // Old way still works\n}\n```\n\nEither way, existing code keeps working, but new deployments get exemplar support automatically.\n\n## My Setup (What's Working vs Not Working)\n\n**Environment:**\n- Temporal Go SDK with OpenTelemetry MetricsHandler\n- Prometheus with exemplar storage enabled\n- Tempo for traces\n- Grafana for visualization\n\n**Custom metrics (working perfectly):**\n```promql\nrate(payments_processed_total{status=\"failed\"}[5m])\n```\n✅ See exemplar dots on the graph\n✅ Click → instant jump to trace (using trace_id from exemplar)\n✅ See exact failure reason in seconds\n\n**SDK metrics (missing exemplars):**\n```promql\nrate(temporal_activity_execution_latency_count{activity_type=\"ProcessPayment\"}[5m])\n```\n❌ No exemplar dots\n❌ Can't jump to traces (no trace_id/span_id attached)\n❌ Manual correlation required\n\nYou can verify this yourself by querying Prometheus:\n```bash\n# Custom metric - has exemplar with trace_id and span_id\ncurl 'http://localhost:9090/api/v1/query_exemplars?query=payments_processed_total'\n# Returns: {\n#   \"labels\": {\n#     \"trace_id\": \"5d228c40d1fdce780dbe98fc3bd0c635\",\n#     \"span_id\": \"6b70a14bf880cf66\"\n#   },\n#   \"value\": \"1\",\n#   \"timestamp\": 1762203470.707\n# }\n\n# SDK metric - no exemplar (empty array)\ncurl 'http://localhost:9090/api/v1/query_exemplars?query=temporal_activity_execution_latency'\n# Returns: [] (empty - no trace_id or span_id available)\n```\n\n---\n\nWould you consider this feature? I think it would significantly improve production debugging for anyone using OpenTelemetry.\n\nThanks for reading!","closedAt":null,"comments":[{"id":"IC_kwDODN1w687Yt1zV","author":{"login":"greatdaveo"},"authorAssociation":"NONE","body":"Hello @Quinn-With-Two-Ns & @THardy98 , I would like to work on this. Could you please assign it to me? Thank you","createdAt":"2025-12-10T08:16:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/2097#issuecomment-3635895509","viewerDidAuthor":false},{"id":"IC_kwDODN1w687anHOM","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"@greatdaveo We have not decided to accept this feature yet or any implementation so please do not do any work on this feature.\n\nIf a user does want to use some OTEL specific API, in this case context, the recommend approach is to use `opentelemetry.ExtractMetricsHandler` to get the actual otel metric handler from the Temporal API.","createdAt":"2025-12-18T00:22:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/2097#issuecomment-3667686284","viewerDidAuthor":false},{"id":"IC_kwDODN1w687a-Gk6","author":{"login":"greatdaveo"},"authorAssociation":"NONE","body":"@Quinn-With-Two-Ns well noted, thank you! \nPlease is there any issue at hand that you would like me to contribute then? I would like to make my first contribution, but it seems most of the issues raised are still yet to be decided on. Thanks","createdAt":"2025-12-19T06:19:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/2097#issuecomment-3673712954","viewerDidAuthor":false}],"createdAt":"2025-11-05T17:07:18Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDky","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":2097,"reactionGroups":[{"content":"CONFUSED","users":{"totalCount":1}},{"content":"HEART","users":{"totalCount":1}}],"state":"OPEN","title":"Feature Request: Add Context to MetricsHandler for Exemplar Support","updatedAt":"2025-12-19T06:19:56Z","url":"https://github.com/temporalio/sdk-go/issues/2097"}
