{"assignees":[],"author":{"id":"MDQ6VXNlcjMzMDY3NTY=","is_bot":false,"login":"Bysmyyr","name":"Olli Raula"},"body":"## Expected Behavior\nNo crash when running with `-debug=f` or through golangci-lint\n\n## Actual Behavior\nIt crashes: (happens with other codebases too but for the simplicity, running it with this codebase)\n\n```\ncontrib/tools/workflowcheck on  master\n❯ go run main.go -debug=f ./...\npanic: runtime error: index out of range [0] with length 0\n\ngoroutine 2756 [running]:\ngolang.org/x/tools/go/analysis/internal/checker.(*action).exportPackageFact(0xc01346ed20, {0x849a88, 0xc010375d40})\n\t/home/olli/go/pkg/mod/golang.org/x/tools@v0.25.0/go/analysis/internal/checker/checker.go:963 +0x309\ngo.temporal.io/sdk/contrib/tools/workflowcheck/determinism.(*collector).applyFacts(0xc00ca16e40)\n\t/home/olli/Downloads/sdk-go/contrib/tools/workflowcheck/determinism/checker.go:427 +0x3ec\ngo.temporal.io/sdk/contrib/tools/workflowcheck/determinism.(*Checker).Run(0xc0000b51c0, 0xc0057ea460)\n\t/home/olli/Downloads/sdk-go/contrib/tools/workflowcheck/determinism/checker.go:202 +0x646\ngo.temporal.io/sdk/contrib/tools/workflowcheck/workflow.(*Checker).Run(0xc0000906c0, 0xc0057ea460)\n\t/home/olli/Downloads/sdk-go/contrib/tools/workflowcheck/workflow/checker.go:157 +0x117\ngo.temporal.io/sdk/contrib/tools/workflowcheck/workflow.(*Checker).NewAnalyzer.func1(0x7fffc5da3579?)\n\t/home/olli/Downloads/sdk-go/contrib/tools/workflowcheck/workflow/checker.go:129 +0x1d\ngolang.org/x/tools/go/analysis/internal/checker.(*action).execOnce(0xc01346ed20)\n\t/home/olli/go/pkg/mod/golang.org/x/tools@v0.25.0/go/analysis/internal/checker/checker.go:759 +0xad0\nsync.(*Once).doSlow(0xc006b70030?, 0xc007fb04b0?)\n\t/home/olli/go/go1.24.1/src/sync/once.go:78 +0xab\nsync.(*Once).Do(...)\n\t/home/olli/go/go1.24.1/src/sync/once.go:69\ngolang.org/x/tools/go/analysis/internal/checker.(*action).exec(...)\n\t/home/olli/go/pkg/mod/golang.org/x/tools@v0.25.0/go/analysis/internal/checker/checker.go:666\ngolang.org/x/tools/go/analysis/internal/checker.execAll.func1(0x0?)\n\t/home/olli/go/pkg/mod/golang.org/x/tools@v0.25.0/go/analysis/internal/checker/checker.go:654 +0x3b\ncreated by golang.org/x/tools/go/analysis/internal/checker.execAll in goroutine 2747\n\t/home/olli/go/pkg/mod/golang.org/x/tools@v0.25.0/go/analysis/internal/checker/checker.go:660 +0x191\nexit status 2\n\n```\n\nWe found the issue when integrating the check for golangci-lint.  With golangci-lint it crash always.\n\ngolangCI-lint has its own pass which does this always:\n```\n    act.Err = errorutil.NewPanicError(fmt.Sprintf(\"%s: package %q (isInitialPkg: %t, needAnalyzeSource: %t): %s\",\n       act.Analyzer.Name, act.Package.Name, act.isInitialPkg, act.needAnalyzeSource, p), debug.Stack())\n}\n```\nwhen run on its own, it uses go standard reporter which does that only when debug flag is on, with it it fails:\n```\nif dbg('f') {\n    fmt.Fprintf(os.Stderr, \"%s: package %s has fact %s\\n\",\n       act.pkg.Fset.Position(act.pass.Files[0].Pos()), act.pass.Pkg.Path(), fact)\n}\n```\nSomehow the `act.pass.Files` is empty slice. In this case the key is `package unsafe (\"unsafe\")`.\n\n\n## Steps to Reproduce the Problem\n\n  1. cd contrib/tools/workflowcheck\n  1. go run main.go -debug=f ./...\n  1.\n\n## Specifications\n\n  - Version: master (b9afba98719cdf39b158dd0cfb05c9d422f477f4)\n  - Platform: go version go1.24.1 linux/amd64\n\n","closedAt":null,"comments":[{"id":"IC_kwDODN1w686l5Svw","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Looks like this may be a bug in the Golang repo on code that assumes a file is present in that slice (and still exists despite being moved to https://github.com/golang/tools/blob/3e7f74d009150bf5e66483f3759d8c59f50e873d/go/analysis/checker/checker.go#L591).","createdAt":"2025-04-07T13:00:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1906#issuecomment-2783259632","viewerDidAuthor":false}],"createdAt":"2025-04-07T06:57:09Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDg2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1906,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"OPEN","title":"workflowcheck crash (index out of range)","updatedAt":"2025-04-07T13:00:38Z","url":"https://github.com/temporalio/sdk-go/issues/1906"}
