{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"**Is your feature request related to a problem? Please describe.**\r\n\r\nPeople need a way to know whether session has failed, specifically if an activity has failed due to being cancelled by session failure.\r\n\r\n**Describe the solution you'd like**\r\n\r\nCan expose the already-existing session state on session info. We need to make sure that it is set to failed if an activity is failed because of session failure.","closedAt":"2023-02-08T19:00:36Z","comments":[{"id":"IC_kwDODN1w685UE3Cr","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"How is this different then the error we already have in the SDK `ErrSessionFailed`?\r\n\r\n>We need to make sure that it is set to failed if an activity is failed because of session failure.\r\n\r\nHow do you propose we tell an activity failed because it was the session that failed?","createdAt":"2023-01-31T15:15:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1021#issuecomment-1410560171","viewerDidAuthor":false},{"id":"IC_kwDODN1w685UFHL7","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> How is this different then the error we already have in the SDK ErrSessionFailed?\r\n\r\nI believe based on docs that an already-in-progress activity on a session just gets cancelled, you can't tell from the error returned by the activity that it was due to session failure. (I could be wrong about this, did not test)\r\n\r\n> How do you propose we tell an activity failed because it was the session that failed?\r\n\r\nWhile there are technically some race conditions, if the activity failed due to cancellation the user can check if the session is failed and _may_ make reasonable a judgement that that may be the reason. It's about the best we can offer I think without changing error approaches.","createdAt":"2023-01-31T15:48:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1021#issuecomment-1410626299","viewerDidAuthor":false},{"id":"IC_kwDODN1w685UFLFG","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":">While there are technically some race conditions, if the activity failed due to cancellation the user can check if the session is failed and may make reasonable a judgement that that may be the reason. It's about the best we can offer I think without changing error approaches.\r\n\r\nI'd need to test but I think depending on worker and activity settings it could be pretty easy to have false positives and false negatives. I agree it is the best we can do so I am fine with this approach.\r\n\r\nIn your original comment you suggested we should mark the session failed if an activity is failed because of session failure. That I don't like because I don't think it is possible to reliably do and is a breaking change to the session API as we explicitly call out we don't fail the session on activity failure in the documentation.","createdAt":"2023-01-31T15:58:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1021#issuecomment-1410642246","viewerDidAuthor":false},{"id":"IC_kwDODN1w685UFMRb","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> In your original comment you suggested we should mark the session failed if an activity is failed because of session failure\r\n\r\nI am not suggesting changing anything with how sessions are marked. I am just suggesting we expose session state/status. By \"we need to make sure\" I just mean a test to confirm that the session status is as expected when an in-flight activity cancel/failure is caused by session failure. Sorry for the wording confusion.","createdAt":"2023-01-31T16:01:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1021#issuecomment-1410647131","viewerDidAuthor":false},{"id":"IC_kwDODN1w685UFs5k","author":{"login":"armoona"},"authorAssociation":"NONE","body":"From the user's perspective, it would be simplest if ExecuteActivity().Get() always returned ErrSessionFailed on session failure, whether it happened while an activity is in progress or otherwise.\r\n\r\nThinking out loud, I think the following hack would work now to reliably trigger session restarts in all cases. It uses a dummy activity that does nothing.\r\n\r\n```\r\n\terr := workflow.ExecuteActivity(ctx, \"RealActivity\").Get(ctx, nil)\r\n\tvar canceledErr *temporal.CanceledError\r\n\tif err == workflow.ErrSessionFailed {\r\n\t\t// restart session\r\n\t} else if errors.As(err, &canceledErr) {\r\n\t\terr = workflow.ExecuteActivity(ctx, \"DummyActivity\").Get(ctx, nil)\r\n\t\tif err == workflow.ErrSessionFailed {\r\n\t\t\t// restart session\r\n\t\t}\r\n\t}\r\n\r\n```\r\n","createdAt":"2023-01-31T17:25:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1021#issuecomment-1410780772","viewerDidAuthor":false},{"id":"IC_kwDODN1w685UFwTT","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":">From the user's perspective, it would be simplest if ExecuteActivity().Get() always returned ErrSessionFailed on session failure, whether it happened while an activity is in progress or otherwise.\r\n\r\nI agree that would be the simplest, I just don't believe it is possible for the SDK to be confident the activity failed 100% of the time because the session did/did not fail. The best we can do is expose the session state and Users can make that judgement on why the activity failed.","createdAt":"2023-01-31T17:34:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1021#issuecomment-1410794707","viewerDidAuthor":false},{"id":"IC_kwDODN1w685UGNjr","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Also, cancellation is a request not a requirement. Activities can respond to cancellations in different ways (including having already been completed when cancellation is requested). There are many reasons an activity can be cancelled (session close, workflow close, etc) and we don't expose cancellation reasons in any cases. And yes, technically an activity could be cancelled for another reason and you can't tell it was session cancel that was the real reason. All you can do is check whether the session context is closed.\r\n\r\nAnd of course we can't just change existing behavior without potentially breaking people that may expect certain types of errors as they exist today.","createdAt":"2023-01-31T19:03:47Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1021#issuecomment-1410914539","viewerDidAuthor":false},{"id":"IC_kwDODN1w685U0rzn","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"This should be exposed in the go sdk v1.21.0 under `SessionInfo.SessionState `\r\n\r\nAs noted in the PR\r\n```\r\nNote: Sessions have an inherently stale view of the worker they are running on. Session\r\n\tstate may be stale up the the SessionOptions.HeartbeatTimeout. SessionOptions.HeartbeatTimeout\r\n\tshould be less than half the activity timeout for the state to be accurate when checking after activity failure.\r\n```","createdAt":"2023-02-08T19:00:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1021#issuecomment-1423097063","viewerDidAuthor":false}],"createdAt":"2023-01-31T13:21:24Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDky","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1021,"reactionGroups":[],"state":"CLOSED","title":"Expose session state to users","updatedAt":"2023-02-08T19:00:36Z","url":"https://github.com/temporalio/sdk-go/issues/1021"}
