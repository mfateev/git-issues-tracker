{"assignees":[],"author":{"id":"MDQ6VXNlcjE2MzY0OTMw","is_bot":false,"login":"AhmadElsagheer","name":"Ahmad Elsagheer"},"body":"## Context\nWe have, at Payrails, a custom logger (a wrapper of zap)  that implements the temporal SDK `log.Logger` interface and is provided to the SDK client. Recently, we wanted to sanitize the logs to make the zap log fields `caller` and `stacktrace` more representative of the actual log line skipping all logging and temporal SDK internal details. So, we additionally implemented `log.WithSkipCallers` interface but looks like there is an overcount in the skip calls.\n\nWithout implementing the skipping interface, an error log looks like\n```json\n{\n    \"level\": \"error\",\n    \"ts\": 1742899256.974098,\n    \"caller\": \"log/with_logger.go:79\",    // <--- Current (without the skipping interface)\n    \"msg\": \"HelloWorld: this is an error inside the workflow\",\n    \"Namespace\": \"default\",\n    \"TaskQueue\": \"main_queue\",\n    \"WorkerID\": \"37387@KCJ74K6WJ2@\",\n    \"WorkflowType\": \"HelloWorld\",\n    \"WorkflowID\": \"989f5c44-9311-4bd1-be2d-5477c157392c\",\n    \"RunID\": \"84ecd3c3-6ab2-4cd9-82f6-ca14ed470f58\",\n    \"Attempt\": 1,\n    \"stacktrace\": \"go.temporal.io/sdk/log.(*withLogger).Error\\n\\t/payrails/sdk-go/log/with_logger.go:79\\ngo.temporal.io/sdk/log.(*withLogger).Error\\n\\t/payrails/sdk-go/log/with_logger.go:79\\ngo.temporal.io/sdk/internal/log.(*ReplayLogger).Error\\n\\t/payrails/sdk-go/internal/log/replay_logger.go:79\\nmain.HelloWorld\\n\\t/payrails/sdk-go/play/business.go:11\\nreflect.Value.call\\n\\t/usr/local/go/src/reflect/value.go:581\\nreflect.Value.Call\\n\\t/usr/local/go/src/reflect/value.go:365\\ngo.temporal.io/sdk/internal.executeFunction\\n\\t/payrails/sdk-go/internal/internal_worker.go:2087\\ngo.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteWorkflow\\n\\t/payrails/sdk-go/internal/workflow.go:797\\ngo.temporal.io/sdk/internal.(*workflowExecutor).Execute\\n\\t/payrails/sdk-go/internal/internal_worker.go:922\\ngo.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func1\\n\\t/payrails/sdk-go/internal/internal_workflow.go:574\\ngo.temporal.io/sdk/internal.(*coroutineState).run\\n\\t/payrails/sdk-go/internal/internal_workflow.go:1217\"\n}\n```\n```go\n// Stacktrace\n// go.temporal.io/sdk/log.(*withLogger).Error\\n\\t/payrails/sdk-go/log/with_logger.go:79\\n <-- Temporal internals\n// go.temporal.io/sdk/log.(*withLogger).Error\\n\\t/payrails/sdk-go/log/with_logger.go:79\\n <-- Temporal internals\n// go.temporal.io/sdk/internal/log.(*ReplayLogger).Error\\n\\t/payrails/sdk-go/internal/log/replay_logger.go:79\\n <-- Temporal internals\n// main.HelloWorld\\n\\t/payrails/sdk-go/play/business.go:1 <-- Target caller\n```\n\n## Expected Behavior\n```json\n{\n    \"level\": \"error\",\n    \"ts\": 1742898778.993421,\n    \"caller\": \"play/business.go:11\",    // <--- Expected\n    \"msg\": \"HelloWorld: this is an error inside the workflow\",\n    \"Namespace\": \"default\",\n    \"TaskQueue\": \"main_queue\",\n    \"WorkerID\": \"26036@KCJ74K6WJ2@\",\n    \"WorkflowType\": \"HelloWorld\",\n    \"WorkflowID\": \"c548205d-0c6d-428d-a916-40635de42e20\",\n    \"RunID\": \"b67f831e-58c4-4743-8b28-6574d2197deb\",\n    \"Attempt\": 1,\n    \"stacktrace\": \"main.HelloWorld\\n\\t/payrails/sdk-go/play/business.go:11\\nreflect.Value.call\\n\\t/usr/local/go/src/reflect/value.go:581\\nreflect.Value.Call\\n\\t/usr/local/go/src/reflect/value.go:365\\ngo.temporal.io/sdk/internal.executeFunction\\n\\t/payrails/sdk-go/internal/internal_worker.go:2087\\ngo.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteWorkflow\\n\\t/payrails/sdk-go/internal/workflow.go:797\\ngo.temporal.io/sdk/internal.(*workflowExecutor).Execute\\n\\t/payrails/sdk-go/internal/internal_worker.go:922\\ngo.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func1\\n\\t/payrails/sdk-go/internal/internal_workflow.go:574\\ngo.temporal.io/sdk/internal.(*coroutineState).run\\n\\t/payrails/sdk-go/internal/internal_workflow.go:1217\"\n}\n```\nSkipped callers = 3\n\n## Actual Behavior\n```json\n{\n    \"level\": \"error\",\n    \"ts\": 1742898791.142066,\n    \"caller\": \"internal/workflow.go:797\",    // <--- Actual unexpected (with the skipping interface)\n    \"msg\": \"HelloWorld: this is an error inside the workflow\",\n    \"Namespace\": \"default\",\n    \"TaskQueue\": \"main_queue\",\n    \"WorkerID\": \"26374@KCJ74K6WJ2@\",\n    \"WorkflowType\": \"HelloWorld\",\n    \"WorkflowID\": \"33f1016d-bb9f-42e5-9788-c9d3e4440515\",\n    \"RunID\": \"e83505ff-0de9-4373-9b86-0a91b52ffae5\",\n    \"Attempt\": 1,\n    \"stacktrace\": \"go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteWorkflow\\n\\t/payrails/sdk-go/internal/workflow.go:797\\ngo.temporal.io/sdk/internal.(*workflowExecutor).Execute\\n\\t/payrails/sdk-go/internal/internal_worker.go:922\\ngo.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func1\\n\\t/payrails/sdk-go/internal/internal_workflow.go:574\\ngo.temporal.io/sdk/internal.(*coroutineState).run\\n\\t/payrails/sdk-go/internal/internal_workflow.go:1217\"\n}\n```\nSkipped callers = 7\n```go\n// go.temporal.io/sdk/log.(*withLogger).Error\\n\\t/payrails/sdk-go/log/with_logger.go:79\\n // Skipped\n// go.temporal.io/sdk/log.(*withLogger).Error\\n\\t/payrails/sdk-go/log/with_logger.go:79\\n // Skipped\n// go.temporal.io/sdk/internal/log.(*ReplayLogger).Error\\n\\t/payrails/sdk-go/internal/log/replay_logger.go:79\\n // Skipped\n// main.HelloWorld\\n\\t/payrails/sdk-go/play/business.go:11\\n // Skipped\n// reflect.Value.call\\n\\t/usr/local/go/src/reflect/value.go:581\\n // Skipped\n// reflect.Value.Call\\n\\t/usr/local/go/src/reflect/value.go:365\\n // Skipped\n// go.temporal.io/sdk/internal.executeFunction\\n\\t/payrails/sdk-go/internal/internal_worker.go:2087\\n // Skipped\n// go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteWorkflow\\n\\t/payrails/sdk-go/internal/workflow.go:797\\n // Caller\n// go.temporal.io/sdk/internal.(*workflowExecutor).Execute\\n\\t/payrails/sdk-go/internal/internal_worker.go:922\\n\n// go.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func1\\n\\t/payrails/sdk-go/internal/internal_workflow.go:574\\n\n// go.temporal.io/sdk/internal.(*coroutineState).run\\n\\t/payrails/sdk-go/internal/internal_workflow.go:1217\n```\n\n## Steps to Reproduce the Problem\n1. Run the code below (3 files) with:\n```bash\ngo run ./play\n```\n```go\n// ./play/business.go\npackage main\n\nimport (\n\t\"fmt\"\n\n\t\"go.temporal.io/sdk/workflow\"\n)\n\nfunc HelloWorld(ctx workflow.Context, name string) (string, error) {\n\tlogger := workflow.GetLogger(ctx)\n\tlogger.Error(\"HelloWorld: this is an error inside the workflow\")\n\treturn fmt.Sprintf(\"Hello %s\", name), nil\n}\n```\n```go\n// ./play/logger.go\npackage main\n\nimport (\n\t\"fmt\"\n\n\t\"go.temporal.io/sdk/log\"\n\t\"go.uber.org/zap\"\n)\n\nvar _ log.Logger = (*customLogger)(nil)\n\nvar _ log.WithSkipCallers = (*customLogger)(nil)\n\ntype customLogger struct {\n\t*zap.SugaredLogger\n}\n\nfunc newCustomLogger() log.Logger {\n\tzlog, err := zap.NewProduction(\n\t\tzap.AddCallerSkip(1), // Skip custom logger as caller\n\t)\n\tif err != nil {\n\t\tpanic(err)\n\t}\n\treturn &customLogger{SugaredLogger: zlog.Sugar()}\n}\n\nfunc (l *customLogger) Debug(msg string, keyvals ...interface{}) {\n\tl.SugaredLogger.Debugw(msg, keyvals...)\n}\n\nfunc (l *customLogger) Info(msg string, keyvals ...interface{}) {\n\tl.SugaredLogger.Infow(msg, keyvals...)\n}\n\nfunc (l *customLogger) Warn(msg string, keyvals ...interface{}) {\n\tl.SugaredLogger.Warnw(msg, keyvals...)\n}\n\nfunc (l *customLogger) Error(msg string, keyvals ...interface{}) {\n\tl.SugaredLogger.Errorw(msg, keyvals...)\n}\n\nfunc (l *customLogger) WithCallerSkip(depth int) log.Logger {\n\tfmt.Println(\"--- skip:\", depth)\n\treturn &customLogger{\n\t\tSugaredLogger: l.SugaredLogger.WithOptions(zap.AddCallerSkip(depth)),\n\t}\n}\n```\n```go\n// ./play/main.go\npackage main\n\nimport (\n\t\"context\"\n\t\"fmt\"\n\t\"os\"\n\n\t\"go.temporal.io/sdk/client\"\n\t\"go.temporal.io/sdk/worker\"\n)\n\nfunc main() {\n\tif err := run(); err != nil {\n\t\tfmt.Println(err)\n\t\tos.Exit(1)\n\t}\n}\n\nfunc run() error {\n\t// 1. Create client\n\tlogger := newCustomLogger()\n\n\tc, err := client.Dial(client.Options{\n\t\tLogger: logger,\n\t})\n\tif err != nil {\n\t\treturn err\n\t}\n\n\t// 2. Create worker\n\twk := worker.New(c, \"main_queue\", worker.Options{})\n\twk.RegisterWorkflow(HelloWorld)\n\n\t// 3. Start a workflow\n\tgo func() {\n\t\trun, err := c.ExecuteWorkflow(context.Background(),\n\t\t\tclient.StartWorkflowOptions{\n\t\t\t\tTaskQueue: \"main_queue\",\n\t\t\t},\n\t\t\tHelloWorld,\n\t\t\t\"Ben\",\n\t\t)\n\n\t\tif err != nil {\n\t\t\tlogger.Error(\"main: failed to execute workflow\", \"error\", err)\n\t\t}\n\n\t\tvar res string\n\t\terr = run.Get(context.Background(), &res)\n\t\tif err != nil {\n\t\t\tlogger.Error(\"main: workflow failed\", \"error\", err)\n\t\t}\n\t}()\n\n\treturn wk.Run(worker.InterruptCh())\n}\n```\n\nOutput:\n```\n--- skip: 1\n--- skip: 1\n--- skip: 1\n--- skip: 1\n--- skip: 1\n--- skip: 1\n{\"level\":\"error\",\"ts\":1742900250.435758,\"caller\":\"internal/workflow.go:797\",\"msg\":\"HelloWorld: this is an error inside the workflow\",\"Namespace\":\"default\",\"TaskQueue\":\"main_queue\",\"WorkerID\":\"61032@KCJ74K6WJ2@\",\"WorkflowType\":\"HelloWorld\",\"WorkflowID\":\"c42fe9b6-357a-47ba-974e-44aeb745a25e\",\"RunID\":\"2fb6c16d-54b4-4e5e-a42b-9637f9905b5e\",\"Attempt\":1,\"stacktrace\":\"go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteWorkflow\\n\\t/payrails/sdk-go/internal/workflow.go:797\\ngo.temporal.io/sdk/internal.(*workflowExecutor).Execute\\n\\t/payrails/sdk-go/internal/internal_worker.go:922\\ngo.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func1\\n\\t/payrails/sdk-go/internal/internal_workflow.go:574\\ngo.temporal.io/sdk/internal.(*coroutineState).run\\n\\t/payrails/sdk-go/internal/internal_workflow.go:1217\"}\n```\n\n\n## Specifications\n\n  - Version: `1.33.0`\n  - Platform: MacOS Apple M1 Max, arm64\n","closedAt":"2025-03-25T14:07:18Z","comments":[{"id":"IC_kwDODN1w686j_ECH","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Your logger should also implement `WithLogger`","createdAt":"2025-03-25T13:11:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1882#issuecomment-2751217799","viewerDidAuthor":false},{"id":"IC_kwDODN1w686j_tUS","author":{"login":"AhmadElsagheer"},"authorAssociation":"NONE","body":"Thanks, that solved the problem ðŸ‘ðŸ½ Looks like `WithSkipCallers` interface is not independent.","createdAt":"2025-03-25T14:07:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1882#issuecomment-2751386898","viewerDidAuthor":false}],"createdAt":"2025-03-25T11:14:09Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDg2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1882,"reactionGroups":[],"state":"CLOSED","title":"Caller skips is incorrectly calculated when a custom logger is provided to the SDK client","updatedAt":"2025-03-25T14:07:19Z","url":"https://github.com/temporalio/sdk-go/issues/1882"}
