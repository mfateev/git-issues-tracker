{"assignees":[{"id":"MDQ6VXNlcjUxNzY4Mw==","login":"Sushisource","name":"Spencer Judge","databaseId":0}],"author":{"id":"MDQ6VXNlcjE2MjAyNjU=","is_bot":false,"login":"vkarpov15","name":"Valeri Karpov"},"body":"## Expected Behavior\r\n\r\nConsider the below test:\r\n\r\n```javascript\r\nfunc (s *UnitTestSuite) Test_AddToCart() {\r\n\tcart := CartState{Items: make([]CartItem, 0)}\r\n\r\n\ts.env.RegisterDelayedCallback(func() {\r\n\t\t// suite.go:63: test panicked: runtime error: invalid memory address or nil pointer dereference\r\n\t\tres, err := s.env.QueryWorkflow(\"getCart\")\r\n\t\ts.NoError(err)\r\n\t\terr = res.Get(&cart)\r\n\t\ts.NoError(err)\r\n\t\ts.Equal(len(cart.Items), 0)\r\n\r\n\t\tupdate := AddToCartSignal{\r\n\t\t\tRoute: RouteTypes.ADD_TO_CART,\r\n\t\t\tItem: CartItem{ProductId: 1, Quantity: 1},\r\n\t\t}\r\n\t\ts.env.SignalWorkflow(\"cartMessages\", update)\r\n\t\tfmt.Println(cart.Items)\r\n\t}, time.Millisecond*0)\r\n\r\n\ts.env.ExecuteWorkflow(CartWorkflow, cart)\r\n\r\n\tres, err := s.env.QueryWorkflow(\"getCart\")\r\n\ts.NoError(err)\r\n\terr = res.Get(&cart)\r\n\ts.NoError(err)\r\n\ts.Equal(1, len(cart.Items))\r\n\r\n\ts.True(s.env.IsWorkflowCompleted())\r\n}\r\n```\r\n\r\nI expect this test to succeed. Full code is available in this PR: https://github.com/temporalio/temporal-ecommerce/pull/5\r\n\r\n## Actual Behavior\r\n\r\nI get a runtime error that points to what looks like [this line](https://github.com/temporalio/sdk-go/blob/3b9239055da4692f37fb16351c924217a688a489/internal/internal_workflow_testsuite.go#L2217). Below is the full stack trace:\r\n\r\n```\r\n$ go test\r\n2021/05/06 14:36:04 DEBUG Auto fire timer TimerID 0 TimerDuration 87600h0m0s TimeSkipped 87600h0m0s\r\n--- FAIL: TestUnitTestSuite (0.00s)\r\n    --- FAIL: TestUnitTestSuite/Test_AddToCart (0.00s)\r\n        suite.go:63: test panicked: runtime error: invalid memory address or nil pointer dereference\r\n            goroutine 21 [running]:\r\n            runtime/debug.Stack(0xc000213400, 0xedf4a0, 0x16f65b0)\r\n            \t/usr/local/go/src/runtime/debug/stack.go:24 +0x9f\r\n            github.com/stretchr/testify/suite.failOnPanic(0xc000103380)\r\n            \t/home/val/go/pkg/mod/github.com/stretchr/testify@v1.7.0/suite/suite.go:63 +0x57\r\n            panic(0xedf4a0, 0x16f65b0)\r\n            \t/usr/local/go/src/runtime/panic.go:969 +0x1b9\r\n            go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).queryWorkflow(0xc000103680, 0x101d289, 0x7, 0x0, 0x0, 0x0, 0xc00049c000, 0xc00049c000, 0x203000, 0x20)\r\n            \t/home/val/go/pkg/mod/go.temporal.io/sdk@v1.6.0/internal/internal_workflow_testsuite.go:2211 +0x9d\r\n            go.temporal.io/sdk/internal.(*TestWorkflowEnvironment).QueryWorkflow(...)\r\n            \t/home/val/go/pkg/mod/go.temporal.io/sdk@v1.6.0/internal/workflow_testsuite.go:714\r\n            temporal-ecommerce/app.(*UnitTestSuite).Test_AddToCart.func1()\r\n            \t/home/val/Workspace/meanIT/temporal-ecommerce/workflow_test.go:38 +0x78\r\n            go.temporal.io/sdk/internal.(*testCallbackHandle).processCallback(0xc0002137a0)\r\n            \t/home/val/go/pkg/mod/go.temporal.io/sdk@v1.6.0/internal/internal_workflow_testsuite.go:691 +0x77\r\n            go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).startMainLoop(0xc000103680)\r\n            \t/home/val/go/pkg/mod/go.temporal.io/sdk@v1.6.0/internal/internal_workflow_testsuite.go:650 +0xd9\r\n            go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeWorkflowInternal(0xc000103680, 0x0, 0x168af3f, 0xc, 0xc000471720)\r\n            \t/home/val/go/pkg/mod/go.temporal.io/sdk@v1.6.0/internal/internal_workflow_testsuite.go:493 +0x21a\r\n            go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeWorkflow(0xc000103680, 0xeb9440, 0x106aa50, 0xc0004378d0, 0x1, 0x1)\r\n            \t/home/val/go/pkg/mod/go.temporal.io/sdk@v1.6.0/internal/internal_workflow_testsuite.go:437 +0x119\r\n            go.temporal.io/sdk/internal.(*TestWorkflowEnvironment).ExecuteWorkflow(...)\r\n            \t/home/val/go/pkg/mod/go.temporal.io/sdk@v1.6.0/internal/workflow_testsuite.go:487\r\n            temporal-ecommerce/app.(*UnitTestSuite).Test_AddToCart(0xc0001290e0)\r\n            \t/home/val/Workspace/meanIT/temporal-ecommerce/workflow_test.go:55 +0x20a\r\n            reflect.Value.call(0xc000483620, 0xc0001270e8, 0x13, 0x101a265, 0x4, 0xc00006ce30, 0x1, 0x1, 0xc00006ccf8, 0x40d34a, ...)\r\n            \t/usr/local/go/src/reflect/value.go:476 +0x8c7\r\n            reflect.Value.Call(0xc000483620, 0xc0001270e8, 0x13, 0xc00006ce30, 0x1, 0x1, 0x24, 0xc00005ae50, 0x456354)\r\n            \t/usr/local/go/src/reflect/value.go:337 +0xb9\r\n            github.com/stretchr/testify/suite.Run.func1(0xc000103380)\r\n            \t/home/val/go/pkg/mod/github.com/stretchr/testify@v1.7.0/suite/suite.go:158 +0x379\r\n            testing.tRunner(0xc000103380, 0xc00020ad80)\r\n            \t/usr/local/go/src/testing/testing.go:1123 +0xef\r\n            created by testing.(*T).Run\r\n            \t/usr/local/go/src/testing/testing.go:1168 +0x2b3\r\nFAIL\r\nexit status 1\r\nFAIL\ttemporal-ecommerce/app\t0.005s\r\n```\r\n\r\nIf I remove the `Select()` call from the workflow, I don't get this error. I also don't get this error if I query the workflow outside of `RegisterDelayedCallback()`\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Clone https://github.com/temporalio/temporal-ecommerce\r\n  1. `cd temporal-ecommerce`\r\n  1. `go test`\r\n\r\n## Specifications\r\n\r\n  - Version: 1.6.0\r\n  - Platform: Xubuntu 18.04\r\n","closedAt":"2021-07-02T16:34:28Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDgzNjI4NzAyNg==","author":{"login":"vitarb"},"authorAssociation":"CONTRIBUTOR","body":"Thanks for the report. I'm a little confused, I don't see Select in your code, neither in the sample you've provided in the description nor in your PR. Could you clarify please?","createdAt":"2021-05-10T07:21:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/433#issuecomment-836287026","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDgzNzE1MTU3MA==","author":{"login":"vkarpov15"},"authorAssociation":"NONE","body":"Yeah,  the `Select()` call is in [`workflow.go`](https://github.com/temporalio/temporal-ecommerce/blob/75637b7478b27018a8dfa766945b29f1710ee656/workflow.go#L132), the file that's being tested. Below is a simplified version:\r\n\r\n```go\r\nfunc CartWorkflow(ctx workflow.Context, state CartState) error {\r\n\tlogger := workflow.GetLogger(ctx)\r\n\r\n\terr := workflow.SetQueryHandler(ctx, \"getCart\", func(input []byte) (CartState, error) {\r\n\t\treturn state, nil\r\n\t})\r\n\tif err != nil {\r\n\t\tlogger.Info(\"SetQueryHandler failed.\", \"Error\", err)\r\n\t\treturn err\r\n\t}\r\n\r\n\tchannel := workflow.GetSignalChannel(ctx, SignalChannelName)\r\n\tcheckedOut := false\r\n\tsentAbandonedCartEmail := false\r\n\r\n\tfor {\r\n\t\tselector := workflow.NewSelector(ctx)\r\n\t\tselector.AddReceive(channel, func(c workflow.ReceiveChannel, _ bool) {\r\n\t\t\tvar signal interface{}\r\n\t\t\tc.Receive(ctx, &signal)\r\n\r\n\t\t\tvar routeSignal RouteSignal\r\n\t\t\terr := mapstructure.Decode(signal, &routeSignal)\r\n\t\t\tif err != nil {\r\n\t\t\t\tlogger.Error(\"Invalid signal type %v\", err)\r\n\t\t\t\treturn\r\n\t\t\t}\r\n\r\n\t\t\t// Handle routeSignal\r\n\t\t})\r\n\r\n\t\tif !sentAbandonedCartEmail && len(state.Items) > 0 {\r\n\t\t\tselector.AddFuture(workflow.NewTimer(ctx, abandonedCartTimeout), func(f workflow.Future) {\r\n\t\t\t\tsentAbandonedCartEmail = true\r\n\t\t\t\tao := workflow.ActivityOptions{\r\n\t\t\t\t\tScheduleToStartTimeout: time.Minute,\r\n\t\t\t\t\tStartToCloseTimeout:    time.Minute,\r\n\t\t\t\t}\r\n\r\n\t\t\t\tctx = workflow.WithActivityOptions(ctx, ao)\r\n\r\n\t\t\t\terr := workflow.ExecuteActivity(ctx, SendAbandonedCartEmail, state.Email).Get(ctx, nil)\r\n\t\t\t\tif err != nil {\r\n\t\t\t\t\tlogger.Error(\"Error sending email %v\", err)\r\n\t\t\t\t\treturn\r\n\t\t\t\t}\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tselector.Select(ctx) // <-- `Select()` here\r\n\r\n\t\tif checkedOut {\r\n\t\t\tbreak\r\n\t\t}\r\n\t}\r\n\r\n\treturn nil\r\n}\r\n```","createdAt":"2021-05-10T18:57:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/433#issuecomment-837151570","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg0MjY4NTAyNQ==","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"@vkarpov15 Dug into this and it is a bug with the test environment for sure. 0 duration on `RegisterDelayedCallback` will always break if you try to query inside of it because of a bug where the query handler isn't registered yet. I'll fix this. In the meantime, using any nonzero duration unblocks you.","createdAt":"2021-05-17T22:31:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/433#issuecomment-842685025","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg0MjcwNjUyNQ==","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"@vkarpov15 Spoke with Max, we decided to update the docstring - supporting this in the test framework would require significant change and it's not really something you could do in the real world in any case, since there's no `QueryWithStart` sort of functionality (which probably wouldn't be very useful anyway).","createdAt":"2021-05-17T23:22:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/433#issuecomment-842706525","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg3MzEyMTg0OA==","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"Think we can close this now","createdAt":"2021-07-02T16:34:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/433#issuecomment-873121848","viewerDidAuthor":false}],"createdAt":"2021-05-06T18:45:30Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":433,"reactionGroups":[],"state":"CLOSED","title":"Test environment `RegisterDelayedCallback()` with 0 duration which performs a query crashes","updatedAt":"2021-07-02T16:34:28Z","url":"https://github.com/temporalio/sdk-go/issues/433"}
