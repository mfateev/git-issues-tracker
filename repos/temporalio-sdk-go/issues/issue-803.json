{"assignees":[],"author":{"id":"MDQ6VXNlcjQ2NjcyMw==","is_bot":false,"login":"dnr","name":"David Reiss"},"body":"## Expected Behavior\r\nMutableSideEffect works as described in the docs.\r\n\r\n## Actual Behavior\r\nThis code:\r\n```\r\n\t// load default number\r\n\tget := func(ctx workflow.Context) interface{} { return defaultNumber }\r\n\teq := func(a, b interface{}) bool { return a.(int) == b.(int) }\r\n\tvar number int\r\n\tif err := workflow.MutableSideEffect(ctx, \"defaultNumber\", get, eq).Get(&number); err != nil {\r\n\t\tpanic(\"can't decode number:\" + err.Error())\r\n\t}\r\n```\r\nworks at first, but if I kill and restart the worker to force replay, I get:\r\n```\r\n2022/05/09 18:16:00 ERROR Workflow panic Namespace default TaskQueue hello-world WorkerID 2450384@pinglin@ WorkflowType Workflow WorkflowID hello_world_workflowID RunID 408db9e3-7885-4ca5-be59-0bce212c08eb Attempt 1 Error can't decode number:payload item 0: unable to decode: json: cannot unmarshal string into Go value of type int StackTrace coroutine root [panic]:\r\ngithub.com/temporalio/samples-go/helloworld.Workflow({0xdfce40, 0xc00043a580}, {0xc0004360f8, 0x8})\r\n        /home/dnr/t/samples-go/helloworld/helloworld.go:21 +0x23d\r\nreflect.Value.call({0xbe9b60?, 0xd38768?, 0x30?}, {0xcd73c3, 0x4}, {0xc00040d1d0, 0x2, 0x18?})\r\n        /nix/store/f2n8g9nbrxaqwyd9b3grynvwhyz3qlrw-go-1.18/share/go/src/reflect/value.go:556 +0x845\r\nreflect.Value.Call({0xbe9b60?, 0xd38768?, 0xc000407d28?}, {0xc00040d1d0, 0x2, 0x2})\r\n        /nix/store/f2n8g9nbrxaqwyd9b3grynvwhyz3qlrw-go-1.18/share/go/src/reflect/value.go:339 +0xbf\r\ngo.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).ExecuteWorkflow(0xc00042a730?, {0xdfce40?, 0xc00043a580?}, {0xc00042e490?, 0xc0005a86c0?}, {0xc00042e4a0?, 0x1?, 0xc0001030c8?})\r\n        /home/dnr/t/go/pkg/mod/go.temporal.io/sdk@v1.6.0/internal/workflow.go:393 +0x1e5\r\ngo.temporal.io/sdk/internal.(*workflowExecutor).Execute(0xc00043a500, {0xdfce40, 0xc00043a580}, 0x25?)\r\n        /home/dnr/t/go/pkg/mod/go.temporal.io/sdk@v1.6.0/internal/internal_worker.go:762 +0x2c3\r\ngo.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute.func1({0xdfcfc8, 0xc00040d170})\r\n        /home/dnr/t/go/pkg/mod/go.temporal.io/sdk@v1.6.0/internal/internal_workflow.go:494 +0xcd\r\n\r\n```\r\n\r\nAnother weird thing I noticed was what was encoded in the marker:\r\n\r\n```\r\n{\r\n  \"data\": {\r\n    \"payloads\": [\r\n      {\r\n        \"metadata\": {\"encoding\": \"anNvbi9wbGFpbg==\"},\r\n        \"data\": \"ImRlZmF1bHROdW1iZXIi\"\r\n      },\r\n      {\r\n        \"metadata\": {\"encoding\": \"anNvbi9wcm90b2J1Zg==\"},\r\n        \"data\": \"eyJwYXlsb2FkcyI6W3sibWV0YWRhdGEiOnsiZW5jb2RpbmciOiJhbk52Ymk5d2JHRnBiZz09In0sImRhdGEiOiJNVGs9In1dfQ==\"\r\n      }\r\n    ]\r\n  },\r\n  \"side-effect-id\": {\r\n    \"payloads\": [\r\n      {\r\n        \"metadata\": {\"encoding\": \"anNvbi9wbGFpbg==\"},\r\n        \"data\": \"ImRlZmF1bHROdW1iZXIi\"\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\nDecoding all of that base64 to strings just to make things clear (pseudo-json):\r\n```\r\n{\r\n  \"data\": {\r\n    \"payloads\": [\r\n      {\r\n        \"metadata\": {\"encoding\": \"json/plain\"},\r\n        \"data\": `\"defaultNumber\"`\r\n      },\r\n      {\r\n        \"metadata\": {\"encoding\": \"json/protobuf\"},\r\n        \"data\": `{\"payloads\":[{\"metadata\":{\"encoding\":\"anNvbi9wbGFpbg==\"},\"data\":\"MTk=\"}]}`\r\n      }\r\n    ]\r\n  },\r\n  \"side-effect-id\": {\r\n    \"payloads\": [\r\n      {\r\n        \"metadata\": {\"encoding\": \"json/plain\"},\r\n        \"data\": `\"defaultNumber\"`\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\nThat is, the actual data is double-base64-encoded.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nRepro here: https://github.com/dnr/samples-go/tree/mutablesideeffect/helloworld\r\n\r\n1. Run the worker\r\n2. Run the starter\r\n3. Kill the worker\r\n4. Start the worker again\r\n\r\n## Specifications\r\n\r\n  - Version: tested go sdk 1.6.0 and also 1.14.0. server is a branch somewhere near 1.16.0. go 1.18\r\n  - Platform: linux\r\n","closedAt":"2022-05-25T14:08:20Z","comments":[{"id":"IC_kwDODN1w685DOLRO","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@dnr - Thanks for the report! Can you give a bit more to your snippet? Specifically I am looking to see the `defaultNumber` variable and where it's defined.\r\n\r\nI will attempt to replicate and fix shortly.","createdAt":"2022-05-16T15:04:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/803#issuecomment-1127789646","viewerDidAuthor":false},{"id":"IC_kwDODN1w685DOyhw","author":{"login":"dnr"},"authorAssociation":"MEMBER","body":"It's all in here: https://github.com/dnr/samples-go/tree/mutablesideeffect/helloworld","createdAt":"2022-05-16T17:36:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/803#issuecomment-1127950448","viewerDidAuthor":false},{"id":"IC_kwDODN1w685DPgad","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Ok, I have replicated this issue. It seems we have no good tests for mutable side effects :-( I have found two issues:\r\n\r\n1. We do not properly unwrap the payloads from history that we wrap. It seems #151 wrapped them but didn't unwrap them on replay/history properly and there was no test to confirm it does\r\n2. We are not recording a command during replay so there is a command mismatch\r\n\r\nI am working on a fix","createdAt":"2022-05-16T21:09:50Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/803#issuecomment-1128138397","viewerDidAuthor":false},{"id":"IC_kwDODN1w685DSf3B","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"This is a much harder problem than it seems, and mutable side effects have never worker properly during replay.\r\n\r\nBasically, the Go SDK maintains a counter so it can re-obtain things deterministically. This counter, which is incremented each command, is used for command IDs, timer IDs, cancellation IDs, signal IDs, upsert search attr IDs, etc.\r\n\r\nWhen mutable side effect callback result _is not equal_ to the previous one during normal run, we record a marker command which increments the counter for all other commands. But we don't record a command if it _is equal_. During replay however, we can never know it is or isn't equal because we are not allowed to invoke the callback. So, do we record a command or not? If we don't get it right, the command counter mismatches causing non-determinism issues.\r\n\r\nSo, given a Go workflow that does:\r\n\r\n1. WFT start (counter 5)\r\n1. Mutable side effect not equal - record marker command (++counter)\r\n1. Start a timer with ID 7 (++counter)\r\n1. WFT end\r\n1. Marker recorded\r\n1. Timer 7 started\r\n1. WFT start (counter 7)\r\n1. Mutable side effect equal - *do not* record marker command\r\n1. Start a timer with ID 8 (++counter)\r\n1. WFT end\r\n1. Timer 8 started\r\n\r\nThis is how replay looks if we _always_ record marker during replay\r\n\r\n1. WFT start (counter 5)\r\n1. Mutable side effect - record marker command (++counter)\r\n1. Start a timer with ID 7 (++counter)\r\n1. WFT end\r\n1. Marker recorded\r\n1. Timer 7 started\r\n1. WFT start (counter 7)\r\n1. Mutable side effect - record marker command (++counter) - note, we don't know equal vs not-equal here\r\n1. Start a timer with ID 9 (++counter)\r\n1. WFT end\r\n1. Timer 8 started\r\n\r\nThat last step causes an error because timer 8 does not exist.\r\n\r\nThis is how replay looks if we _never_ record marker during replay (what the code does today):\r\n\r\n1. WFT start (counter 5)\r\n1. Mutable side effect - *do not* record marker command\r\n1. Start a timer with ID 6 (++counter)\r\n1. WFT end\r\n1. Marker recorded (we don't error today if we don't know about the marker)\r\n1. Timer 7 started\r\n\r\nThat last step causes an error because timer 7 does not exist.\r\n\r\nSo, what do we do here? Java seems to use a \"fake\" marker on every replay and just skips it when checking, but Go is not that fortunate because it has a counter that affects all things after it. Right now, here is the best solution I can think of:\r\n\r\n* Track all replay markers recorded last WFT\r\n* For every replay marker not recorded in history by the next WFT start, undo everything it did, which means I have to change past-recorded counter uses which includes:\r\n  * Cancellation IDs for all pending cancel-external-workflow commands\r\n  * Signal IDs for all pending signal-external-workflow commands\r\n  * Upsert IDs for all pending upsert-search-attribute commands\r\n  * Child workflow IDs for all pending execute-child-workflow commands. This is a bit complicated, because it only applies if they didn't provide their own workflow ID. When they don't provide it, it is `<parent-run-id>_<++counter>`. So I have to either check that it matches that pattern or maintain some state saying whether I auto-generated the ID so I can alter the generated value\r\n  * Timer IDs for all pending timer commands\r\n  * Schedule activity IDs for all pending execute-activity commands\r\n\r\nIs there a better option here I am missing? cc @Sushisource, @mfateev, @yiminc, @alexshtin","createdAt":"2022-05-17T14:11:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/803#issuecomment-1128922561","viewerDidAuthor":false},{"id":"IC_kwDODN1w685DTrdy","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"OK, I have been able to use marker lookahead here. PR incoming...","createdAt":"2022-05-17T19:21:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/803#issuecomment-1129232242","viewerDidAuthor":false}],"createdAt":"2022-05-10T01:37:24Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":803,"reactionGroups":[],"state":"CLOSED","title":"MutableSideEffect doesn't seem to work","updatedAt":"2022-05-25T14:08:20Z","url":"https://github.com/temporalio/sdk-go/issues/803"}
