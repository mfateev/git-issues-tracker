{"assignees":[],"author":{"id":"MDQ6VXNlcjE1ODI5MTU3","is_bot":false,"login":"jupudibhaskar967","name":"Naga Jupudi"},"body":"## Expected Behavior\nTest should be successful.\n\n## Actual Behavior\nTest panics when executing env.ExecuteWorkflow()\nTried with v1.36.0 SDK version as well but still the test is flaky and fails intermittently.\n\n## Steps to Reproduce the Problem\n\nWorkflow definition\n```\nfunc TestNewWorkflow(ctx workflow.Context, envName string, orgName string, baseDir string) (string, error) {\n\tchildOpts := workflow.ChildWorkflowOptions{\n\t\tWorkflowExecutionTimeout: childWorkflowTimeout,\n\t\tWorkflowTaskTimeout:      childWorkflowTaskTimeout,\n\t\tParentClosePolicy:        enums.PARENT_CLOSE_POLICY_REQUEST_CANCEL,\n\t}\n\tchildCtx := workflow.WithChildOptions(ctx, childOpts)\n\tfutures := make([]workflow.ChildWorkflowFuture, 0)\n\tfor ii := 0; ii < 500; ii++ {\n\t\tfuture := workflow.ExecuteChildWorkflow(childCtx, ManualStageWorkflow)\n\t\tfutures = append(futures, future)\n\t}\n\n\tfor ii := 0; ii < 500; ii++ {\n\t\tif err := futures[ii].Get(childCtx, nil); err != nil {\n\t\t\treturn \"\", err\n\t\t}\n\t}\n\n\treturn \"Successfully executed 500 child workflows\", nil\n}\n```\n\nUnit test definition\n```\n// Registration and env instantiation:\ntestSuite = &testsuite.WorkflowTestSuite{}\nenv = testSuite.NewTestWorkflowEnvironment()\nenv.RegisterWorkflow(orchworker.TestNewWorkflow)\nenv.RegisterWorkflow(orchworker.ManualStageWorkflow)\n\n// Actual test\nIt(\"Simulate panic\", func() {\n\tenv.OnWorkflow(orchworker.ManualStageWorkflow, mock.Anything, mock.Anything).\n\t\tReturn(errors.New(\"test\")).Maybe()\n\tenv.ExecuteWorkflow(orchworker.TestNewWorkflow, \"testenv\", \"org1\", \"\")\n\tExpect(env.IsWorkflowCompleted()).To(BeTrue())\n\tExpect(env.GetWorkflowError()).To(HaveOccurred())\n})\n\n```\n\nThe test behavior is flaky with occasional failures\n`watch -n3 \"go clean -testcache && go test -v <package> -ginkgo.focus=\"Simulate panic\"\"`\n\nPanic stack trace:\n```\n/go/pkg/mod/go.temporal.io/sdk@v1.30.0/internal/internal_workflow_testsuite.go:2855 +0x30\ngo.temporal.io/sdk/internal.(*testCallbackHandle).processCallback(0x40004d3bc8)\n\t/go/pkg/mod/go.temporal.io/sdk@v1.30.0/internal/internal_workflow_testsuite.go:857 +0xb8\ngo.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).startMainLoop(0x4000318488)\n\t/go/pkg/mod/go.temporal.io/sdk@v1.30.0/internal/internal_workflow_testsuite.go:797 +0x10c\ngo.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeWorkflowInternal(0x4000318488, 0x0, {0xf8ea84, 0xf}, 0x4000391c00)\n\t/go/pkg/mod/go.temporal.io/sdk@v1.30.0/internal/internal_workflow_testsuite.go:591 +0x384\ngo.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeWorkflow(0x4000318488, {0xa5a300, 0xc5ca40}, {0x4000472f60, 0x3, 0x3})\n\t/go/pkg/mod/go.temporal.io/sdk@v1.30.0/internal/internal_workflow_testsuite.go:535 +0x104\ngo.temporal.io/sdk/internal.(*TestWorkflowEnvironment).ExecuteWorkflow(0x400037ea80?, {0xa5a300?, 0xc5ca40?}, {0x4000472f60?, 0x2?, 0x2?})\n\t/go/pkg/mod/go.temporal.io/sdk@v1.30.0/internal/workflow_testsuite.go:776 +0xac\norchestration/internal/orchworker_test.init.func3.4.3()\n\t/app/internal/orchworker/workflow_test.go:356 +0x154\n```\n\n## Specifications\n\n  - Version: 1.30.0\n  - Platform: Alpine with go 1.25.3\n","closedAt":null,"comments":[],"createdAt":"2025-11-10T21:16:09Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDg2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":2107,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"OPEN","title":"Panic in temporal unit test framework.","updatedAt":"2025-11-10T21:16:56Z","url":"https://github.com/temporalio/sdk-go/issues/2107"}
