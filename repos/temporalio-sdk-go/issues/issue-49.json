{"assignees":[],"author":{"id":"MDQ6VXNlcjE3NjY1MTU=","is_bot":false,"login":"samarabbas","name":"Samar Abbas"},"body":"I have a workflow that contains a snippet like this:\r\n\r\n```\r\noptions := workflow.ActivityOptions{\r\n\t\tScheduleToStartTimeout: 60 * time.Minute,\r\n\t\tStartToCloseTimeout:    60 * time.Minute,\r\n\t\tScheduleToCloseTimeout: 60 * time.Minute,\r\n\t\tHeartbeatTimeout:       5 * time.Minute,\r\n\t\tActivityID:             activities.GenerateID(ctx, \"partprocessor\"),\r\n\t}\r\n\tpartProcessorContext := workflow.WithActivityOptions(ctx, options)\r\n\r\n\tcompleteEntityCtx := workflow.WithActivityOptions(ctx, workflow.ActivityOptions{\r\n\t\tScheduleToStartTimeout: 5 * time.Second,\r\n\t\tStartToCloseTimeout:    10 * time.Minute,\r\n\t\tScheduleToCloseTimeout: 10 * time.Minute,\r\n\t\tHeartbeatTimeout:       10 * time.Minute,\r\n\t\tActivityID:             activities.GenerateID(ctx, \"completeentity\"),\r\n\t})\r\n\r\n\tvar runPartProcessorOutput activities.RunPartProcessorOutput\r\n\terr := workflow.ExecuteActivity(partProcessorContext, activities.RunPartProcessor, partID).Get(partProcessorContext, &runPartProcessorOutput)\r\n```\r\n\r\n`GenerateID` above calls `workflow.SideEffect` to generate an id for our activities.\r\n\r\n```\r\nfunc GenerateID(ctx workflow.Context, activityName string) string {\r\n\tencodedActivityID := workflow.SideEffect(ctx, func(ctx workflow.Context) interface{} {\r\n\t\treturn workflow.GetInfo(ctx).WorkflowExecution.ID + \"-\" + activityName + \"-\" + uuid.New()\r\n\t})\r\n\tvar activityID string\r\n\terr := encodedActivityID.Get(&activityID)\r\n\tif err != nil {\r\n\t\tpanic(err)\r\n\t}\r\n\treturn activityID\r\n}\r\n```\r\n\r\nWhen I run this code, `RunPartProcessor` activity ends up with an id that contains the word `completeentity`. So not sure if the problem is that I've called `SideEffect` twice in a row with different parameters. Or if `ExecuteActivity` is using the latest context created instead of the context I explicitly passed.\r\n\r\nHere's my test that fails:\r\n\r\n```\r\nfunc TestWorkflow(t *testing.T) {\r\n\tt.Run(\"WhenSuccessfulExpectsWorkflowCompleted\", func(t *testing.T) {\r\n\t\t// arrange - variables\r\n\t\ts := &testsuite.WorkflowTestSuite{}\r\n\t\tenv := s.NewTestWorkflowEnvironment()\r\n\t\tpartID := 32\r\n\t\texpectedRunPartProcessorOutput := &activities.RunPartProcessorOutput{}\r\n\r\n\t\t// arrange - mock activities\r\n\t\tmockPartProcessorActivity := func(ctx context.Context, partID int) (*activities.RunPartProcessorOutput, error) {\r\n\t\t\tactivityInfo := activity.GetInfo(ctx)\r\n\t\t\tenv.RegisterDelayedCallback(func() {\r\n\t\t\t\terr := env.CompleteActivity(activityInfo.TaskToken, expectedRunPartProcessorOutput, nil)\r\n\t\t\t\tassert.NoError(t, err)\r\n\t\t\t}, time.Second)\r\n\t\t\treturn nil, activity.ErrResultPending\r\n\t\t}\r\n\r\n\t\tenv.OnActivity(activities.RunPartProcessor, mock.Anything, partID).Return(mockPartProcessorActivity)\r\n\t\tenv.OnActivity(activities.CompleteEntity, mock.Anything, keys.PartManager, partID, 0, \"\").Return(nil)\r\n\r\n\t\t// arrange - setup listeners\r\n\t\tenv.SetOnActivityCompletedListener(func(activityInfo *activity.Info, result encoded.Value, err error) {\r\n\t\t\tswitch activityInfo.ActivityType.Name {\r\n\t\t\tcase \"github.com/3dsim/workflow/activities.RunPartProcessor\":\r\n\t\t\t\tif err != nil && err != activity.ErrResultPending {\r\n\t\t\t\t\tassert.FailNow(t, err.Error())\r\n\t\t\t\t}\r\n\t\t\t\tassert.NotEmpty(t, activityInfo.ActivityID, \"Expected part processor to have completed\")\r\n\t\t\t\tassert.Contains(t, activityInfo.ActivityID, \"partprocessor\", \"Expected activity id for RunPartProcessor to contain the word 'partprocessor'\")\r\n\t\t\tcase \"github.com/3dsim/workflow/activities.CompleteEntity\":\r\n\t\t\t\tassert.Contains(t, activityInfo.ActivityID, \"completeentity\", \"Expected activity id for CompleteEntity to contain the word 'completeentity'\")\r\n\t\t\t\tassert.NotEmpty(t, activityInfo.ActivityID, \"Expected completeEntity to have completed\")\r\n\t\t\tdefault:\r\n\t\t\t\tt.Fatal(\"Unknown activity type: \" + activityInfo.ActivityType.Name)\r\n\t\t\t}\r\n\t\t})\r\n\r\n\t\t// act\r\n\t\tenv.ExecuteWorkflow(Workflow, partID)\r\n\r\n\t\t// assert\r\n\t\tassert.True(t, env.IsWorkflowCompleted(), \"Expected workflow to complete\")\r\n\t\tassert.NoError(t, env.GetWorkflowError(), \"Expected no errors\")\r\n\t\tenv.AssertExpectations(t)\r\n\t})\r\n}\r\n```","closedAt":"2020-03-03T21:54:53Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDU5NDE5MDE4OA==","author":{"login":"samarabbas"},"authorAssociation":"MEMBER","body":"Ported from https://github.com/uber-go/cadence-client/issues/372","createdAt":"2020-03-03T21:54:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/49#issuecomment-594190188","viewerDidAuthor":false}],"createdAt":"2020-03-03T21:54:37Z","labels":[],"milestone":null,"number":49,"reactionGroups":[],"state":"CLOSED","title":"Context used for ExecuteActivity is ignored or SideEffect ignores parameters","updatedAt":"2020-03-03T21:54:53Z","url":"https://github.com/temporalio/sdk-go/issues/49"}
