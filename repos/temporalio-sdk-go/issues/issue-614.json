{"assignees":[],"author":{"id":"MDQ6VXNlcjEwNjA4NzM=","is_bot":false,"login":"tminusplus","name":"Travis"},"body":"## Expected Behavior\r\nTesting a cron child workflow with PARENT_CLOSE_POLICY_ABANDON should either close with the parent workflow for testsuite or have a method to shutdown the child workflow for the test.\r\n\r\n## Actual Behavior\r\nThe cron child workflow runs forever due to the auto-fire timer and then panics when the test times out.\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nOriginally produced while updating go-sdk in a repo. There is a test below for internal_workflow_testsuite_test.go which can reproduce the issue\r\n```\r\nfunc (s *WorkflowTestSuiteUnitTest) Test_CronChildWorkflowWithParentPolicyAbandon() {\r\n\tfailedCount, successCount, lastCompletionResult := 0, 0, 0\r\n\tcronWorkflow := func(ctx Context) (int, error) {\r\n\t\tinfo := GetWorkflowInfo(ctx)\r\n\t\tvar result int\r\n\t\tif HasLastCompletionResult(ctx) {\r\n\t\t\t_ = GetLastCompletionResult(ctx, &result)\r\n\t\t}\r\n\t\t_ = Sleep(ctx, time.Second*3)\r\n\t\tif info.Attempt == 1 {\r\n\t\t\tfailedCount++\r\n\t\t\treturn 0, errors.New(\"please-retry\")\r\n\t\t}\r\n\r\n\t\tsuccessCount++\r\n\t\tresult++\r\n\t\tlastCompletionResult = result\r\n\t\treturn result, nil\r\n\t}\r\n\r\n\ttestWorkflow := func(ctx Context) error {\r\n\t\tctx1 := WithChildWorkflowOptions(ctx, ChildWorkflowOptions{\r\n\t\t\tWorkflowRunTimeout: time.Minute * 10,\r\n\t\t\tRetryPolicy: &RetryPolicy{\r\n\t\t\t\tMaximumAttempts:        5,\r\n\t\t\t\tInitialInterval:        time.Second,\r\n\t\t\t\tMaximumInterval:        time.Second * 10,\r\n\t\t\t\tBackoffCoefficient:     2,\r\n\t\t\t\tNonRetryableErrorTypes: []string{\"bad-bug\"},\r\n\t\t\t},\r\n\t\t\tParentClosePolicy: enumspb.PARENT_CLOSE_POLICY_ABANDON,\r\n\t\t\tCronSchedule:      \"0 * * * *\", // hourly\r\n\t\t})\r\n\r\n\t\tcronFuture := ExecuteChildWorkflow(ctx1, cronWorkflow) // cron never stop so this future won't return\r\n\r\n\t\ttimeoutTimer := NewTimer(ctx, time.Hour*3)\r\n\t\tselector := NewSelector(ctx)\r\n\t\tvar err error\r\n\t\tselector.AddFuture(cronFuture, func(f Future) {\r\n\t\t\terr = errors.New(\"cron workflow returns, this is not expected\")\r\n\t\t}).AddFuture(timeoutTimer, func(f Future) {\r\n\t\t\t// err will be nil\r\n\t\t}).Select(ctx)\r\n\r\n\t\treturn err\r\n\t}\r\n\r\n\tenv := s.NewTestWorkflowEnvironment()\r\n\tenv.RegisterWorkflow(cronWorkflow)\r\n\tenv.RegisterWorkflow(testWorkflow)\r\n\r\n\tstartTime, _ := time.Parse(time.RFC3339, \"2018-12-20T16:30:00+08:00\")\r\n\tenv.SetStartTime(startTime)\r\n\tenv.ExecuteWorkflow(testWorkflow)\r\n\r\n\ts.True(env.IsWorkflowCompleted())\r\n\terr := env.GetWorkflowError()\r\n\ts.NoError(err)\r\n\r\n\ts.Equal(4, failedCount)\r\n\ts.Equal(4, successCount)\r\n\ts.Equal(4, lastCompletionResult)\r\n}\r\n```\r\n\r\nThen you can run it with `go test -run \"TestUnitTestSuite/Test_CronChildWorkflowWithParentPolicyAbandon\"` in `sdk-go/internal`\r\n\r\n## Specifications\r\n\r\n  - Version: v1.11.0\r\n  - Platform: Mac v11.6\r\n","closedAt":"2021-11-19T18:11:01Z","comments":[{"id":"IC_kwDODN1w6845EoQS","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"To clarify, you are saying that when using abandon in a non-test it is expected to wait until fired and not be related to parent closing, but in a test scenario it should relate to parent closing? How would the child be closed in a non-test scenario? Maybe there should be some way to terminate all workflows started by the test suite? Sorry if I am misunderstanding.","createdAt":"2021-11-02T12:59:45Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/614#issuecomment-957514770","viewerDidAuthor":false},{"id":"IC_kwDODN1w6845GHWF","author":{"login":"tminusplus"},"authorAssociation":"NONE","body":"For the non-test, yes that is my understanding. But to be clear, the main issue I am reporting is that within testsuite, if you run a child cron-job with PARENT_CLOSE_POLICY_ABANDON the test will run forever until it hits a time-out, in which case it panics.\r\n\r\nI'm not sure what the best or intended behavior should be for testsuite, but I am hoping that we can find some method so that child cron-jobs with PARENT_CLOSE_POLICY_ABANDON can be tested without running forever.","createdAt":"2021-11-02T16:16:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/614#issuecomment-957904261","viewerDidAuthor":false},{"id":"IC_kwDODN1w6845GMKb","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> but I am hoping that we can find some method so that child cron-jobs with PARENT_CLOSE_POLICY_ABANDON can be tested without running forever.\r\n\r\nHow about some kind of \"close\" or \"terminate all\" that will stop all workflows for the test environment regardless of how they were started?","createdAt":"2021-11-02T16:33:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/614#issuecomment-957923995","viewerDidAuthor":false},{"id":"IC_kwDODN1w6845cE8o","author":{"login":"tszucs-stripe"},"authorAssociation":"NONE","body":"That would be great, the only issue is that the blocking happens on `env.ExecuteWorkflow(testWorkflow)`. So maybe it would have to be done in a callback, or even some config to specify how many times a workflow may run.","createdAt":"2021-11-08T23:17:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/614#issuecomment-963661608","viewerDidAuthor":false},{"id":"IC_kwDODN1w68451iXa","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Note, this was introduced by https://github.com/temporalio/sdk-go/pull/471.","createdAt":"2021-11-16T14:36:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/614#issuecomment-970335706","viewerDidAuthor":false}],"createdAt":"2021-11-02T06:19:24Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":614,"reactionGroups":[],"state":"CLOSED","title":"Testing cron child workflow with parent policy abandon runs forever","updatedAt":"2021-11-19T18:11:01Z","url":"https://github.com/temporalio/sdk-go/issues/614"}
