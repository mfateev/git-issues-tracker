{"assignees":[],"author":{"id":"MDQ6VXNlcjUxNzY4Mw==","is_bot":false,"login":"Sushisource","name":"Spencer Judge"},"body":"Came up while running integ tests for an unrelated change:\r\n\r\n```\r\n==================\r\nWARNING: DATA RACE\r\nRead at 0x00c000316a80 by goroutine 4489:\r\n  runtime.raceread()\r\n      <autogenerated>:1 +0x24\r\n  go.temporal.io/sdk/internal.(*eagerActivityExecutor).handleResponse()\r\n      /home/runner/work/sdk-go/sdk-go/internal/internal_eager_activity.go:143 +0x388\r\n  go.temporal.io/sdk/internal.(*workflowTaskPoller).RespondTaskCompleted()\r\n      /home/runner/work/sdk-go/sdk-go/internal/internal_task_pollers.go:427 +0x765\r\n  go.temporal.io/sdk/internal.(*workflowTaskPoller).RespondTaskCompletedWithMetrics()\r\n      /home/runner/work/sdk-go/sdk-go/internal/internal_task_pollers.go:386 +0x924\r\n  go.temporal.io/sdk/internal.(*workflowTaskPoller).processWorkflowTask()\r\n      /home/runner/work/sdk-go/sdk-go/internal/internal_task_pollers.go:347 +0x64b\r\n  go.temporal.io/sdk/internal.(*workflowTaskPoller).ProcessTask()\r\n      /home/runner/work/sdk-go/sdk-go/internal/internal_task_pollers.go:296 +0x93\r\n  go.temporal.io/sdk/internal.(*baseWorker).processTask()\r\n      /home/runner/work/sdk-go/sdk-go/internal/internal_worker_base.go:440 +0x255\r\n  go.temporal.io/sdk/internal.(*baseWorker).runTaskDispatcher.func2()\r\n      /home/runner/work/sdk-go/sdk-go/internal/internal_worker_base.go:334 +0x58\r\n\r\nPrevious write at 0x00c000316a80 by goroutine 4493:\r\n  runtime.racewrite()\r\n      <autogenerated>:1 +0x24\r\n  go.temporal.io/sdk/internal.awaitWaitGroup.func1()\r\n      /home/runner/work/sdk-go/sdk-go/internal/internal_utils.go:180 +0x39\r\n\r\nGoroutine 4489 (running) created at:\r\n  go.temporal.io/sdk/internal.(*baseWorker).runTaskDispatcher()\r\n      /home/runner/work/sdk-go/sdk-go/internal/internal_worker_base.go:334 +0x10f\r\n  go.temporal.io/sdk/internal.(*baseWorker).Start.func3()\r\n      /home/runner/work/sdk-go/sdk-go/internal/internal_worker_base.go:275 +0x39\r\n\r\nGoroutine 4493 (finished) created at:\r\n  go.temporal.io/sdk/internal.awaitWaitGroup()\r\n      /home/runner/work/sdk-go/sdk-go/internal/internal_utils.go:179 +0x131\r\n  go.temporal.io/sdk/internal.(*baseWorker).Stop()\r\n      /home/runner/work/sdk-go/sdk-go/internal/internal_worker_base.go:458 +0xb9\r\n  go.temporal.io/sdk/internal.(*activityWorker).Stop()\r\n      /home/runner/work/sdk-go/sdk-go/internal/internal_worker.go:472 +0x149\r\n  go.temporal.io/sdk/internal.(*AggregatedWorker).Stop()\r\n      /home/runner/work/sdk-go/sdk-go/internal/internal_worker.go:1074 +0xeb\r\n  go.temporal.io/sdk/test_test.(*IntegrationTestSuite).TearDownTest()\r\n      /home/runner/work/sdk-go/sdk-go/test/integration_test.go:254 +0x9e\r\n  github.com/stretchr/testify/suite.Run.func1.1()\r\n      /home/runner/go/pkg/mod/github.com/stretchr/testify@v1.8.1/suite/suite.go:157 +0x319\r\n  runtime.deferreturn()\r\n      /opt/hostedtoolcache/go/1.20.1/x64/src/runtime/panic.go:476 +0x32\r\n  testing.tRunner()\r\n      /opt/hostedtoolcache/go/1.20.1/x64/src/testing/testing.go:1576 +0x216\r\n  testing.(*T).Run.func1()\r\n      /opt/hostedtoolcache/go/1.20.1/x64/src/testing/testing.go:1629 +0x47\r\n==================\r\n```","closedAt":"2023-08-11T17:04:35Z","comments":[{"id":"IC_kwDODN1w685VxIWa","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Yeah, we're mutating that wait group while waiting on it and not sure there's an easy way out short of switching to channels. If https://github.com/temporalio/sdk-go/blob/dc4f883fc62dd266579b73b46e1e49b936291fd5/internal/internal_eager_activity.go#L143 didn't trigger it, https://github.com/temporalio/sdk-go/blob/dc4f883fc62dd266579b73b46e1e49b936291fd5/internal/internal_worker_base.go#L333 probably would. But this is definitely a race. If we receive an activity task (eager or not) during Stop, something could get missed.","createdAt":"2023-02-21T18:46:39Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1050#issuecomment-1438942618","viewerDidAuthor":false},{"id":"IC_kwDODN1w685joNi_","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"This is happening a lot more know with the introduction of `TestEagerWorkflowDispatchRaceWithWorkerStop`, going to need to fix this\r\n\r\n\r\nhttps://github.com/temporalio/sdk-go/actions/runs/5803250659/job/15730996485\r\n","createdAt":"2023-08-09T14:28:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1050#issuecomment-1671485631","viewerDidAuthor":false}],"createdAt":"2023-02-21T18:19:31Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1050,"reactionGroups":[],"state":"CLOSED","title":"Data race in eager activity handling","updatedAt":"2023-08-11T17:04:35Z","url":"https://github.com/temporalio/sdk-go/issues/1050"}
