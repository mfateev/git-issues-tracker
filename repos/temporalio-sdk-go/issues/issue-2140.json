{"assignees":[],"author":{"id":"U_kgDODJ0gtw","is_bot":false,"login":"LaurynasKatkus","name":""},"body":"## Expected Behavior\n\nWhen I use `contrib/opentelemetry` as MetricsHandler in `client.Dial(client.Options{})`, I expect that Counter metrics will have `_total` suffix as describe in Prometheus. They do not.\n\n## Actual Behavior\n\nAs per [Temporal metric documentation](https://docs.temporal.io/references/sdk-metrics#workflow_completed), `workflow_completed` metric is of type Counter. According to [Prometheus documentation](https://prometheus.io/docs/specs/om/open_metrics_spec/#counter-1):\n\n> The MetricPoint's Total Value Sample MetricName MUST have the suffix _total\n\nWhen I expose metrics using `contrib/opentelemetry`, instead of Tally, the `workflow_completed` is described as Gauge, not as Counter.\n\nSupport for OpenTelemetry was added with this [issue](https://github.com/temporalio/sdk-go/issues/1137).\n\n## Steps to Reproduce the Problem\n\nI have used https://github.com/temporalio/samples-go/tree/main/metrics as a base. Instead of Tally, I have wired worker to use OTEL:\n\n```\nfunc main() {\n\treader, err := prometheusexporter.New()\n\tif err != nil {\n\t\tfmt.Errorf(\"error creating prometheus exporter: %w\", err)\n\t}\n\n\tmeterProvider := sdkmetric.NewMeterProvider(sdkmetric.WithReader(reader))\n\totel.SetMeterProvider(meterProvider)\n\n\t// Start Prometheus HTTP server using the registry\n\tgo func() {\n\t\tlog.Println(\"Serving Prometheus metrics on :9090/metrics\")\n\t\thttp.Handle(\"/metrics\", promhttp.Handler())\n\t\tif err := http.ListenAndServe(\":9090\", nil); err != nil {\n\t\t\tlog.Fatalln(\"Failed to start Prometheus server\", err)\n\t\t}\n\t}()\n\n\t// The client and worker are heavyweight objects that should be created once per process.\n\tc, err := client.Dial(client.Options{\n\t\tMetricsHandler: opentelemetry.NewMetricsHandler(opentelemetry.MetricsHandlerOptions{\n\t\t\tMeter: meterProvider.Meter(\"temporal-sdk\"),\n\t\t}),\n\t})\n\tif err != nil {\n\t\tlog.Fatalln(\"Unable to create client\", err)\n\t}\n\tdefer c.Close()\n\n\tw := worker.New(c, \"metrics\", worker.Options{})\n\n\tw.RegisterWorkflow(metrics.Workflow)\n\tw.RegisterActivity(metrics.Activity)\n\n\terr = w.Run(worker.InterruptCh())\n\tif err != nil {\n\t\tlog.Fatalln(\"Unable to start worker\", err)\n\t}\n\n\t// Shutdown the MeterProvider\n\tif err := meterProvider.Shutdown(context.Background()); err != nil {\n\t\tlog.Println(\"Error shutting down meter provider:\", err)\n\t}\n}\n```\n\nThe rest is the same.\n\n## Specific Problem\n\nOpenTelemetry handler implements Counter as `m.meter.Int64UpDownCounter(name)`. Within the test of Counter, it explicitly tests whether Counter is [not monotonic](https://github.com/temporalio/sdk-go/blob/master/contrib/opentelemetry/handler_test.go#L81). In opentelemetry-go prometheus exporter, it [explicitly checks](https://github.com/open-telemetry/opentelemetry-go/blob/exporters/prometheus/v0.61.0/exporters/prometheus/exporter.go#L523) whether the type Sum is monotonic or not. If it is not - then it is Gauge value.\n\nI have created a local patch with one change in `handler` `Counter` method:\n```\nfunc (m MetricsHandler) Counter(name string) client.MetricsCounter {\n\tc, err := m.meter.Int64Counter(name)\n        ...\n}\n```\n\nThen it works as expected.\n\n## Specifications\n\n  - Version: Golang version 1.25.5, go.temporal.io/sdk v1.38.0, go.temporal.io/sdk/contrib/opentelemetry v0.6.0\n  - Platform: macOS Sequoia Version 15.7.2\n","closedAt":null,"comments":[],"createdAt":"2026-01-07T12:26:43Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDg2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":2140,"reactionGroups":[],"state":"OPEN","title":"OpenTelemetry incorrect metric type for Counter","updatedAt":"2026-01-07T12:26:43Z","url":"https://github.com/temporalio/sdk-go/issues/2140"}
