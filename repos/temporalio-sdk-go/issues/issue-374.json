{"assignees":[{"id":"MDQ6VXNlcjUxNzY4Mw==","login":"Sushisource","name":"Spencer Judge","databaseId":0},{"id":"MDQ6VXNlcjEzMTE2OTQ=","login":"vitarb","name":"Vitali","databaseId":0}],"author":{"id":"MDQ6VXNlcjY4ODU5","is_bot":false,"login":"MrSaints","name":"Ian L."},"body":"## Expected Behavior\r\n\r\nIf a workflow executes a `SideEffect` with versioning, and we then query that newly launched workflow, it should return successfully instead of timing out due to a workflow panic.\r\n\r\nBased on my reading of https://docs.temporal.io/docs/go-versioning/, this should be an acceptable use-case, e.g. introducing a unique ID for use in an activity which previously did not take any unique ID.\r\n\r\n## Actual Behavior\r\n\r\nThe query fails even though the workflow succeeds. This affects a newly launched workflow.\r\n\r\nServer logs:\r\n\r\n```\r\ntemporal                | {\"level\":\"error\",\"ts\":\"2021-02-28T17:03:09.620Z\",\"msg\":\"query directly though matching on non-sticky failed\",\"service\":\"history\",\"shard-id\":1,\"address\":\"172.19.0.3:7234\",\"shard-item\":\"0xc00014f480\",\"component\":\"history-engine\",\"wf-namespace\":\"default\",\"wf-id\":\"hello_world_workflowID\",\"wf-run-id\":\"4c44131e-5a12-406f-9998-c4e7a5202546\",\"wf-query-type\":\"test-query\",\"error\":\"context canceled\",\"logging-call-at\":\"historyEngine.go:981\",\"stacktrace\":\"go.temporal.io/server/common/log/loggerimpl.(*loggerImpl).Error\\n\\t/temporal/common/log/loggerimpl/logger.go:138\\ngo.temporal.io/server/service/history.(*historyEngineImpl).queryDirectlyThroughMatching\\n\\t/temporal/service/history/historyEngine.go:981\\ngo.temporal.io/server/service/history.(*historyEngineImpl).QueryWorkflow\\n\\t/temporal/service/history/historyEngine.go:830\\ngo.temporal.io/server/service/history.(*Handler).QueryWorkflow\\n\\t/temporal/service/history/handler.go:1165\\ngo.temporal.io/server/api/historyservice/v1._HistoryService_QueryWorkflow_Handler.func1\\n\\t/temporal/api/historyservice/v1/service.pb.go:1401\\ngo.temporal.io/server/common/rpc.ServiceErrorInterceptor\\n\\t/temporal/common/rpc/grpc.go:100\\ngo.temporal.io/server/api/historyservice/v1._HistoryService_QueryWorkflow_Handler\\n\\t/temporal/api/historyservice/v1/service.pb.go:1403\\ngoogle.golang.org/grpc.(*Server).processUnaryRPC\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.34.0/server.go:1210\\ngoogle.golang.org/grpc.(*Server).handleStream\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.34.0/server.go:1533\\ngoogle.golang.org/grpc.(*Server).serveStreams.func1.2\\n\\t/go/pkg/mod/google.golang.org/grpc@v1.34.0/server.go:871\"}\r\n```\r\n\r\nWorker logs:\r\n\r\n```\r\n2021/02/28 16:54:37 INFO  HelloWorld workflow completed. Namespace default TaskQueue hello-world WorkerID 46087@<omitted>@ WorkflowType Workflow WorkflowID hello_world_workflowID RunID bfcecbbe-04c9-4eef-b056-69ad5cf1e575 Attempt 1 result Hello Temporal!\r\n2021/02/28 16:54:37 ERROR Workflow panic Namespace default TaskQueue hello-world WorkerID 46087@<omitted>@ WorkflowType Workflow WorkflowID hello_world_workflowID RunID bfcecbbe-04c9-4eef-b056-69ad5cf1e575 Attempt 1 Error lookup failed for scheduledEventID to activityID: scheduleEventID: 8, activityID: 8 StackTrace process event for hello-world [panic]:\r\ngo.temporal.io/sdk/internal.panicIllegalState(...)\r\n    <omitted>/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_decision_state_machine.go:393\r\ngo.temporal.io/sdk/internal.(*commandsHelper).handleActivityTaskScheduled(0xc000487ec0, 0x13eff00, 0x1, 0x8)\r\n    <omitted>/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_decision_state_machine.go:878 +0x165\r\ngo.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).ProcessEvent(0xc0004cf9c0, 0xc0001b0a80, 0x1, 0x0, 0x0)\r\n    <omitted>/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_event_handlers.go:800 +0x41e\r\ngo.temporal.io/sdk/internal.(*workflowExecutionContextImpl).ProcessWorkflowTask(0xc0004c86c0, 0xc0001cb9b0, 0x1437360, 0xc0003ae8c0, 0xc0004c86c0, 0x0)\r\n    <omitted>/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_task_handlers.go:876 +0x73c\r\ngo.temporal.io/sdk/internal.(*workflowTaskHandlerImpl).ProcessWorkflowTask(0xc000458210, 0xc0001cb9b0, 0xc0004d6e40, 0x0, 0x0, 0x0, 0x0)\r\n    <omitted>/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_task_handlers.go:727 +0x739\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).processWorkflowTask(0xc00043e340, 0xc0001cb9b0, 0x0, 0x0)\r\n    <omitted>/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_task_pollers.go:288 +0x4ae\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).ProcessTask(0xc00043e340, 0xce4dc0, 0xc0001cb9b0, 0xf393a0, 0xc000403bc0)\r\n    <omitted>/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_task_pollers.go:259 +0x85\r\ngo.temporal.io/sdk/internal.(*baseWorker).processTask(0xc000480000, 0xce4980, 0xc0001ac710)\r\n    <omitted>/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_worker_base.go:343 +0xba\r\ncreated by go.temporal.io/sdk/internal.(*baseWorker).runTaskDispatcher\r\n    <omitted>/pkg/mod/go.temporal.io/sdk@v1.5.0/internal/internal_worker_base.go:270 +0xff\r\n2021/02/28 16:54:37 WARN  Failed to process workflow task. Namespace default TaskQueue hello-world WorkerID 46087@<omitted>@ WorkflowType Workflow WorkflowID hello_world_workflowID RunID bfcecbbe-04c9-4eef-b056-69ad5cf1e575 Attempt 1 Error lookup failed for scheduledEventID to activityID: scheduleEventID: 8, activityID: 8\r\n2021/02/28 16:54:37 INFO  Task processing failed with error Namespace default TaskQueue hello-world WorkerID 46087@<omitted>@ WorkerType WorkflowWorker Error Workflow executionsRow not found.  WorkflowId: hello-world, RunId: d9acd11a-3fdf-4afd-a79d-e9b78a81d7cb\r\n```\r\n\r\nFor what it is worth, the workflow succeeds if running the side-effect WITHOUT versioning. And the workflow succeeds if running the version marker WITHOUT the side-effect. But together, they fail.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nI've modified the `helloworld` sample to reproduce the problem: https://github.com/MrSaints/samples-go/commit/8bd6f2fd890501337cb381021da10bc94be0e454\r\n\r\nYou should be able to trigger it with:\r\n\r\n- `go run helloworld/worker/main.go`\r\n- `go run helloworld/starter/main.go`\r\n\r\n## Specifications\r\n\r\n  - Version: 1.5.0 (also affects 1.4.1)\r\n  - Platform: Linux\r\n","closedAt":"2021-03-11T17:26:18Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDc5NDYxNDU2NQ==","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"@MrSaints Thanks for the really great bug report! I have created a unit test that repros this and I'm fixing it now.","createdAt":"2021-03-09T23:43:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-go/issues/374#issuecomment-794614565","viewerDidAuthor":false}],"createdAt":"2021-02-28T17:14:35Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":374,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":4}}],"state":"CLOSED","title":"Workflow panic when querying a workflow using a side effect inside a versioned block","updatedAt":"2021-03-11T17:26:18Z","url":"https://github.com/temporalio/sdk-go/issues/374"}
