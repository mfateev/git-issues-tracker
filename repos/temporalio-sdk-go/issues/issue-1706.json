{"assignees":[],"author":{"id":"MDQ6VXNlcjIyNzg5ODUx","is_bot":false,"login":"ndtretyak","name":"Nikolay Tretyak"},"body":"## Expected Behavior\r\n`ProcessWorkflowTask` should stop\r\n\r\n## Actual Behavior\r\nA WorkflowTask started by a stopped worker continues to send heartbeats, blocking further workflow execution.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nThe following code is based on the server's per-namespace worker [implementation](https://github.com/temporalio/temporal/blob/main/service/worker/pernamespaceworker.go). It starts the worker, stops it, and then starts it again using the same client.\r\n\r\nThe workflow executes a series of local activities, similar to the server's Scheduler workflow.\r\n\r\nIf the worker is stopped during the execution of a local activity, we will see a \"canceled\" error in the logs:\r\n```\r\n2024/11/08 10:15:49 ERROR Activity failed\r\n```\r\n\r\nHowever, this error is ignored by the workflow, which will continue processing the current WorkflowTask and will schedule another local activity. This activity will not be executed since the worker is stopped. `ProcessWorkflowTask` will remain active, though, and will keep sending heartbeats until either a network timeout occurs or the history size limit is reached.\r\n\r\nHeartbeats can be seen in the logs:\r\n```\r\n2024/11/08 10:16:28 DEBUG Force RespondWorkflowTaskCompleted\r\n```\r\n\r\n```go\r\npackage main\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"fmt\"\r\n\t\"time\"\r\n\r\n\t\"go.temporal.io/api/enums/v1\"\r\n\t\"go.temporal.io/sdk/client\"\r\n\t\"go.temporal.io/sdk/worker\"\r\n\t\"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\nconst (\r\n\thostPort   = \"localhost:7233\"\r\n\tnamespace  = \"default\"\r\n\ttaskQueue  = \"default\"\r\n\tworkflowID = \"test-workflow\"\r\n\r\n\tsleepDuration = 100 * time.Millisecond\r\n\tnActivities   = 10\r\n)\r\n\r\ntype Worker struct {\r\n\tparentClient client.Client\r\n\tclient       client.Client\r\n\tworker       worker.Worker\r\n}\r\n\r\nfunc NewWorker(c client.Client) *Worker {\r\n\treturn &Worker{parentClient: c}\r\n}\r\n\r\nfunc (w *Worker) Start() error {\r\n\tc, err := newTemporalClientFromExisting(w.parentClient)\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"create client: %w\", err)\r\n\t}\r\n\ttw := newTemporalWorker(c)\r\n\terr = tw.Start()\r\n\tif err != nil {\r\n\t\treturn fmt.Errorf(\"start worker: %w\", err)\r\n\t}\r\n\tw.client = c\r\n\tw.worker = tw\r\n\treturn nil\r\n}\r\n\r\nfunc (w *Worker) Stop() {\r\n\tw.worker.Stop()\r\n\tw.client.Close()\r\n}\r\n\r\nfunc newTemporalClient() (client.Client, error) {\r\n\treturn client.Dial(client.Options{\r\n\t\tHostPort:  hostPort,\r\n\t\tNamespace: namespace,\r\n\t})\r\n}\r\n\r\nfunc newTemporalClientFromExisting(c client.Client) (client.Client, error) {\r\n\treturn client.NewClientFromExisting(c, client.Options{})\r\n}\r\n\r\nfunc newTemporalWorker(c client.Client) worker.Worker {\r\n\tw := worker.New(c, taskQueue, worker.Options{})\r\n\tw.RegisterWorkflow(Workflow)\r\n\tw.RegisterActivity(Activity)\r\n\treturn w\r\n}\r\n\r\nfunc Workflow(ctx workflow.Context) error {\r\n\tfor {\r\n\t\tfor range nActivities {\r\n\t\t\tctx := workflow.WithLocalActivityOptions(ctx, workflow.LocalActivityOptions{\r\n\t\t\t\tStartToCloseTimeout: time.Minute,\r\n\t\t\t})\r\n\t\t\terr := workflow.ExecuteLocalActivity(ctx, Activity).Get(ctx, nil)\r\n\t\t\tif err != nil {\r\n\t\t\t\tworkflow.GetLogger(ctx).Error(\"Activity failed.\", \"Error\", err)\r\n\t\t\t}\r\n\t\t}\r\n\t\tworkflow.Sleep(ctx, sleepDuration)\r\n\t\tif workflow.GetInfo(ctx).GetContinueAsNewSuggested() {\r\n\t\t\treturn workflow.NewContinueAsNewError(ctx, Workflow)\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunc Activity(ctx context.Context) error {\r\n\ttime.Sleep(sleepDuration)\r\n\treturn ctx.Err()\r\n}\r\n\r\nfunc startWorkflow(ctx context.Context, c client.Client) error {\r\n\topts := client.StartWorkflowOptions{\r\n\t\tID:                    workflowID,\r\n\t\tTaskQueue:             taskQueue,\r\n\t\tWorkflowIDReusePolicy: enums.WORKFLOW_ID_REUSE_POLICY_TERMINATE_IF_RUNNING,\r\n\t}\r\n\t_, err := c.ExecuteWorkflow(ctx, opts, Workflow)\r\n\treturn err\r\n}\r\n\r\nfunc main() {\r\n\tctx := context.Background()\r\n\tc, err := newTemporalClient()\r\n\tif err != nil {\r\n\t\tfmt.Printf(\"Error creating client: %v\\n\", err)\r\n\t}\r\n\r\n\terr = startWorkflow(ctx, c)\r\n\tif err != nil {\r\n\t\tfmt.Printf(\"Error starting workflow: %v\\n\", err)\r\n\t\treturn\r\n\t}\r\n\tfmt.Println(\"Workflow started.\")\r\n\r\n\tw := NewWorker(c)\r\n\tfor {\r\n\t\terr = w.Start()\r\n\t\tif err != nil {\r\n\t\t\tfmt.Println(\"Error starting worker:\", err)\r\n\t\t\treturn\r\n\t\t}\r\n\t\ttime.Sleep(33 * sleepDuration)\r\n\t\tw.Stop()\r\n\t}\r\n}\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version:\r\n  - Platform:\r\n","closedAt":"2025-05-30T20:35:43Z","comments":[{"id":"IC_kwDODN1w686TQlMV","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I am not sure we want workflow heartbeating to stop just because poller stopped. This is used by long-running local activities. Just because poller stopped doesn't mean we want to interrupt existing tasks (which can include local activity retries if the policy wants it). A worker stopping still allows all workflow and activity tasks to complete.\r\n\r\nIf the local activity worker is already stopped, then yes there may be some other issue concerning not properly waiting for local activity to complete on worker shutdown.","createdAt":"2024-11-12T13:56:27Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1706#issuecomment-2470597397","viewerDidAuthor":false},{"id":"IC_kwDODN1w686TRQrR","author":{"login":"ndtretyak"},"authorAssociation":"CONTRIBUTOR","body":"As I understand, there are at least three ways for the local activity task to \"hang forever\"\r\n\r\n1. If the task is created after `laTunnel` (which uses the same stop channel as the worker) has already closed, then `sendTask` will return false, leaving the local activity task unstarted.\r\n\r\nhttps://github.com/temporalio/sdk-go/blob/9d74a905fc3602dfa9dddf114087c43a1b64e6b8/internal/internal_task_handlers.go#L1366\r\n\r\n2. If the task is created before `laTunnel` closes, but after the local activity worker has already stopped, the task is sent to `taskCh`, but no one is listening. Additionally, this `select` might choose to send even if `stopCh` has already closed.\r\n\r\nhttps://github.com/temporalio/sdk-go/blob/9d74a905fc3602dfa9dddf114087c43a1b64e6b8/internal/internal_task_pollers.go#L220-L227\r\n\r\n3. If the task is polled by the local activity worker just before `worker.Stop()` is called, it will be dropped.\r\n\r\nhttps://github.com/temporalio/sdk-go/blob/9d74a905fc3602dfa9dddf114087c43a1b64e6b8/internal/internal_task_pollers.go#L606-L609\r\n\r\nSince the local activity worker is stopped first, I thought it would be fine to simply stop sending heartbeats.","createdAt":"2024-11-12T15:03:21Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1706#issuecomment-2470775505","viewerDidAuthor":false},{"id":"IC_kwDODN1w686TRbba","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Hrmm, I suspect we may be prematurely stopping the local activity worker before its tasks are done. Let me confer with team, but I agree if there's no need to continue to do workflow task heartbeating if the local activity is not running.","createdAt":"2024-11-12T15:20:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1706#issuecomment-2470819546","viewerDidAuthor":false},{"id":"IC_kwDODN1w686X4HKm","author":{"login":"ndtretyak"},"authorAssociation":"CONTRIBUTOR","body":"@cretz Hi! Any updates on this issue?\r\n\r\nI wanted to highlight that it affects server's scheduler because of [this code section](https://github.com/temporalio/temporal/blob/436c3437771cf9832e99fb6f9569d005b69f93e7/service/worker/scheduler/workflow.go#L1241-L1262).\r\n\r\nHere, the local activity `StartWorkflow` is executed in a loop, and errors are only logged. If the error is \"context canceled\" (due to the worker being stopped) and there are still more items in `allStarts`, another local activity will be scheduled, essentially blocking the workflow because there are no local activity pollers available anymore.\r\n\r\n ","createdAt":"2024-12-17T10:22:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1706#issuecomment-2548069030","viewerDidAuthor":false},{"id":"IC_kwDODN1w686X7oXe","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Sorry, the primary maintainers of the Go SDK have limited availability this time of year. I will see if I can increase the priority of this issue.","createdAt":"2024-12-17T16:42:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1706#issuecomment-2548991454","viewerDidAuthor":false},{"id":"IC_kwDODN1w686ZYiEM","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Note, we will be looking into and tackling this hopefully soon. We will update when we have more details.","createdAt":"2025-01-06T15:27:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":3}}],"url":"https://github.com/temporalio/sdk-go/issues/1706#issuecomment-2573345036","viewerDidAuthor":false},{"id":"IC_kwDODN1w686kpG53","author":{"login":"yuandrew"},"authorAssociation":"MEMBER","body":"Looks like #1875 solved a different issue with graceful shutdown, WorkerStopTimeout, looking into a fix for this heartbeating issue","createdAt":"2025-03-28T19:24:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1706#issuecomment-2762239607","viewerDidAuthor":false}],"createdAt":"2024-11-08T09:38:53Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1706,"reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"state":"CLOSED","title":"ProcessWorkflowTask is not stopped on worker.Stop()","updatedAt":"2025-05-30T20:35:43Z","url":"https://github.com/temporalio/sdk-go/issues/1706"}
