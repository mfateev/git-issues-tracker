{"assignees":[],"author":{"id":"MDQ6VXNlcjgxOTE0MTQy","is_bot":false,"login":"gingercat-maki","name":"maki"},"body":"## Expected Behavior\r\n\r\nWorkflowcheck should find the deadlock here. But it doesn't. \r\nNon-deterministic is not found either. (I personally think this will not result in a non-deterministic error since historyMatch process does not match things not recorded in the command/event. And I think these sleep or print will not go into the command/event.\r\n\r\n```\r\n\r\n\t// try some bad thing here\r\n\tlogger.Debug(\"before sleep\")\r\n\t// time.Sleep(1 * time.Microsecond)\r\n\ttime.Sleep(2 * time.Second)\r\n\tnow := time.Now()\r\n\tfmt.Printf(\"Now: %v\\n\", now)\r\n\tlogger.Debug(\"after sleep\")\r\n\r\n```\r\n\r\n\r\n## Actual Behavior\r\n\r\nwhen time is 1*ms, everything goes well. The flow is successfully completed. \r\nwhen time is 1s, deadlock happens, and the flow failed.\r\nBut workflow checks don't show errors here.\r\n\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1.\r\n  1.\r\n  1.\r\n\r\n## Specifications\r\n\r\n  - Version: \r\n  - │   go.temporal.io/api v1.7.1-0.20220223032354-6e6fe738916a // indirect\r\n│   go.temporal.io/sdk v1.14.0 // indirect\r\n  - Platform: macos\r\n","closedAt":"2022-05-25T01:06:31Z","comments":[{"id":"IC_kwDODN1w685DtFyI","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Can you give the full code file and the full `workflowcheck` command you are running? We even have tests in `workflowcheck` that confirm things like `time.Sleep` and `fmt.Printf` are both non-deterministic.","createdAt":"2022-05-24T13:00:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/814#issuecomment-1135893640","viewerDidAuthor":false},{"id":"IC_kwDODN1w685DtHjg","author":{"login":"gingercat-maki"},"authorAssociation":"NONE","body":"https://github.com/gingercat-maki/temporal-demo ","createdAt":"2022-05-24T13:07:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/814#issuecomment-1135900896","viewerDidAuthor":false},{"id":"IC_kwDODN1w685DtYEl","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"This works for me. You have to make sure that you check the package where you are calling `RegisterWorkflow`. This entrypoint is the only way that the static analyzer knows your function is a workflow and not just some other code (we can't just assume every function signature containing `workflow.Context` as the first parameter is a workflow).\r\n\r\nWhen I run:\r\n\r\n    workflowcheck ./app/worker\r\n\r\nI get:\r\n\r\n```\r\ntmp/workflowcheck-test/temporal-demo/app/worker/main.go:24:2: approval-workflow-demo-go.ExpenseApprovalWorkflow is non-deterministic, reason: calls non-deterministic function time.Sleep\r\n  time.Sleep is non-deterministic, reason: declared non-deterministic\r\n/tmp/workflowcheck-test/temporal-demo/app/worker/main.go:24:2: approval-workflow-demo-go.ExpenseApprovalWorkflow is non-deterministic, reason: calls non-deterministic function time.Now\r\n  time.Now is non-deterministic, reason: declared non-deterministic\r\n/tmp/workflowcheck-test/temporal-demo/app/worker/main.go:24:2: approval-workflow-demo-go.ExpenseApprovalWorkflow is non-deterministic, reason: calls non-deterministic function fmt.Printf\r\n  fmt.Printf is non-deterministic, reason: accesses non-deterministic var os.Stdout\r\n/tmp/workflowcheck-test/temporal-demo/app/worker/main.go:24:2: approval-workflow-demo-go.ExpenseApprovalWorkflow is non-deterministic, reason: calls non-deterministic function github.com/luci/go-render/render.Render\r\n  github.com/luci/go-render/render.Render is non-deterministic, reason: calls non-deterministic function (*github.com/luci/go-render/render.traverseState).render\r\n    (*github.com/luci/go-render/render.traverseState).render is non-deterministic, reason: calls non-deterministic function (reflect.Value).MapIndex\r\n      (reflect.Value).MapIndex is non-deterministic, reason: calls non-deterministic function (reflect.Value).assignTo\r\n        (reflect.Value).assignTo is non-deterministic, reason: calls non-deterministic function reflect.makeMethodValue\r\n          reflect.makeMethodValue is non-deterministic, reason: calls non-deterministic function reflect.funcLayout\r\n            reflect.funcLayout is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n              (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n                (*sync.Map).dirtyLocked is non-deterministic, reason: iterates over map\r\n        (reflect.Value).assignTo is non-deterministic, reason: calls non-deterministic function reflect.valueInterface\r\n          reflect.valueInterface is non-deterministic, reason: calls non-deterministic function reflect.makeMethodValue\r\n            reflect.makeMethodValue is non-deterministic, reason: calls non-deterministic function reflect.funcLayout\r\n    (*github.com/luci/go-render/render.traverseState).render is non-deterministic, reason: calls non-deterministic function github.com/luci/go-render/render.writeType\r\n      github.com/luci/go-render/render.writeType is non-deterministic, reason: calls non-deterministic function reflect.SliceOf\r\n        reflect.SliceOf is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n          (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n        reflect.SliceOf is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n          (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n      github.com/luci/go-render/render.writeType is non-deterministic, reason: calls non-deterministic function reflect.MapOf\r\n        reflect.MapOf is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n          (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n        reflect.MapOf is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n          (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n        reflect.MapOf is non-deterministic, reason: calls non-deterministic function reflect.bucketOf\r\n          reflect.bucketOf is non-deterministic, reason: calls non-deterministic function reflect.PointerTo\r\n            reflect.PointerTo is non-deterministic, reason: calls non-deterministic function (*reflect.rtype).ptrTo\r\n              (*reflect.rtype).ptrTo is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n                (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n              (*reflect.rtype).ptrTo is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n                (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n/tmp/workflowcheck-test/temporal-demo/app/worker/main.go:24:2: approval-workflow-demo-go.ExpenseApprovalWorkflow is non-deterministic, reason: calls non-deterministic function go.temporal.io/sdk/workflow.AwaitWithTimeout\r\n  go.temporal.io/sdk/workflow.AwaitWithTimeout is non-deterministic, reason: calls non-deterministic function go.temporal.io/sdk/internal.AwaitWithTimeout\r\n    go.temporal.io/sdk/internal.AwaitWithTimeout is non-deterministic, reason: calls non-deterministic function (*go.temporal.io/sdk/internal.coroutineState).yield\r\n      (*go.temporal.io/sdk/internal.coroutineState).yield is non-deterministic, reason: sends to channel\r\n      (*go.temporal.io/sdk/internal.coroutineState).yield is non-deterministic, reason: calls non-deterministic function (*go.temporal.io/sdk/internal.coroutineState).initialYield\r\n        (*go.temporal.io/sdk/internal.coroutineState).initialYield is non-deterministic, reason: receives from channel\r\n/tmp/workflowcheck-test/temporal-demo/app/worker/main.go:24:2: approval-workflow-demo-go.ExpenseApprovalWorkflow is non-deterministic, reason: calls non-deterministic function approval-workflow-demo-go.createSubmitSelector\r\n  approval-workflow-demo-go.createSubmitSelector is non-deterministic, reason: calls non-deterministic function github.com/luci/go-render/render.Render\r\n    github.com/luci/go-render/render.Render is non-deterministic, reason: calls non-deterministic function (*github.com/luci/go-render/render.traverseState).render\r\n      (*github.com/luci/go-render/render.traverseState).render is non-deterministic, reason: calls non-deterministic function (reflect.Value).MapIndex\r\n        (reflect.Value).MapIndex is non-deterministic, reason: calls non-deterministic function (reflect.Value).assignTo\r\n          (reflect.Value).assignTo is non-deterministic, reason: calls non-deterministic function reflect.makeMethodValue\r\n            reflect.makeMethodValue is non-deterministic, reason: calls non-deterministic function reflect.funcLayout\r\n              reflect.funcLayout is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n                (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n                  (*sync.Map).dirtyLocked is non-deterministic, reason: iterates over map\r\n          (reflect.Value).assignTo is non-deterministic, reason: calls non-deterministic function reflect.valueInterface\r\n            reflect.valueInterface is non-deterministic, reason: calls non-deterministic function reflect.makeMethodValue\r\n              reflect.makeMethodValue is non-deterministic, reason: calls non-deterministic function reflect.funcLayout\r\n      (*github.com/luci/go-render/render.traverseState).render is non-deterministic, reason: calls non-deterministic function github.com/luci/go-render/render.writeType\r\n        github.com/luci/go-render/render.writeType is non-deterministic, reason: calls non-deterministic function reflect.SliceOf\r\n          reflect.SliceOf is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n            (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n          reflect.SliceOf is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n            (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n        github.com/luci/go-render/render.writeType is non-deterministic, reason: calls non-deterministic function reflect.MapOf\r\n          reflect.MapOf is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n            (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n          reflect.MapOf is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n            (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n          reflect.MapOf is non-deterministic, reason: calls non-deterministic function reflect.bucketOf\r\n            reflect.bucketOf is non-deterministic, reason: calls non-deterministic function reflect.PointerTo\r\n              reflect.PointerTo is non-deterministic, reason: calls non-deterministic function (*reflect.rtype).ptrTo\r\n                (*reflect.rtype).ptrTo is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n                  (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n                (*reflect.rtype).ptrTo is non-deterministic, reason: calls non-deterministic function (*sync.Map).LoadOrStore\r\n                  (*sync.Map).LoadOrStore is non-deterministic, reason: calls non-deterministic function (*sync.Map).dirtyLocked\r\n```","createdAt":"2022-05-24T14:00:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/814#issuecomment-1135968549","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Dtm2x","author":{"login":"gingercat-maki"},"authorAssociation":"NONE","body":"I see. I just  workflowcheck workflow.go  RegisterWorkflow as the entry point for the check is a good guide for me.","createdAt":"2022-05-24T14:49:11Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/814#issuecomment-1136029105","viewerDidAuthor":false},{"id":"IC_kwDODN1w685DtnNT","author":{"login":"gingercat-maki"},"authorAssociation":"NONE","body":"Another question here is, the workers and workflows actually run to completion without errors, and why is that?","createdAt":"2022-05-24T14:50:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/814#issuecomment-1136030547","viewerDidAuthor":false},{"id":"IC_kwDODN1w685Dtn6t","author":{"login":"gingercat-maki"},"authorAssociation":"NONE","body":"I personally don't think these print or sleep should cause non-deterministic errors. They are actually not in events and not seen by the workflow history.\r\n","createdAt":"2022-05-24T14:52:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/814#issuecomment-1136033453","viewerDidAuthor":false},{"id":"IC_kwDODN1w685DtptM","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Another question here is, the workers and workflows actually run to completion without errors, and why is that?\r\n\r\nBecause there are no errors during run I am guessing. We can't tell you use non-deterministic code at runtime, we can only check deadlocks.\r\n\r\n> I personally don't think these print or sleep should cause non-deterministic errors. They are actually not in events and not seen by the workflow history.\r\n\r\nMaybe \"non-deterministic\" may not be the right phrasing, maybe \"outside of the Temporal-controlled runtime\". But it is very important for Temporal that nothing use Golang goroutines or the Go timing/sleeping system. Workflow code is expected to run until all coroutines are yielded in a couple of milliseconds. This is important to worker scaling and replaying. See https://docs.temporal.io/application-development-guide#workflow-logic-requirements.","createdAt":"2022-05-24T14:58:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/814#issuecomment-1136040780","viewerDidAuthor":false},{"id":"IC_kwDODN1w685DvuK-","author":{"login":"gingercat-maki"},"authorAssociation":"NONE","body":"Yeah, I know. I just read the source code of go-SDK and find the logic of temporal non-deterministic error which seems to be a different logic. But I think \"outside of the Temporal-controlled runtime\" really causes less confusion and really helpful.","createdAt":"2022-05-25T01:06:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/814#issuecomment-1136583358","viewerDidAuthor":false}],"createdAt":"2022-05-24T12:55:39Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":814,"reactionGroups":[],"state":"CLOSED","title":"workflowcheck not working","updatedAt":"2022-05-25T01:06:31Z","url":"https://github.com/temporalio/sdk-go/issues/814"}
