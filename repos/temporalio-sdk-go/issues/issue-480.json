{"assignees":[{"id":"MDQ6VXNlcjEzMTE2OTQ=","login":"vitarb","name":"Vitali","databaseId":0}],"author":{"id":"MDQ6VXNlcjk5MzIxNQ==","is_bot":false,"login":"sev3ryn","name":"Severyn Lisovskyi"},"body":"## Expected Behavior\r\n```\r\n2021/06/22 10:40:46 INFO  workflow started \r\n2021/06/22 10:40:46 INFO  start-id id=0\r\n2021/06/22 10:40:51 WARN  got interupt! id=5\r\n2021/06/22 10:40:51 INFO continued activity id=5\r\n2021/06/22 10:40:51 INFO  Stopped Worker Namespace default \r\n2021/06/22 10:40:51 INFO  Started Worker Namespace default \r\n2021/06/22 10:40:52 INFO  start-id id=5\r\n2021/06/22 10:40:59 INFO workflow finished\r\n```\r\n\r\n## Actual Behavior\r\n```\r\n2021/06/22 10:40:46 INFO  Started Worker Namespace default TaskQueue split-merge WorkerID 5263@m1.local@\r\n2021/06/22 10:40:46 INFO  workflow started Namespace default TaskQueue split-merge WorkerID 5263@m1.local@ WorkflowType SampleWorkflow WorkflowID bacaf3a6-c2e8-4e3f-8da8-18b138c877a3 RunID 4e8e62dc-542c-4c08-8ec3-72c07549d556 Attempt 1\r\n2021/06/22 10:40:46 DEBUG ExecuteActivity Namespace default TaskQueue split-merge WorkerID 5263@m1.local@ WorkflowType SampleWorkflow WorkflowID bacaf3a6-c2e8-4e3f-8da8-18b138c877a3 RunID 4e8e62dc-542c-4c08-8ec3-72c07549d556 Attempt 1 ActivityID 5 ActivityType SampleActivity\r\n2021/06/22 10:40:46 INFO  start id Namespace default TaskQueue split-merge WorkerID 5263@m1.local@ ActivityID 5 ActivityType SampleActivity Attempt 1 WorkflowType SampleWorkflow WorkflowID bacaf3a6-c2e8-4e3f-8da8-18b138c877a3 RunID 4e8e62dc-542c-4c08-8ec3-72c07549d556 id 0\r\n2021/06/22 10:40:51 WARN  got interupt! Namespace default TaskQueue split-merge WorkerID 5263@m1.local@ ActivityID 5 ActivityType SampleActivity Attempt 1 WorkflowType SampleWorkflow WorkflowID bacaf3a6-c2e8-4e3f-8da8-18b138c877a3 RunID 4e8e62dc-542c-4c08-8ec3-72c07549d556 id 5\r\n2021/06/22 10:40:51 INFO  Task processing failed with error Namespace default TaskQueue split-merge WorkerID 5263@m1.local@ WorkerType ActivityWorker Error worker stopping\r\n2021/06/22 10:40:51 INFO  Stopped Worker Namespace default TaskQueue split-merge WorkerID 5263@m1.local@\r\n2021/06/22 10:40:51 INFO  Started Worker Namespace default TaskQueue split-merge WorkerID 5263@m1.local@\r\n```\r\n## Steps to Reproduce the Problem\r\n\r\n  1. See and run following [code](https://pastebin.com/1nrQ8YDN). History of such workflow can be found [here](https://pastebin.com/4jZfGs6f)\r\n\r\n## Specifications\r\n\r\n  - Version: \r\n  SDK: go.temporal.io/sdk v1.7.0\r\n  Temporal: v1.9.0\r\n   DB: cassandra 3.11.9\r\n   \r\n  - Platform:\r\n   linux/amd64","closedAt":"2021-10-18T20:07:18Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg2NjI3NzkyMA==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"activity heartbeat details / progress is not stored in workflow history, but within workflow itself\r\n\r\ndoes `tctl --namespace <namespace> workflow describe -w <workflow ID>` shows the activity heartbeat details?","createdAt":"2021-06-22T19:38:11Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/480#issuecomment-866277920","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg2NjYxMzE5Nw==","author":{"login":"sev3ryn"},"authorAssociation":"NONE","body":"I'm not expecting heartbeat to be stored in history. Here I mean - when worker is in graceful shutdown mode (after executing worker.Stop but before exceeding WorkerStopTimeout) all the activity results that are returned in the same time are not stored anywhere, so they are not noticed by workflow execution. Workflow execution continues to expect results from activity that actually already properly ended.\r\n\r\nHere is the the output of tctl command - lastHeartbeatTime is not updating. This workflow will fail later because of StartToClose - but at the same time it will not execute anything\r\n\r\n<details><summary>Full command output</summary>\r\n<p>\r\n\r\n```\r\n{\r\n  \"executionConfig\": {\r\n    \"taskQueue\": {\r\n      \"name\": \"split-merge\",\r\n      \"kind\": \"Normal\"\r\n    },\r\n    \"workflowExecutionTimeout\": \"0s\",\r\n    \"workflowRunTimeout\": \"0s\",\r\n    \"defaultWorkflowTaskTimeout\": \"10s\"\r\n  },\r\n  \"workflowExecutionInfo\": {\r\n    \"execution\": {\r\n      \"workflowId\": \"1bfcba91-2bed-4677-84a7-51589037e1f6\",\r\n      \"runId\": \"d6f4f0b4-95f0-4e71-a157-0650e9c07917\"\r\n    },\r\n    \"type\": {\r\n      \"name\": \"SampleWorkflow\"\r\n    },\r\n    \"startTime\": \"2021-06-23T06:52:15.445305804Z\",\r\n    \"status\": \"Running\",\r\n    \"historyLength\": \"5\",\r\n    \"memo\": {\r\n\r\n    },\r\n    \"searchAttributes\": {\r\n      \"indexedFields\": {\r\n        \"BinaryChecksums\": \"[\\\"905b1840ac923516d00b15ed1fae63a7\\\"]\"\r\n      }\r\n    },\r\n    \"autoResetPoints\": {\r\n      \"points\": [\r\n        {\r\n          \"binaryChecksum\": \"905b1840ac923516d00b15ed1fae63a7\",\r\n          \"runId\": \"d6f4f0b4-95f0-4e71-a157-0650e9c07917\",\r\n          \"firstWorkflowTaskCompletedId\": \"4\",\r\n          \"createTime\": \"2021-06-23T06:52:15.773711707Z\",\r\n          \"resettable\": true\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"pendingActivities\": [\r\n    {\r\n      \"activityId\": \"5\",\r\n      \"activityType\": {\r\n        \"name\": \"SampleActivity\"\r\n      },\r\n      \"state\": \"Started\",\r\n      \"lastHeartbeatTime\": \"2021-06-23T06:52:15.789476631Z\",\r\n      \"lastStartedTime\": \"2021-06-23T06:52:15.789476631Z\",\r\n      \"attempt\": 1,\r\n      \"expirationTime\": \"0001-01-01T00:00:00Z\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n</p>\r\n</details>\r\n","createdAt":"2021-06-23T07:50:07Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/480#issuecomment-866613197","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg2NjY0MTQ2Nw==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"so let me see if i get the issue right:\r\nactivity heartbeats / completions during the worker grace shutdown period do not correctly propagated to server?","createdAt":"2021-06-23T08:31:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/480#issuecomment-866641467","viewerDidAuthor":false},{"id":"MDEyOklzc3VlQ29tbWVudDg2NjY0MjA0NA==","author":{"login":"wxing1292"},"authorAssociation":"CONTRIBUTOR","body":"@vitarb can you take a look?","createdAt":"2021-06-23T08:32:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/480#issuecomment-866642044","viewerDidAuthor":false},{"id":"IC_kwDODN1w6842tdTN","author":{"login":"changwuf31"},"authorAssociation":"NONE","body":"Hi, any ETA or any update on this issue ?\r\n\r\nMany thanks","createdAt":"2021-09-13T06:39:02Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/480#issuecomment-917886157","viewerDidAuthor":false},{"id":"IC_kwDODN1w6842vzIi","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"Sorry all, looks like this one slipped off the radar.\r\n\r\nIn any case, I can confirm that this looks like an SDK bug and does repro. The worker should properly complete the activity in this case when it receives the interrupt. We'll take a look at this soon.","createdAt":"2021-09-13T19:16:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/480#issuecomment-918499874","viewerDidAuthor":false},{"id":"IC_kwDODN1w6843rc6s","author":{"login":"changwuf31"},"authorAssociation":"NONE","body":"Hi, is the PR https://github.com/temporalio/sdk-go/pull/520 already fix this ?\r\nOr is it not related at all with this ?\r\n\r\nMany thanks ","createdAt":"2021-10-05T07:21:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/480#issuecomment-934137516","viewerDidAuthor":false},{"id":"IC_kwDODN1w68436vlm","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Here is the Java analogue: https://github.com/temporalio/sdk-java/issues/731. We are intentionally not recording this, see https://github.com/cretz/sdk-go/blob/b52191f564572912c7835573567eb7ff7e802530/internal/internal_task_pollers.go#L884-L887\r\n\r\nCurrently reviewing the cost of this specific fix while weighing other potential approaches including suggesting using external notification mechanisms or incorporating a more two-phased stop throughout.","createdAt":"2021-10-07T20:50:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/480#issuecomment-938146150","viewerDidAuthor":false},{"id":"IC_kwDODN1w68438qex","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Replicated issue and fixed in #579","createdAt":"2021-10-08T13:36:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/480#issuecomment-938649521","viewerDidAuthor":false}],"createdAt":"2021-06-22T19:27:55Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDg2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":480,"reactionGroups":[],"state":"CLOSED","title":"Activity result is not stored (and continued) when stopping worker gracefully","updatedAt":"2021-10-18T20:07:18Z","url":"https://github.com/temporalio/sdk-go/issues/480"}
