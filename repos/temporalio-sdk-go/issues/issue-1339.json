{"assignees":[],"author":{"id":"MDQ6VXNlcjE1NjU0Mzk=","is_bot":false,"login":"avarabyeu","name":"Andrei Varabyeu"},"body":"## Expected Behavior\r\nWorker does not create more sessions than defined in MaxConcurrentSessionExecutionSize. Workflow tasks are queued until worker is ready to accept new one. \r\n\r\n## Actual Behavior\r\nMore sessions than defined in MaxConcurrentSessionExecutionSize are created\r\n\r\n## Steps to Reproduce the Problem\r\nI've got quite unusual use case when i need a worker to handle only one session. Workflow itself is quite basic - when session is started, workflow waits for external signal for a while (some sort of approval), than executes single activity. The activity uses serial port, so running two activities / sessions in parallel is prohibited. Normally, there are 2-3 workers are running in parallel. \r\n \r\nFrom time to time i see some workers starting 2 sessions in parallel which seems to be a bug since MaxConcurrentSessionExecutionSize=1 is set to all workers.  \r\n\r\n## Specifications\r\nTemporal CLI server\r\n  - Version: 1.22.2 server, 1.25.1 go SDK\r\n  - Platform: Linux\r\n","closedAt":"2024-01-08T20:13:19Z","comments":[{"id":"IC_kwDODN1w685wJhMo","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Can you share some more details around this scenario? Ideally some minimal example that reproduces this issue","createdAt":"2024-01-08T17:39:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1339#issuecomment-1881543464","viewerDidAuthor":false},{"id":"IC_kwDODN1w685wJ9E0","author":{"login":"avarabyeu"},"authorAssociation":"NONE","body":"Unfortunately, i won't be able to share the complete example, but here are some pieces. Hope it makes sense:\r\nSo, the workflow is basically executor of 3D-printer. That's why i can't have two workflows/sessions running in parallel for the same worker instance. \r\nThere is root workflow that handles pre-processing and other stuff. When the image is ready for print, root workflow creates child workflow that runs on the worker physically connected to the printer. \r\nThis is how printer worker is created:\r\n```go\r\n                        w := worker.New(c, \"printers-queue\", worker.Options{\r\n\t\t\t\tIdentity:                           fmt.Sprintf(\"printer-queue-%s\", cfg.PrinterName),\r\n\t\t\t\tMaxConcurrentSessionExecutionSize:  1,\r\n\t\t\t\tEnableSessionWorker:                true,\r\n\t\t\t})\r\n\t\t\tpq := printerqueue.NewPrinterWorkflow(cfg.PrinterName)\r\n\t\t\tw.RegisterWorkflow(pq.PrinterQueue)\r\n                         w.RegisterActivityWithOptions(printActivity.Run, activity.RegisterOptions{\r\n\t\t\t\tName: \"PrinterActivity\",\r\n\t\t\t})\t\t\t\r\n```\r\nI've got at least two workers, running as docker containers. \r\n\r\nThis is how workflow looks like:\r\n\r\n```go\r\nfunc (wfl *PrinterWorkflow) PrinterQueue(ctx workflow.Context, input string) error {\r\n\tsessionOptions := &workflow.SessionOptions{\r\n\t\tCreationTimeout:  1 * time.Hour,\r\n\t\tExecutionTimeout: 1 * time.Hour,\r\n\t}\r\n\t// Create a Session with the Worker so that all Activities execute with the same Worker.\r\n\tsessionCtx, err := workflow.CreateSession(ctx, sessionOptions)\r\n\tif err != nil {\r\n\t\treturn err\r\n\t}\r\n\tdefer workflow.CompleteSession(sessionCtx)\r\n\r\n        // let parent workflow that printer is assigned and ready to print\r\n\tparent := workflow.GetInfo(ctx).ParentWorkflowExecution\r\n\tif err := workflow.SignalExternalWorkflow(ctx,\r\n\t\tparent.ID,\r\n\t\tparent.RunID, SignalNameAssigned, wfl.printer).Get(ctx, nil); err != nil {\r\n\t\treturn err\r\n\t}\r\n\r\n\tapproved, err := wfl.waitForApproval(ctx)\r\n\tif err != nil {\r\n\t\treturn err\r\n\t}\r\n\tif !approved {\r\n\t\treturn errors.New(\"printing isn't approved\")\r\n\t}\r\n        // once approved, start printing\r\n\tctx = workflow.WithActivityOptions(ctx, workflow.ActivityOptions{\r\n\t\tStartToCloseTimeout: 1 * time.Hour,\r\n\t\tTaskQueue:           workflow.GetInfo(ctx).TaskQueueName,\r\n\t})\r\n\terr = workflow.ExecuteActivity(ctx, \"PrinterActivity\", activities.PrintActivityInput{\r\n\t\tFilename: input,\r\n\t}).Get(ctx, nil)\r\n\tif err != nil {\r\n\t\treturn err\r\n\t}\r\n\r\n\treturn nil\r\n}\r\n```\r\n\r\nWhat i see is that there are two workflows at the same worker stuck at 'waitingForApproval' line, which basically means that there are two parallel sessions are created ","createdAt":"2024-01-08T19:01:13Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1339#issuecomment-1881657652","viewerDidAuthor":false},{"id":"IC_kwDODN1w685wJ-qJ","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":">What i see is that there are two workflows at the same worker stuck at 'waitingForApproval' line, which basically means that there are two parallel sessions are created\r\n\r\nSessions do not control what workers workflow tasks run on, only what worker activities run on. If you approve both those workflows the activities should run on separate workers.","createdAt":"2024-01-08T19:05:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1339#issuecomment-1881664137","viewerDidAuthor":false},{"id":"IC_kwDODN1w685wKUmT","author":{"login":"avarabyeu"},"authorAssociation":"NONE","body":"That makes perfect sense and explains the problem i have. \r\nThanks a lot for prompt replies @Quinn-With-Two-Ns \r\nClosing this one since it's not a bug","createdAt":"2024-01-08T20:13:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1339#issuecomment-1881754003","viewerDidAuthor":false}],"createdAt":"2024-01-08T15:43:35Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1339,"reactionGroups":[],"state":"CLOSED","title":"workflow.CreateSession create more sessions than MaxConcurrentSessionExecutionSize","updatedAt":"2024-01-08T20:13:19Z","url":"https://github.com/temporalio/sdk-go/issues/1339"}
