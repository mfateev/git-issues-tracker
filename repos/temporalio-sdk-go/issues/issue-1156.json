{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"## Expected Behavior\r\n\r\nWhen a worker stops while an activity is running and that context is cancelled and bubbled out as an activity error, that activity attempt should be recorded as failed server side. This is how it works in most SDKs today.\r\n\r\n## Actual Behavior\r\n\r\nToday if you stop a worker, the activity tries to return to the server the cancelled error but the server fails the activity task completion with:\r\n\r\n> unable to mark activity as canceled without activity being request canceled first\r\n\r\nI think we need to send 1) only send activity cancelled if the server requested cancel (otherwise wrap as application error if canceled error received), and 2) write a test proving that worker stop during a non-heartbeating activity does the next attempt on the next worker.","closedAt":"2025-06-04T18:52:04Z","comments":[{"id":"IC_kwDODN1w685gz1HC","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"This maybe could be done at the same time as #1086","createdAt":"2023-07-06T19:24:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1156#issuecomment-1624199618","viewerDidAuthor":false},{"id":"IC_kwDODN1w685vce0K","author":{"login":"josh-berry"},"authorAssociation":"NONE","body":"Am I correct in thinking the impact of this is just performanceâ€”that is, it takes longer overall to successfully complete the activity than it otherwise might?\r\n\r\nMy mental model of this is:\r\n\r\n1. Activity cancellation error gets sent to server\r\n2. Server fails the task completion, and therefore doesn't realize the activity was canceled\r\n3. Eventually the activity times out server-side (<-- this is where the extra time goes)\r\n4. Server retries the activity (hopefully on a new worker since the old one died)\r\n5. Eventually the activity completes (if nothing else goes wrong)\r\n\r\nlmk what I got wrong. :)","createdAt":"2023-12-26T19:38:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1156#issuecomment-1869737226","viewerDidAuthor":false},{"id":"IC_kwDODN1w685vzBra","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Yes, that seems correct. I think in most Core-based SDKs, we already convert non-server-requested-activity-cancellation errors (i.e. worker shutdown) to activity errors. I think we probably just confirm and do this in all SDKs.","createdAt":"2024-01-03T16:33:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1156#issuecomment-1875647194","viewerDidAuthor":false},{"id":"IC_kwDODN1w686UI5E2","author":{"login":"dmateusp"},"authorAssociation":"NONE","body":"I've just hit the same behavior. I'm cancelling the activity context in an interceptor when the graceful shutdown of workers is initiated, but then I see the same `unable to mark activity as canceled without activity being request canceled first` and Temporal waits for the `StartToCloseTimeout` before attempting the activity again.\r\n\r\nIdeally we'd like the next attempt to start as soon as a new worker has rolled out.\r\n\r\nThis is a snippet from my interceptor code for reference:\r\n\r\n```go\r\n\tgracefulShutdownChan := activity.GetWorkerStopChannel(ctx)\r\n\r\n\tactivityCtx, activityCtxCancelFunc := context.WithCancel(ctx)\r\n\tdefer activityCtxCancelFunc()\r\n\r\n\tgo func() {\r\n\t\t<-gracefulShutdownChan\r\n\t\ttime.Sleep(10 * time.Second) // Give the running activities some time to finish\r\n\t\tactivityCtxCancelFunc()\r\n\t}()\r\n\tresult, err := a.Next.ExecuteActivity(activityCtx, in)\r\n```","createdAt":"2024-11-19T10:53:50Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1156#issuecomment-2485358902","viewerDidAuthor":false},{"id":"IC_kwDODN1w686ULWDG","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"@dmateusp I don't believe this issue would help achieve your desired behaviour\r\n\r\n>Ideally we'd like the next attempt to start as soon as a new worker has rolled out.\r\n\r\nIf you want that your activity to immediately run again, your interceptor should return a [custom error](https://pkg.go.dev/go.temporal.io/sdk/temporal#NewApplicationErrorWithOptions) with a very small `NextRetryDelay`","createdAt":"2024-11-19T15:16:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1156#issuecomment-2486001862","viewerDidAuthor":false}],"createdAt":"2023-07-06T19:23:50Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDg2","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":1156,"reactionGroups":[],"state":"CLOSED","title":"Activity cancel error returned when not initiated server side is rejected by server","updatedAt":"2025-06-04T18:52:04Z","url":"https://github.com/temporalio/sdk-go/issues/1156"}
