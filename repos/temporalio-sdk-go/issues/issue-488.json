{"assignees":[{"id":"MDQ6VXNlcjEzMTE2OTQ=","login":"vitarb","name":"Vitali","databaseId":0}],"author":{"id":"MDQ6VXNlcjQxNjYwOTI=","is_bot":false,"login":"ryanhall07","name":"Ryan Hall"},"body":"We are seeing random flakes in our temporal workflow tests due to data races. The data race dumps are a little tough to read because it's missing the Previous Read stacktrace.\r\n\r\n```\r\nWARNING: DATA RACE\r\n\r\nWrite at 0x00c0005100d0 by goroutine 11:\r\n\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).ExecuteUntilAllBlocked.func1()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow.go:956 +0x3e\r\n\r\n  runtime.call32()\r\n\r\n      /var/lib/buildkite-agent/.gimme/versions/go1.15.8.linux.amd64/src/runtime/asm_amd64.s:540 +0x3d\r\n\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).ExecuteUntilAllBlocked()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow.go:968 +0x4e4\r\n\r\n  go.temporal.io/sdk/internal.executeDispatcher()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow.go:566 +0xe1\r\n\r\n  go.temporal.io/sdk/internal.(*syncWorkflowDefinition).OnWorkflowTaskStarted()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow.go:539 +0xa4\r\n\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).startWorkflowTask()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow_testsuite.go:638 +0x8f6\r\n\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).handleActivityResult()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow_testsuite.go:1480 +0x853\r\n\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).ExecuteActivity.func1.1.1()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow_testsuite.go:1088 +0x158\r\n\r\n  go.temporal.io/sdk/internal.(*testCallbackHandle).processCallback()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow_testsuite.go:718 +0x11e\r\n\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).startMainLoop()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow_testsuite.go:672 +0x3e8\r\n\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeWorkflowInternal()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow_testsuite.go:501 +0x404\r\n\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeWorkflow()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow_testsuite.go:445 +0x1e4\r\n\r\n  go.temporal.io/sdk/internal.(*TestWorkflowEnvironment).ExecuteWorkflow()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/workflow_testsuite.go:495 +0x1d8\r\n\r\nPrevious read at 0x00c0005100d0 by goroutine 21:\r\n\r\n  [failed to restore the stack\r\n\r\nGoroutine 21 (running) created at:\r\n\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow.go:920 +0x404\r\n\r\n  go.temporal.io/sdk/internal.(*workflowEnvironmentInterceptor).Go()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow.go:298 +0x93\r\n\r\n  go.temporal.io/sdk/internal.newDispatcher()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow.go:558 +0x19d\r\n\r\n  go.temporal.io/sdk/internal.(*syncWorkflowDefinition).Execute()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow.go:478 +0x22b\r\n\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeWorkflowInternal.func1()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow_testsuite.go:479 +0xfc\r\n\r\n  go.temporal.io/sdk/internal.(*testCallbackHandle).processCallback()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow_testsuite.go:718 +0x11e\r\n\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).startMainLoop()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow_testsuite.go:661 +0x1ab\r\n\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeWorkflowInternal()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow_testsuite.go:501 +0x404\r\n\r\n  go.temporal.io/sdk/internal.(*testWorkflowEnvironmentImpl).executeWorkflow()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/internal_workflow_testsuite.go:445 +0x1e4\r\n\r\n  go.temporal.io/sdk/internal.(*TestWorkflowEnvironment).ExecuteWorkflow()\r\n\r\n      /var/lib/buildkite-agent/go/pkg/mod/go.temporal.io/sdk@v1.8.0/internal/workflow_testsuite.go:495 +0x1d8\r\n```\r\n\r\nMy theory is the new goroutine spawned by [NewCoroutine](https://github.com/temporalio/sdk-go/blob/master/internal/internal_workflow.go#L920) (goroutine 21 above) is reading  the `executing` state, probably via `IsExecuting()`. goroutine 11 is updating `executing` without a lock in the [defer statement](https://github.com/temporalio/sdk-go/blob/master/internal/internal_workflow.go#L956).\r\n\r\n\r\n\r\n## Specifications\r\n\r\n  - Version: 1.8\r\n  - Platform: go sdk\r\n","closedAt":"2021-07-21T01:11:14Z","comments":[{"id":"IC_kwDODN1w6840o3j1","author":{"login":"vitarb"},"authorAssociation":"CONTRIBUTOR","body":"If you have a test that has a chance to cause this issue, would you be able to share it  with us?\r\nOne thing we can try is blindly adding locking into defer statement you've mentioned above, but I afraid it might be insufficient.\r\nMeanwhile I'm trying to find a reliable way to reproduce this problem.","createdAt":"2021-07-20T06:42:24Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/488#issuecomment-883128565","viewerDidAuthor":false},{"id":"IC_kwDODN1w6840rRTC","author":{"login":"vitarb"},"authorAssociation":"CONTRIBUTOR","body":"I've found reliable repro:\r\n```\r\nfunc TestDataRace(t *testing.T) {\r\n\tdone := false\r\n\td := createNewDispatcher(func(ctx Context) {\r\n\t\t_ = Await(ctx, func() bool {\r\n\t\t\ttime.Sleep(defaultDeadlockDetectionTimeout)\r\n\t\t\treturn done\r\n\t\t})\r\n\t})\r\n\terr := d.ExecuteUntilAllBlocked(defaultDeadlockDetectionTimeout)\r\n\trequire.NoError(t, err)\r\n\td.Close()\r\n}\r\n```\r\nIt looks like race condition happens when deadlock detector and await/coroutine completion are happening at the same time.\r\n```\r\nWARNING: DATA RACE\r\nWrite at 0x00c00010ec60 by goroutine 7:\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).ExecuteUntilAllBlocked.func1()\r\n      /home/vit/projects/go-sdk/internal/internal_workflow.go:956 +0x3e\r\n  runtime.call16()\r\n      /usr/lib/go/src/runtime/asm_amd64.s:550 +0x3d\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).ExecuteUntilAllBlocked()\r\n      /home/vit/projects/go-sdk/internal/internal_workflow.go:968 +0x4f3\r\n  go.temporal.io/sdk/internal.TestDataRace()\r\n      /home/vit/projects/go-sdk/internal/internal_coroutines_test.go:765 +0xab\r\n  testing.tRunner()\r\n      /usr/lib/go/src/testing/testing.go:1193 +0x202\r\n\r\nPrevious read at 0x00c00010ec60 by goroutine 8:\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).IsExecuting()\r\n      /home/vit/projects/go-sdk/internal/internal_workflow.go:999 +0xad\r\n  go.temporal.io/sdk/internal.getState()\r\n      /home/vit/projects/go-sdk/internal/internal_workflow.go:596 +0x82\r\n  go.temporal.io/sdk/internal.Await()\r\n      /home/vit/projects/go-sdk/internal/workflow.go:282 +0x6d\r\n  go.temporal.io/sdk/internal.TestDataRace.func1()\r\n      /home/vit/projects/go-sdk/internal/internal_coroutines_test.go:760 +0x78\r\n  go.temporal.io/sdk/internal.(*dispatcherImpl).NewCoroutine.func1()\r\n      /home/vit/projects/go-sdk/internal/internal_workflow.go:929 +0x11c\r\n```","createdAt":"2021-07-20T22:57:56Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/488#issuecomment-883758274","viewerDidAuthor":false},{"id":"IC_kwDODN1w6840rd5v","author":{"login":"vitarb"},"authorAssociation":"CONTRIBUTOR","body":"Above fix *should* address the issue. We plan to make a release soon, let us know/reopen if you keep seeing this after upgrading.","createdAt":"2021-07-21T01:12:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/488#issuecomment-883809903","viewerDidAuthor":false}],"createdAt":"2021-07-15T18:05:53Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":488,"reactionGroups":[],"state":"CLOSED","title":"data race in dispatcherImpl.ExecuteUntilAllBlocked","updatedAt":"2021-07-21T01:12:47Z","url":"https://github.com/temporalio/sdk-go/issues/488"}
