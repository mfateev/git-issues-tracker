{"assignees":[],"author":{"id":"MDQ6VXNlcjEyODMxMDk=","is_bot":false,"login":"twmb","name":"Travis Bischel"},"body":"`internal_worker.AggregatedWorker#Run` calls `aw.Start`, which asserts that the worker has not yet been stopped.\r\n\r\n`Run` is a blocking function, it must be executed in a goroutine if the user wants to stop the worker independently. The user may then wait for an input signal and `Stop` the worker. It is possible that `Run` has not yet started and `Stop` executes before `Run`. In this tight sequence of events, the code will panic: https://github.com/temporalio/sdk-go/blob/dea0cfa509b981c05ea4e9c9ad2f841845997574/internal/internal_worker.go#L955\r\n\r\nSince `Run` returns an error, I'd expect this code to just return `ErrClosed` or something similar.","closedAt":"2022-08-10T18:48:26Z","comments":[{"id":"IC_kwDODN1w685HS8vq","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"For users who cannot be sure that `worker.Stop()` will be called after `worker.Run()` has had enough chance to get started, they may find it better to instead use `worker.Start()` in the same goroutine they may later call `Stop()`. This is one reason we provide both `Start()` and `Run()`, for those that need to now when started (which `Run()` cannot tell them).\r\n\r\nHaving said that, yes, we can return an error for `Start()` and `Run()` if they are called on a stopped worker. Still, most people should tailor their code to avoid this possibility.","createdAt":"2022-07-27T00:52:12Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/868#issuecomment-1196149738","viewerDidAuthor":false},{"id":"IC_kwDODN1w685HS-cu","author":{"login":"twmb"},"authorAssociation":"NONE","body":"Is the point of `Run` to not ever be shutdown? The theoretical race exists in any model of using `Run` in tandem with `Close` _unless_ some activity that is being signals readiness such that the worker can be stopped -- but this relies on input.","createdAt":"2022-07-27T01:05:45Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/868#issuecomment-1196156718","viewerDidAuthor":false},{"id":"IC_kwDODN1w685HVxnC","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Definitely can shutdown. The point of Run is as a helper for people that want to block until shutdown, but Start is better for those concerned that they need to know when start completed because they may immediately shutdown.\r\n\r\nYes, the race exists between Run and Stop. Users concerned about this race should use Start and Stop.","createdAt":"2022-07-27T15:13:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/868#issuecomment-1196890562","viewerDidAuthor":false},{"id":"IC_kwDODN1w685IArGM","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Closing, in favor of using `Start`. Users should not use `Run` if they're concerned they may shutdown before running. Reopen if needed.","createdAt":"2022-08-08T13:31:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/868#issuecomment-1208136076","viewerDidAuthor":false},{"id":"IC_kwDODN1w685IA4Gr","author":{"login":"twmb"},"authorAssociation":"NONE","body":"At a minimum, the panic should be noted in docs on Run. The safest way to\nprogram around the panic right now is to only allow Close to occur in an\nactivity that is ran at least once. This is the only way for a user to\n_know_ that the temporal client has started.\n\nWithout this, users have to rely on heuristics and hope. Any proper\nshutdown path that triggers a more immediate exit can panic if an interrupt\nis received while things are starting up.\n\nOn Mon, Aug 8, 2022 at 07:31 Chad Retz ***@***.***> wrote:\n\n> Closed #868 <https://github.com/temporalio/sdk-go/issues/868> as\n> completed.\n>\n> â€”\n> Reply to this email directly, view it on GitHub\n> <https://github.com/temporalio/sdk-go/issues/868#event-7147135358>, or\n> unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/AAJZIJNIYQSJTCXFCTN4Q3LVYED35ANCNFSM54XNBYJA>\n> .\n> You are receiving this because you authored the thread.Message ID:\n> ***@***.***>\n>\n","createdAt":"2022-08-08T14:16:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/868#issuecomment-1208189355","viewerDidAuthor":false},{"id":"IC_kwDODN1w685IA8lz","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> At a minimum, the panic should be noted in docs on Run. \r\n\r\nOk, I will add docs.\r\n\r\n> The safest way to program around the panic right now is to only allow Close to occur in an activity that is ran at least once\r\n\r\nThe safest way is to use `Start`. Users can rely on this `Start` instead of heuristics and hope. This is a way for users to _know_ Temporal client has started. In retrospect, maybe we should have never had the `Run` helper since its utility seems confusing and is easy to build yourself using `Start`.\r\n\r\nJust use `Start`.","createdAt":"2022-08-08T14:30:44Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/868#issuecomment-1208207731","viewerDidAuthor":false}],"createdAt":"2022-07-26T21:35:38Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":868,"reactionGroups":[],"state":"CLOSED","title":"panic if `Run` and `Stop` race","updatedAt":"2022-08-10T18:48:26Z","url":"https://github.com/temporalio/sdk-go/issues/868"}
