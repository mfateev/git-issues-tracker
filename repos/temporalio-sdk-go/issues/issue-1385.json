{"assignees":[],"author":{"id":"MDQ6VXNlcjY2MjgyNA==","is_bot":false,"login":"askreet","name":"Kyle Smith"},"body":"**Is your feature request related to a problem? Please describe.**\r\n\r\nI've recently learned that using the value of RunId within workflow task code is non-deterministic under workflow ~~retry~~ reset scenarios.\r\n\r\n**Describe the solution you'd like**\r\n\r\nI'd love for the workflowcheck tool to detect reads of this particular property within workflow functions and suggest use of the WorkflowInfo.OriginalRunId (or FirstRunId) field instead.\r\n\r\n**Describe alternatives you've considered**\r\n\r\nN/A.\r\n\r\n**Additional context**\r\n\r\nN/A.","closedAt":"2024-02-09T23:12:30Z","comments":[{"id":"IC_kwDODN1w685zbhJN","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Can you clarify the scenario? Workflow retry starts a whole new workflow so the fact that RunID changes should not lead to non determinism","createdAt":"2024-02-09T20:58:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1385#issuecomment-1936593485","viewerDidAuthor":false},{"id":"IC_kwDODN1w685zbrWQ","author":{"login":"askreet"},"authorAssociation":"NONE","body":"@Quinn-With-Two-Ns It leads to non-determinism if you use the value of RunID as an input to an activity or child workflow. For example, we were rendering the URL to the Temporal UI before kicking off a child workflow that creates a pull request, linking our developers back to the workflow that was created for them. In my scenario, the workflow had previously passed this step successfully so during replay the input value to the child workflow had changed.\r\n\r\nEdit: In fact this journey led me [this field](https://github.com/temporalio/sdk-go/blob/master/internal/workflow.go#L995-L996), which documents itself as a more viable alternative.\r\n","createdAt":"2024-02-09T21:35:24Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1385#issuecomment-1936635280","viewerDidAuthor":false},{"id":"IC_kwDODN1w685zbtgw","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Activities and Child workflows are not carried over retries. Non determinism only applies to a single workflow execution. A retried workflow can take a totally different path then the parent. It sounds like your trying to use RunID as an idempotency token across workflow retries, which is an error in your code, but is not non determinism.\r\n\r\nThe workflow check is designed to catch non determinism errors not all possible programming errors,\r\n","createdAt":"2024-02-09T21:43:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1385#issuecomment-1936644144","viewerDidAuthor":false},{"id":"IC_kwDODN1w685zbttu","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Note: in general we do not recommend workflow retries, we recommend handling errors in your workflow.","createdAt":"2024-02-09T21:44:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1385#issuecomment-1936644974","viewerDidAuthor":false},{"id":"IC_kwDODN1w685zbxs1","author":{"login":"askreet"},"authorAssociation":"NONE","body":"> Activities and Child workflows are not carried over retries.\r\n\r\nI don't follow what you're saying here.\r\n\r\nThe input values need to match during the execution of a workflow task, or you get a non-determinism error when you reach the point in the workflow task when it attempts to run the activity or child workflow, right? In my workflow I execute a child workflow at a point in the event stream, and during the retry the input value is not the same as it was during the previous workflow task because it refers to a Run ID, which has changed due to the retry.\r\n\r\nTo be clear, I don't expect (or desire) that the child workflow is actually run again - we're talking about replaying the event stream to determine the next action for the workflow to take.\r\n\r\n> Note: in general we do not recommend workflow retries, we recommend handling errors in your workflow.\r\n\r\nIn my case I had a workflow fail near the end of it's run due to a program defect. I've corrected the defect and would like to replay the workflow from the point of failure. Are you suggesting that the workflow retry command is not intended for me to do that? What alternative methods are suggested for resuming my terminated, failed workflow execution so that I can complete the intended actions?\r\n\r\nEdit: Wait, I now see the confusion in the second scenario - I've been saying \"retry\", I mean workflow \"reset\". That's what I'm trying to do ðŸ˜“. I am not using workflow retries at all.","createdAt":"2024-02-09T22:00:20Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1385#issuecomment-1936661301","viewerDidAuthor":false},{"id":"IC_kwDODN1w685zbyj1","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Ah OK, reset makes more sense \r\n\r\n>The input values need to match during the execution of a workflow task, or you get a non-determinism error when you reach the point in the workflow task when it attempts to run the activity or child workflow, right? \r\n\r\nNo, input is not checked when the SDK is validating a workflow is deterministic. ","createdAt":"2024-02-09T22:04:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1385#issuecomment-1936664821","viewerDidAuthor":false},{"id":"IC_kwDODN1w685zby3r","author":{"login":"askreet"},"authorAssociation":"NONE","body":"> No, input is not checked when the SDK is validating a workflow is deterministic.\r\n\r\nOh? If that's so that I actually am back at square one and don't understand this determinism error! Will keep digging.","createdAt":"2024-02-09T22:05:18Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1385#issuecomment-1936666091","viewerDidAuthor":false},{"id":"IC_kwDODN1w685zbzun","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Only the `Activity ID` and Type is checked I believe ","createdAt":"2024-02-09T22:08:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1385#issuecomment-1936669607","viewerDidAuthor":false},{"id":"IC_kwDODN1w685zb1dl","author":{"login":"askreet"},"authorAssociation":"NONE","body":"@Quinn-With-Two-Ns You're definitely pointing me in the right direction here, I updated my code to use OriginalRunId and I'm still seeing this error:\r\n\r\n> unknown command CommandType: ChildWorkflow, ID: 70b7166d-0175-40bb-9ec0-e0f6473625c1_29, possible causes are nondeterministic workflow definition code or incompatible change in the workflow definition\r\n\r\nThat ID is the _original_ Run ID, plus the Event ID where the child was spawned. My current thesis is that since I'm not setting a workflow ID on the child workflow execution, it's comparing a newly generated child workflow ID that does not match that value.","createdAt":"2024-02-09T22:16:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1385#issuecomment-1936676709","viewerDidAuthor":false},{"id":"IC_kwDODN1w685zb5jU","author":{"login":"askreet"},"authorAssociation":"NONE","body":"I think the interesting piece of code is: https://github.com/temporalio/sdk-go/blob/master/internal/internal_event_handlers.go#L538-L540.\r\n\r\n```go\r\nfunc (wc *workflowEnvironmentImpl) ExecuteChildWorkflow(\r\n\tparams ExecuteWorkflowParams, callback ResultHandler, startedHandler func(r WorkflowExecution, e error),\r\n) {\r\n\tif params.WorkflowID == \"\" {\r\n\t\tparams.WorkflowID = wc.workflowInfo.WorkflowExecution.RunID + \"_\" + wc.GenerateSequenceID()\r\n\t}\r\n```\r\n\r\nIf I understand this correctly, any child workflow execution without a deterministically set Workflow ID will make the parent execution not \"reset safe\".","createdAt":"2024-02-09T22:35:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1385#issuecomment-1936693460","viewerDidAuthor":false},{"id":"IC_kwDODN1w685zcAda","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Ah if your using child workflow without an ID then this is a know issue https://github.com/temporalio/sdk-go/issues/723. \r\n\r\nI would recommend setting your own ID for now since as the linked issue says the SDK generated ID needs to not conflict with future server work that is not currently prioritized. ","createdAt":"2024-02-09T23:09:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1385#issuecomment-1936721754","viewerDidAuthor":false},{"id":"IC_kwDODN1w685zcA_t","author":{"login":"askreet"},"authorAssociation":"NONE","body":"Awesome, thanks @Quinn-With-Two-Ns! I'll update our internal guidelines to always set child workflow IDs in the meantime. I wonder if _that_ is a useful check for `workflowcheck` in the meantime if we don't have a timeline for the blocking server work? Anyway, I'll close this out for now.","createdAt":"2024-02-09T23:12:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/1385#issuecomment-1936723949","viewerDidAuthor":false}],"createdAt":"2024-02-09T20:56:42Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDky","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":1385,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"state":"CLOSED","title":"Extend workflowcheck tool to detect reads from (WorkflowExecution).RunId and suggest alternatives.","updatedAt":"2024-02-09T23:12:31Z","url":"https://github.com/temporalio/sdk-go/issues/1385"}
