{"assignees":[],"author":{"id":"U_kgDOBg93Ag","is_bot":false,"login":"uritig","name":"guriti"},"body":"## Expected Behavior\r\nCorrect gRPC code should be recorded & returned.\r\n\r\n## Actual Behavior\r\ngRPC code \"Unavailable\" is being reported as \"Unknown\"\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Run a temporal server that returns Http 503 Unavailable gRPC code\r\n  2. Verify that the correct code is being received via another client. In my case, I verified in python, a generic gRPC client & with postman. They all confirmed the \"Unavailable\" code.\r\n Sample code:\r\n```\r\nfunc testRawGrpc() {\r\n\tvar grpcClient *grpc.ClientConn\r\n\tvar err error\r\n\tcreds := credentials.NewTLS(&tls.Config{})\r\n\tgrpcClient, err = grpc.Dial(\"<host:port>\", grpc.WithTransportCredentials(creds), grpc.WithMaxMsgSize(1*1024*1024), grpc.WithTimeout(10*time.Second))\r\n\t\r\n\tdefer grpcClient.Close()\r\n\r\n\tif err != nil {\r\n\t\tlog.Printf(\"unable to create client: %#v\\n\", err)\r\n\t\treturn\r\n\t}\r\n\r\n\treq := workflowservice.ListNamespacesRequest{\r\n\t\tPageSize:        100,\r\n\t\tNamespaceFilter: &namespace.NamespaceFilter{IncludeDeleted: true},\r\n\t}\r\n\r\n\tresp := workflowservice.ListNamespacesResponse{}\r\n\r\n\terr = grpcClient.Invoke(context.Background(), \"/temporal.api.workflowservice.v1.WorkflowService/ListNamespaces\", &req, &resp)\r\n\tif err != nil {\r\n\t\tlog.Printf(\"unable to ListNamespaces: %#v\\n\", err)\r\n\t\tgrpcErr, _ := status.FromError(err)\r\n\t\tlog.Printf(\"grpcMessage=%v, grpcCode=%v\\n\", grpcErr.Message(), grpcErr.Code())\r\n\t\treturn\r\n\t}\r\n\tlog.Println(\"ListNamespaces result:\", &resp)\r\n}\r\n```\r\nNotice in the logs:\r\n```\r\n...\r\ngrpcMessage=no healthy upstream, grpcCode=Unavailable\r\n...\r\n```\r\n  3. Now, try the same with the sdk client\r\n  \r\n```\r\nfunc testTemporalClient() {\r\n\ttemporalConnectionOpts := client.ConnectionOptions{\r\n\t\tTLS: &tls.Config{},\r\n\t}\r\n\ttemporalClientOpts := client.Options{\r\n\t\tHostPort:          \"<host:port>\",\r\n\t\tNamespace:         \"default\",\r\n\t\tConnectionOptions: temporalConnectionOpts,\r\n\t}\r\n\tc, err := client.Dial(temporalClientOpts)\r\n\tif err != nil {\r\n\t\tgrpcErr, _ := status.FromError(err)\r\n\t\tfmt.Printf(\"grpcMessage=%v, grpcCode=%v\\n\", grpcErr.Message(), grpcErr.Code())\r\n\t\tlog.Println(\"Failed to create temporal client:\", err)\r\n\t\treturn\r\n\t}\r\n\tdefer c.Close()\r\n\r\n\treq := workflowservice.ListNamespacesRequest{\r\n\t\tPageSize:        100,\r\n\t\tNamespaceFilter: &namespace.NamespaceFilter{IncludeDeleted: true},\r\n\t}\r\n\r\n\tresp, err := c.WorkflowService().ListNamespaces(context.Background(), &req)\r\n\tif err != nil {\r\n\t\tlog.Println(\"Unable to ListNamespaces\", err)\r\n\t\tgrpcErr, _ := status.FromError(err)\r\n\t\tlog.Printf(\"grpcMessage=%v, grpcCode=%v\\n\", grpcErr.Message(), grpcErr.Code())\r\n\t\treturn\r\n\t}\r\n\tlog.Println(\"ListNamespaces result:\", resp)\r\n}\r\n```\r\nNotice in the logs:\r\n```\r\n...\r\ngrpcMessage=failed reaching server: no healthy upstream, grpcCode=Unknown\r\n...\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: Observed in go-SDK versions v1.24.0, v1.25.0 & v1.28.1\r\n  - Platform: Linux\r\n","closedAt":"2024-08-01T04:42:19Z","comments":[{"id":"IC_kwDODN1w686GxB9V","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"In your second example is the error coming from `c, err := client.Dial(temporalClientOpts)`?","createdAt":"2024-07-31T17:20:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1573#issuecomment-2261000021","viewerDidAuthor":false},{"id":"IC_kwDODN1w686Gx6sI","author":{"login":"uritig"},"authorAssociation":"NONE","body":"> In your second example is the error coming from `c, err := client.Dial(temporalClientOpts)`?\r\n\r\nYes. That is when the System Health Check is getting triggered & hence the error.","createdAt":"2024-07-31T19:10:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1573#issuecomment-2261232392","viewerDidAuthor":false},{"id":"IC_kwDODN1w686G06j2","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"The Go SDK is not changing the status code of any errors. `status.FromError(err)` is returning `UNKNOWN` because it encounters an incompatible error type. If you checked the second parameter you would see OK is false indicating the error is not compatible with `status`. The Go SDK does not return raw grpc errors, it returns [serviceerrors](https://pkg.go.dev/go.temporal.io/api@v1.36.0/serviceerror) if you want to get the underlying status you can use `ToStatus`","createdAt":"2024-08-01T04:42:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1573#issuecomment-2262018294","viewerDidAuthor":false},{"id":"IC_kwDODN1w686G8wOJ","author":{"login":"uritig"},"authorAssociation":"NONE","body":"Good point. My bad for missing that. \r\n\r\n```\r\nfunc testTemporalClient() {\r\n\ttemporalConnectionOpts := client.ConnectionOptions{\r\n\t\tTLS: &tls.Config{},\r\n\t}\r\n\ttemporalClientOpts := client.Options{\r\n\t\tHostPort:          \"<host:port>\",\r\n\t\tNamespace:         \"default\",\r\n\t\tConnectionOptions: temporalConnectionOpts,\r\n\t}\r\n\tc, err := client.Dial(temporalClientOpts)\r\n\tif err != nil {\r\n\t\tgrpcErr := serviceerror.ToStatus(err)\r\n\t\tfmt.Printf(\"grpcMessage=%s, grpcCode=%s\\n\", grpcErr.Message(), grpcErr.Code())\r\n\t\tfmt.Println(\"Failed to create temporal client:\", err)\r\n\t\treturn\r\n\t}\r\n\tdefer c.Close()\r\n}\r\n```\r\nThis still prints:\r\n```\r\n...\r\ngrpcMessage=failed reaching server: no healthy upstream, grpcCode=Unknown\r\nFailed to create temporal client: failed reaching server: no healthy upstream\r\n...\r\n```\r\nWhat am I missing? Am I wrong to expect \"Unavailable\" is the logs above?","createdAt":"2024-08-01T21:51:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1573#issuecomment-2264073097","viewerDidAuthor":false},{"id":"IC_kwDODN1w686HSWR3","author":{"login":"uritig"},"authorAssociation":"NONE","body":"@Quinn-With-Two-Ns can you please reopen this?","createdAt":"2024-08-05T19:10:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1573#issuecomment-2269734007","viewerDidAuthor":false},{"id":"IC_kwDODN1w686HSo-E","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Am I wrong to expect \"Unavailable\" is the logs above?\r\n\r\nI think so. I think not even be able to establish connection is not a gRPC RPC error, it's a network error, so I wouldn't expect it to have a known gRPC status code like gRPC RPC errors which carry status codes.","createdAt":"2024-08-05T19:58:32Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1573#issuecomment-2269810564","viewerDidAuthor":false},{"id":"IC_kwDODN1w686HSypG","author":{"login":"uritig"},"authorAssociation":"NONE","body":"> I think so. I think not even be able to establish connection is not a gRPC RPC error, it's a network error, so I wouldn't expect it to have a known gRPC status code like gRPC RPC errors which carry status codes.\r\n\r\n@cretz The error is \"503 Unavailable\" not a network error. It is a gRPC error \"Unavailable\". So, why shouldn't I expect that? \r\n\r\nPlease note that all other gRPC clients (python sdk, base gRPC client, postman, etc.) return the \"Unavailable\" gRPC code. So should the go sdk.\r\n\r\nUnless you have a good reason, requesting that this issue be reopened. Thank you.\r\n","createdAt":"2024-08-05T20:21:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1573#issuecomment-2269850182","viewerDidAuthor":false},{"id":"IC_kwDODN1w686HS8Zw","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"An HTTP status code of 503 unavailable is not the same as a gRPC status code of unavailable (gRPC status codes do not have HTTP numeric status codes). Granted some clients in some languages may reuse the gRPC errors pre-gRPC connectivity.\r\n\r\nCan you show what type `err` is in your snippet? Also, can you confirm what https://pkg.go.dev/google.golang.org/grpc/status#FromError returns for this error? Same question for if using a pure gRPC client instead of an SDK client. We want to make sure we match what Go gRPC does here, so maybe we're wrapping incorrectly compared to pure gRPC use.","createdAt":"2024-08-05T20:47:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1573#issuecomment-2269890160","viewerDidAuthor":false},{"id":"IC_kwDODN1w686HTFTJ","author":{"login":"uritig"},"authorAssociation":"NONE","body":"> An HTTP status code of 503 unavailable is not the same as a gRPC status code of unavailable (gRPC status codes do not have HTTP numeric status codes). Granted some clients in some languages may reuse the gRPC errors pre-gRPC connectivity.\r\n\r\nI don't quite follow what you mean here. Here are the codes: https://pkg.go.dev/google.golang.org/grpc/codes#Code .\r\n\r\n> Can you show what type err is in your snippet? \r\n\r\n```\r\nc, err := client.Dial(temporalClientOpts)\r\nvs\r\ngrpcErr := serviceerror.ToStatus(err)\r\n```\r\nDoes that answer your question?\r\n\r\n> https://pkg.go.dev/google.golang.org/grpc/status#FromError returns for this error? \r\n\r\n@cretz please see the function: `testRawGrpc` in the description of this issue.  \r\nI can confirm that `FromError` returns the \"Unavailable\" code as expected.\r\n\r\n> We want to make sure we match what Go gRPC does here, so maybe we're wrapping incorrectly compared to pure gRPC use.\r\n\r\nAgreed. Exactly what this issue is about.","createdAt":"2024-08-05T21:11:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1573#issuecomment-2269926601","viewerDidAuthor":false},{"id":"IC_kwDODN1w686HTHl6","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"I can confirm the Go SDK is correctly wrapping the error. I can confirm if a grpc server returns `Unavailable` for `GetSystemInfo` the SDK client will return the correct status.\r\n\r\n```\r\nfunc TestUnavailable(t *testing.T) {\r\n\t// Start a server that always returns an error on get system info\r\n\tsrv, err := startTestGRPCServer()\r\n\trequire.NoError(t, err)\r\n\tdefer srv.Stop()\r\n\tsrv.getSystemInfoResponseError = status.New(codes.Unavailable, \"some server failure\").Err()\r\n\r\n\t// Confirm DialClient returns unavailable\r\n\t_, err = DialClient(context.Background(), ClientOptions{HostPort: srv.addr})\r\n\tstatus := serviceerror.ToStatus(err)\r\n\trequire.Equal(t, codes.Unavailable, status.Code())\r\n}\r\n\r\nfunc TestBadHostUnavailable(t *testing.T) {\r\n\t// Confirm DialClient returns unavailable\r\n\t_, err := DialClient(context.Background(), ClientOptions{HostPort: \"localhost:12345\"})\r\n\tstatus := serviceerror.ToStatus(err)\r\n\trequire.Equal(t, codes.Unavailable, status.Code())\r\n}\r\n```","createdAt":"2024-08-05T21:18:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1573#issuecomment-2269935994","viewerDidAuthor":false},{"id":"IC_kwDODN1w686HtRCJ","author":{"login":"uritig"},"authorAssociation":"NONE","body":"@Quinn-With-Two-Ns your tests fail in v1.24.0 (please see screenshot). I did not test against other released versions but they succeed against the `master` branch of this repo. \r\n\r\n![image](https://github.com/user-attachments/assets/884f7674-c601-446b-bea8-a0e91e74d04c)\r\n\r\nSince it worked against the latest code and that nothing in the diff stood out to me as what may have \"fixed\" the issue. , I am happy to leave this issue closed & wait for the next release. \r\nAs always, appreciate the quick responses & your time!\r\n","createdAt":"2024-08-08T22:29:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1573#issuecomment-2276790409","viewerDidAuthor":false}],"createdAt":"2024-07-31T16:28:32Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"},{"id":"LA_kwDODN1w687UGgkJ","name":"external dependency","description":"Waiting on something externally","color":"c5def5"}],"milestone":null,"number":1573,"reactionGroups":[],"state":"CLOSED","title":"gRPC code \"Unavailable\" is being reported as \"Unknown\" by temporal SDK Client","updatedAt":"2024-08-08T22:29:44Z","url":"https://github.com/temporalio/sdk-go/issues/1573"}
