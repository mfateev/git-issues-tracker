{"assignees":[],"author":{"id":"MDQ6VXNlcjI2NTg0NDc4","is_bot":false,"login":"albertteoh","name":"Albert"},"body":"## Expected Behavior\r\n\r\n- I'd like the test to still pass with a recent workflow history.\r\n- Older workflow histories (say from March or April 2024) appear to pass the test.\r\n- I'm fairly confident it's not related to non-determinism.\r\n\r\n## Actual Behavior\r\n\r\nAfter downloading a recent workflow history from Temporal Cloud, my replay tests are failing with error:\r\n```\r\n=== RUN   TestFulfillmentWorkflowReplay\r\n=== PAUSE TestFulfillmentWorkflowReplay\r\n=== CONT  TestFulfillmentWorkflowReplay\r\n2024/08/16 21:13:12 INFO  No DataConverter configured for temporal worker. Use default one.\r\n2024/08/16 21:13:12 ERROR Workflow panic WorkflowType FulfillmentWorkflow WorkflowID ReplayId RunID 229d965d-04bc-4125-a3e2-6c5fc91e4067 Attempt 1 Error [TMPRL1100] lookup failed for scheduledEventID to activityID: scheduleEventID: 7, activityID: 7 StackTrace process event for main [panic]:\r\ngo.temporal.io/sdk/internal.panicIllegalState(...)\r\n  /Users/albertteoh/go/pkg/mod/go.temporal.io/sdk@v1.28.1/internal/internal_command_state_machine.go:507\r\ngo.temporal.io/sdk/internal.(*commandsHelper).handleActivityTaskScheduled(0x14000613ae0, {0x10289e578, 0x1}, 0x7)\r\n  /Users/albertteoh/go/pkg/mod/go.temporal.io/sdk@v1.28.1/internal/internal_command_state_machine.go:1137 +0xec\r\ngo.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).ProcessEvent(0x14000622978, 0x14000532bd0, 0x1?, 0x0)\r\n  /Users/albertteoh/go/pkg/mod/go.temporal.io/sdk@v1.28.1/internal/internal_event_handlers.go:1211 +0x258\r\ngo.temporal.io/sdk/internal.(*workflowExecutionContextImpl).ProcessWorkflowTask(0x140003a1860, 0x14000632450)\r\n  /Users/albertteoh/go/pkg/mod/go.temporal.io/sdk@v1.28.1/internal/internal_task_handlers.go:1151 +0x13f0\r\ngo.temporal.io/sdk/internal.(*workflowTaskHandlerImpl).ProcessWorkflowTask(0x1400062e5b0, 0x14000632450, 0x140003a1860, 0x0)\r\n  /Users/albertteoh/go/pkg/mod/go.temporal.io/sdk@v1.28.1/internal/internal_task_handlers.go:916 +0x2b8\r\ngo.temporal.io/sdk/internal.(*WorkflowReplayer).replayWorkflowHistory(0x140001bf380, {0x101d93078, 0x14000622900}, {0x101dacdc0, 0x14000619760}, {0x10178017f, 0xf}, {{0x0?, 0x1020df5f1?}, {0x0?, ...}}, ...)\r\n  /Users/albertteoh/go/pkg/mod/go.temporal.io/sdk@v1.28.1/internal/internal_worker.go:1466 +0x754\r\ngo.temporal.io/sdk/internal.(*WorkflowReplayer).ReplayPartialWorkflowHistoryFromJSONFile(0x140001bf380, {0x0, 0x0}, {0x1017a9d2d?, 0x14000065801?}, 0x1400000d9f8?)\r\n  /Users/albertteoh/go/pkg/mod/go.temporal.io/sdk@v1.28.1/internal/internal_worker.go:1318 +0x1c0\r\ngo.temporal.io/sdk/internal.(*WorkflowReplayer).ReplayWorkflowHistoryFromJSONFile(0x140003c4540?, {0x0?, 0x0?}, {0x1017a9d2d?, 0x0?})\r\n  /Users/albertteoh/go/pkg/mod/go.temporal.io/sdk@v1.28.1/internal/internal_worker.go:1298 +0x2c\r\ngithub.com/packsmith/api/internal/workflows/definitions_test.TestFulfillmentWorkflowReplay(0x140000d1860)\r\n  /Users/albertteoh/go/src/github.com/packsmith/api/internal/workflows/definitions/fulfillment_workflow_test.go:448 +0x434\r\ntesting.tRunner(0x140000d1860, 0x101d70088)\r\n  /usr/local/go/src/testing/testing.go:1690 +0xe4\r\ncreated by testing.(*T).Run in goroutine 1\r\n  /usr/local/go/src/testing/testing.go:1743 +0x314\r\n    fulfillment_workflow_test.go:449: \r\n          Error Trace:  /Users/albertteoh/go/src/github.com/packsmith/api/internal/workflows/definitions/fulfillment_workflow_test.go:449\r\n          Error:        Received unexpected error:\r\n                        [TMPRL1100] lookup failed for scheduledEventID to activityID: scheduleEventID: 7, activityID: 7\r\n          Test:         TestFulfillmentWorkflowReplay\r\n--- FAIL: TestFulfillmentWorkflowReplay (0.08s)\r\n```\r\n\r\n## Steps to Reproduce the Problem\r\n\r\nMy workflow replay code:\r\n```go\r\nimport (\r\n\t\"go.temporal.io/sdk/worker\"\r\n\t...\r\n)\r\n\r\nfunc TestFulfillmentWorkflowReplay(t *testing.T) {\r\n\tt.Parallel()\r\n\r\n\treplayer := worker.NewWorkflowReplayer()\r\n\r\n\tp := telemetry.Params{\r\n\t\tLifecycle: fakeLifecycle{},\r\n\t\tLogger:    zap.NewNop().Sugar(),\r\n\t\tConfig:    config.Config{Telemetry: config.TelemetryConfig{}},\r\n\t}\r\n\r\n\ttm, err := telemetry.New(p)\r\n\trequire.NoError(t, err)\r\n\r\n\tl, _ := definitions.NewLibrary(definitions.Deps{\r\n\t\tLogger:    zap.NewNop().Sugar(),\r\n\t\tTelemetry: tm,\r\n\t})\r\n\treplayer.RegisterWorkflow(l.FulfillmentWorkflow)\r\n\r\n\terr = replayer.ReplayWorkflowHistoryFromJSONFile(nil, \"testdata/fulfillment_workflow_20240816.json\")\r\n\trequire.NoError(t, err)\r\n}\r\n```\r\n\r\nHappy to attach the full workflow history files that reproduce the success and failure test runs; please let me know.\r\n\r\n## Specifications\r\n\r\n  - Version: Go SDK version 1.28.1\r\n  - Platform: Temporal Cloud\r\n","closedAt":"2024-08-16T20:58:43Z","comments":[{"id":"IC_kwDODN1w686Itnhw","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Hi Albert, Could you please open a support ticket and someone from our support team can reach out. We do not use github issue for cloud support.\r\n\r\nhttps://docs.temporal.io/cloud/support#zendesk-account","createdAt":"2024-08-16T14:53:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1594#issuecomment-2293659760","viewerDidAuthor":false},{"id":"IC_kwDODN1w686Iv3dz","author":{"login":"albertteoh"},"authorAssociation":"NONE","body":"Will do, thanks for the prompt response, @Quinn-With-Two-Ns!","createdAt":"2024-08-16T20:58:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/1594#issuecomment-2294249331","viewerDidAuthor":false}],"createdAt":"2024-08-16T11:28:27Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":1594,"reactionGroups":[],"state":"CLOSED","title":"Workflow replay error: lookup failed for scheduledEventID to activityID","updatedAt":"2024-08-16T20:58:43Z","url":"https://github.com/temporalio/sdk-go/issues/1594"}
