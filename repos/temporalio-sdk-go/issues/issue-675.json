{"assignees":[],"author":{"id":"MDQ6VXNlcjEwNjA4NzM=","is_bot":false,"login":"tminusplus","name":"Travis"},"body":"## Expected Behavior\r\nExecuting an activity with a defined StartToCloseTimeout, an undefined ScheduleToStartTimeout, and an undefined ScheduleToCloseTimeout raises an error.\r\n\r\nOriginally, we expected the workflow to continue retrying forever - but closer reading of the docs revealed that you must set either ScheduleToStartTimeout or ScheduleToCloseTimeout [here](https://pkg.go.dev/go.temporal.io/sdk@v1.12.0/internal#ActivityOptions). The doc can be confusing, because you have to read all three timeouts to know what must be set, if I understand it correctly.\r\n\r\nIt is possible that this behavior is expected, and just not clearly defined within the docs. I tried looking in the Go SDK docs and on temporal.io. Please let me know if that is the case! The fix is easy on our side but I wanted to report a bug as the behaviour surprised us.\r\n\r\n## Actual Behavior\r\nExecuting an activity with a defined StartToCloseTimeout, an undefined ScheduleToStartTimeout, and an undefined ScheduleToCloseTimeout does not raise an error and runs normally. Then if a WorkflowTaskTimedOut occurs, we observed this with a ScheduleToStart timeout type, the workflow task will fail and retryState will be set to `RetryPolicyNotSet`.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Execute a workflow with default WorkflowOptions.\r\n  1. In that workflow, execute an activity with only StartToCloseTimeout specified in ActivityOptions.\r\n  1. Return an error immediately within the activity task.\r\n  1. Spam the worker with these tasks so that one times out due to ScheduleToStartTimeout.\r\n  1. Once the workflow task times out due to ScheduleToStart, the workflow execution will fail.\r\n\r\n## Specifications\r\n\r\n  - Version: Temporal v1.12.3\r\n  - Platform: Linux, Golang SDK in-between v1.11.1 and v1.12.0, basically up to this PR https://github.com/temporalio/sdk-go/pull/632\r\n\r\n## Notes\r\n\r\nI wanted to provide some more info on this bug, so it is easier to reproduce. I am unable to share the full workflow logs, but can share some of the non-sensitive parts.\r\n\r\nWorkflow task started with:\r\n```\r\n        \"workflowExecutionTimeout\": \"0s\",\r\n        \"workflowRunTimeout\": \"0s\",\r\n        \"workflowTaskTimeout\": \"10s\",\r\n        \"attempt\": 1,\r\n        \"cronSchedule\": \"\",\r\n```\r\n\r\nActivity task started with:\r\n```\r\n        \"scheduleToCloseTimeout\": \"0s\",\r\n        \"scheduleToStartTimeout\": \"0s\",\r\n        \"startToCloseTimeout\": \"5s\",\r\n        \"heartbeatTimeout\": \"0s\",\r\n        \"retryPolicy\": {\r\n          \"nonRetryableErrorTypes\": [],\r\n          \"initialInterval\": \"1s\",\r\n          \"backoffCoefficient\": 2,\r\n          \"maximumInterval\": \"100s\",\r\n          \"maximumAttempts\": 0\r\n        }\r\n```\r\n\r\nActivity task failed with this, which is the error I was throwing to test live failures:\r\n```\r\n        \"lastFailure\": {\r\n          \"message\": \"testing job failure for metrics dashboard\",\r\n          \"source\": \"GoSDK\",\r\n          \"stackTrace\": \"\",\r\n          \"applicationFailureInfo\": {\r\n            \"type\": \"\",\r\n            \"nonRetryable\": false\r\n          },\r\n          \"failureInfo\": \"applicationFailureInfo\"\r\n        }\r\n```\r\n\r\nWorkflow task scheduled as sticky:\r\n```\r\n      \"workflowTaskScheduledEventAttributes\": {\r\n        \"taskQueue\": {\r\n          ...\r\n          \"kind\": \"Sticky\"\r\n        },\r\n        \"startToCloseTimeout\": \"10s\",\r\n        \"attempt\": 1\r\n      }\r\n```\r\n\r\nThen it timed out:\r\n```\r\n      \"eventType\": \"WorkflowTaskTimedOut\",\r\n      \"workflowTaskTimedOutEventAttributes\": {\r\n        \"scheduledEventId\": \"8\",\r\n        \"startedEventId\": \"0\",\r\n        \"timeoutType\": \"ScheduleToStart\"\r\n      }\r\n```\r\n\r\nAnd finally, it failed:\r\n```\r\n      \"workflowExecutionFailedEventAttributes\": {\r\n        \"failure\": {\r\n          \"message\": \"testing failure for metrics\",\r\n          \"source\": \"GoSDK\",\r\n          \"stackTrace\": \"\",\r\n          \"applicationFailureInfo\": {\r\n            \"type\": \"\",\r\n            \"nonRetryable\": false\r\n          }\r\n        },\r\n        \"retryState\": \"RetryPolicyNotSet\",\r\n      }\r\n```\r\n\r\nI tried root causing this, and I think it might be caused around here https://github.com/temporalio/temporal/blob/3de5687db2eda2ad8367beaff4c26e439c84f62c/service/history/commandChecker.go#L306","closedAt":"2023-07-31T13:09:54Z","comments":[{"id":"IC_kwDODN1w6847e_6u","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"The title says:\r\n\r\n> Specifying StartToCloseTimeout but no ScheduleToStartTimeout or ScheduleToCloseTimeout does not return an error\r\n\r\n> It is possible that this behavior is expected, and just not clearly defined within the docs.\r\n\r\nDefinitely expected behavior (and is expected across all SDKs, as it is enforced server side). Simply: At least one of `ScheduleToCloseTimeout` or `StartToCloseTimeout` is required. From the Godoc on `ActivityOptions` you linked (other stuff left off for clarity):\r\n\r\n```\r\n\t// Either this option or StartToClose is required: Defaults to unlimited.\r\n\tScheduleToCloseTimeout time.Duration\r\n\r\n\t// If ScheduleToClose is not provided then this timeout is required: Defaults to the ScheduleToCloseTimeout value.\r\n\tStartToCloseTimeout time.Duration\r\n```\r\n\r\nThis is also documented at https://docs.temporal.io/docs/go/how-to-set-activityoptions-in-go. We would be happy to make this clearer in any way you can think of. Suggestions?","createdAt":"2021-12-20T14:38:07Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/675#issuecomment-997981870","viewerDidAuthor":false},{"id":"IC_kwDODN1w6847mfjn","author":{"login":"tminusplus"},"authorAssociation":"NONE","body":"That makes sense, thank you for the clarification. The part that was confusing was these three comments from the godoc:\r\n```\r\n\t// ...\r\n\t// Either this option or StartToClose is required: Defaults to unlimited.\r\n\tScheduleToCloseTimeout time.Duration\r\n\r\n\t// ...\r\n\t// If ScheduleToClose is not provided then this timeout is required.\r\n\t// Optional: Defaults to unlimited.\r\n\tScheduleToStartTimeout time.Duration\r\n\r\n\t// ...\r\n\t// If ScheduleToClose is not provided then this timeout is required: Defaults to the ScheduleToCloseTimeout value.\r\n\tStartToCloseTimeout time.Duration\r\n```\r\n\r\nIt gave me the impression that if ScheduleToClose is not provided then both StartToClose and ScheduleToStart are required. Perhaps a potential improvement might be:\r\n```\r\n\t// ...\r\n\t// If StartToClose is not provided then this timeout or ScheduleToStart are required. \r\n        // Defaults to unlimited.\r\n\tScheduleToCloseTimeout time.Duration\r\n\r\n\t// ...\r\n\t// If StartToClose is not provided then this timeout or ScheduleToClose are required.\r\n\t// Optional: Defaults to unlimited.\r\n\tScheduleToStartTimeout time.Duration\r\n\r\n\t// ...\r\n\t// If ScheduleToClose or ScheduleToStart are not provided then this timeout is required.\r\n        // Defaults to the ScheduleToCloseTimeout value.\r\n\tStartToCloseTimeout time.Duration\r\n```","createdAt":"2021-12-22T23:53:41Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/675#issuecomment-999946471","viewerDidAuthor":false},{"id":"IC_kwDODN1w6847yxso","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"```\r\n\t// If StartToClose is not provided then this timeout or ScheduleToStart are required. \r\n        // Defaults to unlimited.\r\n\tScheduleToCloseTimeout time.Duration\r\n```\r\nI am not sure this is accurate. You must have at least one of `ScheduleToCloseTimeout` or `StartToCloseTimeout` timeout set. That requirement is unrelated to the `ScheduleToStartTimeout` requirement (at least from my reading, I may have to go confirm behavior).","createdAt":"2021-12-30T20:08:55Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/675#issuecomment-1003166504","viewerDidAuthor":false}],"createdAt":"2021-12-11T00:39:50Z","labels":[],"milestone":null,"number":675,"reactionGroups":[],"state":"CLOSED","title":"Specifying StartToCloseTimeout but no ScheduleToStartTimeout or ScheduleToCloseTimeout does not return an error","updatedAt":"2023-07-31T13:09:54Z","url":"https://github.com/temporalio/sdk-go/issues/675"}
