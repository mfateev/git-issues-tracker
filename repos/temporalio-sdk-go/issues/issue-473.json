{"assignees":[],"author":{"id":"MDQ6VXNlcjg2NDY2NTU=","is_bot":false,"login":"mfesenko","name":"Mary Fesenko"},"body":"## Expected Behavior\r\n- No workflow panics in worker logs\r\n- `Query` tab should load properly:\r\n![image](https://user-images.githubusercontent.com/8646655/122689984-2e7a6080-d22f-11eb-9caf-c0fec8e16eea.png)\r\n\r\n## Actual Behavior\r\n- Workflow panic in worker logs:\r\n```\r\n2021/06/21 01:17:37 ERROR Workflow panic Namespace default TaskQueue TEST_TASK_QUEUE WorkerID 75752@Marys-MacBook-Pro.local@ WorkflowType MyWorkflow WorkflowID my-workflow RunID bfbe63a0-5344-4641-8452-471445bce46c Attempt 1 Error lookup failed for scheduledEventID to activityID: scheduleEventID: 9, activityID: 9 StackTrace process event for TEST_TASK_QUEUE [panic]:\r\ngo.temporal.io/sdk/internal.panicIllegalState(...)\r\n        /Users/mary/work/temporal-examples/money-transfer-project-template-go/vendor/go.temporal.io/sdk/internal/internal_decision_state_machine.go:395\r\ngo.temporal.io/sdk/internal.(*commandsHelper).handleActivityTaskScheduled(0xc0000990e0, 0x206d5a8, 0x1, 0x9)\r\n        /Users/mary/work/temporal-examples/money-transfer-project-template-go/vendor/go.temporal.io/sdk/internal/internal_decision_state_machine.go:891 +0x165\r\ngo.temporal.io/sdk/internal.(*workflowExecutionEventHandlerImpl).ProcessEvent(0xc0004f6600, 0xc000146980, 0x1, 0x0, 0x0)\r\n        /Users/mary/work/temporal-examples/money-transfer-project-template-go/vendor/go.temporal.io/sdk/internal/internal_event_handlers.go:813 +0x42e\r\ngo.temporal.io/sdk/internal.(*workflowExecutionContextImpl).ProcessWorkflowTask(0xc00016e380, 0xc00047a8a0, 0x20b69a0, 0xc0001d4150, 0xc00016e380, 0x0)\r\n        /Users/mary/work/temporal-examples/money-transfer-project-template-go/vendor/go.temporal.io/sdk/internal/internal_task_handlers.go:875 +0x73c\r\ngo.temporal.io/sdk/internal.(*workflowTaskHandlerImpl).ProcessWorkflowTask(0xc0000dfe40, 0xc00047a8a0, 0xc000900900, 0x0, 0x0, 0x0, 0x0)\r\n        /Users/mary/work/temporal-examples/money-transfer-project-template-go/vendor/go.temporal.io/sdk/internal/internal_task_handlers.go:726 +0x739\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).processWorkflowTask(0xc0001abba0, 0xc00047a8a0, 0x0, 0x0)\r\n        /Users/mary/work/temporal-examples/money-transfer-project-template-go/vendor/go.temporal.io/sdk/internal/internal_task_pollers.go:286 +0x4ae\r\ngo.temporal.io/sdk/internal.(*workflowTaskPoller).ProcessTask(0xc0001abba0, 0x191bc00, 0xc00047a8a0, 0x1b84de0, 0xc0000421e0)\r\n        /Users/mary/work/temporal-examples/money-transfer-project-template-go/vendor/go.temporal.io/sdk/internal/internal_task_pollers.go:257 +0x85\r\ngo.temporal.io/sdk/internal.(*baseWorker).processTask(0xc0002120f0, 0x191b7c0, 0xc000408110)\r\n        /Users/mary/work/temporal-examples/money-transfer-project-template-go/vendor/go.temporal.io/sdk/internal/internal_worker_base.go:343 +0xba\r\ncreated by go.temporal.io/sdk/internal.(*baseWorker).runTaskDispatcher\r\n        /Users/mary/work/temporal-examples/money-transfer-project-template-go/vendor/go.temporal.io/sdk/internal/internal_worker_base.go:270 +0xff\r\n2021/06/21 01:17:37 WARN  Failed to process workflow task. Namespace default TaskQueue TEST_TASK_QUEUE WorkerID 75752@Marys-MacBook-Pro.local@ WorkflowType MyWorkflow WorkflowID my-workflow RunID bfbe63a0-5344-4641-8452-471445bce46c Attempt 1 Error lookup failed for scheduledEventID to activityID: scheduleEventID: 9, activityID: 9\r\n2021/06/21 01:17:37 INFO  Task processing failed with error Namespace default TaskQueue TEST_TASK_QUEUE WorkerID 75752@Marys-MacBook-Pro.local@ WorkerType WorkflowWorker Error Workflow executionsRow not found.  WorkflowId: TEST_TASK_QUEUE, RunId: 768d01d9-aabe-4ccf-9985-7af61f445403\r\n```\r\n- `Query` tab says that no queries are registered:\r\n![image](https://user-images.githubusercontent.com/8646655/122689995-4ce05c00-d22f-11eb-9533-8f38b82d6a9c.png)\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Run a workflow that contains two calls to `workflow.GetVersion` in a row:\r\n```\r\npackage app\r\n\r\nimport (\r\n\t\"context\"\r\n\t\"fmt\"\r\n\t\"time\"\r\n\r\n\t\"go.temporal.io/sdk/workflow\"\r\n)\r\n\r\nfunc MyWorkflow(ctx workflow.Context) error {\r\n\tctx = workflow.WithActivityOptions(ctx, workflow.ActivityOptions{\r\n\t\tStartToCloseTimeout: time.Minute,\r\n\t})\r\n\r\n\tworkflow.GetVersion(ctx, \"change-1\", workflow.DefaultVersion, 1)\r\n\r\n\tworkflow.GetVersion(ctx, \"change-2\", workflow.DefaultVersion, 1)\r\n\r\n\treturn workflow.ExecuteActivity(ctx, SendMessage, \"foo\").Get(ctx, nil)\r\n}\r\n\r\nfunc SendMessage(ctx context.Context, message string) error {\r\n\tfmt.Printf(\"Sending message '%s'\\n\", message)\r\n\treturn nil\r\n}\r\n``` \r\n  2. Open `Query` tab in Temporal UI\r\n  3. Check worker logs\r\n\r\n## Specifications\r\n\r\n  - Version: `1.7.0`, looks like it got broken somewhere between `1.2.0` and `1.3.0`\r\n\r\n","closedAt":"2021-06-21T16:51:34Z","comments":[{"id":"MDEyOklzc3VlQ29tbWVudDg2NTQ1NjM3Mw==","author":{"login":"vitarb"},"authorAssociation":"CONTRIBUTOR","body":"Also reported in https://community.temporal.io/t/panic-occurs-for-multiple-changeid/2334/12","createdAt":"2021-06-22T01:40:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/473#issuecomment-865456373","viewerDidAuthor":false}],"createdAt":"2021-06-20T22:28:35Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":473,"reactionGroups":[],"state":"CLOSED","title":"Workflow replay is broken if workflow contains multiple subsequent calls to GetVersion","updatedAt":"2021-06-22T01:40:46Z","url":"https://github.com/temporalio/sdk-go/issues/473"}
