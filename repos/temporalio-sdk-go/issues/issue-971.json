{"assignees":[{"id":"MDQ6VXNlcjk1NjM=","login":"robholland","name":"Rob Holland","databaseId":0}],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"**Is your feature request related to a problem? Please describe.**\r\n\r\nRight now our SDK relies on every API message which is not cool\r\n\r\n**Describe the solution you'd like**\r\n\r\nWe need to move the code gen for proxy and interceptor to https://github.com/temporalio/api-go.\r\n\r\nSpecifically in api-go we should add a `cmd/generateproxy` binary package that:\r\n\r\n* Does what `internal/cmd/generateproxy` does today _and_ what `internal/cmd/generateinterceptor` does (can just be two\r\n  methods called from top-level)\r\n* Make the `generateinterceptor` not rely on known package set (if you have to use the file system to walk the known\r\n  packages so be it). We want to be future proof for new packages.\r\n* Give this its own `go.mod` so that it can depend on `golang.org/x/tools/go` without forcing api-go to add that\r\n  directory.\r\n* Runs after protoc everytime api-go is regenerated\r\n\r\nThat tool should generate/overwrite package `go.temporal.io/api/proxy` (so basically just a `proxy` dir in `api-go`). It\r\nshould generate the following Go public API (can be broken up across files if needed) for the proxy:\r\n\r\n```go\r\npackage proxy\r\n\r\ntype WorkflowServiceProxyOptions struct {\r\n  Client workflowservice.WorkflowServiceClient\r\n}\r\n\r\nfunc NewWorkflowServiceProxyServer(options WorkflowServiceProxyOptions) (workflowservice.WorkflowServiceServer, error) {\r\n  // ...\r\n}\r\n```\r\n\r\nThis is exactly what's in `client` of the SDK today. As for the interceptor side, we need:\r\n\r\n```go\r\npackage proxy\r\n\r\ntype VisitPayloadOptions struct {\r\n  Visitor func(*common.Payload) error\r\n  SkipSearchAttributes bool\r\n}\r\n\r\nfunc VisitPayloads(msg proto.Message, options VisitPayloadOptions) error {\r\n  // ...\r\n}\r\n\r\ntype PayloadVisitorInterceptorOptions struct {\r\n  Outbound *VisitPayloadOptions\r\n  Inbound *VisitPayloadOptions\r\n}\r\n\r\nfunc NewPayloadVisitorInterceptor(options PayloadVisitorInterceptorOptions) (grpc.UnaryClientInterceptor, error) {\r\n  // ...\r\n}\r\n```\r\n\r\nDo what is needed behind the scenes to make that work. You'll want the unexported recursive function to take a pointer to those `VisitPayloadOptions` btw so as not to copy each recursion.\r\n\r\nFinally, just change the SDK to use this. The `client` package calls can just delegate to this. The `converter` stuff\r\ncan just delegate to this but make the payload codec encode/decode as the visitor.\r\n\r\n**Describe alternatives you've considered**\r\n\r\nReflection, but decided against.","closedAt":"2023-01-09T10:50:04Z","comments":[],"createdAt":"2022-12-01T21:57:16Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDky","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":971,"reactionGroups":[],"state":"CLOSED","title":"Move most interceptor/proxy-based code gen to api-go","updatedAt":"2023-01-09T10:50:04Z","url":"https://github.com/temporalio/sdk-go/issues/971"}
