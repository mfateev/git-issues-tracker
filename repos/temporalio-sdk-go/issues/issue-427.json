{"assignees":[],"author":{"is_bot":true,"login":"app/"},"body":"For a workflow in which I have few branches, I'd like to assert that an activity wasn't called\r\n\r\nI found this entry\r\n\r\nhttps://community.temporal.io/t/workflow-unit-tests-questions-why-use-dummy-activities-how-to-ensure-activity-was-not-called-how-to-create-an-instance-of-workflow-context/756\r\n\r\n## Expected Behavior\r\n\r\n```go\r\nenv.OnActivity(\"activity a\", mock.Anything).Panic(\":( this activity shouldn't  be called\")\r\n```\r\n\r\nShould return an error if the activity was called and the assert should **pass** if the activity wasn't called.\r\n\r\n## Actual Behavior\r\n\r\nThe assert is failing if the activity isn't called.\r\n\r\n## Steps to Reproduce the Problem\r\n\r\n  1. Create a Workflow with at least one conditional branch\r\n  2. Call a different activity on each branch\r\n  3. Create a test for one the branches adding an OnActivity(...).Panic(...) to test that the activity in the other branch is not called\r\n  4. Execute the test\r\n  \r\nHere is an example\r\n\r\n```go\r\npackage dummy\r\n\r\nimport (\r\n\t\"github.com/stretchr/testify/mock\"\r\n\t\"github.com/stretchr/testify/suite\"\r\n\t\"go.temporal.io/sdk/activity\"\r\n\t\"go.temporal.io/sdk/testsuite\"\r\n\t\"go.temporal.io/sdk/workflow\"\r\n\t\"testing\"\r\n\t\"time\"\r\n)\r\n\r\nconst (\r\n\tActivityA = \"Activity_a\"\r\n\tActivityB = \"Activity_b\"\r\n\tActivityC = \"Activity_c\"\r\n)\r\n\r\ntype Result struct {\r\n\tValue string\r\n}\r\n\r\nfunc Process(ctx workflow.Context, b bool) error {\r\n\r\n\tvar r Result\r\n\r\n\taCtx := workflow.WithActivityOptions(ctx, workflow.ActivityOptions{\r\n\t\tScheduleToStartTimeout: time.Second,\r\n\t\tScheduleToCloseTimeout: time.Second,\r\n\t})\r\n\r\n\tif b {\r\n\t\tif err := workflow.ExecuteActivity(aCtx, ActivityA, \"foo\").Get(ctx, &r); err != nil {\r\n\t\t\treturn err\r\n\t\t}\r\n\t} else {\r\n\t\tif err := workflow.ExecuteActivity(aCtx, ActivityB, \"bar\").Get(ctx, &r); err != nil {\r\n\t\t\treturn err\r\n\t\t}\r\n\t}\r\n\r\n\treturn workflow.ExecuteActivity(aCtx, ActivityC, r).Get(ctx, nil)\r\n}\r\n\r\ntype Suite struct {\r\n\tsuite.Suite\r\n\ttestsuite.WorkflowTestSuite\r\n\r\n\tenv      *testsuite.TestWorkflowEnvironment\r\n}\r\n\r\nfunc TestSuite(t *testing.T) {\r\n\tsuite.Run(t, new(Suite))\r\n}\r\n\r\nfunc (s *Suite) AfterTest(suiteName, testName string) {\r\n\ts.env.AssertExpectations(s.T())\r\n}\r\n\r\nfunc (s *Suite) SetupTest() {\r\n\ts.env = s.NewTestWorkflowEnvironment()\r\n\r\n\tdummy := func(interface{}) (interface{}, error) { return nil, nil }\r\n\r\n\ts.env.RegisterActivityWithOptions(dummy, activity.RegisterOptions{\r\n\t\tName: ActivityA,\r\n\t})\r\n\r\n\ts.env.RegisterActivityWithOptions(dummy, activity.RegisterOptions{\r\n\t\tName: ActivityB,\r\n\t})\r\n\r\n\ts.env.RegisterActivityWithOptions(func(interface{}) error { return nil }, activity.RegisterOptions{\r\n\t\tName: ActivityC,\r\n\t})\r\n}\r\n\r\nfunc (s *Suite) TestBranchA() {\r\n\ts.env.OnActivity(ActivityA, mock.Anything).Return(&Result{Value: \"A Result OK\"}, nil).Once()\r\n\ts.env.OnActivity(ActivityB, mock.Anything).Panic(\":( unexpected activity call\")\r\n\ts.env.OnActivity(ActivityC, mock.Anything).Return(nil).Once()\r\n\r\n\ts.env.ExecuteWorkflow(Process, true)\r\n\ts.True(s.env.IsWorkflowCompleted())\r\n\ts.Nil(s.env.GetWorkflowError())\r\n}\r\n```\r\n\r\n```\r\n2021/05/04 22:09:54 DEBUG handleActivityResult: *workflowservice.RespondActivityTaskCompletedRequest. ActivityID 1 ActivityType Activity_a\r\n2021/05/04 22:09:54 DEBUG handleActivityResult: *workflowservice.RespondActivityTaskCompletedRequest. ActivityID 2 ActivityType Activity_c\r\n    workflow_testsuite.go:793: PASS:\tActivity_a(string)\r\n    workflow_testsuite.go:793: FAIL:\tActivity_b(string)\r\n        \t\tat: [workflow_testsuite.go:308 dummt_test.go:80]\r\n    workflow_testsuite.go:793: PASS:\tActivity_c(string)\r\n    workflow_testsuite.go:793: FAIL: 2 out of 3 expectation(s) were met.\r\n        \tThe code you are testing needs to make 1 more call(s).\r\n        \tat: [workflow_testsuite.go:793 dummt_test.go:57 suite.go:137 suite.go:159]\r\n--- FAIL: TestSuite (0.00s)\r\n    --- FAIL: TestSuite/TestBranchA (0.00s)\r\n\r\n```\r\n\r\n## Specifications\r\n\r\n  - Version: 1.6.0\r\n","closedAt":"2021-05-05T22:34:21Z","comments":[],"createdAt":"2021-05-04T23:35:26Z","labels":[{"id":"MDU6TGFiZWwyMDUzODEzNTY0","name":"potential-bug","description":"","color":"90c109"}],"milestone":null,"number":427,"reactionGroups":[],"state":"CLOSED","title":"Test that an activity wasn't called","updatedAt":"2021-05-05T22:34:21Z","url":"https://github.com/temporalio/sdk-go/issues/427"}
