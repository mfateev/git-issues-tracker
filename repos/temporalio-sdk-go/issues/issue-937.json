{"assignees":[],"author":{"id":"MDQ6VXNlcjE0NjM2MjI=","is_bot":false,"login":"mfateev","name":"Maxim Fateev"},"body":"**Is your feature request related to a problem? Please describe.**\r\nWhen a worker that owns a session is restarted, the session fails and returns an error to the workflow that created the session.\r\nThis creates a problem. For many use cases, a restart of a worker is not a problem as the shared state is cached on the host disk, and the session should continue as if nothing happened. For these use cases, the session should fail only if the worker is down for a while, which indicates the host failure.\r\n\r\n**Describe the solution you'd like**\r\nSupport special worker id that is durable across restarts and can be used to re-establish a session.\r\nIntroduce a timeout that would support automatic session reestablishing in case of worker restarts. \r\n\r\n","closedAt":null,"comments":[{"id":"IC_kwDODN1w685MyE_c","author":{"login":"AhmedMozaly"},"authorAssociation":"NONE","body":"The current session implementation assumes that the state is temporarily preserved in the worker. Causing the session to fail when the worker restart.\r\n\r\nIn real-life scenarios, I think the common usage of sessions is just to route workflow activities to the same worker. As the state is mostly persisted on worker disk. So, I would vote for splitting the session concept into two concepts:\r\n\r\n* `Session` which keeps the currently implemented behavior\r\n* `DurableSession` Should NOT fail on worker restart. just retry activities on the same worker after restart. (I claim that this is the more common usage for sessions)\r\n\r\nThese two concepts can also be just an option passed to the session when being created.","createdAt":"2022-10-23T20:36:50Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-go/issues/937#issuecomment-1288196060","viewerDidAuthor":false},{"id":"IC_kwDODN1w685hTHoX","author":{"login":"F1bonacc1"},"authorAssociation":"NONE","body":"Hi,\r\n\r\nAs part of my workflow in kubernetes, I need to drain all the nodes one by one.\r\nThere is no way to avoid the worker pod being restarted.\r\nIs there any update on this issue?","createdAt":"2023-07-12T12:01:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/937#issuecomment-1632401943","viewerDidAuthor":false},{"id":"IC_kwDODN1w685hat3U","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Hi @F1bonacc1 ,\r\n\r\nThere is no update on this issue. The best way to achieve similar behaviour is to create a task queue per worker. Then you assign consistent task queue across restarts.\r\n\r\nWe show how to create per task queue workers [here](https://github.com/temporalio/samples-go/tree/main/activities-sticky-queues)","createdAt":"2023-07-13T14:55:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/937#issuecomment-1634393556","viewerDidAuthor":false},{"id":"IC_kwDODN1w685hbi2P","author":{"login":"AhmedMozaly"},"authorAssociation":"NONE","body":"Using `a task queue per worker` won't be the best solution when `retry on another worker if the current one dies`\r\nWhat we came up with. Is to use mix of both session & task queue per worker:\r\n* Each worker would listen on two task queues `public-queue` & `unique-queue-per-worker` \r\n* Use a session for the whole workflow\r\n* The first activity in the workflow would choose the right task queue to use for all following activities \r\n* If the worker dies, the whole workflow would be retried\r\n* When a retries happens, the first activity would choose a task queue for a healthy worker \r\n","createdAt":"2023-07-13T17:12:55Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/937#issuecomment-1634610575","viewerDidAuthor":false},{"id":"IC_kwDODN1w685sCfJX","author":{"login":"mohamedazouz"},"authorAssociation":"NONE","body":"@AhmedMozaly I think this example of [session-failure](https://github.com/temporalio/samples-go/tree/main/session-failure) by @Quinn-With-Two-Ns, is much much easier and straight forward than having a workaround task queues.","createdAt":"2023-11-15T14:02:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/937#issuecomment-1812591191","viewerDidAuthor":false},{"id":"IC_kwDODN1w685sWTVl","author":{"login":"AhmedMozaly"},"authorAssociation":"NONE","body":"@mohamedazouz [session-failure](https://github.com/temporalio/samples-go/tree/main/session-failure) by @Quinn-With-Two-Ns, is easier for simpler requirements.\r\n\r\nWe had a scenario with more requirements:\r\n*  if the worker is restarted (for example due to new version release) we need to fail the session but retry **on the same** worker\r\n* if the worker dies, fail the session and retry on any other worker\r\n\r\nIt would be great to see this scenario has built-in support in Temporal ","createdAt":"2023-11-19T08:28:04Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-go/issues/937#issuecomment-1817785701","viewerDidAuthor":false},{"id":"IC_kwDODN1w685sZdA-","author":{"login":"mohamedazouz"},"authorAssociation":"NONE","body":"@AhmedMozaly I agree, I think this should come as native functionality when a session failed should be restarted as a whole in new or previous worker based on options","createdAt":"2023-11-20T09:33:52Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-go/issues/937#issuecomment-1818611774","viewerDidAuthor":false}],"createdAt":"2022-10-21T01:00:29Z","labels":[{"id":"MDU6TGFiZWwxNjIyNzA3NDky","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":937,"reactionGroups":[],"state":"OPEN","title":"Add ability to keep session open in case of a worker restart.","updatedAt":"2024-12-16T20:49:52Z","url":"https://github.com/temporalio/sdk-go/issues/937"}
