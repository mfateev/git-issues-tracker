{"assignees":[],"author":{"id":"U_kgDOCUzmLQ","is_bot":false,"login":"eukladchikov-bigw","name":"Ev"},"body":"### What are you really trying to do?\r\n\r\nI am upgrading our microservice from Temporal 1.0.0 to 1.1.1 and see that some unit tests fail because they stuck on Workflow.WaitConditionAsync, but downgrading back to 1.0.0 or to 1.1.0 solves the issue\r\n\r\n### Describe the bug\r\n\r\nWorkflow.WaitConditionAsync sometimes hangs probably by a blocked thread caused by this pull request https://github.com/temporalio/sdk-dotnet/pull/242 \r\n\r\nI created a generic test that reproduces the bug for Temporal 1.1.1 and works fine downgrading to 1.1.0\r\n\r\nIn my test it is getting stuck on workflow line:\r\n`await Workflow.WaitConditionAsync(() => _preorderCount == n);`\r\n\r\n\r\n### Minimal Reproduction\r\n\r\nI use Visual Studio 2022 to run it\r\n.NET Project file:\r\n\r\n```\r\n<Project Sdk=\"Microsoft.NET.Sdk\">\r\n\r\n  <PropertyGroup>\r\n    <TargetFramework>net7.0</TargetFramework>\r\n    <ImplicitUsings>enable</ImplicitUsings>\r\n    <Nullable>enable</Nullable>\r\n\r\n    <IsPackable>false</IsPackable>\r\n  </PropertyGroup>\r\n\r\n  <ItemGroup>\r\n\t<PackageReference Include=\"FluentValidation\" Version=\"11.7.1\" />\r\n\t<PackageReference Include=\"Microsoft.Extensions.DependencyInjection\" Version=\"7.0.0\" />\r\n\t<PackageReference Include=\"Shouldly\" Version=\"4.2.1\" />\r\n\t<PackageReference Include=\"Temporalio\" Version=\"1.1.1\" />\r\n    <PackageReference Include=\"Microsoft.NET.Test.Sdk\" Version=\"17.3.2\" />\r\n    <PackageReference Include=\"xunit\" Version=\"2.4.2\" />\r\n    <PackageReference Include=\"xunit.runner.visualstudio\" Version=\"2.4.5\">\r\n      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>\r\n      <PrivateAssets>all</PrivateAssets>\r\n    </PackageReference>\r\n    <PackageReference Include=\"coverlet.collector\" Version=\"3.1.2\">\r\n      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>\r\n      <PrivateAssets>all</PrivateAssets>\r\n    </PackageReference>\r\n  </ItemGroup>\r\n\r\n</Project>\r\n```\r\n\r\nUnit test .cs file:\r\n\r\n```\r\nusing Microsoft.Extensions.DependencyInjection;\r\nusing Microsoft.Extensions.Logging;\r\nusing Microsoft.Extensions.Logging.Abstractions;\r\nusing Shouldly;\r\nusing System.Collections.Concurrent;\r\nusing System.Diagnostics;\r\nusing System.Reflection;\r\nusing Temporalio.Activities;\r\nusing Temporalio.Client;\r\nusing Temporalio.Testing;\r\nusing Temporalio.Worker;\r\nusing Temporalio.Workflows;\r\n\r\nnamespace TemporalWaitConditionAsyncIssue;\r\n\r\npublic class UnitTest1\r\n{\r\n\tprivate ServiceProvider? _serviceProvider;\r\n\tprivate TemporalWorker? _temporalWorker;\r\n\r\n\tpublic WorkflowEnvironment? WorkflowEnvironment { get; private set; }\r\n\r\n\t[Fact]\r\n\tpublic async Task Should_WaitForPreorderCount()\r\n\t{\r\n\t\tClearTemporalCache();\r\n\t\tawait StartWorkflowEnvironment(false);\r\n\t\tvar wfId = Guid.NewGuid().ToString();\r\n\t\tawait StartTemporal(wfId);\r\n\t\tvar workflowClient = CreateWorkflowClient(wfId);\r\n\r\n\t\t// Act\r\n\t\tfor (int i = 0; i < GenericWorkflow1.ConditionCount; i++)\r\n\t\t{\r\n\t\t\tawait workflowClient.SignalPreorderConsignmentReady(wfId);\r\n\t\t\tawait Task.Delay(TimeSpan.FromSeconds(1));\r\n\t\t}\r\n\r\n\t\tawait Task.Delay(TimeSpan.FromSeconds(5));\r\n\r\n\t\t// Assert\r\n\t\tGenericWorkflow1.Finished.ShouldBeTrue();\r\n\t}\r\n\r\n\tprivate void ClearTemporalCache()\r\n\t{\r\n\t\tvar cachedDefinitionsField = typeof(ActivityDefinition)\r\n\t\t\t.GetField(\"CachedDefinitions\", BindingFlags.NonPublic | BindingFlags.Static)\r\n\t\t\t?.GetValue(null);\r\n\r\n\t\tvar activityCache = cachedDefinitionsField as ConcurrentDictionary<MethodInfo, ActivityDefinition>;\r\n\t\tactivityCache?.Clear();\r\n\t}\r\n\tprivate async Task StartWorkflowEnvironment(bool withTimeSkipping)\r\n\t{\r\n\t\tWorkflowEnvironment = withTimeSkipping\r\n\t\t\t? await WorkflowEnvironment.StartTimeSkippingAsync(new WorkflowEnvironmentStartTimeSkippingOptions { })\r\n\t\t\t: await WorkflowEnvironment.StartLocalAsync();\r\n\t}\r\n\r\n\tprivate async Task StartTemporal(string taskQueue)\r\n\t{\r\n\t\tawait StartWorkerService(taskQueue, configureOptions: options =>\r\n\t\t{\r\n\t\t\toptions\r\n\t\t\t\t.AddWorkflow<GenericWorkflow1>();\r\n\t\t});\r\n\r\n\t\tvar workflowId = GenericWorkflow1.GetWorkflowId(taskQueue);\r\n\t\tvar options = new WorkflowOptions\r\n\t\t{\r\n\t\t\tId = workflowId,\r\n\t\t\tTaskQueue = taskQueue,\r\n\t\t};\r\n\r\n\t\tawait WorkflowEnvironment!.Client.StartWorkflowAsync<GenericWorkflow1>(\r\n\t\t\twf => wf.RunAsync(),\r\n\t\t\toptions);\r\n\t}\r\n\r\n\tprivate async Task StartWorkerService(\r\n\t\tstring taskQueue = \"default\",\r\n\t\tAction<TemporalWorkerOptions>? configureOptions = null)\r\n\t{\r\n\t\t_temporalWorker?.Dispose();\r\n\r\n\t\tif (_serviceProvider != null) await _serviceProvider.DisposeAsync();\r\n\t\tif (WorkflowEnvironment == null)\r\n\t\t{\r\n\t\t\tthrow new InvalidOperationException(\"The workflow environment has not been started. Precede this call with a call to StartWorkflowEnvironment.\");\r\n\t\t}\r\n\r\n\t\tvar serviceCollection = new ServiceCollection();\r\n\r\n\t\tif (configureOptions == null)\r\n\t\t{\r\n\t\t\t_serviceProvider = serviceCollection.BuildServiceProvider();\r\n\t\t}\r\n\t\telse\r\n\t\t{\r\n\t\t\t_serviceProvider = serviceCollection.BuildServiceProvider();\r\n\r\n\t\t\tvar workerOptions = new TemporalWorkerOptions(taskQueue)\r\n\t\t\t{\r\n\t\t\t\tLoggerFactory = new NullLoggerFactory(),\r\n\t\t\t\tDebugMode = Debugger.IsAttached\r\n\t\t\t};\r\n\r\n\t\t\tconfigureOptions(workerOptions);\r\n\r\n\t\t\t_temporalWorker = new TemporalWorker(\r\n\t\t\t\tWorkflowEnvironment.Client,\r\n\t\t\t\tworkerOptions);\r\n\r\n\t\t\t// Do not await this task as it will block the test execution\r\n#pragma warning disable CS4014\r\n\t\t\t_temporalWorker.ExecuteAsync(CancellationToken.None);\r\n#pragma warning restore CS4014\r\n\t\t}\r\n\t}\r\n\r\n\tprivate GenericWorkflowClient CreateWorkflowClient(string taskQueue = \"default\")\r\n\t{\r\n\t\tif (WorkflowEnvironment == null)\r\n\t\t{\r\n\t\t\tthrow new InvalidOperationException(\"The workflow environment has not been started. Precede this call with a call to StartWorkflowEnvironment.\");\r\n\t\t}\r\n\r\n\t\treturn new GenericWorkflowClient(WorkflowEnvironment.Client);\r\n\r\n\t}\r\n}\r\n\r\n[Workflow]\r\npublic class GenericWorkflow1\r\n{\r\n\tpublic const int ConditionCount = 2;\r\n\tpublic static bool Finished = false;\r\n\r\n\tprivate int _preorderCount = 0;\r\n\r\n\tpublic static string GetWorkflowId(string orderId)\r\n\t{\r\n\t\treturn $\"{orderId}\";\r\n\t}\r\n\r\n\t[WorkflowRun]\r\n\tpublic async Task RunAsync()\r\n\t{\r\n\t\tint n = ConditionCount;\r\n\r\n\t\tfor (int i = 0; i < n; i++)\r\n\t\t{\r\n\t\t\tawait Workflow.WaitConditionAsync(() => _preorderCount > i && _preorderCount <= n);\r\n\t\t}\r\n\r\n\t\tawait Workflow.WaitConditionAsync(() => _preorderCount == n);\r\n\r\n\t\tFinished = true;\r\n\r\n\t}\r\n\r\n\t[WorkflowSignal]\r\n\tpublic Task PreorderReady()\r\n\t{\r\n\t\t_preorderCount++;\r\n\t\treturn Task.CompletedTask;\r\n\t}\r\n}\r\n\r\npublic class GenericWorkflowClient\r\n{\r\n\tprivate readonly ITemporalClient _client;\r\n\r\n\tpublic GenericWorkflowClient(ITemporalClient client)\r\n\t{\r\n\t\t_client = client;\r\n\t}\r\n\r\n\tpublic async Task SignalPreorderConsignmentReady(string wfId)\r\n\t{\r\n\t\tvar workflowId = GenericWorkflow1.GetWorkflowId(wfId);\r\n\r\n\t\tawait _client.StartWorkflowAsync<GenericWorkflow1>(\r\n\t\t\t\twf => wf.RunAsync(),\r\n\t\t\t\tnew WorkflowOptions(workflowId, wfId)\r\n\t\t\t\t{\r\n\t\t\t\t\tStartSignal = nameof(GenericWorkflow1.PreorderReady),\r\n\t\t\t\t\tStartSignalArgs = Array.Empty<object>()\r\n\t\t\t\t});\r\n\t}\r\n}\r\n```\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: x86 Windows\r\n- Temporalio Version 1.1.1\r\n- Using nuget package and Visual Studio 2022\r\n\r\n### Additional context\r\n\r\nSuspect these changes https://github.com/temporalio/sdk-dotnet/pull/242 \r\n","closedAt":"2024-06-07T13:36:01Z","comments":[{"id":"IC_kwDOInL6Hs6AAB94","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Yes, this is a known bug we accidentally caused. You can downgrade to 1.1.0 or wait until an patch release (today or tomorrow) coming when #259 is merged.","createdAt":"2024-06-04T13:06:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/263#issuecomment-2147491704","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6AcHzj","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"This should now be fixed with 1.1.2.","createdAt":"2024-06-07T13:36:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/263#issuecomment-2154855651","viewerDidAuthor":false}],"createdAt":"2024-06-04T09:28:26Z","labels":[{"id":"LA_kwDOInL6Hs8AAAABJH7zkA","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":263,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Workflow.WaitConditionAsync may be blocked in Temporal 1.1.1 and will never be passed even when condition is true","updatedAt":"2024-06-07T13:36:02Z","url":"https://github.com/temporalio/sdk-dotnet/issues/263"}
