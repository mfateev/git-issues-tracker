{"assignees":[],"author":{"id":"MDQ6VXNlcjIwODQ4NDk1","is_bot":false,"login":"plaisted","name":"Michael Plaisted"},"body":"### What are you really trying to do?\r\n\r\nUse local test server with time skipping to unit test workflows.\r\n\r\n### Describe the bug\r\n\r\nWhen attempting to run tests using the local test server the workflow throws `System.InvalidOperationException : Event set unexpectedly empty` on calling `GetResultAsync()` on the `WorkflowHandle`.  Additionally calls to `WorkflowEnvironment.DelayAsync()` wait real time which I would expect to finish immediately and advance worfklow time. \r\n\r\n### Minimal Reproduction\r\n\r\n```csharp\r\npublic class WorkflowTests\r\n{\r\n    private static TemporalWorker GetWorker(IWorkerClient client)\r\n    {\r\n        return new TemporalWorker(client, new()\r\n        {\r\n            TaskQueue = $\"tq-{Guid.NewGuid()}\",\r\n            Activities = { },\r\n            Workflows = { typeof(ExampleWorkflow) },\r\n        });\r\n    }\r\n    [Fact]\r\n    public async Task It_Dedups_Inside_Window()\r\n    {\r\n        await using var env = await WorkflowEnvironment.StartTimeSkippingAsync();\r\n        \r\n        using var worker = GetWorker(env.Client);\r\n\r\n        var id = \"unit-test\";\r\n\r\n        await worker.ExecuteAsync(async () =>\r\n        {\r\n            var wfA = await StartWorkflow(\"A\");\r\n\r\n            // this waits real time, not skipped,\r\n            // I have tried combinations of time skipping or WithAutoTimeSkippingDisabled for the call but always get a real wait\r\n            await env.DelayAsync(TimeSpan.FromSeconds(10));  \r\n\r\n            var wfB = await StartWorkflow(\"B\");\r\n            \r\n            var rA = await wfA.GetResultAsync(); // this throws `System.InvalidOperationException : Event set unexpectedly empty`\r\n            var rB = await wfB.GetResultAsync();\r\n\r\n            Assert.Equal(rA, rB);\r\n        });\r\n\r\n       \r\n\r\n        async Task<WorkflowHandle<string>> StartWorkflow(string req)\r\n        {\r\n            return await env!.Client.StartWorkflowAsync(\r\n                ExampleWorkflow.Ref.RunAsync,\r\n                (string?)null,\r\n                new WorkflowOptions\r\n                {\r\n                    ID = \"dedup:\" + id,\r\n                    TaskQueue = \"demo-tasks\",\r\n                    StartSignal = \"AddValue\",\r\n                    StartSignalArgs = new List<object> { req }\r\n                });\r\n        }\r\n    }\r\n}\r\n\r\n\r\n[Workflow]\r\npublic class ExampleWorkflow\r\n{\r\n    private static TimeSpan DedupDelay = TimeSpan.FromSeconds(15);\r\n    private static TimeSpan MaxDelay = TimeSpan.FromSeconds(30);\r\n    public static readonly ExampleWorkflow Ref = WorkflowRefs.Create<ExampleWorkflow>();\r\n\r\n    private string? value = null;\r\n    private DateTime lastMessage;\r\n\r\n    [WorkflowRun]\r\n    public async Task<string> RunAsync(string? trigger)\r\n    {\r\n        var firstTime = lastMessage = Workflow.UtcNow;\r\n        value = trigger;\r\n\r\n        var max = Workflow.DelayAsync(MaxDelay);\r\n\r\n        while (true)\r\n        {\r\n            var initial = lastMessage;\r\n            var waitWindow = DedupDelay - (Workflow.UtcNow - lastMessage);\r\n            Workflow.Logger.LogInformation(\"[{EventName}] {Seconds} seconds\", \"DedupWait\", waitWindow.TotalSeconds);\r\n            var window = Workflow.DelayAsync(waitWindow);\r\n            var finished = await Task.WhenAny(window, max);\r\n            if (finished == max)\r\n            {\r\n                Workflow.Logger.LogInformation(\"[{EventName}]\", \"MaxDurationExceeded\");\r\n                break;\r\n            }\r\n            else if (initial == lastMessage)\r\n            {\r\n                Workflow.Logger.LogInformation(\"[{EventName}]\", \"WaitPeriodFinished\");\r\n                break;\r\n            }\r\n        }\r\n\r\n        if (value == null)\r\n        {\r\n            throw new ApplicationException(\"No value\");\r\n        }\r\n        var used = value;\r\n        value = null;\r\n\r\n        // simiulate work\r\n        await Workflow.DelayAsync(5000);\r\n\r\n        // catch signal that happend when work happening\r\n        if (value != null)\r\n        {\r\n            Workflow.Logger.LogInformation(\"[{EventName}] Starting new WF\", \"ExtraMessages\");\r\n            throw Workflow.CreateContinueAsNewException(Ref.RunAsync, value);\r\n        }\r\n        return used;\r\n    }\r\n\r\n    [WorkflowSignal]\r\n    public Task AddValue(string signal)\r\n    {\r\n        Workflow.Logger.LogInformation(\"[{EventName}] {DateTime}\", \"NewValue\", Workflow.UtcNow);\r\n        value = signal;\r\n        lastMessage = Workflow.UtcNow;\r\n        return Task.CompletedTask;\r\n    }\r\n}\r\n```\r\n\r\n### Environment/Versions\r\n\r\n- Windows 11, x64\r\n- Temporal Version: 0.1.0-alpha4 (sdk-dotnet)\r\n","closedAt":"2023-05-25T20:18:57Z","comments":[{"id":"IC_kwDOInL6Hs5br8GI","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks! I will replicate and try to fix soon.\r\n\r\n>  // this waits real time, not skipped,\r\n>  // I have tried combinations of time skipping or WithAutoTimeSkippingDisabled for the call but always get a real wait\r\n\r\nWe only auto-skip when you wait on workflow result and no activities are running. If you want to start auto-skipping, start the `GetResultAsync` earlier (can be backgrounded or whatever). You can call `DelayAsync` on the env to manually skip time though.","createdAt":"2023-05-08T12:03:27Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/63#issuecomment-1538245000","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5bt-lO","author":{"login":"plaisted"},"authorAssociation":"NONE","body":"Okay, that makes sense. The `DelayAsync` on env was waiting the real time in this case so may be a problem there as well.","createdAt":"2023-05-08T17:43:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/63#issuecomment-1538779470","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5buHd7","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":":+1: Will attempt to replicate then fix (may be a bit due to conflicting priorities)","createdAt":"2023-05-08T18:08:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/63#issuecomment-1538815867","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5dL271","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"The unset-event issue will be solved with #78, so I have opened #77 for the fact that delay is real time and not properly skipping.","createdAt":"2023-05-25T19:14:40Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/63#issuecomment-1563389685","viewerDidAuthor":false}],"createdAt":"2023-05-06T22:56:00Z","labels":[{"id":"LA_kwDOInL6Hs8AAAABJH7zkA","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":63,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Local time skipping test server throws `Event set unexpectedly empty`","updatedAt":"2023-05-25T20:18:57Z","url":"https://github.com/temporalio/sdk-dotnet/issues/63"}
