{"assignees":[{"id":"MDQ6VXNlcjQ0Njg3NDMz","login":"jmaeagle99","name":"Justin Anderson","databaseId":0}],"author":{"id":"MDQ6VXNlcjQ0Njg3NDMz","is_bot":false,"login":"jmaeagle99","name":"Justin Anderson"},"body":"### Describe the bug\n\nCI tests on `main` branch have been running into test host process crashes. The following are examples of workflow runs with the crash and their corresponding change:\n| Date | Job | Variant | Commit |\n|---|---|---|---|\n| 2025-12-12 | https://github.com/temporalio/sdk-dotnet/actions/runs/20175327021/job/57921738811 | ubuntu-arm | https://github.com/temporalio/sdk-dotnet/commit/79d44c3472bc77fe3e294bf5b9cfe01fdf896527 |\n| 2025-12-10 | https://github.com/temporalio/sdk-dotnet/actions/runs/20110892146/job/57707557020 | ubuntu-arm | https://github.com/temporalio/sdk-dotnet/commit/2149661d87fb6cf091066d1f6b6056e486696240 |\n| 2025-12-02 | https://github.com/temporalio/sdk-dotnet/actions/runs/19900160973/job/57041412266 | ubuntu-arm | https://github.com/temporalio/sdk-dotnet/commit/549285ab87773de9120704b788116f957d76b03a |\n| 2025-11-17 | https://github.com/temporalio/sdk-dotnet/actions/runs/19445103513/job/55637681567 | macos-intel | https://github.com/temporalio/sdk-dotnet/commit/5161e0bc814baf0e382cc4e80c465c1e3d2d9669 |\n| 2025-11-07 | https://github.com/temporalio/sdk-dotnet/actions/runs/19186311432/job/54853416545 | ubuntu-arm | https://github.com/temporalio/sdk-dotnet/commit/31e754f863a815cc9563d4c85df69c8426f42aa8 |\n\nThe test that was running when the crash occurs is not consistent across runs.","closedAt":"2026-01-06T17:17:54Z","comments":[{"id":"IC_kwDOInL6Hs7a5yZL","author":{"login":"jmaeagle99"},"authorAssociation":"MEMBER","body":"The lastest test run exhibiting this issue has one or two threads with the following stack on it, which may be the cause of the crash:\n\n```bash\n        Child SP               IP Call Site\n0000FF43E2CBD520 0000ff4862c80bdc [InlinedCallFrame: 0000ff43e2cbd520] Temporalio.Bridge.Interop.Methods.temporal_core_worker_complete_workflow_activation(Temporalio.Bridge.Interop.TemporalCoreWorker*, Temporalio.Bridge.Interop.TemporalCoreByteArrayRef, Void*, IntPtr)\n0000FF43E2CBD520 0000ff482abf9078 [InlinedCallFrame: 0000ff43e2cbd520] Temporalio.Bridge.Interop.Methods.temporal_core_worker_complete_workflow_activation(Temporalio.Bridge.Interop.TemporalCoreWorker*, Temporalio.Bridge.Interop.TemporalCoreByteArrayRef, Void*, IntPtr)\n0000FF43E2CBD510 0000FF482ABF9078 ILStubClass.IL_STUB_PInvoke(Temporalio.Bridge.Interop.TemporalCoreWorker*, Temporalio.Bridge.Interop.TemporalCoreByteArrayRef, Void*, IntPtr)\n0000FF43E2CBD620 0000FF482ABF2DF8 Temporalio.Bridge.Worker+<CompleteWorkflowActivationAsync>d__18.MoveNext()\n0000FF43E2CBD720 0000FF482B115C94 System.Runtime.CompilerServices.AsyncTaskMethodBuilder.Start[[System.__Canon, System.Private.CoreLib]](System.__Canon ByRef)\n0000FF43E2CBD760 0000FF482ABF2AC4 Temporalio.Bridge.Worker.CompleteWorkflowActivationAsync(Temporalio.Bridge.Api.WorkflowCompletion.WorkflowActivationCompletion)\n0000FF43E2CBD7B0 0000FF482AC7C220 Temporalio.Worker.WorkflowWorker+<HandleCacheEvictionAsync>d__12.MoveNext()\n0000FF43E2CBD950 0000FF482B115C94 System.Runtime.CompilerServices.AsyncTaskMethodBuilder.Start[[System.__Canon, System.Private.CoreLib]](System.__Canon ByRef)\n0000FF43E2CBD990 0000FF482AC7BC50 Temporalio.Worker.WorkflowWorker.HandleCacheEvictionAsync(Temporalio.Bridge.Api.WorkflowActivation.WorkflowActivation, Temporalio.Bridge.Api.WorkflowActivation.RemoveFromCache)\n0000FF43E2CBD9E0 0000FF482ABD3C84 Temporalio.Worker.WorkflowWorker+<HandleActivationAsync>d__11.MoveNext()\n0000FF43E2CBE160 0000FF482B115C94 System.Runtime.CompilerServices.AsyncTaskMethodBuilder.Start[[System.__Canon, System.Private.CoreLib]](System.__Canon ByRef)\n0000FF43E2CBE1A0 0000FF482ABD3754 Temporalio.Worker.WorkflowWorker.HandleActivationAsync(Temporalio.Bridge.Api.WorkflowActivation.WorkflowActivation)\n0000FF43E2CBE1F0 0000FF482ABD3630 Temporalio.Worker.WorkflowWorker+<>c__DisplayClass10_1.<ExecuteAsync>b__0()\n0000FF43E2CBE210 0000FF482B16E428 System.Threading.ExecutionContext.RunFromThreadPoolDispatchLoop(System.Threading.Thread, System.Threading.ExecutionContext, System.Threading.ContextCallback, System.Object) [/_/src/runtime/src/libraries/System.Private.CoreLib/src/System/Threading/ExecutionContext.cs @ 264]\n0000FF43E2CBE240 0000FF482B0EEE30 System.Threading.Tasks.Task.ExecuteWithThreadLocal(System.Threading.Tasks.Task ByRef, System.Threading.Thread) [/_/src/runtime/src/libraries/System.Private.CoreLib/src/System/Threading/Tasks/Task.cs @ 2346]\n0000FF43E2CBE300 0000FF482AB8224C System.Threading.ThreadPoolWorkQueue.Dispatch() [/_/src/runtime/src/libraries/System.Private.CoreLib/src/System/Threading/ThreadPoolWorkQueue.cs @ 1154]\n0000FF43E2CBE3C0 0000FF4822546CC4 System.Threading.PortableThreadPool+WorkerThread.WorkerThreadStart() [/_/src/runtime/src/libraries/System.Private.CoreLib/src/System/Threading/PortableThreadPool.WorkerThread.cs @ 118]\n0000FF43E2CBE4B0 0000FF482B2180E0 System.Threading.Thread.StartCallback()\n0000FF43E2CBE6B8 0000ff486296b444 [DebuggerU2MCatchHandlerFrame: 0000ff43e2cbe6b8]\n```","createdAt":"2025-12-18T22:50:20Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/577#issuecomment-3672581707","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs7a-MaK","author":{"login":"jmaeagle99"},"authorAssociation":"MEMBER","body":"If I debugged this correctly, the SIGSEGV occurs at https://github.com/temporalio/sdk-core/blob/master/crates/sdk-core-c-bridge/src/lib.rs#L39. In the dump that I debugged, data is pointing to an invalid memory address (probably use-after-free issue).","createdAt":"2025-12-19T06:30:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/577#issuecomment-3673736842","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs7bDbX_","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"tldr: We should stop freeing using destructors for `Scope` and `ByteArrayRef`. We should only use `Dispose` for both (and not call from destructors).\n\n---\n\nReviewing the code, I can't see how at runtime the byte array would point to an invalid place since it's pinned .NET side for the life of the C call.\n\nEDIT: After some searching...\n\nHowever, I do wonder about the lifetime of the static `ByteArrayRef.Empty` on process shutdown. I wonder if it's getting its destructor called while in use on the C side. Note that `Scope.ByteArray` does not add `ByteArrayRef.Empty` to `byteArrayRefs` because we figured the pointer would be stable for the life of the process, but I believe .NET does run GC/destructors for statics on process shutdown. If you can reliably replicate, try adding the `Empty` to `byteArrayRefs` and see if it changes anything.\n\nOne reason why I think this may not be the case is that I cannot see a situation where `temporal_core_worker_complete_workflow_activation` would ever get an empty byte array (it should always be a proto with at least the run ID.\n\nEDIT: After some searching...\n\nBut now, the more I think about it, the more I think process shutdown in C# can just run destructors even for referenced objects which will free memory for all byte array refs, not just empty ones. If you can reliably replicate, may be worth seeing if we can track when pointers are freed compared to when they are accessed by Rust. Or maybe intentionally leak the memory just to confirm it is our byte array destructor causing the issue (and maybe for an actual fix we can intentionally leak if we know we're in process shutdown situation).\n\nEDIT: After some searching...\n\nThe more I dig through CLR stuff, the more I think this statement by ChatGPT is our issue:\n\n> A finalizer must never release native-visible resources whose premature release can crash the process.\n\nSo I wonder if we should stop freeing in destructors and only free on dispose explicitly (and don't call dispose from destructors). This is called out at https://learn.microsoft.com/en-us/dotnet/standard/native-interop/best-practices:\n\n> ‚ùå AVOID finalizers to manage lifetime of objects that encapsulate unmanaged resources. For more information, see [Implement a Dispose method](https://learn.microsoft.com/en-us/dotnet/standard/garbage-collection/implementing-dispose).\n\nIf this were process shutdown related, it would fit with it mostly only occurring in tests and not reported during normal runtime use by users.","createdAt":"2025-12-19T13:33:39Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/577#issuecomment-3675108863","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs7bK9l8","author":{"login":"jmaeagle99"},"authorAssociation":"MEMBER","body":"Managed call stack from newer dump:\n\n```\nOS Thread Id: 0x1e2f (14)\n        Child SP               IP Call Site\n0000FF3C9BFFDA40 0000ff410d5a7b74 [InlinedCallFrame: 0000ff3c9bffda40] Temporalio.Bridge.Interop.Methods.temporal_core_worker_poll_workflow_activation(Temporalio.Bridge.Interop.TemporalCoreWorker*, Void*, IntPtr)\n0000FF3C9BFFDA40 0000ff40d55804a0 [InlinedCallFrame: 0000ff3c9bffda40] Temporalio.Bridge.Interop.Methods.temporal_core_worker_poll_workflow_activation(Temporalio.Bridge.Interop.TemporalCoreWorker*, Void*, IntPtr)\n0000FF3C9BFFDA30 0000FF40D55804A0 ILStubClass.IL_STUB_PInvoke(Temporalio.Bridge.Interop.TemporalCoreWorker*, Void*, IntPtr)\n0000FF3C9BFFDB20 0000FF40D5592FD0 Temporalio.Bridge.Worker+<PollWorkflowActivationAsync>d__15.MoveNext()\n0000FF3C9BFFDC30 0000FF40D5AA323C System.Runtime.CompilerServices.AsyncTaskMethodBuilder`1[[System.__Canon, System.Private.CoreLib]].Start[[System.__Canon, System.Private.CoreLib]](System.__Canon ByRef)\n0000FF3C9BFFDC70 0000FF40D558F024 Temporalio.Bridge.Worker.PollWorkflowActivationAsync()\n0000FF3C9BFFDCB0 0000FF40D558A9A4 Temporalio.Worker.WorkflowWorker+<ExecuteAsync>d__10.MoveNext()\n0000FF3C9BFFDEC0 0000FF40D5568768 System.Threading.ExecutionContext.RunInternal(System.Threading.ExecutionContext, System.Threading.ContextCallback, System.Object) [/_/src/runtime/src/libraries/System.Private.CoreLib/src/System/Threading/ExecutionContext.cs @ 179]\n0000FF3C9BFFDF10 0000FF40D5AE44B8 System.Runtime.CompilerServices.TaskAwaiter+<>c.<OutputWaitEtwEvents>b__12_0(System.Action, System.Threading.Tasks.Task)\n0000FF3C9BFFDF80 0000FF40D5AE52A4 System.Threading.Tasks.AwaitTaskContinuation.RunOrScheduleAction(System.Action, Boolean) [/_/src/runtime/src/libraries/System.Private.CoreLib/src/System/Threading/Tasks/TaskContinuation.cs @ 743]\n0000FF3C9BFFDFC0 0000FF40D55E50D8 System.Threading.Tasks.Task.RunContinuations(System.Object) [/_/src/runtime/src/libraries/System.Private.CoreLib/src/System/Threading/Tasks/Task.cs @ 3480]\n0000FF3C9BFFE070 0000FF40D5AEE948 System.Runtime.CompilerServices.AsyncTaskMethodBuilder`1[[System.__Canon, System.Private.CoreLib]].SetResult(System.__Canon) [/_/src/runtime/src/libraries/System.Private.CoreLib/src/System/Runtime/CompilerServices/AsyncTaskMethodBuilderT.cs @ 478]\n0000FF3C9BFFE0A0 0000FF40D5593234 Temporalio.Bridge.Worker+<PollWorkflowActivationAsync>d__15.MoveNext()\n0000FF3C9BFFE1B0 0000FF40D5568768 System.Threading.ExecutionContext.RunInternal(System.Threading.ExecutionContext, System.Threading.ContextCallback, System.Object) [/_/src/runtime/src/libraries/System.Private.CoreLib/src/System/Threading/ExecutionContext.cs @ 179]\n0000FF3C9BFFE200 0000FF40D5AF3928 System.Runtime.CompilerServices.AsyncTaskMethodBuilder`1+AsyncStateMachineBox`1[[System.__Canon, System.Private.CoreLib],[System.__Canon, System.Private.CoreLib]].MoveNext() [/_/src/runtime/src/libraries/System.Private.CoreLib/src/System/Runtime/CompilerServices/AsyncTaskMethodBuilderT.cs @ 350]\n0000FF3C9BFFE260 0000FF40D5B143B4 System.Threading.Tasks.AwaitTaskContinuation.System.Threading.IThreadPoolWorkItem.Execute() [/_/src/runtime/src/libraries/System.Private.CoreLib/src/System/Threading/Tasks/TaskContinuation.cs @ 647]\n0000FF3C9BFFE300 0000FF40D55662D0 System.Threading.ThreadPoolWorkQueue.Dispatch() [/_/src/runtime/src/libraries/System.Private.CoreLib/src/System/Threading/ThreadPoolWorkQueue.cs @ 1154]\n0000FF3C9BFFE3C0 0000FF40CCF26CC4 System.Threading.PortableThreadPool+WorkerThread.WorkerThreadStart() [/_/src/runtime/src/libraries/System.Private.CoreLib/src/System/Threading/PortableThreadPool.WorkerThread.cs @ 118]\n0000FF3C9BFFE4B0 0000FF40CCEFB690 System.Threading.Thread.StartCallback()\n0000FF3C9BFFE6B8 0000ff410d29b444 [DebuggerU2MCatchHandlerFrame: 0000ff3c9bffe6b8]\n```\n\nNative call stack is:\n```\n(gdb) bt\n#0  0x0000ff410d5a7b74 in __GI___wait4 (pid=9865, stat_loc=0xff40b868ec04, options=0, usage=0x0) at ../sysdeps/unix/sysv/linux/wait4.c:30\n#1  0x0000ff410d2d9dfc in ?? () from /usr/share/dotnet/shared/Microsoft.NETCore.App/10.0.1/libcoreclr.so\n#2  0x0000ff410d2db1bc in ?? () from /usr/share/dotnet/shared/Microsoft.NETCore.App/10.0.1/libcoreclr.so\n#3  0x0000ff410d2b7ea8 in ?? () from /usr/share/dotnet/shared/Microsoft.NETCore.App/10.0.1/libcoreclr.so\n#4  0x0000ff410d2b72e4 in ?? () from /usr/share/dotnet/shared/Microsoft.NETCore.App/10.0.1/libcoreclr.so\n#5  <signal handler called>\n#6  0x0000ff3c9123008c in __aarch64_ldadd8_relax () at ./lib/builtins/aarch64/lse.S:250\n#7  0x0000ff3c8fef7644 in core::sync::atomic::atomic_add<usize, usize> (dst=0xff3c00300034) at /rustc/ded5c06cf21d2b93bffd5d884aa6e96934ee4234/library/core/src/sync/atomic.rs:3983\n#8  core::sync::atomic::AtomicUsize::fetch_add (self=0xff3c00300034) at /rustc/ded5c06cf21d2b93bffd5d884aa6e96934ee4234/library/core/src/sync/atomic.rs:3165\n#9  alloc::sync::{impl#30}::clone<temporalio_sdk_core::worker::Worker, alloc::alloc::Global> (self=0xff3c94041820) at /rustc/ded5c06cf21d2b93bffd5d884aa6e96934ee4234/library/alloc/src/sync.rs:2198\n#10 0x0000ff3c8f6e8020 in temporalio_sdk_core_c_bridge::worker::temporal_core_worker_poll_workflow_activation (worker=0xff3c94041810, user_data=0x0, callback=0xff40cdd8bcc0) at crates/sdk-core-c-bridge/src/worker.rs:683\n#11 0x0000ff40d55804a0 in ?? ()\n#12 0x0000ff3c9bffe6b8 in ?? ()\nBacktrace stopped: previous frame inner to this frame (corrupt stack?)\n```\n\nFrame 10 is:\n```\n(gdb) frame 10\n#10 0x0000ff3c8f6e8020 in temporalio_sdk_core_c_bridge::worker::temporal_core_worker_poll_workflow_activation (worker=0xff3c94041810, user_data=0x0, callback=0xff40cdd8bcc0) at crates/sdk-core-c-bridge/src/worker.rs:683\n683         let core_worker = worker.worker.as_ref().unwrap().clone();\n```\n\nLikely cause is that PollWorkflowActivationAsync is called after the Worker has been disposed.","createdAt":"2025-12-20T00:32:34Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/577#issuecomment-3677084028","viewerDidAuthor":false}],"createdAt":"2025-12-12T22:16:08Z","labels":[{"id":"LA_kwDOInL6Hs8AAAABJH7zkA","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":577,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Investigate test host crash flake","updatedAt":"2026-01-06T17:17:54Z","url":"https://github.com/temporalio/sdk-dotnet/issues/577"}
