{"assignees":[],"author":{"id":"MDQ6VXNlcjk3MjM0MDI=","is_bot":false,"login":"petrkoutnycz","name":"Petr Koutny"},"body":"We instruct the temporal SDK to send metrics to the New Relic via OpenTelemetry endpoint. We noticed that this functionality stopped working after the upgrade to 1.3.0.\r\n\r\nTo investigate the issue, I enabled log forwarding from the client so we get the output like this:\r\n```\r\nLogging = new(new(TelemetryFilterOptions.Level.Debug, TelemetryFilterOptions.Level.Debug))\r\n{\r\n    Forwarding = new LogForwardingOptions(\r\n        serviceProvider.GetRequiredService<ILogger<TemporalRuntime>>())\r\n}\r\n```\r\n\r\nWith version 1.2.0, we have following output from the client:\r\n```\r\n[10:12:57] [DBUG] [TemporalRuntime] [sdk_core::hyper::client::connect::dns] resolving host=\"otlp.eu01.nr-data.net\" \r\n[10:12:57] [DBUG] [TemporalRuntime] [sdk_core::hyper::client::connect::http] connecting to 185.221.85.50:443 \r\n[10:12:58] [DBUG] [TemporalRuntime] [sdk_core::hyper::client::connect::http] connected to 185.221.85.50:443 \r\n[10:12:58] [DBUG] [TemporalRuntime] [sdk_core::h2::client] binding client connection \r\n[10:12:58] [DBUG] [TemporalRuntime] [sdk_core::h2::client] client connection bound\r\n```\r\n\r\nWith version 1.3.0, we have this output:\r\n```\r\n[10:10:45] [DBUG] [TemporalRuntime] [sdk_core::hyper_util::client::legacy::connect::dns] resolving host=\"otlp.eu01.nr-data.net\"\r\n[10:10:46] [DBUG] [TemporalRuntime] [sdk_core::hyper_util::client::legacy::connect::http] connecting to 185.221.85.50:443 \r\n[10:10:46] [DBUG] [TemporalRuntime] [sdk_core::hyper_util::client::legacy::connect::http] connected to 185.221.85.50:443 \r\n[10:10:46] [DBUG] [TemporalRuntime] [sdk_core::tonic::transport::channel::service::reconnect] reconnect::poll_ready: ConnectError(HttpsUriWithoutTlsSupport(())) \r\n[10:10:46] [DBUG] [TemporalRuntime] [sdk_core::tower::buffer::worker] processing request service.ready=true\r\n[10:10:46] [DBUG] [TemporalRuntime] [sdk_core::tonic::transport::channel::service::reconnect] error: Connecting to HTTPS without TLS enabled \r\nOpenTelemetry metrics error occurred. Metrics exporter otlp failed with the grpc server returns error (The service is currently unavailable): , detailed error message: Connecting to HTTPS without TLS enabled\r\n```\r\n\r\nNot saying that the error is reported as DEBUG! So it is impossible for us to catch it as we never have DEBUG allowed in production.\r\n\r\n### Minimal Reproduction\r\n\r\nWe configure metrics as following:\r\n```\r\nMetrics = new MetricsOptions\r\n{\r\n    AttachServiceName = false,\r\n    MetricPrefix = \"temporal.\",\r\n    GlobalTags =\r\n    [\r\n        new KeyValuePair<string, string>(\"service.name\", \"mews-app-name\")\r\n    ],\r\n    OpenTelemetry = new OpenTelemetryOptions\r\n    {\r\n        Url = new Uri(\"https://otlp.eu01.nr-data.net/v1/metrics\"),\r\n        Headers = [new KeyValuePair<string, string>(\"api-key\", \"<THE API KEY>\")],\r\n        MetricTemporality = OpenTelemetryMetricTemporality.Delta,\r\n        MetricsExportInterval = TimeSpan.FromSeconds(5)\r\n    },\r\n},\r\n```\r\n\r\nAlso tried different `Url`. According to the New Relic [docs](https://docs.newrelic.com/docs/opentelemetry/best-practices/opentelemetry-otlp/#configure-endpoint-port-protocol), the url should be fine like that. Also tried simply use `https://otlp.eu01.nr-data.net:4317` (i.e. with gRPC port and without the `v1/metrics` appendix) but also without success. \r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: M1 Mac, Windows\r\n","closedAt":"2024-09-11T14:05:46Z","comments":[{"id":"IC_kwDOInL6Hs6KqtsV","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Yes, we inadvertently broke OpenTelemetry over TLS with the latest release (happened in Python too). This is because of a Rust issue with a dependency upgrade (see https://github.com/open-telemetry/opentelemetry-rust/issues/2008). This was fixed in our Core layer at https://github.com/temporalio/sdk-core/issues/801 and we will be issuing a patch release to fix here.","createdAt":"2024-09-03T12:54:35Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/340#issuecomment-2326453013","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6Kq8Fw","author":{"login":"petrkoutnycz"},"authorAssociation":"CONTRIBUTOR","body":"Thanks üëç","createdAt":"2024-09-03T13:20:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/340#issuecomment-2326511984","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6KrC1B","author":{"login":"petrkoutnycz"},"authorAssociation":"CONTRIBUTOR","body":"And as for reporting the error as DEBUG...? I'd guess this problem was present before as well :-) ","createdAt":"2024-09-03T13:32:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/340#issuecomment-2326539585","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6KsJ3j","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"It's actually not `DEBUG` it's just a standalone stderr line. Notice the last line of your log does not have any log prefixing (not to be confused with the Tonic reconnect trace above it which is not an error). https://github.com/open-telemetry/opentelemetry-rust/blob/976bc54dba564afdc8fd7de51a8feb123f44ecdb/opentelemetry/src/global/error_handler.rs#L62 is where this is happening, and we will look into whether we can configure a global handler, though it is difficult because logs are configured per runtime.","createdAt":"2024-09-03T15:33:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/340#issuecomment-2326830563","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6KxkJf","author":{"login":"petrkoutnycz"},"authorAssociation":"CONTRIBUTOR","body":"Btw weird thing is that this problem occurs for us on a specific environment even with version 1.2.0\r\n<img width=\"1058\" alt=\"image\" src=\"https://github.com/user-attachments/assets/e63a751a-fd2a-4e5f-a8d8-b94021b8570b\">\r\n","createdAt":"2024-09-04T08:34:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/340#issuecomment-2328248927","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6K1Ndx","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"If you'd like, you can try to rebuild the SDK from the branch at the PR in https://github.com/temporalio/sdk-dotnet/pull/344 and see if it resolves your issue.","createdAt":"2024-09-04T14:21:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/340#issuecomment-2329204593","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6LFDXf","author":{"login":"petrkoutnycz"},"authorAssociation":"CONTRIBUTOR","body":"When do you expect to fix the OTel over TLS problem please? :-) ","createdAt":"2024-09-06T06:43:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/340#issuecomment-2333357535","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6LHZjM","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"It will be fixed on next release, which should hopefully happen soon as a patch release (we are patching another issue).","createdAt":"2024-09-06T12:44:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/340#issuecomment-2333972684","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6Lsy-O","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"This should now be fixed with the 1.3.1 release.","createdAt":"2024-09-11T14:05:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/340#issuecomment-2343776142","viewerDidAuthor":false}],"createdAt":"2024-09-03T08:26:33Z","labels":[{"id":"LA_kwDOInL6Hs8AAAABJH7zkA","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":340,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"[Bug] Metrics stopped working after the upgrade from 1.2.0 to 1.3.0","updatedAt":"2024-09-11T14:05:47Z","url":"https://github.com/temporalio/sdk-dotnet/issues/340"}
