{"assignees":[],"author":{"id":"MDQ6VXNlcjI4NzY0MQ==","is_bot":false,"login":"jakejscott","name":"Jake Scott"},"body":"### What are you really trying to do?\r\n\r\nTrying to start a workflow from asp.net minimal api.\r\n\r\n### Describe the bug\r\n\r\nIf I create the client at startup, and then try and use that client instance within an endpoint it hangs when I call `StartWorkflowAsync`. \r\n\r\nIf I create a client within the MapGet endpoint lambda it works. \r\n\r\n### Minimal Reproduction\r\n\r\n```csharp\r\nusing Temporalio.Client;\r\nusing Temporalio.Runtime;\r\n\r\nvar builder = WebApplication.CreateBuilder(args);\r\n\r\nbuilder.Logging.AddSimpleConsole(options =>\r\n{\r\n    options.TimestampFormat = \"yyyy-mm-ddTHH:mm:ss.ff \";\r\n    options.UseUtcTimestamp = true;\r\n    options.IncludeScopes = false;\r\n    options.SingleLine = true;\r\n});\r\n\r\n// If I create the client here, when I call `client.StartWorkflowAsync` the call blocks and doesn't work.\r\nvar client = await TemporalClient.ConnectAsync(new()\r\n{\r\n    TargetHost = \"localhost:7233\",\r\n    Namespace = \"default\",\r\n});\r\n\r\nvar app = builder.Build();\r\n\r\napp.MapGet(\"/\", async () =>\r\n{\r\n    app.Logger.LogInformation(\"We are here\");\r\n    \r\n    // NOTE: If I connect here it works\r\n    // var client = await TemporalClient.ConnectAsync(new()\r\n    // {\r\n    //     TargetHost = \"localhost:7233\",\r\n    //     Namespace = \"default\",\r\n    // });\r\n\r\n    var id = $\"simple-workflow-{Guid.NewGuid().ToString()}\";\r\n\r\n    // This call blocks and doesn't work\r\n    var handle = await client.StartWorkflowAsync(\r\n        workflow: SimpleWorkflow.Ref.RunAsync,\r\n        arg: \"Jake\",\r\n        options: new WorkflowOptions(\r\n            id: id,\r\n            taskQueue: \"my-task-queue\"\r\n        )\r\n    );\r\n\r\n    var result = await handle.GetResultAsync();\r\n    return result;\r\n});\r\n\r\napp.Logger.LogInformation(\"Started\");\r\n\r\napp.Run();\r\n```\r\n\r\n### Environment/Versions\r\n\r\n- x86 Windows\r\n- using temporal cli","closedAt":"2023-08-21T19:50:46Z","comments":[{"id":"IC_kwDOInL6Hs5Zhbqt","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I have replicated. There is something about how the container is working that does is preventing the Tokio thread from running properly.\r\n\r\nIn the meantime, what you have there is not best practice. And it's not good to connect per call either. Consider changing to:\r\n\r\n```csharp\r\nbuilder.Services.AddSingleton(_ =>\r\n    Task.Run(() => TemporalClient.ConnectAsync(new()\r\n    {\r\n        TargetHost = \"localhost:7233\",\r\n        Namespace = \"default\",\r\n    })).Result);\r\n```\r\n\r\nAnd:\r\n\r\n```csharp\r\napp.MapGet(\"/\", async (TemporalClient client) =>\r\n```","createdAt":"2023-04-10T15:10:37Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/44#issuecomment-1501936301","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5Zhf2i","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"This is actually bad practice too, ref https://learn.microsoft.com/en-us/dotnet/core/extensions/dependency-injection-guidelines#async-di-factories-can-cause-deadlocks. I will consider some kind of `TemporalClientProvider` when I write the sample for this.","createdAt":"2023-04-10T15:25:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/44#issuecomment-1501953442","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5bfHPi","author":{"login":"cecilphillip"},"authorAssociation":"MEMBER","body":"If might be help if there were a blocking version of [Bridge.Client.ConnectAsync](https://github.com/temporalio/sdk-dotnet/blob/53e3862dbc0a426f3d6b30fc80fd73f4ccc8d43b/src/Temporalio/Bridge/Client.cs#L40). ","createdAt":"2023-05-04T14:27:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/44#issuecomment-1534882786","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5bgXth","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Hrmm, I wonder how. Can you explain a bit more? It's non-blocking because the Rust side is intentionally non-blocking. Users can of course execute any .NET task in a blocking manner. But the problem is that something is broken within the client if created on the outside vs the inside in the exact same way.","createdAt":"2023-05-04T18:19:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/44#issuecomment-1535212385","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5i4VXL","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"So I have packaged up the replication. See the attached zip. Steps to replicate:\r\n\r\n1. Have a Temporal serer running\r\n1. Clone this repository recursively and set `TreatWarningsAsErrors` as `false` in `Directory.Build.props`\r\n1. Extract [attached zip](https://github.com/temporalio/sdk-dotnet/files/12218124/Temporalio.WebFailure.zip) to `tests/` (it has a single folder in it called `Temporalio.WebFailure`)\r\n1. `cd tests/Temporalio.WebFailure`\r\n1. `dotnet run`\r\n1. It'll start with some logs, now navigate to http://localhost:5000 in a browser and watch it hang while trying to make start-workflow gRPC call\r\n\r\nThere is something weird going on with sockets or threads or something, and I cannot figure out what.\r\n\r\nTo enable trace logs, change the initial client creation to:\r\n\r\n```csharp\r\nvar runtime = new TemporalRuntime(new(new() { Logging = new(new(\"trace\")) }));\r\nvar client = await TemporalClient.ConnectAsync(new(\"localhost:7233\") { Runtime = runtime });\r\n```\r\n\r\nWhat I have observed with trace logs is that in the successful case (client created inside handler which works), `Connection:poll:` logs appear when making the call. But in the failed case (the default code), `Connection:poll` logs do not appear. Something is inadvertently stopping/killing connection poll and I am not sure what.\r\n\r\n[Temporalio.WebFailure.zip](https://github.com/temporalio/sdk-dotnet/files/12218124/Temporalio.WebFailure.zip)\r\n","createdAt":"2023-07-31T18:31:27Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/44#issuecomment-1658934731","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5jT6El","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Good news. I can no longer replicate after updating core to get https://github.com/temporalio/sdk-core/pull/584 and setting my min tonic version to 0.9 and `cargo update`ing the bridge project. I will try to dig through Tonic release notes to see what it could be (though it could be one of their transitive dependencies).\r\n\r\nI will update when I make a PR to fix this (I will likely wait for https://github.com/temporalio/sdk-core/pull/544 to be merged too).","createdAt":"2023-08-04T20:44:52Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/44#issuecomment-1666162981","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5jc28-","author":{"login":"jakejscott"},"authorAssociation":"CONTRIBUTOR","body":"Wonder if it's worth adding a regression test in case it ever comes back?","createdAt":"2023-08-07T20:13:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/44#issuecomment-1668509502","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5jhQ9s","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I think it might be, yes. I'll try to see if I can replicate via https://learn.microsoft.com/en-us/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1 in my unit tests without too much trouble.","createdAt":"2023-08-08T13:52:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/44#issuecomment-1669664620","viewerDidAuthor":false}],"createdAt":"2023-04-10T08:11:27Z","labels":[{"id":"LA_kwDOInL6Hs8AAAABJH7zkA","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":44,"reactionGroups":[],"state":"CLOSED","title":"Trying to start a workflow from asp.net and the client hangs","updatedAt":"2023-08-21T19:50:46Z","url":"https://github.com/temporalio/sdk-dotnet/issues/44"}
