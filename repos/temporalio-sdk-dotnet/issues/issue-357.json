{"assignees":[],"author":{"id":"MDQ6VXNlcjExNDc5MzI5","is_bot":false,"login":"robcao","name":"Robert Cao"},"body":"### What are you really trying to do?\r\n\r\n<!-- \r\nTell us at a high level what you're doing, to avoid XY problem (https://en.wikipedia.org/wiki/XY_problem) \r\n-->\r\n\r\nI have a use case where I am invoking signal from start in an activity. I stumbled across a scenario where Temporal client credentials can potentially get leaked in workflow history.\r\n\r\n### Describe the bug\r\n\r\n<!-- A clear and concise description of what the bug is. -->\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n\r\nWhen executing an activity that returns a `Task`, if you instead return a `Task<T>`, the value of `T` is stored in workflow history. This can lead to unexpected leakage of Temporal server credentials when `T` is a `WorkflowHandle`.\r\n\r\nConsider the following activity. The activity returns `Task<WorkflowHandle>`, and the workflow handle gets stored in workflow history.\r\n\r\n```csharp\r\ninternal class Activities(ITemporalClient client)\r\n{\r\n\t/// <summary>\r\n\t/// When returning a <see cref=\"Task{WorkflowHandle}\"/>, the workflow handle gets serialized to workflow history.\r\n\t/// </summary>\r\n\t[Activity]\r\n\tpublic Task StartWorkflowThatLeaksWorkflowHandleToEventHistoryAsync()\r\n\t{\r\n\t\tWorkflowOptions options = new WorkflowOptions(Guid.NewGuid().ToString(), \"my-tq\");\r\n\r\n\t\treturn client.StartWorkflowAsync<Other>(wf => wf.RunAsync(), options);\r\n\t}\r\n```\r\n\r\nThe issue here is that `WorkflowHandle` has a reference to the Temporal client, which leaks sensitive information like the api key or TLS certificate into the workflow history.\r\n\r\n![image](https://github.com/user-attachments/assets/7ff8c09f-ab0d-4014-af9b-e4b42350f690)\r\n\r\n\r\n### Minimal Reproduction\r\n\r\nI have a code sample here: https://github.com/robcao/temporal-client-serialization\r\n\r\nTo reproduce:\r\n\r\nStart a dev server: `temporal server start-dev`.\r\n\r\nStart the worker: `dotnet run`.\r\n\r\nExecute a workflow: `temporal workflow start --task-queue=my-tq --type=Example`.\r\n\r\nNavigate to the temporal ui and click the `Example` workflow. If you look at the workflow history, you'll see that the entire workflow handle was stored.\r\n\r\n<!-- \r\nModify our hello world templates to demonstrate:\r\n\r\n- TypeScript: https://github.com/temporalio/samples-typescript/tree/main/hello-world\r\n- Go: https://github.com/temporalio/money-transfer-project-template-go\r\n- Java: https://github.com/temporalio/money-transfer-project-template-java\r\n- PHP: https://github.com/temporalio/samples-php#samples\r\n-->\r\n\r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: [e.g. M1 Mac, x86 Windows, Linux]\r\n- Temporal Version: [e.g. 1.14.0?] and/or SDK version\r\n- Are you using Docker or Kubernetes or building Temporal from source?\r\n.NET SDK 1.3.1\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context about the problem here. -->\r\n\r\n\r\nThis can be fixed by re-writing the activity like this, so it's fairly minor. However, perhaps serialization of the `TemporalClient` should be changed to omit the `ApiKey`, `TlsOptions`, and other potentially sensitive values?\r\n\r\n```csharp\r\ninternal class Activities(ITemporalClient client)\r\n{\r\n\t/// <summary>\r\n\t/// No problems here because a <see cref=\"Task\"/>> is returned.\r\n\t/// </summary>\r\n\t[Activity]\r\n\tpublic async Task StartWorkflowThatDoesNotLeakWorkflowHandleToEventHistoryAsync()\r\n\t{\r\n\t\tWorkflowOptions options = new WorkflowOptions(Guid.NewGuid().ToString(), \"my-tq\");\r\n\r\n\t\tawait client.StartWorkflowAsync<Other>(wf => wf.RunAsync(), options).ConfigureAwait(false);\r\n\t}\r\n}\r\n```","closedAt":null,"comments":[{"id":"IC_kwDOInL6Hs6PYRew","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"You are returning `Task<WorkflowHandle>` which is then serialized.\r\n\r\n`WorkflowHandle` is not meant to be serializable (just coincidence that it works with `System.Text.Json`). This would be the same as if you returned `Task<MyDatabaseOrmEntity>` that contains a property with the database that had its initial options. That the return type is `Task` does not mean the result is expected to automatically be removed, `Task` is just a supertype of `Task<TResult>` and return covariance applies and we do support caller specifying the result-type for upcasting. This information would leak if you just called the method regularly and not through Temporal.\r\n\r\nYou should not return the workflow handle from the activity if you do not want it to be serialized. If you cannot `await`, then you can do something like `startTask.ContinueWith(_ => Task.CompletedTask), TaskContinuationOptions.OnlyOnRanToCompletion)`.","createdAt":"2024-10-10T15:59:15Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/357#issuecomment-2405504944","viewerDidAuthor":false}],"createdAt":"2024-10-10T03:10:01Z","labels":[{"id":"LA_kwDOInL6Hs8AAAABJH7zkA","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":357,"reactionGroups":[],"state":"OPEN","title":"[Bug] Unexpected Serialization of Activity Results","updatedAt":"2024-10-11T19:07:13Z","url":"https://github.com/temporalio/sdk-dotnet/issues/357"}
