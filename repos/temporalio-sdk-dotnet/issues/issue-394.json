{"assignees":[],"author":{"id":"MDQ6VXNlcjk3MjM0MDI=","is_bot":false,"login":"petrkoutnycz","name":"Petr Koutny"},"body":"### Is your feature request related to a problem? Please describe.\n\nWhen having a workflow with custom search attributes and having OpenTelemetry tracing enabled, I'd like the SDK to append those search attributes to activity tags as part of `RunWorkflow` activity.\n\nReason is that I need to able to filter traces by those attributes.\n\n### Describe the solution you'd like\n\n`TracingInterceptor` is extended so it appends custom workflow search attributes to activity tags while spinning up a new `RunWorkflow` activity. The logic might be customized via `TracingInterceptorOptions`.","closedAt":"2025-01-21T16:37:58Z","comments":[{"id":"IC_kwDOInL6Hs6a4GKL","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> I'd like the SDK to append those search attributes to activity tags as part of `RunWorkflow` activity.\n\nHrmm. We do offer the ability to create your own spans with your own tags, so you could `using (TracingInterceptor.WorkflowsSource.TrackWorkflowDiagnosticActivity(name: \"MyCustomActivity\", tags: CreateMyOwnTags()))` inside your own `ExecuteWorkflowAsync` interceptor.\n\nBut if you don't want to do that, there is `protected virtual IEnumerable<KeyValuePair<string, object?>> CreateInWorkflowTags()`, so you can probably have something like:\n\n```csharp\npublic class MyTracingInterceptor : TracingInterceptor\n{\n    public MyTracingInterceptor(TracingInterceptorOptions? options = null)\n        : base(options)\n    {\n    }\n\n    protected override IEnumerable<KeyValuePair<string, object?>> CreateInWorkflowTags()\n    {\n        var tags = base.CreateInWorkflowTags();\n        return tags.Append(new(\"myTagName\", Workflow.TypedSearchAttributes.Get(MyAttrKey)));\n    }\n}\n```\n\nThis will add your search attribute to `RunWorkflow` and any other spans created inside the workflow by the interceptor (untested, just typed here in comment).\n\nIs this good enough?","createdAt":"2025-01-17T13:43:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"EYES","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/394#issuecomment-2598396555","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6a4K0V","author":{"login":"petrkoutnycz"},"authorAssociation":"CONTRIBUTOR","body":"Hmm, that looks feasible. Will give it a shot and let you know!","createdAt":"2025-01-17T13:52:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HEART","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/394#issuecomment-2598415637","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6bE7nP","author":{"login":"petrkoutnycz"},"authorAssociation":"CONTRIBUTOR","body":"Tried it and it does not work in my case. The reason might be that I update my search attributes _during_ a workflow task.\n\nCreated a branch with repro if you're interested: https://github.com/petrkoutnycz/temporalio-samples-dotnet/commit/4dcdbbc7e9b8a5df3838dc868c619bd7a287248f.\n\nMeanwhile, I came up with a workaround that sets those OTel attributes in an activity.","createdAt":"2025-01-20T08:40:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/394#issuecomment-2601761231","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6bQia4","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> The reason might be that I update my search attributes during a workflow task.\n\nWhen you call `UpsertTypedSearchAttributes`, it does update `Workflow.TypedSearchAttributes`. But these span tags are fetched when the span is created and in your code you are changing the search attribute well after the spans are created.","createdAt":"2025-01-21T13:55:15Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/394#issuecomment-2604803768","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6bR0dJ","author":{"login":"petrkoutnycz"},"authorAssociation":"CONTRIBUTOR","body":"Exactly, so for my use case I keep updating OTel tags within an activity.\n\nAnyway, I still think this ticket makes sense when search attributes are known upfront, right?","createdAt":"2025-01-21T16:05:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/394#issuecomment-2605139785","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6bR5c_","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"The ability to do this makes sense, yes, which we support, but not necessarily sure it's something we should do in the SDK. What tags a user chooses to provide in this override is up to them, they may want a certain search attribute, or a memo value, or a some other thing off the instance (now that we made `.Instance` available in #393), or something else entirely.","createdAt":"2025-01-21T16:11:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/394#issuecomment-2605160255","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6bR-Zo","author":{"login":"petrkoutnycz"},"authorAssociation":"CONTRIBUTOR","body":"Get it. So process this ticket as you wish then :-) ","createdAt":"2025-01-21T16:19:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/394#issuecomment-2605180520","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6bSI-Y","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Closing as not planned, but we may consider a sample to demonstrate how to customize the span tags","createdAt":"2025-01-21T16:37:58Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/394#issuecomment-2605223832","viewerDidAuthor":false}],"createdAt":"2025-01-17T12:35:20Z","labels":[{"id":"LA_kwDOInL6Hs8AAAABJH7znQ","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":394,"reactionGroups":[],"state":"CLOSED","title":"[Feature Request] Add workflow search attributes as Activity tags","updatedAt":"2025-01-21T16:37:59Z","url":"https://github.com/temporalio/sdk-dotnet/issues/394"}
