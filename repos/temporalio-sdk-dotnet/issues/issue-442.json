{"assignees":[],"author":{"id":"MDQ6VXNlcjQwOTg3OTQw","is_bot":false,"login":"vchirikov","name":"Vladimir Chirikov"},"body":"Hi, I have a stable semantic versioning and want to show the worker version via `Build Id`, but I don't want to use `UseWorkerVersioning`, for now I can't because of these lines:\n\nhttps://github.com/temporalio/sdk-dotnet/blob/bac42d3db19617fae17bc1965e1a9c33fd517fc1/src/Temporalio.Extensions.Hosting/TemporalWorkerService.cs#L138-L142\n\nCan we change this behavior/check or did I misunderstand something?","closedAt":"2025-04-10T22:11:50Z","comments":[{"id":"IC_kwDOInL6Hs6lTRM5","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Hrmm, I see. This use of \"build ID\" is meant to automatically enable this form of versioning. I assume you are using the build ID parameter of `AddHostedTemporalWorker` and then going back to options and setting `UseWorkerVersioning` to false (since it is set to true if build ID is provided)?\n\nWe should support setting build ID without opting into versioning (which is experimental and being changed anyways). I think the best way for us to do this is to clarify that setting build ID via `AddHostedTemporalWorker` opts in to versioning, and to use the worker option of build ID if you just want the build ID and remove the condition above the one you linked (i.e. `options.BuildId != taskQueueAndBuildId.BuildId`). But since versioning is experimental and changing anyways, I think we may mark the parameter (or entire overload) as deprecated or remove its assumption you want to opt-in to versioning. We will investigate...","createdAt":"2025-04-02T17:47:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/442#issuecomment-2773291833","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6lUWEl","author":{"login":"vchirikov"},"authorAssociation":"NONE","body":"> I assume you are using the build ID parameter of AddHostedTemporalWorker\n\n\nI use my own registrations with DI (because with the existing one I can't get `Meter` from service provider for example). So I can provide version to `TemporalWorkerServiceOptionsBuilder.ctor` / `TemporalWorkerServiceOptionsBuilder.ConfigureOptions` / `TemporalWorkerService.ctor`, but because of this check inside TemporalWorkerService it doesn't work, and `buildId` will be `Assembly.GetEntryAssembly().ManifestModule.ModuleVersionId` (according to xmldoc at least). :(\n\n> remove its assumption you want to opt-in to versioning\n\n\nYes, it will be enough for me. to be clear, I want to see here my worker app version (but I don't want to require workflows to run only for a specific worker version.)  \n\n![Image](https://github.com/user-attachments/assets/72f1b9e5-fa91-421e-b8ea-2415f00c41a0)\n\n","createdAt":"2025-04-02T19:49:59Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/442#issuecomment-2773573925","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6lUY2Q","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Makes sense, we are looking at ways to safely stop assuming build ID is an opt-in to versioning.\n\n> because with the existing one I can't get Meter from service provider for example\n\nUnderstanding this separately may help us understand where our DI abstraction isn't powerful enough. What meter are you referring to and how is that preventing use of `AddHostedTemporalWorker`? (can discuss on `#dotnet-sdk` on [Slack](https://t.mp/slack) instead of here if that's easier).","createdAt":"2025-04-02T19:56:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/442#issuecomment-2773585296","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6lUr7f","author":{"login":"vchirikov"},"authorAssociation":"NONE","body":">  where our DI abstraction isn't powerful enough\n\nIMHO you should provide an overload to get access to the service provider, e.g. I want to add an extension method to my \"shared\" library which will add a temporal client with reasonable defaults, but give an opportunity to tune the defaults e.g. all apps should use same Interceptors/DataConverter config, KeepAlive settings, but use the different `Meter` instance (with different MeterName I can better separate otel metrics from different apps & have different otel collector configs).\nThis is a simplified version that I need to do, but can't with default DI integration:\n\n```cs\npublic static IServiceCollection AddTemporal(this IServiceCollection services, Func<IServiceProvider, Meter> meterAccessor){\n    // ...\n    services.AddOptions<TemporalClientConnectOptions>().Configure<IServiceProvider>((opt, sp) => {\n      opt.TargetHost = sp.GetRequiredService<IConfiguration>().GetConnectionString(\"temporal\");\n      // also specify some other settings\n      // opt.Namespace = cfg.Namespace;\n      // opt.KeepAlive = cfg.KeepAlive;\n      opt.Interceptors = [new TracingInterceptor()];\n      opt.DataConverter = CreateDataConverter();\n      opt.Runtime = new TemporalRuntime(new() {\n        Telemetry = new() {\n          // here I need to get Meter from the app, not from the Shared library...\n          Metrics = new() { CustomMetricMeter = new CustomMetricMeter(meterAccessor(sp)), },\n        },\n      });\n      if (sp.GetService<ILoggerFactory>() is { } loggerFactory) {\n        opt.LoggerFactory = loggerFactory;\n      }\n    });\n   // ...\n}\n```\n","createdAt":"2025-04-02T20:31:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/442#issuecomment-2773663455","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6lVW3B","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> This is a simplified version that I need to do, but can't with default DI integration:\n\nCan you do something like:\n\n```csharp\nservices.AddHostedTemporalWorker(...).ConfigureOptions().Configure<IServiceProvider>((options, provider) => {\n  // Do what is needed with options.ClientOptions\n})\n```\n\nthe `ConfigureOptions()` returns an `OptionsBuilder<TemporalWorkerServiceOptions>` which can have `Configure` called on it with injected pieces. In fact, our `ConfigureOptions` just calls `AddOptions` like you do here (but we have it named so different workers can configure different options).\n\nAlso, if you use this `AddTemporal` utility multiple times, I would strongly suggest having the `Runtime` be a singleton in the container or global and reuse it for every client in the system. Creating multiple runtimes is not usually a good idea.\n\n(of course this is an aside, we still will look into the original issue of removing that check)","createdAt":"2025-04-02T22:06:19Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/442#issuecomment-2773839297","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6lYALB","author":{"login":"vchirikov"},"authorAssociation":"NONE","body":"If I use `AddHostedTemporalWorker(this IServiceCollection services, string taskQueue, string? buildId = null)` I can't use ConfigureOptions() again, because it uses `disallowDuplicates: true` isn't it?\n\np.s. It also unclear which client options and when worker re-use from registered ITemporalClient I mean in `ConfigureOptions` `TemporalWorkerServiceOptions.ClientOptions` is null which is confusing, xmldoc doesn't help a lot.\n\np.p.s anyway original issue is not related to registrations, so I waiting for your decision to disable versioning check to have an option to set an explicit buildId for workers.","createdAt":"2025-04-03T05:28:22Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/442#issuecomment-2774532801","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6lcdHS","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":":+1: You can use `ConfigureOptions()` on the result of `AddHostedTemporalWorker` as much as is needed, `disallowDuplicates` is an optional parameter you can set. Yes, client options vs providing a DI client can be confusing because both need to be supported. Basically if you use the `AddHostedTemporalWorker` overload w/ client options or set client options on the `TemporalWorkerServiceOptions` (i.e. from `ConfigureOptions()`), then it won't use any DI client it will create one based on the options just for the worker.","createdAt":"2025-04-03T12:54:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/442#issuecomment-2775699922","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6liTx5","author":{"login":"vchirikov"},"authorAssociation":"NONE","body":"@cretz sorry, but I think you don't get my point :) I can't use `services.AddHostedTemporalWorker(...).ConfigureOptions().Configure<IServiceProvider>((options, provider) => {})` as you suggested, because the extension method already set `disallowDuplicates: true`\n\nhttps://github.com/temporalio/sdk-dotnet/blob/bac42d3db19617fae17bc1965e1a9c33fd517fc1/src/Temporalio.Extensions.Hosting/TemporalHostingServiceCollectionExtensions.cs#L64-L83\n\nAnd I can't use this extension method\n\nhttps://github.com/temporalio/sdk-dotnet/blob/bac42d3db19617fae17bc1965e1a9c33fd517fc1/src/Temporalio.Extensions.Hosting/TemporalHostingServiceCollectionExtensions.cs#L37-L44\n\nBecause I want to get `clientTargetHost` from DI + want that the worker use a client registration. (Ok, maybe I can reconfigure target host + reset ClientOptions to null later with `.Configure`, but it looks too ugly)","createdAt":"2025-04-03T23:55:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/442#issuecomment-2777234553","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6lpSKa","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> I can't use `services.AddHostedTemporalWorker(...).ConfigureOptions().Configure<IServiceProvider>((options, provider) => {})` as you suggested, because the extension method already set `disallowDuplicates: true`\n\nHrmm, `disallowDuplicates` is set on each call to `ConfigureOptions` and only applies to that call, not all future `ConfigureOptions` calls. We use it internally in `AddHostedTemporalWorker` to make sure you aren't registering duplicate workers. What is the exception you get from `.ConfigureOptions()` which defaults `disallowDuplicates` to `false`? Or are you registering duplicate workers? (sorry if I am misunderstanding)","createdAt":"2025-04-04T15:22:43Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/442#issuecomment-2779062938","viewerDidAuthor":false}],"createdAt":"2025-04-02T17:29:24Z","labels":[],"milestone":null,"number":442,"reactionGroups":[],"state":"CLOSED","title":"Less strict checking of `UseWorkerVersioning`","updatedAt":"2025-04-10T22:11:50Z","url":"https://github.com/temporalio/sdk-dotnet/issues/442"}
