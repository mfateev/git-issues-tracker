{"assignees":[],"author":{"id":"MDQ6VXNlcjE2NzI1ODUy","is_bot":false,"login":"AdnanSoftic","name":""},"body":"### What are you really trying to do?\r\n\r\nWe have a .NET 7 Web API that registers a TemporalClient like:\r\n\r\n```\r\nbuilder.Services.AddTemporalClient(options =>\r\n    {\r\n        options.TargetHost = builder.Configuration.GetValue<string>(\"Temporal:Host\");\r\n        options.Namespace = builder.Configuration.GetValue<string>(\"Temporal:Namespace\") ?? \"default\";\r\n    \r\n        var privateKey = builder.Configuration.GetValue<string>(\"Temporal:PrivateKey\");\r\n        var publicCertificate = builder.Configuration.GetValue<string>(\"Temporal:PublicCertificate\");\r\n\r\n        if (!string.IsNullOrEmpty(privateKey) && !string.IsNullOrEmpty(publicCertificate))\r\n        {\r\n            options.Tls = new TlsOptions\r\n            {\r\n                ClientCert = Encoding.UTF8.GetBytes(publicCertificate.Replace(\"******\", \"\\n\")),\r\n                ClientPrivateKey = Encoding.UTF8.GetBytes(privateKey.Replace(\"******\", \"\\n\"))\r\n            };\r\n        }\r\n    });\r\n```\r\n\r\n### Describe the bug\r\n\r\nIn our TST environment we are connecting to a Temporal Cloud service and things are working as expected for for a certain period. After a day or two We have noticed that Temporal client loses connection with temporal Cloud and is unable to start any new Workflow(s). The result is a following exception:\r\n\r\n```\r\n2023-11-17T12:38:53.347909835Z [12:38:53 ERR] An unhandled exception has occurred while executing the request.\r\n2023-11-17T12:38:53.347943176Z Temporalio.Exceptions.RpcException: Timeout expired\r\n2023-11-17T12:38:53.347949201Z    at Temporalio.Bridge.Client.CallAsync[T](RpcService service, String rpc, IMessage req, MessageParser`1 resp, Boolean retry, IEnumerable`1 metadata, Nullable`1 timeout, Nullable`1 cancellationToken)\r\n2023-11-17T12:38:53.347953385Z    at Temporalio.Client.TemporalConnection.InvokeRpcAsync[T](RpcService service, String rpc, IMessage req, MessageParser`1 resp, RpcOptions options)\r\n2023-11-17T12:38:53.347957739Z    at Temporalio.Client.WorkflowService.StartWorkflowExecutionAsync(StartWorkflowExecutionRequest req, RpcOptions options)\r\n2023-11-17T12:38:53.347962584Z    at Temporalio.Client.TemporalClient.Impl.StartWorkflowInternalAsync[TWorkflow,TResult](StartWorkflowInput input)\r\n2023-11-17T12:38:53.347966881Z    at Temporalio.Client.TemporalClient.Impl.StartWorkflowAsync[TWorkflow,TResult](StartWorkflowInput input)\r\n2023-11-17T12:38:53.347971070Z    at Temporalio.Client.TemporalClient.StartWorkflowAsync[TWorkflow,TResult](Expression`1 workflowRunCall, WorkflowOptions options)\r\n2023-11-17T12:38:53.347975844Z    at ******************.Facade.Controllers.B2BPersonsController.OnboardB2BPerson(B2BPersonOnboardingRequest b2BPersonOnboardingRequest) in /src/WebApi/Controllers/B2BPersonsController.cs:line 111\r\n```\r\n\r\n<!-- If applicable, add screenshots or code blocks to help explain your problem. You can also use [Loom](http://loom.com/) to do short, free video bug reports. -->\r\n\r\n### Minimal Reproduction\r\n\r\nUnable to reproduce since the issue is occurring sporadically.\r\n \r\n### Environment/Versions\r\n\r\n<!-- Please complete the following information where relevant. -->\r\n\r\n- OS and processor: Linux\r\n- Temporal Version: .NET SDK version: 0.1.0-beta1\r\n- Are you using Docker or Kubernetes or building Temporal from source? - No. We are using Temporal Cloud.\r\n\r\n### Additional context\r\n\r\nOur Client application is running in Azure Container environment.\r\n","closedAt":"2023-11-17T14:14:28Z","comments":[{"id":"IC_kwDOInL6Hs5sRVT3","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"We have seen other situations of this and have turned on client keep alive by default in beta 2 (#138). It is possible that Azure is closing idle outbound connections. Can you upgrade to beta 2 and confirm this issue no longer occurs?","createdAt":"2023-11-17T14:00:54Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/158#issuecomment-1816483063","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5sRZRh","author":{"login":"AdnanSoftic"},"authorAssociation":"NONE","body":"@cretz I will update to beta2 and monitor throughout the next week.\r\nRegarding Azure closing outbound connections, I am really not sure how that works. From our side we configure number of instances of an image running in the Container environment, where we always have at least one instance running.\r\n\r\nThank you for your feedback.","createdAt":"2023-11-17T14:10:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/158#issuecomment-1816499297","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5sRarq","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":":+1: No prob. We have seen other issues with users there hitting these idle timeouts and this client keep alive did seem to resolve it. I will close the issue now, but feel free to reopen if it persists (or come join us on `#dotnet-sdk` on Slack at https://t.mp/slack or our forums at https://community.temporal.io).","createdAt":"2023-11-17T14:14:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/158#issuecomment-1816505066","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs52nKNf","author":{"login":"geoffreytran"},"authorAssociation":"NONE","body":"Also running into this issue with the 1.0 sdk. Is there a way to check if the connection is disconnected and reconnect?","createdAt":"2024-03-12T03:13:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/158#issuecomment-1989976927","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs52uOZJ","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"No, the connection is supposed to automatically reconnect internally, and keep alive is enabled by default which should reconnect when it is seen as down.","createdAt":"2024-03-12T14:48:47Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/158#issuecomment-1991829065","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs52ukuP","author":{"login":"geoffreytran"},"authorAssociation":"NONE","body":"That's good to know! Odd thing is, when this exception occurs, with the default keep alive settings, it doesn't seem to recover. We have an exponential retry configured to retry the start workflow call, but it keeps getting the timeout expired exception until the app is restarted.\r\n\r\nIt's been elusive to reproduce as it seems to happen sporadically, so I haven't been able to debug deeper yet, but just wanted to leave a comment in case anyone else is running into the same issue.","createdAt":"2024-03-12T15:27:48Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/158#issuecomment-1991920527","viewerDidAuthor":false}],"createdAt":"2023-11-17T13:48:30Z","labels":[{"id":"LA_kwDOInL6Hs8AAAABJH7zkA","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":158,"reactionGroups":[],"state":"CLOSED","title":"[Bug] TemporalClient timing out ","updatedAt":"2024-03-12T15:28:15Z","url":"https://github.com/temporalio/sdk-dotnet/issues/158"}
