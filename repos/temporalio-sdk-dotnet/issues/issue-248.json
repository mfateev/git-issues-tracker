{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"### Describe the bug\r\n\r\nTo replicate, make a project with this:\r\n\r\n```csharp\r\nusing Temporalio.Client;\r\nusing Temporalio.Client.Schedules;\r\nusing Temporalio.Runtime;\r\nusing Temporalio.Workflows;\r\n\r\n// Connect client\r\nvar runtime = new TemporalRuntime(new()\r\n{\r\n    Telemetry = new()\r\n    {\r\n        Logging = new()\r\n        {\r\n            // Filter = new(TelemetryFilterOptions.Level.Trace, TelemetryFilterOptions.Level.Trace),\r\n        }\r\n    }\r\n});\r\nvar client = await TemporalClient.ConnectAsync(new(\"localhost:7233\") { Runtime = runtime });\r\n\r\n// Two schedule tasks\r\nvar tasks = new List<Task<ScheduleHandle>>\r\n{\r\n    CreateScheduleAsync(),\r\n    CreateScheduleAsync(),\r\n};\r\n\r\n// Running Task.WaitAll hangs, but Task.WaitAll off the main thread or Task.WhenAll works\r\n\r\n// DOES NOT WORK:\r\nTask.WaitAll(tasks.ToArray());\r\n\r\n// WORKS:\r\n// await Task.Run(() => Task.WaitAll(tasks.ToArray()));\r\n\r\n// WORKS:\r\n// await Task.WhenAll(tasks.ToArray());\r\n\r\nforeach (var task in tasks)\r\n{\r\n    var desc = task.Result.DescribeAsync();\r\n    Console.WriteLine(\"Described schedule: {0}\", desc.Id);\r\n}\r\n\r\nasync Task<ScheduleHandle> CreateScheduleAsync()\r\n{\r\n    var action = ScheduleActionStartWorkflow.Create<MyWorkflow>(\r\n        wf => wf.RunAsync(),\r\n        new()\r\n        {\r\n            Id = $\"my-workflow-{Guid.NewGuid()}\",\r\n            TaskQueue = \"my-task-queue-{Guid.NewGuid()}\",\r\n        });\r\n    var spec = new ScheduleSpec()\r\n    {\r\n        Intervals = new List<ScheduleIntervalSpec> { new(TimeSpan.FromHours(10)) },\r\n    };\r\n    var id = $\"my-schedule-{Guid.NewGuid()}\";\r\n    Console.WriteLine(\"Starting schedule: {0}\", id);\r\n    var handle = await client.CreateScheduleAsync(id, new(action, spec));\r\n    Console.WriteLine(\"Schedule started: {0}\", id);\r\n    return handle;\r\n}\r\n\r\n[Workflow]\r\npublic class MyWorkflow\r\n{\r\n    [WorkflowRun]\r\n    public async Task<string> RunAsync() => \"done\";\r\n}\r\n```\r\n\r\nAn easy way to do this is to update `tests/Temporalio.SmokeTest/Program.cs` with this and add this in the `Temporalio.SmokeTest.csproj:\r\n\r\n```xml\r\n  <ItemGroup>\r\n    <ProjectReference Include=\"..\\..\\src\\Temporalio\\Temporalio.csproj\" />\r\n  </ItemGroup>\r\n```\r\n\r\nThen in that directory, run `dotnet run`. Note, sdk-core can be updated and `dotnet build` can be run to recompile if doing guess-and-check debugging.\r\n\r\nWhat is happening is that Tonic seems to hang when this is waited on the main thread. I have hooked up Tokio console and I see nothing obvious. I have upgraded, turned on tracing, etc and see nothing obvious. A very similar thing happened in #44 but the fix was a core/dependency upgrade yet we could not find which bug fixed it upstream in Tonic/h2/hyper/tokio.","closedAt":"2024-06-18T19:54:21Z","comments":[{"id":"IC_kwDOInL6Hs6BnBB6","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks to @robcao, the `TaskCompletionSource` can deadlock on same thread, need to supply `TaskCreationOptions.RunContinuationsAsynchronously` to the constructor so that it will schedule it elsewhere.","createdAt":"2024-06-17T21:49:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/248#issuecomment-2174488698","viewerDidAuthor":false}],"createdAt":"2024-05-15T12:59:53Z","labels":[{"id":"LA_kwDOInL6Hs8AAAABJH7zkA","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":248,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Client hangs when waiting for calls on main thread","updatedAt":"2024-06-18T19:54:21Z","url":"https://github.com/temporalio/sdk-dotnet/issues/248"}
