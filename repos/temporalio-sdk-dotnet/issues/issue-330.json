{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"### Describe the bug\r\n\r\nGiven the [KitchenSinkWorkflow.cs.txt](https://github.com/user-attachments/files/16599943/KitchenSinkWorkflow.cs.txt) workflow and [KitchenSink.cs.txt](https://github.com/user-attachments/files/16599955/KitchenSink.cs.txt) proto model (may need to adjust namespace), running the [omes-replay.json](https://github.com/user-attachments/files/16599958/omes-replay.json) history on it via a replayer gives:\r\n\r\n> Temporalio.Exceptions.WorkflowNondeterminismException : Nondeterminism: Workflow activation completion failed: Failure { failure: Some(Failure { message: \"[TMPRL1100] Nondeterminism error: Activity machine does not handle this event: HistoryEvent(id: 1182, StartChildWorkflowExecutionInitiated)\", source: \"\", stack_trace: \"\", encoded_attributes: None, cause: None, failure_info: Some(ApplicationFailureInfo(ApplicationFailureInfo { r#type: \"\", non_retryable: false, details: None, next_retry_delay: None })) }), force_cause: NonDeterministicError }\r\n\r\nThis history was obtained via https://github.com/temporalio/omes and this repo, both checked out at the time of this writing, and running this command with a dev server running:\r\n\r\n    go run ./cmd run-scenario-with-worker --scenario fuzzer --language cs --option seed=17951219391681344745 --iterations 1 --version /path/to/sdk-dotnet\r\n\r\nEach run may give a different history.\r\n\r\nWe are still investigating this. Debugging how the original run may have given a mismatching history is challenging.","closedAt":"2024-09-11T14:06:06Z","comments":[{"id":"IC_kwDOInL6Hs6IRSzk","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Here is another one history from the same scenario but with cache/sticky disabled: [omes-replay-2.json](https://github.com/user-attachments/files/16600152/omes-replay-2.json) that causes:\r\n\r\n> Temporalio.Exceptions.WorkflowNondeterminismException : Nondeterminism: Workflow activation completion failed: Failure { failure: Some(Failure { message: \"[TMPRL1100] Nondeterminism error: Timer machine does not handle this event: HistoryEvent(id: 624, ActivityTaskScheduled)\", source: \"\", stack_trace: \"\", encoded_attributes: None, cause: None, failure_info: Some(ApplicationFailureInfo(ApplicationFailureInfo { r#type: \"\", non_retryable: false, details: None, next_retry_delay: None })) }), force_cause: NonDeterministicError }\r\n","createdAt":"2024-08-13T13:18:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/330#issuecomment-2286234852","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6IR0pu","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Here's a simple test to add to SDK to replicate via replayer:\r\n\r\n```csharp\r\npublic class OmesTest : WorkflowEnvironmentTestBase\r\n{\r\n    public OmesTest(ITestOutputHelper output, WorkflowEnvironment env)\r\n        : base(output, env)\r\n    {\r\n    }\r\n\r\n    [Fact]\r\n    public async Task ReplayWorkflowAsync_NonDeterministicRunFromOmes_Fails()\r\n    {\r\n        // Replay history from JSON\r\n        var history = WorkflowHistory.FromJson(\r\n            \"w-nespuagc-1\",\r\n            TestUtils.ReadAllFileText(\"omes-replay.json\"));\r\n\r\n        var replayer = new WorkflowReplayer(\r\n            new WorkflowReplayerOptions()\r\n            {\r\n                LoggerFactory = LoggerFactory,\r\n            }.AddWorkflow<KitchenSinkWorkflow>());\r\n        await replayer.ReplayWorkflowAsync(history);\r\n    }\r\n}\r\n```","createdAt":"2024-08-13T14:16:46Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/330#issuecomment-2286373486","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6Jcyeu","author":{"login":"dandavison"},"authorAssociation":"MEMBER","body":"Here's another example from the fuzzer just in case it's useful. Sorry, the oss-cicd pipeline that caught this is not yet in a position to save and retrieve the fuzzer proto.\r\n\r\n> {\r\n  \"message\": \"[TMPRL1100] Nondeterminism error: Child workflow machine does not handle this event:HistoryEvent { event_id: 1709, event_time: Some(Timestamp { seconds: 1724331693, nanos: 159859858 }), event_type: WorkflowExecutionUpdateCompleted, version: 0, task_id: 1061367, worker_may_ignore: false, user_metadata: None, attributes: Some(WorkflowExecutionUpdateCompletedEventAttributes(WorkflowExecutionUpdateCompletedEventAttributes { meta: Some(Meta { update_id: \\\"a90bbbb8-10ca-4356-955a-66c58155cc42\\\", identity: \\\"7@oss-cicd-worker-dd844b6d4-kvh5f@\\\" }), accepted_event_id: 1692, outcome: Some(Outcome { value: Some(Success(Payloads { payloads: [Payload { metadata: {\\\"messageType\\\": \"temporal.omes.kitchen_sink.WorkflowState\", \\\"encoding\\\": \"json/protobuf\"}, data: \"{ \"kvs\": { \"1\": \"x\", \"10\": \"x\", \"12\": \"x\", \"14\": \"x\", \"2\": \"x\", \"21\": \"x\", \"22\": \"x\", \"24\": \"x\", \"29\": \"x\", \"3\": \"x\", \"34\": \"x\", \"36\": \"x\", \"40\": \"x\", \"41\": \"x\", \"45\": \"x\", \"48\": \"x\", \"53\": \"x\", \"57\": \"x\", \"59\": \"x\", \"61\": \"x\", \"72\": \"x\", \"83\": \"x\", \"84\": \"x\", \"85\": \"x\", \"89\": \"x\", \"91\": \"x\", \"93\": \"x\" } }\" }] })) }) })) }\",\r\n  \"applicationFailureInfo\": {}\r\n}\r\n","createdAt":"2024-08-23T01:48:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/330#issuecomment-2306025390","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6Jg4md","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Yeah, it's quite easy to replicate now, but I am struggling mightily to debug.","createdAt":"2024-08-23T13:29:14Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/330#issuecomment-2307099037","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6JipuY","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"After digging, this has been replicated and is believed to be a core issue. https://github.com/temporalio/sdk-core/issues/803 has been opened.","createdAt":"2024-08-23T18:01:24Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/330#issuecomment-2307562392","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6LszK2","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"This should now be fixed with the 1.3.1 release.","createdAt":"2024-09-11T14:06:06Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/330#issuecomment-2343776950","viewerDidAuthor":false}],"createdAt":"2024-08-13T13:04:13Z","labels":[{"id":"LA_kwDOInL6Hs8AAAABJH7zkA","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":330,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Non-determinism found during fuzzing","updatedAt":"2024-09-11T14:06:06Z","url":"https://github.com/temporalio/sdk-dotnet/issues/330"}
