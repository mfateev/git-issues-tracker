{"assignees":[],"author":{"id":"MDQ6VXNlcjUyMzE1MA==","is_bot":false,"login":"pauldotknopf","name":"Paul Knopf"},"body":"### What are you really trying to do?\n\nGet info about a namespace, using 1.4.0 of the .NET SDK.\n\n### Describe the bug\n\n```csharp\npublic async Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context, CancellationToken cancellationToken)\n{\n    var stopwatch = new Stopwatch();\n\n    try\n    {\n        stopwatch.Start();\n        \n        var client = await _rcmClientConnectionProvider.OpenClient();\n        \n        // Error gets thrown here.\n        var namespaceInfo = await client.WorkflowService.DescribeNamespaceAsync(\n            new Temporalio.Api.WorkflowService.V1.DescribeNamespaceRequest { Namespace = \"default\" },\n            new RpcOptions\n            {\n                CancellationToken = cancellationToken\n            }\n        );\n\n        stopwatch.Stop();\n\n        if (namespaceInfo == null)\n        {\n            return HealthCheckResult.Unhealthy(\n                $\"Temporal namespace is unreachable: elapsed: {stopwatch.Elapsed}\");\n        }\n\n        return HealthCheckResult.Healthy();\n    }\n    catch (Exception ex)\n    {\n        stopwatch.Stop();\n        return HealthCheckResult.Unhealthy($\"Temporal client is unreachable: elapsed: {stopwatch.Elapsed}\", ex);\n    }\n}\n```\n\nThe ```_rcmClientConnectionProvider``` variable is a singleton service that maintains a single ```ITemporalClient``` (through ```OpenClient```), used throughout the application (creating workflows and subscribing to task queues). It's code is like this:\n\n```csharp\npublic async Task<ITemporalClient> OpenClient()\n{\n    if (_client != null)\n    {\n        return _client;\n    }\n\n    await _semaphoreSlim.WaitAsync();\n    \n    try\n    {\n        if (_client == null)\n        {\n            var options = new TemporalClientConnectOptions\n            {\n                TargetHost = $\"{_options.HostName}:{_options.Port}\",\n                Namespace = _options.Namespace\n            };\n            if (serviceProvider.GetService(typeof(ILoggerFactory)) is ILoggerFactory loggerFactory)\n            {\n                options.LoggerFactory = loggerFactory;\n            }\n\n            try\n            {\n                _client = await TemporalClient.ConnectAsync(options);\n            }\n            catch(InvalidOperationException e)\n            {\n                if (e.Message.StartsWith(\"Connection failed: Server connection error\"))\n                {\n                    var message = $\"Failed to connect to Temporal server at {_options.HostName}:{_options.Port}\";\n                    if (_options.HostName == \"localhost\")\n                    {\n                        message += \"\\nA local instance of temporal can be ran by running 'temporal server start-dev'\";\n                    }\n                    throw new InvalidOperationException(message, e);\n                }\n\n                throw;\n            }\n        }\n\n        return _client;\n    }\n    finally\n    {\n        _semaphoreSlim.Release();\n    }\n}\n```\n\n### Minimal Reproduction\n\nIt only happens in one environment, so I fear minimal repo may be hard to do.\n\n### Environment/Versions\n\nTemporal helm chart v0.54.0.\nTemporal .NET SDK 1.4.0 (nuget)\nAzure App Service (for Linux)\n\n### Additional context\n\nThis is the complete error, being reported by App Insights.\n\n```json\n[\n  {\n    \"severityLevel\": \"Error\",\n    \"outerId\": \"0\",\n    \"message\": \"operation was canceled\",\n    \"type\": \"Temporalio.Exceptions.RpcException\",\n    \"id\": \"11222409\",\n    \"parsedStack\": [\n      {\n        \"assembly\": \"System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e\",\n        \"method\": \"System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw\",\n        \"level\": 0\n      },\n      {\n        \"assembly\": \"System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e\",\n        \"method\": \"System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification\",\n        \"level\": 1\n      },\n      {\n        \"assembly\": \"Temporalio, Version=1.4.0.0, Culture=neutral, PublicKeyToken=null\",\n        \"method\": \"Temporalio.Bridge.Client+<CallAsync>d__14`1.MoveNext\",\n        \"level\": 2\n      },\n      {\n        \"assembly\": \"System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e\",\n        \"method\": \"System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw\",\n        \"level\": 3\n      },\n      {\n        \"assembly\": \"System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e\",\n        \"method\": \"System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification\",\n        \"level\": 4\n      },\n      {\n        \"assembly\": \"Temporalio, Version=1.4.0.0, Culture=neutral, PublicKeyToken=null\",\n        \"method\": \"Temporalio.Client.TemporalConnection+<InvokeRpcAsync>d__42`1.MoveNext\",\n        \"level\": 5\n      },\n      {\n        \"assembly\": \"System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e\",\n        \"method\": \"System.Runtime.ExceptionServices.ExceptionDispatchInfo.Throw\",\n        \"level\": 6\n      },\n      {\n        \"assembly\": \"System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e\",\n        \"method\": \"System.Runtime.CompilerServices.TaskAwaiter.HandleNonSuccessAndDebuggerNotification\",\n        \"level\": 7\n      },\n      {\n        \"assembly\": \"System.Private.CoreLib, Version=8.0.0.0, Culture=neutral, PublicKeyToken=7cec85d7bea7798e\",\n        \"method\": \"System.Runtime.CompilerServices.TaskAwaiter`1.GetResult\",\n        \"level\": 8\n      },\n      {\n        \"assembly\": \"AutomatedActions.Services, Version=0.2.86.0, Culture=neutral, PublicKeyToken=null\",\n        \"method\": \"AutomatedActions.Services.HealthChecks.TemporalConnectionHealthCheck+<CheckHealthAsync>d__2.MoveNext\",\n        \"level\": 9,\n        \"line\": 26,\n        \"fileName\": \"/agent/_work/1/s/src/Workflow/src/AutomatedActions.Services/HealthChecks/TemporalConnectionHealthCheck.cs\"\n      }\n    ]\n  }\n]\n```\n\nOne this worth mentioning is that I don't think this is actually a timeout issue, because the exception is thrown immediately-ish: ```Temporal client is unreachable: elapsed: 00:00:00.0022905```.\n","closedAt":null,"comments":[{"id":"IC_kwDOInL6Hs6bQkxJ","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> It only happens in one environment, so I fear minimal repo may be hard to do.\n\nIs this only an issue on Azure or can anyone replicate it with the dev server? I fear if only one environment has the issue it may be specific to the environment. Ideally we can have a replication we can run in CI to know it has been fixed and continues to remain fixed.","createdAt":"2025-01-21T13:59:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/395#issuecomment-2604813385","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6bvzxr","author":{"login":"pauldotknopf"},"authorAssociation":"NONE","body":"Update, it's happening in every environment now..","createdAt":"2025-01-24T17:05:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/395#issuecomment-2613001323","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6bv0yh","author":{"login":"pauldotknopf"},"authorAssociation":"NONE","body":"Considering this timeout exception is being thrown immediately, should I not be sharing my ```TemporalClient``` across threads?\n\nThis particular method is a \"health check\" that's done periodically.\n\nIt doesn't look like ```TemporalClient``` implements IDisposable. Is it safe to create them and let the GC handle them? Will connection resources become starved?","createdAt":"2025-01-24T17:07:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/395#issuecomment-2613005473","viewerDidAuthor":false}],"createdAt":"2025-01-20T01:54:14Z","labels":[{"id":"LA_kwDOInL6Hs8AAAABJH7zkA","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":395,"reactionGroups":[],"state":"OPEN","title":"[Bug] Temporalio.Exceptions.RpcException:operation was canceled","updatedAt":"2025-01-24T17:07:13Z","url":"https://github.com/temporalio/sdk-dotnet/issues/395"}
