{"assignees":[],"author":{"id":"MDQ6VXNlcjY5NTExNDA=","is_bot":false,"login":"san127127","name":"Gary Lee"},"body":"### What are you really trying to do?\nI would like to use Opentelemetry trace id to correlate logs from each workflow.\nWhen I do logging in workflow and activities, I found that there is no trace ID on logs from the workflow logge.\n\n### Describe the bug\nOpenTelemetry span is not created by TracingInterceptor in workflow run methods.\n\n### Minimal Reproduction\n\nWorker and client set up\n```csharp\nvar builder = WebApplication.CreateBuilder(args);\n\nbuilder.Services.AddOpenTelemetry()\n    .WithTracing(t =>\n    {\n        t.AddSource(\n            TracingInterceptor.ClientSource.Name,\n            TracingInterceptor.WorkflowsSource.Name,\n            TracingInterceptor.ActivitiesSource.Name\n        );\n    });\n\nbuilder.Services.AddTemporalClient(x =>\n{\n    x.TargetHost = \"localhost:7233\";\n    x.Namespace = \"default\";\n    x.Interceptors = [new TracingInterceptor()];\n    x.LoggerFactory = new LoggerFactory().AddSerilog();\n});\nbuilder.Services\n    .AddHostedTemporalWorker(\n        \"my-task-queue\"\n    )\n    .AddWorkflow<SayHelloWorkflow>()\n    .AddSingletonActivities<SayHelloActivity>();\n```\n\nWorkflow and activity\n```\n[Workflow]\npublic class SayHelloWorkflow\n{\n    [WorkflowRun]\n    public async Task<string> SayHello()\n    {\n        // Activity.Current is null here\n        var traceId = Activity.Current?.TraceId.ToHexString();\n        Console.WriteLine($\"Trace id in workflow {traceId}\");\n\n        await Workflow.ExecuteActivityAsync((SayHelloActivity a) => a.SayHello(), new ActivityOptions\n        {\n            StartToCloseTimeout = TimeSpan.FromSeconds(10),\n        });\n\n        return \"ABC\";\n    }\n}\n\npublic class SayHelloActivity\n{\n    [Activity]\n    public async Task SayHello()\n    {\n        // Activity.Current is not null here\n        var traceId = Activity.Current?.TraceId.ToHexString();\n        Console.WriteLine($\"Trace id in activity {traceId}\");\n    }\n}\n\n```\n\nWhen running this workflow, trace id in workflow run will be null while trace id in activity is present.\n\n\n### Environment/Versions\n\n.NET 9 (SDK 9.0.203)\nTemporalio.Extensions.OpenTelemetry 1.5.0\n\n### Additional context\n\n<!-- Add any other context about the problem here. -->\n","closedAt":"2025-05-16T12:48:35Z","comments":[{"id":"IC_kwDOInL6Hs6r5Po6","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> `var traceId = Activity.Current?.TraceId.ToHexString();`\n> trace id in workflow run will be null while trace id in activity is present\n\nWorkflows cannot use the non-deterministic .NET activity API because the current span can be absent when replaying on different machines. This is explained in depth at https://github.com/temporalio/sdk-dotnet/tree/main/src/Temporalio.Extensions.OpenTelemetry/#workflow-tracing which also includes the warning:\n\n> ⚠️WARNING Do not use .NET diagnostic activity API inside of workflows. They are inherently non-deterministic and can lead to unpredictable behavior/traces during replay (which often only surfaces in failure scenarios).\n\n`Activity.Current` is non-deterministic, unsafe API to use in a workflow that can result in different values on replay. This is because OpenTelemetry trace/spans are process-specific (you can't create a span in one place and finish in another). If you need some sort of deterministic identifier, we recommend not using tracing identifiers, pass something more explicit instead.","createdAt":"2025-05-15T13:56:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/480#issuecomment-2883910202","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6r6tvU","author":{"login":"san127127"},"authorAssociation":"NONE","body":"hi @cretz ,\nThe biggest reason why I want an activity in workflow run is that I want to attach a trace info like trace id to logs when I do logging with `Workflow.Logger`\n\nActually, after I read the readme you gave me, I found a workaround to do what I want:\n```csharp\n[WorkflowRun]\npublic async Task SayHello()\n{\n    using var diaAct = CustomSource.TrackWorkflowDiagnosticActivity(\"SayHello\");\n\n    using var act = CustomSource.CreateActivity(\"SayHello\", ActivityKind.Server);\n    act.SetParentId(diaAct.Context.TraceId, diaAct.Context.SpanId, diaAct.Context.TraceFlags);\n    act.Start();\n\n    // This log has trace info attached now\n    Workflow.Logger.LogInformation(\"hello from WF\");\n\n    await Workflow.ExecuteActivityAsync((SayHelloActivity a) => a.SayHello(), new ActivityOptions\n    {\n        StartToCloseTimeout = TimeSpan.FromSeconds(10),\n    });\n}\n```\n\nIt looks like the `WorkflowDiagnosticActivity.Context` is persisted somewhere and remain unchanged when replaying or retrying.\n\nAnyway, I guess it is not a bug to have a null `Activity.Current` then.","createdAt":"2025-05-15T15:44:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/480#issuecomment-2884295636","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6r7WHE","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> CustomSource.CreateActivity\n\nYou should not do this in workflows because you should not use the .NET activity API in workflows. This will create an activity for _every_ replay of the workflow (so every time it resumes on another worker or a query is run after close or whatever). .NET activity APIs are not deterministic. Just use the `TrackWorkflowDiagnosticActivity`.\n\n> It looks like the `WorkflowDiagnosticActivity.Context` is persisted somewhere and remain unchanged when replaying or retrying.\n\nIt's \"replayed\" so it has the same local state but only creates the actual span/activity when first run for non-replay. .NET activity things on `WorkflowDiagnosticActivity` are unsafe as well to use.","createdAt":"2025-05-15T16:44:53Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/480#issuecomment-2884460996","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6sDnhh","author":{"login":"san127127"},"authorAssociation":"NONE","body":"> This will create an activity for every replay of the workflow (so every time it resumes on another worker or a query is run after close or whatever).\n\nMy goal is simply having a trace on workflow level with a consistent trace ID so this is actually what I want.\nI understand it is a bit hacky, but I am ok with this as long as it doesn't compromise the correctness of the workflow.\n\nThanks for your replies and advice anyway. I am closing this issue.","createdAt":"2025-05-16T12:48:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/480#issuecomment-2886629473","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6sDt8t","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> My goal is simply having a trace on workflow level with a consistent trace ID so this is actually what I want.\n\nNote, this code will not provide a consistent trace ID. Neither `dialAct` not `act` will have a consistent trace ID if this workflow moves between workers (as durable workflows are meant to do). You may want to make sure to either replay test or test this workflow running across multiple workers (e.g. restart a worker once the workflow has started the activity but before it finishes).\n\nIf you need consistent, deterministic values in a workflow, you need to obtain them deterministically (either via workflow input or via activity or deterministic random on the `Workflow` class or something).","createdAt":"2025-05-16T12:59:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/480#issuecomment-2886655789","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6sFFb2","author":{"login":"san127127"},"authorAssociation":"NONE","body":"> Note, this code will not provide a consistent trace ID. Neither dialAct not act will have a consistent trace ID if this workflow moves between workers (as durable workflows are meant to do). \n\n@cretz \nReally?\nI tried to simulate worker crashes by putting `Environment.Exit(1)` inside the workflow.\nAfter it kills the worker process, I start another worker process to trigger replaying and `diaAct.Context` is the same.\nIt looks to me the `diaAct.Context` is persisted somewhere.","createdAt":"2025-05-16T15:14:03Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/480#issuecomment-2887014134","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6sHf_i","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> I tried to simulate worker crashes by putting Environment.Exit(1) inside the workflow.\n\nNot sure this is the best simulation, but Environment.Exit inside the `SayHello` activity may be an ok representation.\n\n> It looks to me the diaAct.Context is persisted somewhere\n\nIt is not. If `TrackWorkflowDiagnosticActivity` is run on one worker, and the workflow then needs to replay on another worker, the result of `TrackWorkflowDiagnosticActivity` will be different (because only the first time did it call `ActivitySource.StartActivity`, second time just skips it).","createdAt":"2025-05-16T20:46:00Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/480#issuecomment-2887647202","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6sIsss","author":{"login":"san127127"},"authorAssociation":"NONE","body":"@cretz \n\n> Not sure this is the best simulation, but Environment.Exit inside the SayHello activity may be an ok representation.\n\nI believe both are good simulation, you can have a worker crash in workflow run rather than in activity\n\n> It is not. If TrackWorkflowDiagnosticActivity is run on one worker, and the workflow then needs to replay on another worker, the result of TrackWorkflowDiagnosticActivity will be different\n\nI don't think so, the trace ID and span ID etc seems to be the same across worker processes.\nThere were two worker processes running the same workflow in the above experiment.\n\nJust in case, I even tried to the following workflow using two computers\n```csharp\n [WorkflowRun]\n public async Task SayHello()\n {\n     using var diaAct = CustomSource.TrackWorkflowDiagnosticActivity(\"Test\");\n\n     using var act = CustomSource.CreateActivity(\"WF\", ActivityKind.Server);\n     act.SetParentId(diaAct.Context.TraceId, diaAct.Context.SpanId, diaAct.Context.TraceFlags);\n     act.Start();\n\n     Workflow.UpsertMemo([\n         MemoUpdate.ValueSet(\"TraceId\", diaAct.Context.TraceId.ToHexString()),\n     ]);\n\n     Workflow.Logger.LogInformation(\"WF T:{TraceId} S:{SpanId} P:{ParentSpanId}\", act.Context.TraceId, act.Context.SpanId, act.ParentSpanId);\n\n     var id1 = await Workflow.ExecuteActivityAsync((SayHelloActivity a) => a.SayHello(4), new ActivityOptions\n     {\n         StartToCloseTimeout = TimeSpan.FromSeconds(10),\n     });\n\n     // Crash here on the first worker\n     // Removed on the second worker\n     Environment.Exit(1);\n\n     var id2 = await Workflow.ExecuteActivityAsync((SayHelloActivity a) => a.SayHello(5), new ActivityOptions\n     {\n         StartToCloseTimeout = TimeSpan.FromSeconds(10),\n     });\n\n     var id3 = await Workflow.ExecuteActivityAsync((SayHelloActivity a) => a.SayHello(6), new ActivityOptions\n     {\n         StartToCloseTimeout = TimeSpan.FromSeconds(10),\n     });\n }\n```\n\n```csharp\npublic class SayHelloActivity(ILogger<SayHelloActivity> _logger)\n{\n    [Activity]\n    public async Task<string?> SayHello(int i)\n    {\n        var act = Activity.Current;\n\n        _logger.LogInformation(\"Activity {i} T:{TraceId} S:{SpanId} P:{ParentSpanId}\", i, act.Context.TraceId, act.Context.SpanId, act.ParentSpanId);\n        return Activity.Current?.Id;\n    }\n}\n```\n\nAnd here is the result.\nNote that the activity results are the traceparent from each activity\n![Image](https://github.com/user-attachments/assets/2f52338c-9afe-43af-bde9-8dc4ef612325)\n\nThis suggests to me either the trace id is persisted somewhere or they are generated in some deterministic ways.","createdAt":"2025-05-17T02:02:27Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/480#issuecomment-2887961388","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6sT2Do","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Just in case, I even tried to the following workflow using two computers\n\nTry setting worker option `MaxCachedWorkflows` to `0`, you won't need two computers since every step will replay from the beginning every time. But yes, maybe trace ID is actually coming from the persisted parent here which is set on client call and is in history as a header on the start event. Therefore so long as you don't start via CLI or UI or a .NET client without this interceptor, it may be stable (though you usually don't want to rely on how it is started). I expect `diaAct.Context.SpanId` to be unstable however.","createdAt":"2025-05-19T12:46:32Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/480#issuecomment-2890883304","viewerDidAuthor":false}],"createdAt":"2025-05-15T01:28:48Z","labels":[{"id":"LA_kwDOInL6Hs8AAAABJH7zkA","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":480,"reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"state":"CLOSED","title":"[Bug] OpenTelemetry TracingInterceptor doesn't create a span in workflow run method","updatedAt":"2025-05-19T12:46:54Z","url":"https://github.com/temporalio/sdk-dotnet/issues/480"}
