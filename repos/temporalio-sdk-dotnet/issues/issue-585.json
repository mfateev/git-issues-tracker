{"assignees":[],"author":{"id":"U_kgDOCVDSzw","is_bot":false,"login":"neeraj-mathur","name":""},"body":"Hello Team,\n\nI am attempting to implement a caller Workflow that invokes a long-running Nexus operation with a 2-hour timeout. In the code below, I have explicitly configured the Nexus operation using:\n\nScheduleToCloseTimeout = TimeSpan.FromHours(2)\n\nHowever, during execution, I observe in the Temporal UI that the Nexus operation is being retried approximately every 10 seconds. Additionally, the invoked Nexus operation logs a warning with the message:\n\n“Nexus task not found on completion.”\n\nThis behavior suggests that the configured long Nexus operation timeout is not being honored as expected.\n\nCould someone please help identify what is incorrect or missing in the code that would cause the Nexus operation to retry at short intervals instead of respecting the configured 2-hour timeout?\n\n\n`WARN temporal_sdk_core::worker::nexus: Nexus task not found on completion. This may happen if the operation has already been cancelled but completed anyway. details=Status { code: NotFound, message: \"Nexus task not found or already expired\", details: b\"\\x08\\x05\\x12'Nexus task not found or already expired\\x1aB\\n@type.googleapis.com/temporal.api.errordetails.v1.NotFoundFailure\", metadata: MetadataMap { headers: {\"content-type\": \"application/grpc\"} }, source: None }`\n\n\n```\nusing Adapter.DataIngestor;\nusing Adapter.DataIngestor.Models;\nusing System;\nusing System.IO;\nusing System.Threading.Tasks;\nusing Temporalio.Client;\nusing Temporalio.Worker;\nusing Xunit;\n\nnamespace Adapter.DataIngestor.Tests;\n\n/// <summary>\n/// Simple Nexus Caller Workflow Test - following the pattern from:\n/// https://github.com/temporalio/samples-dotnet/blob/main/src/NexusSimple/Program.cs\n/// https://github.com/temporalio/samples-dotnet/blob/main/src/NexusSimple/Caller/HelloCallerWorkflow.workflow.cs\n/// </summary>\npublic class SimpleNexusCallerWorkflowTest : IAsyncLifetime\n{\n    private TemporalClient? _temporalClient;\n    private const string TemporalHost = \"localhost:7233\";\n    private const string TemporalNamespace = \"default\";\n    private const long TestProjectId = 1L;\n    private const long TestUserId = 67890L;\n    private static readonly long? TestCompanyId = 1L;\n\n    public async Task InitializeAsync()\n    {\n        try\n        {\n            // Connect to Temporal server\n            _temporalClient = await TemporalClient.ConnectAsync(new()\n            {\n                TargetHost = TemporalHost,\n                Namespace = TemporalNamespace\n            });\n        }\n        catch (Exception ex)\n        {\n            throw new InvalidOperationException(\n                $\"Failed to connect to Temporal server at {TemporalHost}. \" +\n                \"Ensure Temporal server is running. \" +\n                $\"Error: {ex.Message}\", ex);\n        }\n    }\n\n    public Task DisposeAsync()\n    {\n        _temporalClient = null;\n        return Task.CompletedTask;\n    }\n\n    [Fact]\n    [Trait(\"Category\", \"Integration\")]\n    public async Task NexusCallerWorkflow_ProcessNeedsFile_ShouldComplete()\n    {\n        // Arrange\n        var jsonFilePath = GetTestMaterialNeedsFilePath();\n        Assert.True(File.Exists(jsonFilePath), $\"Test JSON file not found at: {jsonFilePath}\");\n\n        var input = new ProcessNeedsFileInput\n        {\n            FilePath = jsonFilePath,\n            CorrelationId = Guid.NewGuid().ToString(),\n            ProjectId = TestProjectId,\n            UserId = TestUserId,\n            CompanyId = TestCompanyId\n        };\n\n        // Act\n        var result = await ExecuteCallerWorkflowAsync(input);\n\n        // Assert\n        Assert.NotNull(result);\n        Assert.Equal(input.CorrelationId, result.CorrelationId);\n        \n        Console.WriteLine($\"Processing completed. Success: {result.Success}\");\n        Console.WriteLine($\"Headers Processed: {result.HeadersProcessed}\");\n        Console.WriteLine($\"Lines Processed: {result.LinesProcessed}\");\n        Console.WriteLine($\"Errors Count: {result.Errors.Count}\");\n    }\n\n    /// <summary>\n    /// Execute the caller workflow that invokes the Nexus operation.\n    /// Following the pattern from: https://github.com/temporalio/samples-dotnet/blob/main/src/NexusSimple/Program.cs\n    /// </summary>\n    private async Task<ProcessNeedsFileOutput> ExecuteCallerWorkflowAsync(ProcessNeedsFileInput input)\n    {\n        if (_temporalClient == null)\n        {\n            throw new InvalidOperationException(\"Temporal client is not initialized.\");\n        }\n\n        // Create a temporary task queue for this test\n        var testTaskQueue = $\"test-caller-queue-{Guid.NewGuid()}\";\n\n        // Create and run a worker with the caller workflow\n        using var worker = new TemporalWorker(\n            _temporalClient,\n            new TemporalWorkerOptions(testTaskQueue)\n                .AddWorkflow<ProcessNeedsCallerWorkflow>());\n\n        // Execute the worker and workflow\n        return await worker.ExecuteAsync(async () =>\n        {\n            Console.WriteLine(\"Executing caller workflow\");\n            \n            var result = await _temporalClient.ExecuteWorkflowAsync(\n                (ProcessNeedsCallerWorkflow wf) => wf.RunAsync(input),\n                new(id: $\"nexus-caller-wf-{Guid.NewGuid()}\", taskQueue: testTaskQueue)\n                {\n                    // Workflow execution timeout - total time for the workflow\n                    ExecutionTimeout = TimeSpan.FromHours(2.5),\n                    // Run timeout - time for a single workflow run\n                    RunTimeout = TimeSpan.FromHours(2.5)\n                });\n\n            Console.WriteLine($\"Workflow result: Success={result.Success}, \" +\n                            $\"Headers={result.HeadersProcessed}, \" +\n                            $\"Lines={result.LinesProcessed}\");\n            \n            return result;\n        });\n    }\n\n    /// <summary>\n    /// Gets the path to the Material_Needs.json file\n    /// </summary>\n    private static string GetTestMaterialNeedsFilePath()\n    {\n        var testAssemblyLocation = typeof(SimpleNexusCallerWorkflowTest).Assembly.Location;\n        var testAssemblyDir = Path.GetDirectoryName(testAssemblyLocation);\n        \n        if (string.IsNullOrEmpty(testAssemblyDir))\n        {\n            testAssemblyDir = Directory.GetCurrentDirectory();\n        }\n\n        // Navigate to test project directory\n        var testProjectDir = Path.GetFullPath(Path.Combine(testAssemblyDir, \"..\", \"..\", \"..\"));\n        var jsonPath = Path.Combine(testProjectDir, \"Material_Needs.json\");\n\n        if (!File.Exists(jsonPath))\n        {\n            // Try current directory\n            var currentDir = Directory.GetCurrentDirectory();\n            if (currentDir.Contains(\"Adapter.DataIngestor.Tests\"))\n            {\n                var altJsonPath = Path.Combine(currentDir, \"Material_Needs.json\");\n                if (File.Exists(altJsonPath))\n                {\n                    return altJsonPath;\n                }\n            }\n            \n            // Try relative to working directory\n            var cwdJsonPath = Path.GetFullPath(Path.Combine(\"test\", \"Adapter.DataIngestor.Tests\", \"Material_Needs.json\"));\n            if (File.Exists(cwdJsonPath))\n            {\n                return cwdJsonPath;\n            }\n        }\n\n        return jsonPath;\n    }\n}\n```\n\n```\nusing Adapter.DataIngestor;\nusing Adapter.DataIngestor.Models;\nusing System;\nusing System.Linq;\nusing System.Reflection;\nusing System.Threading.Tasks;\nusing Temporalio.Nexus;\nusing Temporalio.Workflows;\n\nnamespace Adapter.DataIngestor.Tests;\n\n/// <summary>\n/// Simple caller workflow that invokes the ProcessNeedsFile Nexus operation.\n/// Following the pattern from:\n/// https://github.com/temporalio/samples-dotnet/blob/main/src/NexusSimple/Caller/HelloCallerWorkflow.workflow.cs\n/// https://github.com/temporalio/samples-dotnet/blob/main/src/NexusSimple/Caller/EchoCallerWorkflow.workflow.cs\n/// \n/// This is a long-running Nexus operation with:\n/// - 2 hour timeout\n/// - No retries (failures are returned as error results)\n/// </summary>\n[Workflow]\npublic class ProcessNeedsCallerWorkflow\n{\n    [WorkflowRun]\n    public async Task<ProcessNeedsFileOutput> RunAsync(ProcessNeedsFileInput input)\n    {\n        // Create Nexus operation options\n        // - 2 hour timeout for long-running operation (handled by ScheduleToCloseTimeout)\n        // - No built-in retry policy configuration (handled by error return)\n        // Note: DO NOT create CancellationTokenSource in workflows - it's non-deterministic!\n        var options = new NexusOperationOptions\n        {\n            ScheduleToCloseTimeout = TimeSpan.FromHours(2)\n        };\n\n        // Create typed Nexus client\n        var nexusClient = Workflow.CreateNexusClient<INeedsIngestionService>(\n            INeedsIngestionService.EndpointName);\n\n        // Use reflection to invoke ExecuteNexusOperationAsync with options\n        // This is necessary because the SDK's expression-based API doesn't expose the options parameter\n        var clientType = nexusClient.GetType();\n        var executeMethod = clientType.GetMethods(BindingFlags.Public | BindingFlags.Instance)\n            .FirstOrDefault(m =>\n                m.Name == \"ExecuteNexusOperationAsync\" &&\n                m.IsGenericMethod &&\n                m.GetGenericArguments().Length == 1 &&\n                m.GetParameters().Length == 3 &&\n                m.GetParameters()[0].ParameterType == typeof(string) &&\n                m.GetParameters()[1].ParameterType == typeof(object) &&\n                m.GetParameters()[2].ParameterType.Name == \"NexusOperationOptions\");\n\n        if (executeMethod == null)\n        {\n            throw new InvalidOperationException(\n                \"ExecuteNexusOperationAsync method with NexusOperationOptions not found. \" +\n                \"SDK version mismatch?\");\n        }\n\n        // Make generic method for output type\n        var genericMethod = executeMethod.MakeGenericMethod(typeof(ProcessNeedsFileOutput));\n\n        try\n        {\n            // Invoke the Nexus operation with 2-hour timeout, no retries\n            var task = (Task<ProcessNeedsFileOutput>)genericMethod.Invoke(\n                nexusClient,\n                new object[]\n                {\n                    nameof(INeedsIngestionService.ProcessNeedsFile),\n                    input,\n                    options\n                })!;\n\n            var result = await task;\n            return result;\n        }\n        catch (Exception ex)\n        {\n            // No retries - return error result immediately\n            return new ProcessNeedsFileOutput\n            {\n                CorrelationId = input.CorrelationId,\n                Success = false,\n                HeadersProcessed = 0,\n                LinesProcessed = 0,\n                Errors = new List<string>\n                {\n                    $\"Nexus operation failed: {ex.Message}\",\n                    $\"Exception type: {ex.GetType().Name}\",\n                    \"Operation will not be retried per configuration.\"\n                }\n            };\n        }\n    }\n}\n\n\n\n```\n\n<img width=\"3776\" height=\"2284\" alt=\"Image\" src=\"https://github.com/user-attachments/assets/18c309d9-d3f4-4039-8a41-43da88611fed\" />\n\n[019b8f8b-d58d-7635-8a48-f792f559a02d_events.json](https://github.com/user-attachments/files/24439190/019b8f8b-d58d-7635-8a48-f792f559a02d_events.json)\n","closedAt":"2026-01-06T12:17:22Z","comments":[{"id":"IC_kwDOInL6Hs7dP1-P","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Starting a Nexus operation has a built-in timeout of 10 seconds before the start is retried. This is mostly unrelated to operation timeout (i.e. schedule to close). A Nexus operation can either be synchronous (completing effectively immediately and returning) or asynchronous (can take a while and returns operation ID/handle). Asynchronous operations are only supported with backing workflows at this time, though we plan to allow general purpose async operations in the near future.\n\nWhat does your implementation of `INeedsIngestionService.ProcessNeedsFile` look like? It should effectively complete almost immediately either with a sync result, or an async result via a started workflow.","createdAt":"2026-01-05T20:06:18Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/585#issuecomment-3711917967","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs7dQDz9","author":{"login":"prasek"},"authorAssociation":"MEMBER","body":"Nexus handlers should be used to quickly handoff to a reliable backend like Temporal in [< 10 seconds](https://docs.temporal.io/nexus/operations#synchronous-operation-lifecycle).\n\nFor long running [Async Nexus Operations](https://docs.temporal.io/nexus/operations#asynchronous-operation-lifecycle), we recommend backing the Nexus Operation with a Temporal Workflow like this: \nhttps://docs.temporal.io/develop/dotnet/nexus#develop-an-asynchronous-nexus-operation-handler-to-start-a-workflow\n\nAlso note the [automatic retry](https://docs.temporal.io/nexus/operations#automatic-retries) and [circuit breaking](https://docs.temporal.io/nexus/operations#circuit-breaking) behavior.","createdAt":"2026-01-05T20:27:22Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/585#issuecomment-3711974653","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs7dT2Ay","author":{"login":"neeraj-mathur"},"authorAssociation":"NONE","body":"Thank you for the clarification. It appears that I need to migrate to an asynchronous Nexus operation handler.\n\nThe Nexus operation INeedsIngestionService.ProcessNeedsFile is a long-running process that performs a large file import. The operation is expected to take a significant amount of time to complete, with a maximum execution duration of approximately two hours, depending on the size and complexity of the data being processed.","createdAt":"2026-01-06T03:28:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/585#issuecomment-3712966706","viewerDidAuthor":false}],"createdAt":"2026-01-05T19:11:12Z","labels":[],"milestone":null,"number":585,"reactionGroups":[],"state":"CLOSED","title":"Nexus operation ignores ScheduleToCloseTimeout and retries every 10 seconds","updatedAt":"2026-01-06T12:17:22Z","url":"https://github.com/temporalio/sdk-dotnet/issues/585"}
