{"assignees":[],"author":{"id":"MDQ6VXNlcjY5NjQ5Ng==","is_bot":false,"login":"travismcchesney","name":"Travis McChesney"},"body":"### What are you really trying to do?\n\nIn a codec that I'm writing, I would like to return the _unaltered_ payload in certain cases (both on encode and decode), without cloning the payload.\n\n### Describe the bug\n\nIf a codec returns the originally provided, _unaltered_, payload (either from encode or decode), a seemingly unrelated error is produced:\n\n```\n[10:45:36] warn: Temporalio.Workflow:MyWorkflow[0]\n      Failed activation on workflow MyWorkflow with ID activity-large-workflow-id and run ID a9a0d02d-b467-40e1-b7d1-cb9435075afc\n      System.Collections.Generic.KeyNotFoundException: The given key was not present in the dictionary.\n         at Google.Protobuf.Collections.MapField`2.get_Item(TKey key)\n         at Temporalio.Converters.DefaultPayloadConverter.ToValue(Payload payload, Type type)\n         at Temporalio.Converters.ConverterExtensions.ToValue[T](IPayloadConverter converter, Payload payload)\n         at Temporalio.Worker.WorkflowInstance.OutboundImpl.<>c__DisplayClass11_0`1.<<ExecuteActivityInternalAsync>b__0>d.MoveNext()\n      --- End of stack trace from previous location ---\n         at TemporalioSamples.ActivitySimple.MyWorkflow.RunAsync() in /Users/travis/CloudElements/TaaS/prod-test/dotnet/ActivitySimple/MyWorkflow.workflow.cs:line 16\n         at Temporalio.Worker.WorkflowInstance.InboundImpl.ExecuteWorkflowAsync(ExecuteWorkflowInput input)\n         at Temporalio.Worker.WorkflowInstance.<ApplyInitializeWorkflow>b__164_1()\n         at Temporalio.Worker.WorkflowInstance.RunTopLevelAsync(Func`1 func)\n         at Temporalio.Worker.WorkflowInstance.RunOnce(Boolean checkConditions)\n         at Temporalio.Worker.WorkflowInstance.Activate(WorkflowActivation act)\n```\n\nNote that if you return a `Clone()`ed payload, or an entirely new payload, this error goes away. \n\n### Minimal Reproduction\n\nSee this repo for repro: https://github.com/travismcchesney/temporal-codec-repro\n\n### Environment/Versions\n\n- OS and processor: M3 Mac OS Sonoma 14.7.4\n- Temporal Version: CLI 1.1.1 (Server 1.25.1, UI 2.31.2), .NET SDK 1.15.0\n- Are you using Docker or Kubernetes or building Temporal from source?\n\n### Additional context\n\nThis is likely related to this issue: https://github.com/temporalio/sdk-dotnet/issues/234. I'm not sure what the right answer is. Without changing anything, it could just be mandated that even unaltered payloads need to be `Clone()`ed , but there is just some mixed messaging in the sample code (see below).\n\nBased on the testing, I suspect that when this happens in the encryption example, it would likely fail: https://github.com/temporalio/samples-dotnet/blob/main/src/Encryption/Codec/EncryptionCodec.cs#L50\n\nMy guess is that this bit of code in the SDK is causing the problem: https://github.com/temporalio/sdk-dotnet/blob/main/src/Temporalio/Worker/WorkflowCodecHelper.cs#L280-L282","closedAt":"2025-03-17T17:12:02Z","comments":[{"id":"IC_kwDOInL6Hs6gQv_F","author":{"login":"travismcchesney"},"authorAssociation":"CONTRIBUTOR","body":"Note that if this is something you want to address in some way, I'm happy to contribute a fix. Just need guidance on the appetite to do anything about it, and what that might look like.","createdAt":"2025-02-27T18:17:30Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/417#issuecomment-2688745413","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs6gR-6u","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Thanks! So yes that is the bit of code that is causing the problem. I agree there is mixed messaging in that sample allows ignoring payloads but the SDK does not. So this is for sure a bug IMO.\n\nWe have that bit because we assume the payload is always mutated and it is expensive to do protobuf equality. However, we'd be ok with identity/reference equality check I think, and we'd definitely welcome a PR here. So ideally the PR would probably surround those three lines with a `if (!Object.ReferenceEquals(encoded, payload)) {` type of check and have some test that fails today but will pass with the new code in place.\n\nIf you can't get around to this no problem, we can get to it (though may not be until second week in March).","createdAt":"2025-02-27T20:42:21Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/417#issuecomment-2689068718","viewerDidAuthor":false}],"createdAt":"2025-02-27T18:15:01Z","labels":[{"id":"LA_kwDOInL6Hs8AAAABJH7zkA","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":417,"reactionGroups":[],"state":"CLOSED","title":"[Bug] Returning original unaltered payload from codec causes error","updatedAt":"2025-03-17T17:12:02Z","url":"https://github.com/temporalio/sdk-dotnet/issues/417"}
