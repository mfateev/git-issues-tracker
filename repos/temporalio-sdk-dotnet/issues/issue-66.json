{"assignees":[],"author":{"id":"MDQ6VXNlcjMyNjA4MTI=","is_bot":false,"login":"m-wild","name":"Michael Wildman"},"body":"Is there any advice for how to perform dependency injection - particularly services with a Scoped lifetime - with the .NET SDK?\r\n\r\nIt appears the workflow instance is created from the Type using `Activator.CreateInstance(Type)`.\r\nThis works fine for the workflow as it must be deterministic.\r\n\r\nHowever, it appears the responsibility for creating the Activity instance is not part of the SDK, Activity Delegates must be passed to the TemporalWorkerOptions.\r\nFor the simple demo code this is fine\r\n\r\n\r\n```cs\r\nvar activities = new MyActivities();\r\n\r\nusing var worker = new TemporalWorker(client,\r\n    new()\r\n    {\r\n        Activities = { activities.SayHello },\r\n        ...\r\n    });\r\n```\r\n\r\nBut what if MyActivites has dependencies registered in the DI container with a Scoped lifetime?\r\n\r\nThe only thing I can think is to manually inject the IServiceProvider into the activity class and handle the service scope manually in user code.\r\n\r\n```cs\r\n// Worker.cs ----------------\r\npublic class Worker : BackgroundService\r\n{\r\n    private readonly IServiceProvider serviceProvider; // from DI container\r\n\r\n    protected override async Task ExecuteAsync(CancellationToken stoppingToken)\r\n    {\r\n        var activities = new MyActivities(serviceProvider);\r\n\r\n        using var worker = new TemporalWorker(client,\r\n            new()\r\n            {\r\n                Activities = { activities.SayHello },\r\n                ...\r\n            });\r\n    }\r\n}\r\n\r\n// MyActivities.cs ----------------\r\npublic class MyActivities\r\n{\r\n    private readonly IServiceProvider serviceProvider;\r\n\r\n    public MyActivities(IServiceProvider serviceProvider) => this.serviceProvider = serviceProvider;\r\n\r\n    [Activity]\r\n    public string SayHello(string name)\r\n    {\r\n        using var scope = serviceProvider.CreateScope();\r\n        var greeter = scope.ServiceProvider.GetRequiredService<IGreeter>();\r\n\r\n        return greeter.Greet(name);\r\n    }\r\n}\r\n```\r\n\r\nDoes this seem okay? \r\n\r\nIs the SDK planning to integrate with Microsoft.Extensions.DependencyInjection?\r\nI could imagine a solution would be passing the IServiceProvider to the TemporalWorkerOptions and letting the SDK manage the activity instance lifecycle, creating and disposing them as required.\r\n\r\n```cs\r\nusing var worker = new TemporalWorker(client,\r\n    new()\r\n    {\r\n        Activities = { typeof(MyActivities) }, // can just pass the Activity type, instance will be created when needed\r\n        ServiceProvider = serviceProvider, // used to resolve Activity instances\r\n        ...\r\n    });\r\n```\r\n\r\n","closedAt":"2023-06-28T13:30:38Z","comments":[{"id":"IC_kwDOInL6Hs5cIpF1","author":{"login":"devbased"},"authorAssociation":"NONE","body":"This is an expected feature. Currently, you can use https://github.com/devbased/temporal-activity-gen or do something similar. Additionally, according to @cretz, DI activity can be implemented using Interceptors, although I'm not entirely sure how to do it, and there is no example of that created yet (see: https://github.com/temporalio/samples-dotnet/issues/9).","createdAt":"2023-05-12T13:40:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/66#issuecomment-1545769333","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5cJZLy","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":":+1: to what @devbased said. As part of #62 I will be reworking activity definitions so technically a factory can be provided for activity classes (so you can use a service provider to create one) and I will be making the sample reflect that when released (https://github.com/temporalio/samples-dotnet/issues/9 as linked before).","createdAt":"2023-05-12T16:02:43Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/66#issuecomment-1545966322","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5dfs47","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I have created a sample at https://github.com/temporalio/samples-dotnet/pull/16. Review welcome. Still trying to avoid infecting this project with assumptions of DI, but we may be able to do some, see that PR for options.","createdAt":"2023-05-30T14:58:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/sdk-dotnet/issues/66#issuecomment-1568591419","viewerDidAuthor":false},{"id":"IC_kwDOInL6Hs5gDEhK","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"We now have a dependency injection extension as part of #92.","createdAt":"2023-06-28T13:30:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/sdk-dotnet/issues/66#issuecomment-1611417674","viewerDidAuthor":false}],"createdAt":"2023-05-12T01:18:43Z","labels":[],"milestone":null,"number":66,"reactionGroups":[],"state":"CLOSED","title":"[Question] Action Dependency Injection","updatedAt":"2023-06-28T13:30:39Z","url":"https://github.com/temporalio/sdk-dotnet/issues/66"}
