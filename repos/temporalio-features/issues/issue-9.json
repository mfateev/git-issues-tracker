{"assignees":[],"author":{"id":"MDQ6VXNlcjQwNDI0MTA=","is_bot":false,"login":"rohitgup14","name":"Rohit Gupta"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\nDuring one of the issues while debugging with customer it was noticed that error message when client cert is expired is not very useful and clear. \r\n\r\nCurrent error message says `Context deadline exceeded`\r\n\r\n### Describe the solution you'd like\r\n\r\nHave a message which clearly states `Expired Certificate or something equivalent`. Also it will be beneficial if we can have error code associated with this message\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context or screenshots about the feature request here. -->\r\n","closedAt":null,"comments":[{"id":"IC_kwDOGflYbs48PE4O","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"There are two two more related asks:\r\n\r\n1. For SDK to auto-reload certificates from the file system. This will make it work well with the typical setup when certificates are injected via a mounted and get refreshed there by the infrastructure.\r\n2. Produce a metric with remaining time until expiration of certificates. That will allow users to monitor and alert before a client certificate expires.","createdAt":"2022-01-12T03:06:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/9#issuecomment-1010585102","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs48Q92S","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@sergeybykov -\r\n\r\n1. File-system based certs are not even a part of at least the Go SDKs, we just accept the normal TLS config that all HTTP-based client libraries do. In many cases, people can live generate them, load them from Vault, whatever. We shouldn't even assume disk is present if we don't have to. Rather, we may be able to provide a \"certificate getter\" that is auto-reinvoked or a \"certificate setter\" that a user is expected to reinvoke on SIGUSR1 or expiration or whatever.\r\n2. Metrics don't really keep time remaining, and since they are numbers, we can have something like \"unix timestamp\" of expiration. But really, as a library, any caller can just as easily obtain this value themselves when they load their certificate.\r\n\r\nAre there any other examples of, say, gRPC/HTTP-based client libraries (Go, TS, Java, etc) that handle certificate refresh internally we can look to for inspiration? Usually one might expect this to be a caller problem like any other HTTP client. For instance, in Go, one might expect them to provide `GetClientCertificate` on [tls.Config](https://pkg.go.dev/crypto/tls#Config). I think we can add a sample or even some helpers to help with this.","createdAt":"2022-01-12T14:06:56Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/9#issuecomment-1011080594","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs48Rr6j","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"> Usually one might expect this to be a caller problem like any other HTTP client\r\n\r\nYeah, it seems a bit odd to me that any \"long lived process with an HTTPS client\" would all have to implement some kind of periodic cert refresh in an independent way.\r\n\r\nWe definitely should do it if there's no other good way, but I'd hope there's some reasonable generic approach here.","createdAt":"2022-01-12T17:11:10Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/9#issuecomment-1011269283","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs48Ru-Z","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"ðŸ‘ to what @cretz said.\r\n\r\nAs a first step I'd verify that the right error is propagated from the SDK and that we don't attempt to reconnect in face of such errors. At least then the easy solution would be to crash the process so a new one can be started and certificates would be reloaded.","createdAt":"2022-01-12T17:24:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/9#issuecomment-1011281817","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs48SRrn","author":{"login":"sergeybykov"},"authorAssociation":"MEMBER","body":"I think a certificate getter callback would cover most of the typical cases. `GetClientCertificate` is a good example IMO.","createdAt":"2022-01-12T20:27:41Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/9#issuecomment-1011423975","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs480e6o","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Ok, I have done research on this for Go. See the attached script at [main.go.txt](https://github.com/temporalio/sdk-features/files/7927798/main.go.txt) to replicate.\r\n\r\nBasically I start a reverse proxy w/ a good client cert, change that to being a bad client cert, then change it back waiting a bit between all steps. What I learned:\r\n\r\n* gRPC is built to retry on these failures and does so with no logs of its own\r\n* We record the poll error once it has timed out, but we do it at the `DEBUG` level, and it's generic, and you have to opt-into it via https://pkg.go.dev/go.temporal.io/sdk/worker#EnableVerboseLogging\r\n* The client doesn't not know the reason for handshake failure, but the default Go HTTP server logs it properly (though the gRPC server may not log this properly):\r\n> http: TLS handshake error from 127.0.0.1:63353: tls: failed to verify client certificate: x509: certificate has expired or is not yet valid: current time 2022-01-24T11:54:58-06:00 is after 2022-01-19T17:54:56\r\n* The server just aborts the invalid handshake\r\n\r\nThe onus is really on the server to report its reasons for cert validation failure. We can bump the poll-failure SDK logs to `WARN` if desired, but they still only output one of these two lines:\r\n\r\n> Error last connection error: connection closed before server preface received\r\n> Error last connection error: use of closed network connection","createdAt":"2022-01-24T18:08:19Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/9#issuecomment-1020391080","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs480f00","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"> Error last connection error: connection closed before server preface received\r\n\r\nThis might be helpful but we'd probably prefer metrics over logs\r\n\r\n> Error last connection error: use of closed network connection\r\n\r\nThis one just sounds like an SDK bug\r\n\r\nDoes Temporal have any metrics for connection failures and more specifically TLS failures?","createdAt":"2022-01-24T18:12:07Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/9#issuecomment-1020394804","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs480iGW","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> This might be helpful but we'd probably prefer metrics over logs\r\n\r\nWe do already have `temporal_long_request_failure` which is basically this (we don't long poll for much else IIRC). But we can make a special metric for poll failures if wanted.\r\n\r\n> This one just sounds like an SDK bug\r\n\r\nIt's not, this is how gRPC operates. It tries until timeout and reports the last error. This is unrelated to SDK.\r\n\r\n> Does Temporal have any metrics for connection failures and more specifically TLS failures?\r\n\r\nI do not know, but it probably should. It is the server that knows why it's closing the connection.","createdAt":"2022-01-24T18:21:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/9#issuecomment-1020404118","viewerDidAuthor":false}],"createdAt":"2022-01-06T18:21:54Z","labels":[{"id":"LA_kwDOGflYbs7XtLc6","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":9,"reactionGroups":[],"state":"OPEN","title":"[Feature Request] Enhance error message & add error code for expired client cert","updatedAt":"2024-07-13T01:08:43Z","url":"https://github.com/temporalio/features/issues/9"}
