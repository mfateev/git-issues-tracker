{"assignees":[],"author":{"id":"MDQ6VXNlcjUyMjA1","is_bot":false,"login":"dandavison","name":"Dan Davison"},"body":"See e.g. https://github.com/temporalio/features/actions/runs/12835436433/job/35794872814?pr=577\n\nThe workflow seems to be exiting prematurely. Let's double-check that the assertions are being made at the correct point in the workflow lifecycle also.\n\n@roxblnfk @rustation\n\n\n<details>\n\n```\nRunning check Harness\\Feature\\ContinueAsNew\\ContinueAsSame\\FeatureChecker::check FAILED\nTemporal\\Exception\\Client\\TimeoutException {#325\n  #message: \"Deadline Exceeded (code: 4)\"\n  #code: 4\n  #file: \"./vendor/temporal/sdk/src/Client/GRPC/BaseClient.php\"\n  #line: 291\n  -previous: Temporal\\Exception\\Client\\ServiceClientException {#307\n    #message: \"Deadline Exceeded (code: 4)\"\n    #code: 4\n    #file: \"./vendor/temporal/sdk/src/Client/GRPC/BaseClient.php\"\n    #line: [28](https://github.com/temporalio/features/actions/runs/12835436433/job/35794872814?pr=577#step:9:29)4\n    -status: Google\\Rpc\\Status {#314\n      message: \"google.rpc.Status\"\n      values: []\n    }\n    trace: {\n      ./vendor/temporal/sdk/src/Client/GRPC/BaseClient.php:284 { â€¦}\n      ./vendor/temporal/sdk/src/Client/GRPC/BaseClient.php:252 { â€¦}\n      ./vendor/temporal/sdk/src/Client/GRPC/ServiceClient.php:137 { â€¦}\n      ./vendor/temporal/sdk/src/Internal/Client/WorkflowStub.php:576 { â€¦}\n      ./vendor/temporal/sdk/src/Internal/Client/WorkflowStub.php:491 { â€¦}\n      ./vendor/temporal/sdk/src/Internal/Client/WorkflowStub.php:423 { â€¦}\n      ./vendor/temporal/sdk/src/Internal/Interceptor/Pipeline.php:92 { â€¦}\n      ./vendor/temporal/sdk/src/Internal/Client/WorkflowStub.php:432 { â€¦}\n      /app/features/continue_as_new/continue_as_same/feature.php:62 {\n        Harness\\Feature\\ContinueAsNew\\ContinueAsSame\\FeatureChecker::check(WorkflowStubInterface $stub): void\n        â€º ): void {\n        â€º     Assert::same($stub->getResult(), INPUT_DATA);\n        â€º     # Workflow ID does not change after continue as new\n      }\n      Harness\\Feature\\ContinueAsNew\\ContinueAsSame\\FeatureChecker::check() {}\n      ./vendor/spiral/core/src/Internal/Invoker.php:59 { â€¦}\n      ./vendor/spiral/core/src/Container.php:[29](https://github.com/temporalio/features/actions/runs/12835436433/job/35794872814?pr=577#step:9:30)2 { â€¦}\n      /app/harness/php/runner.php:108 { â€¦}\n      {closure}() {}\n      ./vendor/spiral/core/src/Internal/Invoker.php:77 { â€¦}\n      ./vendor/spiral/core/src/Container.php:292 { â€¦}\n      ./vendor/spiral/core/src/Container.php:404 { â€¦}\n      ./vendor/spiral/core/src/ContainerScope.php:46 { â€¦}\n      ./vendor/spiral/core/src/Container.php:399 { â€¦}\n      ./vendor/spiral/core/src/Container.php:181 { â€¦}\n      /app/harness/php/runner.php:99 { â€¦}\n    }\n  }\n  trace: {\n    ./vendor/temporal/sdk/src/Client/GRPC/BaseClient.php:291 { â€¦}\n    ./vendor/temporal/sdk/src/Client/GRPC/BaseClient.php:252 { â€¦}\n    ./vendor/temporal/sdk/src/Client/GRPC/ServiceClient.php:137 { â€¦}\n    ./vendor/temporal/sdk/src/Internal/Client/WorkflowStub.php:576 { â€¦}\n    ./vendor/temporal/sdk/src/Internal/Client/WorkflowStub.php:491 { â€¦}\n    ./vendor/temporal/sdk/src/Internal/Client/WorkflowStub.php:423 { â€¦}\n    ./vendor/temporal/sdk/src/Internal/Interceptor/Pipeline.php:92 { â€¦}\n    ./vendor/temporal/sdk/src/Internal/Client/WorkflowStub.php:4[32](https://github.com/temporalio/features/actions/runs/12835436433/job/35794872814?pr=577#step:9:33) { â€¦}\n    /app/features/continue_as_new/continue_as_same/feature.php:62 {\n      Harness\\Feature\\ContinueAsNew\\ContinueAsSame\\FeatureChecker::check(WorkflowStubInterface $stub): void\n      â€º ): void {\n      â€º     Assert::same($stub->getResult(), INPUT_DATA);\n      â€º     # Workflow ID does not change after continue as new\n    }\n    Harness\\Feature\\ContinueAsNew\\ContinueAsSame\\FeatureChecker::check() {}\n    ./vendor/spiral/core/src/Internal/Invoker.php:59 { â€¦}\n    ./vendor/spiral/core/src/Container.php:292 { â€¦}\n    /app/harness/php/runner.php:108 { â€¦}\n    {closure}() {}\n    ./vendor/spiral/core/src/Internal/Invoker.php:77 { â€¦}\n    ./vendor/spiral/core/src/Container.php:292 { â€¦}\n    ./vendor/spiral/core/src/Container.php:404 { â€¦}\n    ./vendor/spiral/core/src/ContainerScope.php:46 { â€¦}\n    ./vendor/spiral/core/src/Container.php:[39](https://github.com/temporalio/features/actions/runs/12835436433/job/35794872814?pr=577#step:9:40)9 { â€¦}\n    ./vendor/spiral/core/src/Container.php:181 { â€¦}\n    /app/harness/php/runner.php:99 { â€¦}\n  }\n}\n-> /app/features/continue_as_new/continue_as_same/feature.php:62\nTimeoutException\nDeadline Exceeded (code: 4)\nServiceClientException\nDeadline Exceeded (code: 4)\n```\n\n</details>\n\n<details>\n\n```\nTemporal\\Exception\\Client\\WorkflowExecutionAlreadyStartedException {#321\n  #message: \"runId='ea5a377f-b9a2-4285-a72b-af2541b1719d', workflowType='Workflow'\"\n  #code: 0\n  #file: \"./vendor/temporal/sdk/src/Internal/Client/WorkflowStarter.php\"\n  #line: 291\n  -previous: Temporal\\Exception\\Client\\ServiceClientException {#264\n    #message: \"Workflow execution already finished successfully. WorkflowId: TestID, RunId: ea5a377f-b9a2-4285-a72b-af2541b1719d. Workflow Id reuse policy: allow duplicate workflow Id if last run failed. (code: 6)\"\n    #code: 6\n    #file: \"./vendor/temporal/sdk/src/Client/GRPC/BaseClient.php\"\n    #line: 284\n    -status: Google\\Rpc\\Status {#312\n      message: \"google.rpc.Status\"\n      values: array:3 [\n        \"code\" => 6\n        \"message\" => \"Workflow execution already finished successfully. WorkflowId: TestID, RunId: ea5a377f-b9a2-4285-a72b-af2541b1719d. Workflow Id reuse policy: allow duplicate workflow Id if last run failed.\"\n        \"details\" => array:1 [\n          0 => array:3 [\n            \"@type\" => \"type.googleapis.com/temporal.api.errordetails.v1.WorkflowExecutionAlreadyStartedFailure\"\n            \"startRequestId\" => \"79be0125-9281-44e5-bf9b-f1a48fd20adc\"\n            \"runId\" => \"ea5a377f-b9a2-4285-a72b-af2541b1719d\"\n          ]\n        ]\n      ]\n    }\n    trace: {\n      ./vendor/temporal/sdk/src/Client/GRPC/BaseClient.php:284 { â€¦}\n      ./vendor/temporal/sdk/src/Client/GRPC/BaseClient.php:252 { â€¦}\n      ./vendor/temporal/sdk/src/Client/GRPC/ServiceClient.php:96 { â€¦}\n      ./vendor/temporal/sdk/src/Internal/Client/WorkflowStarter.php:283 { â€¦}\n      ./vendor/temporal/sdk/src/Internal/Client/WorkflowStarter.php:76 { â€¦}\n      ./vendor/temporal/sdk/src/Internal/Interceptor/Pipeline.php:92 { â€¦}\n      ./vendor/temporal/sdk/src/Internal/Client/WorkflowStarter.php:81 { â€¦}\n      ./vendor/temporal/sdk/src/Client/WorkflowClient.php:136 { â€¦}\n      /app/harness/php/src/Feature/WorkflowStubInjector.php:60 {\n        Harness\\Feature\\WorkflowStubInjector->createInjection(ReflectionClass $class, ReflectionParameter|string|null $context = null): WorkflowStubInterface\n        â€º $stub = $client->newUntypedWorkflowStub($attribute->type, $options);\n        â€º $client->start($stub, ...$attribute->args);\n        â€º \n        arguments: {\n          $workflow: Temporal\\Internal\\Client\\WorkflowStub {#315 â€¦}\n          ...$args: {\n            \"InputData\"\n          }\n        }\n      }\n      ./vendor/spiral/core/src/Internal/Factory.php:157 { â€¦}\n      ./vendor/spiral/core/src/Internal/Factory.php:101 { â€¦}\n      ./vendor/spiral/core/src/Internal/Factory.php:331 { â€¦}\n      ./vendor/spiral/core/src/Internal/Factory.php:78 { â€¦}\n      ./vendor/spiral/core/src/Internal/Container.php:59 { â€¦}\n      ./vendor/spiral/core/src/Internal/Resolver.php:276 { â€¦}\n      ./vendor/spiral/core/src/Internal/Resolver.php:218 { â€¦}\n      ./vendor/spiral/core/src/Internal/Resolver.php:52 { â€¦}\n      ./vendor/spiral/core/src/Internal/Invoker.php:61 { â€¦}\n      ./vendor/spiral/core/src/Container.php:282 { â€¦}\n      /app/harness/php/runner.php:108 { â€¦}\n      {closure}() {}\n      ./vendor/spiral/core/src/Internal/Invoker.php:77 { â€¦}\n      ./vendor/spiral/core/src/Container.php:282 { â€¦}\n      ./vendor/spiral/core/src/Container.php:407 { â€¦}\n      ./vendor/spiral/core/src/ContainerScope.php:45 { â€¦}\n      ./vendor/spiral/core/src/Container.php:402 { â€¦}\n      ./vendor/spiral/core/src/Container.php:169 { â€¦}\n      /app/harness/php/runner.php:99 { â€¦}\n    }\n  }\n  -execution: Temporal\\Workflow\\WorkflowExecution {#284\n    -id: \"TestID\"\n    -runId: \"ea5a377f-b9a2-4285-a72b-af2541b1719d\"\n  }\n  -type: \"Workflow\"\n  trace: {\n    ./vendor/temporal/sdk/src/Internal/Client/WorkflowStarter.php:291 { â€¦}\n    ./vendor/temporal/sdk/src/Internal/Client/WorkflowStarter.php:76 { â€¦}\n    ./vendor/temporal/sdk/src/Internal/Interceptor/Pipeline.php:92 { â€¦}\n    ./vendor/temporal/sdk/src/Internal/Client/WorkflowStarter.php:81 { â€¦}\n    ./vendor/temporal/sdk/src/Client/WorkflowClient.php:136 { â€¦}\n    /app/harness/php/src/Feature/WorkflowStubInjector.php:60 {\n      Harness\\Feature\\WorkflowStubInjector->createInjection(ReflectionClass $class, ReflectionParameter|string|null $context = null): WorkflowStubInterface\n      â€º $stub = $client->newUntypedWorkflowStub($attribute->type, $options);\n      â€º $client->start($stub, ...$attribute->args);\n      â€º \n      arguments: {\n        $workflow: Temporal\\Internal\\Client\\WorkflowStub {#315 â€¦}\n        ...$args: {\n          \"InputData\"\n        }\n      }\n    }\n    ./vendor/spiral/core/src/Internal/Factory.php:157 { â€¦}\n    ./vendor/spiral/core/src/Internal/Factory.php:101 { â€¦}\n    ./vendor/spiral/core/src/Internal/Factory.php:331 { â€¦}\n    ./vendor/spiral/core/src/Internal/Factory.php:78 { â€¦}\n    ./vendor/spiral/core/src/Internal/Container.php:59 { â€¦}\n    ./vendor/spiral/core/src/Internal/Resolver.php:276 { â€¦}\n    ./vendor/spiral/core/src/Internal/Resolver.php:218 { â€¦}\n    ./vendor/spiral/core/src/Internal/Resolver.php:52 { â€¦}\n    ./vendor/spiral/core/src/Internal/Invoker.php:61 { â€¦}\n    ./vendor/spiral/core/src/Container.php:282 { â€¦}\n    /app/harness/php/runner.php:108 { â€¦}\n    {closure}() {}\n    ./vendor/spiral/core/src/Internal/Invoker.php:77 { â€¦}\n    ./vendor/spiral/core/src/Container.php:282 { â€¦}\n    ./vendor/spiral/core/src/Container.php:407 { â€¦}\n    ./vendor/spiral/core/src/ContainerScope.php:45 { â€¦}\n    ./vendor/spiral/core/src/Container.php:402 { â€¦}\n    ./vendor/spiral/core/src/Container.php:169 { â€¦}\n    /app/harness/php/runner.php:99 { â€¦}\n  }\n}\n```\n\n</details>","closedAt":"2025-02-21T21:53:42Z","comments":[{"id":"IC_kwDOGflYbs6bF6qu","author":{"login":"roxblnfk"},"authorAssociation":"COLLABORATOR","body":"The problem related with https://github.com/temporalio/sdk-php/issues/481\n\nA temporary solution could be to set a unique name for the Workflow to avoid conflicts with Workflows of the same name from other TaskQueues:\nhttps://github.com/temporalio/sdk-php/blob/fc67190d6176f7fb145167d5ad0a2d5273fedf06/tests/Acceptance/Harness/ContinueAsNew/ContinueAsSameTest.php#L44\nhttps://github.com/temporalio/sdk-php/blob/fc67190d6176f7fb145167d5ad0a2d5273fedf06/tests/Acceptance/Harness/ContinueAsNew/ContinueAsSameTest.php#L25\nhttps://github.com/temporalio/sdk-php/blob/fc67190d6176f7fb145167d5ad0a2d5273fedf06/tests/Acceptance/Harness/ContinueAsNew/ContinueAsSameTest.php#L52\n\nWith this bug, all Harness tests might be flaky because the Workflow type \"Workflow\" is used everywhere (but with different TaskQueues) ðŸ¤¯ ","createdAt":"2025-01-20T10:27:30Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/582#issuecomment-2602019502","viewerDidAuthor":false}],"createdAt":"2025-01-17T19:31:27Z","labels":[],"milestone":null,"number":582,"reactionGroups":[],"state":"CLOSED","title":"[Features Platform] continue_as_new/continue_as_same feature does not pass against cloud","updatedAt":"2025-02-21T21:53:42Z","url":"https://github.com/temporalio/features/issues/582"}
