{"assignees":[],"author":{"id":"MDQ6VXNlcjcyOTc0MA==","is_bot":false,"login":"scoplin","name":"Scott Coplin"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\nUsing prometheus metrics to detect unhappy-path events like workflow failures, or even compute happy-path rates on seldom-executed workflows is made more difficult by the lazy implementation of counters in Temporal SDK metrics.  When a workflow fails for the first time, the counter only then begins being reported -- with an initial value of 1.\r\n\r\nPrometheus monitoring solutions wishing to alarm on error rates can miss this first increment since prometheus's rate calculation depends upon observing change over time, and a change from non-existence for a counter is undefined.  More description of the problem can be found [here](https://www.section.io/blog/beware-prometheus-counters-that-do-not-begin-at-zero/).\r\n\r\n### Describe the solution you'd like\r\n\r\nFor counters that can be known ahead of time, such as for registered worker activities and workflows, I would like to see counters for happy and unhappy-path scenarios eagerly created at the time of registration.\r\n\r\nEager registration would not necessarily apply to dynamic workflows or activities, as they cannot be known ahead of time.  However, I would suggest that even for those cases, registration of the corresponding unhappy-path counters should take place immediately at the time the new workflow or activity is discovered, not when it first fails.\r\n\r\nI would like to see this at least in the Java SDK, but I am told by @tsurdilo that all SDKs may be affected.\r\n\r\n### Additional context\r\n\r\nSome discussion related to this request took place on the Temporal Slack in [this thread](https://temporalio.slack.com/archives/CTRCR8RBP/p1666187913779529).\r\n\r\nSee [prometheus issue #3886](https://github.com/prometheus/prometheus/issues/3886) for discussion on how prometheus deals with counters that initially appear non-zero.","closedAt":null,"comments":[{"id":"IC_kwDOGflYbs5MotEv","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"General notes (Slack thread may disappear):\r\n\r\n1. It is very common to not report a counter until it is first incremented. The problem with consuming a lack of counter is a consumer-side issue not a producer-side one.\r\n2. Our abstractions are for more than just Prometheus so it wouldn't make sense to do something special at worker start time just for Prometheus.\r\n3. How do you even initialize a counter to zero and make it show up using the abstractions we use?\r\n4. Would like to see what the rest of the industry does here. I doubt that it's common to expose never-incremented counters. We should follow the industry. It sounds like this problem would happen with any system, not just Temporal.\r\n5. It can be unreasonable to all of the sudden dump every permutation of counter and labels as 0 on worker start for this consumer-side issue. Say I start quick ephemeral workers that have 100 workflows on them even though I only execute 1 workflow and close them. We went from a single workflow metric for every task queue to 100 for every task queue.\r\n6. This can be worked around for the very limited subset of users using rates on not-present metrics by using a user-defined gauge.","createdAt":"2022-10-20T15:23:41Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/146#issuecomment-1285738799","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5MpFcv","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"After internal team discussion, it does appear to be common practice to initialize metrics if you know all labels and I believe I have confirmed that Prometheus Go client does display created-but-not-incremented metrics. I wonder if a worker option for `EagerMetricInitialization` that defaults to false would be acceptable instead of doing this by default.","createdAt":"2022-10-20T16:26:54Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/146#issuecomment-1285838639","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5MpGSM","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"Any downsides to defaulting to true?\n\nOn Thu, Oct 20, 2022 at 12:27 PM Chad Retz ***@***.***> wrote:\n\n> After internal team discussion this does appear to be common practice and\n> I have confirmed that Prometheus Go client does initialize 0's. I wonder if\n> a worker option for EagerMetricInitialization that defaults to false\n> would be acceptable.\n>\n> â€”\n> Reply to this email directly, view it on GitHub\n> <https://github.com/temporalio/sdk-features/issues/146#issuecomment-1285838639>,\n> or unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/AAB5LGFZSXFZNYALWZYHFX3WEFXFTANCNFSM6AAAAAARKIL5IY>\n> .\n> You are receiving this because you are subscribed to this thread.Message\n> ID: ***@***.***>\n>\n","createdAt":"2022-10-20T16:29:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/146#issuecomment-1285842060","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5MpGop","author":{"login":"TimSimmons"},"authorAssociation":"MEMBER","body":"You can also do some query shenanigans detailed at the bottom of\r\nhttps://www.robustperception.io/existential-issues-with-metrics/\r\n\r\nto work around the issue. It's definitely not pretty but I think this is a common tactic folks take to work around this rough edge in systems they can't or won't change.","createdAt":"2022-10-20T16:31:01Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/146#issuecomment-1285843497","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5MpHo6","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> Any downsides to defaulting to true?\r\n\r\nOnly that: 1) non-prom users aren't affected, 2) we already do not do this today so it's a behavior change to those already scraping (e.g. if you're `curl`ing and then `grep`ping for the failed metric), 3) it will make the HTTP response much larger for many workers possible w/ many workflows, and 4) it's not foolproof anyways (some labels are dynamic).\r\n\r\nAlso, from that link above I found https://prometheus.io/docs/practices/instrumentation/#avoid-missing-metrics. If deemed not a big deal, I would be ok with creating all the counters eagerly by default.","createdAt":"2022-10-20T16:34:30Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/features/issues/146#issuecomment-1285847610","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5MpsUl","author":{"login":"scoplin"},"authorAssociation":"NONE","body":"Making the new eager initialization behavior optional with a default being existing behavior sounds like a good hedge against unexpected surprises for existing users.","createdAt":"2022-10-20T18:53:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/146#issuecomment-1285997861","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs6Etusz","author":{"login":"scoplin"},"authorAssociation":"NONE","body":"Was this actually completed?  I don't see any linked PRs.","createdAt":"2024-07-13T00:35:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/146#issuecomment-2226580275","viewerDidAuthor":false}],"createdAt":"2022-10-20T15:15:08Z","labels":[{"id":"LA_kwDOGflYbs7XtLc6","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":146,"reactionGroups":[],"state":"OPEN","title":"[Feature Request] Eagerly initialize workflow/activity counters","updatedAt":"2024-07-13T01:07:44Z","url":"https://github.com/temporalio/features/issues/146"}
