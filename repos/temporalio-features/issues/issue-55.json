{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"### Overview\r\n\r\nSDKs need to support \"eager activity dispatch\" by default which is essentially just setting `ScheduleActivityTaskCommandAttributes.request_eager_execution` to true if there is \"room\". Then if supported on the server, the server will give the work right back to the worker requesting.\r\n\r\n### Unbalanced Worker Concern\r\n\r\nThis feature is purely for server benefit, and is actually possibly harmful to SDK and users. It can cause unbalancing of workers. For example, say you have 10 workers with 1000 activity slots each and just one workflow is running. If that workflow starts 300 activities, those are all gonna be on the one worker and the other 9 will idle. Today the server does not have a load balancing policy and therefore which worker work is given to is random, but even that may distribute load better than same-worker-as-workflow-by-default.\r\n\r\n### Features\r\n\r\n* Set eager execution boolean when scheduling activity if the worker is known to have activity slots available\r\n* Have worker option for \"max eager activities\" that represents the maximum number\r\n  * Make sure this can be set to \"off\" (or use a separate config boolean)\r\n  * Research - what is the default? Unset which means max activities of the worker?\r\n  * Research - ~can we reliably determine when to add a eager-activity slot back to the pool? This means we have to know when an eager activity is no longer running. Are we expected to track activity completion? How does this work with retries? Are retries also sent back to the same worker? If we're in a many-minute backoff period for retry which means it is not \"running\", does that still take an eager-activity slot? How can the workflow side even tell that the activity side is in backoff?~ EDIT: The activity tasks come back in the WFT complete response, not the activty poll response, so you know then.\r\n* Should we have way in activity options to disallow eager dispatch?\r\n\r\n### Issues\r\n\r\n* [x] Core - https://github.com/temporalio/sdk-core/pull/296\r\n* [x] TypeScript\r\n* [x] Go\r\n* [x] Python\r\n* [x] Java https://github.com/temporalio/sdk-java/issues/1339\r\n* [x] PHP\r\n\r\n","closedAt":"2023-10-13T22:17:36Z","comments":[{"id":"IC_kwDOGflYbs5DfGUN","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"> Should we have way in activity options to disallow eager dispatch?\r\n\r\nhttps://github.com/temporalio/sdk-core/pull/296/files#diff-df2313a0cc3597f2135b2972c7f8ca12c4377fce2d1f6b97a41b0aff18e9fb50R83\r\n\r\n> Make sure this can be set to \"off\" (or use a separate config boolean)\r\n\r\nThis would be setting the max eager activities to 0\r\n\r\n> Research - what is the default? Unset which means max activities of the worker?\r\n\r\nGood question, I'd consider adding a rate limiter for eager activities to make sure we don't overload a single worker, it might be more useful than concurrency limiter.\r\n\r\n> Research - can we reliably determine when to add a eager-activity slot back to the pool\r\n\r\nOnce a worker accepts these activities the rest of the flow is exactly the same as with non-eager activities.\r\nWe essentially accept a single activity attempt (task), retries and timeouts are handled by the server.\r\n\r\n> Unbalanced Worker Concern\r\n\r\nThis is a valid concern but as workload grows it become increasingly insignificant AFAICT.\r\n","createdAt":"2022-05-19T21:32:13Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/55#issuecomment-1132225805","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5DfRMZ","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"> This feature is purely for server benefit\r\n\r\nThis is not true. User get benefit of much faster dispatch and less overhead. \r\n\r\nI think we should just start conservatively, only allow small number of eager execution. Small number like 2 or 3 should cover the majority of the cases and thus harvest most of the benefit we want.\r\n","createdAt":"2022-05-19T22:37:12Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/55#issuecomment-1132270361","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5Df1PE","author":{"login":"yiminc"},"authorAssociation":"MEMBER","body":"> Should we have way in activity options to disallow eager dispatch?\r\n\r\nI don't think we need this on SDK. Server side has control to disable this feature per namespace, if we ever need to do so.\r\n","createdAt":"2022-05-20T03:23:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/55#issuecomment-1132417988","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5DhThl","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> This is not true. User get benefit of much faster dispatch and less overhead.\r\n\r\nSorry, I wasn't clear/accurate when I said only for server benefit. I mean this optimization is only exposed to users so the server can provide a performance benefit. The server is a black box to users and ideally we wouldn't have to bother SDK or users with a new concept to improve performance. But if course I understand why.\r\n\r\n> I don't think we need this on SDK. Server side has control to disable this feature per namespace, if we ever need to do so.\r\n\r\nWe already are going to have max eager worker option, so technically 0 is disabling. The question here is whether to also support disabling at the activity options level inside the workflow. Is there a use case where a workflow dev may know they don't want to eagerly dispatch a certain type of activity? Is this similar to the decision we allow them to make about choosing whether an activity is locally dispatched?\r\n\r\n","createdAt":"2022-05-20T11:45:47Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/55#issuecomment-1132804197","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5pBW7x","author":{"login":"josh-berry"},"authorAssociation":"NONE","body":"I see all the langs are checked off as being doneâ€”can this be closed?","createdAt":"2023-10-13T18:07:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":2}}],"url":"https://github.com/temporalio/features/issues/55#issuecomment-1761963761","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5pB2uB","author":{"login":"mjameswh"},"authorAssociation":"MEMBER","body":"There's some outstanding discussion regarding interaction of Eager Activity Execution + Workflow Versioning, but I strongly feel like this is outside of the scope of this ticket.","createdAt":"2023-10-13T19:35:40Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/features/issues/55#issuecomment-1762093953","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5pCrO9","author":{"login":"josh-berry"},"authorAssociation":"NONE","body":"Great. Closing.","createdAt":"2023-10-13T22:17:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/55#issuecomment-1762309053","viewerDidAuthor":false}],"createdAt":"2022-05-19T19:51:16Z","labels":[{"id":"LA_kwDOGflYbs7XtLc6","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":55,"reactionGroups":[],"state":"CLOSED","title":"[Feature Request] Eager activity dispatch","updatedAt":"2023-10-13T22:17:37Z","url":"https://github.com/temporalio/features/issues/55"}
