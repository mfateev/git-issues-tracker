{"assignees":[],"author":{"id":"MDQ6VXNlcjUyMzA0","is_bot":false,"login":"bergundy","name":"Roey Berman"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\nSometimes it's required to get the Date at the time a query is processed as opposed to the last processed workflow task's time.\r\nFor example this query will always return the same result:\r\n\r\n```ts\r\nsetHandler(timerSettingsQuery, () => {\r\n  const deadlineMs = timer.getDeadline();\r\n  return { sleepIntervalMs: timer.sleepMs, timeLeftMs: deadlineMs - Date.now(), deadlineMs: deadlineMs };\r\n});\r\n```\r\n\r\n### Describe the solution you'd like\r\n\r\nUpdate workflow time before processing queries (and possibly immediately reset back to workflow time)\r\nSpecial care should be taken not to trigger any `condition`s (`Workflow.await`).","closedAt":"2022-08-02T04:22:46Z","comments":[{"id":"IC_kwDOGflYbs5DyUXo","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Hrmm, the idea that anything in a query can be different for each invocation of the same query is a bit concerning. I am not sure we should support one worker giving a different result to a query than another worker (or replayer). I am not convinced we should support this.\r\n\r\nBasically with this change we've now said that queries aren't idempotent (in the strict sense that for the same input they get the same output). For this specific use case, the deadline can be returned and the caller can use their notion of \"now\" to do any calculations. While that may be different than the worker's, both may be different than the server's which is what really matters here. No worker-specific anything should affect a query's output.","createdAt":"2022-05-25T13:47:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/31#issuecomment-1137264104","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5DzJk6","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"I agree, think I mentioned when we talked about this briefly earlier. IMO it makes no sense for a query to return wall-clock time. Queries query _workflow_ state, and that should be consistent with the concept of what that means everywhere else. It seems very unintuitive for queries to behave one way, and everything else another.\r\n\r\nIf it's really important to access wall clock time, make it available behind a special API inside the `unsafe` type package, or similar (only usable during query). \r\n\r\nEven then, I can't imagine almost any possible reason it's necessary, as the thing doing the querying ostensibly can just... look at the wall clock either before or after the query.","createdAt":"2022-05-25T16:07:30Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/31#issuecomment-1137482042","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5D1uBy","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Queries are different than other workflow events, they don't need to be deterministic. I initially argued with @mfateev (who originally suggested this feature) for the same reasons both of you bring up here but after thinking about it I don't see a reason why we shouldn't support this.\r\n\r\nI agree the handler above could be implemented on the caller side like @Sushisource points out but why not in the workflow?\r\nAs for the replayer you've mentioned @cretz, do the Go or Java replayers support running additional queries after replay? That could be a useful feature.","createdAt":"2022-05-26T05:01:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/31#issuecomment-1138155634","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5D3UUe","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> after thinking about it I don't see a reason why we shouldn't support this.\r\n\r\nOf course the question is why we _should_. With TS maybe, but with other SDKs we don't have sandbox restrictions (yet) that prevent them from using the non-workflow \"now\" if they really want.\r\n\r\nThe other question is: Is it ok for the same query to have different responses depending on where it's run?\r\n\r\nAre you planning on also restoring system rand for query calls instead of our seeded workflow one?","createdAt":"2022-05-26T13:24:05Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/31#issuecomment-1138574622","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5D3eov","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I think this would mostly be relevant to TS where the wall clock isnâ€™t available. Since user might want the workflow time in some cases, right now I think the right thing is to expose system time in the unsafe part of WorkflowInfo, it could be useful in other situations like tracing. ","createdAt":"2022-05-26T14:07:17Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/features/issues/31#issuecomment-1138616879","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5D4-3i","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"> Of course the question is why we should. \r\n\r\nThis is the critical point. Good API design IMHO is about providing the smallest most composable set of things to allow you to do what you need. \r\n\r\nI think I referenced this quote before:\r\n> [\"Simplify, then add lightness\"](https://www.lotuscars.com/en-US/lotus-philosophy/)\r\n\r\nAnyway, sounds like we're on the same page here w/ how to expose it, but I just love driving that point home.","createdAt":"2022-05-26T20:37:11Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/31#issuecomment-1139011042","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5D5EIn","author":{"login":"lorensr"},"authorAssociation":"CONTRIBUTOR","body":"I like the ability to provide a `timeLeftQuery`, and our current sample doesn't return the intended value:\r\n\r\nhttps://github.com/temporalio/samples-typescript/blob/main/timer-examples/src/updatable-timer.ts#L18\r\n\r\nI like it being in `workflowInfo().unsafe.now`","createdAt":"2022-05-26T20:51:34Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/31#issuecomment-1139032615","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5HpRD-","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Closing in favor of the linked TS issue, not needed for non-sandboxed runtimes.","createdAt":"2022-08-02T04:22:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/31#issuecomment-1202000126","viewerDidAuthor":false}],"createdAt":"2022-03-31T18:06:00Z","labels":[{"id":"LA_kwDOGflYbs7XtLc6","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":31,"reactionGroups":[],"state":"CLOSED","title":"[Feature Request] Update workflow time when processing queries","updatedAt":"2022-08-02T04:22:46Z","url":"https://github.com/temporalio/features/issues/31"}
