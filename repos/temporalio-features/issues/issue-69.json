{"assignees":[],"author":{"id":"MDQ6VXNlcjE0NjM2MjI=","is_bot":false,"login":"mfateev","name":"Maxim Fateev"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\nSometimes users want to update the workflow code rolling back some progress. Trivial example:\r\n\r\n```\r\nif patch(\"patch1\") {\r\n   sleep(10 days);\r\n} else {\r\n   sleep(100 days);\r\n}\r\n```\r\nThis patch is useless as if a workflow is already blocked on 100-day sleep, the patch is always going to return _false_, and the sleep is not going to be interrupted.\r\n\r\n### Describe the solution you'd like\r\n\r\nAbility to reset workflow to any point by specifying the reset point in the code. Given that in many cases reset point can be reached through different code paths it is practically impossible to find the reset point just looking at a history. It is even less possible if millions of such workflows have to be reset through a batch call.\r\n\r\n### The strawman API proposal\r\n\r\nCode before the change:\r\n```\r\nsleep(100 days);\r\n```\r\nCode after the change:\r\n```\r\nresetScope = reset(\"resetId\");\r\nsleep(10 days);\r\nresetScope.close();\r\n```\r\nAny workflow that is blocked inside the resetScope (which can be modeled with real scopes and closures as well) will be rolled automatically back to the line just before _reset_ call. After all the workflows executed the rollback the reset code can be removed.\r\n\r\nThe open question is what causes reset to happen for blocked workflows. It might require an automatically generated batch job that pokes all such blocked workflows after the code deployment.","closedAt":null,"comments":[{"id":"IC_kwDOGflYbs5Gniff","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"If we need a batch job to probe the workflows why not send a signal in the batch job to wake the workflow up?\r\n\r\n```ts\r\ntry {\r\n  await CancellationScope.cancellable(async () => {\r\n    setHandler(updateSignal, () => CancellationScope.current.cancel())\r\n    await sleep('10 days')\r\n  })\r\n} catch {\r\n  // ignore cancellation\r\n}\r\n```","createdAt":"2022-07-14T18:31:14Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/69#issuecomment-1184770015","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5Go3zB","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"Because it assumes that a workflow was coded from the beginning to listen for this signal and react accordingly. \r\n\r\nThis issue supports unplanned changes to workflow code.","createdAt":"2022-07-15T03:03:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/69#issuecomment-1185119425","viewerDidAuthor":true},{"id":"IC_kwDOGflYbs5GpEMs","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"It doesn't assume that. With the technique I mentioned you can safely patch (not to be confused with the `patched` API) a running workflow.\r\n","createdAt":"2022-07-15T04:48:09Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/69#issuecomment-1185170220","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5GpFvZ","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"The issue with my approach is that it requires signals to be sent to new workflows as well as already running ones.\r\nBut that can be fixed with:\r\n\r\n```ts\r\n/** TODO: find a better name for this */\r\nasync function skipOnSignal<T>(fn: () => Promise<T>, returnValueIfSkipped: T, signalName: string): Promise<T> {\r\n  try {\r\n    if (patched(`skip-${Math.random()}`)) {\r\n      return returnValueIfSkipped\r\n    }\r\n    return await CancellationScope.cancellable(async () => {\r\n      setHandler(defineSignal(signalName), () => CancellationScope.current.cancel())\r\n      return await fn()\r\n    })\r\n  } catch (error) {\r\n    if (isCancellation(error)) {\r\n      return returnValueIfSkipped\r\n    }\r\n    throw error\r\n  }\r\n}\r\n\r\nasync function myWorkflowBeforeChange() {\r\n  await sleep('10 days')\r\n}\r\n\r\nasync function myWorkflowAfterChange() {\r\n  await skipOnSignal(async () => {\r\n    await sleep('10 days')\r\n  }, undefined, 'skip-sleep')\r\n}\r\n```","createdAt":"2022-07-15T05:03:15Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/69#issuecomment-1185176537","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5IQSVi","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"I think you missed my point that this is not about just waking up. It is to be able to fix any part of the workflow code and roll back all open workflows to a specific point in the past. ","createdAt":"2022-08-11T16:43:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/69#issuecomment-1212228962","viewerDidAuthor":true},{"id":"IC_kwDOGflYbs5IQYLA","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I'd need more details here.\r\nIIUC, what you're suggesting requires the reset point to be specified ahead which is why I claimed that it's not as useful but maybe I'm misunderstanding.","createdAt":"2022-08-11T17:01:46Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/69#issuecomment-1212252864","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5IQZ_H","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"The use case is that a workflow has some bug/issue/change that requires changing the past and redoing part of a workflow. This is possible through reset. The actual reset point is at some point in the workflow code. Calculating the reset point looking at the history and correlating it to the workflow code is almost impossible. Thus the proposal is to specify it directly in the code. Sending signal in this case doesn't add any value as the newly deployed code already contain all the needed info to perform reset.","createdAt":"2022-08-11T17:08:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/69#issuecomment-1212260295","viewerDidAuthor":true},{"id":"IC_kwDOGflYbs5IQsMq","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I think I follow now.\r\n\r\nSeems like there should be something external trigger to get the workflow to replay so it can emit this information to the runtime.\r\nMaybe we could use the replayer for that and catch this special \"reset point\" command.\r\nAlso not sure why it should be a scope instead of a simple method, what's the reason to \"end\" the scope?","createdAt":"2022-08-11T18:16:49Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/69#issuecomment-1212334890","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5Iyj4O","author":{"login":"mfateev"},"authorAssociation":"MEMBER","body":"An external trigger is still needed to force workflow reevaluation. I don't have a concrete design ready. It can use replayer or normal worker to determine the reset point. Then we need to decide how the reset is actually triggered. It can be in the response to the workflow task or a direct API call.\r\n\r\nI agree that scope is not needed.","createdAt":"2022-08-20T02:35:31Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/69#issuecomment-1221213710","viewerDidAuthor":true},{"id":"IC_kwDOGflYbs5Iypea","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Seems pretty straight forward to do with just a replayer and a special exception but if we think this is valuable enough we can bake it into the SDK.","createdAt":"2022-08-20T05:31:15Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/69#issuecomment-1221236634","viewerDidAuthor":false}],"createdAt":"2022-07-14T17:14:02Z","labels":[{"id":"LA_kwDOGflYbs7XtLc6","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":69,"reactionGroups":[],"state":"OPEN","title":"[Feature Request] Specify reset point in workflow code","updatedAt":"2024-07-13T01:08:12Z","url":"https://github.com/temporalio/features/issues/69"}
