{"assignees":[],"author":{"id":"MDQ6VXNlcjI4ODU2MjQz","is_bot":false,"login":"madhav2302","name":"Madhav Sodhani"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\nIt would be nice number of times an activity worker can poll tasks, as our service is currently not multi-tenant, and we would like to set it to 1. It will also help us to shutoff the workers gracefully by limiting the number of activities we allow it to run, as our activities can be long running, and we can't kill the activity and start new as progress will be lost. \r\n\r\n### Describe the solution you'd like\r\n\r\nIt can be handled with 2 solutions: \r\n- Poller suspend polling after polling a task successfully\r\n- Provide MaximumPollTaskPerPoller. See implementation at https://gist.github.com/madhav2302/e35a9336b2fd8ccfc36fe4452d9c26b5\r\n\r\n### Additional context\r\n\r\n<!-- Add any other context or screenshots about the feature request here. -->\r\n","closedAt":null,"comments":[{"id":"IC_kwDOGflYbs541kiK","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Can you have a max-concurrent-activity setting as 1 and inside the activity start the worker shutdown? Or since this refers to Java, use `stopPollers` from inside the activity?","createdAt":"2024-03-29T14:17:45Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2027309194","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs541w4G","author":{"login":"madhav2302"},"authorAssociation":"NONE","body":"@cretz I tried it. \r\n\r\n- worker shutdown shuts down the heartbeat executor as well, so it doesn't work for us.\r\n- stopping pollers have some delay, as it waits for activity to start. For quick activities poller makes the call to temporal server to fetch next task. ","createdAt":"2024-03-29T15:05:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2027359750","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs54150W","author":{"login":"amanpsbhatia"},"authorAssociation":"NONE","body":"+1 This would be great feature to have.","createdAt":"2024-03-29T15:37:28Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2027396374","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5424gq","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> worker shutdown shuts down the heartbeat executor as well, so it doesn't work for us.\r\n\r\nI think this is a Java SDK thing. The way worker shutdown works in most SDKs is to stop polling and, with optional grace period, cancel activities and wait indefinitely for them to complete (while still letting heartbeat work). But Java SDK has the stop-polling step separate so can use just that.\r\n\r\n> stopping pollers have some delay, as it waits for activity to start. For quick activities poller makes the call to temporal server to fetch next task.\r\n\r\nBut it won't fetch the next task if you have max activities as 1 and you are still _in_ that 1 activity, correct? It should only poll again if you have available slots, which you don't until the activity completes, but you have since stopped polling before that next poll could start. (I have not tested this)\r\n\r\nIn general, we offer one-at-a-time workers, but not only-one-ever workers, so you'll have to use one-at-a-time to stop any future ones. We could create some \"max activities before shutdown\" option, but controlling when you stop polling yourself gives you more freedom/flexibility than just a number to reach.","createdAt":"2024-03-29T19:24:50Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2027653162","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs543Jrb","author":{"login":"madhav2302"},"authorAssociation":"NONE","body":"> It should only poll again if you have available slots, which you don't until the activity completes, but you have since stopped polling before that next poll could start. (I have not tested this)\r\n\r\nI don't see the logic in the java SDK where it checks for available slots. Maybe that is missing, that's why polling doesn't stop. \r\n\r\nCan you confirm if Java SDK checks available slots before polling? if not, it would be nice to implement that. ","createdAt":"2024-03-29T20:49:48Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2027723483","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs543O6v","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":":+1: Will confer with Java SDK owner next week on this to confirm (cc @Quinn-With-Two-Ns). Basically if you put `setMaxConcurrentActivityExecutionSize` as `1` on `WorkerOptions.Builder`, then that worker will not even ask for a second item of work while the first is running. Will check if you have to lower pollers too.","createdAt":"2024-03-29T21:16:46Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2027744943","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs543R9r","author":{"login":"madhav2302"},"authorAssociation":"NONE","body":"@cretz yes, we have done this.  See below -\r\n\r\n```\r\n            var workerOptions =\r\n                    WorkerOptions.newBuilder(WorkerOptions.getDefaultInstance())\r\n                            .setMaxConcurrentActivityExecutionSize(1)\r\n                            .setMaxConcurrentActivityTaskPollers(1)\r\n                            .build();\r\n```\r\n\r\nIt still isn't stopping the polling when we don't have available slots. ","createdAt":"2024-03-29T21:34:35Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2027757419","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs543l4A","author":{"login":"madhav2302"},"authorAssociation":"NONE","body":"@cretz @Quinn-With-Two-Ns I wrote a test at https://gist.github.com/madhav2302/67de7f577f9be1f2592193982b5a4fa5, where 2nd activity runs on a worker even after polling is suspended. \r\n\r\n@cretz as you said there is a check for available slots [here](https://github.com/temporalio/sdk-java/blob/0c6c566a89f28f9a7715fcb258c3c2401ea310e7/temporal-sdk/src/main/java/io/temporal/internal/worker/ActivityPollTask.java#L97-L102) as a semaphore lock, but after this we don't check if polling is suspended, which results in activity execution on worker. ","createdAt":"2024-03-30T00:16:51Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2027838976","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5456uX","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"@cretz is correct `setMaxConcurrentActivityExecutionSize` as 1 will limit the worker to executing 1 normal activity at a time.\r\n\r\n@madhav2302 That would be expected `suspendPolling` suspends any new worker poll requests, but currently outstanding ones could still return workflow/activity tasks after its called and those tasks will be run.","createdAt":"2024-03-30T19:25:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2028448663","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs546FO8","author":{"login":"madhav2302"},"authorAssociation":"NONE","body":"@Quinn-With-Two-Ns is it expected behavior to do one last poll, even after we have suspended polling? it doesn't look correct, as after polling is suspended, no single activity run should happen. ","createdAt":"2024-03-30T23:12:36Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2028491708","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs546FWT","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":">as after polling is suspended, no single activity run should happen.\r\n\r\nThis is not true, after suspended polling is called any outstanding poll request can still be severed. The same thing is also explained in this forum post https://community.temporal.io/t/worker-suspendpolling-not-working/7102","createdAt":"2024-03-30T23:15:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2028492179","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs546ISa","author":{"login":"madhav2302"},"authorAssociation":"NONE","body":"@Quinn-With-Two-Ns how would you suggest that 2nd activity mentioned in https://gist.github.com/madhav2302/67de7f577f9be1f2592193982b5a4fa5 doesn't run at all? \r\n\r\nor does it make sense to have this feature, or maybe add a check [here](https://github.com/temporalio/sdk-java/blob/0c6c566a89f28f9a7715fcb258c3c2401ea310e7/temporal-sdk/src/main/java/io/temporal/internal/worker/ActivityPollTask.java#L97-L102) which checks if polling is suspended. ","createdAt":"2024-03-31T00:10:08Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2028504218","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs55C5Qf","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"So I think the way to do it right now is shutdown the worker as the last thing you do in your activity, probably in a finally block. That would stop polling for new work before the slot is released by the activity finishing.\r\n\r\nWe can also check if we paused polling after getting a slot as well. This whole part of the SDK is being actively refactored and maybe we can changes this as part of that work. @Sushisource I think when we add the pauseable slot supplier wrapper we should make sure we check if it is paused before and after getting a slot in case getting a slot blocks and the pauseable state changes","createdAt":"2024-04-01T23:44:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2030801951","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs55DalA","author":{"login":"madhav2302"},"authorAssociation":"NONE","body":"> So I think the way to do it right now is shutdown the worker as the last thing you do in your activity, probably in a finally block. That would stop polling for new work before the slot is released by the activity finishing.\r\n\r\nOk, I will try that. \r\n\r\n\r\n\r\n> We can also check if we paused polling after getting a slot as well. This whole part of the SDK is being actively refactored and maybe we can changes this as part of that work.\r\n\r\nThat would be great. Can we add the issue in the refactor SDK parent, so it is not missed. Any idea when the refactored SDK will be released? ","createdAt":"2024-04-02T01:58:29Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2030938432","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs55JBPX","author":{"login":"madhav2302"},"authorAssociation":"NONE","body":"> We can also check if we paused polling after getting a slot as well. This whole part of the SDK is being actively refactored and maybe we can changes this as part of that work.\r\n\r\n@Quinn-With-Two-Ns @Sushisource we can contribute it via a PR if it helps to get the fix released quickly. \r\n\r\n","createdAt":"2024-04-02T15:39:38Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2032407511","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs55J_GC","author":{"login":"Sushisource"},"authorAssociation":"MEMBER","body":"> We can also check if we paused polling after getting a slot as well. This whole part of the SDK is being actively refactored and maybe we can changes this as part of that work. @Sushisource I think when we add the pauseable slot supplier wrapper we should make sure we check if it is paused before and after getting a slot in case getting a slot blocks and the pauseable state changes\r\n\r\nPausing the supplier is, in effect, making the slot reservation call block until un-paused. If you pause the handing out of slots _just after_ a slot was handed out, well, you handed it out, and it's going to get used.\r\n\r\nThe desired semantic is something more like \"invalidate any issued but un-used slots and also cancel any in-flight poll RPCs\". And that, ultimately, is pretty much shutdown - just without the minor overhead of restarting the worker later.\r\n\r\nSo I'm actually not sure what the right default semantic for a `PauseableSlotSupplier` would be. I can buy that the right default behavior might actually be the semantic I just described, rather than the more literal \"pause handing out of any new slots\". Maybe we want both, but I think that's starting to get a bit confusing.\r\n\r\n@madhav2302 The good news for you is we'll be releasing this interface fairly soon, and you can implement it to do 90% of what you want - but this particular race may not be addressable in the first cut. We'll discuss internally if we want to add this particular ability in the first preview. No need for contribution, but thank you!","createdAt":"2024-04-02T17:36:44Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}},{"content":"HOORAY","users":{"totalCount":1}}],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2032660866","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs6XQ9NT","author":{"login":"madhav2302"},"authorAssociation":"NONE","body":"> The good news for you is we'll be releasing this interface fairly soon, and you can implement it to do 90% of what you want - but this particular race may not be addressable in the first cut. We'll discuss internally if we want to add this particular ability in the first preview. No need for contribution, but thank you!\r\n\r\n@Sushisource any updates on it? ","createdAt":"2024-12-12T04:45:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/443#issuecomment-2537804627","viewerDidAuthor":false}],"createdAt":"2024-03-28T23:04:04Z","labels":[{"id":"LA_kwDOGflYbs7XtLc6","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":443,"reactionGroups":[],"state":"OPEN","title":"[Feature Request] Implement activity task poll limit","updatedAt":"2024-12-12T04:45:24Z","url":"https://github.com/temporalio/features/issues/443"}
