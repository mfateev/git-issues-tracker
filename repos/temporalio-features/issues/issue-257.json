{"assignees":[],"author":{"id":"MDQ6VXNlcjQ1MjM5NTU=","is_bot":false,"login":"longquanzheng","name":"Quanzheng Long"},"body":"**Is your feature request related to a problem? Please describe.**\r\n\r\nUsing “short update“ is a very important pattern of Update API feature. It acts like an RPC.  Usually, the update handler may call an external system to perform an action, if successful, then mutate the workflow states. If calling external fails, then no mutation on the workflow.\r\n\r\nNote that this “short update“ may be called frequently with back off retry on failures. In reality, the external system could be unreliable so the failure is out of control. \r\n\r\nAs the way it works today, Temporal will write the update failure event into history, even this event doesn’t have any value for this use case. Eventually, this failure event will blow up the history very quickly. Hence this will become a scalability issue to use with Temporal.\r\n\r\n**Describe the solution you'd like**\r\nBased on discussion with @mfateev , it was designed this way because throwing away the activity results means the cache would become invalid hence the workflow has to be replayed to rebuild the cache. This will put significant load on the service  as every such rejection would require kicking the workflow out of cache and replaying it from the beginning.\r\n\r\nAn better idea to implement this is to only allow certain way to calling external system -- for example, using local activity only.  In GoSDK, the update API will just change the `UpdateHandlerOptions` to become like this:\r\n```golang\r\nUpdateHandlerOptions struct {\r\n    // Validator is an optional (i.e. can be left nil) func with exactly the\r\n    // same type signature as the required update handler func but returning\r\n    // only a single value of type error.  ....\r\n    Validator interface{}\r\n\r\n    // PreUpdateLocalActivity is an optional local activity to be execute after the Validator, \r\n    // If it succeeds, then invoke PreUpdateLocalActivityValidator if exists, or invoke the update handler\r\n    // if it fails then return the error to Update API caller\r\n    // Note that when this is set, the first parameter of update handler must be accepting the result of the local \r\n    // activity, and then the other parameters from caller\r\n    PreUpdateLocalActivity interface{}\r\n\r\n    // PreUpdateLocalActivityValidator is an optional func like Validator to validate the results of local activity\r\n    // same requirement as Validator. \r\n    // If succeeds then invoke update handler\r\n    // If fails then return error to Update API caller\r\n    PreUpdateLocalActivityValidator interface{}\r\n    \r\n    // PreUpdateLocalActivityOptions is the options for PreUpdateLocalActivity\r\n    PreUpdateLocalActivityOptions LocalActivityOptions\r\n}\r\n```\r\n\r\nThis feature will only need to implement in the SDK. And since we only update the `UpdateHandlerOptions`, it's backward compatible.  Maxim has confirmed that this should work, see the thread in the context. \r\n\r\nEssentially, Temporal doesn't assign any activityId(which means the state machine needs to change) or history eventId when invoking the local activity. So if it fails, nothing will be changed to the workflow states(cache). If it succeeds, the pass the results to the real update handler. \r\n\r\n**Describe alternatives you've considered**\r\nAnother way to workaround is to ask user to call the external system, if succeeds then passing the results when calling Update API. However, user will have to handle a lot more edge cases, especially racing conditions (as when calling external APIs, workflow is also running, and the workflow states could be changed).\r\n\r\n**Additional context**\r\nhttps://temporalio.slack.com/archives/CTDTU3J4T/p1681187414101309\r\n","closedAt":null,"comments":[{"id":"IC_kwDOGflYbs5ZouB0","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":">This feature will only need to implement in the SDK. And since we only update the UpdateHandlerOptions, it's backward compatible\r\n\r\nI'd need server team confirmation, but this idea sounds like it needs server support as well. Since your local activity could be long running it could cause a workflow task heartbeat and the server would need to understand to throw those workflow tasks away to avoid growing your history on failure.","createdAt":"2023-04-11T17:55:00Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/257#issuecomment-1503846516","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5ZovQt","author":{"login":"longquanzheng"},"authorAssociation":"NONE","body":"> > This feature will only need to implement in the SDK. And since we only update the UpdateHandlerOptions, it's backward compatible\r\n> \r\n> I'd need server team confirmation, but this idea sounds like it needs server support as well. Since your local activity could be long running it could cause a workflow task heartbeat and the server would need to understand to throw those workflow tasks away to avoid growing your history on failure.\r\n\r\nYeah good call. \r\nbut I think it’s also reasonable to limit this local activity to execute and retry within the workflow task execution. \r\n\r\nBecause this is different from regular way of executing local activity. User could have back off retry on their own anyway.\r\n\r\nWe can even just remove the retry policy from this local activity options ","createdAt":"2023-04-11T17:59:23Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/257#issuecomment-1503851565","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5Zo2EO","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Is the result of this `PreUpdateLocalActivity` meant to be available to the update handler? ","createdAt":"2023-04-11T18:21:25Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/257#issuecomment-1503879438","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5Zo4yS","author":{"login":"longquanzheng"},"authorAssociation":"NONE","body":"> Is the result of this `PreUpdateLocalActivity` meant to be available to the update handler?\r\n\r\nYes\r\n> Note that when this is set, the first parameter of update handler must be accepting the result of the local  activity, and then the other parameters from caller\r\n    \r\n","createdAt":"2023-04-11T18:31:56Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/257#issuecomment-1503890578","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5ZvT_7","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"We have a plan to allow calling \"local activities\" without generating history from workflows specifically for these purposes.\r\nThis mechanism would be very useful in update validators and query handlers.\r\nIt's mostly necessary for dependency injection or sandboxed workflow environments though, otherwise, you can run any code in your validation function as long as it doesn't mutate workflow state or generate history events.","createdAt":"2023-04-12T16:27:43Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/257#issuecomment-1505574907","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5ZvYwl","author":{"login":"longquanzheng"},"authorAssociation":"NONE","body":"> It's mostly necessary for dependency injection or sandboxed workflow environments though, otherwise, you can run any code in your validation function as long as it doesn't mutate workflow state or generate history events.\r\n\r\nThat's not exactly the purpose. It's not just \"calling local activities\" but also making the results as part of the input for mutation of the workflow(in an atomic operation). Therefore running the code in validation is not going to work.\r\n\r\nAlso it's making a lot of confusion of the \"readonly\" requirement. And in SDKs like Java, calling external system without activities is anti-pattern of writing Temporal workflow code.   \r\n\r\n","createdAt":"2023-04-12T16:42:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/257#issuecomment-1505594405","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5ZvwQG","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I see, we had mentioned allowing the validator to mutate the input during the design of the feature.\r\nMight be worth revisiting the decision we made where the validator can only return error or nil.","createdAt":"2023-04-12T17:48:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/257#issuecomment-1505690630","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5Zv1n1","author":{"login":"longquanzheng"},"authorAssociation":"NONE","body":"> allowing the validator to mutate the input \r\n\r\nThat would be nice but I don't think that's too useful unless it allows to interact with external system using [local]activities. Otherwise mutation can be done in update handler anyway. ","createdAt":"2023-04-12T18:06:33Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/257#issuecomment-1505712629","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5Zv26J","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"Yes, the point would be to allow interacting with external systems via an \"ephemeral\" local activity (the result of that local activity would not be persisted in history).","createdAt":"2023-04-12T18:10:39Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/257#issuecomment-1505717897","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5iY_h7","author":{"login":"longquanzheng"},"authorAssociation":"NONE","body":"> I see, we had mentioned allowing the validator to mutate the input during the design of the feature.\r\n> Might be worth revisiting the decision we made where the validator can only return error or nil.\r\n\r\n\r\nAfter reflecting on this, I think what is really needed is to let validator return something when passed, rather than nil. \r\n\r\nThen I will use  validator to call external system \r\n\r\n","createdAt":"2023-07-25T23:53:36Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/257#issuecomment-1650718843","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5iiI9e","author":{"login":"bergundy"},"authorAssociation":"MEMBER","body":"I agree this is desirable, the API is still marked experimental in Go so it's not too late to change.\r\nAlternatively, we could let the validator add information to `UpdateInfo`.","createdAt":"2023-07-27T08:13:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/257#issuecomment-1653116766","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs5iuaZA","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Even if the update validator could return a result you'd still have issues with workflow task timeout, and  I don't think it is feasible in languages like Typescript with a strict sandbox for workflows.\r\n\r\nI think we'd need to allow update validators to call local activities in some form, then we can explore allowing the validator to pass data to the handler. The second part might require a server side change","createdAt":"2023-07-28T21:04:26Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/257#issuecomment-1656333888","viewerDidAuthor":false}],"createdAt":"2023-04-11T17:31:34Z","labels":[{"id":"LA_kwDOGflYbs7XtLc6","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":257,"reactionGroups":[],"state":"OPEN","title":"Update API: support not writing history when calling external failure","updatedAt":"2024-07-13T01:07:02Z","url":"https://github.com/temporalio/features/issues/257"}
