{"assignees":[],"author":{"id":"MDQ6VXNlcjkxMDg0MzQ1","is_bot":false,"login":"alonwengierko","name":"Alon"},"body":"### What are you really trying to do?\r\nI'm aiming to establish comprehensive tracing observability for temporal workflows initiated via scheduling.\r\n\r\n### Describe the bug\r\n\r\nWhen the worfklow is triggered using create_schedule, only RunActivity spans are captured. However when it is triggered manually using start_workflow or execute_workflow, all spans are captured.\r\n\r\nTracing capture using jaeger for both manual and scheduled workflow executions. It shows workflow triggered manually with 5 spans, and the workflows triggered using schedule with 1 span. \r\n<img width=\"520\" alt=\"Screenshot 2024-02-22 at 10 20 45\" src=\"https://github.com/temporalio/features/assets/91084345/60f8b64d-42eb-491f-87ac-02e20e922f33\">\r\n\r\nThe screenshot below show that the only span capture for the scheduled workflows is RunActivity\r\n<img width=\"523\" alt=\"Screenshot 2024-02-22 at 10 19 02\" src=\"https://github.com/temporalio/features/assets/91084345/cd7ccf2c-6d66-463a-8d09-1cdb086b5c50\">\r\n\r\nHowever for the workflows triggered manually using starter.py, we can see 5 spans captured.  It is seen 5 spans: StartWorkflow, RunWorkflow, StartActivity, RunActivity and CompleteWorkflow \r\n<img width=\"622\" alt=\"Screenshot 2024-02-22 at 10 18 54\" src=\"https://github.com/temporalio/features/assets/91084345/666d0b1f-3a4f-42a8-a331-1a4f1f460b54\">\r\n\r\n### Minimal Reproduction\r\n1. Clone project https://github.com/temporalio/samples-python/tree/main/open_telemetry\r\n2. Run starter.py (execute workflow at demand)\r\n3. Run scheduler.py (execute workflow by scheduler) zip file attached to this issue\r\n4. Observe the difference of captured spans.  The spans generated by the workflow triggered manually is 5, while for the workflow triggered using create_schedule is 1. It should be the same for both.\r\n\r\n### Environment/Versions\r\n\r\n- OS and processor: M1 Mac\r\n- Temporal Version: Python SDK 1.5.0\r\n- Are you using Docker or Kubernetes or building Temporal from source? I am running docker container for jaeger\r\n\r\n### Additional context\r\n[scheduler.py.zip](https://github.com/temporalio/features/files/14375404/scheduler.py.zip)\r\n\r\n","closedAt":null,"comments":[{"id":"IC_kwDOGflYbs51F0EK","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"Is this a duplicate of #394?","createdAt":"2024-02-26T15:44:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/422#issuecomment-1964458250","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs51GRvd","author":{"login":"alonwengierko"},"authorAssociation":"NONE","body":"> Is this a duplicate of #394?\r\n\r\n@cretz, it appears there's a distinction between the issues. The bug highlighted in this particular matter concerns the omission of certain spans when a workflow is executed solely by Schedule. Notably, spans such as StartActivity, StartWorkflow, RunWorkflow, StartChildWorkflows, among others, are not being captured, with only the RunActivity span being recorded. On the other hand, #394 suggests that the Schedule creation should indeed generate a tracing span.","createdAt":"2024-02-26T16:29:10Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/422#issuecomment-1964579805","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs51GW9Y","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I see. There is some overlap because the overarching issue is that the workflows need an outer span from the client side to have a parent (whether that's schedule create or workflow start). The question becomes, how do you do that? You don't have an interceptor to apply per client-workflow-start for a schedule, it's started server side, and one large outer span for a schedule would get huge and live forever.\r\n\r\nSimply put, spans are applied SDK side, and there is no SDK side interception for starting workflows from a schedule. The server does not start spans for a user. Open to suggestions here.","createdAt":"2024-02-26T16:39:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/422#issuecomment-1964601176","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs51HDHD","author":{"login":"alonwengierko"},"authorAssociation":"NONE","body":"> I see. There is some overlap because the overarching issue is that the workflows need an outer span from the client side to have a parent (whether that's schedule create or workflow start). The question becomes, how do you do that? You don't have an interceptor to apply per client-workflow-start for a schedule, it's started server side, and one large outer span for a schedule would get huge and live forever.\r\n> \r\n> Simply put, spans are applied SDK side, and there is no SDK side interception for starting workflows from a schedule. The server does not start spans for a user. Open to suggestions here.\r\n\r\n@cretz \r\nI believe the outer span should represent the workflow start. I completely agree with your point that having the schedule creation as the outer span, with all workflows starting inside, would be not be the best. While I might not have all the intricate details, I firmly believe it should function similarly to when 'start_workflow' is invoked. In my perspective, when the schedule triggers a workflow execution, it should initiate a trace beginning from the workflow start. I'm uncertain why, currently, only 'RunActivity' spans are being generated.","createdAt":"2024-02-26T17:59:23Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/422#issuecomment-1964782019","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs51HYzF","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"The problem is that for schedules the server invokes start workflow and not your client. Therefore the server can't possibly know what OTel server you've setup with your SDK to send spans to (or that you're not using OpenTracing or DataDog or whatever other tracer). But we are considering options on possibly creating an outer span when the workflow is first run (knowing that it may have duplicates in rare initial-task-failed situations). We will leave this open while we figure out a solution here.","createdAt":"2024-02-26T18:41:37Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/features/issues/422#issuecomment-1964870853","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs6VXcIL","author":{"login":"LuckySting"},"authorAssociation":"NONE","body":"We fixed that problem using our implementation of TracingWorkflowInboundInterceptor. We generate a trace_id based on WorkflowRunId and set this context globally. Here is an implementation of our trace generator:\r\n```\r\nclass IdempotentIdGenerator(IdGenerator):\r\n    \"\"\"TID generator for TracerProvider which repeatedly generates IDs based on idempotency_key.\"\"\"\r\n\r\n    def __init__(self, idempotency_key: str) -> None:\r\n        self._rand = random.Random(idempotency_key)  # noqa: S311\r\n\r\n    def generate_span_id(self) -> int:\r\n        span_id = self._rand.getrandbits(64)\r\n        while span_id == trace.INVALID_SPAN_ID:\r\n            span_id = self._rand.getrandbits(64)\r\n        return span_id\r\n\r\n    def generate_trace_id(self) -> int:\r\n        trace_id = self._rand.getrandbits(128)\r\n        while trace_id == trace.INVALID_TRACE_ID:\r\n            trace_id = self._rand.getrandbits(128)\r\n        return trace_id\r\n```","createdAt":"2024-11-28T11:57:54Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/422#issuecomment-2505949707","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs6azptv","author":{"login":"leonard-henriquez"},"authorAssociation":"NONE","body":"@LuckySting could you give more details about your implementation of TracingWorkflowInboundInterceptor ?","createdAt":"2025-01-17T01:16:20Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/422#issuecomment-2597231471","viewerDidAuthor":false}],"createdAt":"2024-02-22T14:53:46Z","labels":[{"id":"LA_kwDOGflYbs7XtLc0","name":"bug","description":"Something isn't working","color":"d73a4a"}],"milestone":null,"number":422,"reactionGroups":[],"state":"OPEN","title":"[Bug] Incomplete Span Reporting: Only RunActivity Spans Sent When Workflow Triggered via scheduler","updatedAt":"2025-01-17T01:16:21Z","url":"https://github.com/temporalio/features/issues/422"}
