{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNTA0MDQ5","is_bot":false,"login":"Quinn-With-Two-Ns","name":"Quinn Klassen"},"body":"### Is your feature request related to a problem? Please describe.\r\n\r\nWhen users make a request to update a workflow execution they specify the update life cycle stage they would like to wait for before returning. Depending on the SDK this is specified either directly through an option or through the SDK API they use. Currently the SDK just passes this option to the gRPC call, but that is not sufficient since the gRPC call can return early if the server encounters an internal timeout. If the server encounters an internal timeout it will return an empty response and the SDK should poll. Currently the SDK returns an update handle if the server returns an empty response. This is dangerous since updates are not durable until accepted so it is possible to return a handle to a non durable update that can be lost. \r\n\r\n### Solution\r\n\r\nIf the server returns an update not in the desired life cycle stage,  the SDK should start polling the update request until it reaches the desired life cycle stage before returning the handle to the user.\r\n\r\nClient places:\r\n\r\n* [x] Go - https://github.com/temporalio/sdk-go/issues/1414\r\n* [ ] CLI  - Should be covered by the Go SDK\r\n* [ ] Java - https://github.com/temporalio/sdk-java/issues/2002\r\n* [ ] TypeScript - https://github.com/temporalio/sdk-typescript/issues/1372\r\n* [x] Python - https://github.com/temporalio/sdk-python/issues/485\r\n* [x] .NET - https://github.com/temporalio/sdk-dotnet/issues/199\r\n","closedAt":"2024-08-06T19:11:49Z","comments":[{"id":"IC_kwDOGflYbs52HO-U","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"To clarify, we originally thought it would be best to have the handle contain a wait-for-stage call that we ourselves could leverage inside the start call, but since \"admitted\" is not supported, there's not much value at this time.","createdAt":"2024-03-06T19:19:01Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/432#issuecomment-1981607828","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs52ZAxc","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"Talking with @mfateev about this, he brought up the server should return the `Updates Request` current life cycle state instead of an empty response when the servers internal deadline is reached. If the server returns the current life cycle state I purpose the logic should be:\r\n\r\nIf the Update Request reaches or passes the desired lifecycle state:\r\n - Return the update handle to the user\r\n\r\nelse If the server hits an internal deadline while waiting for the desired lifecycle state it returns a response with the current life cycle state:\r\n - If the `Update Request` state is `ADMITTED`\r\n    - SDK should retry the request since the update request it could be lost. (SDK must be supplying an update ID in this case)\r\n - else If the `Update Request` is `ACCEPTED`\r\n     - Poll until the update is `COMPLETED`\r\n\r\nThere is also a potential optimization we can make for low latency use cases by allowing users to specify two different `WaitStages`, one for the initial update request and one for polling. This would allow a users to say that if an update completes quickly they just want to wait for completed, but if it is taking longer then expected just return after it is accepted.","createdAt":"2024-03-08T19:20:32Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/432#issuecomment-1986268252","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs52ZZxc","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> he brought up the server should return the Updates Request current life cycle state instead of an empty response when the servers internal deadline is reached\r\n\r\nI thought it already did this\r\n\r\n> If the server returns the current life cycle state I purpose the logic should be\r\n\r\nI propose similar, but stated simply: \"SDK should wait for user-provided lifecycle stage or `ACCEPTED` by default. `ADMITTED` is not a valid lifecycle stage the user can give at this time (which means it will always wait for `ACCEPTED` or `COMPLETED` today).\"","createdAt":"2024-03-08T20:26:47Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/432#issuecomment-1986370652","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs52ZuKy","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":">I thought it already did this\r\n\r\nIt does not, I confirmed \r\n\r\n> I propose similar, but stated simply: \"SDK should wait for user-provided lifecycle stage or ACCEPTED by default. ADMITTED is not a valid lifecycle stage the user can give at this time (which means it will always wait for ACCEPTED or COMPLETED today).\"\r\n\r\nUsers cannot give `ADMITTED` correct, but the server could still return `ADMITTED` if the update is in that stage when it reaches the deadline. At that point we have two options,\r\n\r\n1. poll and hope the update doesn't get lost \r\n2. retry and know the update won't get lost.","createdAt":"2024-03-08T21:36:17Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/432#issuecomment-1986454194","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs52Zxcn","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"> It does not, I confirmed\r\n\r\nDocumentation at https://github.com/temporalio/api/blob/6776e414d82c7f469e470caa1a60b22e88231342/temporal/api/workflowservice/v1/request_response.proto#L1251-L1261 says it sets this value on timeout and the poll response has this too. I wonder if there's just a server version mismatch compared to API.\r\n\r\n> At that point we have two options,\r\n>   1. poll and hope the update doesn't get lost\r\n>   2. retry and know the update won't get lost.\r\n\r\nHrmm, I was thinking option 1 would be best here, but now I see what you're saying. So you're saying never poll on start, always continually call the start call because the start call with the same ID is the same as polling?","createdAt":"2024-03-08T21:49:03Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/432#issuecomment-1986467623","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs52ikI9","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":"The documentation aligns with what I am saying \r\n```\r\n    // UNSPECIFIED will be returned if and only if the server's maximum wait\r\n    // time was reached before the Update reached the stage specified in the\r\n    // request WaitPolicy, and before the context deadline expired; clients may\r\n    // may then retry the call as needed.\r\n```\r\n\r\nYes just keep calling start until the update is durable then we can poll\r\n\r\n\r\n","createdAt":"2024-03-11T15:52:27Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/432#issuecomment-1988772413","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs52jXji","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"I see, I thought \"known to have reached\" applied regardless (I didn't read far enough, sorry). I think we should change the current behavior and docs. It should never return `UNSPECIFIED` IMO, so we're all in agreement I think here.","createdAt":"2024-03-11T17:08:56Z","includesCreatedEdit":true,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/features/issues/432#issuecomment-1988983010","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs53P-q-","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"I am going to fix \"empty response return\" to include actually reached state (`ADMITTED` or `ACCEPTED`) although I propose not to rely on it's value. I'm also making server to return specific error if update is lost and server knows about it. Roughly internals of `UpdateWorkflow` should be:\r\n\r\nStep 1: Call to `UpdateWorkflowExecution` API. If it returns:\r\n  - non-retryable error => return error to the caller\r\n  - \"update is lost\" error => repeat Step 1\r\n  - non-empty response => return it to the caller\r\n  - empty response => start polling (Step 2)\r\n\r\nStep 2: Call `PollWorflowExecutionUpdate`. If it returns:\r\n  - non-retryable error => return error to the caller\r\n  - \"update is lost\" or NotFound error => go to Step 1\r\n  - non-empty response => return it to the caller\r\n  - empty response => continue polling (go to Step 2)\r\n\r\nTimeout needs special tricky handling.","createdAt":"2024-03-15T23:47:42Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/432#issuecomment-2000677566","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs53bxcp","author":{"login":"cretz"},"authorAssociation":"MEMBER","body":"@alexshtin - This can't work exactly as stated, I have started an internal discussion.","createdAt":"2024-03-18T12:21:19Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/432#issuecomment-2003769129","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs54den0","author":{"login":"tlalfano"},"authorAssociation":"MEMBER","body":"We may want to add PHP to the description list, Update has been implemented there as well.","createdAt":"2024-03-26T17:01:03Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/432#issuecomment-2020993524","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs55opVv","author":{"login":"alexshtin"},"authorAssociation":"CONTRIBUTOR","body":"I just merged server side support for this: https://github.com/temporalio/temporal/pull/5623.","createdAt":"2024-04-05T22:14:55Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/432#issuecomment-2040698223","viewerDidAuthor":false}],"createdAt":"2024-03-06T17:56:52Z","labels":[{"id":"LA_kwDOGflYbs7XtLc6","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":432,"reactionGroups":[],"state":"CLOSED","title":"[Feature Request] SDK should not return an update handle if the update has not reached the desired state","updatedAt":"2024-08-06T19:11:49Z","url":"https://github.com/temporalio/features/issues/432"}
