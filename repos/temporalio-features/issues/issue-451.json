{"assignees":[],"author":{"id":"MDQ6VXNlcjIwNjM5Ng==","is_bot":false,"login":"cretz","name":"Chad Retz"},"body":"### Describe the solution you'd like\r\n\r\nEvery SDK needs a feature test that confirms that an update is properly processed if it is received while a task that tries to complete the workflow is processing. The test needs to make sure it receives and processes the update before complete (and no cheating like making the workflow function wait on update). This is probably something like:\r\n\r\n```python\r\n@workflow.defn\r\nclass MyWorkflow:\r\n    def __init__(self) -> None:\r\n        self.result = \"done\"\r\n\r\n    @workflow.run\r\n    async def run(self) -> str:\r\n        # <possibly inject some artificial task hang here on first task attempt>\r\n        return self.result\r\n\r\n    @workflow.update\r\n    async def update(self) -> None:\r\n        self.result = \"done-from-update\"\r\n```\r\n\r\nThen make sure an update is sent _while the initial task is processed_, causing unhandled command (assert this occurs if possible), and that the workflow result is \"done-from-update\".\r\n\r\nA test like this hopefully helps us confirm that 1) server unhandled-command processing of updates works properly, and 2) coroutine ordering of the update coroutine will make sure it runs before workflow complete.\r\n\r\nEDIT: Actually, unhandled command causes full replay. So we probably _also_ need a test that operates on cache. Something like:\r\n\r\n```python\r\n@workflow.defn\r\nclass MyWorkflow:\r\n    def __init__(self) -> None:\r\n        self.results = []\r\n\r\n    @workflow.run\r\n    async def run(self) -> List[str]:\r\n        await workflow.wait_condition(lambda: self.results)\r\n        return self.results\r\n\r\n    @workflow.signal\r\n    async def signal(self) -> None:\r\n        self.result.append(\"got-signal\")\r\n\r\n    @workflow.update\r\n    async def update(self) -> None:\r\n        self.result.append(\"got-update\")\r\n```\r\n\r\nAnd make sure that the signal and update are _in the same task_ and in that order (i.e. stop the worker after first task processed before sending signal + update) and that the workflow returns with _both_ values (i.e. signal isn't the only thing processed).","closedAt":null,"comments":[{"id":"IC_kwDOGflYbs56oKT4","author":{"login":"Quinn-With-Two-Ns"},"authorAssociation":"MEMBER","body":">Then make sure an update is sent while the initial task is processed, causing unhandled command (assert this occurs if possible), and that the workflow result is \"done-from-update\".\r\n\r\nThis is a server side test that updates cause `unhandled command` I don't know if we need to test this with every SDK?\r\n\r\nI think what is more valuable to test across SDKs is that SDKs process update at a higher priority then the main workflow method.","createdAt":"2024-04-15T16:45:12Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[],"url":"https://github.com/temporalio/features/issues/451#issuecomment-2057348344","viewerDidAuthor":false},{"id":"IC_kwDOGflYbs57ZbIT","author":{"login":"dandavison"},"authorAssociation":"MEMBER","body":"> This is a server side test that updates cause unhandled command. I don't know if we need to test this with every SDK?\r\n\r\nAgree this is important to test but +1 that the priority is to add (if it doesn't exist) server-side test coverage for this rather than per-SDK feature tests. There's a similar test for signals here: https://github.com/temporalio/temporal/blob/main/tests/client_suite.go#L1211","createdAt":"2024-04-22T17:05:21Z","includesCreatedEdit":false,"isMinimized":false,"minimizedReason":"","reactionGroups":[{"content":"THUMBS_UP","users":{"totalCount":1}}],"url":"https://github.com/temporalio/features/issues/451#issuecomment-2070262291","viewerDidAuthor":false}],"createdAt":"2024-04-12T16:54:35Z","labels":[{"id":"LA_kwDOGflYbs7XtLc6","name":"enhancement","description":"New feature or request","color":"a2eeef"}],"milestone":null,"number":451,"reactionGroups":[],"state":"OPEN","title":"[Feature Request] Feature test confirming unhandled-command update behavior","updatedAt":"2024-04-22T17:05:22Z","url":"https://github.com/temporalio/features/issues/451"}
